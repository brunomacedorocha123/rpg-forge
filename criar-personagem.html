<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Personagem - RPGForce</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- PDF.js para exportação -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #2a1a3a 100%);
            min-height: 100vh;
            color: #fff;
        }
        .magic-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
        }
        .magic-bg::before {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
        }
        .magic-bg::after {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            background: radial-gradient(circle at 80% 80%, rgba(198, 40, 40, 0.1) 0%, transparent 50%);
            animation: pulse 10s ease-in-out infinite reverse;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .navbar {
            background: rgba(10, 10, 26, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 15px 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        .logo-area h2 {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.3rem;
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .user-id {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 30px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .user-id i { color: #ffd700; }
        .user-id .value {
            color: #ffd700;
            font-family: monospace;
            font-weight: 600;
        }
        .user-nick {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 215, 0, 0.1);
            padding: 6px 15px;
            border-radius: 30px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .user-nick i { color: #ffd700; }
        
        /* ===== NOVOS BOTÕES ADICIONADOS ===== */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        
        .btn-excluir {
            background: transparent;
            border: 2px solid rgba(255, 0, 0, 0.5);
            color: #ff6b6b;
            padding: 6px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-excluir:hover {
            background: #ff6b6b;
            color: #0a0a1a;
            border-color: #ff6b6b;
        }
        
        .btn-pdf {
            background: transparent;
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: #ffd700;
            padding: 6px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-pdf:hover {
            background: #ffd700;
            color: #0a0a1a;
            border-color: #ffd700;
        }
        
        .btn-salvar {
            background: linear-gradient(45deg, #4a6da8, #2a4a8a);
            border: none;
            color: white;
            padding: 6px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-salvar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 109, 168, 0.4);
        }
        
        .auto-save-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: rgba(255,215,0,0.7);
            margin-left: 10px;
        }
        
        .auto-save-indicator i {
            font-size: 0.7rem;
        }
        
        .auto-save-indicator.saving {
            color: #ffd700;
            animation: pulse 1s infinite;
        }
        
        .auto-save-indicator.saved {
            color: #4CAF50;
        }
        /* ===== FIM DOS NOVOS BOTÕES ===== */
        
        .btn-sair {
            background: transparent;
            border: 2px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 6px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-sair:hover {
            background: #ff6b6b;
            color: #0a0a1a;
            border-color: #ff6b6b;
        }
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            flex-wrap: wrap;
        }
        .breadcrumb a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
        }
        .breadcrumb a:hover { color: #ffd700; }
        .breadcrumb i {
            font-size: 0.7rem;
            color: rgba(255, 215, 0, 0.5);
        }
        .breadcrumb .current { color: #ffd700; }
        .page-header h1 {
            font-family: 'MedievalSharp', cursive;
            font-size: 2rem;
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .abas-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: rgba(10, 10, 26, 0.6);
            padding: 10px;
            border-radius: 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        .aba {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: rgba(255, 255, 255, 0.7);
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            flex: 1;
            justify-content: center;
            min-width: 120px;
        }
        .aba:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
            color: #ffd700;
        }
        .aba.ativa {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            border-color: #ffd700;
            color: #0a0a1a;
            font-weight: 600;
        }
        .aba .contador {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .aba.ativa .contador {
            background: rgba(0, 0, 0, 0.2);
            color: #0a0a1a;
        }
        .conteudo-aba { display: none; }
        .conteudo-aba.ativa { display: block; }
        
        .subabas-container {
            display: flex;
            gap: 5px;
            margin: 15px 0;
            flex-wrap: wrap;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 15px;
        }
        .subaba {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 15px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            flex: 1;
            justify-content: center;
        }
        .subaba:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
            color: #ffd700;
        }
        .subaba.ativa {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            color: #ffd700;
        }
        .subaba img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }
        
        .card {
            background: rgba(10, 10, 26, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 30px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .card-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }
        .card-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .card-section h2 {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-group label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 12px 15px;
            color: #fff;
            font-size: 1rem;
            width: 100%;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ffd700;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .upload-area {
            background: rgba(0, 0, 0, 0.2);
            border: 2px dashed rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.05);
        }
        .upload-area i {
            font-size: 2rem;
            color: #ffd700;
            margin-bottom: 10px;
            display: block;
        }
        .preview-area {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            margin: 10px 0;
        }
        .preview-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .btn-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pontos-restantes {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: bold;
        }
        .pontos-restantes .valor {
            font-size: 1.5rem;
            font-family: 'MedievalSharp', cursive;
        }
        .atributo-row {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .atributo-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .atributo-nome {
            font-weight: 600;
            color: #fff;
        }
        .atributo-valor {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffd700;
        }
        .bolinhas-container {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .bolinha {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }
        .bolinha.preenchida {
            background: #ffd700;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        .bolinha:hover {
            transform: scale(1.1);
            border-color: #ffd700;
        }
        .atributo-detalhes {
            display: flex;
            gap: 15px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            flex-wrap: wrap;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        .status-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }
        .status-item .label {
            display: block;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .status-item .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffd700;
        }
        .vantagens-grid, .desvantagens-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .vantagem-card, .desvantagem-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .vantagem-card:hover, .desvantagem-card:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
            transform: translateY(-2px);
        }
        .vantagem-card.selecionada {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        .desvantagem-card.selecionada {
            background: rgba(255, 0, 0, 0.2);
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }
        .vantagem-card h3, .desvantagem-card h3 {
            font-size: 1rem;
            color: #ffd700;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .vantagem-card p, .desvantagem-card p {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }
        .vantagem-card .resumo, .desvantagem-card .resumo {
            font-size: 0.7rem;
            color: rgba(255, 215, 0, 0.8);
            font-style: italic;
        }
        .vantagem-card .check { display: none; color: #ffd700; font-size: 1.2rem; }
        .vantagem-card.selecionada .check { display: inline; }
        .badge-fobia {
            background: rgba(255, 0, 0, 0.3);
            color: #ff6b6b;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-top: 5px;
            display: inline-block;
        }
        .contador {
            background: rgba(255, 215, 0, 0.1);
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .contador span { color: #ffd700; font-weight: bold; }
        .contador.desvantagens { background: rgba(255, 0, 0, 0.1); }
        .contador.desvantagens span { color: #ff6b6b; }
        
        /* ===== NOVOS MODAIS ===== */
        .modal-confirm {
            background: #1a1a3a;
            border: 2px solid #ff6b6b;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .modal-confirm h3 {
            color: #ff6b6b;
            margin-bottom: 15px;
            font-family: 'MedievalSharp', cursive;
        }
        
        .modal-confirm p {
            color: rgba(255,255,255,0.8);
            margin-bottom: 20px;
        }
        
        .modal-confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn-confirm-excluir {
            background: #ff6b6b;
            border: none;
            color: #0a0a1a;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-confirm-excluir:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .btn-cancel-excluir {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-cancel-excluir:hover {
            border-color: #ffd700;
            color: #ffd700;
        }
        /* ===== FIM DOS NOVOS MODAIS ===== */
        
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a3a;
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h3 {
            color: #ffd700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .fobia-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .fobia-item:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }
        .fobia-item h4 { color: #ffd700; margin-bottom: 5px; }
        .fobia-item p {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .modal-close {
            background: transparent;
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
        }
        .pm-header {
            background: linear-gradient(45deg, #4a2a6a, #2a1a4a);
            border: 1px solid #ffd700;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        .pm-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 30px;
        }
        .pm-input-group label {
            color: #ffd700;
            font-weight: bold;
        }
        .pm-input-group input {
            background: transparent;
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 5px 10px;
            border-radius: 10px;
            width: 70px;
            text-align: center;
            font-weight: bold;
        }
        .pm-stats {
            display: flex;
            gap: 20px;
            font-size: 1.1rem;
        }
        .pm-stats span {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.3rem;
        }
        .pericias-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            min-height: 500px;
        }
        .catalogo-pericias {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        .filtros-pericias {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filtro-pericia {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        .filtro-pericia.ativo {
            background: #ffd700;
            color: #0a0a1a;
            border-color: #ffd700;
        }
        .filtro-pericia:hover { background: rgba(255, 215, 0, 0.2); }
        .lista-pericias {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .pericia-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .pericia-card:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
            transform: translateX(5px);
        }
        .pericia-card h4 {
            color: #ffd700;
            font-size: 1rem;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        .pericia-card .tipo {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        .pericia-card .tipo.mental { background: #4a6da8; }
        .pericia-card .tipo.fisica { background: #8b4a6d; }
        .pericia-card .tipo.organica { background: #2d8b6d; }
        .pericia-card .descricao {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
        }
        .pericia-card .atributo {
            font-size: 0.7rem;
            color: #ffd700;
        }
        .pericias-adquiridas {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        .pericias-adquiridas h3 {
            color: #ffd700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .lista-adquiridas {
            max-height: 550px;
            overflow-y: auto;
        }
        .pericia-adquirida {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pericia-adquirida-info h4 {
            color: #ffd700;
            font-size: 1rem;
        }
        .pericia-adquirida-info .nivel {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .pericia-adquirida-info .bonus {
            color: #4CAF50;
            font-weight: bold;
        }
        .pericia-adquirida-info .nh {
            font-size: 0.9rem;
            color: #4CAF50;
            font-weight: bold;
            margin-top: 2px;
        }
        .pericia-adquirida-info .nh span {
            color: #ffd700;
            font-size: 1rem;
            margin-left: 5px;
        }
        .pericia-adquirida-acoes {
            display: flex;
            gap: 8px;
        }
        .btn-pericia {
            background: transparent;
            border: 1px solid #ffd700;
            color: #ffd700;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-pericia:hover {
            background: #ffd700;
            color: #0a0a1a;
        }
        .btn-pericia:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .tabela-niveis {
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        .tabela-niveis table {
            width: 100%;
            border-collapse: collapse;
        }
        .tabela-niveis th {
            background: #ffd700;
            color: #0a0a1a;
            padding: 8px;
            font-size: 0.9rem;
        }
        .tabela-niveis td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }
        .tabela-niveis tr:last-child td { border-bottom: none; }
        .seletor-nivel {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        .seletor-nivel button {
            background: transparent;
            border: 2px solid #ffd700;
            color: #ffd700;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .seletor-nivel button:hover:not(:disabled) {
            background: #ffd700;
            color: #0a0a1a;
        }
        .seletor-nivel button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .seletor-nivel span {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
            min-width: 60px;
            text-align: center;
        }
        .custo-info {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        .custo-info .custo {
            font-size: 2rem;
            color: #ffd700;
            font-weight: bold;
        }
        .btn-confirmar {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
            border: none;
            padding: 12px;
            border-radius: 30px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-confirmar:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.4);
        }
        .btn-confirmar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .resumo-personagem {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .resumo-personagem .foto {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffd700;
            font-size: 1.5rem;
            overflow: hidden;
        }
        .resumo-personagem .foto img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .resumo-personagem .info h3 {
            color: #ffd700;
            margin-bottom: 5px;
        }
        .resumo-personagem .info p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 10, 26, 0.9);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        .loading-overlay.active { display: flex; }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 215, 0, 0.2);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            color: #ffd700;
            font-size: 1.2rem;
            font-family: 'MedievalSharp', cursive;
        }
        .btn-primary, .btn-secondary {
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background: transparent;
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: #ffd700;
        }
        .btn-secondary:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }
        .card-actions {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            margin-top: 30px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Estilos da aba de equipamentos */
        .dinheiro-header {
            background: linear-gradient(45deg, #2a6a4a, #1a4a3a);
            border: 1px solid #ffd700;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        .dinheiro-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2rem;
        }
        .dinheiro-info i {
            color: #ffd700;
            font-size: 1.5rem;
        }
        .dinheiro-info .valor {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.5rem;
        }
        .carga-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .carga-barra {
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }
        .carga-preenchimento {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #ffd700, #ff6b6b);
            width: 0%;
            transition: width 0.3s;
        }
        .carga-marcadores {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        .carga-nivel {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .carga-nivel.leve { background: rgba(76, 175, 80, 0.3); color: #4CAF50; }
        .carga-nivel.medio { background: rgba(255, 193, 7, 0.3); color: #ffc107; }
        .carga-nivel.pesado { background: rgba(255, 87, 34, 0.3); color: #ff5722; }
        .carga-nivel.limite { background: rgba(244, 67, 54, 0.3); color: #f44336; }
        
        .inventario-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .inventario-coluna {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        .inventario-coluna h3 {
            color: #ffd700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .inventario-itens {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }
        .item-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .item-card:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }
        .item-card .item-nome {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        .item-card .item-detalhes {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: space-between;
        }
        .item-card .item-peso {
            color: #4CAF50;
        }
        .item-card .item-preco {
            color: #ffd700;
        }
        .item-acoes {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
            gap: 5px;
        }
        .item-card:hover .item-acoes {
            display: flex;
        }
        .item-acao {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #ffd700;
            color: #ffd700;
            width: 25px;
            height: 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .item-acao:hover {
            background: #ffd700;
            color: #0a0a1a;
        }
        
        .catalogo-itens {
            margin-top: 30px;
        }
        .catalogo-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .catalogo-tab {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .catalogo-tab.ativo {
            background: #ffd700;
            color: #0a0a1a;
            border-color: #ffd700;
        }
        .catalogo-tab:hover {
            background: rgba(255, 215, 0, 0.2);
        }
        .catalogo-lista {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }
        
        .btn-criar-item {
            background: linear-gradient(45deg, #4a2a6a, #2a1a4a);
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 12px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .btn-criar-item:hover {
            background: #ffd700;
            color: #0a0a1a;
        }
        
        .campo-dinamico {
            margin-bottom: 15px;
        }
        .campo-dinamico label {
            display: block;
            color: #ffd700;
            margin-bottom: 5px;
        }
        .campo-dinamico input, .campo-dinamico select {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #ffd700;
            border-radius: 10px;
            color: #fff;
        }
        
        /* NOVOS ESTILOS DA ABA DE COMBATE */
        .combate-header {
            background: linear-gradient(45deg, #6a2a2a, #3a1a1a);
            border: 1px solid #ff6b6b;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .combate-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .combate-stat-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .combate-stat-card .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .combate-stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b6b;
            font-family: 'MedievalSharp', cursive;
        }
        .combate-stat-card .stat-desc {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
        }
        
        .defesas-ativas {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .defesas-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .defesa-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .defesa-card .defesa-nome {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        .defesa-card .defesa-valor {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            font-family: 'MedievalSharp', cursive;
            margin-bottom: 5px;
        }
        .defesa-card .defesa-detalhe {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .rd-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .rd-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .rd-item .rd-tipo {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }
        .rd-item .rd-valor {
            font-size: 1.3rem;
            color: #ffd700;
            font-weight: bold;
        }
        
        .thresholds {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .threshold-item {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            min-width: 150px;
        }
        .threshold-item.atordoamento {
            border-left: 3px solid #ffa500;
        }
        .threshold-item.morte {
            border-left: 3px solid #ff0000;
        }
        .threshold-item .threshold-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
        .threshold-item .threshold-valor {
            font-size: 1.5rem;
            color: #ffd700;
            font-weight: bold;
        }
        
        .arma-equipada {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #ffd700;
        }
        .arma-equipada h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }
        .arma-detalhes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .arma-detalhe-item {
            text-align: center;
        }
        .arma-detalhe-item .label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
        }
        .arma-detalhe-item .valor {
            font-size: 1.1rem;
            color: #ffd700;
            font-weight: bold;
        }
        
        .escudo-pv {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }
        .escudo-pv-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .escudo-pv-barra {
            height: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            overflow: hidden;
        }
        .escudo-pv-preenchimento {
            height: 100%;
            background: #ffd700;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .card { padding: 20px; }
            .form-row { grid-template-columns: 1fr; }
            .status-grid { grid-template-columns: repeat(2, 1fr); }
            .vantagens-grid, .desvantagens-grid { grid-template-columns: repeat(2, 1fr); }
            .aba { min-width: auto; padding: 10px; font-size: 0.8rem; }
            .pericias-container { grid-template-columns: 1fr; }
            .inventario-grid { grid-template-columns: 1fr; }
            .defesas-grid { grid-template-columns: 1fr; }
            .combate-stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        .magia-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #0a2a3a, #1a4a6a);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid #4a9fff;
        }
        .simbolo-agua {
            width: 50px;
            height: 50px;
            background-image: url('agua1.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .info-escola {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .info-escola-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
        }
        .info-escola-item .label {
            color: #4a9fff;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .info-escola-item .valor {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
        }
        .esferas-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .esfera-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(74, 159, 255, 0.3);
            border-radius: 15px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }
        .esfera-card.desbloqueada {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        .esfera-card.disponivel {
            border-color: #4a9fff;
            background: rgba(74, 159, 255, 0.1);
            cursor: pointer;
        }
        .esfera-card.disponivel:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            transform: translateY(-5px);
        }
        .esfera-card.trancada {
            opacity: 0.5;
            filter: grayscale(0.8);
            cursor: not-allowed;
        }
        .numero-esfera {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            background: #ffd700;
            color: #0a0a1a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .icone-esfera {
            font-size: 2rem;
            margin: 10px 0;
            color: #4a9fff;
        }
        .esfera-card.desbloqueada .icone-esfera { color: #ffd700; }
        .esfera-card.disponivel .icone-esfera { color: #4a9fff; }
        .nome-esfera {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .tipo-esfera {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
        }
        .nivel-esfera {
            margin-top: 8px;
            font-size: 0.8rem;
            color: #ffd700;
        }
        .btn-comprar-esfera {
            background: #4a9fff;
            border: none;
            color: #0a0a1a;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
            transition: all 0.3s;
        }
        .btn-comprar-esfera:hover {
            background: #ffd700;
            transform: scale(1.05);
        }
        .detalhe-magia-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .detalhe-magia-modal.active { display: flex; }
        .detalhe-magia-content {
            background: #1a1a3a;
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .tabela-detalhe {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        .tabela-detalhe th {
            background: #ffd700;
            color: #0a0a1a;
            padding: 8px;
        }
        .tabela-detalhe td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }
        .tabela-detalhe tr.nivel-atual {
            background: rgba(255, 215, 0, 0.3);
            font-weight: bold;
        }
        .tabela-detalhe tr.nivel-atual td {
            color: #ffd700;
            border-bottom: 2px solid #ffd700;
        }
        .btn-comprar-nivel {
            background: linear-gradient(45deg, #4a9fff, #2a6fb0);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 10px;
            width: 100%;
            margin: 10px 0;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-comprar-nivel:hover:not(:disabled) {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
        }
        .btn-comprar-nivel:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .tabelas-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }
        .tabela-item { display: none; }
        .tabela-item.ativa { display: block; }
        
        .tabela-catalogo {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            font-size: 0.9rem;
        }
        .tabela-catalogo th {
            background: #ffd700;
            color: #0a0a1a;
            padding: 12px 8px;
            font-weight: 600;
            text-align: left;
        }
        .tabela-catalogo td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            color: rgba(255, 255, 255, 0.9);
        }
        .tabela-catalogo tr:hover td {
            background: rgba(255, 215, 0, 0.1);
        }
        .btn-comprar-tabela {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        .btn-comprar-tabela:hover {
            background: #ffd700;
            color: #0a0a1a;
            transform: scale(1.05);
        }
        
        @media (max-width: 768px) {
            .tabela-catalogo { font-size: 0.8rem; }
            .tabela-catalogo th, .tabela-catalogo td { padding: 8px 4px; }
            .btn-comprar-tabela { padding: 3px 6px; font-size: 0.7rem; }
            .tabelas-container { overflow-x: auto; }
            .tabela-catalogo { min-width: 600px; }
        }
        .destaque-campo {
            background: rgba(255, 215, 0, 0.05);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            border-left: 3px solid #ffd700;
        }
    </style>
</head>

<body>
    <div class="magic-bg"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando...</div>
    </div>

    <!-- Modal de fobias (EXISTENTE) -->
    <div class="modal" id="modalFobias">
        <div class="modal-content">
            <h3><i class="fas fa-spider"></i> Escolha uma Fobia</h3>
            <div class="fobia-item" data-fobia="acrofobia"><h4>Acrofobia</h4><p>Medo de alturas. Não vai a lugares com mais de 5m de altura.</p></div>
            <div class="fobia-item" data-fobia="agorafobia"><h4>Agorafobia</h4><p>Medo de espaços abertos. Desconfortável sem paredes num raio de 15m.</p></div>
            <div class="fobia-item" data-fobia="aracnofobia"><h4>Aracnofobia</h4><p>Medo de aranhas.</p></div>
            <div class="fobia-item" data-fobia="autofobia"><h4>Autofobia</h4><p>Medo de solidão. Não suporta ficar sozinho.</p></div>
            <div class="fobia-item" data-fobia="brontofobia"><h4>Brontofobia</h4><p>Medo de ruídos altos. Evita tempestades e explosões.</p></div>
            <div class="fobia-item" data-fobia="claustrofobia"><h4>Claustrofobia</h4><p>Medo de espaços fechados. Pânico em lugares pequenos.</p></div>
            <div class="fobia-item" data-fobia="coitofobia"><h4>Coitofobia</h4><p>Medo de sexo.</p></div>
            <div class="fobia-item" data-fobia="demofobia"><h4>Demofobia</h4><p>Medo de multidões. Penalidade progressiva por quantidade de pessoas.</p></div>
            <div class="fobia-item" data-fobia="ecmofobia"><h4>Ecmofobia</h4><p>Medo de coisas afiadas. Espadas, facas, agulhas.</p></div>
            <div class="fobia-item" data-fobia="elurofobia"><h4>Elurofobia</h4><p>Medo de gatos.</p></div>
            <div class="fobia-item" data-fobia="entomofobia"><h4>Entomofobia</h4><p>Medo de insetos. Penalidade para insetos grandes ou muitos.</p></div>
            <div class="fobia-item" data-fobia="hematofobia"><h4>Hematofobia</h4><p>Medo de sangue. Teste durante combates.</p></div>
            <div class="fobia-item" data-fobia="hoplofobia"><h4>Hoplofobia</h4><p>Medo de armas. Penalidade ao ser ameaçado.</p></div>
            <div class="fobia-item" data-fobia="manafobia"><h4>Manafobia</h4><p>Medo de magia. Não aprende magias, reage mal a magos.</p></div>
            <div class="fobia-item" data-fobia="misofobia"><h4>Misofobia</h4><p>Medo de sujeira. Evita se sujar, comida estranha.</p></div>
            <div class="fobia-item" data-fobia="necrofobia"><h4>Necrofobia</h4><p>Medo da morte e mortos. Pânico perto de cadáveres.</p></div>
            <div class="fobia-item" data-fobia="nictofobia"><h4>Nictofobia</h4><p>Medo do escuro. Evita lugares subterrâneos.</p></div>
            <div class="fobia-item" data-fobia="ofiofobia"><h4>Ofiofobia</h4><p>Medo de répteis. Penalidade para cobras, lagartos.</p></div>
            <div class="fobia-item" data-fobia="pirofobia"><h4>Pirofobia</h4><p>Medo de fogo. Até cigarro aceso incomoda.</p></div>
            <div class="fobia-item" data-fobia="psicofobia"><h4>Psicofobia</h4><p>Medo de poderes psíquicos.</p></div>
            <div class="fobia-item" data-fobia="talassofobia"><h4>Talassofobia</h4><p>Medo do mar. Evita viagens marítimas.</p></div>
            <div class="fobia-item" data-fobia="tecnofobia"><h4>Tecnofobia</h4><p>Medo de máquinas. Não usa tecnologia avançada.</p></div>
            <div class="fobia-item" data-fobia="teratofobia"><h4>Teratofobia</h4><p>Medo de monstros. Penalidade progressiva.</p></div>
            <div class="fobia-item" data-fobia="triscedecofobia"><h4>Triscedecofobia</h4><p>Medo do número 13. Teste ao envolver o número.</p></div>
            <div class="fobia-item" data-fobia="xenofobia"><h4>Xenofobia</h4><p>Medo do desconhecido/estrangeiros. Penalidade para não-humanos.</p></div>
            <button class="modal-close" id="fecharModalFobias"><i class="fas fa-times"></i> Fechar</button>
        </div>
    </div>

    <!-- Modal de criar item (EXISTENTE) -->
    <div class="modal" id="modalCriarItem">
        <div class="modal-content">
            <h3><i class="fas fa-plus-circle"></i> Criar Item Personalizado</h3>
            
            <div class="campo-dinamico">
                <label>Nome do Item</label>
                <input type="text" id="itemPersonalizadoNome" placeholder="Ex: Espada Mágica Flamejante">
            </div>
            
            <div class="campo-dinamico">
                <label>Tipo de Item</label>
                <select id="itemPersonalizadoTipo">
                    <option value="arma_ca">Arma Corpo a Corpo</option>
                    <option value="arma_distancia">Arma de Distância</option>
                    <option value="armadura">Armadura</option>
                    <option value="escudo">Escudo</option>
                    <option value="item_geral">Item Geral</option>
                </select>
            </div>
            
            <div id="camposEspecificos"></div>
            
            <div class="campo-dinamico">
                <label>Preço ($)</label>
                <input type="number" id="itemPersonalizadoPreco" min="0" value="10">
            </div>
            
            <div class="campo-dinamico">
                <label>Peso</label>
                <input type="number" id="itemPersonalizadoPeso" min="0" step="0.1" value="1.0">
            </div>
            
            <div class="campo-dinamico">
                <label>Quantidade</label>
                <input type="number" id="itemPersonalizadoQtd" min="1" value="1">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" id="cancelarCriarItem" style="flex: 1;">Cancelar</button>
                <button class="btn-primary" id="confirmarCriarItem" style="flex: 2;">Criar Item</button>
            </div>
        </div>
    </div>

    <!-- Modal de perícia (EXISTENTE) -->
    <div class="modal" id="modalPericia">
        <div class="modal-content">
            <h3><i class="fas fa-brain"></i> <span id="modalPericiaNome">Espada</span></h3>
            <div class="tabela-niveis">
                <table>
                    <thead><tr><th>Nível</th><th>Bônus</th><th>Custo Total</th></tr></thead>
                    <tbody>
                        <tr><td>1</td><td>0</td><td>2 PM</td></tr>
                        <tr><td>2</td><td>+1</td><td>6 PM</td></tr>
                        <tr><td>3</td><td>+2</td><td>10 PM</td></tr>
                        <tr><td>4</td><td>+3</td><td>14 PM</td></tr>
                        <tr><td>5</td><td>+4</td><td>18 PM</td></tr>
                        <tr><td>6</td><td>+5</td><td>22 PM</td></tr>
                        <tr><td>7</td><td>+6</td><td>26 PM</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="seletor-nivel">
                <button id="modalPericiaMenos" disabled>-</button>
                <span id="modalPericiaNivel">1</span>
                <button id="modalPericiaMais">+</button>
            </div>
            <div class="custo-info">
                <div style="font-size: 0.9rem; margin-bottom: 5px;">Custo desta operação:</div>
                <div class="custo" id="modalPericiaCusto">2 PM</div>
                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);" id="modalPericiaObservacao"></div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-secondary" id="modalPericiaCancelar" style="flex: 1;">Cancelar</button>
                <button class="btn-primary" id="modalPericiaConfirmar" style="flex: 2;">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de detalhe de magia (EXISTENTE) -->
    <div class="detalhe-magia-modal" id="detalheMagiaModal">
        <div class="detalhe-magia-content">
            <h3 id="detalheMagiaTitulo" style="color: #ffd700; margin-bottom: 10px;">Localizar Água</h3>
            <div style="margin-bottom: 15px; color: #4a9fff;" id="detalheMagiaInfo">IQ | Mana: 2</div>
            <table class="tabela-detalhe" id="tabelaDetalheMagia">
                <thead><tr><th>Nível</th><th>Valor</th></tr></thead>
                <tbody id="corpoTabelaDetalhe"></tbody>
            </table>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" id="fecharDetalheMagia" style="flex: 1;">Fechar</button>
                <button class="btn-comprar-nivel" id="comprarNivelMagia" style="flex: 2;">Comprar Nível</button>
            </div>
        </div>
    </div>

    <!-- ===== NOVO MODAL DE CONFIRMAÇÃO DE EXCLUSÃO ===== -->
    <div class="modal" id="modalConfirmarExclusao">
        <div class="modal-confirm">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão</h3>
            <p>Tem certeza que deseja excluir este personagem? Esta ação não pode ser desfeita.</p>
            <div class="modal-confirm-actions">
                <button class="btn-cancel-excluir" id="cancelarExclusao">Cancelar</button>
                <button class="btn-confirm-excluir" id="confirmarExclusao">Excluir Permanentemente</button>
            </div>
        </div>
    </div>

    <!-- ===== NOVO MODAL DE SUCESSO AO SALVAR ===== -->
    <div class="modal" id="modalSalvarSucesso" style="display: none;">
        <div class="modal-content" style="text-align: center; background: #1a3a1a; border-color: #4CAF50;">
            <h3 style="color: #4CAF50;"><i class="fas fa-check-circle"></i> Personagem Salvo!</h3>
            <p style="color: rgba(255,255,255,0.8); margin: 15px 0;">O personagem foi salvo com sucesso no banco de dados.</p>
            <button class="btn-primary" id="fecharModalSalvar" style="background: #4CAF50;">OK</button>
        </div>
    </div>
    <!-- ===== FIM DOS NOVOS MODAIS ===== -->

    <!-- CONTAINER PRINCIPAL -->
    <div class="container">
        <nav class="navbar">
            <div class="logo-area"><h2>RPGForce</h2></div>
            <div class="user-info">
                <div class="user-id"><i class="fas fa-id-card"></i><span class="value" id="displayIdPc">--------</span></div>
                <div class="user-nick"><i class="fas fa-user"></i><span id="displayNickname">Aventureiro</span></div>
                
                <!-- ===== NOVOS BOTÕES DE AÇÃO ===== -->
                <div class="action-buttons">
                    <button class="btn-salvar" id="btnSalvarPersonagem" title="Salvar personagem">
                        <i class="fas fa-save"></i><span>Salvar</span>
                    </button>
                    <button class="btn-pdf" id="btnExportarPDF" title="Exportar para PDF">
                        <i class="fas fa-file-pdf"></i><span>PDF</span>
                    </button>
                    <button class="btn-excluir" id="btnExcluirPersonagem" title="Excluir personagem">
                        <i class="fas fa-trash"></i><span>Excluir</span>
                    </button>
                </div>
                
                <!-- Indicador de salvamento automático -->
                <div class="auto-save-indicator" id="autoSaveIndicator">
                    <i class="fas fa-circle"></i>
                    <span>Salvo</span>
                </div>
                <!-- ===== FIM DOS NOVOS BOTÕES ===== -->
                
                <button class="btn-sair" id="btnSair"><i class="fas fa-sign-out-alt"></i><span>Sair</span></button>
            </div>
        </nav>

        <div class="breadcrumb">
            <a href="dashboard-pc.html"><i class="fas fa-home"></i> Dashboard</a>
            <i class="fas fa-chevron-right"></i>
            <a href="personagens.html">Personagens</a>
            <i class="fas fa-chevron-right"></i>
            <span class="current" id="breadcrumbCurrent">Criar Personagem</span>
        </div>

        <div class="page-header">
            <h1><i class="fas fa-dragon"></i> <span id="pageTitle">Criar Novo Personagem</span></h1>
        </div>

        <div class="abas-container">
            <button class="aba ativa" data-aba="basicos"><i class="fas fa-user"></i> Dados Básicos</button>
            <button class="aba" data-aba="combate"><i class="fas fa-shield-alt"></i> Combate</button>
            <button class="aba" data-aba="vantagens" id="abaVantagensBtn"><i class="fas fa-star"></i> Vantagens <span class="contador" id="contadorVantagensAba">0/3</span></button>
            <button class="aba" data-aba="desvantagens" id="abaDesvantagensBtn"><i class="fas fa-skull"></i> Desvantagens <span class="contador" id="contadorDesvantagensAba">0/4</span></button>
            <button class="aba" data-aba="pericias"><i class="fas fa-brain"></i> Perícias <span class="contador" id="contadorPericiasAba">0 PM</span></button>
            <button class="aba" data-aba="magias"><i class="fas fa-magic"></i> Magias <span class="contador" id="contadorMagiasAba">0/15</span></button>
            <button class="aba" data-aba="equipamentos"><i class="fas fa-backpack"></i> Equipamentos</button>
        </div>

        <!-- ABA DADOS BÁSICOS -->
        <div id="abaBasicos" class="conteudo-aba ativa">
            <div class="card">
                <div class="card-section">
                    <h2><i class="fas fa-user"></i> Dados Básicos</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomePersonagem">Nome do Personagem</label>
                            <input type="text" id="nomePersonagem" placeholder="Ex: Aric, o Caçador" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="classePersonagem">Classe</label>
                            <select id="classePersonagem">
                                <option value="guerreiro">Guerreiro</option>
                                <option value="mago">Mago</option>
                                <option value="ladino">Ladino</option>
                                <option value="clerigo">Clérigo</option>
                                <option value="barbaro">Bárbaro</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ===== NOVOS CAMPOS: Idade, Altura, Peso ===== -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="idadePersonagem">Idade</label>
                            <input type="number" id="idadePersonagem" min="1" max="999" value="25" placeholder="Ex: 25">
                        </div>
                        <div class="form-group">
                            <label for="alturaPersonagem">Altura (cm)</label>
                            <input type="number" id="alturaPersonagem" min="50" max="300" value="170" placeholder="Ex: 170">
                        </div>
                        <div class="form-group">
                            <label for="pesoPersonagem">Peso (kg)</label>
                            <input type="number" id="pesoPersonagem" min="20" max="500" value="70" step="0.1" placeholder="Ex: 70.5">
                        </div>
                    </div>
                    <!-- ===== FIM DOS NOVOS CAMPOS ===== -->
                    
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-camera"></i>
                        <span>Clique para adicionar foto (opcional)</span>
                        <input type="file" id="fotoInput" accept="image/*" style="display: none;">
                    </div>
                    <div class="preview-area" id="previewArea" style="display: none;">
                        <img id="previewImage" src="" alt="Preview">
                        <button type="button" id="removeFoto" class="btn-remove"><i class="fas fa-times"></i></button>
                    </div>
                </div>

                <div class="card-section">
                    <h2><i class="fas fa-user-circle"></i> Aparência, História e Economia</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="aparencia">Aparência</label>
                            <select id="aparencia">
                                <option value="feio">Feio (-2 reação)</option>
                                <option value="normal" selected>Normal</option>
                                <option value="atraente">Atraente (+2 reação)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="riqueza">Riqueza Inicial</label>
                            <select id="riqueza">
                                <option value="pobre">Pobre (metade do base)</option>
                                <option value="medio" selected>Médio (valor base)</option>
                                <option value="rico">Rico (5x o base)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dinheiroBase">Valor Base de Dinheiro ($)</label>
                            <input type="number" id="dinheiroBase" min="0" value="1000" step="100">
                            <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem; margin-top: 5px; display: block;">
                                <i class="fas fa-info-circle"></i> O mestre define este valor. Pobre = metade, Rico = 5x
                            </small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="peculiaridades">Peculiaridades</label>
                        <textarea id="peculiaridades" placeholder="Ex: Fala sozinho quando nervoso... Tem uma cicatriz no rosto... Adora poesia..."></textarea>
                    </div>
                    
                    <!-- Campo oculto para ID do personagem (quando for edição) -->
                    <input type="hidden" id="personagemId" value="">
                </div>

                <div class="card-section">
                    <h2><i class="fas fa-chart-bar"></i> Atributos</h2>
                    <div class="pontos-restantes">
                        <span>Pontos para distribuir:</span>
                        <span class="valor" id="pontosRestantes">6</span>
                    </div>
                    
                    <div class="atributo-row" data-atributo="st">
                        <div class="atributo-info">
                            <span class="atributo-nome">ST (Força)</span>
                            <span class="atributo-valor" id="stValor">9</span>
                        </div>
                        <div class="bolinhas-container" id="stBolinhas"></div>
                        <div class="atributo-detalhes">
                            <span class="dano" id="stDano">1d-1</span>
                        </div>
                    </div>

                    <div class="atributo-row" data-atributo="dx">
                        <div class="atributo-info">
                            <span class="atributo-nome">DX (Destreza)</span>
                            <span class="atributo-valor" id="dxValor">5</span>
                        </div>
                        <div class="bolinhas-container" id="dxBolinhas"></div>
                        <div class="atributo-detalhes">
                            <span class="esquiva" id="dxEsquiva">Esquiva 5</span>
                        </div>
                    </div>

                    <div class="atributo-row" data-atributo="iq">
                        <div class="atributo-info">
                            <span class="atributo-nome">IQ (Inteligência)</span>
                            <span class="atributo-valor" id="iqValor">5</span>
                        </div>
                        <div class="bolinhas-container" id="iqBolinhas"></div>
                        <div class="atributo-detalhes">
                            <span class="vontade" id="iqVontade">Vontade 5</span>
                        </div>
                    </div>

                    <div class="atributo-row" data-atributo="ht">
                        <div class="atributo-info">
                            <span class="atributo-nome">HT (Vigor)</span>
                            <span class="atributo-valor" id="htValor">48</span>
                        </div>
                        <div class="bolinhas-container" id="htBolinhas"></div>
                        <div class="atributo-detalhes">
                            <span class="vida" id="htVida">Vida 48</span>
                            <span class="fadiga" id="htFadiga">Fadiga 8</span>
                        </div>
                    </div>
                </div>

                <div class="card-section status-grid">
                    <div class="status-item">
                        <span class="label">Vida:</span>
                        <span class="value" id="statusVida">48</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Fadiga:</span>
                        <span class="value" id="statusFadiga">8</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Mana:</span>
                        <span class="value" id="statusMana">13</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Dano:</span>
                        <span class="value" id="statusDano">1d-1</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Esquiva:</span>
                        <span class="value" id="statusEsquiva">5</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Deslocamento:</span>
                        <span class="value" id="statusDeslocamento">12.2</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA COMBATE -->
        <div id="abaCombate" class="conteudo-aba">
            <div class="card">
                <div class="combate-header">
                    <h2 style="color: #ff6b6b; margin-bottom: 15px;"><i class="fas fa-shield-alt"></i> Status de Combate</h2>
                    <div class="combate-stats-grid">
                        <div class="combate-stat-card">
                            <div class="stat-label">Pontos de Vida (PV)</div>
                            <div class="stat-value" id="combatePV">48</div>
                            <div class="stat-desc">HT × 8</div>
                        </div>
                        <div class="combate-stat-card">
                            <div class="stat-label">Fadiga</div>
                            <div class="stat-value" id="combateFadiga">8</div>
                            <div class="stat-desc">Base + bônus</div>
                        </div>
                        <div class="combate-stat-card">
                            <div class="stat-label">Deslocamento</div>
                            <div class="stat-value" id="combateDeslocamento">12.2</div>
                            <div class="stat-desc">(ST+DX+HT)/5</div>
                        </div>
                    </div>
                </div>

                <div class="defesas-ativas">
                    <h3 style="color: #ffd700; margin-bottom: 10px;"><i class="fas fa-shield"></i> Defesas Ativas</h3>
                    <div class="defesas-grid">
                        <div class="defesa-card">
                            <div class="defesa-nome">Esquiva</div>
                            <div class="defesa-valor" id="defesaEsquiva">9</div>
                            <div class="defesa-detalhe">DX + HT/6 + 8</div>
                        </div>
                        <div class="defesa-card">
                            <div class="defesa-nome">Aparar</div>
                            <div class="defesa-valor" id="defesaAparar">8</div>
                            <div class="defesa-detalhe">NH Arma + DX/4 + 6</div>
                        </div>
                        <div class="defesa-card">
                            <div class="defesa-nome">Bloqueio</div>
                            <div class="defesa-valor" id="defesaBloqueio">8</div>
                            <div class="defesa-detalhe">NH Escudo + DX/4 + 6 + bônus</div>
                        </div>
                    </div>
                </div>

                <div class="arma-equipada" id="armaEquipadaContainer">
                    <h3><i class="fas fa-sword"></i> Arma Equipada</h3>
                    <div class="arma-detalhes" id="armaEquipadaDetalhes">
                        <div class="arma-detalhe-item">
                            <div class="label">Arma</div>
                            <div class="valor" id="armaNome">Nenhuma</div>
                        </div>
                        <div class="arma-detalhe-item">
                            <div class="label">Dano</div>
                            <div class="valor" id="armaDano">-</div>
                        </div>
                        <div class="arma-detalhe-item">
                            <div class="label">Tipo</div>
                            <div class="valor" id="armaTipo">-</div>
                        </div>
                        <div class="arma-detalhe-item">
                            <div class="label">Alcance</div>
                            <div class="valor" id="armaAlcance">-</div>
                        </div>
                    </div>
                </div>

                <div class="rd-grid">
                    <div class="rd-item">
                        <div class="rd-tipo">RD Corpo</div>
                        <div class="rd-valor" id="rdCorpo">0</div>
                    </div>
                    <div class="rd-item">
                        <div class="rd-tipo">RD Cabeça</div>
                        <div class="rd-valor" id="rdCabeca">0</div>
                    </div>
                    <div class="rd-item">
                        <div class="rd-tipo">RD Membros</div>
                        <div class="rd-valor" id="rdMembros">0</div>
                    </div>
                </div>

                <div class="escudo-pv" id="escudoPVContainer" style="display: none;">
                    <div class="escudo-pv-header">
                        <span><i class="fas fa-shield"></i> PV do Escudo</span>
                        <span id="escudoPVTexto">30/30</span>
                    </div>
                    <div class="escudo-pv-barra">
                        <div class="escudo-pv-preenchimento" id="escudoPVBarra" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="thresholds">
                    <div class="threshold-item atordoamento">
                        <div class="threshold-label"><i class="fas fa-exclamation-triangle"></i> Atordoamento (×6 PV)</div>
                        <div class="threshold-valor" id="thresholdAtordoamento">288</div>
                    </div>
                    <div class="threshold-item morte">
                        <div class="threshold-label"><i class="fas fa-skull"></i> Morte (×8 PV)</div>
                        <div class="threshold-valor" id="thresholdMorte">384</div>
                    </div>
                </div>

                <div class="card-section" style="margin-top: 20px; background: rgba(255,0,0,0.1); border-radius: 10px; padding: 15px;">
                    <h4 style="color: #ff6b6b;"><i class="fas fa-exclamation-circle"></i> Regras de Fadiga</h4>
                    <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">Quando a Fadiga chegar a zero, todas as habilidades e deslocamento são reduzidos pela metade.</p>
                </div>
            </div>
        </div>

        <!-- ABA VANTAGENS -->
        <div id="abaVantagens" class="conteudo-aba">
            <div class="card">
                <div class="resumo-personagem" id="resumoPersonagem">
                    <div class="foto" id="resumoFoto"><i class="fas fa-user"></i></div>
                    <div class="info"><h3 id="resumoNome">Carregando...</h3><p id="resumoDetalhes">Classe: <span id="resumoClasse">-</span> | Aparência: <span id="resumoAparencia">-</span> | Riqueza: <span id="resumoRiqueza">-</span></p></div>
                </div>
                <div class="card-section">
                    <h2><i class="fas fa-star"></i> Vantagens <span style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">(escolha 3)</span></h2>
                    <div class="contador"><span><i class="fas fa-check-circle"></i> Vantagens selecionadas:</span><span id="contadorVantagens">0/3</span></div>
                    <div class="vantagens-grid" id="vantagensGrid">
                        <div class="vantagem-card" data-vantagem="aliado"><h3>Aliado <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Um companheiro fiel</p></div>
                        <div class="vantagem-card" data-vantagem="ambidestria"><h3>Ambidestria <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Usa ambas as mãos sem penalidade</p></div>
                        <div class="vantagem-card" data-vantagem="aptidaoMagica"><h3>Aptidão mágica +1 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Bônus em magias</p></div>
                        <div class="vantagem-card" data-vantagem="abascanto"><h3>Abascanto +3 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Resistência a magia +3</p></div>
                        <div class="vantagem-card" data-vantagem="carisma"><h3>Carisma +1 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Persuasão, liderança</p></div>
                        <div class="vantagem-card" data-vantagem="destemor"><h3>Destemor +2 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Resistência a medo/intimidação</p></div>
                        <div class="vantagem-card" data-vantagem="duroMatar"><h3>Duro de matar +2 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Bônus em HT ou resistência</p></div>
                        <div class="vantagem-card" data-vantagem="flexibilidade"><h3>Flexibilidade <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Bônus em testes de DX/escapar</p></div>
                        <div class="vantagem-card" data-vantagem="intuicao"><h3>Intuição <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Sentir quando algo está errado</p></div>
                        <div class="vantagem-card" data-vantagem="nocaoPerigo"><h3>Noção do perigo <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Alerta contra emboscadas</p></div>
                        <div class="vantagem-card" data-vantagem="reflexoCombate"><h3>Reflexo de combate <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Iniciativa, esquiva</p></div>
                        <div class="vantagem-card" data-vantagem="regeneracao"><h3>Regeneração <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Recupera vida mais rápido</p></div>
                        <div class="vantagem-card" data-vantagem="sentidosAgucados"><h3>Sentidos aguçados +2 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Percepção +2</p></div>
                        <div class="vantagem-card" data-vantagem="sorte"><h3>Sorte <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Pode rerolar testes</p></div>
                        <div class="vantagem-card" data-vantagem="visaoNoturna"><h3>Visão noturna <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Enxerga no escuro</p></div>
                        <div class="vantagem-card" data-vantagem="mestreArmas"><h3>Mestre das armas <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Bônus com armas</p></div>
                        <div class="vantagem-card" data-vantagem="forcaVontade"><h3>Força de vontade +2 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Resistência mental +2</p></div>
                        <div class="vantagem-card" data-vantagem="fadigaExtra"><h3>Fadiga extra +2 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">+2 na reserva de fadiga</p></div>
                        <div class="vantagem-card" data-vantagem="htExtra"><h3>HT extra +5% <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Aumento percentual no Vigor</p></div>
                        <div class="vantagem-card" data-vantagem="atraente"><h3>Atraente <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">+2 em reações</p></div>
                        <div class="vantagem-card" data-vantagem="rico"><h3>Rico <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Começa com 250 moedas</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA DESVANTAGENS -->
        <div id="abaDesvantagens" class="conteudo-aba">
            <div class="card">
                <div class="resumo-personagem" id="resumoPersonagem2">
                    <div class="foto" id="resumoFoto2"><i class="fas fa-user"></i></div>
                    <div class="info"><h3 id="resumoNome2">Carregando...</h3><p id="resumoDetalhes2">Classe: <span id="resumoClasse2">-</span> | Aparência: <span id="resumoAparencia2">-</span> | Riqueza: <span id="resumoRiqueza2">-</span></p></div>
                </div>
                <div class="card-section">
                    <h2><i class="fas fa-skull"></i> Desvantagens <span style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">(escolha 4)</span></h2>
                    <div class="contador desvantagens"><span><i class="fas fa-skull"></i> Desvantagens selecionadas:</span><span id="contadorDesvantagens">0/4</span></div>
                    <div class="desvantagens-grid" id="desvantagensGrid">
                        <div class="desvantagem-card" data-desvantagem="alcoolismo"><h3>Alcoolismo</h3><p class="resumo">Vício em bebida</p></div>
                        <div class="desvantagem-card" data-desvantagem="avareza"><h3>Avareza</h3><p class="resumo">Mesquinho, ama dinheiro</p></div>
                        <div class="desvantagem-card" data-desvantagem="briguento"><h3>Briguento</h3><p class="resumo">Adora uma briga</p></div>
                        <div class="desvantagem-card" data-desvantagem="barulhento"><h3>Barulhento +2</h3><p class="resumo">Não consegue ser furtivo</p></div>
                        <div class="desvantagem-card" data-desvantagem="cobica"><h3>Cobiça</h3><p class="resumo">Quer tudo que vê</p></div>
                        <div class="desvantagem-card" data-desvantagem="circunspeccao"><h3>Circunspecção</h3><p class="resumo">Cautela extrema</p></div>
                        <div class="desvantagem-card" data-desvantagem="cleptomania"><h3>Cleptomania</h3><p class="resumo">Compulsão por roubar</p></div>
                        <div class="desvantagem-card" data-desvantagem="codigoHonra"><h3>Código de honra</h3><p class="resumo">Segue regras rígidas</p></div>
                        <div class="desvantagem-card" data-desvantagem="covardia"><h3>Covardia</h3><p class="resumo">Foge de perigo</p></div>
                        <div class="desvantagem-card" data-desvantagem="daltonismo"><h3>Daltonismo</h3><p class="resumo">Não vê cores</p></div>
                        <div class="desvantagem-card" data-desvantagem="sensoDever"><h3>Senso do dever</h3><p class="resumo">Protege algo/alguém</p></div>
                        <div class="desvantagem-card" data-desvantagem="inimigo"><h3>Inimigo</h3><p class="resumo">Alguém te persegue</p></div>
                        <div class="desvantagem-card" data-desvantagem="excessoConfianca"><h3>Excesso de confiança</h3><p class="resumo">Se acha mais capaz</p></div>
                        <div class="desvantagem-card" id="cardFobia" data-desvantagem="fobia"><h3>Fobia <i class="fas fa-chevron-right" style="font-size: 0.8rem;"></i></h3><p class="resumo">Clique para escolher</p><span class="badge-fobia" id="fobiaEscolhida" style="display: none;">Nenhuma</span></div>
                        <div class="desvantagem-card" data-desvantagem="furia"><h3>Fúria</h3><p class="resumo">Perde o controle na raiva</p></div>
                        <div class="desvantagem-card" data-desvantagem="honestidade"><h3>Honestidade</h3><p class="resumo">Não consegue mentir</p></div>
                        <div class="desvantagem-card" data-desvantagem="luxuria"><h3>Luxúria</h3><p class="resumo">Obcecado por prazeres</p></div>
                        <div class="desvantagem-card" data-desvantagem="megalomania"><h3>Megalomania</h3><p class="resumo">Quer dominar o mundo</p></div>
                        <div class="desvantagem-card" data-desvantagem="pacifismo"><h3>Pacifismo</h3><p class="resumo">Não suporta violência</p></div>
                        <div class="desvantagem-card" data-desvantagem="piromania"><h3>Piromania</h3><p class="resumo">Adora fogo</p></div>
                        <div class="desvantagem-card" data-desvantagem="preguica"><h3>Preguiça</h3><p class="resumo">Evita esforço</p></div>
                        <div class="desvantagem-card" data-desvantagem="sanguinolencia"><h3>Sanguinolência</h3><p class="resumo">Adora ver sangue</p></div>
                        <div class="desvantagem-card" data-desvantagem="teimosia"><h3>Teimosia</h3><p class="resumo">Não muda de ideia</p></div>
                        <div class="desvantagem-card" data-desvantagem="veracidade"><h3>Veracidade</h3><p class="resumo">Sempre fala a verdade</p></div>
                        <div class="desvantagem-card" data-desvantagem="zarolho"><h3>Zarolho</h3><p class="resumo">Tem só um olho</p></div>
                        <div class="desvantagem-card" data-desvantagem="magro"><h3>Magro</h3><p class="resumo">-20% peso, vulnerável a quedas</p></div>
                        <div class="desvantagem-card" data-desvantagem="gordo"><h3>Gordo</h3><p class="resumo">+20% peso, perde fadiga rápido</p></div>
                        <div class="desvantagem-card" data-desvantagem="nanismo"><h3>Nanismo</h3><p class="resumo">-1 deslocamento, altura máx 1.30m</p></div>
                        <div class="desvantagem-card" data-desvantagem="pobre"><h3>Pobre</h3><p class="resumo">Começa com 25 moedas</p></div>
                        <div class="desvantagem-card" data-desvantagem="feio"><h3>Feio</h3><p class="resumo">-2 em reações</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA PERÍCIAS -->
        <div id="abaPericias" class="conteudo-aba">
            <div class="card">
                <div class="pm-header">
                    <div class="pm-input-group"><label for="pmInicial">PM Inicial:</label><input type="number" id="pmInicial" min="0" value="30" step="1"></div>
                    <div class="pm-stats"><div>Gastos: <span id="pmGasto">0</span></div><div>Restante: <span id="pmRestante">30</span></div></div>
                </div>
                <div class="pericias-container">
                    <div class="catalogo-pericias">
                        <h3 style="color: #ffd700; margin-bottom: 15px;"><i class="fas fa-book"></i> Catálogo de Perícias</h3>
                        <div class="filtros-pericias">
                            <button class="filtro-pericia ativo" data-filtro="todas">Todas</button>
                            <button class="filtro-pericia" data-filtro="mental">Mental (IQ)</button>
                            <button class="filtro-pericia" data-filtro="fisica">Física (DX)</button>
                            <button class="filtro-pericia" data-filtro="organica">Orgânica (HT)</button>
                        </div>
                        <div class="lista-pericias" id="listaPericias"></div>
                    </div>
                    <div class="pericias-adquiridas">
                        <h3><i class="fas fa-check-circle"></i> Perícias do Personagem</h3>
                        <div class="lista-adquiridas" id="listaPericiasAdquiridas"><div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Clique em uma perícia do catálogo para adicionar</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA MAGIAS -->
        <div id="abaMagias" class="conteudo-aba">
            <div class="card">
                <div class="subabas-container">
                    <button class="subaba ativa" data-subaba="agua">
                        <img src="agua1.png" alt="Água" style="width: 20px; height: 20px;"> Escola da Água
                    </button>
                    <button class="subaba" data-subaba="fogo" disabled style="opacity: 0.5;">
                        <i class="fas fa-fire"></i> Escola do Fogo
                    </button>
                    <button class="subaba" data-subaba="terra" disabled style="opacity: 0.5;">
                        <i class="fas fa-mountain"></i> Escola da Terra
                    </button>
                </div>

                <div id="subabaAgua" class="conteudo-subaba ativa">
                    <div class="magia-header">
                        <div class="simbolo-agua"></div>
                        <div class="info-escola">
                            <div class="info-escola-item"><div class="label">Aptidão Mágica</div><div class="valor" id="aptidaoMagicaValor">0</div></div>
                            <div class="info-escola-item"><div class="label">Esferas</div><div class="valor" id="esferasDesbloqueadas">0</div></div>
                            <div class="info-escola-item"><div class="label">PM em Magias</div><div class="valor" id="pmMagias">0</div></div>
                        </div>
                    </div>

                    <h2 style="color: #ffd700; margin: 20px 0 10px;"><i class="fas fa-water"></i> Árvore de Magias da Água</h2>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">Cada esfera desbloqueia uma nova magia. Compre esferas com PM para expandir seu poder.</p>

                    <div class="esferas-grid" id="esferasGrid"></div>
                </div>
            </div>
        </div>

        <!-- ABA EQUIPAMENTOS -->
        <div id="abaEquipamentos" class="conteudo-aba">
            <div class="card">
                <div class="dinheiro-header">
                    <div class="dinheiro-info">
                        <i class="fas fa-coins"></i>
                        <span>Saldo: <span class="valor" id="dinheiroSaldo">50</span> $</span>
                    </div>
                    <div class="dinheiro-info">
                        <i class="fas fa-weight-hanging"></i>
                        <span>Carga: <span id="cargaAtual">0.0</span> / <span id="cargaLimite">108</span> kg</span>
                    </div>
                </div>

                <div class="carga-info">
                    <div class="carga-barra">
                        <div class="carga-preenchimento" id="cargaBarra" style="width: 0%;"></div>
                    </div>
                    <div class="carga-marcadores">
                        <span>Leve (STx2: <span id="cargaLeve">18</span> kg)</span>
                        <span>Médio (STx4: <span id="cargaMedia">36</span> kg)</span>
                        <span>Pesado (STx8: <span id="cargaPesada">72</span> kg)</span>
                        <span>Limite (STx12: <span id="cargaLimiteDisplay">108</span> kg)</span>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                        <span class="carga-nivel" id="cargaNivel">Leve</span>
                        <span>Penalidades: <span id="cargaPenalidade">Nenhuma</span></span>
                    </div>
                </div>

                <div class="inventario-grid">
                    <div class="inventario-coluna">
                        <h3><i class="fas fa-user"></i> Corpo</h3>
                        <div class="inventario-itens" id="inventarioCorpo">
                            <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nada equipado</div>
                        </div>
                    </div>
                    <div class="inventario-coluna">
                        <h3><i class="fas fa-shopping-bag"></i> Mochila <span style="font-size: 0.8rem; color: rgba(255,255,255,0.6);" id="pesoMochila">(0.0 kg)</span></h3>
                        <div class="inventario-itens" id="inventarioMochila">
                            <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Mochila vazia</div>
                        </div>
                    </div>
                    <div class="inventario-coluna">
                        <h3><i class="fas fa-warehouse"></i> Depósito</h3>
                        <div class="inventario-itens" id="inventarioDeposito">
                            <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Depósito vazio</div>
                        </div>
                    </div>
                </div>

                <button class="btn-criar-item" id="btnCriarItem">
                    <i class="fas fa-plus-circle"></i> Criar Item Personalizado
                </button>

                <div class="catalogo-itens">
                    <h3 style="color: #ffd700; margin-bottom: 15px;"><i class="fas fa-store"></i> Catálogo de Itens</h3>
                    
                    <div class="catalogo-tabs">
                        <button class="catalogo-tab ativo" data-tab="armas_ca">Armas Corpo a Corpo</button>
                        <button class="catalogo-tab" data-tab="armas_dist">Armas de Distância</button>
                        <button class="catalogo-tab" data-tab="armaduras">Armaduras</button>
                        <button class="catalogo-tab" data-tab="escudos">Escudos</button>
                        <button class="catalogo-tab" data-tab="itens_gerais">Itens Gerais</button>
                    </div>

                    <div class="tabelas-container">
                        <div class="tabela-item ativa" id="tabelaArmasCA">
                            <table class="tabela-catalogo">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Alcance</th>
                                        <th>Dano</th>
                                        <th>Tipo</th>
                                        <th>Custo ($)</th>
                                        <th>Peso (kg)</th>
                                        <th>ST</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaArmasCA">
                                    <tr><td colspan="8" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tabela-item" id="tabelaArmasDist">
                            <table class="tabela-catalogo">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Precisão</th>
                                        <th>Dano</th>
                                        <th>Tipo</th>
                                        <th>Alcance</th>
                                        <th>Custo ($)</th>
                                        <th>Peso (kg)</th>
                                        <th>ST</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaArmasDist">
                                    <tr><td colspan="9" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tabela-item" id="tabelaArmaduras">
                            <table class="tabela-catalogo">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>RD</th>
                                        <th>Custo ($)</th>
                                        <th>Peso (kg)</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaArmaduras">
                                    <tr><td colspan="5" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tabela-item" id="tabelaEscudos">
                            <table class="tabela-catalogo">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Bônus</th>
                                        <th>VE</th>
                                        <th>Custo ($)</th>
                                        <th>Peso (kg)</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaEscudos">
                                    <tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tabela-item" id="tabelaItensGerais">
                            <table class="tabela-catalogo">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Especificação</th>
                                        <th>Custo ($)</th>
                                        <th>Peso (kg)</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaItensGerais">
                                    <tr><td colspan="5" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-actions">
            <button type="button" class="btn-secondary" id="btnAnterior"><i class="fas fa-arrow-left"></i> Anterior</button>
            <button type="button" class="btn-primary" id="btnProximo">Próximo <i class="fas fa-arrow-right"></i></button>
            <button type="button" class="btn-primary" id="btnFinalizar" style="display: none;"><i class="fas fa-save"></i> Finalizar Personagem</button>
        </div>
    </div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyBrx4JSmFay24k95pu1ICjFfVki8gs_uHw",
    authDomain: "rpgforce-e3227.firebaseapp.com",
    projectId: "rpgforce-e3227",
    storageBucket: "rpgforce-e3227.firebasestorage.app",
    messagingSenderId: "984517342332",
    appId: "1:984517342332:web:87d33aa4c84ff2a07685f9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const displayIdPc = document.getElementById('displayIdPc');
const displayNickname = document.getElementById('displayNickname');
const btnSair = document.getElementById('btnSair');
const loadingOverlay = document.getElementById('loadingOverlay');
const btnAnterior = document.getElementById('btnAnterior');
const btnProximo = document.getElementById('btnProximo');
const btnFinalizar = document.getElementById('btnFinalizar');
const abas = document.querySelectorAll('.aba');
const conteudos = document.querySelectorAll('.conteudo-aba');
const subabas = document.querySelectorAll('.subaba');
const uploadArea = document.getElementById('uploadArea');
const fotoInput = document.getElementById('fotoInput');
const previewArea = document.getElementById('previewArea');
const previewImage = document.getElementById('previewImage');
const removeFoto = document.getElementById('removeFoto');
const pontosRestantesSpan = document.getElementById('pontosRestantes');
const modalFobias = document.getElementById('modalFobias');
const fecharModalFobias = document.getElementById('fecharModalFobias');
const fobiaEscolhida = document.getElementById('fobiaEscolhida');
const cardFobia = document.getElementById('cardFobia');
const contadorVantagensSpan = document.getElementById('contadorVantagens');
const contadorDesvantagensSpan = document.getElementById('contadorDesvantagens');
const contadorVantagensAba = document.getElementById('contadorVantagensAba');
const contadorDesvantagensAba = document.getElementById('contadorDesvantagensAba');
const contadorPericiasAba = document.getElementById('contadorPericiasAba');
const contadorMagiasAba = document.getElementById('contadorMagiasAba');
const pmInicial = document.getElementById('pmInicial');
const pmGasto = document.getElementById('pmGasto');
const pmRestante = document.getElementById('pmRestante');
const listaPericias = document.getElementById('listaPericias');
const listaPericiasAdquiridas = document.getElementById('listaPericiasAdquiridas');
const modalPericia = document.getElementById('modalPericia');
const modalPericiaNome = document.getElementById('modalPericiaNome');
const modalPericiaNivel = document.getElementById('modalPericiaNivel');
const modalPericiaCusto = document.getElementById('modalPericiaCusto');
const modalPericiaObservacao = document.getElementById('modalPericiaObservacao');
const modalPericiaMenos = document.getElementById('modalPericiaMenos');
const modalPericiaMais = document.getElementById('modalPericiaMais');
const modalPericiaCancelar = document.getElementById('modalPericiaCancelar');
const modalPericiaConfirmar = document.getElementById('modalPericiaConfirmar');
const aptidaoMagicaValor = document.getElementById('aptidaoMagicaValor');
const esferasDesbloqueadasSpan = document.getElementById('esferasDesbloqueadas');
const pmMagiasSpan = document.getElementById('pmMagias');
const esferasGrid = document.getElementById('esferasGrid');
const detalheMagiaModal = document.getElementById('detalheMagiaModal');
const detalheMagiaTitulo = document.getElementById('detalheMagiaTitulo');
const detalheMagiaInfo = document.getElementById('detalheMagiaInfo');
const corpoTabelaDetalhe = document.getElementById('corpoTabelaDetalhe');
const fecharDetalheMagia = document.getElementById('fecharDetalheMagia');
const comprarNivelMagia = document.getElementById('comprarNivelMagia');
const dinheiroBaseInput = document.getElementById('dinheiroBase');
const dinheiroSaldo = document.getElementById('dinheiroSaldo');
const cargaAtual = document.getElementById('cargaAtual');
const cargaLimite = document.getElementById('cargaLimite');
const cargaLeve = document.getElementById('cargaLeve');
const cargaMedia = document.getElementById('cargaMedia');
const cargaPesada = document.getElementById('cargaPesada');
const cargaBarra = document.getElementById('cargaBarra');
const cargaNivel = document.getElementById('cargaNivel');
const cargaPenalidade = document.getElementById('cargaPenalidade');
const pesoMochila = document.getElementById('pesoMochila');
const inventarioCorpo = document.getElementById('inventarioCorpo');
const inventarioMochila = document.getElementById('inventarioMochila');
const inventarioDeposito = document.getElementById('inventarioDeposito');
const btnCriarItem = document.getElementById('btnCriarItem');
const modalCriarItem = document.getElementById('modalCriarItem');
const cancelarCriarItem = document.getElementById('cancelarCriarItem');
const confirmarCriarItem = document.getElementById('confirmarCriarItem');
const itemPersonalizadoNome = document.getElementById('itemPersonalizadoNome');
const itemPersonalizadoTipo = document.getElementById('itemPersonalizadoTipo');
const camposEspecificos = document.getElementById('camposEspecificos');
const itemPersonalizadoPreco = document.getElementById('itemPersonalizadoPreco');
const itemPersonalizadoPeso = document.getElementById('itemPersonalizadoPeso');
const itemPersonalizadoQtd = document.getElementById('itemPersonalizadoQtd');
const idadePersonagem = document.getElementById('idadePersonagem');
const alturaPersonagem = document.getElementById('alturaPersonagem');
const pesoPersonagem = document.getElementById('pesoPersonagem');
const btnSalvarPersonagem = document.getElementById('btnSalvarPersonagem');
const btnExportarPDF = document.getElementById('btnExportarPDF');
const btnExcluirPersonagem = document.getElementById('btnExcluirPersonagem');
const modalConfirmarExclusao = document.getElementById('modalConfirmarExclusao');
const cancelarExclusao = document.getElementById('cancelarExclusao');
const confirmarExclusao = document.getElementById('confirmarExclusao');
const modalSalvarSucesso = document.getElementById('modalSalvarSucesso');
const fecharModalSalvar = document.getElementById('fecharModalSalvar');
const autoSaveIndicator = document.getElementById('autoSaveIndicator');
const breadcrumbCurrent = document.getElementById('breadcrumbCurrent');
const pageTitle = document.getElementById('pageTitle');
const personagemIdHidden = document.getElementById('personagemId');
const combatePV = document.getElementById('combatePV');
const combateFadiga = document.getElementById('combateFadiga');
const combateDeslocamento = document.getElementById('combateDeslocamento');
const defesaEsquiva = document.getElementById('defesaEsquiva');
const defesaAparar = document.getElementById('defesaAparar');
const defesaBloqueio = document.getElementById('defesaBloqueio');
const armaNome = document.getElementById('armaNome');
const armaDano = document.getElementById('armaDano');
const armaTipo = document.getElementById('armaTipo');
const armaAlcance = document.getElementById('armaAlcance');
const rdCorpo = document.getElementById('rdCorpo');
const rdCabeca = document.getElementById('rdCabeca');
const rdMembros = document.getElementById('rdMembros');
const escudoPVContainer = document.getElementById('escudoPVContainer');
const escudoPVTexto = document.getElementById('escudoPVTexto');
const escudoPVBarra = document.getElementById('escudoPVBarra');
const thresholdAtordoamento = document.getElementById('thresholdAtordoamento');
const thresholdMorte = document.getElementById('thresholdMorte');
const corpoTabelaArmasCA = document.getElementById('corpoTabelaArmasCA');
const corpoTabelaArmasDist = document.getElementById('corpoTabelaArmasDist');
const corpoTabelaArmaduras = document.getElementById('corpoTabelaArmaduras');
const corpoTabelaEscudos = document.getElementById('corpoTabelaEscudos');
const corpoTabelaItensGerais = document.getElementById('corpoTabelaItensGerais');

const catalogoItensData = {
    armas_ca: [
        { id: 'machado', nome: 'Machado', alcance: 1, dano: '1d-1', tipoDano: 'Corte', preco: 50, peso: 2.0, st: 10 },
        { id: 'maca_lisa', nome: 'Maça Lisa', alcance: 1, dano: '1D', tipoDano: 'Contusão', preco: 80, peso: 2.5, st: 11 },
        { id: 'espada_larga', nome: 'Espada Larga', alcance: 1, dano: '1d Corte / 1D-1 Perf', tipoDano: 'Corte/Perf', preco: 500, peso: 2.0, st: 10 },
        { id: 'rapieira', nome: 'Rapieira', alcance: 1.2, dano: '1D', tipoDano: 'Perfuração', preco: 500, peso: 1.5, st: 9 }
    ],
    armas_dist: [
        { id: 'arco', nome: 'Arco', precisao: 1, dano: '1D+1', tipoDano: 'Perf', alcance: 'STx15', preco: 200, peso: 1.5, st: 12 },
        { id: 'besta', nome: 'Besta', precisao: 1, dano: '2D', tipoDano: 'Perf', alcance: 'STx20', preco: 200, peso: 3.0, st: 9 }
    ],
    armaduras: [
        { id: 'couro', nome: 'Armadura de Couro', rd: 2, preco: 50, peso: 5.0, local: 'completo' },
        { id: 'couro_ref', nome: 'Armadura de Couro Reforçado', rd: 4, preco: 250, peso: 10.0, local: 'completo' },
        { id: 'escamas', nome: 'Armadura de Escamas de Aço', rd: 8, preco: 900, peso: 22.0, local: 'completo' }
    ],
    escudos: [
        { id: 'escudo_leve', nome: 'Escudo Leve', bonus: 1, preco: 50, peso: 1.0, ve: '5/30' },
        { id: 'escudo_medio', nome: 'Escudo Médio', bonus: 2, preco: 150, peso: 8.0, ve: '7/55' }
    ],
    itens_gerais: [
        { id: 'corda', nome: 'Corda (10m)', especificacao: '10m', preco: 5, peso: 1.5 },
        { id: 'tocha', nome: 'Tocha', especificacao: '1h', preco: 1, peso: 0.5 },
        { id: 'oleo', nome: 'Óleo para lamparina (1L)', especificacao: '1L', preco: 3, peso: 1.0 },
        { id: 'mochila', nome: 'Mochila', especificacao: '50kg', preco: 20, peso: 1.5 },
        { id: 'racao', nome: 'Ração de viagem (1 dia)', especificacao: '1 dia', preco: 2, peso: 0.5 },
        { id: 'cantil', nome: 'Cantil (1L)', especificacao: '1L', preco: 2, peso: 0.3 },
        { id: 'kit_primeiros', nome: 'Kit de primeiros socorros', especificacao: '3 usos', preco: 15, peso: 1.0 },
        { id: 'pederneira', nome: 'Pederneira', especificacao: '', preco: 5, peso: 0.1 },
        { id: 'saco_dormir', nome: 'Saco de dormir', especificacao: '', preco: 10, peso: 2.0 },
        { id: 'barraca', nome: 'Barraca (2 pessoas)', especificacao: '2 pessoas', preco: 30, peso: 5.0 }
    ]
};

let abaAtual = 'basicos';
let pontosRestantes = 6;
let fobiaSelecionada = null;
let personagemTemp = null;
let personagemId = null;
let modoEdicao = false;
const vantagensSelecionadas = new Set();
const desvantagensSelecionadas = new Set();
let pmDisponivel = 30;
let pmGastoTotal = 0;
let pericias = {};
let periciaAtual = null;
let dinheiroBase = 1000;
let escudoPVAtual = 0;
let escudoPVMax = 0;
let autoSaveTimeout = null;
let magiaSelecionada = null;
let escolaSelecionada = 'agua';
let esferasDesbloqueadas = 0;

let inventario = {
    corpo: [],
    mochila: [],
    deposito: []
};

let dinheiro = 0;

const atributos = {
    st: { valor: 9, bolinhas: 0, base: 9 },
    dx: { valor: 5, bolinhas: 0, base: 5 },
    iq: { valor: 5, bolinhas: 0, base: 5 },
    ht: { valor: 8, bolinhas: 0, base: 8 }
};

const tabelaDano = {
    9: "1d-1", 10: "1d", 11: "1d+1", 12: "1d+2",
    13: "2d-1", 14: "2d", 15: "2d+1", 16: "2d+2",
    17: "3d-1", 18: "3d", 19: "3d+1", 20: "3d+2"
};

const escolas = {
    agua: {
        id: 'agua',
        nome: 'Água',
        desbloqueada: true,
        custoDesbloqueio: 0,
        icone: 'agua1.png',
        magias: {
            localizarAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Informação', icone: 'fa-location-dot' },
            purificarAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Utilitária', icone: 'fa-droplet' },
            criarAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Utilitária', icone: 'fa-water' },
            dissiparAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Área', icone: 'fa-wind' },
            respirarNaAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Suporte', icone: 'fa-lungs' },
            moldarAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Controle', icone: 'fa-hand' },
            nevoeiro: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Área', icone: 'fa-cloud' },
            armaCongelante: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Encanto', icone: 'fa-snowflake' },
            cortinaDagua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Defesa/Área', icone: 'fa-shield' },
            jatoDeAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Ataque', icone: 'fa-gun' },
            ondaExpulsora: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Ataque/Área', icone: 'fa-wave-square' },
            adagaDeGelo: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Ataque', icone: 'fa-knife' },
            golemDeAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Conjuração', icone: 'fa-robot' },
            tempestadeDeGelo: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Área', icone: 'fa-cloud-rain' },
            congelamento: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Paralisia', icone: 'fa-icicles' }
        }
    }
};

const tabelasMagia = {
    localizarAgua: { coluna: 'Alcance', valores: ['50m', '100m', '200m', '350m', '500m', '1km', '1.5km', '2km', '2.5km', '3km', '4km', '5km', '10km', '14km', '20km+'] },
    purificarAgua: { coluna: 'Litros', valores: ['1L', '5L', '10L', '20L', '35L', '50L', '75L', '100L', '150L', '200L', '300L', '500L', '750L', '1000L', '2000L'] },
    criarAgua: { coluna: 'Litros', valores: ['1L', '5L', '10L', '20L', '35L', '50L', '75L', '100L', '150L', '200L', '300L', '500L', '750L', '1000L', '2000L'] },
    dissiparAgua: { coluna: 'Volume (m³)', valores: ['1m³', '2m³', '3m³', '5m³', '8m³', '12m³', '18m³', '25m³', '35m³', '50m³', '70m³', '100m³', '150m³', '250m³', '500m³'] },
    respirarNaAgua: { coluna: 'Duração', valores: ['1min', '2min', '3min', '5min', '8min', '10min', '15min', '20min', '30min', '45min', '1h', '1.5h', '2h', '3h', '6h'] },
    moldarAgua: { coluna: 'Litros', valores: ['1L', '5L', '10L', '20L', '35L', '50L', '75L', '100L', '150L', '200L', '300L', '500L', '750L', '1000L', '2000L'] },
    nevoeiro: { coluna: 'Raio / Penalidade', valores: ['2m / -1', '3m / -1', '4m / -2', '5m / -2', '6m / -3', '8m / -3', '10m / -4', '12m / -4', '15m / -5', '18m / -5', '20m / -6', '25m / -6', '30m / -7', '40m / -7', '50m / -8'] },
    armaCongelante: { coluna: 'Dano / Duração', valores: ['+0 / 30s', '+1 / 1min', '+1 / 2min', '+2 / 2min', '+2 / 3min', '+3 / 3min', '+3 / 4min', '+4 / 4min', '+4 / 5min', '+5 / 5min', '+5 / 6min', '+6 / 6min', '+6 / 7min', '+7 / 7min', '+8 / 10min'] },
    cortinaDagua: { coluna: 'Tamanho / RD / Duração', valores: ['2x2m / RD2 / 2s', '3x2m / RD3 / 2s', '3x3m / RD4 / 3s', '4x3m / RD5 / 3s', '4x4m / RD6 / 4s', '5x4m / RD7 / 4s', '5x5m / RD8 / 5s', '6x5m / RD9 / 5s', '6x6m / RD10 / 6s', '7x6m / RD12 / 6s', '7x7m / RD14 / 7s', '8x7m / RD16 / 7s', '8x8m / RD18 / 8s', '9x8m / RD20 / 8s', '10x10m / RD25 / 10s'] },
    jatoDeAgua: { coluna: 'Dano / Alcance / Empurra', valores: ['1d-2 / 5m / 1m', '1d-1 / 7m / 1m', '1d / 10m / 2m', '1d+1 / 12m / 2m', '1d+2 / 15m / 3m', '2d-1 / 18m / 3m', '2d / 20m / 4m', '2d+1 / 22m / 4m', '2d+2 / 25m / 5m', '3d-1 / 30m / 5m', '3d / 35m / 6m', '3d+1 / 40m / 6m', '3d+2 / 45m / 7m', '4d-1 / 50m / 8m', '4d / 60m / 10m'] },
    ondaExpulsora: { coluna: 'Dano / Cone / Empurra', valores: ['1d-2 / 3m / 1m', '1d-1 / 4m / 1m', '1d / 5m / 2m', '1d+1 / 6m / 2m', '1d+2 / 7m / 3m', '2d-1 / 8m / 3m', '2d / 9m / 4m', '2d+1 / 10m / 4m', '2d+2 / 12m / 5m', '3d-1 / 14m / 5m', '3d / 16m / 6m', '3d+1 / 18m / 6m', '3d+2 / 20m / 7m', '4d-1 / 25m / 8m', '4d / 30m / 10m'] },
    adagaDeGelo: { coluna: 'Dano (Perfuração)', valores: ['1d-2', '1d-1', '1d', '1d+1', '1d+2', '2d-1', '2d', '2d+1', '2d+2', '3d-1', '3d', '3d+1', '3d+2', '4d-1', '4d'] },
    golemDeAgua: { coluna: 'PV / FOR / Tamanho', valores: ['10 / 8 / 0.8m', '15 / 9 / 1.0m', '20 / 10 / 1.2m', '25 / 11 / 1.4m', '30 / 12 / 1.6m', '35 / 13 / 1.8m', '40 / 14 / 2.0m', '45 / 15 / 2.2m', '50 / 16 / 2.5m', '60 / 17 / 2.8m', '70 / 18 / 3.0m', '80 / 19 / 3.3m', '90 / 20 / 3.6m', '100 / 21 / 4.0m', '120 / 22 / 5.0m'] },
    tempestadeDeGelo: { coluna: 'Dano em Área', valores: ['1d-2', '1d-1', '1d', '1d+1', '1d+2', '2d-1', '2d', '2d+1', '2d+2', '3d-1', '3d', '3d+1', '3d+2', '4d-1', '4d'] },
    congelamento: { coluna: 'Duração / Chance', valores: ['1s / 10%', '2s / 15%', '3s / 20%', '4s / 25%', '5s / 30%', '6s / 35%', '7s / 40%', '8s / 45%', '9s / 50%', '10s / 55%', '12s / 60%', '15s / 65%', '20s / 70%', '30s / 75%', '1min / 80%'] }
};

const catalogoPericias = [
    { id: "adestramento", nome: "Adestramento", tipo: "mental", atributo: "iq", descricao: "Treinar e comandar animais" },
    { id: "alquimia", nome: "Alquimia", tipo: "mental", atributo: "iq", descricao: "Criar poções e misturas" },
    { id: "artista", nome: "Artista", tipo: "mental", atributo: "iq", descricao: "Pintura, música, escultura" },
    { id: "comercio", nome: "Comércio", tipo: "mental", atributo: "iq", descricao: "Negociar e avaliar mercadorias" },
    { id: "culinaria", nome: "Culinária", tipo: "mental", atributo: "iq", descricao: "Preparar alimentos" },
    { id: "persuasao", nome: "Persuasão", tipo: "mental", atributo: "iq", descricao: "Convencer alguém" },
    { id: "detectarMentira", nome: "Detecção de Mentira", tipo: "mental", atributo: "iq", descricao: "Perceber se alguém mente" },
    { id: "diplomacia", nome: "Diplomacia", tipo: "mental", atributo: "iq", descricao: "Resolver conflitos" },
    { id: "falcoaria", nome: "Falcoaria", tipo: "mental", atributo: "iq", descricao: "Treinar aves de rapina" },
    { id: "interrogatorio", nome: "Interrogatório", tipo: "mental", atributo: "iq", descricao: "Extrair informações" },
    { id: "intimidacao", nome: "Intimidação", tipo: "mental", atributo: "iq", descricao: "Assustar ou coagir" },
    { id: "labia", nome: "Lábia", tipo: "mental", atributo: "iq", descricao: "Conversa fiada, enganar" },
    { id: "lideranca", nome: "Liderança", tipo: "mental", atributo: "iq", descricao: "Comandar e inspirar" },
    { id: "manha", nome: "Manha", tipo: "mental", atributo: "iq", descricao: "Ardis e truques" },
    { id: "medicina", nome: "Medicina", tipo: "mental", atributo: "iq", descricao: "Tratar doenças" },
    { id: "ocultamento", nome: "Ocultamento", tipo: "mental", atributo: "iq", descricao: "Esconder objetos" },
    { id: "ocultismo", nome: "Ocultismo", tipo: "mental", atributo: "iq", descricao: "Conhecimento do sobrenatural" },
    { id: "prestidigitacao", nome: "Prestidigitação", tipo: "mental", atributo: "iq", descricao: "Truques com as mãos" },
    { id: "primeirosSocorros", nome: "Primeiros Socorros", tipo: "mental", atributo: "iq", descricao: "Atendimento emergencial" },
    { id: "rastreamento", nome: "Rastreamento", tipo: "mental", atributo: "iq", descricao: "Seguir pistas e rastros" },
    { id: "veneficio", nome: "Venefício", tipo: "mental", atributo: "iq", descricao: "Preparar venenos" },
    { id: "acrobacia", nome: "Acrobacia", tipo: "fisica", atributo: "dx", descricao: "Saltos, cambalhotas" },
    { id: "arco", nome: "Arco", tipo: "fisica", atributo: "dx", descricao: "Atirar com arco e flecha" },
    { id: "esgrima", nome: "Esgrima", tipo: "fisica", atributo: "dx", descricao: "Lutar com armas brancas" },
    { id: "armasHaste", nome: "Armas de Haste", tipo: "fisica", atributo: "dx", descricao: "Lanças, alabardas" },
    { id: "chicote", nome: "Chicote", tipo: "fisica", atributo: "dx", descricao: "Usar chicote" },
    { id: "espada", nome: "Espada", tipo: "fisica", atributo: "dx", descricao: "Todos os tipos de espada" },
    { id: "mangual", nome: "Mangual", tipo: "fisica", atributo: "dx", descricao: "Armas com corrente" },
    { id: "kuzari", nome: "Kuzari", tipo: "fisica", atributo: "dx", descricao: "Corrente com peso" },
    { id: "arremesso", nome: "Arremesso", tipo: "fisica", atributo: "dx", descricao: "Lançar objetos" },
    { id: "bastao", nome: "Bastão", tipo: "fisica", atributo: "dx", descricao: "Lutar com cajado" },
    { id: "besta", nome: "Besta", tipo: "fisica", atributo: "dx", descricao: "Atirar com besta" },
    { id: "boleadeira", nome: "Boleadeira", tipo: "fisica", atributo: "dx", descricao: "Armas de laço" },
    { id: "boxe", nome: "Boxe", tipo: "fisica", atributo: "dx", descricao: "Socos" },
    { id: "briga", nome: "Briga", tipo: "fisica", atributo: "dx", descricao: "Luta corporal suja" },
    { id: "capa", nome: "Capa", tipo: "fisica", atributo: "dx", descricao: "Usar capa em combate" },
    { id: "cavalgar", nome: "Cavalgar", tipo: "fisica", atributo: "dx", descricao: "Montaria" },
    { id: "escalada", nome: "Escalada", tipo: "fisica", atributo: "dx", descricao: "Subir superfícies" },
    { id: "escudo", nome: "Escudo", tipo: "fisica", atributo: "dx", descricao: "Bloquear com escudo" },
    { id: "fuga", nome: "Fuga", tipo: "fisica", atributo: "dx", descricao: "Escapar de amarras" },
    { id: "funda", nome: "Funda", tipo: "fisica", atributo: "dx", descricao: "Atirar com funda" },
    { id: "furtividade", nome: "Furtividade", tipo: "fisica", atributo: "dx", descricao: "Esgueirar-se" },
    { id: "jitteSai", nome: "Jitte/Sai", tipo: "fisica", atributo: "dx", descricao: "Armas de defesa" },
    { id: "punga", nome: "Punga", tipo: "fisica", atributo: "dx", descricao: "Furtar carteiras" },
    { id: "zarabatana", nome: "Zarabatana", tipo: "fisica", atributo: "dx", descricao: "Atirar dardos" },
    { id: "boemia", nome: "Boemia", tipo: "organica", atributo: "ht", descricao: "Beber sem se embriagar" },
    { id: "caminhada", nome: "Caminhada", tipo: "organica", atributo: "ht", descricao: "Andar longas distâncias" },
    { id: "corrida", nome: "Corrida", tipo: "organica", atributo: "ht", descricao: "Correr rápido" },
    { id: "natacao", nome: "Natação", tipo: "organica", atributo: "ht", descricao: "Nadar" },
    { id: "sexAppeal", nome: "Sex Appeal", tipo: "organica", atributo: "ht", descricao: "Atrair sexualmente" }
];

function showLoading() {
    loadingOverlay.classList.add('active');
}

function hideLoading() {
    loadingOverlay.classList.remove('active');
}

function setAutoSaveIndicator(state) {
    if (!autoSaveIndicator) return;
    
    autoSaveIndicator.className = 'auto-save-indicator';
    if (state === 'saving') {
        autoSaveIndicator.classList.add('saving');
        autoSaveIndicator.innerHTML = '<i class="fas fa-circle"></i><span>Salvando...</span>';
    } else if (state === 'saved') {
        autoSaveIndicator.classList.add('saved');
        autoSaveIndicator.innerHTML = '<i class="fas fa-circle"></i><span>Salvo</span>';
    } else if (state === 'error') {
        autoSaveIndicator.innerHTML = '<i class="fas fa-circle" style="color: #ff6b6b;"></i><span>Erro ao salvar</span>';
    }
}

function triggerAutoSave() {
    if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        if (auth.currentUser) {
            salvarRascunho();
        }
    }, 3000);
}

function criarBolinhas(atributoId) {
    const container = document.getElementById(`${atributoId}Bolinhas`);
    if (!container) return;
    
    container.innerHTML = '';
    for (let i = 0; i < 15; i++) {
        const bolinha = document.createElement('div');
        bolinha.className = 'bolinha';
        bolinha.dataset.index = i;
        bolinha.dataset.atributo = atributoId;
        bolinha.addEventListener('click', () => {
            const atributo = atributos[atributoId];
            const clicada = i < atributo.bolinhas;
            
            if (!clicada && pontosRestantes > 0) {
                atributo.bolinhas++;
                if (atributoId === 'st' || atributoId === 'dx' || atributoId === 'iq') {
                    atributo.valor = atributo.base + atributo.bolinhas;
                }
                pontosRestantes--;
            } else if (clicada) {
                atributo.bolinhas--;
                if (atributoId === 'st' || atributoId === 'dx' || atributoId === 'iq') {
                    atributo.valor = atributo.base + atributo.bolinhas;
                }
                pontosRestantes++;
            }
            atualizarInterface();
            triggerAutoSave();
        });
        container.appendChild(bolinha);
    }
    atualizarBolinhas(atributoId);
}

function atualizarBolinhas(atributoId) {
    const container = document.getElementById(`${atributoId}Bolinhas`);
    if (!container) return;
    
    const bolinhas = container.children;
    const qtdPreenchidas = atributos[atributoId].bolinhas;
    
    for (let i = 0; i < bolinhas.length; i++) {
        if (i < qtdPreenchidas) {
            bolinhas[i].classList.add('preenchida');
        } else {
            bolinhas[i].classList.remove('preenchida');
        }
    }
}

function calcularHT() {
    return 8 + atributos.ht.bolinhas;
}

function calcularPV() {
    return calcularHT() * 8;
}

function calcularFadiga() {
    return 8 + atributos.ht.bolinhas;
}

function calcularMana() {
    return calcularFadiga() + atributos.iq.valor;
}

function calcularDeslocamento() {
    return (atributos.st.valor + atributos.dx.valor + calcularHT()) / 5;
}

function calcularEsquiva() {
    const carga = calcularCarga();
    let esquiva = Math.floor((atributos.dx.valor + calcularHT()) / 6) + 6;
    return Math.max(0, esquiva - carga.reducaoEsquiva);
}

function calcularAparar() {
    let melhorNH = 0;
    let temArma = false;
    
    inventario.corpo.forEach(item => {
        if (item.dano && item.tipo !== 'escudo') {
            temArma = true;
            let periciaId = 'espada';
            const nomeItem = item.nome.toLowerCase();
            if (nomeItem.includes('machado')) periciaId = 'adestramento';
            else if (nomeItem.includes('espada')) periciaId = 'espada';
            else if (nomeItem.includes('arco')) periciaId = 'arco';
            else if (nomeItem.includes('besta')) periciaId = 'besta';
            
            const pericia = pericias[periciaId];
            if (pericia) {
                const bonus = pericia.nivel === 1 ? 0 : pericia.nivel - 1;
                const nh = atributos.dx.valor + bonus;
                if (nh > melhorNH) melhorNH = nh;
            }
        }
    });
    
    if (!temArma) return 0;
    if (melhorNH === 0) melhorNH = atributos.dx.valor;
    
    return Math.floor((melhorNH + atributos.dx.valor) / 4) + 6;
}

function calcularBloqueio() {
    let melhorNH = 0;
    let bonusEscudo = 0;
    let temEscudo = false;
    
    inventario.corpo.forEach(item => {
        if (item.tipo === 'escudo' || item.nome.toLowerCase().includes('escudo')) {
            temEscudo = true;
            bonusEscudo = item.bonus || 0;
            const pericia = pericias['escudo'];
            if (pericia) {
                const bonus = pericia.nivel === 1 ? 0 : pericia.nivel - 1;
                const nh = atributos.dx.valor + bonus;
                if (nh > melhorNH) melhorNH = nh;
            }
        }
    });
    
    if (!temEscudo) return 0;
    if (melhorNH === 0) melhorNH = atributos.dx.valor;
    
    return Math.floor((melhorNH + atributos.dx.valor) / 4) + 6 + bonusEscudo;
}

function calcularRD() {
    let rdCorpo = 0, rdCabeca = 0, rdMembros = 0;
    
    inventario.corpo.forEach(item => {
        if (item.rd) {
            if (item.local === 'completo') {
                rdCorpo += item.rd;
                rdCabeca += item.rd;
                rdMembros += item.rd;
            } else if (item.local === 'torso') {
                rdCorpo += item.rd;
            } else if (item.local === 'membros') {
                rdMembros += item.rd;
            }
        }
    });
    
    return { corpo: rdCorpo, cabeca: rdCabeca, membros: rdMembros };
}

function atualizarArmaEquipada() {
    let arma = null;
    inventario.corpo.forEach(item => {
        if (item.dano && item.tipo !== 'escudo') arma = item;
    });
    
    if (arma) {
        armaNome.textContent = arma.nome;
        armaDano.textContent = arma.dano;
        armaTipo.textContent = arma.tipoDano || '-';
        armaAlcance.textContent = arma.alcance || '-';
    } else {
        armaNome.textContent = 'Nenhuma';
        armaDano.textContent = '-';
        armaTipo.textContent = '-';
        armaAlcance.textContent = '-';
    }
}

function atualizarEscudoPV() {
    let escudo = null;
    inventario.corpo.forEach(item => {
        if (item.tipo === 'escudo' || item.nome.toLowerCase().includes('escudo')) escudo = item;
    });
    
    if (escudo && escudo.ve) {
        const partes = escudo.ve.split('/');
        if (partes.length === 2) {
            escudoPVMax = parseInt(partes[1]) || 30;
            if (escudoPVAtual === 0) escudoPVAtual = escudoPVMax;
            
            escudoPVContainer.style.display = 'block';
            escudoPVTexto.textContent = `${escudoPVAtual}/${escudoPVMax}`;
            const percentual = (escudoPVAtual / escudoPVMax) * 100;
            escudoPVBarra.style.width = percentual + '%';
        }
    } else {
        escudoPVContainer.style.display = 'none';
    }
}

function atualizarCombate() {
    const ht = calcularHT();
    const pv = calcularPV();
    const fadiga = calcularFadiga();
    const mana = calcularMana();
    const deslocamento = calcularDeslocamento();
    const esquiva = calcularEsquiva();
    const aparar = calcularAparar();
    const bloqueio = calcularBloqueio();
    const rd = calcularRD();
    
    if (combatePV) combatePV.textContent = pv;
    if (thresholdAtordoamento) thresholdAtordoamento.textContent = 6 * ht;
    if (thresholdMorte) thresholdMorte.textContent = 8 * ht;
    
    if (combateFadiga) combateFadiga.textContent = fadiga;
    if (combateDeslocamento) combateDeslocamento.textContent = deslocamento.toFixed(1);
    if (defesaEsquiva) defesaEsquiva.textContent = esquiva;
    if (defesaAparar) defesaAparar.textContent = aparar;
    if (defesaBloqueio) defesaBloqueio.textContent = bloqueio;
    
    if (rdCorpo) rdCorpo.textContent = rd.corpo;
    if (rdCabeca) rdCabeca.textContent = rd.cabeca;
    if (rdMembros) rdMembros.textContent = rd.membros;
    
    atualizarArmaEquipada();
    atualizarEscudoPV();
    
    if (document.getElementById('statusVida')) {
        document.getElementById('statusVida').textContent = pv;
        document.getElementById('statusFadiga').textContent = fadiga;
        document.getElementById('statusMana').textContent = mana;
        document.getElementById('statusDeslocamento').textContent = deslocamento.toFixed(1);
        document.getElementById('statusEsquiva').textContent = esquiva;
    }
    
    if (document.getElementById('htValor')) {
        document.getElementById('htValor').textContent = ht;
    }
    if (document.getElementById('htVida')) {
        document.getElementById('htVida').textContent = `Vida ${pv}`;
    }
    if (document.getElementById('htFadiga')) {
        document.getElementById('htFadiga').textContent = `Fadiga ${fadiga}`;
    }
}

function atualizarInterface() {
    if (document.getElementById('stValor')) document.getElementById('stValor').textContent = atributos.st.valor;
    if (document.getElementById('dxValor')) document.getElementById('dxValor').textContent = atributos.dx.valor;
    if (document.getElementById('iqValor')) document.getElementById('iqValor').textContent = atributos.iq.valor;
    
    const ht = calcularHT();
    if (document.getElementById('htValor')) document.getElementById('htValor').textContent = ht;
    if (pontosRestantesSpan) pontosRestantesSpan.textContent = pontosRestantes;
    
    atualizarBolinhas('st');
    atualizarBolinhas('dx');
    atualizarBolinhas('iq');
    atualizarBolinhas('ht');
    
    const dano = tabelaDano[atributos.st.valor] || "1d-1";
    const esquiva = calcularEsquiva();
    const fadiga = calcularFadiga();
    const pv = calcularPV();
    const mana = calcularMana();
    const deslocamento = calcularDeslocamento();
    
    if (document.getElementById('stDano')) document.getElementById('stDano').textContent = dano;
    if (document.getElementById('dxEsquiva')) document.getElementById('dxEsquiva').textContent = `Esquiva ${esquiva}`;
    if (document.getElementById('iqVontade')) document.getElementById('iqVontade').textContent = `Vontade ${atributos.iq.valor}`;
    if (document.getElementById('htVida')) document.getElementById('htVida').textContent = `Vida ${pv}`;
    if (document.getElementById('htFadiga')) document.getElementById('htFadiga').textContent = `Fadiga ${fadiga}`;
    if (document.getElementById('statusVida')) document.getElementById('statusVida').textContent = pv;
    if (document.getElementById('statusFadiga')) document.getElementById('statusFadiga').textContent = fadiga;
    if (document.getElementById('statusMana')) document.getElementById('statusMana').textContent = mana;
    if (document.getElementById('statusDano')) document.getElementById('statusDano').textContent = dano;
    if (document.getElementById('statusEsquiva')) document.getElementById('statusEsquiva').textContent = esquiva;
    if (document.getElementById('statusDeslocamento')) document.getElementById('statusDeslocamento').textContent = deslocamento.toFixed(1);
    
    atualizarCombate();
    
    if (abaAtual === 'pericias') renderizarPericiasAdquiridas();
    if (abaAtual === 'magias') renderizarEsferas();
}

function calcularDinheiroInicial() {
    const base = parseInt(dinheiroBaseInput?.value) || 1000;
    const riquezaSelect = document.getElementById('riqueza');
    const riqueza = riquezaSelect?.value || 'medio';
    
    if (desvantagensSelecionadas.has('pobre') || riqueza === 'pobre') {
        return Math.floor(base / 2);
    } else if (vantagensSelecionadas.has('rico') || riqueza === 'rico') {
        return base * 5;
    } else {
        return base;
    }
}

function atualizarDinheiroDisplay() {
    dinheiro = calcularDinheiroInicial();
    if (dinheiroSaldo) dinheiroSaldo.textContent = dinheiro;
}

function calcularCarga() {
    const st = atributos.st.valor;
    const leve = st * 2;
    const media = st * 4;
    const pesada = st * 8;
    const limite = st * 12;
    
    let pesoTotal = 0;
    
    inventario.corpo.forEach(item => pesoTotal += (item.peso * (item.quantidade || 1)));
    inventario.mochila.forEach(item => pesoTotal += (item.peso * (item.quantidade || 1)));
    
    if (cargaAtual) cargaAtual.textContent = pesoTotal.toFixed(1);
    if (cargaLeve) cargaLeve.textContent = leve;
    if (cargaMedia) cargaMedia.textContent = media;
    if (cargaPesada) cargaPesada.textContent = pesada;
    if (cargaLimite) cargaLimite.textContent = limite;
    
    let percentual = (pesoTotal / limite) * 100;
    if (percentual > 100) percentual = 100;
    if (cargaBarra) cargaBarra.style.width = percentual + '%';
    
    let nivel = 'leve';
    let penalidade = 'Nenhuma';
    let reducaoEsquiva = 0;
    
    if (pesoTotal > pesada) {
        nivel = 'limite';
        penalidade = '-3 Esquiva';
        reducaoEsquiva = 3;
    } else if (pesoTotal > media) {
        nivel = 'pesado';
        penalidade = '-3 Esquiva';
        reducaoEsquiva = 3;
    } else if (pesoTotal > leve) {
        nivel = 'medio';
        penalidade = '-1 Esquiva';
        reducaoEsquiva = 1;
    }
    
    if (cargaNivel) {
        cargaNivel.textContent = nivel.charAt(0).toUpperCase() + nivel.slice(1);
        cargaNivel.className = `carga-nivel ${nivel}`;
    }
    if (cargaPenalidade) cargaPenalidade.textContent = penalidade;
    
    let pesoMochilaTotal = 0;
    inventario.mochila.forEach(item => pesoMochilaTotal += (item.peso * (item.quantidade || 1)));
    if (pesoMochila) pesoMochila.textContent = `(${pesoMochilaTotal.toFixed(1)} kg)`;
    
    return { nivel, reducaoEsquiva };
}

function carregarPericias() {
    renderizarCatalogoPericias('todas');
    renderizarPericiasAdquiridas();
}

function renderizarCatalogoPericias(filtro = 'todas') {
    if (!listaPericias) return;
    
    const periciasFiltradas = catalogoPericias.filter(p => filtro === 'todas' || p.tipo === filtro);
    
    listaPericias.innerHTML = periciasFiltradas.map(pericia => `
        <div class="pericia-card" data-pericia-id="${pericia.id}">
            <h4>${pericia.nome} <span class="tipo ${pericia.tipo}">${pericia.tipo === 'mental' ? 'IQ' : pericia.tipo === 'fisica' ? 'DX' : 'HT'}</span></h4>
            <div class="descricao">${pericia.descricao}</div>
            <div class="atributo">Atributo: ${pericia.atributo.toUpperCase()}</div>
        </div>
    `).join('');
    
    document.querySelectorAll('.pericia-card').forEach(card => {
        card.addEventListener('click', () => abrirModalPericia(card.dataset.periciaId));
    });
}

function renderizarPericiasAdquiridas() {
    if (!listaPericiasAdquiridas) return;
    
    const periciasArray = Object.entries(pericias);
    
    if (periciasArray.length === 0) {
        listaPericiasAdquiridas.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Clique em uma perícia do catálogo para adicionar</div>';
        return;
    }
    
    listaPericiasAdquiridas.innerHTML = periciasArray.map(([id, dados]) => {
        const pericia = catalogoPericias.find(p => p.id === id);
        const bonus = dados.nivel === 1 ? 0 : dados.nivel - 1;
        
        let atributoBase = 0;
        if (pericia?.atributo === 'st') atributoBase = atributos.st.valor;
        else if (pericia?.atributo === 'dx') atributoBase = atributos.dx.valor;
        else if (pericia?.atributo === 'iq') atributoBase = atributos.iq.valor;
        else if (pericia?.atributo === 'ht') atributoBase = 8;
        
        const nh = atributoBase + bonus;
        
        return `
            <div class="pericia-adquirida" data-pericia-id="${id}">
                <div class="pericia-adquirida-info">
                    <h4>${pericia?.nome || id}</h4>
                    <div class="nivel">Nível ${dados.nivel} <span class="bonus">(Bônus ${bonus > 0 ? '+' : ''}${bonus})</span></div>
                    <div class="nh">NH: <span>${nh}</span> (${pericia?.atributo.toUpperCase()} ${atributoBase} + ${bonus})</div>
                </div>
                <div class="pericia-adquirida-acoes">
                    <button class="btn-pericia btn-aumentar-pericia" data-pericia-id="${id}" ${pmGastoTotal >= pmDisponivel ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
                    <button class="btn-pericia btn-diminuir-pericia" data-pericia-id="${id}" ${dados.nivel <= 1 ? 'disabled' : ''}><i class="fas fa-minus"></i></button>
                </div>
            </div>
        `;
    }).join('');
    
    document.querySelectorAll('.btn-aumentar-pericia').forEach(btn => {
        btn.addEventListener('click', (e) => { 
            e.stopPropagation(); 
            aumentarPericia(btn.dataset.periciaId); 
        });
    });
    
    document.querySelectorAll('.btn-diminuir-pericia').forEach(btn => {
        btn.addEventListener('click', (e) => { 
            e.stopPropagation(); 
            diminuirPericia(btn.dataset.periciaId); 
        });
    });
}

function calcularCustoPericia(nivel) {
    return nivel === 1 ? 2 : 2 + ((nivel - 1) * 4);
}

function abrirModalPericia(periciaId) {
    const pericia = catalogoPericias.find(p => p.id === periciaId);
    if (!pericia) return;
    
    const periciaExistente = pericias[periciaId];
    const nivelAtual = periciaExistente?.nivel || 0;
    
    periciaAtual = {
        id: periciaId,
        nome: pericia.nome,
        nivelAtual: nivelAtual,
        novoNivel: nivelAtual + 1 || 1
    };
    
    modalPericiaNome.textContent = pericia.nome;
    modalPericiaNivel.textContent = periciaAtual.novoNivel;
    atualizarModalPericia();
    modalPericia.classList.add('active');
}

function atualizarModalPericia() {
    if (!periciaAtual) return;
    
    const novoNivel = periciaAtual.novoNivel;
    const nivelAtual = periciaAtual.nivelAtual;
    const custoTotal = calcularCustoPericia(novoNivel);
    const custoAtual = nivelAtual > 0 ? calcularCustoPericia(nivelAtual) : 0;
    const custoDiferenca = custoTotal - custoAtual;
    
    modalPericiaCusto.textContent = custoDiferenca + ' PM';
    modalPericiaConfirmar.disabled = custoDiferenca > (pmDisponivel - pmGastoTotal);
    
    if (nivelAtual > 0) {
        modalPericiaObservacao.textContent = `Nível atual: ${nivelAtual} (já gastou ${custoAtual} PM)`;
    } else {
        modalPericiaObservacao.textContent = 'Perícia nova';
    }
    
    modalPericiaMenos.disabled = novoNivel <= (nivelAtual > 0 ? nivelAtual + 1 : 1);
    modalPericiaMais.disabled = novoNivel >= 7;
}

function confirmarPericia() {
    if (!periciaAtual) return;
    
    const periciaId = periciaAtual.id;
    const novoNivel = periciaAtual.novoNivel;
    const nivelAtual = periciaAtual.nivelAtual;
    const custoTotal = calcularCustoPericia(novoNivel);
    const custoAtual = nivelAtual > 0 ? calcularCustoPericia(nivelAtual) : 0;
    const custoDiferenca = custoTotal - custoAtual;
    
    if (custoDiferenca > (pmDisponivel - pmGastoTotal)) { 
        alert('PM insuficiente!'); 
        return; 
    }
    
    pmGastoTotal += custoDiferenca;
    pericias[periciaId] = { nivel: novoNivel, custo: custoTotal };
    
    pmGasto.textContent = pmGastoTotal;
    pmRestante.textContent = pmDisponivel - pmGastoTotal;
    
    renderizarPericiasAdquiridas();
    atualizarContadoresAbas();
    modalPericia.classList.remove('active');
    atualizarCombate();
    triggerAutoSave();
}

function aumentarPericia(periciaId) {
    const pericia = pericias[periciaId];
    if (!pericia) return;
    
    const novoNivel = pericia.nivel + 1;
    if (novoNivel > 7) return;
    
    const custoAtual = calcularCustoPericia(pericia.nivel);
    const custoNovo = calcularCustoPericia(novoNivel);
    const custoDiferenca = custoNovo - custoAtual;
    
    if (custoDiferenca > (pmDisponivel - pmGastoTotal)) { 
        alert('PM insuficiente!'); 
        return; 
    }
    
    pmGastoTotal += custoDiferenca;
    pericia.nivel = novoNivel;
    pericia.custo = custoNovo;
    
    pmGasto.textContent = pmGastoTotal;
    pmRestante.textContent = pmDisponivel - pmGastoTotal;
    
    renderizarPericiasAdquiridas();
    atualizarContadoresAbas();
    atualizarCombate();
    triggerAutoSave();
}

function diminuirPericia(periciaId) {
    const pericia = pericias[periciaId];
    if (!pericia) return;
    
    const novoNivel = pericia.nivel - 1;
    if (novoNivel < 1) return;
    
    const custoAtual = calcularCustoPericia(pericia.nivel);
    const custoNovo = calcularCustoPericia(novoNivel);
    const custoDiferenca = custoAtual - custoNovo;
    
    pmGastoTotal -= custoDiferenca;
    
    if (novoNivel === 0) {
        delete pericias[periciaId];
    } else {
        pericia.nivel = novoNivel;
        pericia.custo = custoNovo;
    }
    
    pmGasto.textContent = pmGastoTotal;
    pmRestante.textContent = pmDisponivel - pmGastoTotal;
    
    renderizarPericiasAdquiridas();
    atualizarContadoresAbas();
    atualizarCombate();
    triggerAutoSave();
}

function custoNivelMagia(nivelAtual) {
    const novoNivel = nivelAtual + 1;
    if (novoNivel <= 5) return 2;
    if (novoNivel <= 10) return 4;
    return 6;
}

function renderizarEsferas() {
    if (!esferasGrid) return;
    
    const magiasLista = Object.entries(escolas.agua.magias);
    let html = '';
    
    magiasLista.forEach(([id, magia], index) => {
        const numero = index + 1;
        let classeEsfera = 'trancada';
        let iconeCadeado = '';
        let botaoAcao = '';
        
        if (magia.desbloqueada) {
            classeEsfera = 'desbloqueada';
        } else if (numero <= esferasDesbloqueadas + 1) {
            classeEsfera = 'disponivel';
            const custo = custoNivelMagia(0);
            botaoAcao = `<button class="btn-comprar-esfera" data-esfera-id="${id}" data-esfera-numero="${numero}">Desbloquear (${custo} PM)</button>`;
        } else {
            iconeCadeado = '<i class="fas fa-lock" style="color: #666; font-size: 1.2rem; margin: 5px 0;"></i>';
        }
        
        const nomesMagia = {
            localizarAgua: 'Localizar Água', purificarAgua: 'Purificar Água', criarAgua: 'Criar Água',
            dissiparAgua: 'Dissipar Água', respirarNaAgua: 'Respirar na Água', moldarAgua: 'Moldar Água',
            nevoeiro: 'Nevoeiro', armaCongelante: 'Arma Congelante', cortinaDagua: 'Cortina D\'água',
            jatoDeAgua: 'Jato de Água', ondaExpulsora: 'Onda Expulsora', adagaDeGelo: 'Adaga de Gelo',
            golemDeAgua: 'Golem de Água', tempestadeDeGelo: 'Tempestade de Gelo', congelamento: 'Congelamento'
        };
        
        html += `
            <div class="esfera-card ${classeEsfera}" data-magia-id="${id}">
                <div class="numero-esfera">${numero}</div>
                <div class="icone-esfera"><i class="fas ${magia.icone}"></i></div>
                ${iconeCadeado}
                <div class="nome-esfera">${nomesMagia[id] || id}</div>
                <div class="tipo-esfera">${magia.tipo}</div>
                ${magia.desbloqueada ? `<div class="nivel-esfera">Nível ${magia.nivel} <button class="btn-detalhe" data-magia-id="${id}" style="background:transparent; border:1px solid #ffd700; color:#ffd700; border-radius:15px; padding:2px 8px; margin-left:5px; cursor:pointer;"><i class="fas fa-search"></i></button></div>` : ''}
                ${botaoAcao}
            </div>
        `;
    });
    
    esferasGrid.innerHTML = html;
    
    document.querySelectorAll('.btn-comprar-esfera').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const esferaId = btn.dataset.esferaId;
            const custo = custoNivelMagia(0);
            
            if (custo > (pmDisponivel - pmGastoTotal)) { 
                alert('PM insuficiente!'); 
                return; 
            }
            
            pmGastoTotal += custo;
            escolas.agua.magias[esferaId].desbloqueada = true;
            escolas.agua.magias[esferaId].nivel = 1;
            esferasDesbloqueadas++;
            
            pmGasto.textContent = pmGastoTotal;
            pmRestante.textContent = pmDisponivel - pmGastoTotal;
            
            atualizarContadoresAbas();
            renderizarEsferas();
            triggerAutoSave();
        });
    });
    
    document.querySelectorAll('.btn-detalhe, .esfera-card.desbloqueada').forEach(el => {
        el.addEventListener('click', (e) => {
            if (e.target.closest('.btn-comprar-esfera')) return;
            
            const magiaId = el.closest('.esfera-card')?.dataset.magiaId || el.dataset.magiaId;
            if (magiaId && escolas.agua.magias[magiaId].desbloqueada) {
                abrirDetalheMagia(magiaId);
            }
        });
    });
}

function abrirDetalheMagia(magiaId) {
    const magia = escolas.agua.magias[magiaId];
    const tabela = tabelasMagia[magiaId];
    if (!magia || !tabela) return;
    
    magiaSelecionada = magiaId;
    
    const nomesMagia = {
        localizarAgua: 'Localizar Água', purificarAgua: 'Purificar Água', criarAgua: 'Criar Água',
        dissiparAgua: 'Dissipar Água', respirarNaAgua: 'Respirar na Água', moldarAgua: 'Moldar Água',
        nevoeiro: 'Nevoeiro', armaCongelante: 'Arma Congelante', cortinaDagua: 'Cortina D\'água',
        jatoDeAgua: 'Jato de Água', ondaExpulsora: 'Onda Expulsora', adagaDeGelo: 'Adaga de Gelo',
        golemDeAgua: 'Golem de Água', tempestadeDeGelo: 'Tempestade de Gelo', congelamento: 'Congelamento'
    };
    
    detalheMagiaTitulo.textContent = nomesMagia[magiaId] || magiaId;
    detalheMagiaInfo.textContent = `${magia.atributo} | Tipo: ${magia.tipo}`;
    
    let linhas = '';
    for (let i = 0; i < 15; i++) {
        const nivel = i + 1;
        const classe = nivel === magia.nivel ? 'nivel-atual' : '';
        const valor = tabela.valores[i] || '-';
        linhas += `<tr class="${classe}"><td>${nivel}</td><td>${valor}</td></tr>`;
    }
    corpoTabelaDetalhe.innerHTML = linhas;
    
    const custoProximoNivel = magia.nivel >= 15 ? 0 : custoNivelMagia(magia.nivel);
    comprarNivelMagia.disabled = magia.nivel >= 15 || (custoProximoNivel > (pmDisponivel - pmGastoTotal));
    comprarNivelMagia.textContent = magia.nivel >= 15 ? 'Nível Máximo' : `Comprar Nível ${magia.nivel + 1} (${custoProximoNivel} PM)`;
    
    detalheMagiaModal.classList.add('active');
}

function renderizarInventario() {
    if (!inventarioCorpo) return;
    
    const renderizarItens = (itens, local) => {
        return itens.map(item => `
            <div class="item-card" data-item-id="${item.id}" data-local="${local}">
                <div class="item-nome">
                    ${item.nome}
                    ${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}
                </div>
                <div class="item-detalhes">
                    <span class="item-peso">${(item.peso * (item.quantidade || 1)).toFixed(1)} kg</span>
                    <span class="item-preco">${item.preco} $</span>
                </div>
                <div class="item-acoes">
                    ${local !== 'deposito' ? `<button class="item-acao btn-mover-deposito" title="Mover para Depósito"><i class="fas fa-arrow-right"></i></button>` : ''}
                    ${local === 'mochila' ? `<button class="item-acao btn-equipar" title="Equipar"><i class="fas fa-user"></i></button>` : ''}
                    ${local === 'corpo' ? `<button class="item-acao btn-guardar" title="Guardar na Mochila"><i class="fas fa-shopping-bag"></i></button>` : ''}
                    ${local !== 'deposito' ? `<button class="item-acao btn-vender" title="Vender (50%)"><i class="fas fa-coins"></i></button>` : ''}
                    <button class="item-acao btn-descartar" title="Descartar"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');
    };
    
    inventarioCorpo.innerHTML = renderizarItens(inventario.corpo, 'corpo') || '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nada equipado</div>';
    inventarioMochila.innerHTML = renderizarItens(inventario.mochila, 'mochila') || '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Mochila vazia</div>';
    inventarioDeposito.innerHTML = inventario.deposito.map(item => `
        <div class="item-card" data-item-id="${item.id}" data-local="deposito">
            <div class="item-nome">
                ${item.nome}
                ${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}
            </div>
            <div class="item-detalhes">
                <span class="item-peso">${(item.peso * (item.quantidade || 1)).toFixed(1)} kg</span>
                <span class="item-preco">${item.preco} $</span>
            </div>
            <div class="item-acoes">
                <button class="item-acao btn-pegar" title="Pegar"><i class="fas fa-arrow-left"></i></button>
                <button class="item-acao btn-vender-deposito" title="Vender (50%)"><i class="fas fa-coins"></i></button>
                <button class="item-acao btn-descartar" title="Descartar"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    `).join('') || '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Depósito vazio</div>';
    
    adicionarEventosInventario();
    calcularCarga();
    atualizarCombate();
}

function adicionarEventosInventario() {
    document.querySelectorAll('.btn-mover-deposito').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.item-card');
            const itemId = card.dataset.itemId;
            const local = card.dataset.local;
            moverParaDeposito(itemId, local);
            triggerAutoSave();
        });
    });
    
    document.querySelectorAll('.btn-equipar').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.item-card');
            const itemId = card.dataset.itemId;
            equiparItem(itemId);
            triggerAutoSave();
        });
    });
    
    document.querySelectorAll('.btn-guardar').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.item-card');
            const itemId = card.dataset.itemId;
            guardarItem(itemId);
            triggerAutoSave();
        });
    });
    
    document.querySelectorAll('.btn-pegar').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.item-card');
            const itemId = card.dataset.itemId;
            pegarItem(itemId);
            triggerAutoSave();
        });
    });
    
    document.querySelectorAll('.btn-vender, .btn-vender-deposito').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.item-card');
            const itemId = card.dataset.itemId;
            const local = card.dataset.local;
            venderItem(itemId, local);
            triggerAutoSave();
        });
    });
    
    document.querySelectorAll('.btn-descartar').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.item-card');
            const itemId = card.dataset.itemId;
            const local = card.dataset.local;
            descartarItem(itemId, local);
            triggerAutoSave();
        });
    });
}

function moverParaDeposito(itemId, local) {
    const index = inventario[local].findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario[local][index];
        inventario.deposito.push(item);
        inventario[local].splice(index, 1);
        renderizarInventario();
        salvarInventario();
    }
}

function equiparItem(itemId) {
    const index = inventario.mochila.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario.mochila[index];
        
        if (item.st && atributos.st.valor < item.st) {
            alert(`Força insuficiente! Precisa de ST ${item.st}`);
            return;
        }
        
        inventario.corpo.push(item);
        inventario.mochila.splice(index, 1);
        renderizarInventario();
        salvarInventario();
        atualizarCombate();
    }
}

function guardarItem(itemId) {
    const index = inventario.corpo.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario.corpo[index];
        inventario.mochila.push(item);
        inventario.corpo.splice(index, 1);
        renderizarInventario();
        salvarInventario();
        atualizarCombate();
    }
}

function pegarItem(itemId) {
    const index = inventario.deposito.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario.deposito[index];
        inventario.mochila.push(item);
        inventario.deposito.splice(index, 1);
        renderizarInventario();
        salvarInventario();
    }
}

function venderItem(itemId, local) {
    const index = inventario[local].findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario[local][index];
        const valorVenda = Math.floor(item.preco * 0.5 * (item.quantidade || 1));
        dinheiro += valorVenda;
        dinheiroSaldo.textContent = dinheiro;
        
        if (item.quantidade > 1) {
            item.quantidade--;
        } else {
            inventario[local].splice(index, 1);
        }
        
        renderizarInventario();
        salvarInventario();
        if (local === 'corpo') atualizarCombate();
        triggerAutoSave();
    }
}

function descartarItem(itemId, local) {
    const index = inventario[local].findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario[local][index];
        if (item.quantidade > 1) {
            item.quantidade--;
        } else {
            inventario[local].splice(index, 1);
        }
        renderizarInventario();
        salvarInventario();
        if (local === 'corpo') atualizarCombate();
        triggerAutoSave();
    }
}

function salvarInventario() {
    if (personagemTemp) {
        personagemTemp.inventario = inventario;
        personagemTemp.dinheiro = dinheiro;
        sessionStorage.setItem('personagemTemp', JSON.stringify(personagemTemp));
    }
}

function selecionarVantagem(card) {
    const vantagemId = card.dataset.vantagem;
    
    if (vantagensSelecionadas.has(vantagemId)) {
        vantagensSelecionadas.delete(vantagemId);
        card.classList.remove('selecionada');
    } else {
        if (vantagensSelecionadas.size < 3) {
            vantagensSelecionadas.add(vantagemId);
            card.classList.add('selecionada');
        } else { 
            alert('Você já selecionou 3 vantagens!'); 
            return; 
        }
    }
    
    if (vantagemId === 'rico') {
        if (desvantagensSelecionadas.has('pobre')) {
            desvantagensSelecionadas.delete('pobre');
            document.querySelector('[data-desvantagem="pobre"]')?.classList.remove('selecionada');
        }
    }
    
    atualizarContadoresAbas();
    triggerAutoSave();
}

function selecionarDesvantagem(card) {
    const desvantagemId = card.dataset.desvantagem;
    
    if (desvantagensSelecionadas.has(desvantagemId)) {
        desvantagensSelecionadas.delete(desvantagemId);
        card.classList.remove('selecionada');
    } else {
        if (desvantagensSelecionadas.size < 4) {
            desvantagensSelecionadas.add(desvantagemId);
            card.classList.add('selecionada');
        } else { 
            alert('Você já selecionou 4 desvantagens!'); 
            return; 
        }
    }
    
    if (desvantagemId === 'pobre') {
        if (vantagensSelecionadas.has('rico')) {
            vantagensSelecionadas.delete('rico');
            document.querySelector('[data-vantagem="rico"]')?.classList.remove('selecionada');
        }
    }
    
    atualizarContadoresAbas();
    triggerAutoSave();
}

function carregarResumoPersonagem() {
    if (!personagemTemp) return;
    
    if (document.getElementById('resumoNome')) 
        document.getElementById('resumoNome').textContent = personagemTemp.nome || 'Sem nome';
    
    const classes = { guerreiro: 'Guerreiro', mago: 'Mago', ladino: 'Ladino', clerigo: 'Clérigo', barbaro: 'Bárbaro' };
    if (document.getElementById('resumoClasse')) 
        document.getElementById('resumoClasse').textContent = classes[personagemTemp.classe] || personagemTemp.classe;
    
    const aparencias = { feio: 'Feio', normal: 'Normal', atraente: 'Atraente' };
    if (document.getElementById('resumoAparencia')) 
        document.getElementById('resumoAparencia').textContent = aparencias[personagemTemp.aparencia] || 'Normal';
    
    const riquezas = { pobre: 'Pobre', medio: 'Médio', rico: 'Rico' };
    if (document.getElementById('resumoRiqueza')) 
        document.getElementById('resumoRiqueza').textContent = riquezas[personagemTemp.riqueza] || 'Médio';
    
    if (personagemTemp.fotoURL && document.getElementById('resumoFoto')) 
        document.getElementById('resumoFoto').innerHTML = `<img src="${personagemTemp.fotoURL}" alt="Foto">`;
}

function carregarResumoPersonagem2() {
    if (!personagemTemp) return;
    
    if (document.getElementById('resumoNome2')) 
        document.getElementById('resumoNome2').textContent = personagemTemp.nome || 'Sem nome';
    
    const classes = { guerreiro: 'Guerreiro', mago: 'Mago', ladino: 'Ladino', clerigo: 'Clérigo', barbaro: 'Bárbaro' };
    if (document.getElementById('resumoClasse2')) 
        document.getElementById('resumoClasse2').textContent = classes[personagemTemp.classe] || personagemTemp.classe;
    
    const aparencias = { feio: 'Feio', normal: 'Normal', atraente: 'Atraente' };
    if (document.getElementById('resumoAparencia2')) 
        document.getElementById('resumoAparencia2').textContent = aparencias[personagemTemp.aparencia] || 'Normal';
    
    const riquezas = { pobre: 'Pobre', medio: 'Médio', rico: 'Rico' };
    if (document.getElementById('resumoRiqueza2')) 
        document.getElementById('resumoRiqueza2').textContent = riquezas[personagemTemp.riqueza] || 'Médio';
    
    if (personagemTemp.fotoURL && document.getElementById('resumoFoto2')) 
        document.getElementById('resumoFoto2').innerHTML = `<img src="${personagemTemp.fotoURL}" alt="Foto">`;
}

function mudarAba(abaId) {
    abas.forEach(aba => {
        if (aba.dataset.aba === abaId) aba.classList.add('ativa');
        else aba.classList.remove('ativa');
    });
    
    conteudos.forEach(conteudo => {
        if (conteudo.id === `aba${abaId.charAt(0).toUpperCase() + abaId.slice(1)}`) {
            conteudo.classList.add('ativa');
        } else {
            conteudo.classList.remove('ativa');
        }
    });
    
    abaAtual = abaId;
    
    if (abaId === 'basicos') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'inline-flex';
        btnFinalizar.style.display = 'none';
    } else if (abaId === 'combate') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'inline-flex';
        btnFinalizar.style.display = 'none';
        atualizarCombate();
    } else if (abaId === 'vantagens') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'inline-flex';
        btnFinalizar.style.display = 'none';
        carregarResumoPersonagem();
    } else if (abaId === 'desvantagens') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'inline-flex';
        btnFinalizar.style.display = 'none';
        carregarResumoPersonagem2();
    } else if (abaId === 'pericias') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'none';
        btnFinalizar.style.display = 'inline-flex';
        carregarPericias();
    } else if (abaId === 'magias') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'none';
        btnFinalizar.style.display = 'inline-flex';
        renderizarEsferas();
    } else if (abaId === 'equipamentos') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'none';
        btnFinalizar.style.display = 'inline-flex';
        atualizarDinheiroDisplay();
        renderizarInventario();
        renderizarTabelas('armas_ca');
    }
}

function coletarDadosBasicos() {
    return {
        nome: document.getElementById('nomePersonagem')?.value || '',
        classe: document.getElementById('classePersonagem')?.value || 'guerreiro',
        idade: parseInt(document.getElementById('idadePersonagem')?.value) || 25,
        altura: parseInt(document.getElementById('alturaPersonagem')?.value) || 170,
        peso: parseFloat(document.getElementById('pesoPersonagem')?.value) || 70,
        aparencia: document.getElementById('aparencia')?.value || 'normal',
        riqueza: document.getElementById('riqueza')?.value || 'medio',
        dinheiroBase: parseInt(dinheiroBaseInput?.value) || 1000,
        peculiaridades: document.getElementById('peculiaridades')?.value || '',
        fotoURL: previewImage?.src || ''
    };
}

function salvarDadosBasicos() {
    const dados = coletarDadosBasicos();
    
    const pv = calcularPV();
    const fadiga = calcularFadiga();
    const mana = calcularMana();
    
    dinheiro = calcularDinheiroInicial();
    
    personagemTemp = {
        ...dados,
        atributos: {
            st: { bolinhas: atributos.st.bolinhas, valor: atributos.st.valor, base: 9 },
            dx: { bolinhas: atributos.dx.bolinhas, valor: atributos.dx.valor, base: 5 },
            iq: { bolinhas: atributos.iq.bolinhas, valor: atributos.iq.valor, base: 5 },
            ht: { bolinhas: atributos.ht.bolinhas, valor: 8, base: 8 }
        },
        status: { vidaMax: pv, fadigaMax: fadiga, manaMax: mana },
        inventario: inventario,
        dinheiro: dinheiro,
        vantagens: Array.from(vantagensSelecionadas),
        desvantagens: Array.from(desvantagensSelecionadas),
        fobia: fobiaSelecionada,
        pericias: pericias,
        escolas: escolas,
        esferasDesbloqueadas: esferasDesbloqueadas,
        pmDisponivel: pmDisponivel,
        pmGasto: pmGastoTotal
    };
    
    sessionStorage.setItem('personagemTemp', JSON.stringify(personagemTemp));
    return personagemTemp;
}

async function salvarPersonagem(finalizar = false) {
    try {
        setAutoSaveIndicator('saving');
        
        const user = auth.currentUser;
        if (!user) {
            alert('Usuário não autenticado!');
            window.location.href = 'index.html';
            return;
        }
        
        const dadosBasicos = coletarDadosBasicos();
        if (!dadosBasicos.nome.trim()) {
            alert('Digite um nome para o personagem');
            setAutoSaveIndicator('error');
            return;
        }
        
        const pv = calcularPV();
        const fadiga = calcularFadiga();
        const mana = calcularMana();
        
        let reacaoBase = 0;
        if (vantagensSelecionadas.has('atraente')) reacaoBase += 2;
        if (desvantagensSelecionadas.has('feio')) reacaoBase -= 2;
        
        const personagemData = {
            nome: dadosBasicos.nome,
            classe: dadosBasicos.classe,
            idade: dadosBasicos.idade,
            altura: dadosBasicos.altura,
            peso: dadosBasicos.peso,
            fotoURL: dadosBasicos.fotoURL,
            aparencia: dadosBasicos.aparencia,
            riqueza: dadosBasicos.riqueza,
            dinheiroBase: dadosBasicos.dinheiroBase,
            peculiaridades: dadosBasicos.peculiaridades,
            userId: user.uid,
            status: finalizar ? 'finalizado' : 'rascunho',
            createdAt: personagemId ? null : new Date(),
            updatedAt: new Date(),
            
            vantagens: Array.from(vantagensSelecionadas),
            desvantagens: Array.from(desvantagensSelecionadas),
            fobia: fobiaSelecionada,
            
            atributos: {
                st: atributos.st,
                dx: atributos.dx,
                iq: atributos.iq,
                ht: { ...atributos.ht, valor: 8 }
            },
            
            statusCombate: {
                vidaAtual: pv,
                vidaMax: pv,
                fadigaAtual: fadiga,
                fadigaMax: fadiga,
                manaAtual: mana,
                manaMax: mana
            },
            
            derivados: {
                danoBase: tabelaDano[atributos.st.valor] || "1d-1",
                esquiva: calcularEsquiva(),
                aparar: calcularAparar(),
                bloqueio: calcularBloqueio(),
                vontade: atributos.iq.valor,
                percepcao: atributos.iq.valor,
                deslocamento: calcularDeslocamento().toFixed(1),
                rd: calcularRD()
            },
            
            reacao: { base: reacaoBase, total: reacaoBase },
            
            pericias: pericias,
            escolas: escolas,
            esferasDesbloqueadas: esferasDesbloqueadas,
            
            pmDisponivel: pmDisponivel,
            pmGasto: pmGastoTotal,
            
            inventario: inventario,
            dinheiro: dinheiro
        };
        
        let docRef;
        if (personagemId) {
            docRef = doc(db, "personagens", personagemId);
            await updateDoc(docRef, personagemData);
        } else {
            docRef = doc(collection(db, "personagens"));
            personagemId = docRef.id;
            personagemData.id = personagemId;
            await setDoc(docRef, personagemData);
        }
        
        if (personagemIdHidden) personagemIdHidden.value = personagemId;
        if (breadcrumbCurrent) breadcrumbCurrent.textContent = `Editando: ${dadosBasicos.nome}`;
        if (pageTitle) pageTitle.textContent = `Editando Personagem: ${dadosBasicos.nome}`;
        
        setAutoSaveIndicator('saved');
        
        if (finalizar) {
            modalSalvarSucesso.style.display = 'flex';
        }
        
        return true;
        
    } catch (error) {
        setAutoSaveIndicator('error');
        alert('Erro ao salvar personagem');
        return false;
    }
}

async function salvarRascunho() {
    if (!auth.currentUser) return;
    await salvarPersonagem(false);
}

async function carregarPersonagem(id) {
    try {
        showLoading();
        
        const docRef = doc(db, "personagens", id);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) {
            alert('Personagem não encontrado!');
            window.location.href = 'personagens.html';
            return;
        }
        
        const data = docSnap.data();
        
        if (data.userId !== auth.currentUser?.uid) {
            alert('Você não tem permissão para editar este personagem!');
            window.location.href = 'personagens.html';
            return;
        }
        
        personagemId = id;
        modoEdicao = true;
        
        document.getElementById('nomePersonagem').value = data.nome || '';
        document.getElementById('classePersonagem').value = data.classe || 'guerreiro';
        document.getElementById('idadePersonagem').value = data.idade || 25;
        document.getElementById('alturaPersonagem').value = data.altura || 170;
        document.getElementById('pesoPersonagem').value = data.peso || 70;
        document.getElementById('aparencia').value = data.aparencia || 'normal';
        document.getElementById('riqueza').value = data.riqueza || 'medio';
        document.getElementById('dinheiroBase').value = data.dinheiroBase || 1000;
        document.getElementById('peculiaridades').value = data.peculiaridades || '';
        
        if (data.fotoURL) {
            previewImage.src = data.fotoURL;
            previewArea.style.display = 'block';
            uploadArea.style.display = 'none';
        }
        
        if (data.atributos) {
            atributos.st = data.atributos.st || { valor: 9, bolinhas: 0, base: 9 };
            atributos.dx = data.atributos.dx || { valor: 5, bolinhas: 0, base: 5 };
            atributos.iq = data.atributos.iq || { valor: 5, bolinhas: 0, base: 5 };
            atributos.ht = data.atributos.ht || { valor: 8, bolinhas: 0, base: 8 };
            
            pontosRestantes = 6 - (atributos.st.bolinhas + atributos.dx.bolinhas + atributos.iq.bolinhas + atributos.ht.bolinhas);
            atualizarInterface();
        }
        
        if (data.vantagens) {
            data.vantagens.forEach(v => vantagensSelecionadas.add(v));
        }
        if (data.desvantagens) {
            data.desvantagens.forEach(d => desvantagensSelecionadas.add(d));
        }
        if (data.fobia) {
            fobiaSelecionada = data.fobia;
            if (fobiaEscolhida) {
                fobiaEscolhida.style.display = 'inline-block';
                fobiaEscolhida.textContent = data.fobia;
            }
            if (cardFobia) cardFobia.classList.add('selecionada');
        }
        
        if (data.pericias) {
            pericias = data.pericias;
        }
        
        if (data.escolas) {
            escolas.agua = data.escolas.agua || escolas.agua;
            esferasDesbloqueadas = data.esferasDesbloqueadas || 0;
        }
        
        if (data.inventario) {
            inventario = data.inventario;
        }
        if (data.dinheiro !== undefined) {
            dinheiro = data.dinheiro;
        }
        
        if (data.pmDisponivel !== undefined) {
            pmDisponivel = data.pmDisponivel;
            pmInicial.value = pmDisponivel;
        }
        if (data.pmGasto !== undefined) {
            pmGastoTotal = data.pmGasto;
            pmGasto.textContent = pmGastoTotal;
            pmRestante.textContent = pmDisponivel - pmGastoTotal;
        }
        
        if (breadcrumbCurrent) breadcrumbCurrent.textContent = `Editando: ${data.nome}`;
        if (pageTitle) pageTitle.textContent = `Editando Personagem: ${data.nome}`;
        if (personagemIdHidden) personagemIdHidden.value = id;
        
        atualizarContadoresAbas();
        
    } catch (error) {
        alert('Erro ao carregar personagem!');
    } finally {
        hideLoading();
    }
}

async function excluirPersonagem() {
    if (!personagemId) {
        alert('Nenhum personagem para excluir');
        return;
    }
    
    try {
        showLoading();
        
        const docRef = doc(db, "personagens", personagemId);
        await deleteDoc(docRef);
        
        sessionStorage.removeItem('personagemTemp');
        
        window.location.href = 'personagens.html';
        
    } catch (error) {
        alert('Erro ao excluir personagem');
        hideLoading();
    }
}

async function exportarPDF() {
    try {
        showLoading();
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });
        
        let yPos = 20;
        
        pdf.setFontSize(22);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Ficha de Personagem - RPGForce', 105, yPos, { align: 'center' });
        
        yPos += 10;
        pdf.setDrawColor(0, 0, 0);
        pdf.setLineWidth(0.5);
        pdf.line(20, yPos, 190, yPos);
        yPos += 10;
        
        const nome = document.getElementById('nomePersonagem')?.value || 'Sem nome';
        const classe = document.getElementById('classePersonagem')?.value || 'guerreiro';
        const idade = document.getElementById('idadePersonagem')?.value || '25';
        const altura = document.getElementById('alturaPersonagem')?.value || '170';
        const peso = document.getElementById('pesoPersonagem')?.value || '70';
        
        const classes = { guerreiro: 'Guerreiro', mago: 'Mago', ladino: 'Ladino', clerigo: 'Clérigo', barbaro: 'Bárbaro' };
        
        pdf.setFontSize(14);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Dados Básicos', 20, yPos);
        yPos += 7;
        
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        pdf.setTextColor(0, 0, 0);
        pdf.text(`Nome: ${nome}`, 25, yPos);
        yPos += 6;
        pdf.text(`Classe: ${classes[classe] || classe}`, 25, yPos);
        yPos += 6;
        pdf.text(`Idade: ${idade} anos | Altura: ${altura} cm | Peso: ${peso} kg`, 25, yPos);
        yPos += 10;
        
        pdf.setFontSize(14);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Atributos', 20, yPos);
        yPos += 7;
        
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        pdf.setTextColor(0, 0, 0);
        
        const st = document.getElementById('stValor')?.textContent || '9';
        const dx = document.getElementById('dxValor')?.textContent || '5';
        const iq = document.getElementById('iqValor')?.textContent || '5';
        const ht = document.getElementById('htValor')?.textContent || '8';
        
        pdf.text(`ST (Força): ${st}`, 25, yPos);
        yPos += 6;
        pdf.text(`DX (Destreza): ${dx}`, 25, yPos);
        yPos += 6;
        pdf.text(`IQ (Inteligência): ${iq}`, 25, yPos);
        yPos += 6;
        pdf.text(`HT (Vigor): ${ht}`, 25, yPos);
        yPos += 10;
        
        const pv = document.getElementById('statusVida')?.textContent || '48';
        const fp = document.getElementById('statusFadiga')?.textContent || '8';
        const mp = document.getElementById('statusMana')?.textContent || '13';
        const esquiva = document.getElementById('statusEsquiva')?.textContent || '5';
        const dano = document.getElementById('statusDano')?.textContent || '1d-1';
        const desloc = document.getElementById('statusDeslocamento')?.textContent || '12.2';
        
        pdf.setFontSize(14);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Status', 20, yPos);
        yPos += 7;
        
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        pdf.setTextColor(0, 0, 0);
        pdf.text(`PV: ${pv} | FP: ${fp} | PM: ${mp}`, 25, yPos);
        yPos += 6;
        pdf.text(`Esquiva: ${esquiva} | Dano: ${dano} | Deslocamento: ${desloc}`, 25, yPos);
        yPos += 10;
        
        pdf.setFontSize(14);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Combate', 20, yPos);
        yPos += 7;
        
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        pdf.setTextColor(0, 0, 0);
        
        const rdCorpoValor = document.getElementById('rdCorpo')?.textContent || '0';
        const rdCabecaValor = document.getElementById('rdCabeca')?.textContent || '0';
        const rdMembrosValor = document.getElementById('rdMembros')?.textContent || '0';
        
        pdf.text(`RD Corpo: ${rdCorpoValor} | RD Cabeça: ${rdCabecaValor} | RD Membros: ${rdMembrosValor}`, 25, yPos);
        yPos += 6;
        
        const armaEquipada = armaNome?.textContent || 'Nenhuma';
        const armaDanoValor = armaDano?.textContent || '-';
        pdf.text(`Arma: ${armaEquipada} (Dano: ${armaDanoValor})`, 25, yPos);
        yPos += 10;
        
        if (Object.keys(pericias).length > 0) {
            if (yPos > 250) {
                pdf.addPage();
                yPos = 20;
            }
            
            pdf.setFontSize(14);
            pdf.setTextColor(0, 0, 0);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Perícias', 20, yPos);
            yPos += 7;
            
            pdf.setFontSize(9);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(0, 0, 0);
            
            const periciasArray = Object.entries(pericias);
            periciasArray.forEach(([id, dados]) => {
                const pericia = catalogoPericias.find(p => p.id === id);
                const nomePericia = pericia?.nome || id;
                const bonus = dados.nivel === 1 ? 0 : dados.nivel - 1;
                
                let atributoBase = 0;
                if (pericia?.atributo === 'st') atributoBase = atributos.st.valor;
                else if (pericia?.atributo === 'dx') atributoBase = atributos.dx.valor;
                else if (pericia?.atributo === 'iq') atributoBase = atributos.iq.valor;
                else atributoBase = 8;
                
                const nh = atributoBase + bonus;
                
                pdf.text(`${nomePericia}: Nv ${dados.nivel} (NH ${nh})`, 25, yPos);
                yPos += 5;
                
                if (yPos > 280) {
                    pdf.addPage();
                    yPos = 20;
                }
            });
            yPos += 5;
        }
        
        const magiasDesbloqueadas = Object.entries(escolas.agua.magias).filter(([_, m]) => m.desbloqueada);
        if (magiasDesbloqueadas.length > 0) {
            if (yPos > 250) {
                pdf.addPage();
                yPos = 20;
            }
            
            pdf.setFontSize(14);
            pdf.setTextColor(0, 0, 0);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Magias', 20, yPos);
            yPos += 7;
            
            pdf.setFontSize(9);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(0, 0, 0);
            
            const nomesMagia = {
                localizarAgua: 'Localizar Água', purificarAgua: 'Purificar Água', criarAgua: 'Criar Água',
                dissiparAgua: 'Dissipar Água', respirarNaAgua: 'Respirar na Água', moldarAgua: 'Moldar Água',
                nevoeiro: 'Nevoeiro', armaCongelante: 'Arma Congelante', cortinaDagua: 'Cortina D\'água',
                jatoDeAgua: 'Jato de Água', ondaExpulsora: 'Onda Expulsora', adagaDeGelo: 'Adaga de Gelo',
                golemDeAgua: 'Golem de Água', tempestadeDeGelo: 'Tempestade de Gelo', congelamento: 'Congelamento'
            };
            
            magiasDesbloqueadas.forEach(([id, magia]) => {
                pdf.text(`${nomesMagia[id] || id}: Nv ${magia.nivel} (${magia.tipo})`, 25, yPos);
                yPos += 5;
                
                if (yPos > 280) {
                    pdf.addPage();
                    yPos = 20;
                }
            });
            yPos += 5;
        }
        
        if (inventario.corpo.length > 0 || inventario.mochila.length > 0 || inventario.deposito.length > 0) {
            if (yPos > 250) {
                pdf.addPage();
                yPos = 20;
            }
            
            pdf.setFontSize(14);
            pdf.setTextColor(0, 0, 0);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Equipamentos', 20, yPos);
            yPos += 7;
            
            if (inventario.corpo.length > 0) {
                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Equipado:', 25, yPos);
                yPos += 5;
                
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                inventario.corpo.forEach(item => {
                    pdf.text(`• ${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''} - ${item.peso}kg`, 30, yPos);
                    yPos += 5;
                    
                    if (yPos > 280) {
                        pdf.addPage();
                        yPos = 20;
                    }
                });
            }
            
            if (inventario.mochila.length > 0) {
                if (yPos > 260) {
                    pdf.addPage();
                    yPos = 20;
                }
                
                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Mochila:', 25, yPos);
                yPos += 5;
                
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                inventario.mochila.slice(0, 15).forEach(item => {
                    pdf.text(`• ${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''} - ${item.peso}kg`, 30, yPos);
                    yPos += 5;
                    
                    if (yPos > 280) {
                        pdf.addPage();
                        yPos = 20;
                    }
                });
            }
            
            if (inventario.deposito.length > 0 && yPos < 260) {
                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Depósito (Selecionado):', 25, yPos);
                yPos += 5;
                
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                inventario.deposito.slice(0, 10).forEach(item => {
                    pdf.text(`• ${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}`, 30, yPos);
                    yPos += 5;
                    
                    if (yPos > 280) {
                        pdf.addPage();
                        yPos = 20;
                    }
                });
            }
            yPos += 5;
        }
        
        if (yPos > 260) {
            pdf.addPage();
            yPos = 20;
        }
        
        pdf.setFontSize(14);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Vantagens', 20, yPos);
        yPos += 7;
        
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'normal');
        pdf.setTextColor(0, 0, 0);
        const vantagensList = Array.from(vantagensSelecionadas).join(', ') || 'Nenhuma';
        const linhasVantagens = pdf.splitTextToSize(vantagensList, 170);
        linhasVantagens.forEach(linha => {
            pdf.text(linha, 25, yPos);
            yPos += 5;
            
            if (yPos > 280) {
                pdf.addPage();
                yPos = 20;
            }
        });
        yPos += 5;
        
        if (yPos > 260) {
            pdf.addPage();
            yPos = 20;
        }
        
        pdf.setFontSize(14);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Desvantagens', 20, yPos);
        yPos += 7;
        
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'normal');
        pdf.setTextColor(0, 0, 0);
        
        let desvantagensList = Array.from(desvantagensSelecionadas).join(', ') || 'Nenhuma';
        if (fobiaSelecionada) {
            desvantagensList += `, Fobia: ${fobiaSelecionada}`;
        }
        const linhasDesvantagens = pdf.splitTextToSize(desvantagensList, 170);
        linhasDesvantagens.forEach(linha => {
            pdf.text(linha, 25, yPos);
            yPos += 5;
            
            if (yPos > 280) {
                pdf.addPage();
                yPos = 20;
            }
        });
        yPos += 5;
        
        const peculiaridades = document.getElementById('peculiaridades')?.value || '';
        if (peculiaridades) {
            if (yPos > 260) {
                pdf.addPage();
                yPos = 20;
            }
            
            pdf.setFontSize(14);
            pdf.setTextColor(0, 0, 0);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Peculiaridades', 20, yPos);
            yPos += 7;
            
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(0, 0, 0);
            const linhasPeculiaridades = pdf.splitTextToSize(peculiaridades, 170);
            linhasPeculiaridades.forEach(linha => {
                pdf.text(linha, 25, yPos);
                yPos += 5;
                
                if (yPos > 280) {
                    pdf.addPage();
                    yPos = 20;
                }
            });
        }
        
        pdf.save(`ficha_${nome.replace(/\s+/g, '_')}.pdf`);
        
    } catch (error) {
        alert('Erro ao gerar PDF');
    } finally {
        hideLoading();
    }
}

function renderizarTabelas(tab = 'armas_ca') {
    document.querySelectorAll('.tabela-item').forEach(t => t.classList.remove('ativa'));
    
    const mapaTabelas = {
        'armas_ca': 'tabelaArmasCA',
        'armas_dist': 'tabelaArmasDist',
        'armaduras': 'tabelaArmaduras',
        'escudos': 'tabelaEscudos',
        'itens_gerais': 'tabelaItensGerais'
    };
    
    const tabelaId = mapaTabelas[tab];
    const tabelaElement = document.getElementById(tabelaId);
    
    if (tabelaElement) {
        tabelaElement.classList.add('ativa');
    }
    
    renderizarTabelaArmasCA();
    renderizarTabelaArmasDist();
    renderizarTabelaArmaduras();
    renderizarTabelaEscudos();
    renderizarTabelaItensGerais();
}

function renderizarTabelaArmasCA() {
    const tbody = document.getElementById('corpoTabelaArmasCA');
    if (!tbody) return;
    
    let html = '';
    for (let i = 0; i < catalogoItensData.armas_ca.length; i++) {
        const item = catalogoItensData.armas_ca[i];
        html += `
            <tr>
                <td>${item.nome}</td>
                <td>${item.alcance}</td>
                <td>${item.dano}</td>
                <td>${item.tipoDano}</td>
                <td>${item.preco}</td>
                <td>${item.peso}</td>
                <td>${item.st}</td>
                <td>
                    <button class="btn-comprar-tabela" data-tipo="armas_ca" data-indice="${i}">
                        <i class="fas fa-cart-plus"></i> Comprar
                    </button>
                </td>
            </tr>
        `;
    }
    tbody.innerHTML = html;
    adicionarEventosCompra();
}

function renderizarTabelaArmasDist() {
    const tbody = document.getElementById('corpoTabelaArmasDist');
    if (!tbody) return;
    
    let html = '';
    for (let i = 0; i < catalogoItensData.armas_dist.length; i++) {
        const item = catalogoItensData.armas_dist[i];
        html += `
            <tr>
                <td>${item.nome}</td>
                <td>+${item.precisao}</td>
                <td>${item.dano}</td>
                <td>${item.tipoDano}</td>
                <td>${item.alcance}</td>
                <td>${item.preco}</td>
                <td>${item.peso}</td>
                <td>${item.st}</td>
                <td>
                    <button class="btn-comprar-tabela" data-tipo="armas_dist" data-indice="${i}">
                        <i class="fas fa-cart-plus"></i> Comprar
                    </button>
                </td>
            </tr>
        `;
    }
    tbody.innerHTML = html;
    adicionarEventosCompra();
}

function renderizarTabelaArmaduras() {
    const tbody = document.getElementById('corpoTabelaArmaduras');
    if (!tbody) return;
    
    let html = '';
    for (let i = 0; i < catalogoItensData.armaduras.length; i++) {
        const item = catalogoItensData.armaduras[i];
        html += `
            <tr>
                <td>${item.nome}</td>
                <td>${item.rd}</td>
                <td>${item.preco}</td>
                <td>${item.peso}</td>
                <td>
                    <button class="btn-comprar-tabela" data-tipo="armaduras" data-indice="${i}">
                        <i class="fas fa-cart-plus"></i> Comprar
                    </button>
                </td>
            </tr>
        `;
    }
    tbody.innerHTML = html;
    adicionarEventosCompra();
}

function renderizarTabelaEscudos() {
    const tbody = document.getElementById('corpoTabelaEscudos');
    if (!tbody) return;
    
    let html = '';
    for (let i = 0; i < catalogoItensData.escudos.length; i++) {
        const item = catalogoItensData.escudos[i];
        html += `
            <tr>
                <td>${item.nome}</td>
                <td>+${item.bonus}</td>
                <td>${item.ve}</td>
                <td>${item.preco}</td>
                <td>${item.peso}</td>
                <td>
                    <button class="btn-comprar-tabela" data-tipo="escudos" data-indice="${i}">
                        <i class="fas fa-cart-plus"></i> Comprar
                    </button>
                </td>
            </tr>
        `;
    }
    tbody.innerHTML = html;
    adicionarEventosCompra();
}

function renderizarTabelaItensGerais() {
    const tbody = document.getElementById('corpoTabelaItensGerais');
    if (!tbody) return;
    
    let html = '';
    for (let i = 0; i < catalogoItensData.itens_gerais.length; i++) {
        const item = catalogoItensData.itens_gerais[i];
        html += `
            <tr>
                <td>${item.nome}</td>
                <td>${item.especificacao || ''}</td>
                <td>${item.preco}</td>
                <td>${item.peso}</td>
                <td>
                    <button class="btn-comprar-tabela" data-tipo="itens_gerais" data-indice="${i}">
                        <i class="fas fa-cart-plus"></i> Comprar
                    </button>
                </td>
            </tr>
        `;
    }
    tbody.innerHTML = html;
    adicionarEventosCompra();
}

function adicionarEventosCompra() {
    document.querySelectorAll('.btn-comprar-tabela').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            
            const tipo = btn.dataset.tipo;
            const indice = parseInt(btn.dataset.indice);
            
            let item = null;
            if (tipo === 'armas_ca') item = catalogoItensData.armas_ca[indice];
            else if (tipo === 'armas_dist') item = catalogoItensData.armas_dist[indice];
            else if (tipo === 'armaduras') item = catalogoItensData.armaduras[indice];
            else if (tipo === 'escudos') item = catalogoItensData.escudos[indice];
            else if (tipo === 'itens_gerais') item = catalogoItensData.itens_gerais[indice];
            
            if (item) {
                comprarItem(item);
                triggerAutoSave();
            }
        });
    });
}

function comprarItem(item) {
    const preco = item.preco;
    
    if (dinheiro < preco) {
        alert(`Dinheiro insuficiente! Você tem $${dinheiro} e o item custa $${preco}`);
        return;
    }
    
    dinheiro -= preco;
    dinheiroSaldo.textContent = dinheiro;
    
    const novoItem = {
        ...item,
        id: item.id + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        quantidade: 1
    };
    
    const existente = inventario.deposito.find(i => i.nome === item.nome && i.preco === item.preco);
    if (existente) {
        existente.quantidade = (existente.quantidade || 1) + 1;
    } else {
        inventario.deposito.push(novoItem);
    }
    
    renderizarInventario();
    salvarInventario();
    setAutoSaveIndicator('saved');
    setTimeout(() => {
        setAutoSaveIndicator('saved');
    }, 1000);
}

function configurarCamposItemPersonalizado() {
    if (!itemPersonalizadoTipo || !camposEspecificos) return;
    
    const tipo = itemPersonalizadoTipo.value;
    let html = '';
    
    switch(tipo) {
        case 'arma_ca':
            html = `
                <div class="campo-dinamico">
                    <label>Alcance (m)</label>
                    <input type="number" id="itemAlcance" min="0" step="0.1" value="1">
                </div>
                <div class="campo-dinamico">
                    <label>Dano</label>
                    <input type="text" id="itemDano" placeholder="Ex: 1d+2" value="1d">
                </div>
                <div class="campo-dinamico">
                    <label>Tipo de Dano</label>
                    <select id="itemTipoDano">
                        <option value="Corte">Corte</option>
                        <option value="Perfuração">Perfuração</option>
                        <option value="Contusão">Contusão</option>
                        <option value="Corte/Perf">Corte/Perf</option>
                    </select>
                </div>
                <div class="campo-dinamico">
                    <label>ST Mínima</label>
                    <input type="number" id="itemSt" min="1" value="8">
                </div>
            `;
            break;
            
        case 'arma_distancia':
            html = `
                <div class="campo-dinamico">
                    <label>Precisão</label>
                    <input type="number" id="itemPrecisao" min="0" value="1">
                </div>
                <div class="campo-dinamico">
                    <label>Dano</label>
                    <input type="text" id="itemDano" placeholder="Ex: 2d" value="1d">
                </div>
                <div class="campo-dinamico">
                    <label>Tipo de Dano</label>
                    <select id="itemTipoDano">
                        <option value="Perf">Perfuração</option>
                        <option value="Corte">Corte</option>
                        <option value="Impacto">Impacto</option>
                    </select>
                </div>
                <div class="campo-dinamico">
                    <label>Alcance</label>
                    <input type="text" id="itemAlcance" placeholder="Ex: STx10" value="STx10">
                </div>
                <div class="campo-dinamico">
                    <label>ST Mínima</label>
                    <input type="number" id="itemSt" min="1" value="8">
                </div>
            `;
            break;
            
        case 'armadura':
            html = `
                <div class="campo-dinamico">
                    <label>RD (Redução de Dano)</label>
                    <input type="number" id="itemRd" min="0" value="2">
                </div>
                <div class="campo-dinamico">
                    <label>Localização</label>
                    <select id="itemLocal">
                        <option value="completo">Completo</option>
                        <option value="torso">Torso</option>
                        <option value="membros">Membros</option>
                        <option value="cabeca">Cabeça</option>
                    </select>
                </div>
            `;
            break;
            
        case 'escudo':
            html = `
                <div class="campo-dinamico">
                    <label>Bônus de Bloqueio</label>
                    <input type="number" id="itemBonus" min="0" value="1">
                </div>
                <div class="campo-dinamico">
                    <label>VE (Ex: 5/30)</label>
                    <input type="text" id="itemVe" placeholder="5/30" value="5/30">
                </div>
            `;
            break;
            
        default:
            html = '';
    }
    
    camposEspecificos.innerHTML = html;
}

function criarItemPersonalizado() {
    const nome = itemPersonalizadoNome?.value.trim();
    if (!nome) {
        alert('Digite um nome para o item');
        return;
    }
    
    const tipo = itemPersonalizadoTipo?.value;
    const preco = parseInt(itemPersonalizadoPreco?.value) || 10;
    const peso = parseFloat(itemPersonalizadoPeso?.value) || 1;
    const quantidade = parseInt(itemPersonalizadoQtd?.value) || 1;
    
    if (dinheiro < preco * quantidade) {
        alert('Dinheiro insuficiente!');
        return;
    }
    
    dinheiro -= preco * quantidade;
    dinheiroSaldo.textContent = dinheiro;
    
    const itemBase = {
        id: 'custom_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        nome: nome,
        tipo: tipo,
        preco: preco,
        peso: peso,
        quantidade: quantidade
    };
    
    switch(tipo) {
        case 'arma_ca':
            itemBase.alcance = parseFloat(document.getElementById('itemAlcance')?.value) || 1;
            itemBase.dano = document.getElementById('itemDano')?.value || '1d';
            itemBase.tipoDano = document.getElementById('itemTipoDano')?.value || 'Corte';
            itemBase.st = parseInt(document.getElementById('itemSt')?.value) || 8;
            break;
            
        case 'arma_distancia':
            itemBase.precisao = parseInt(document.getElementById('itemPrecisao')?.value) || 1;
            itemBase.dano = document.getElementById('itemDano')?.value || '1d';
            itemBase.tipoDano = document.getElementById('itemTipoDano')?.value || 'Perf';
            itemBase.alcance = document.getElementById('itemAlcance')?.value || 'STx10';
            itemBase.st = parseInt(document.getElementById('itemSt')?.value) || 8;
            break;
            
        case 'armadura':
            itemBase.rd = parseInt(document.getElementById('itemRd')?.value) || 2;
            itemBase.local = document.getElementById('itemLocal')?.value || 'completo';
            break;
            
        case 'escudo':
            itemBase.bonus = parseInt(document.getElementById('itemBonus')?.value) || 1;
            itemBase.ve = document.getElementById('itemVe')?.value || '5/30';
            break;
            
        default:
            itemBase.especificacao = 'Item personalizado';
    }
    
    const existente = inventario.deposito.find(i => i.nome === nome && i.preco === preco);
    if (existente) {
        existente.quantidade = (existente.quantidade || 1) + quantidade;
    } else {
        inventario.deposito.push(itemBase);
    }
    
    renderizarInventario();
    salvarInventario();
    
    modalCriarItem.classList.remove('active');
    
    itemPersonalizadoNome.value = '';
    itemPersonalizadoPreco.value = '10';
    itemPersonalizadoPeso.value = '1';
    itemPersonalizadoQtd.value = '1';
}

function atualizarContadoresAbas() {
    if (contadorVantagensAba) contadorVantagensAba.textContent = `${vantagensSelecionadas.size}/3`;
    if (contadorDesvantagensAba) contadorDesvantagensAba.textContent = `${desvantagensSelecionadas.size}/4`;
    if (contadorVantagensSpan) contadorVantagensSpan.textContent = `${vantagensSelecionadas.size}/3`;
    if (contadorDesvantagensSpan) contadorDesvantagensSpan.textContent = `${desvantagensSelecionadas.size}/4`;
    
    if (contadorPericiasAba) contadorPericiasAba.textContent = `${pmGastoTotal} PM`;
    
    const magiasDesbloqueadas = Object.values(escolas.agua.magias).filter(m => m.desbloqueada).length;
    if (contadorMagiasAba) contadorMagiasAba.textContent = `${magiasDesbloqueadas}/15`;
    if (esferasDesbloqueadasSpan) esferasDesbloqueadasSpan.textContent = esferasDesbloqueadas;
    
    const aptidao = vantagensSelecionadas.has('aptidaoMagica') ? 1 : 0;
    if (aptidaoMagicaValor) aptidaoMagicaValor.textContent = `+${aptidao}`;
    
    const pmMagias = Object.values(escolas.agua.magias).reduce((total, magia) => {
        let custoTotalMagia = 0;
        for (let i = 1; i <= magia.nivel; i++) {
            if (i <= 5) custoTotalMagia += 2;
            else if (i <= 10) custoTotalMagia += 4;
            else custoTotalMagia += 6;
        }
        return total + custoTotalMagia;
    }, 0);
    
    if (pmMagiasSpan) pmMagiasSpan.textContent = pmMagias;
    
    pmGasto.textContent = pmGastoTotal;
    pmRestante.textContent = pmDisponivel - pmGastoTotal;
    
    atualizarDinheiroDisplay();
}

function carregarDadosSalvos() {
    try {
        const salvos = sessionStorage.getItem('personagemTemp');
        if (salvos) {
            personagemTemp = JSON.parse(salvos);
            
            if (document.getElementById('nomePersonagem')) 
                document.getElementById('nomePersonagem').value = personagemTemp.nome || '';
            if (document.getElementById('classePersonagem')) 
                document.getElementById('classePersonagem').value = personagemTemp.classe || 'guerreiro';
            if (document.getElementById('idadePersonagem') && personagemTemp.idade)
                document.getElementById('idadePersonagem').value = personagemTemp.idade;
            if (document.getElementById('alturaPersonagem') && personagemTemp.altura)
                document.getElementById('alturaPersonagem').value = personagemTemp.altura;
            if (document.getElementById('pesoPersonagem') && personagemTemp.peso)
                document.getElementById('pesoPersonagem').value = personagemTemp.peso;
            if (document.getElementById('aparencia')) 
                document.getElementById('aparencia').value = personagemTemp.aparencia || 'normal';
            if (document.getElementById('riqueza')) 
                document.getElementById('riqueza').value = personagemTemp.riqueza || 'medio';
            if (document.getElementById('peculiaridades')) 
                document.getElementById('peculiaridades').value = personagemTemp.peculiaridades || '';
            if (personagemTemp.dinheiroBase && document.getElementById('dinheiroBase')) {
                document.getElementById('dinheiroBase').value = personagemTemp.dinheiroBase;
            }
            if (personagemTemp.fotoURL) {
                previewImage.src = personagemTemp.fotoURL;
                previewArea.style.display = 'block';
                uploadArea.style.display = 'none';
            }
            
            if (personagemTemp.atributos) {
                atributos.st = personagemTemp.atributos.st || { valor: 9, bolinhas: 0, base: 9 };
                atributos.dx = personagemTemp.atributos.dx || { valor: 5, bolinhas: 0, base: 5 };
                atributos.iq = personagemTemp.atributos.iq || { valor: 5, bolinhas: 0, base: 5 };
                atributos.ht = personagemTemp.atributos.ht || { valor: 8, bolinhas: 0, base: 8 };
                
                pontosRestantes = 6 - (atributos.st.bolinhas + atributos.dx.bolinhas + atributos.iq.bolinhas + atributos.ht.bolinhas);
                atualizarInterface();
            }
            
            if (personagemTemp.vantagens) {
                personagemTemp.vantagens.forEach(v => vantagensSelecionadas.add(v));
            }
            
            if (personagemTemp.desvantagens) {
                personagemTemp.desvantagens.forEach(d => desvantagensSelecionadas.add(d));
            }
            
            if (personagemTemp.fobia) {
                fobiaSelecionada = personagemTemp.fobia;
                if (fobiaEscolhida) {
                    fobiaEscolhida.style.display = 'inline-block';
                    fobiaEscolhida.textContent = personagemTemp.fobia;
                }
                if (cardFobia) cardFobia.classList.add('selecionada');
            }
            
            if (personagemTemp.pericias) {
                pericias = personagemTemp.pericias;
            }
            
            if (personagemTemp.inventario) {
                inventario = personagemTemp.inventario;
            }
            
            if (personagemTemp.dinheiro !== undefined) {
                dinheiro = personagemTemp.dinheiro;
            }
            
            if (personagemTemp.pmDisponivel !== undefined) {
                pmDisponivel = personagemTemp.pmDisponivel;
                pmInicial.value = pmDisponivel;
            }
            
            if (personagemTemp.pmGasto !== undefined) {
                pmGastoTotal = personagemTemp.pmGasto;
                pmGasto.textContent = pmGastoTotal;
                pmRestante.textContent = pmDisponivel - pmGastoTotal;
            }
            
            atualizarContadoresAbas();
        }
    } catch (e) {}
}

document.addEventListener('DOMContentLoaded', () => {
    criarBolinhas('st');
    criarBolinhas('dx');
    criarBolinhas('iq');
    criarBolinhas('ht');
    
    const urlParams = new URLSearchParams(window.location.search);
    const idParaEditar = urlParams.get('id');
    
    if (idParaEditar) {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await carregarPersonagem(idParaEditar);
            } else {
                window.location.href = 'index.html';
            }
        });
    } else {
        carregarDadosSalvos();
    }
    
    atualizarDinheiroDisplay();
    atualizarCombate();
    
    const camposAutoSave = [
        'nomePersonagem', 'classePersonagem', 'idadePersonagem', 'alturaPersonagem', 
        'pesoPersonagem', 'aparencia', 'riqueza', 'dinheiroBase', 'peculiaridades'
    ];
    
    camposAutoSave.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', triggerAutoSave);
            el.addEventListener('change', triggerAutoSave);
        }
    });
    
    abas.forEach(aba => {
        aba.addEventListener('click', () => {
            if (['combate', 'vantagens', 'desvantagens', 'pericias', 'magias', 'equipamentos'].includes(aba.dataset.aba)) {
                salvarDadosBasicos();
            }
            mudarAba(aba.dataset.aba);
        });
    });

    subabas.forEach(subaba => {
        subaba.addEventListener('click', () => {
            if (subaba.classList.contains('ativa') || subaba.disabled) return;
            
            document.querySelectorAll('.subaba').forEach(s => s.classList.remove('ativa'));
            subaba.classList.add('ativa');
            escolaSelecionada = subaba.dataset.subaba;
            renderizarEsferas();
        });
    });

    if (uploadArea) {
        uploadArea.addEventListener('click', () => fotoInput.click());
    }
    
    if (fotoInput) {
        fotoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewArea.style.display = 'block';
                    uploadArea.style.display = 'none';
                    triggerAutoSave();
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    if (removeFoto) {
        removeFoto.addEventListener('click', () => {
            previewArea.style.display = 'none';
            uploadArea.style.display = 'block';
            fotoInput.value = '';
            triggerAutoSave();
        });
    }

    document.querySelectorAll('.vantagem-card').forEach(card => {
        card.addEventListener('click', () => selecionarVantagem(card));
    });
    
    document.querySelectorAll('.desvantagem-card:not(#cardFobia)').forEach(card => {
        card.addEventListener('click', () => selecionarDesvantagem(card));
    });

    if (cardFobia) {
        cardFobia.addEventListener('click', () => modalFobias.classList.add('active'));
    }
    
    if (fecharModalFobias) {
        fecharModalFobias.addEventListener('click', () => modalFobias.classList.remove('active'));
    }
    
    if (modalFobias) {
        modalFobias.addEventListener('click', (e) => { 
            if (e.target === modalFobias) modalFobias.classList.remove('active'); 
        });
    }
    
    document.querySelectorAll('.fobia-item').forEach(item => {
        item.addEventListener('click', () => {
            if (desvantagensSelecionadas.size >= 4) { 
                alert('Você já selecionou 4 desvantagens!'); 
                modalFobias.classList.remove('active'); 
                return; 
            }
            
            const fobia = item.dataset.fobia;
            const nomeFobia = item.querySelector('h4')?.textContent || fobia;
            
            fobiaSelecionada = fobia;
            
            if (fobiaEscolhida) {
                fobiaEscolhida.style.display = 'inline-block';
                fobiaEscolhida.textContent = nomeFobia;
            }
            
            if (cardFobia) cardFobia.classList.add('selecionada');
            desvantagensSelecionadas.add(`fobia:${fobia}`);
            atualizarContadoresAbas();
            modalFobias.classList.remove('active');
            triggerAutoSave();
        });
    });

    document.querySelectorAll('.filtro-pericia').forEach(filtro => {
        filtro.addEventListener('click', () => {
            document.querySelectorAll('.filtro-pericia').forEach(f => f.classList.remove('ativo'));
            filtro.classList.add('ativo');
            renderizarCatalogoPericias(filtro.dataset.filtro);
        });
    });

    if (modalPericiaMais) {
        modalPericiaMais.addEventListener('click', () => {
            if (periciaAtual) { 
                periciaAtual.novoNivel++; 
                modalPericiaNivel.textContent = periciaAtual.novoNivel; 
                atualizarModalPericia(); 
            }
        });
    }
    
    if (modalPericiaMenos) {
        modalPericiaMenos.addEventListener('click', () => {
            if (periciaAtual) { 
                periciaAtual.novoNivel--; 
                modalPericiaNivel.textContent = periciaAtual.novoNivel; 
                atualizarModalPericia(); 
            }
        });
    }
    
    if (modalPericiaCancelar) {
        modalPericiaCancelar.addEventListener('click', () => modalPericia.classList.remove('active'));
    }
    
    if (modalPericiaConfirmar) {
        modalPericiaConfirmar.addEventListener('click', confirmarPericia);
    }

    if (pmInicial) {
        pmInicial.addEventListener('change', () => {
            pmDisponivel = parseInt(pmInicial.value) || 30;
            pmRestante.textContent = pmDisponivel - pmGastoTotal;
            triggerAutoSave();
        });
    }

    if (fecharDetalheMagia) {
        fecharDetalheMagia.addEventListener('click', () => detalheMagiaModal.classList.remove('active'));
    }
    
    if (comprarNivelMagia) {
        comprarNivelMagia.addEventListener('click', () => {
            if (!magiaSelecionada) return;
            
            const magia = escolas.agua.magias[magiaSelecionada];
            if (magia.nivel >= 15) return;
            
            const custo = custoNivelMagia(magia.nivel);
            if (custo > (pmDisponivel - pmGastoTotal)) { 
                alert('PM insuficiente!'); 
                return; 
            }
            
            pmGastoTotal += custo;
            magia.nivel++;
            
            pmGasto.textContent = pmGastoTotal;
            pmRestante.textContent = pmDisponivel - pmGastoTotal;
            
            atualizarContadoresAbas();
            abrirDetalheMagia(magiaSelecionada);
            renderizarEsferas();
            triggerAutoSave();
        });
    }

    document.querySelectorAll('.catalogo-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.catalogo-tab').forEach(t => t.classList.remove('ativo'));
            tab.classList.add('ativo');
            renderizarTabelas(tab.dataset.tab);
        });
    });

    if (btnCriarItem) {
        btnCriarItem.addEventListener('click', () => {
            configurarCamposItemPersonalizado();
            modalCriarItem.classList.add('active');
        });
    }

    if (itemPersonalizadoTipo) {
        itemPersonalizadoTipo.addEventListener('change', configurarCamposItemPersonalizado);
    }

    if (cancelarCriarItem) {
        cancelarCriarItem.addEventListener('click', () => {
            modalCriarItem.classList.remove('active');
        });
    }

    if (confirmarCriarItem) {
        confirmarCriarItem.addEventListener('click', criarItemPersonalizado);
    }

    if (btnAnterior) {
        btnAnterior.addEventListener('click', () => {
            if (abaAtual === 'combate') mudarAba('basicos');
            else if (abaAtual === 'vantagens') mudarAba('combate');
            else if (abaAtual === 'desvantagens') mudarAba('vantagens');
            else if (abaAtual === 'pericias') mudarAba('desvantagens');
            else if (abaAtual === 'magias') mudarAba('pericias');
            else if (abaAtual === 'equipamentos') mudarAba('magias');
        });
    }

    if (btnProximo) {
        btnProximo.addEventListener('click', () => {
            if (abaAtual === 'basicos') {
                const nome = document.getElementById('nomePersonagem')?.value.trim();
                if (!nome) { 
                    alert('Digite um nome para o personagem'); 
                    return; 
                }
                if (pontosRestantes > 0) { 
                    alert(`Você ainda tem ${pontosRestantes} pontos para distribuir`); 
                    return; 
                }
                salvarDadosBasicos();
                mudarAba('combate');
            } else if (abaAtual === 'combate') {
                mudarAba('vantagens');
            } else if (abaAtual === 'vantagens') {
                if (vantagensSelecionadas.size === 0) { 
                    alert('Escolha pelo menos 1 vantagem'); 
                    return; 
                }
                mudarAba('desvantagens');
            } else if (abaAtual === 'desvantagens') {
                if (desvantagensSelecionadas.size === 0) { 
                    alert('Escolha pelo menos 1 desvantagem'); 
                    return; 
                }
                mudarAba('pericias');
            }
        });
    }

    if (btnFinalizar) {
        btnFinalizar.addEventListener('click', async () => {
            if (vantagensSelecionadas.size === 0) { 
                alert('Escolha pelo menos 1 vantagem'); 
                return; 
            }
            if (desvantagensSelecionadas.size === 0) { 
                alert('Escolha pelo menos 1 desvantagem'); 
                return; 
            }
            if (desvantagensSelecionadas.size < 4) { 
                alert(`Você precisa escolher 4 desvantagens (faltam ${4 - desvantagensSelecionadas.size})`); 
                return; 
            }

            await salvarPersonagem(true);
        });
    }

    if (btnSalvarPersonagem) {
        btnSalvarPersonagem.addEventListener('click', async () => {
            await salvarPersonagem(false);
        });
    }

    if (btnExportarPDF) {
        btnExportarPDF.addEventListener('click', exportarPDF);
    }

    if (btnExcluirPersonagem) {
        btnExcluirPersonagem.addEventListener('click', () => {
            modalConfirmarExclusao.classList.add('active');
        });
    }

    if (cancelarExclusao) {
        cancelarExclusao.addEventListener('click', () => {
            modalConfirmarExclusao.classList.remove('active');
        });
    }

    if (confirmarExclusao) {
        confirmarExclusao.addEventListener('click', async () => {
            modalConfirmarExclusao.classList.remove('active');
            await excluirPersonagem();
        });
    }

    if (fecharModalSalvar) {
        fecharModalSalvar.addEventListener('click', () => {
            modalSalvarSucesso.style.display = 'none';
            window.location.href = 'personagens.html';
        });
    }
});

onAuthStateChanged(auth, async (user) => {
    if (user) {
        const docRef = doc(db, "usuarios", user.uid);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const userData = docSnap.data();
            if (displayIdPc) displayIdPc.textContent = userData.id_pc || '--------';
            if (displayNickname) displayNickname.textContent = userData.nickname || 'Aventureiro';
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.get('id') && !personagemTemp) {
            setTimeout(() => {
                salvarRascunho();
            }, 5000);
        }
        
    } else {
        window.location.href = 'index.html';
    }
});

if (btnSair) {
    btnSair.addEventListener('click', async () => {
        try { 
            showLoading(); 
            await signOut(auth); 
            window.location.href = 'index.html'; 
        } catch (error) { 
            hideLoading(); 
        }
    });
}

atualizarContadoresAbas();
</script>
</body>
</html>