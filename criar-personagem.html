<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Personagem - RPGForce</title>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #2a1a3a 100%);
            min-height: 100vh;
            color: #fff;
        }

        .magic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .magic-bg::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
        }

        .magic-bg::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 80% 80%, rgba(198, 40, 40, 0.1) 0%, transparent 50%);
            animation: pulse 10s ease-in-out infinite reverse;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .navbar {
            background: rgba(10, 10, 26, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 15px 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-area h2 {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.3rem;
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .user-id {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 30px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .user-id i {
            color: #ffd700;
        }

        .user-id .value {
            color: #ffd700;
            font-family: monospace;
            font-weight: 600;
        }

        .user-nick {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 215, 0, 0.1);
            padding: 6px 15px;
            border-radius: 30px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .user-nick i {
            color: #ffd700;
        }

        .btn-sair {
            background: transparent;
            border: 2px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 6px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-sair:hover {
            background: #ff6b6b;
            color: #0a0a1a;
            border-color: #ff6b6b;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .breadcrumb a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            color: #ffd700;
        }

        .breadcrumb i {
            font-size: 0.7rem;
            color: rgba(255, 215, 0, 0.5);
        }

        .breadcrumb .current {
            color: #ffd700;
        }

        .page-header h1 {
            font-family: 'MedievalSharp', cursive;
            font-size: 2rem;
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card {
            background: rgba(10, 10, 26, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 30px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .card-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }

        .card-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .card-section h2 {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 12px 15px;
            color: #fff;
            font-size: 1rem;
            width: 100%;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ffd700;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .upload-area {
            background: rgba(0, 0, 0, 0.2);
            border: 2px dashed rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.05);
        }

        .upload-area i {
            font-size: 2rem;
            color: #ffd700;
            margin-bottom: 10px;
            display: block;
        }

        .preview-area {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            margin: 10px 0;
        }

        .preview-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .btn-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pontos-restantes {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: bold;
        }

        .pontos-restantes .valor {
            font-size: 1.5rem;
            font-family: 'MedievalSharp', cursive;
        }

        .atributo-row {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .atributo-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .atributo-nome {
            font-weight: 600;
            color: #fff;
        }

        .atributo-valor {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffd700;
        }

        .bolinhas-container {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .bolinha {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }

        .bolinha.preenchida {
            background: #ffd700;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .bolinha:hover {
            transform: scale(1.1);
            border-color: #ffd700;
        }

        .atributo-detalhes {
            display: flex;
            gap: 15px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .status-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .status-item .label {
            display: block;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .status-item .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffd700;
        }

        .card-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn-primary, .btn-secondary {
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: #ffd700;
        }

        .btn-secondary:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 26, 0.9);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 215, 0, 0.2);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: #ffd700;
            font-size: 1.2rem;
            font-family: 'MedievalSharp', cursive;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .card { padding: 20px; }
            .form-row { grid-template-columns: 1fr; }
            .status-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="magic-bg"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando...</div>
    </div>

    <div class="container">
        <nav class="navbar">
            <div class="logo-area">
                <h2>RPGForce</h2>
            </div>

            <div class="user-info">
                <div class="user-id">
                    <i class="fas fa-id-card"></i>
                    <span class="value" id="displayIdPc">--------</span>
                </div>
                
                <div class="user-nick">
                    <i class="fas fa-user"></i>
                    <span id="displayNickname">Aventureiro</span>
                </div>
                
                <button class="btn-sair" id="btnSair">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </button>
            </div>
        </nav>

        <div class="breadcrumb">
            <a href="dashboard-pc.html"><i class="fas fa-home"></i> Dashboard</a>
            <i class="fas fa-chevron-right"></i>
            <a href="personagens.html">Personagens</a>
            <i class="fas fa-chevron-right"></i>
            <span class="current">Criar Personagem</span>
        </div>

        <div class="page-header">
            <h1>
                <i class="fas fa-dragon"></i> 
                Criar Novo Personagem
            </h1>
        </div>

        <div class="card">
            <!-- Dados Básicos -->
            <div class="card-section">
                <h2><i class="fas fa-user"></i> Dados Básicos</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="nomePersonagem">Nome do Personagem</label>
                        <input type="text" id="nomePersonagem" placeholder="Ex: Aric, o Caçador" maxlength="50">
                    </div>
                    
                    <div class="form-group">
                        <label for="classePersonagem">Classe</label>
                        <select id="classePersonagem">
                            <option value="guerreiro">Guerreiro</option>
                            <option value="mago">Mago</option>
                            <option value="ladino">Ladino</option>
                            <option value="clerigo">Clérigo</option>
                            <option value="barbaro">Bárbaro</option>
                        </select>
                    </div>
                </div>

                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-camera"></i>
                    <span>Clique para adicionar foto (opcional)</span>
                    <input type="file" id="fotoInput" accept="image/*" style="display: none;">
                </div>
                
                <div class="preview-area" id="previewArea" style="display: none;">
                    <img id="previewImage" src="" alt="Preview">
                    <button type="button" id="removeFoto" class="btn-remove"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <!-- Aparência, Riqueza e Peculiaridades -->
            <div class="card-section">
                <h2><i class="fas fa-user-circle"></i> Aparência e História</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="aparencia">Aparência</label>
                        <select id="aparencia">
                            <option value="feio">Feio (-2 reação)</option>
                            <option value="normal" selected>Normal</option>
                            <option value="atraente">Atraente (+2 reação)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="riqueza">Riqueza Inicial</label>
                        <select id="riqueza">
                            <option value="pobre">Pobre (25 moedas)</option>
                            <option value="medio" selected>Médio (50 moedas)</option>
                            <option value="rico">Rico (250 moedas)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="peculiaridades">Peculiaridades</label>
                    <textarea id="peculiaridades" placeholder="Ex: Fala sozinho quando nervoso... Tem uma cicatriz no rosto... Adora poesia..."></textarea>
                </div>
            </div>

            <!-- Atributos -->
            <div class="card-section">
                <h2><i class="fas fa-chart-bar"></i> Atributos</h2>
                
                <div class="pontos-restantes">
                    <span>Pontos para distribuir:</span>
                    <span class="valor" id="pontosRestantes">6</span>
                </div>

                <div class="atributo-row" data-atributo="st">
                    <div class="atributo-info">
                        <span class="atributo-nome">ST (Força)</span>
                        <span class="atributo-valor" id="stValor">9</span>
                    </div>
                    <div class="bolinhas-container" id="stBolinhas"></div>
                    <div class="atributo-detalhes">
                        <span class="dano" id="stDano">1d-1</span>
                    </div>
                </div>

                <div class="atributo-row" data-atributo="dx">
                    <div class="atributo-info">
                        <span class="atributo-nome">DX (Destreza)</span>
                        <span class="atributo-valor" id="dxValor">5</span>
                    </div>
                    <div class="bolinhas-container" id="dxBolinhas"></div>
                    <div class="atributo-detalhes">
                        <span class="esquiva" id="dxEsquiva">Esquiva 5</span>
                    </div>
                </div>

                <div class="atributo-row" data-atributo="iq">
                    <div class="atributo-info">
                        <span class="atributo-nome">IQ (Inteligência)</span>
                        <span class="atributo-valor" id="iqValor">5</span>
                    </div>
                    <div class="bolinhas-container" id="iqBolinhas"></div>
                    <div class="atributo-detalhes">
                        <span class="vontade" id="iqVontade">Vontade 5</span>
                    </div>
                </div>

                <div class="atributo-row" data-atributo="ht">
                    <div class="atributo-info">
                        <span class="atributo-nome">HT (Vigor)</span>
                        <span class="atributo-valor" id="htValor">48</span>
                    </div>
                    <div class="bolinhas-container" id="htBolinhas"></div>
                    <div class="atributo-detalhes">
                        <span class="vida" id="htVida">Vida 48</span>
                        <span class="fadiga" id="htFadiga">Fadiga 8</span>
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div class="card-section status-grid">
                <div class="status-item">
                    <span class="label">Vida:</span>
                    <span class="value" id="statusVida">48</span>
                </div>
                <div class="status-item">
                    <span class="label">Fadiga:</span>
                    <span class="value" id="statusFadiga">8</span>
                </div>
                <div class="status-item">
                    <span class="label">Mana:</span>
                    <span class="value" id="statusMana">53</span>
                </div>
                <div class="status-item">
                    <span class="label">Dano:</span>
                    <span class="value" id="statusDano">1d-1</span>
                </div>
                <div class="status-item">
                    <span class="label">Esquiva:</span>
                    <span class="value" id="statusEsquiva">5</span>
                </div>
                <div class="status-item">
                    <span class="label">Deslocamento:</span>
                    <span class="value" id="statusDeslocamento">4.8</span>
                </div>
            </div>

            <!-- Botões -->
            <div class="card-actions">
                <button type="button" class="btn-secondary" onclick="history.back()">
                    <i class="fas fa-arrow-left"></i> Cancelar
                </button>
                <button type="button" class="btn-primary" id="btnCriarPersonagem">
                    <i class="fas fa-save"></i> Criar Personagem
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { 
            getAuth, 
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc,
            setDoc,
            collection,
            getDoc
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBrx4JSmFay24k95pu1ICjFfVki8gs_uHw",
            authDomain: "rpgforce-e3227.firebaseapp.com",
            projectId: "rpgforce-e3227",
            storageBucket: "rpgforce-e3227.firebasestorage.app",
            messagingSenderId: "984517342332",
            appId: "1:984517342332:web:87d33aa4c84ff2a07685f9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const displayIdPc = document.getElementById('displayIdPc');
        const displayNickname = document.getElementById('displayNickname');
        const btnSair = document.getElementById('btnSair');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const btnCriar = document.getElementById('btnCriarPersonagem');
        
        const uploadArea = document.getElementById('uploadArea');
        const fotoInput = document.getElementById('fotoInput');
        const previewArea = document.getElementById('previewArea');
        const previewImage = document.getElementById('previewImage');
        const removeFoto = document.getElementById('removeFoto');

        const pontosRestantesSpan = document.getElementById('pontosRestantes');
        let pontosRestantes = 6;
        
        const atributos = {
            st: { valor: 9, bolinhas: 0, base: 9 },
            dx: { valor: 5, bolinhas: 0, base: 5 },
            iq: { valor: 5, bolinhas: 0, base: 5 },
            ht: { valor: 48, bolinhas: 0, base: 48 }
        };

        const tabelaDano = {
            9: "1d-1", 10: "1d", 11: "1d+1", 12: "1d+2",
            13: "2d-1", 14: "2d", 15: "2d+1", 16: "2d+2",
            17: "3d-1", 18: "3d", 19: "3d+1", 20: "3d+2"
        };

        function showLoading() { loadingOverlay.classList.add('active'); }
        function hideLoading() { loadingOverlay.classList.remove('active'); }

        function calcularDerivados() {
            const st = atributos.st.valor;
            const dano = tabelaDano[st] || "1d-1";
            document.getElementById('stDano').textContent = dano;
            
            const dx = atributos.dx.valor;
            const esquiva = Math.floor(dx / 2) + 3;
            document.getElementById('dxEsquiva').textContent = `Esquiva ${esquiva}`;
            
            const iq = atributos.iq.valor;
            document.getElementById('iqVontade').textContent = `Vontade ${iq}`;
            
            const ht = atributos.ht.valor;
            const fadiga = 8 + atributos.ht.bolinhas;
            document.getElementById('htVida').textContent = `Vida ${ht}`;
            document.getElementById('htFadiga').textContent = `Fadiga ${fadiga}`;
            
            document.getElementById('statusVida').textContent = ht;
            document.getElementById('statusFadiga').textContent = fadiga;
            document.getElementById('statusMana').textContent = iq + ht;
            document.getElementById('statusDano').textContent = dano;
            document.getElementById('statusEsquiva').textContent = esquiva;
            document.getElementById('statusDeslocamento').textContent = (ht / 10).toFixed(1);
        }

        function criarBolinhas(atributoId, totalBolinhas = 15) {
            const container = document.getElementById(`${atributoId}Bolinhas`);
            if (!container) return;
            
            container.innerHTML = '';
            
            for (let i = 0; i < totalBolinhas; i++) {
                const bolinha = document.createElement('div');
                bolinha.className = 'bolinha';
                bolinha.dataset.index = i;
                bolinha.dataset.atributo = atributoId;
                
                bolinha.addEventListener('click', () => {
                    const atributo = atributos[atributoId];
                    const clicada = i < atributo.bolinhas;
                    
                    if (!clicada && pontosRestantes > 0) {
                        atributo.bolinhas++;
                        atributo.valor = atributo.base + atributo.bolinhas;
                        pontosRestantes--;
                    } else if (clicada) {
                        atributo.bolinhas--;
                        atributo.valor = atributo.base + atributo.bolinhas;
                        pontosRestantes++;
                    }
                    
                    atualizarInterface();
                });
                
                container.appendChild(bolinha);
            }
            
            atualizarBolinhas(atributoId);
        }

        function atualizarBolinhas(atributoId) {
            const container = document.getElementById(`${atributoId}Bolinhas`);
            if (!container) return;
            
            const bolinhas = container.children;
            const qtdPreenchidas = atributos[atributoId].bolinhas;
            
            for (let i = 0; i < bolinhas.length; i++) {
                if (i < qtdPreenchidas) {
                    bolinhas[i].classList.add('preenchida');
                } else {
                    bolinhas[i].classList.remove('preenchida');
                }
            }
        }

        function atualizarInterface() {
            document.getElementById('stValor').textContent = atributos.st.valor;
            document.getElementById('dxValor').textContent = atributos.dx.valor;
            document.getElementById('iqValor').textContent = atributos.iq.valor;
            document.getElementById('htValor').textContent = atributos.ht.valor;
            
            pontosRestantesSpan.textContent = pontosRestantes;
            
            atualizarBolinhas('st');
            atualizarBolinhas('dx');
            atualizarBolinhas('iq');
            atualizarBolinhas('ht');
            
            calcularDerivados();
        }

        criarBolinhas('st');
        criarBolinhas('dx');
        criarBolinhas('iq');
        criarBolinhas('ht');

        uploadArea.addEventListener('click', () => fotoInput.click());
        
        fotoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewArea.style.display = 'block';
                    uploadArea.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        removeFoto.addEventListener('click', () => {
            previewArea.style.display = 'none';
            uploadArea.style.display = 'block';
            fotoInput.value = '';
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docRef = doc(db, "usuarios", user.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    displayIdPc.textContent = userData.id_pc || '--------';
                    displayNickname.textContent = userData.nickname || 'Aventureiro';
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        btnSair.addEventListener('click', async () => {
            try {
                showLoading();
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                hideLoading();
            }
        });

        btnCriar.addEventListener('click', async () => {
            const nome = document.getElementById('nomePersonagem').value.trim();
            
            if (!nome) {
                alert('Digite um nome para o personagem');
                return;
            }

            if (pontosRestantes > 0) {
                alert(`Você ainda tem ${pontosRestantes} pontos para distribuir`);
                return;
            }

            try {
                showLoading();
                const user = auth.currentUser;
                
                const personagemRef = doc(collection(db, "personagens"));
                const personagemId = personagemRef.id;

                const dx = atributos.dx.valor;
                const iq = atributos.iq.valor;
                const ht = atributos.ht.valor;
                const fadiga = 8 + atributos.ht.bolinhas;
                const mana = iq + ht;
                const esquiva = Math.floor(dx / 2) + 3;
                const dano = tabelaDano[atributos.st.valor] || "1d-1";

                const aparencia = document.getElementById('aparencia').value;
                const riqueza = document.getElementById('riqueza').value;
                const peculiaridades = document.getElementById('peculiaridades').value.trim();

                let dinheiro = 50;
                if (riqueza === 'pobre') dinheiro = 25;
                if (riqueza === 'rico') dinheiro = 250;

                let reacaoBase = 0;
                if (aparencia === 'feio') reacaoBase = -2;
                if (aparencia === 'atraente') reacaoBase = 2;

                const personagemData = {
                    id: personagemId,
                    userId: user.uid,
                    nome: nome,
                    classe: document.getElementById('classePersonagem').value,
                    fotoURL: previewImage.src || '',
                    
                    aparencia: aparencia,
                    riqueza: riqueza,
                    peculiaridades: peculiaridades,
                    
                    pontos: {
                        xp: 0,
                        xpTotal: 0,
                        pm: 0,
                        dinheiro: dinheiro
                    },
                    
                    atributos: {
                        st: { bolinhas: atributos.st.bolinhas, valor: atributos.st.valor, base: 9 },
                        dx: { bolinhas: atributos.dx.bolinhas, valor: dx, base: 5 },
                        iq: { bolinhas: atributos.iq.bolinhas, valor: iq, base: 5 },
                        ht: { bolinhas: atributos.ht.bolinhas, valor: ht, base: 48 }
                    },
                    
                    status: {
                        vidaAtual: ht,
                        vidaMax: ht,
                        fadigaAtual: fadiga,
                        fadigaMax: fadiga,
                        manaAtual: mana,
                        manaMax: mana
                    },
                    
                    derivados: {
                        danoBase: dano,
                        esquiva: esquiva,
                        vontade: iq,
                        percepcao: iq,
                        deslocamento: (ht / 10).toFixed(1)
                    },
                    
                    reacao: {
                        base: reacaoBase,
                        total: reacaoBase
                    },
                    
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                await setDoc(personagemRef, personagemData);
                
                window.location.href = `aventura-solo.html?personagemId=${personagemId}`;
                
            } catch (error) {
                alert('Erro ao criar personagem. Tente novamente.');
                hideLoading();
            }
        });
    </script>
</body>
</html>