<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Personagem - RPGForce</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #2a1a3a 100%);
            min-height: 100vh;
            color: #fff;
        }
        .magic-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
        }
        .magic-bg::before {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
        }
        .magic-bg::after {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            background: radial-gradient(circle at 80% 80%, rgba(198, 40, 40, 0.1) 0%, transparent 50%);
            animation: pulse 10s ease-in-out infinite reverse;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .navbar {
            background: rgba(10, 10, 26, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 15px 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        .logo-area h2 {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.3rem;
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .user-id {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 30px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .user-id i { color: #ffd700; }
        .user-id .value {
            color: #ffd700;
            font-family: monospace;
            font-weight: 600;
        }
        .user-nick {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 215, 0, 0.1);
            padding: 6px 15px;
            border-radius: 30px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .user-nick i { color: #ffd700; }
        .btn-sair {
            background: transparent;
            border: 2px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 6px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-sair:hover {
            background: #ff6b6b;
            color: #0a0a1a;
            border-color: #ff6b6b;
        }
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            flex-wrap: wrap;
        }
        .breadcrumb a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
        }
        .breadcrumb a:hover { color: #ffd700; }
        .breadcrumb i {
            font-size: 0.7rem;
            color: rgba(255, 215, 0, 0.5);
        }
        .breadcrumb .current { color: #ffd700; }
        .page-header h1 {
            font-family: 'MedievalSharp', cursive;
            font-size: 2rem;
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .abas-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: rgba(10, 10, 26, 0.6);
            padding: 10px;
            border-radius: 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        .aba {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: rgba(255, 255, 255, 0.7);
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            flex: 1;
            justify-content: center;
            min-width: 120px;
        }
        .aba:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
            color: #ffd700;
        }
        .aba.ativa {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            border-color: #ffd700;
            color: #0a0a1a;
            font-weight: 600;
        }
        .aba .contador {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .aba.ativa .contador {
            background: rgba(0, 0, 0, 0.2);
            color: #0a0a1a;
        }
        .conteudo-aba { display: none; }
        .conteudo-aba.ativa { display: block; }
        
        .subabas-container {
            display: flex;
            gap: 5px;
            margin: 15px 0;
            flex-wrap: wrap;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 15px;
        }
        .subaba {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 15px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            flex: 1;
            justify-content: center;
        }
        .subaba:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
            color: #ffd700;
        }
        .subaba.ativa {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            color: #ffd700;
        }
        .subaba img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }
        
        .card {
            background: rgba(10, 10, 26, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 30px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .card-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }
        .card-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .card-section h2 {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-group label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 12px 15px;
            color: #fff;
            font-size: 1rem;
            width: 100%;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ffd700;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .upload-area {
            background: rgba(0, 0, 0, 0.2);
            border: 2px dashed rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.05);
        }
        .upload-area i {
            font-size: 2rem;
            color: #ffd700;
            margin-bottom: 10px;
            display: block;
        }
        .preview-area {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            margin: 10px 0;
        }
        .preview-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .btn-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pontos-restantes {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: bold;
        }
        .pontos-restantes .valor {
            font-size: 1.5rem;
            font-family: 'MedievalSharp', cursive;
        }
        .atributo-row {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .atributo-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .atributo-nome {
            font-weight: 600;
            color: #fff;
        }
        .atributo-valor {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffd700;
        }
        .bolinhas-container {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .bolinha {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }
        .bolinha.preenchida {
            background: #ffd700;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        .bolinha:hover {
            transform: scale(1.1);
            border-color: #ffd700;
        }
        .atributo-detalhes {
            display: flex;
            gap: 15px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            flex-wrap: wrap;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        .status-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }
        .status-item .label {
            display: block;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .status-item .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffd700;
        }
        .vantagens-grid, .desvantagens-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .vantagem-card, .desvantagem-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .vantagem-card:hover, .desvantagem-card:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
            transform: translateY(-2px);
        }
        .vantagem-card.selecionada {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        .desvantagem-card.selecionada {
            background: rgba(255, 0, 0, 0.2);
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }
        .vantagem-card h3, .desvantagem-card h3 {
            font-size: 1rem;
            color: #ffd700;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .vantagem-card p, .desvantagem-card p {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }
        .vantagem-card .resumo, .desvantagem-card .resumo {
            font-size: 0.7rem;
            color: rgba(255, 215, 0, 0.8);
            font-style: italic;
        }
        .vantagem-card .check { display: none; color: #ffd700; font-size: 1.2rem; }
        .vantagem-card.selecionada .check { display: inline; }
        .badge-fobia {
            background: rgba(255, 0, 0, 0.3);
            color: #ff6b6b;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-top: 5px;
            display: inline-block;
        }
        .contador {
            background: rgba(255, 215, 0, 0.1);
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .contador span { color: #ffd700; font-weight: bold; }
        .contador.desvantagens { background: rgba(255, 0, 0, 0.1); }
        .contador.desvantagens span { color: #ff6b6b; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a3a;
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h3 {
            color: #ffd700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .fobia-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .fobia-item:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }
        .fobia-item h4 { color: #ffd700; margin-bottom: 5px; }
        .fobia-item p {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .modal-close {
            background: transparent;
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
        }
        .pm-header {
            background: linear-gradient(45deg, #4a2a6a, #2a1a4a);
            border: 1px solid #ffd700;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        .pm-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 30px;
        }
        .pm-input-group label {
            color: #ffd700;
            font-weight: bold;
        }
        .pm-input-group input {
            background: transparent;
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 5px 10px;
            border-radius: 10px;
            width: 70px;
            text-align: center;
            font-weight: bold;
        }
        .pm-stats {
            display: flex;
            gap: 20px;
            font-size: 1.1rem;
        }
        .pm-stats span {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.3rem;
        }
        .pericias-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            min-height: 500px;
        }
        .catalogo-pericias {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        .filtros-pericias {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filtro-pericia {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        .filtro-pericia.ativo {
            background: #ffd700;
            color: #0a0a1a;
            border-color: #ffd700;
        }
        .filtro-pericia:hover { background: rgba(255, 215, 0, 0.2); }
        .lista-pericias {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .pericia-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .pericia-card:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
            transform: translateX(5px);
        }
        .pericia-card h4 {
            color: #ffd700;
            font-size: 1rem;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        .pericia-card .tipo {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        .pericia-card .tipo.mental { background: #4a6da8; }
        .pericia-card .tipo.fisica { background: #8b4a6d; }
        .pericia-card .tipo.organica { background: #2d8b6d; }
        .pericia-card .descricao {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
        }
        .pericia-card .atributo {
            font-size: 0.7rem;
            color: #ffd700;
        }
        .pericias-adquiridas {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        .pericias-adquiridas h3 {
            color: #ffd700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .lista-adquiridas {
            max-height: 550px;
            overflow-y: auto;
        }
        .pericia-adquirida {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pericia-adquirida-info h4 {
            color: #ffd700;
            font-size: 1rem;
        }
        .pericia-adquirida-info .nivel {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .pericia-adquirida-info .bonus {
            color: #4CAF50;
            font-weight: bold;
        }
        .pericia-adquirida-info .nh {
            font-size: 0.9rem;
            color: #4CAF50;
            font-weight: bold;
            margin-top: 2px;
        }
        .pericia-adquirida-info .nh span {
            color: #ffd700;
            font-size: 1rem;
            margin-left: 5px;
        }
        .pericia-adquirida-acoes {
            display: flex;
            gap: 8px;
        }
        .btn-pericia {
            background: transparent;
            border: 1px solid #ffd700;
            color: #ffd700;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-pericia:hover {
            background: #ffd700;
            color: #0a0a1a;
        }
        .btn-pericia:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .tabela-niveis {
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        .tabela-niveis table {
            width: 100%;
            border-collapse: collapse;
        }
        .tabela-niveis th {
            background: #ffd700;
            color: #0a0a1a;
            padding: 8px;
            font-size: 0.9rem;
        }
        .tabela-niveis td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }
        .tabela-niveis tr:last-child td { border-bottom: none; }
        .seletor-nivel {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        .seletor-nivel button {
            background: transparent;
            border: 2px solid #ffd700;
            color: #ffd700;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .seletor-nivel button:hover:not(:disabled) {
            background: #ffd700;
            color: #0a0a1a;
        }
        .seletor-nivel button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .seletor-nivel span {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
            min-width: 60px;
            text-align: center;
        }
        .custo-info {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        .custo-info .custo {
            font-size: 2rem;
            color: #ffd700;
            font-weight: bold;
        }
        .btn-confirmar {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
            border: none;
            padding: 12px;
            border-radius: 30px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-confirmar:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.4);
        }
        .btn-confirmar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .resumo-personagem {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .resumo-personagem .foto {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffd700;
            font-size: 1.5rem;
            overflow: hidden;
        }
        .resumo-personagem .foto img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .resumo-personagem .info h3 {
            color: #ffd700;
            margin-bottom: 5px;
        }
        .resumo-personagem .info p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 10, 26, 0.9);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        .loading-overlay.active { display: flex; }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 215, 0, 0.2);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            color: #ffd700;
            font-size: 1.2rem;
            font-family: 'MedievalSharp', cursive;
        }
        .btn-primary, .btn-secondary {
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background: transparent;
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: #ffd700;
        }
        .btn-secondary:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }
        .card-actions {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            margin-top: 30px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Estilos da aba de equipamentos */
        .dinheiro-header {
            background: linear-gradient(45deg, #2a6a4a, #1a4a3a);
            border: 1px solid #ffd700;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        .dinheiro-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2rem;
        }
        .dinheiro-info i {
            color: #ffd700;
            font-size: 1.5rem;
        }
        .dinheiro-info .valor {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.5rem;
        }
        .carga-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .carga-barra {
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }
        .carga-preenchimento {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #ffd700, #ff6b6b);
            width: 0%;
            transition: width 0.3s;
        }
        .carga-marcadores {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        .carga-nivel {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .carga-nivel.leve { background: rgba(76, 175, 80, 0.3); color: #4CAF50; }
        .carga-nivel.medio { background: rgba(255, 193, 7, 0.3); color: #ffc107; }
        .carga-nivel.pesado { background: rgba(255, 87, 34, 0.3); color: #ff5722; }
        .carga-nivel.limite { background: rgba(244, 67, 54, 0.3); color: #f44336; }
        
        .inventario-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .inventario-coluna {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        .inventario-coluna h3 {
            color: #ffd700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .inventario-itens {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }
        .item-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .item-card:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }
        .item-card .item-nome {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        .item-card .item-detalhes {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: space-between;
        }
        .item-card .item-peso {
            color: #4CAF50;
        }
        .item-card .item-preco {
            color: #ffd700;
        }
        .item-acoes {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
            gap: 5px;
        }
        .item-card:hover .item-acoes {
            display: flex;
        }
        .item-acao {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #ffd700;
            color: #ffd700;
            width: 25px;
            height: 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .item-acao:hover {
            background: #ffd700;
            color: #0a0a1a;
        }
        
        .catalogo-itens {
            margin-top: 30px;
        }
        .catalogo-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .catalogo-tab {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .catalogo-tab.ativo {
            background: #ffd700;
            color: #0a0a1a;
            border-color: #ffd700;
        }
        .catalogo-tab:hover {
            background: rgba(255, 215, 0, 0.2);
        }
        .catalogo-lista {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }
        
        .btn-criar-item {
            background: linear-gradient(45deg, #4a2a6a, #2a1a4a);
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 12px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .btn-criar-item:hover {
            background: #ffd700;
            color: #0a0a1a;
        }
        
        .campo-dinamico {
            margin-bottom: 15px;
        }
        .campo-dinamico label {
            display: block;
            color: #ffd700;
            margin-bottom: 5px;
        }
        .campo-dinamico input, .campo-dinamico select {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #ffd700;
            border-radius: 10px;
            color: #fff;
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .card { padding: 20px; }
            .form-row { grid-template-columns: 1fr; }
            .status-grid { grid-template-columns: repeat(2, 1fr); }
            .vantagens-grid, .desvantagens-grid { grid-template-columns: repeat(2, 1fr); }
            .aba { min-width: auto; padding: 10px; font-size: 0.8rem; }
            .pericias-container { grid-template-columns: 1fr; }
            .inventario-grid { grid-template-columns: 1fr; }
        }
        
        .magia-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #0a2a3a, #1a4a6a);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid #4a9fff;
        }
        .simbolo-agua {
            width: 50px;
            height: 50px;
            background-image: url('agua1.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .info-escola {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .info-escola-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
        }
        .info-escola-item .label {
            color: #4a9fff;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .info-escola-item .valor {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
        }
        .esferas-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .esfera-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(74, 159, 255, 0.3);
            border-radius: 15px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }
        .esfera-card.desbloqueada {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        .esfera-card.disponivel {
            border-color: #4a9fff;
            background: rgba(74, 159, 255, 0.1);
            cursor: pointer;
        }
        .esfera-card.disponivel:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            transform: translateY(-5px);
        }
        .esfera-card.trancada {
            opacity: 0.5;
            filter: grayscale(0.8);
            cursor: not-allowed;
        }
        .numero-esfera {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            background: #ffd700;
            color: #0a0a1a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .icone-esfera {
            font-size: 2rem;
            margin: 10px 0;
            color: #4a9fff;
        }
        .esfera-card.desbloqueada .icone-esfera { color: #ffd700; }
        .esfera-card.disponivel .icone-esfera { color: #4a9fff; }
        .nome-esfera {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .tipo-esfera {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
        }
        .nivel-esfera {
            margin-top: 8px;
            font-size: 0.8rem;
            color: #ffd700;
        }
        .btn-comprar-esfera {
            background: #4a9fff;
            border: none;
            color: #0a0a1a;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
            transition: all 0.3s;
        }
        .btn-comprar-esfera:hover {
            background: #ffd700;
            transform: scale(1.05);
        }
        .detalhe-magia-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .detalhe-magia-modal.active { display: flex; }
        .detalhe-magia-content {
            background: #1a1a3a;
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .tabela-detalhe {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        .tabela-detalhe th {
            background: #ffd700;
            color: #0a0a1a;
            padding: 8px;
        }
        .tabela-detalhe td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }
        .tabela-detalhe tr.nivel-atual {
            background: rgba(255, 215, 0, 0.3);
            font-weight: bold;
        }
        .tabela-detalhe tr.nivel-atual td {
            color: #ffd700;
            border-bottom: 2px solid #ffd700;
        }
        .btn-comprar-nivel {
            background: linear-gradient(45deg, #4a9fff, #2a6fb0);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 10px;
            width: 100%;
            margin: 10px 0;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-comprar-nivel:hover:not(:disabled) {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
        }
        .btn-comprar-nivel:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* ESTILOS DAS TABELAS DE CATÁLOGO */
.tabelas-container {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 15px;
    padding: 15px;
    margin-top: 15px;
}

.tabela-item {
    display: none;
}

.tabela-item.ativa {
    display: block;
}

.tabela-catalogo {
    width: 100%;
    border-collapse: collapse;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    overflow: hidden;
    font-size: 0.9rem;
}

.tabela-catalogo th {
    background: #ffd700;
    color: #0a0a1a;
    padding: 12px 8px;
    font-weight: 600;
    text-align: left;
}

.tabela-catalogo td {
    padding: 10px 8px;
    border-bottom: 1px solid rgba(255, 215, 0, 0.2);
    color: rgba(255, 255, 255, 0.9);
}

.tabela-catalogo tr:hover td {
    background: rgba(255, 215, 0, 0.1);
}

.tabela-catalogo tr:last-child td {
    border-bottom: none;
}

.btn-comprar-tabela {
    background: #4CAF50;
    border: none;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s;
}

.btn-comprar-tabela:hover {
    background: #ffd700;
    color: #0a0a1a;
    transform: scale(1.05);
}

.btn-comprar-tabela i {
    font-size: 0.8rem;
}

/* Ajuste para mobile */
@media (max-width: 768px) {
    .tabela-catalogo {
        font-size: 0.8rem;
    }
    
    .tabela-catalogo th,
    .tabela-catalogo td {
        padding: 8px 4px;
    }
    
    .btn-comprar-tabela {
        padding: 3px 6px;
        font-size: 0.7rem;
    }
}
@media (max-width: 768px) {
    .tabelas-container {
        overflow-x: auto;
    }
    
    .tabela-catalogo {
        min-width: 600px; 
    }
}
/* OPCIONAL - só se quiser */
.destaque-campo {
    background: rgba(255, 215, 0, 0.05);
    border-radius: 10px;
    padding: 10px;
    margin-top: 10px;
    border-left: 3px solid #ffd700;
}
    </style>
</head>
<body>
    <div class="magic-bg"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando...</div>
    </div>

    <div class="modal" id="modalFobias">
        <div class="modal-content">
            <h3><i class="fas fa-spider"></i> Escolha uma Fobia</h3>
            <div class="fobia-item" data-fobia="acrofobia"><h4>Acrofobia</h4><p>Medo de alturas. Não vai a lugares com mais de 5m de altura.</p></div>
            <div class="fobia-item" data-fobia="agorafobia"><h4>Agorafobia</h4><p>Medo de espaços abertos. Desconfortável sem paredes num raio de 15m.</p></div>
            <div class="fobia-item" data-fobia="aracnofobia"><h4>Aracnofobia</h4><p>Medo de aranhas.</p></div>
            <div class="fobia-item" data-fobia="autofobia"><h4>Autofobia</h4><p>Medo de solidão. Não suporta ficar sozinho.</p></div>
            <div class="fobia-item" data-fobia="brontofobia"><h4>Brontofobia</h4><p>Medo de ruídos altos. Evita tempestades e explosões.</p></div>
            <div class="fobia-item" data-fobia="claustrofobia"><h4>Claustrofobia</h4><p>Medo de espaços fechados. Pânico em lugares pequenos.</p></div>
            <div class="fobia-item" data-fobia="coitofobia"><h4>Coitofobia</h4><p>Medo de sexo.</p></div>
            <div class="fobia-item" data-fobia="demofobia"><h4>Demofobia</h4><p>Medo de multidões. Penalidade progressiva por quantidade de pessoas.</p></div>
            <div class="fobia-item" data-fobia="ecmofobia"><h4>Ecmofobia</h4><p>Medo de coisas afiadas. Espadas, facas, agulhas.</p></div>
            <div class="fobia-item" data-fobia="elurofobia"><h4>Elurofobia</h4><p>Medo de gatos.</p></div>
            <div class="fobia-item" data-fobia="entomofobia"><h4>Entomofobia</h4><p>Medo de insetos. Penalidade para insetos grandes ou muitos.</p></div>
            <div class="fobia-item" data-fobia="hematofobia"><h4>Hematofobia</h4><p>Medo de sangue. Teste durante combates.</p></div>
            <div class="fobia-item" data-fobia="hoplofobia"><h4>Hoplofobia</h4><p>Medo de armas. Penalidade ao ser ameaçado.</p></div>
            <div class="fobia-item" data-fobia="manafobia"><h4>Manafobia</h4><p>Medo de magia. Não aprende magias, reage mal a magos.</p></div>
            <div class="fobia-item" data-fobia="misofobia"><h4>Misofobia</h4><p>Medo de sujeira. Evita se sujar, comida estranha.</p></div>
            <div class="fobia-item" data-fobia="necrofobia"><h4>Necrofobia</h4><p>Medo da morte e mortos. Pânico perto de cadáveres.</p></div>
            <div class="fobia-item" data-fobia="nictofobia"><h4>Nictofobia</h4><p>Medo do escuro. Evita lugares subterrâneos.</p></div>
            <div class="fobia-item" data-fobia="ofiofobia"><h4>Ofiofobia</h4><p>Medo de répteis. Penalidade para cobras, lagartos.</p></div>
            <div class="fobia-item" data-fobia="pirofobia"><h4>Pirofobia</h4><p>Medo de fogo. Até cigarro aceso incomoda.</p></div>
            <div class="fobia-item" data-fobia="psicofobia"><h4>Psicofobia</h4><p>Medo de poderes psíquicos.</p></div>
            <div class="fobia-item" data-fobia="talassofobia"><h4>Talassofobia</h4><p>Medo do mar. Evita viagens marítimas.</p></div>
            <div class="fobia-item" data-fobia="tecnofobia"><h4>Tecnofobia</h4><p>Medo de máquinas. Não usa tecnologia avançada.</p></div>
            <div class="fobia-item" data-fobia="teratofobia"><h4>Teratofobia</h4><p>Medo de monstros. Penalidade progressiva.</p></div>
            <div class="fobia-item" data-fobia="triscedecofobia"><h4>Triscedecofobia</h4><p>Medo do número 13. Teste ao envolver o número.</p></div>
            <div class="fobia-item" data-fobia="xenofobia"><h4>Xenofobia</h4><p>Medo do desconhecido/estrangeiros. Penalidade para não-humanos.</p></div>
            <button class="modal-close" id="fecharModalFobias"><i class="fas fa-times"></i> Fechar</button>
        </div>
    </div>

    <div class="modal" id="modalCriarItem">
        <div class="modal-content">
            <h3><i class="fas fa-plus-circle"></i> Criar Item Personalizado</h3>
            
            <div class="campo-dinamico">
                <label>Nome do Item</label>
                <input type="text" id="itemPersonalizadoNome" placeholder="Ex: Espada Mágica Flamejante">
            </div>
            
            <div class="campo-dinamico">
                <label>Tipo de Item</label>
                <select id="itemPersonalizadoTipo">
                    <option value="arma_ca">Arma Corpo a Corpo</option>
                    <option value="arma_distancia">Arma de Distância</option>
                    <option value="armadura">Armadura</option>
                    <option value="escudo">Escudo</option>
                    <option value="item_geral">Item Geral</option>
                </select>
            </div>
            
            <div id="camposEspecificos">
                <!-- Campos serão preenchidos dinamicamente via JS -->
            </div>
            
            <div class="campo-dinamico">
                <label>Preço ($)</label>
                <input type="number" id="itemPersonalizadoPreco" min="0" value="10">
            </div>
            
            <div class="campo-dinamico">
                <label>Peso</label>
                <input type="number" id="itemPersonalizadoPeso" min="0" step="0.1" value="1.0">
            </div>
            
            <div class="campo-dinamico">
                <label>Quantidade</label>
                <input type="number" id="itemPersonalizadoQtd" min="1" value="1">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" id="cancelarCriarItem" style="flex: 1;">Cancelar</button>
                <button class="btn-primary" id="confirmarCriarItem" style="flex: 2;">Criar Item</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalPericia">
        <div class="modal-content">
            <h3><i class="fas fa-brain"></i> <span id="modalPericiaNome">Espada</span></h3>
            <div class="tabela-niveis">
                <table>
                    <thead><tr><th>Nível</th><th>Bônus</th><th>Custo Total</th></tr></thead>
                    <tbody>
                        <tr><td>1</td><td>0</td><td>2 PM</td></tr>
                        <tr><td>2</td><td>+1</td><td>6 PM</td></tr>
                        <tr><td>3</td><td>+2</td><td>10 PM</td></tr>
                        <tr><td>4</td><td>+3</td><td>14 PM</td></tr>
                        <tr><td>5</td><td>+4</td><td>18 PM</td></tr>
                        <tr><td>6</td><td>+5</td><td>22 PM</td></tr>
                        <tr><td>7</td><td>+6</td><td>26 PM</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="seletor-nivel">
                <button id="modalPericiaMenos" disabled>-</button>
                <span id="modalPericiaNivel">1</span>
                <button id="modalPericiaMais">+</button>
            </div>
            <div class="custo-info">
                <div style="font-size: 0.9rem; margin-bottom: 5px;">Custo desta operação:</div>
                <div class="custo" id="modalPericiaCusto">2 PM</div>
                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);" id="modalPericiaObservacao"></div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-secondary" id="modalPericiaCancelar" style="flex: 1;">Cancelar</button>
                <button class="btn-primary" id="modalPericiaConfirmar" style="flex: 2;">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="detalhe-magia-modal" id="detalheMagiaModal">
        <div class="detalhe-magia-content">
            <h3 id="detalheMagiaTitulo" style="color: #ffd700; margin-bottom: 10px;">Localizar Água</h3>
            <div style="margin-bottom: 15px; color: #4a9fff;" id="detalheMagiaInfo">IQ | Mana: 2</div>
            <table class="tabela-detalhe" id="tabelaDetalheMagia">
                <thead><tr><th>Nível</th><th>Valor</th></tr></thead>
                <tbody id="corpoTabelaDetalhe"></tbody>
            </table>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" id="fecharDetalheMagia" style="flex: 1;">Fechar</button>
                <button class="btn-comprar-nivel" id="comprarNivelMagia" style="flex: 2;">Comprar Nível</button>
            </div>
        </div>
    </div>

    <!-- CONTAINER PRINCIPAL (agora com as abas) -->
    <div class="container">
        <nav class="navbar">
            <div class="logo-area"><h2>RPGForce</h2></div>
            <div class="user-info">
                <div class="user-id"><i class="fas fa-id-card"></i><span class="value" id="displayIdPc">--------</span></div>
                <div class="user-nick"><i class="fas fa-user"></i><span id="displayNickname">Aventureiro</span></div>
                <button class="btn-sair" id="btnSair"><i class="fas fa-sign-out-alt"></i><span>Sair</span></button>
            </div>
        </nav>

        <div class="breadcrumb">
            <a href="dashboard-pc.html"><i class="fas fa-home"></i> Dashboard</a>
            <i class="fas fa-chevron-right"></i>
            <a href="personagens.html">Personagens</a>
            <i class="fas fa-chevron-right"></i>
            <span class="current">Criar Personagem</span>
        </div>

        <!-- BOTÕES DAS ABAS (agora no lugar certo) -->
        <div class="page-header">
            <h1><i class="fas fa-dragon"></i> Criar Novo Personagem</h1>
        </div>

        <div class="abas-container">
            <button class="aba ativa" data-aba="basicos"><i class="fas fa-user"></i> Dados Básicos</button>
            <button class="aba" data-aba="vantagens" id="abaVantagensBtn"><i class="fas fa-star"></i> Vantagens <span class="contador" id="contadorVantagensAba">0/3</span></button>
            <button class="aba" data-aba="desvantagens" id="abaDesvantagensBtn"><i class="fas fa-skull"></i> Desvantagens <span class="contador" id="contadorDesvantagensAba">0/4</span></button>
            <button class="aba" data-aba="pericias"><i class="fas fa-brain"></i> Perícias <span class="contador" id="contadorPericiasAba">0 PM</span></button>
            <button class="aba" data-aba="magias"><i class="fas fa-magic"></i> Magias <span class="contador" id="contadorMagiasAba">0/15</span></button>
            <button class="aba" data-aba="equipamentos"><i class="fas fa-backpack"></i> Equipamentos</button>
        </div>

        <!-- CONTEÚDO DAS ABAS (seu código original) -->
        <div id="abaBasicos" class="conteudo-aba ativa">
            <div class="card">
                <div class="card-section">
                    <h2><i class="fas fa-user"></i> Dados Básicos</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomePersonagem">Nome do Personagem</label>
                            <input type="text" id="nomePersonagem" placeholder="Ex: Aric, o Caçador" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="classePersonagem">Classe</label>
                            <select id="classePersonagem">
                                <option value="guerreiro">Guerreiro</option>
                                <option value="mago">Mago</option>
                                <option value="ladino">Ladino</option>
                                <option value="clerigo">Clérigo</option>
                                <option value="barbaro">Bárbaro</option>
                            </select>
                        </div>
                    </div>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-camera"></i>
                        <span>Clique para adicionar foto (opcional)</span>
                        <input type="file" id="fotoInput" accept="image/*" style="display: none;">
                    </div>
                    <div class="preview-area" id="previewArea" style="display: none;">
                        <img id="previewImage" src="" alt="Preview">
                        <button type="button" id="removeFoto" class="btn-remove"><i class="fas fa-times"></i></button>
                    </div>
                </div>

                <div class="card-section">
                    <h2><i class="fas fa-user-circle"></i> Aparência, História e Economia</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="aparencia">Aparência</label>
                            <select id="aparencia">
                                <option value="feio">Feio (-2 reação)</option>
                                <option value="normal" selected>Normal</option>
                                <option value="atraente">Atraente (+2 reação)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="riqueza">Riqueza Inicial</label>
                            <select id="riqueza">
                                <option value="pobre">Pobre (metade do base)</option>
                                <option value="medio" selected>Médio (valor base)</option>
                                <option value="rico">Rico (5x o base)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dinheiroBase">Valor Base de Dinheiro ($)</label>
                            <input type="number" id="dinheiroBase" min="0" value="1000" step="100">
                            <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem; margin-top: 5px; display: block;">
                                <i class="fas fa-info-circle"></i> O mestre define este valor. Pobre = metade, Rico = 5x
                            </small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="peculiaridades">Peculiaridades</label>
                        <textarea id="peculiaridades" placeholder="Ex: Fala sozinho quando nervoso... Tem uma cicatriz no rosto... Adora poesia..."></textarea>
                    </div>
                </div>

                <div class="card-section">
                    <h2><i class="fas fa-chart-bar"></i> Atributos</h2>
                    <div class="pontos-restantes">
                        <span>Pontos para distribuir:</span>
                        <span class="valor" id="pontosRestantes">6</span>
                    </div>
                    
                    <div class="atributo-row" data-atributo="st">
                        <div class="atributo-info">
                            <span class="atributo-nome">ST (Força)</span>
                            <span class="atributo-valor" id="stValor">9</span>
                        </div>
                        <div class="bolinhas-container" id="stBolinhas"></div>
                        <div class="atributo-detalhes">
                            <span class="dano" id="stDano">1d-1</span>
                        </div>
                    </div>

                    <div class="atributo-row" data-atributo="dx">
                        <div class="atributo-info">
                            <span class="atributo-nome">DX (Destreza)</span>
                            <span class="atributo-valor" id="dxValor">5</span>
                        </div>
                        <div class="bolinhas-container" id="dxBolinhas"></div>
                        <div class="atributo-detalhes">
                            <span class="esquiva" id="dxEsquiva">Esquiva 5</span>
                        </div>
                    </div>

                    <div class="atributo-row" data-atributo="iq">
                        <div class="atributo-info">
                            <span class="atributo-nome">IQ (Inteligência)</span>
                            <span class="atributo-valor" id="iqValor">5</span>
                        </div>
                        <div class="bolinhas-container" id="iqBolinhas"></div>
                        <div class="atributo-detalhes">
                            <span class="vontade" id="iqVontade">Vontade 5</span>
                        </div>
                    </div>

                    <div class="atributo-row" data-atributo="ht">
                        <div class="atributo-info">
                            <span class="atributo-nome">HT (Vigor)</span>
                            <span class="atributo-valor" id="htValor">48</span>
                        </div>
                        <div class="bolinhas-container" id="htBolinhas"></div>
                        <div class="atributo-detalhes">
                            <span class="vida" id="htVida">Vida 48</span>
                            <span class="fadiga" id="htFadiga">Fadiga 8</span>
                        </div>
                    </div>
                </div>

                <div class="card-section status-grid">
                    <div class="status-item">
                        <span class="label">Vida:</span>
                        <span class="value" id="statusVida">48</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Fadiga:</span>
                        <span class="value" id="statusFadiga">8</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Mana:</span>
                        <span class="value" id="statusMana">13</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Dano:</span>
                        <span class="value" id="statusDano">1d-1</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Esquiva:</span>
                        <span class="value" id="statusEsquiva">5</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Deslocamento:</span>
                        <span class="value" id="statusDeslocamento">4.8</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="abaVantagens" class="conteudo-aba">
            <div class="card">
                <div class="resumo-personagem" id="resumoPersonagem">
                    <div class="foto" id="resumoFoto"><i class="fas fa-user"></i></div>
                    <div class="info"><h3 id="resumoNome">Carregando...</h3><p id="resumoDetalhes">Classe: <span id="resumoClasse">-</span> | Aparência: <span id="resumoAparencia">-</span> | Riqueza: <span id="resumoRiqueza">-</span></p></div>
                </div>
                <div class="card-section">
                    <h2><i class="fas fa-star"></i> Vantagens <span style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">(escolha 3)</span></h2>
                    <div class="contador"><span><i class="fas fa-check-circle"></i> Vantagens selecionadas:</span><span id="contadorVantagens">0/3</span></div>
                    <div class="vantagens-grid" id="vantagensGrid">
                        <div class="vantagem-card" data-vantagem="aliado"><h3>Aliado <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Um companheiro fiel</p></div>
                        <div class="vantagem-card" data-vantagem="ambidestria"><h3>Ambidestria <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Usa ambas as mãos sem penalidade</p></div>
                        <div class="vantagem-card" data-vantagem="aptidaoMagica"><h3>Aptidão mágica +1 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Bônus em magias</p></div>
                        <div class="vantagem-card" data-vantagem="abascanto"><h3>Abascanto +3 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Resistência a magia +3</p></div>
                        <div class="vantagem-card" data-vantagem="carisma"><h3>Carisma +1 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Persuasão, liderança</p></div>
                        <div class="vantagem-card" data-vantagem="destemor"><h3>Destemor +2 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Resistência a medo/intimidação</p></div>
                        <div class="vantagem-card" data-vantagem="duroMatar"><h3>Duro de matar +2 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Bônus em HT ou resistência</p></div>
                        <div class="vantagem-card" data-vantagem="flexibilidade"><h3>Flexibilidade <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Bônus em testes de DX/escapar</p></div>
                        <div class="vantagem-card" data-vantagem="intuicao"><h3>Intuição <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Sentir quando algo está errado</p></div>
                        <div class="vantagem-card" data-vantagem="nocaoPerigo"><h3>Noção do perigo <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Alerta contra emboscadas</p></div>
                        <div class="vantagem-card" data-vantagem="reflexoCombate"><h3>Reflexo de combate <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Iniciativa, esquiva</p></div>
                        <div class="vantagem-card" data-vantagem="regeneracao"><h3>Regeneração <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Recupera vida mais rápido</p></div>
                        <div class="vantagem-card" data-vantagem="sentidosAgucados"><h3>Sentidos aguçados +2 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Percepção +2</p></div>
                        <div class="vantagem-card" data-vantagem="sorte"><h3>Sorte <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Pode rerolar testes</p></div>
                        <div class="vantagem-card" data-vantagem="visaoNoturna"><h3>Visão noturna <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Enxerga no escuro</p></div>
                        <div class="vantagem-card" data-vantagem="mestreArmas"><h3>Mestre das armas <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Bônus com armas</p></div>
                        <div class="vantagem-card" data-vantagem="forcaVontade"><h3>Força de vontade +2 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Resistência mental +2</p></div>
                        <div class="vantagem-card" data-vantagem="fadigaExtra"><h3>Fadiga extra +2 <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">+2 na reserva de fadiga</p></div>
                        <div class="vantagem-card" data-vantagem="htExtra"><h3>HT extra +5% <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Aumento percentual no Vigor</p></div>
                        <div class="vantagem-card" data-vantagem="atraente"><h3>Atraente <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">+2 em reações</p></div>
                        <div class="vantagem-card" data-vantagem="rico"><h3>Rico <span class="check"><i class="fas fa-check-circle"></i></span></h3><p class="resumo">Começa com 250 moedas</p></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="abaDesvantagens" class="conteudo-aba">
            <div class="card">
                <div class="resumo-personagem" id="resumoPersonagem2">
                    <div class="foto" id="resumoFoto2"><i class="fas fa-user"></i></div>
                    <div class="info"><h3 id="resumoNome2">Carregando...</h3><p id="resumoDetalhes2">Classe: <span id="resumoClasse2">-</span> | Aparência: <span id="resumoAparencia2">-</span> | Riqueza: <span id="resumoRiqueza2">-</span></p></div>
                </div>
                <div class="card-section">
                    <h2><i class="fas fa-skull"></i> Desvantagens <span style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">(escolha 4)</span></h2>
                    <div class="contador desvantagens"><span><i class="fas fa-skull"></i> Desvantagens selecionadas:</span><span id="contadorDesvantagens">0/4</span></div>
                    <div class="desvantagens-grid" id="desvantagensGrid">
                        <div class="desvantagem-card" data-desvantagem="alcoolismo"><h3>Alcoolismo</h3><p class="resumo">Vício em bebida</p></div>
                        <div class="desvantagem-card" data-desvantagem="avareza"><h3>Avareza</h3><p class="resumo">Mesquinho, ama dinheiro</p></div>
                        <div class="desvantagem-card" data-desvantagem="briguento"><h3>Briguento</h3><p class="resumo">Adora uma briga</p></div>
                        <div class="desvantagem-card" data-desvantagem="barulhento"><h3>Barulhento +2</h3><p class="resumo">Não consegue ser furtivo</p></div>
                        <div class="desvantagem-card" data-desvantagem="cobica"><h3>Cobiça</h3><p class="resumo">Quer tudo que vê</p></div>
                        <div class="desvantagem-card" data-desvantagem="circunspeccao"><h3>Circunspecção</h3><p class="resumo">Cautela extrema</p></div>
                        <div class="desvantagem-card" data-desvantagem="cleptomania"><h3>Cleptomania</h3><p class="resumo">Compulsão por roubar</p></div>
                        <div class="desvantagem-card" data-desvantagem="codigoHonra"><h3>Código de honra</h3><p class="resumo">Segue regras rígidas</p></div>
                        <div class="desvantagem-card" data-desvantagem="covardia"><h3>Covardia</h3><p class="resumo">Foge de perigo</p></div>
                        <div class="desvantagem-card" data-desvantagem="daltonismo"><h3>Daltonismo</h3><p class="resumo">Não vê cores</p></div>
                        <div class="desvantagem-card" data-desvantagem="sensoDever"><h3>Senso do dever</h3><p class="resumo">Protege algo/alguém</p></div>
                        <div class="desvantagem-card" data-desvantagem="inimigo"><h3>Inimigo</h3><p class="resumo">Alguém te persegue</p></div>
                        <div class="desvantagem-card" data-desvantagem="excessoConfianca"><h3>Excesso de confiança</h3><p class="resumo">Se acha mais capaz</p></div>
                        <div class="desvantagem-card" id="cardFobia" data-desvantagem="fobia"><h3>Fobia <i class="fas fa-chevron-right" style="font-size: 0.8rem;"></i></h3><p class="resumo">Clique para escolher</p><span class="badge-fobia" id="fobiaEscolhida" style="display: none;">Nenhuma</span></div>
                        <div class="desvantagem-card" data-desvantagem="furia"><h3>Fúria</h3><p class="resumo">Perde o controle na raiva</p></div>
                        <div class="desvantagem-card" data-desvantagem="honestidade"><h3>Honestidade</h3><p class="resumo">Não consegue mentir</p></div>
                        <div class="desvantagem-card" data-desvantagem="luxuria"><h3>Luxúria</h3><p class="resumo">Obcecado por prazeres</p></div>
                        <div class="desvantagem-card" data-desvantagem="megalomania"><h3>Megalomania</h3><p class="resumo">Quer dominar o mundo</p></div>
                        <div class="desvantagem-card" data-desvantagem="pacifismo"><h3>Pacifismo</h3><p class="resumo">Não suporta violência</p></div>
                        <div class="desvantagem-card" data-desvantagem="piromania"><h3>Piromania</h3><p class="resumo">Adora fogo</p></div>
                        <div class="desvantagem-card" data-desvantagem="preguica"><h3>Preguiça</h3><p class="resumo">Evita esforço</p></div>
                        <div class="desvantagem-card" data-desvantagem="sanguinolencia"><h3>Sanguinolência</h3><p class="resumo">Adora ver sangue</p></div>
                        <div class="desvantagem-card" data-desvantagem="teimosia"><h3>Teimosia</h3><p class="resumo">Não muda de ideia</p></div>
                        <div class="desvantagem-card" data-desvantagem="veracidade"><h3>Veracidade</h3><p class="resumo">Sempre fala a verdade</p></div>
                        <div class="desvantagem-card" data-desvantagem="zarolho"><h3>Zarolho</h3><p class="resumo">Tem só um olho</p></div>
                        <div class="desvantagem-card" data-desvantagem="magro"><h3>Magro</h3><p class="resumo">-20% peso, vulnerável a quedas</p></div>
                        <div class="desvantagem-card" data-desvantagem="gordo"><h3>Gordo</h3><p class="resumo">+20% peso, perde fadiga rápido</p></div>
                        <div class="desvantagem-card" data-desvantagem="nanismo"><h3>Nanismo</h3><p class="resumo">-1 deslocamento, altura máx 1.30m</p></div>
                        <div class="desvantagem-card" data-desvantagem="pobre"><h3>Pobre</h3><p class="resumo">Começa com 25 moedas</p></div>
                        <div class="desvantagem-card" data-desvantagem="feio"><h3>Feio</h3><p class="resumo">-2 em reações</p></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="abaPericias" class="conteudo-aba">
            <div class="card">
                <div class="pm-header">
                    <div class="pm-input-group"><label for="pmInicial">PM Inicial:</label><input type="number" id="pmInicial" min="0" value="30" step="1"></div>
                    <div class="pm-stats"><div>Gastos: <span id="pmGasto">0</span></div><div>Restante: <span id="pmRestante">30</span></div></div>
                </div>
                <div class="pericias-container">
                    <div class="catalogo-pericias">
                        <h3 style="color: #ffd700; margin-bottom: 15px;"><i class="fas fa-book"></i> Catálogo de Perícias</h3>
                        <div class="filtros-pericias">
                            <button class="filtro-pericia ativo" data-filtro="todas">Todas</button>
                            <button class="filtro-pericia" data-filtro="mental">Mental (IQ)</button>
                            <button class="filtro-pericia" data-filtro="fisica">Física (DX)</button>
                            <button class="filtro-pericia" data-filtro="organica">Orgânica (HT)</button>
                        </div>
                        <div class="lista-pericias" id="listaPericias"></div>
                    </div>
                    <div class="pericias-adquiridas">
                        <h3><i class="fas fa-check-circle"></i> Perícias do Personagem</h3>
                        <div class="lista-adquiridas" id="listaPericiasAdquiridas"><div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Clique em uma perícia do catálogo para adicionar</div></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="abaMagias" class="conteudo-aba">
            <div class="card">
                <div class="subabas-container">
                    <button class="subaba ativa" data-subaba="agua">
                        <img src="agua1.png" alt="Água" style="width: 20px; height: 20px;"> Escola da Água
                    </button>
                    <button class="subaba" data-subaba="fogo" disabled style="opacity: 0.5;">
                        <i class="fas fa-fire"></i> Escola do Fogo
                    </button>
                    <button class="subaba" data-subaba="terra" disabled style="opacity: 0.5;">
                        <i class="fas fa-mountain"></i> Escola da Terra
                    </button>
                </div>

                <div id="subabaAgua" class="conteudo-subaba ativa">
                    <div class="magia-header">
                        <div class="simbolo-agua"></div>
                        <div class="info-escola">
                            <div class="info-escola-item"><div class="label">Aptidão Mágica</div><div class="valor" id="aptidaoMagicaValor">0</div></div>
                            <div class="info-escola-item"><div class="label">Esferas</div><div class="valor" id="esferasDesbloqueadas">0</div></div>
                            <div class="info-escola-item"><div class="label">PM em Magias</div><div class="valor" id="pmMagias">0</div></div>
                        </div>
                    </div>

                    <h2 style="color: #ffd700; margin: 20px 0 10px;"><i class="fas fa-water"></i> Árvore de Magias da Água</h2>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">Cada esfera desbloqueia uma nova magia. Compre esferas com PM para expandir seu poder.</p>

                    <div class="esferas-grid" id="esferasGrid"></div>
                </div>
            </div>
        </div>

        <div id="abaEquipamentos" class="conteudo-aba">
            <div class="card">
                <div class="dinheiro-header">
                    <div class="dinheiro-info">
                        <i class="fas fa-coins"></i>
                        <span>Saldo: <span class="valor" id="dinheiroSaldo">50</span> $</span>
                    </div>
                    <div class="dinheiro-info">
                        <i class="fas fa-weight-hanging"></i>
                        <span>Carga: <span id="cargaAtual">0.0</span> / <span id="cargaLimite">108</span> kg</span>
                    </div>
                </div>

                <div class="carga-info">
                    <div class="carga-barra">
                        <div class="carga-preenchimento" id="cargaBarra" style="width: 0%;"></div>
                    </div>
                    <div class="carga-marcadores">
                        <span>Leve (STx2: <span id="cargaLeve">18</span> kg)</span>
                        <span>Médio (STx4: <span id="cargaMedia">36</span> kg)</span>
                        <span>Pesado (STx8: <span id="cargaPesada">72</span> kg)</span>
                        <span>Limite (STx12: <span id="cargaLimiteDisplay">108</span> kg)</span>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                        <span class="carga-nivel" id="cargaNivel">Leve</span>
                        <span>Penalidades: <span id="cargaPenalidade">Nenhuma</span></span>
                    </div>
                </div>

                <div class="inventario-grid">
                    <div class="inventario-coluna">
                        <h3><i class="fas fa-user"></i> Corpo</h3>
                        <div class="inventario-itens" id="inventarioCorpo">
                            <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nada equipado</div>
                        </div>
                    </div>
                    <div class="inventario-coluna">
                        <h3><i class="fas fa-shopping-bag"></i> Mochila <span style="font-size: 0.8rem; color: rgba(255,255,255,0.6);" id="pesoMochila">(0.0 kg)</span></h3>
                        <div class="inventario-itens" id="inventarioMochila">
                            <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Mochila vazia</div>
                        </div>
                    </div>
                    <div class="inventario-coluna">
                        <h3><i class="fas fa-warehouse"></i> Depósito</h3>
                        <div class="inventario-itens" id="inventarioDeposito">
                            <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Depósito vazio</div>
                        </div>
                    </div>
                </div>

                <button class="btn-criar-item" id="btnCriarItem">
                    <i class="fas fa-plus-circle"></i> Criar Item Personalizado
                </button>

                <div class="catalogo-itens">
                    <h3 style="color: #ffd700; margin-bottom: 15px;"><i class="fas fa-store"></i> Catálogo de Itens</h3>
                    
                    <div class="catalogo-tabs">
                        <button class="catalogo-tab ativo" data-tab="armas_ca">Armas Corpo a Corpo</button>
                        <button class="catalogo-tab" data-tab="armas_dist">Armas de Distância</button>
                        <button class="catalogo-tab" data-tab="armaduras">Armaduras</button>
                        <button class="catalogo-tab" data-tab="escudos">Escudos</button>
                        <button class="catalogo-tab" data-tab="itens_gerais">Itens Gerais</button>
                    </div>

                    <div class="tabelas-container">
                        <div class="tabela-item ativa" id="tabelaArmasCA">
                            <table class="tabela-catalogo">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Alcance</th>
                                        <th>Dano</th>
                                        <th>Tipo</th>
                                        <th>Custo ($)</th>
                                        <th>Peso (kg)</th>
                                        <th>ST</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaArmasCA">
                                    <tr><td colspan="8" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tabela-item" id="tabelaArmasDist">
                            <table class="tabela-catalogo">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Precisão</th>
                                        <th>Dano</th>
                                        <th>Tipo</th>
                                        <th>Alcance</th>
                                        <th>Custo ($)</th>
                                        <th>Peso (kg)</th>
                                        <th>ST</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaArmasDist">
                                    <tr><td colspan="9" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tabela-item" id="tabelaArmaduras">
                            <table class="tabela-catalogo">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>RD</th>
                                        <th>Custo ($)</th>
                                        <th>Peso (kg)</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaArmaduras">
                                    <tr><td colspan="5" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tabela-item" id="tabelaEscudos">
                            <table class="tabela-catalogo">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Bônus</th>
                                        <th>VE</th>
                                        <th>Custo ($)</th>
                                        <th>Peso (kg)</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaEscudos">
                                    <tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tabela-item" id="tabelaItensGerais">
                            <table class="tabela-catalogo">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Especificação</th>
                                        <th>Custo ($)</th>
                                        <th>Peso (kg)</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaItensGerais">
                                    <tr><td colspan="5" style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-actions">
            <button type="button" class="btn-secondary" id="btnAnterior"><i class="fas fa-arrow-left"></i> Anterior</button>
            <button type="button" class="btn-primary" id="btnProximo">Próximo <i class="fas fa-arrow-right"></i></button>
            <button type="button" class="btn-primary" id="btnFinalizar" style="display: none;"><i class="fas fa-save"></i> Finalizar Personagem</button>
        </div>
    </div>
    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBrx4JSmFay24k95pu1ICjFfVki8gs_uHw",
    authDomain: "rpgforce-e3227.firebaseapp.com",
    projectId: "rpgforce-e3227",
    storageBucket: "rpgforce-e3227.firebasestorage.app",
    messagingSenderId: "984517342332",
    appId: "1:984517342332:web:87d33aa4c84ff2a07685f9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const displayIdPc = document.getElementById('displayIdPc');
const displayNickname = document.getElementById('displayNickname');
const btnSair = document.getElementById('btnSair');
const loadingOverlay = document.getElementById('loadingOverlay');
const btnAnterior = document.getElementById('btnAnterior');
const btnProximo = document.getElementById('btnProximo');
const btnFinalizar = document.getElementById('btnFinalizar');
const abas = document.querySelectorAll('.aba');
const conteudos = document.querySelectorAll('.conteudo-aba');
const subabas = document.querySelectorAll('.subaba');
const uploadArea = document.getElementById('uploadArea');
const fotoInput = document.getElementById('fotoInput');
const previewArea = document.getElementById('previewArea');
const previewImage = document.getElementById('previewImage');
const removeFoto = document.getElementById('removeFoto');
const pontosRestantesSpan = document.getElementById('pontosRestantes');
const modalFobias = document.getElementById('modalFobias');
const fecharModalFobias = document.getElementById('fecharModalFobias');
const fobiaEscolhida = document.getElementById('fobiaEscolhida');
const cardFobia = document.getElementById('cardFobia');
const contadorVantagensSpan = document.getElementById('contadorVantagens');
const contadorDesvantagensSpan = document.getElementById('contadorDesvantagens');
const contadorVantagensAba = document.getElementById('contadorVantagensAba');
const contadorDesvantagensAba = document.getElementById('contadorDesvantagensAba');
const contadorPericiasAba = document.getElementById('contadorPericiasAba');
const contadorMagiasAba = document.getElementById('contadorMagiasAba');
const pmInicial = document.getElementById('pmInicial');
const pmGasto = document.getElementById('pmGasto');
const pmRestante = document.getElementById('pmRestante');
const listaPericias = document.getElementById('listaPericias');
const listaPericiasAdquiridas = document.getElementById('listaPericiasAdquiridas');
const modalPericia = document.getElementById('modalPericia');
const modalPericiaNome = document.getElementById('modalPericiaNome');
const modalPericiaNivel = document.getElementById('modalPericiaNivel');
const modalPericiaCusto = document.getElementById('modalPericiaCusto');
const modalPericiaObservacao = document.getElementById('modalPericiaObservacao');
const modalPericiaMenos = document.getElementById('modalPericiaMenos');
const modalPericiaMais = document.getElementById('modalPericiaMais');
const modalPericiaCancelar = document.getElementById('modalPericiaCancelar');
const modalPericiaConfirmar = document.getElementById('modalPericiaConfirmar');
const aptidaoMagicaValor = document.getElementById('aptidaoMagicaValor');
const esferasDesbloqueadasSpan = document.getElementById('esferasDesbloqueadas');
const pmMagiasSpan = document.getElementById('pmMagias');
const esferasGrid = document.getElementById('esferasGrid');
const detalheMagiaModal = document.getElementById('detalheMagiaModal');
const detalheMagiaTitulo = document.getElementById('detalheMagiaTitulo');
const detalheMagiaInfo = document.getElementById('detalheMagiaInfo');
const corpoTabelaDetalhe = document.getElementById('corpoTabelaDetalhe');
const fecharDetalheMagia = document.getElementById('fecharDetalheMagia');
const comprarNivelMagia = document.getElementById('comprarNivelMagia');
const dinheiroBaseInput = document.getElementById('dinheiroBase');
const dinheiroSaldo = document.getElementById('dinheiroSaldo');
const cargaAtual = document.getElementById('cargaAtual');
const cargaLimite = document.getElementById('cargaLimite');
const cargaLeve = document.getElementById('cargaLeve');
const cargaMedia = document.getElementById('cargaMedia');
const cargaPesada = document.getElementById('cargaPesada');
const cargaLimiteSpan = document.getElementById('cargaLimite');
const cargaBarra = document.getElementById('cargaBarra');
const cargaNivel = document.getElementById('cargaNivel');
const cargaPenalidade = document.getElementById('cargaPenalidade');
const pesoMochila = document.getElementById('pesoMochila');
const inventarioCorpo = document.getElementById('inventarioCorpo');
const inventarioMochila = document.getElementById('inventarioMochila');
const inventarioDeposito = document.getElementById('inventarioDeposito');
const btnCriarItem = document.getElementById('btnCriarItem');
const modalCriarItem = document.getElementById('modalCriarItem');
const cancelarCriarItem = document.getElementById('cancelarCriarItem');
const confirmarCriarItem = document.getElementById('confirmarCriarItem');
const itemPersonalizadoNome = document.getElementById('itemPersonalizadoNome');
const itemPersonalizadoTipo = document.getElementById('itemPersonalizadoTipo');
const camposEspecificos = document.getElementById('camposEspecificos');
const itemPersonalizadoPreco = document.getElementById('itemPersonalizadoPreco');
const itemPersonalizadoPeso = document.getElementById('itemPersonalizadoPeso');
const itemPersonalizadoQtd = document.getElementById('itemPersonalizadoQtd');

let abaAtual = 'basicos';
let pontosRestantes = 6;
let fobiaSelecionada = null;
let personagemTemp = null;
const vantagensSelecionadas = new Set();
const desvantagensSelecionadas = new Set();
let pmDisponivel = 30;
let pmGastoTotal = 0;
let pericias = {};
let periciaAtual = null;
let dinheiroBase = 1000;

let inventario = {
    corpo: [],
    mochila: [],
    deposito: []
};

let dinheiro = 0;

const catalogoItensData = {
    armas_ca: [
        { id: 'machado', nome: 'Machado', alcance: 1, dano: '1d-1', tipoDano: 'Corte', preco: 50, peso: 2.0, st: 10 },
        { id: 'maca_lisa', nome: 'Maça Lisa', alcance: 1, dano: '1D', tipoDano: 'Contusão', preco: 80, peso: 2.5, st: 11 },
        { id: 'espada_larga', nome: 'Espada Larga', alcance: 1, dano: '1d Corte / 1D-1 Perf', tipoDano: 'Corte/Perf', preco: 500, peso: 2.0, st: 10 },
        { id: 'rapieira', nome: 'Rapieira', alcance: 1.2, dano: '1D', tipoDano: 'Perfuração', preco: 500, peso: 1.5, st: 9 }
    ],
    armas_dist: [
        { id: 'arco', nome: 'Arco', precisao: 1, dano: '1D+1', tipoDano: 'Perf', alcance: 'STx15', preco: 200, peso: 1.5, st: 12 },
        { id: 'besta', nome: 'Besta', precisao: 1, dano: '2D', tipoDano: 'Perf', alcance: 'STx20', preco: 200, peso: 3.0, st: 9 }
    ],
    armaduras: [
        { id: 'couro', nome: 'Armadura de Couro', rd: 2, preco: 50, peso: 5.0, local: 'completo' },
        { id: 'couro_ref', nome: 'Armadura de Couro Reforçado', rd: 4, preco: 250, peso: 10.0, local: 'completo' },
        { id: 'escamas', nome: 'Armadura de Escamas de Aço', rd: 8, preco: 900, peso: 22.0, local: 'completo' }
    ],
    escudos: [
        { id: 'escudo_leve', nome: 'Escudo Leve', bonus: 1, preco: 50, peso: 1.0, ve: '5/30' },
        { id: 'escudo_medio', nome: 'Escudo Médio', bonus: 2, preco: 150, peso: 8.0, ve: '7/55' }
    ],
    itens_gerais: [
        { id: 'corda', nome: 'Corda (10m)', duracao: '10m', preco: 5, peso: 1.5 },
        { id: 'tocha', nome: 'Tocha', duracao: '1h', preco: 1, peso: 0.5 },
        { id: 'oleo', nome: 'Óleo para lamparina (1L)', duracao: '1L', preco: 3, peso: 1.0 },
        { id: 'mochila', nome: 'Mochila', capacidade: '50kg', preco: 20, peso: 1.5 },
        { id: 'racao', nome: 'Ração de viagem (1 dia)', duracao: '1 dia', preco: 2, peso: 0.5 },
        { id: 'cantil', nome: 'Cantil (1L)', capacidade: '1L', preco: 2, peso: 0.3 },
        { id: 'kit_primeiros', nome: 'Kit de primeiros socorros', usos: 3, preco: 15, peso: 1.0 },
        { id: 'pederneira', nome: 'Pederneira', preco: 5, peso: 0.1 },
        { id: 'saco_dormir', nome: 'Saco de dormir', preco: 10, peso: 2.0 },
        { id: 'barraca', nome: 'Barraca (2 pessoas)', preco: 30, peso: 5.0 }
    ]
};

const escolas = {
    agua: {
        id: 'agua',
        nome: 'Água',
        desbloqueada: true,
        custoDesbloqueio: 0,
        icone: 'agua1.png',
        magias: {
            localizarAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Informação', icone: 'fa-location-dot' },
            purificarAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Utilitária', icone: 'fa-droplet' },
            criarAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Utilitária', icone: 'fa-water' },
            dissiparAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Área', icone: 'fa-wind' },
            respirarNaAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Suporte', icone: 'fa-lungs' },
            moldarAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Controle', icone: 'fa-hand' },
            nevoeiro: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Área', icone: 'fa-cloud' },
            armaCongelante: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Encanto', icone: 'fa-snowflake' },
            cortinaDagua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Defesa/Área', icone: 'fa-shield' },
            jatoDeAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Ataque', icone: 'fa-gun' },
            ondaExpulsora: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Ataque/Área', icone: 'fa-wave-square' },
            adagaDeGelo: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Ataque', icone: 'fa-knife' },
            golemDeAgua: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Conjuração', icone: 'fa-robot' },
            tempestadeDeGelo: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Área', icone: 'fa-cloud-rain' },
            congelamento: { nivel: 0, desbloqueada: false, atributo: 'IQ', tipo: 'Paralisia', icone: 'fa-icicles' }
        }
    }
};

const tabelasMagia = {
    localizarAgua: { coluna: 'Alcance', valores: ['50m', '100m', '200m', '350m', '500m', '1km', '1.5km', '2km', '2.5km', '3km', '4km', '5km', '10km', '14km', '20km+'] },
    purificarAgua: { coluna: 'Litros', valores: ['1L', '5L', '10L', '20L', '35L', '50L', '75L', '100L', '150L', '200L', '300L', '500L', '750L', '1000L', '2000L'] },
    criarAgua: { coluna: 'Litros', valores: ['1L', '5L', '10L', '20L', '35L', '50L', '75L', '100L', '150L', '200L', '300L', '500L', '750L', '1000L', '2000L'] },
    dissiparAgua: { coluna: 'Volume (m³)', valores: ['1m³', '2m³', '3m³', '5m³', '8m³', '12m³', '18m³', '25m³', '35m³', '50m³', '70m³', '100m³', '150m³', '250m³', '500m³'] },
    respirarNaAgua: { coluna: 'Duração', valores: ['1min', '2min', '3min', '5min', '8min', '10min', '15min', '20min', '30min', '45min', '1h', '1.5h', '2h', '3h', '6h'] },
    moldarAgua: { coluna: 'Litros', valores: ['1L', '5L', '10L', '20L', '35L', '50L', '75L', '100L', '150L', '200L', '300L', '500L', '750L', '1000L', '2000L'] },
    nevoeiro: { coluna: 'Raio / Penalidade', valores: ['2m / -1', '3m / -1', '4m / -2', '5m / -2', '6m / -3', '8m / -3', '10m / -4', '12m / -4', '15m / -5', '18m / -5', '20m / -6', '25m / -6', '30m / -7', '40m / -7', '50m / -8'] },
    armaCongelante: { coluna: 'Dano / Duração', valores: ['+0 / 30s', '+1 / 1min', '+1 / 2min', '+2 / 2min', '+2 / 3min', '+3 / 3min', '+3 / 4min', '+4 / 4min', '+4 / 5min', '+5 / 5min', '+5 / 6min', '+6 / 6min', '+6 / 7min', '+7 / 7min', '+8 / 10min'] },
    cortinaDagua: { coluna: 'Tamanho / RD / Duração', valores: ['2x2m / RD2 / 2s', '3x2m / RD3 / 2s', '3x3m / RD4 / 3s', '4x3m / RD5 / 3s', '4x4m / RD6 / 4s', '5x4m / RD7 / 4s', '5x5m / RD8 / 5s', '6x5m / RD9 / 5s', '6x6m / RD10 / 6s', '7x6m / RD12 / 6s', '7x7m / RD14 / 7s', '8x7m / RD16 / 7s', '8x8m / RD18 / 8s', '9x8m / RD20 / 8s', '10x10m / RD25 / 10s'] },
    jatoDeAgua: { coluna: 'Dano / Alcance / Empurra', valores: ['1d-2 / 5m / 1m', '1d-1 / 7m / 1m', '1d / 10m / 2m', '1d+1 / 12m / 2m', '1d+2 / 15m / 3m', '2d-1 / 18m / 3m', '2d / 20m / 4m', '2d+1 / 22m / 4m', '2d+2 / 25m / 5m', '3d-1 / 30m / 5m', '3d / 35m / 6m', '3d+1 / 40m / 6m', '3d+2 / 45m / 7m', '4d-1 / 50m / 8m', '4d / 60m / 10m'] },
    ondaExpulsora: { coluna: 'Dano / Cone / Empurra', valores: ['1d-2 / 3m / 1m', '1d-1 / 4m / 1m', '1d / 5m / 2m', '1d+1 / 6m / 2m', '1d+2 / 7m / 3m', '2d-1 / 8m / 3m', '2d / 9m / 4m', '2d+1 / 10m / 4m', '2d+2 / 12m / 5m', '3d-1 / 14m / 5m', '3d / 16m / 6m', '3d+1 / 18m / 6m', '3d+2 / 20m / 7m', '4d-1 / 25m / 8m', '4d / 30m / 10m'] },
    adagaDeGelo: { coluna: 'Dano (Perfuração)', valores: ['1d-2', '1d-1', '1d', '1d+1', '1d+2', '2d-1', '2d', '2d+1', '2d+2', '3d-1', '3d', '3d+1', '3d+2', '4d-1', '4d'] },
    golemDeAgua: { coluna: 'PV / FOR / Tamanho', valores: ['10 / 8 / 0.8m', '15 / 9 / 1.0m', '20 / 10 / 1.2m', '25 / 11 / 1.4m', '30 / 12 / 1.6m', '35 / 13 / 1.8m', '40 / 14 / 2.0m', '45 / 15 / 2.2m', '50 / 16 / 2.5m', '60 / 17 / 2.8m', '70 / 18 / 3.0m', '80 / 19 / 3.3m', '90 / 20 / 3.6m', '100 / 21 / 4.0m', '120 / 22 / 5.0m'] },
    tempestadeDeGelo: { coluna: 'Dano em Área', valores: ['1d-2', '1d-1', '1d', '1d+1', '1d+2', '2d-1', '2d', '2d+1', '2d+2', '3d-1', '3d', '3d+1', '3d+2', '4d-1', '4d'] },
    congelamento: { coluna: 'Duração / Chance', valores: ['1s / 10%', '2s / 15%', '3s / 20%', '4s / 25%', '5s / 30%', '6s / 35%', '7s / 40%', '8s / 45%', '9s / 50%', '10s / 55%', '12s / 60%', '15s / 65%', '20s / 70%', '30s / 75%', '1min / 80%'] }
};

const catalogoPericias = [
    { id: "adestramento", nome: "Adestramento", tipo: "mental", atributo: "iq", descricao: "Treinar e comandar animais" },
    { id: "alquimia", nome: "Alquimia", tipo: "mental", atributo: "iq", descricao: "Criar poções e misturas" },
    { id: "artista", nome: "Artista", tipo: "mental", atributo: "iq", descricao: "Pintura, música, escultura" },
    { id: "comercio", nome: "Comércio", tipo: "mental", atributo: "iq", descricao: "Negociar e avaliar mercadorias" },
    { id: "culinaria", nome: "Culinária", tipo: "mental", atributo: "iq", descricao: "Preparar alimentos" },
    { id: "persuasao", nome: "Persuasão", tipo: "mental", atributo: "iq", descricao: "Convencer alguém" },
    { id: "detectarMentira", nome: "Detecção de Mentira", tipo: "mental", atributo: "iq", descricao: "Perceber se alguém mente" },
    { id: "diplomacia", nome: "Diplomacia", tipo: "mental", atributo: "iq", descricao: "Resolver conflitos" },
    { id: "falcoaria", nome: "Falcoaria", tipo: "mental", atributo: "iq", descricao: "Treinar aves de rapina" },
    { id: "interrogatorio", nome: "Interrogatório", tipo: "mental", atributo: "iq", descricao: "Extrair informações" },
    { id: "intimidacao", nome: "Intimidação", tipo: "mental", atributo: "iq", descricao: "Assustar ou coagir" },
    { id: "labia", nome: "Lábia", tipo: "mental", atributo: "iq", descricao: "Conversa fiada, enganar" },
    { id: "lideranca", nome: "Liderança", tipo: "mental", atributo: "iq", descricao: "Comandar e inspirar" },
    { id: "manha", nome: "Manha", tipo: "mental", atributo: "iq", descricao: "Ardis e truques" },
    { id: "medicina", nome: "Medicina", tipo: "mental", atributo: "iq", descricao: "Tratar doenças" },
    { id: "ocultamento", nome: "Ocultamento", tipo: "mental", atributo: "iq", descricao: "Esconder objetos" },
    { id: "ocultismo", nome: "Ocultismo", tipo: "mental", atributo: "iq", descricao: "Conhecimento do sobrenatural" },
    { id: "prestidigitacao", nome: "Prestidigitação", tipo: "mental", atributo: "iq", descricao: "Truques com as mãos" },
    { id: "primeirosSocorros", nome: "Primeiros Socorros", tipo: "mental", atributo: "iq", descricao: "Atendimento emergencial" },
    { id: "rastreamento", nome: "Rastreamento", tipo: "mental", atributo: "iq", descricao: "Seguir pistas e rastros" },
    { id: "veneficio", nome: "Venefício", tipo: "mental", atributo: "iq", descricao: "Preparar venenos" },
    { id: "acrobacia", nome: "Acrobacia", tipo: "fisica", atributo: "dx", descricao: "Saltos, cambalhotas" },
    { id: "arco", nome: "Arco", tipo: "fisica", atributo: "dx", descricao: "Atirar com arco e flecha" },
    { id: "esgrima", nome: "Esgrima", tipo: "fisica", atributo: "dx", descricao: "Lutar com armas brancas" },
    { id: "armasHaste", nome: "Armas de Haste", tipo: "fisica", atributo: "dx", descricao: "Lanças, alabardas" },
    { id: "chicote", nome: "Chicote", tipo: "fisica", atributo: "dx", descricao: "Usar chicote" },
    { id: "espada", nome: "Espada", tipo: "fisica", atributo: "dx", descricao: "Todos os tipos de espada" },
    { id: "mangual", nome: "Mangual", tipo: "fisica", atributo: "dx", descricao: "Armas com corrente" },
    { id: "kuzari", nome: "Kuzari", tipo: "fisica", atributo: "dx", descricao: "Corrente com peso" },
    { id: "arremesso", nome: "Arremesso", tipo: "fisica", atributo: "dx", descricao: "Lançar objetos" },
    { id: "bastao", nome: "Bastão", tipo: "fisica", atributo: "dx", descricao: "Lutar com cajado" },
    { id: "besta", nome: "Besta", tipo: "fisica", atributo: "dx", descricao: "Atirar com besta" },
    { id: "boleadeira", nome: "Boleadeira", tipo: "fisica", atributo: "dx", descricao: "Armas de laço" },
    { id: "boxe", nome: "Boxe", tipo: "fisica", atributo: "dx", descricao: "Socos" },
    { id: "briga", nome: "Briga", tipo: "fisica", atributo: "dx", descricao: "Luta corporal suja" },
    { id: "capa", nome: "Capa", tipo: "fisica", atributo: "dx", descricao: "Usar capa em combate" },
    { id: "cavalgar", nome: "Cavalgar", tipo: "fisica", atributo: "dx", descricao: "Montaria" },
    { id: "escalada", nome: "Escalada", tipo: "fisica", atributo: "dx", descricao: "Subir superfícies" },
    { id: "escudo", nome: "Escudo", tipo: "fisica", atributo: "dx", descricao: "Bloquear com escudo" },
    { id: "fuga", nome: "Fuga", tipo: "fisica", atributo: "dx", descricao: "Escapar de amarras" },
    { id: "funda", nome: "Funda", tipo: "fisica", atributo: "dx", descricao: "Atirar com funda" },
    { id: "furtividade", nome: "Furtividade", tipo: "fisica", atributo: "dx", descricao: "Esgueirar-se" },
    { id: "jitteSai", nome: "Jitte/Sai", tipo: "fisica", atributo: "dx", descricao: "Armas de defesa" },
    { id: "punga", nome: "Punga", tipo: "fisica", atributo: "dx", descricao: "Furtar carteiras" },
    { id: "zarabatana", nome: "Zarabatana", tipo: "fisica", atributo: "dx", descricao: "Atirar dardos" },
    { id: "boemia", nome: "Boemia", tipo: "organica", atributo: "ht", descricao: "Beber sem se embriagar" },
    { id: "caminhada", nome: "Caminhada", tipo: "organica", atributo: "ht", descricao: "Andar longas distâncias" },
    { id: "corrida", nome: "Corrida", tipo: "organica", atributo: "ht", descricao: "Correr rápido" },
    { id: "natacao", nome: "Natação", tipo: "organica", atributo: "ht", descricao: "Nadar" },
    { id: "sexAppeal", nome: "Sex Appeal", tipo: "organica", atributo: "ht", descricao: "Atrair sexualmente" }
];

const tabelaDano = {
    9: "1d-1", 10: "1d", 11: "1d+1", 12: "1d+2",
    13: "2d-1", 14: "2d", 15: "2d+1", 16: "2d+2",
    17: "3d-1", 18: "3d", 19: "3d+1", 20: "3d+2"
};

const atributos = {
    st: { valor: 9, bolinhas: 0, base: 9 },
    dx: { valor: 5, bolinhas: 0, base: 5 },
    iq: { valor: 5, bolinhas: 0, base: 5 },
    ht: { valor: 48, bolinhas: 0, base: 48 }
};

let magiaSelecionada = null;
let escolaSelecionada = 'agua';
let esferasDesbloqueadas = 0;

function calcularDinheiroInicial() {
    const base = parseInt(dinheiroBaseInput?.value) || 1000;
    const riquezaSelect = document.getElementById('riqueza');
    const riqueza = riquezaSelect?.value || 'medio';
    
    if (desvantagensSelecionadas.has('pobre') || riqueza === 'pobre') {
        return Math.floor(base / 2);
    } else if (vantagensSelecionadas.has('rico') || riqueza === 'rico') {
        return base * 5;
    } else {
        return base;
    }
}

function atualizarDinheiroDisplay() {
    dinheiro = calcularDinheiroInicial();
    if (dinheiroSaldo) dinheiroSaldo.textContent = dinheiro;
}

function custoNivelMagia(nivelAtual) {
    const novoNivel = nivelAtual + 1;
    if (novoNivel <= 5) return 2;
    if (novoNivel <= 10) return 4;
    return 6;
}

function showLoading() {
    loadingOverlay.classList.add('active');
}

function hideLoading() {
    loadingOverlay.classList.remove('active');
}

function calcularCarga() {
    const st = atributos.st.valor;
    const leve = st * 2;
    const media = st * 4;
    const pesada = st * 8;
    const limite = st * 12;
    
    let pesoTotal = 0;
    
    inventario.corpo.forEach(item => pesoTotal += (item.peso * (item.quantidade || 1)));
    inventario.mochila.forEach(item => pesoTotal += (item.peso * (item.quantidade || 1)));
    
    cargaAtual.textContent = pesoTotal.toFixed(1);
    cargaLeve.textContent = leve;
    cargaMedia.textContent = media;
    cargaPesada.textContent = pesada;
    cargaLimiteSpan.textContent = limite;
    
    let percentual = (pesoTotal / limite) * 100;
    if (percentual > 100) percentual = 100;
    cargaBarra.style.width = percentual + '%';
    
    let nivel = 'leve';
    let penalidade = 'Nenhuma';
    let reducaoEsquiva = 0;
    let reducaoDeslocamento = 0;
    
    if (pesoTotal > pesada) {
        nivel = 'limite';
        penalidade = '-3 Esquiva, -0.3 Deslocamento';
        reducaoEsquiva = 3;
        reducaoDeslocamento = 0.3;
    } else if (pesoTotal > media) {
        nivel = 'pesado';
        penalidade = '-3 Esquiva, -0.3 Deslocamento';
        reducaoEsquiva = 3;
        reducaoDeslocamento = 0.3;
    } else if (pesoTotal > leve) {
        nivel = 'medio';
        penalidade = '-1 Esquiva, -0.1 Deslocamento';
        reducaoEsquiva = 1;
        reducaoDeslocamento = 0.1;
    }
    
    cargaNivel.textContent = nivel.charAt(0).toUpperCase() + nivel.slice(1);
    cargaNivel.className = `carga-nivel ${nivel}`;
    cargaPenalidade.textContent = penalidade;
    
    let pesoMochilaTotal = 0;
    inventario.mochila.forEach(item => pesoMochilaTotal += (item.peso * (item.quantidade || 1)));
    pesoMochila.textContent = `(${pesoMochilaTotal.toFixed(1)} kg)`;
    
    return { nivel, reducaoEsquiva, reducaoDeslocamento };
}

function renderizarInventario() {
    if (!inventarioCorpo) return;
    
    const renderizarItens = (itens, local) => {
        return itens.map(item => `
            <div class="item-card" data-item-id="${item.id}" data-local="${local}">
                <div class="item-nome">
                    ${item.nome}
                    ${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}
                </div>
                <div class="item-detalhes">
                    <span class="item-peso">${(item.peso * (item.quantidade || 1)).toFixed(1)} kg</span>
                    <span class="item-preco">${item.preco} $</span>
                </div>
                <div class="item-acoes">
                    ${local !== 'deposito' ? `<button class="item-acao btn-mover-deposito" title="Mover para Depósito"><i class="fas fa-arrow-right"></i></button>` : ''}
                    ${local === 'mochila' ? `<button class="item-acao btn-equipar" title="Equipar"><i class="fas fa-user"></i></button>` : ''}
                    ${local === 'corpo' ? `<button class="item-acao btn-guardar" title="Guardar na Mochila"><i class="fas fa-shopping-bag"></i></button>` : ''}
                    ${local !== 'deposito' ? `<button class="item-acao btn-vender" title="Vender (50%)"><i class="fas fa-coins"></i></button>` : ''}
                    <button class="item-acao btn-descartar" title="Descartar"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');
    };
    
    inventarioCorpo.innerHTML = renderizarItens(inventario.corpo, 'corpo') || '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nada equipado</div>';
    inventarioMochila.innerHTML = renderizarItens(inventario.mochila, 'mochila') || '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Mochila vazia</div>';
    inventarioDeposito.innerHTML = inventario.deposito.map(item => `
        <div class="item-card" data-item-id="${item.id}" data-local="deposito">
            <div class="item-nome">
                ${item.nome}
                ${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}
            </div>
            <div class="item-detalhes">
                <span class="item-peso">${(item.peso * (item.quantidade || 1)).toFixed(1)} kg</span>
                <span class="item-preco">${item.preco} $</span>
            </div>
            <div class="item-acoes">
                <button class="item-acao btn-pegar" title="Pegar"><i class="fas fa-arrow-left"></i></button>
                <button class="item-acao btn-vender-deposito" title="Vender (50%)"><i class="fas fa-coins"></i></button>
                <button class="item-acao btn-descartar" title="Descartar"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    `).join('') || '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Depósito vazio</div>';
    
    document.querySelectorAll('.btn-mover-deposito').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.item-card');
            const itemId = card.dataset.itemId;
            const local = card.dataset.local;
            moverParaDeposito(itemId, local);
        });
    });
    
    document.querySelectorAll('.btn-equipar').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.item-card');
            const itemId = card.dataset.itemId;
            equiparItem(itemId);
        });
    });
    
    document.querySelectorAll('.btn-guardar').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.item-card');
            const itemId = card.dataset.itemId;
            guardarItem(itemId);
        });
    });
    
    document.querySelectorAll('.btn-pegar').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.item-card');
            const itemId = card.dataset.itemId;
            pegarItem(itemId);
        });
    });
    
    document.querySelectorAll('.btn-vender, .btn-vender-deposito').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.item-card');
            const itemId = card.dataset.itemId;
            const local = card.dataset.local;
            venderItem(itemId, local);
        });
    });
    
    document.querySelectorAll('.btn-descartar').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.item-card');
            const itemId = card.dataset.itemId;
            const local = card.dataset.local;
            descartarItem(itemId, local);
        });
    });
    
    calcularCarga();
}

function renderizarTabelas(tab = 'armas_ca') {
    document.querySelectorAll('.tabela-item').forEach(t => t.classList.remove('ativa'));
    const tabelaId = 'tabela' + tab.split('_').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('');
    document.getElementById(tabelaId)?.classList.add('ativa');
    
    renderizarTabelaArmasCA();
    renderizarTabelaArmasDist();
    renderizarTabelaArmaduras();
    renderizarTabelaEscudos();
    renderizarTabelaItensGerais();
}

function renderizarTabelaArmasCA() {
    const tbody = document.getElementById('corpoTabelaArmasCA');
    if (!tbody) return;
    
    tbody.innerHTML = catalogoItensData.armas_ca.map(item => `
        <tr>
            <td>${item.nome}</td>
            <td>${item.alcance}</td>
            <td>${item.dano}</td>
            <td>${item.tipoDano}</td>
            <td>${item.preco}</td>
            <td>${item.peso}</td>
            <td>${item.st}</td>
            <td>
                <button class="btn-comprar-tabela" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-tab="armas_ca">
                    <i class="fas fa-cart-plus"></i> Comprar
                </button>
            </td>
        </tr>
    `).join('');
    
    adicionarEventosCompra();
}

function renderizarTabelaArmasDist() {
    const tbody = document.getElementById('corpoTabelaArmasDist');
    if (!tbody) return;
    
    tbody.innerHTML = catalogoItensData.armas_dist.map(item => `
        <tr>
            <td>${item.nome}</td>
            <td>+${item.precisao}</td>
            <td>${item.dano}</td>
            <td>${item.tipoDano}</td>
            <td>${item.alcance}</td>
            <td>${item.preco}</td>
            <td>${item.peso}</td>
            <td>${item.st}</td>
            <td>
                <button class="btn-comprar-tabela" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-tab="armas_dist">
                    <i class="fas fa-cart-plus"></i> Comprar
                </button>
            </td>
        </tr>
    `).join('');
    
    adicionarEventosCompra();
}

function renderizarTabelaArmaduras() {
    const tbody = document.getElementById('corpoTabelaArmaduras');
    if (!tbody) return;
    
    tbody.innerHTML = catalogoItensData.armaduras.map(item => `
        <tr>
            <td>${item.nome}</td>
            <td>${item.rd}</td>
            <td>${item.preco}</td>
            <td>${item.peso}</td>
            <td>
                <button class="btn-comprar-tabela" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-tab="armaduras">
                    <i class="fas fa-cart-plus"></i> Comprar
                </button>
            </td>
        </tr>
    `).join('');
    
    adicionarEventosCompra();
}

function renderizarTabelaEscudos() {
    const tbody = document.getElementById('corpoTabelaEscudos');
    if (!tbody) return;
    
    tbody.innerHTML = catalogoItensData.escudos.map(item => `
        <tr>
            <td>${item.nome}</td>
            <td>+${item.bonus}</td>
            <td>${item.ve}</td>
            <td>${item.preco}</td>
            <td>${item.peso}</td>
            <td>
                <button class="btn-comprar-tabela" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-tab="escudos">
                    <i class="fas fa-cart-plus"></i> Comprar
                </button>
            </td>
        </tr>
    `).join('');
    
    adicionarEventosCompra();
}

function renderizarTabelaItensGerais() {
    const tbody = document.getElementById('corpoTabelaItensGerais');
    if (!tbody) return;
    
    tbody.innerHTML = catalogoItensData.itens_gerais.map(item => {
        let espec = '';
        if (item.duracao) espec = `Duração: ${item.duracao}`;
        else if (item.capacidade) espec = `Capacidade: ${item.capacidade}`;
        else if (item.usos) espec = `${item.usos} usos`;
        
        return `
            <tr>
                <td>${item.nome}</td>
                <td>${espec}</td>
                <td>${item.preco}</td>
                <td>${item.peso}</td>
                <td>
                    <button class="btn-comprar-tabela" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' data-tab="itens_gerais">
                        <i class="fas fa-cart-plus"></i> Comprar
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    adicionarEventosCompra();
}

function adicionarEventosCompra() {
    document.querySelectorAll('.btn-comprar-tabela').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const itemData = JSON.parse(btn.dataset.item.replace(/&apos;/g, "'"));
            const tab = btn.dataset.tab;
            comprarItem(itemData, tab);
        });
    });
}

function comprarItem(item, tab) {
    const preco = item.preco;
    if (dinheiro < preco) {
        alert('Dinheiro insuficiente!');
        return;
    }
    
    dinheiro -= preco;
    dinheiroSaldo.textContent = dinheiro;
    
    const novoItem = {
        ...item,
        id: item.id + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        quantidade: 1
    };
    
    const existente = inventario.deposito.find(i => i.nome === item.nome && i.preco === item.preco);
    if (existente) {
        existente.quantidade = (existente.quantidade || 1) + 1;
    } else {
        inventario.deposito.push(novoItem);
    }
    
    renderizarInventario();
    salvarInventario();
}

function moverParaDeposito(itemId, local) {
    const index = inventario[local].findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario[local][index];
        inventario.deposito.push(item);
        inventario[local].splice(index, 1);
        renderizarInventario();
        salvarInventario();
    }
}

function equiparItem(itemId) {
    const index = inventario.mochila.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario.mochila[index];
        
        if (item.st && atributos.st.valor < item.st) {
            alert(`Força insuficiente! Precisa de ST ${item.st}`);
            return;
        }
        
        inventario.corpo.push(item);
        inventario.mochila.splice(index, 1);
        renderizarInventario();
        salvarInventario();
    }
}

function guardarItem(itemId) {
    const index = inventario.corpo.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario.corpo[index];
        inventario.mochila.push(item);
        inventario.corpo.splice(index, 1);
        renderizarInventario();
        salvarInventario();
    }
}

function pegarItem(itemId) {
    const index = inventario.deposito.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario.deposito[index];
        inventario.mochila.push(item);
        inventario.deposito.splice(index, 1);
        renderizarInventario();
        salvarInventario();
    }
}

function venderItem(itemId, local) {
    const index = inventario[local].findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario[local][index];
        const valorVenda = Math.floor(item.preco * 0.5 * (item.quantidade || 1));
        dinheiro += valorVenda;
        dinheiroSaldo.textContent = dinheiro;
        
        if (item.quantidade > 1) {
            item.quantidade--;
        } else {
            inventario[local].splice(index, 1);
        }
        
        renderizarInventario();
        salvarInventario();
        alert(`Vendeu por ${valorVenda} $`);
    }
}

function descartarItem(itemId, local) {
    if (confirm('Tem certeza que deseja descartar este item?')) {
        const index = inventario[local].findIndex(i => i.id === itemId);
        if (index !== -1) {
            const item = inventario[local][index];
            if (item.quantidade > 1) {
                item.quantidade--;
            } else {
                inventario[local].splice(index, 1);
            }
            renderizarInventario();
            salvarInventario();
        }
    }
}

function salvarInventario() {
    if (personagemTemp) {
        personagemTemp.inventario = inventario;
        personagemTemp.dinheiro = dinheiro;
        sessionStorage.setItem('personagemTemp', JSON.stringify(personagemTemp));
    }
}

function atualizarContadoresAbas() {
    if (contadorVantagensAba) contadorVantagensAba.textContent = `${vantagensSelecionadas.size}/3`;
    if (contadorDesvantagensAba) contadorDesvantagensAba.textContent = `${desvantagensSelecionadas.size}/4`;
    if (contadorVantagensSpan) contadorVantagensSpan.textContent = `${vantagensSelecionadas.size}/3`;
    if (contadorDesvantagensSpan) contadorDesvantagensSpan.textContent = `${desvantagensSelecionadas.size}/4`;
    
    if (contadorPericiasAba) contadorPericiasAba.textContent = `${pmGastoTotal} PM`;
    
    const magiasDesbloqueadas = Object.values(escolas.agua.magias).filter(m => m.desbloqueada).length;
    if (contadorMagiasAba) contadorMagiasAba.textContent = `${magiasDesbloqueadas}/15`;
    if (esferasDesbloqueadasSpan) esferasDesbloqueadasSpan.textContent = esferasDesbloqueadas;
    
    const aptidao = vantagensSelecionadas.has('aptidaoMagica') ? 1 : 0;
    if (aptidaoMagicaValor) aptidaoMagicaValor.textContent = `+${aptidao}`;
    
    const pmMagias = Object.values(escolas.agua.magias).reduce((total, magia) => {
        let custoTotalMagia = 0;
        for (let i = 1; i <= magia.nivel; i++) {
            if (i <= 5) custoTotalMagia += 2;
            else if (i <= 10) custoTotalMagia += 4;
            else custoTotalMagia += 6;
        }
        return total + custoTotalMagia;
    }, 0);
    
    if (pmMagiasSpan) pmMagiasSpan.textContent = pmMagias;
    
    pmGasto.textContent = pmGastoTotal;
    pmRestante.textContent = pmDisponivel - pmGastoTotal;
    
    atualizarDinheiroDisplay();
}

function calcularDerivados() {
    const st = atributos.st.valor;
    const dano = tabelaDano[st] || "1d-1";
    const dx = atributos.dx.valor;
    const carga = calcularCarga();
    let esquiva = Math.floor(dx / 2) + 3;
    esquiva -= carga.reducaoEsquiva;
    
    const iq = atributos.iq.valor;
    const vontade = iq;
    const vida = atributos.ht.base + (atributos.ht.bolinhas * 6);
    atributos.ht.valor = vida;
    const fadiga = 8 + atributos.ht.bolinhas;
    const mana = fadiga + vontade;
    let deslocamento = vida / 10;
    deslocamento -= carga.reducaoDeslocamento;
    if (deslocamento < 0.5) deslocamento = 0.5;

    document.getElementById('stDano').textContent = dano;
    document.getElementById('dxEsquiva').textContent = `Esquiva ${esquiva}`;
    document.getElementById('iqVontade').textContent = `Vontade ${vontade}`;
    document.getElementById('htVida').textContent = `Vida ${vida}`;
    document.getElementById('htFadiga').textContent = `Fadiga ${fadiga}`;
    document.getElementById('htValor').textContent = vida;
    document.getElementById('statusVida').textContent = vida;
    document.getElementById('statusFadiga').textContent = fadiga;
    document.getElementById('statusMana').textContent = mana;
    document.getElementById('statusDano').textContent = dano;
    document.getElementById('statusEsquiva').textContent = esquiva;
    document.getElementById('statusDeslocamento').textContent = deslocamento.toFixed(1);
}

function criarBolinhas(atributoId) {
    const container = document.getElementById(`${atributoId}Bolinhas`);
    if (!container) return;
    container.innerHTML = '';
    for (let i = 0; i < 15; i++) {
        const bolinha = document.createElement('div');
        bolinha.className = 'bolinha';
        bolinha.dataset.index = i;
        bolinha.dataset.atributo = atributoId;
        bolinha.addEventListener('click', () => {
            const atributo = atributos[atributoId];
            const clicada = i < atributo.bolinhas;
            if (!clicada && pontosRestantes > 0) {
                atributo.bolinhas++;
                if (atributoId === 'ht') atributo.valor = atributo.base + (atributo.bolinhas * 6);
                else atributo.valor = atributo.base + atributo.bolinhas;
                pontosRestantes--;
            } else if (clicada) {
                atributo.bolinhas--;
                if (atributoId === 'ht') atributo.valor = atributo.base + (atributo.bolinhas * 6);
                else atributo.valor = atributo.base + atributo.bolinhas;
                pontosRestantes++;
            }
            atualizarInterface();
        });
        container.appendChild(bolinha);
    }
    atualizarBolinhas(atributoId);
}

function atualizarBolinhas(atributoId) {
    const container = document.getElementById(`${atributoId}Bolinhas`);
    if (!container) return;
    const bolinhas = container.children;
    const qtdPreenchidas = atributos[atributoId].bolinhas;
    for (let i = 0; i < bolinhas.length; i++) {
        if (i < qtdPreenchidas) bolinhas[i].classList.add('preenchida');
        else bolinhas[i].classList.remove('preenchida');
    }
}

function atualizarInterface() {
    document.getElementById('stValor').textContent = atributos.st.valor;
    document.getElementById('dxValor').textContent = atributos.dx.valor;
    document.getElementById('iqValor').textContent = atributos.iq.valor;
    pontosRestantesSpan.textContent = pontosRestantes;
    
    atualizarBolinhas('st');
    atualizarBolinhas('dx');
    atualizarBolinhas('iq');
    atualizarBolinhas('ht');
    
    calcularDerivados();
    
    if (abaAtual === 'pericias') renderizarPericiasAdquiridas();
    if (abaAtual === 'magias') renderizarEsferas();
}

function mudarAba(abaId) {
    abas.forEach(aba => {
        if (aba.dataset.aba === abaId) aba.classList.add('ativa');
        else aba.classList.remove('ativa');
    });
    conteudos.forEach(conteudo => {
        if (conteudo.id === `aba${abaId.charAt(0).toUpperCase() + abaId.slice(1)}`) conteudo.classList.add('ativa');
        else conteudo.classList.remove('ativa');
    });
    abaAtual = abaId;
    
    if (abaId === 'basicos') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'inline-flex';
        btnFinalizar.style.display = 'none';
    } else if (abaId === 'vantagens') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'inline-flex';
        btnFinalizar.style.display = 'none';
        carregarResumoPersonagem();
    } else if (abaId === 'desvantagens') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'inline-flex';
        btnFinalizar.style.display = 'none';
        carregarResumoPersonagem2();
    } else if (abaId === 'pericias') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'none';
        btnFinalizar.style.display = 'inline-flex';
        carregarPericias();
    } else if (abaId === 'magias') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'none';
        btnFinalizar.style.display = 'inline-flex';
        renderizarEsferas();
    } else if (abaId === 'equipamentos') {
        btnAnterior.style.display = 'inline-flex';
        btnProximo.style.display = 'none';
        btnFinalizar.style.display = 'inline-flex';
        atualizarDinheiroDisplay();
        renderizarInventario();
        renderizarTabelas('armas_ca');
    }
}

function carregarResumoPersonagem() {
    if (!personagemTemp) return;
    document.getElementById('resumoNome').textContent = personagemTemp.nome || 'Sem nome';
    const classes = { guerreiro: 'Guerreiro', mago: 'Mago', ladino: 'Ladino', clerigo: 'Clérigo', barbaro: 'Bárbaro' };
    document.getElementById('resumoClasse').textContent = classes[personagemTemp.classe] || personagemTemp.classe;
    const aparencias = { feio: 'Feio', normal: 'Normal', atraente: 'Atraente' };
    document.getElementById('resumoAparencia').textContent = aparencias[personagemTemp.aparencia] || 'Normal';
    const riquezas = { pobre: 'Pobre', medio: 'Médio', rico: 'Rico' };
    document.getElementById('resumoRiqueza').textContent = riquezas[personagemTemp.riqueza] || 'Médio';
    if (personagemTemp.fotoURL) document.getElementById('resumoFoto').innerHTML = `<img src="${personagemTemp.fotoURL}" alt="Foto">`;
}

function carregarResumoPersonagem2() {
    if (!personagemTemp) return;
    document.getElementById('resumoNome2').textContent = personagemTemp.nome || 'Sem nome';
    const classes = { guerreiro: 'Guerreiro', mago: 'Mago', ladino: 'Ladino', clerigo: 'Clérigo', barbaro: 'Bárbaro' };
    document.getElementById('resumoClasse2').textContent = classes[personagemTemp.classe] || personagemTemp.classe;
    const aparencias = { feio: 'Feio', normal: 'Normal', atraente: 'Atraente' };
    document.getElementById('resumoAparencia2').textContent = aparencias[personagemTemp.aparencia] || 'Normal';
    const riquezas = { pobre: 'Pobre', medio: 'Médio', rico: 'Rico' };
    document.getElementById('resumoRiqueza2').textContent = riquezas[personagemTemp.riqueza] || 'Médio';
    if (personagemTemp.fotoURL) document.getElementById('resumoFoto2').innerHTML = `<img src="${personagemTemp.fotoURL}" alt="Foto">`;
}

function selecionarVantagem(card) {
    const vantagemId = card.dataset.vantagem;
    if (vantagensSelecionadas.has(vantagemId)) {
        vantagensSelecionadas.delete(vantagemId);
        card.classList.remove('selecionada');
    } else {
        if (vantagensSelecionadas.size < 3) {
            vantagensSelecionadas.add(vantagemId);
            card.classList.add('selecionada');
        } else { alert('Você já selecionou 3 vantagens!'); return; }
    }
    
    if (vantagemId === 'rico') {
        if (desvantagensSelecionadas.has('pobre')) {
            desvantagensSelecionadas.delete('pobre');
            document.querySelector('[data-desvantagem="pobre"]')?.classList.remove('selecionada');
        }
    }
    
    atualizarContadoresAbas();
}

function selecionarDesvantagem(card) {
    const desvantagemId = card.dataset.desvantagem;
    if (desvantagensSelecionadas.has(desvantagemId)) {
        desvantagensSelecionadas.delete(desvantagemId);
        card.classList.remove('selecionada');
    } else {
        if (desvantagensSelecionadas.size < 4) {
            desvantagensSelecionadas.add(desvantagemId);
            card.classList.add('selecionada');
        } else { alert('Você já selecionou 4 desvantagens!'); return; }
    }
    
    if (desvantagemId === 'pobre') {
        if (vantagensSelecionadas.has('rico')) {
            vantagensSelecionadas.delete('rico');
            document.querySelector('[data-vantagem="rico"]')?.classList.remove('selecionada');
        }
    }
    
    atualizarContadoresAbas();
}

function carregarPericias() {
    renderizarCatalogoPericias('todas');
    renderizarPericiasAdquiridas();
}

function renderizarCatalogoPericias(filtro = 'todas') {
    if (!listaPericias) return;
    const periciasFiltradas = catalogoPericias.filter(p => filtro === 'todas' || p.tipo === filtro);
    listaPericias.innerHTML = periciasFiltradas.map(pericia => `
        <div class="pericia-card" data-pericia-id="${pericia.id}">
            <h4>${pericia.nome} <span class="tipo ${pericia.tipo}">${pericia.tipo === 'mental' ? 'IQ' : pericia.tipo === 'fisica' ? 'DX' : 'HT'}</span></h4>
            <div class="descricao">${pericia.descricao}</div>
            <div class="atributo">Atributo: ${pericia.atributo.toUpperCase()}</div>
        </div>
    `).join('');
    document.querySelectorAll('.pericia-card').forEach(card => {
        card.addEventListener('click', () => abrirModalPericia(card.dataset.periciaId));
    });
}

function renderizarPericiasAdquiridas() {
    if (!listaPericiasAdquiridas) return;
    const periciasArray = Object.entries(pericias);
    if (periciasArray.length === 0) {
        listaPericiasAdquiridas.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Clique em uma perícia do catálogo para adicionar</div>';
        return;
    }
    listaPericiasAdquiridas.innerHTML = periciasArray.map(([id, dados]) => {
        const pericia = catalogoPericias.find(p => p.id === id);
        const bonus = dados.nivel === 1 ? 0 : dados.nivel - 1;
        let atributoBase = 0;
        if (pericia?.atributo === 'st') atributoBase = atributos.st.valor;
        else if (pericia?.atributo === 'dx') atributoBase = atributos.dx.valor;
        else if (pericia?.atributo === 'iq') atributoBase = atributos.iq.valor;
        else if (pericia?.atributo === 'ht') atributoBase = atributos.ht.valor;
        const nh = atributoBase + bonus;
        return `
            <div class="pericia-adquirida" data-pericia-id="${id}">
                <div class="pericia-adquirida-info">
                    <h4>${pericia?.nome || id}</h4>
                    <div class="nivel">Nível ${dados.nivel} <span class="bonus">(Bônus ${bonus > 0 ? '+' : ''}${bonus})</span></div>
                    <div class="nh">NH: <span>${nh}</span> (${pericia?.atributo.toUpperCase()} ${atributoBase} + ${bonus})</div>
                </div>
                <div class="pericia-adquirida-acoes">
                    <button class="btn-pericia btn-aumentar-pericia" data-pericia-id="${id}" ${pmGastoTotal >= pmDisponivel ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
                    <button class="btn-pericia btn-diminuir-pericia" data-pericia-id="${id}" ${dados.nivel <= 1 ? 'disabled' : ''}><i class="fas fa-minus"></i></button>
                </div>
            </div>
        `;
    }).join('');
    document.querySelectorAll('.btn-aumentar-pericia').forEach(btn => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); aumentarPericia(btn.dataset.periciaId); });
    });
    document.querySelectorAll('.btn-diminuir-pericia').forEach(btn => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); diminuirPericia(btn.dataset.periciaId); });
    });
}

function calcularCustoPericia(nivel) {
    return nivel === 1 ? 2 : 2 + ((nivel - 1) * 4);
}

function abrirModalPericia(periciaId) {
    const pericia = catalogoPericias.find(p => p.id === periciaId);
    if (!pericia) return;
    const periciaExistente = pericias[periciaId];
    const nivelAtual = periciaExistente?.nivel || 0;
    periciaAtual = {
        id: periciaId,
        nome: pericia.nome,
        nivelAtual: nivelAtual,
        novoNivel: nivelAtual + 1 || 1
    };
    modalPericiaNome.textContent = pericia.nome;
    modalPericiaNivel.textContent = periciaAtual.novoNivel;
    atualizarModalPericia();
    modalPericia.classList.add('active');
}

function atualizarModalPericia() {
    if (!periciaAtual) return;
    const novoNivel = periciaAtual.novoNivel;
    const nivelAtual = periciaAtual.nivelAtual;
    const custoTotal = calcularCustoPericia(novoNivel);
    const custoAtual = nivelAtual > 0 ? calcularCustoPericia(nivelAtual) : 0;
    const custoDiferenca = custoTotal - custoAtual;
    modalPericiaCusto.textContent = custoDiferenca + ' PM';
    modalPericiaConfirmar.disabled = custoDiferenca > (pmDisponivel - pmGastoTotal);
    if (nivelAtual > 0) modalPericiaObservacao.textContent = `Nível atual: ${nivelAtual} (já gastou ${custoAtual} PM)`;
    else modalPericiaObservacao.textContent = 'Perícia nova';
    modalPericiaMenos.disabled = novoNivel <= (nivelAtual > 0 ? nivelAtual + 1 : 1);
    modalPericiaMais.disabled = novoNivel >= 7;
}

function confirmarPericia() {
    if (!periciaAtual) return;
    const periciaId = periciaAtual.id;
    const novoNivel = periciaAtual.novoNivel;
    const nivelAtual = periciaAtual.nivelAtual;
    const custoTotal = calcularCustoPericia(novoNivel);
    const custoAtual = nivelAtual > 0 ? calcularCustoPericia(nivelAtual) : 0;
    const custoDiferenca = custoTotal - custoAtual;
    if (custoDiferenca > (pmDisponivel - pmGastoTotal)) { alert('PM insuficiente!'); return; }
    pmGastoTotal += custoDiferenca;
    pericias[periciaId] = { nivel: novoNivel, custo: custoTotal };
    pmGasto.textContent = pmGastoTotal;
    pmRestante.textContent = pmDisponivel - pmGastoTotal;
    renderizarPericiasAdquiridas();
    atualizarContadoresAbas();
    modalPericia.classList.remove('active');
}

function aumentarPericia(periciaId) {
    const pericia = pericias[periciaId];
    if (!pericia) return;
    const novoNivel = pericia.nivel + 1;
    if (novoNivel > 7) return;
    const custoAtual = calcularCustoPericia(pericia.nivel);
    const custoNovo = calcularCustoPericia(novoNivel);
    const custoDiferenca = custoNovo - custoAtual;
    if (custoDiferenca > (pmDisponivel - pmGastoTotal)) { alert('PM insuficiente!'); return; }
    pmGastoTotal += custoDiferenca;
    pericia.nivel = novoNivel;
    pericia.custo = custoNovo;
    pmGasto.textContent = pmGastoTotal;
    pmRestante.textContent = pmDisponivel - pmGastoTotal;
    renderizarPericiasAdquiridas();
    atualizarContadoresAbas();
}

function diminuirPericia(periciaId) {
    const pericia = pericias[periciaId];
    if (!pericia) return;
    const novoNivel = pericia.nivel - 1;
    if (novoNivel < 1) return;
    const custoAtual = calcularCustoPericia(pericia.nivel);
    const custoNovo = calcularCustoPericia(novoNivel);
    const custoDiferenca = custoAtual - custoNovo;
    pmGastoTotal -= custoDiferenca;
    if (novoNivel === 0) delete pericias[periciaId];
    else { pericia.nivel = novoNivel; pericia.custo = custoNovo; }
    pmGasto.textContent = pmGastoTotal;
    pmRestante.textContent = pmDisponivel - pmGastoTotal;
    renderizarPericiasAdquiridas();
    atualizarContadoresAbas();
}

function renderizarEsferas() {
    if (!esferasGrid) return;
    const magiasLista = Object.entries(escolas.agua.magias);
    let html = '';
    magiasLista.forEach(([id, magia], index) => {
        const numero = index + 1;
        let classeEsfera = 'trancada';
        let iconeCadeado = '';
        let botaoAcao = '';
        
        if (magia.desbloqueada) {
            classeEsfera = 'desbloqueada';
        } else if (numero <= esferasDesbloqueadas + 1) {
            classeEsfera = 'disponivel';
            const custo = custoNivelMagia(0);
            botaoAcao = `<button class="btn-comprar-esfera" data-esfera-id="${id}" data-esfera-numero="${numero}">Desbloquear (${custo} PM)</button>`;
        } else {
            iconeCadeado = '<i class="fas fa-lock" style="color: #666; font-size: 1.2rem; margin: 5px 0;"></i>';
        }
        
        const nomesMagia = {
            localizarAgua: 'Localizar Água', purificarAgua: 'Purificar Água', criarAgua: 'Criar Água',
            dissiparAgua: 'Dissipar Água', respirarNaAgua: 'Respirar na Água', moldarAgua: 'Moldar Água',
            nevoeiro: 'Nevoeiro', armaCongelante: 'Arma Congelante', cortinaDagua: 'Cortina D\'água',
            jatoDeAgua: 'Jato de Água', ondaExpulsora: 'Onda Expulsora', adagaDeGelo: 'Adaga de Gelo',
            golemDeAgua: 'Golem de Água', tempestadeDeGelo: 'Tempestade de Gelo', congelamento: 'Congelamento'
        };
        
        html += `
            <div class="esfera-card ${classeEsfera}" data-magia-id="${id}">
                <div class="numero-esfera">${numero}</div>
                <div class="icone-esfera"><i class="fas ${magia.icone}"></i></div>
                ${iconeCadeado}
                <div class="nome-esfera">${nomesMagia[id] || id}</div>
                <div class="tipo-esfera">${magia.tipo}</div>
                ${magia.desbloqueada ? `<div class="nivel-esfera">Nível ${magia.nivel} <button class="btn-detalhe" data-magia-id="${id}" style="background:transparent; border:1px solid #ffd700; color:#ffd700; border-radius:15px; padding:2px 8px; margin-left:5px; cursor:pointer;"><i class="fas fa-search"></i></button></div>` : ''}
                ${botaoAcao}
            </div>
        `;
    });
    esferasGrid.innerHTML = html;
    
    document.querySelectorAll('.btn-comprar-esfera').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const esferaId = btn.dataset.esferaId;
            const custo = custoNivelMagia(0);
            if (custo > (pmDisponivel - pmGastoTotal)) { alert('PM insuficiente!'); return; }
            pmGastoTotal += custo;
            escolas.agua.magias[esferaId].desbloqueada = true;
            escolas.agua.magias[esferaId].nivel = 1;
            esferasDesbloqueadas++;
            pmGasto.textContent = pmGastoTotal;
            pmRestante.textContent = pmDisponivel - pmGastoTotal;
            atualizarContadoresAbas();
            renderizarEsferas();
        });
    });
    
    document.querySelectorAll('.btn-detalhe, .esfera-card.desbloqueada').forEach(el => {
        el.addEventListener('click', (e) => {
            if (e.target.closest('.btn-comprar-esfera')) return;
            const magiaId = el.closest('.esfera-card')?.dataset.magiaId || el.dataset.magiaId;
            if (magiaId && escolas.agua.magias[magiaId].desbloqueada) abrirDetalheMagia(magiaId);
        });
    });
}

function abrirDetalheMagia(magiaId) {
    const magia = escolas.agua.magias[magiaId];
    const tabela = tabelasMagia[magiaId];
    if (!magia || !tabela) return;
    
    magiaSelecionada = magiaId;
    const nomesMagia = {
        localizarAgua: 'Localizar Água', purificarAgua: 'Purificar Água', criarAgua: 'Criar Água',
        dissiparAgua: 'Dissipar Água', respirarNaAgua: 'Respirar na Água', moldarAgua: 'Moldar Água',
        nevoeiro: 'Nevoeiro', armaCongelante: 'Arma Congelante', cortinaDagua: 'Cortina D\'água',
        jatoDeAgua: 'Jato de Água', ondaExpulsora: 'Onda Expulsora', adagaDeGelo: 'Adaga de Gelo',
        golemDeAgua: 'Golem de Água', tempestadeDeGelo: 'Tempestade de Gelo', congelamento: 'Congelamento'
    };
    
    detalheMagiaTitulo.textContent = nomesMagia[magiaId] || magiaId;
    detalheMagiaInfo.textContent = `${magia.atributo} | Tipo: ${magia.tipo}`;
    
    let linhas = '';
    for (let i = 0; i < 15; i++) {
        const nivel = i + 1;
        const classe = nivel === magia.nivel ? 'nivel-atual' : '';
        const valor = tabela.valores[i] || '-';
        linhas += `<tr class="${classe}"><td>${nivel}</td><td>${valor}</td></tr>`;
    }
    corpoTabelaDetalhe.innerHTML = linhas;
    
    const custoProximoNivel = magia.nivel >= 15 ? 0 : custoNivelMagia(magia.nivel);
    comprarNivelMagia.disabled = magia.nivel >= 15 || (custoProximoNivel > (pmDisponivel - pmGastoTotal));
    comprarNivelMagia.textContent = magia.nivel >= 15 ? 'Nível Máximo' : `Comprar Nível ${magia.nivel + 1} (${custoProximoNivel} PM)`;
    
    detalheMagiaModal.classList.add('active');
}

function salvarDadosBasicos() {
    const nome = document.getElementById('nomePersonagem')?.value || '';
    const classe = document.getElementById('classePersonagem')?.value || 'guerreiro';
    const aparencia = document.getElementById('aparencia')?.value || 'normal';
    const riqueza = document.getElementById('riqueza')?.value || 'medio';
    const peculiaridades = document.getElementById('peculiaridades')?.value || '';
    const fotoURL = previewImage?.src || '';
    const vida = atributos.ht.base + (atributos.ht.bolinhas * 6);
    const fadiga = 8 + atributos.ht.bolinhas;
    const mana = fadiga + atributos.iq.valor;
    
    dinheiro = calcularDinheiroInicial();
    
    personagemTemp = {
        nome, classe, fotoURL, aparencia, riqueza, peculiaridades,
        dinheiroBase: parseInt(dinheiroBaseInput?.value) || 1000,
        atributos: {
            st: { bolinhas: atributos.st.bolinhas, valor: atributos.st.valor, base: 9 },
            dx: { bolinhas: atributos.dx.bolinhas, valor: atributos.dx.valor, base: 5 },
            iq: { bolinhas: atributos.iq.bolinhas, valor: atributos.iq.valor, base: 5 },
            ht: { bolinhas: atributos.ht.bolinhas, valor: vida, base: 48 }
        },
        status: { vidaMax: vida, fadigaMax: fadiga, manaMax: mana },
        derivados: {
            danoBase: tabelaDano[atributos.st.valor] || "1d-1",
            esquiva: Math.floor(atributos.dx.valor / 2) + 3,
            vontade: atributos.iq.valor,
            percepcao: atributos.iq.valor,
            deslocamento: (vida / 10).toFixed(1)
        },
        inventario: inventario,
        dinheiro: dinheiro
    };
    sessionStorage.setItem('personagemTemp', JSON.stringify(personagemTemp));
}

function carregarDadosSalvos() {
    try {
        const salvos = sessionStorage.getItem('personagemTemp');
        if (salvos) {
            personagemTemp = JSON.parse(salvos);
            document.getElementById('nomePersonagem').value = personagemTemp.nome || '';
            document.getElementById('classePersonagem').value = personagemTemp.classe || 'guerreiro';
            document.getElementById('aparencia').value = personagemTemp.aparencia || 'normal';
            document.getElementById('riqueza').value = personagemTemp.riqueza || 'medio';
            document.getElementById('peculiaridades').value = personagemTemp.peculiaridades || '';
            if (personagemTemp.dinheiroBase) {
                document.getElementById('dinheiroBase').value = personagemTemp.dinheiroBase;
            }
            if (personagemTemp.fotoURL) {
                previewImage.src = personagemTemp.fotoURL;
                previewArea.style.display = 'block';
                uploadArea.style.display = 'none';
            }
            if (personagemTemp.atributos) {
                atributos.st = personagemTemp.atributos.st || { valor: 9, bolinhas: 0, base: 9 };
                atributos.dx = personagemTemp.atributos.dx || { valor: 5, bolinhas: 0, base: 5 };
                atributos.iq = personagemTemp.atributos.iq || { valor: 5, bolinhas: 0, base: 5 };
                atributos.ht = personagemTemp.atributos.ht || { valor: 48, bolinhas: 0, base: 48 };
                pontosRestantes = 6 - (atributos.st.bolinhas + atributos.dx.bolinhas + atributos.iq.bolinhas + atributos.ht.bolinhas);
                atualizarInterface();
            }
            if (personagemTemp.inventario) {
                inventario = personagemTemp.inventario;
            }
            if (personagemTemp.dinheiro !== undefined) {
                dinheiro = personagemTemp.dinheiro;
            }
        }
    } catch (e) {}
}

document.addEventListener('DOMContentLoaded', () => {
    criarBolinhas('st');
    criarBolinhas('dx');
    criarBolinhas('iq');
    criarBolinhas('ht');
    carregarDadosSalvos();
    atualizarDinheiroDisplay();
    
    dinheiroBaseInput.addEventListener('input', () => {
        atualizarDinheiroDisplay();
        if (personagemTemp) {
            personagemTemp.dinheiroBase = parseInt(dinheiroBaseInput.value) || 1000;
        }
    });
    
    document.getElementById('riqueza').addEventListener('change', () => {
        atualizarDinheiroDisplay();
    });
    
    abas.forEach(aba => {
        aba.addEventListener('click', () => {
            if (['vantagens', 'desvantagens', 'pericias', 'magias', 'equipamentos'].includes(aba.dataset.aba)) salvarDadosBasicos();
            mudarAba(aba.dataset.aba);
        });
    });

    subabas.forEach(subaba => {
        subaba.addEventListener('click', () => {
            if (subaba.classList.contains('ativa') || subaba.disabled) return;
            document.querySelectorAll('.subaba').forEach(s => s.classList.remove('ativa'));
            subaba.classList.add('ativa');
            escolaSelecionada = subaba.dataset.subaba;
            renderizarEsferas();
        });
    });

    uploadArea.addEventListener('click', () => fotoInput.click());
    fotoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewArea.style.display = 'block';
                uploadArea.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });
    removeFoto.addEventListener('click', () => {
        previewArea.style.display = 'none';
        uploadArea.style.display = 'block';
        fotoInput.value = '';
    });

    document.querySelectorAll('.vantagem-card').forEach(card => {
        card.addEventListener('click', () => selecionarVantagem(card));
    });
    document.querySelectorAll('.desvantagem-card:not(#cardFobia)').forEach(card => {
        card.addEventListener('click', () => selecionarDesvantagem(card));
    });

    cardFobia.addEventListener('click', () => modalFobias.classList.add('active'));
    fecharModalFobias.addEventListener('click', () => modalFobias.classList.remove('active'));
    modalFobias.addEventListener('click', (e) => { if (e.target === modalFobias) modalFobias.classList.remove('active'); });
    document.querySelectorAll('.fobia-item').forEach(item => {
        item.addEventListener('click', () => {
            if (desvantagensSelecionadas.size >= 4) { alert('Você já selecionou 4 desvantagens!'); modalFobias.classList.remove('active'); return; }
            const fobia = item.dataset.fobia;
            const nomeFobia = item.querySelector('h4')?.textContent || fobia;
            fobiaSelecionada = fobia;
            fobiaEscolhida.style.display = 'inline-block';
            fobiaEscolhida.textContent = nomeFobia;
            cardFobia.classList.add('selecionada');
            desvantagensSelecionadas.add(`fobia:${fobia}`);
            atualizarContadoresAbas();
            modalFobias.classList.remove('active');
        });
    });

    document.querySelectorAll('.filtro-pericia').forEach(filtro => {
        filtro.addEventListener('click', () => {
            document.querySelectorAll('.filtro-pericia').forEach(f => f.classList.remove('ativo'));
            filtro.classList.add('ativo');
            renderizarCatalogoPericias(filtro.dataset.filtro);
        });
    });

    modalPericiaMais.addEventListener('click', () => {
        if (periciaAtual) { periciaAtual.novoNivel++; modalPericiaNivel.textContent = periciaAtual.novoNivel; atualizarModalPericia(); }
    });
    modalPericiaMenos.addEventListener('click', () => {
        if (periciaAtual) { periciaAtual.novoNivel--; modalPericiaNivel.textContent = periciaAtual.novoNivel; atualizarModalPericia(); }
    });
    modalPericiaCancelar.addEventListener('click', () => modalPericia.classList.remove('active'));
    modalPericiaConfirmar.addEventListener('click', confirmarPericia);

    pmInicial.addEventListener('change', () => {
        pmDisponivel = parseInt(pmInicial.value) || 30;
        pmRestante.textContent = pmDisponivel - pmGastoTotal;
    });

    fecharDetalheMagia.addEventListener('click', () => detalheMagiaModal.classList.remove('active'));
    comprarNivelMagia.addEventListener('click', () => {
        if (!magiaSelecionada) return;
        const magia = escolas.agua.magias[magiaSelecionada];
        if (magia.nivel >= 15) return;
        
        const custo = custoNivelMagia(magia.nivel);
        if (custo > (pmDisponivel - pmGastoTotal)) { alert('PM insuficiente!'); return; }
        
        pmGastoTotal += custo;
        magia.nivel++;
        
        pmGasto.textContent = pmGastoTotal;
        pmRestante.textContent = pmDisponivel - pmGastoTotal;
        atualizarContadoresAbas();
        abrirDetalheMagia(magiaSelecionada);
        renderizarEsferas();
    });

    document.querySelectorAll('.catalogo-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.catalogo-tab').forEach(t => t.classList.remove('ativo'));
            tab.classList.add('ativo');
            renderizarTabelas(tab.dataset.tab);
        });
    });

    btnCriarItem.addEventListener('click', () => {
        modalCriarItem.classList.add('active');
        atualizarCamposEspecificos();
    });

    cancelarCriarItem.addEventListener('click', () => {
        modalCriarItem.classList.remove('active');
    });

    itemPersonalizadoTipo.addEventListener('change', atualizarCamposEspecificos);

    function atualizarCamposEspecificos() {
        const tipo = itemPersonalizadoTipo.value;
        let html = '';
        
        if (tipo === 'arma_ca') {
            html = `
                <div class="campo-dinamico">
                    <label>Alcance</label>
                    <input type="number" id="itemAlcance" min="0" step="0.1" value="1">
                </div>
                <div class="campo-dinamico">
                    <label>Dano</label>
                    <input type="text" id="itemDano" value="1d">
                </div>
                <div class="campo-dinamico">
                    <label>Tipo de Dano</label>
                    <select id="itemTipoDano">
                        <option value="Corte">Corte</option>
                        <option value="Perfuração">Perfuração</option>
                        <option value="Contusão">Contusão</option>
                    </select>
                </div>
                <div class="campo-dinamico">
                    <label>ST Exigido</label>
                    <input type="number" id="itemST" min="1" value="9">
                </div>
            `;
        } else if (tipo === 'arma_dist') {
            html = `
                <div class="campo-dinamico">
                    <label>Precisão</label>
                    <input type="number" id="itemPrecisao" min="0" value="1">
                </div>
                <div class="campo-dinamico">
                    <label>Dano</label>
                    <input type="text" id="itemDano" value="1d">
                </div>
                <div class="campo-dinamico">
                    <label>Tipo de Dano</label>
                    <select id="itemTipoDano">
                        <option value="Perfuração">Perfuração</option>
                        <option value="Corte">Corte</option>
                        <option value="Contusão">Contusão</option>
                    </select>
                </div>
                <div class="campo-dinamico">
                    <label>Alcance</label>
                    <input type="text" id="itemAlcance" value="STx10">
                </div>
                <div class="campo-dinamico">
                    <label>ST Exigido</label>
                    <input type="number" id="itemST" min="1" value="9">
                </div>
            `;
        } else if (tipo === 'armadura') {
            html = `
                <div class="campo-dinamico">
                    <label>RD (Redução de Dano)</label>
                    <input type="number" id="itemRD" min="0" value="2">
                </div>
                <div class="campo-dinamico">
                    <label>Local</label>
                    <select id="itemLocal">
                        <option value="completo">Completo (tudo menos cabeça)</option>
                        <option value="torso">Apenas Torso</option>
                        <option value="membros">Apenas Membros</option>
                    </select>
                </div>
            `;
        } else if (tipo === 'escudo') {
            html = `
                <div class="campo-dinamico">
                    <label>Bônus de Defesa</label>
                    <input type="number" id="itemBonus" min="0" value="1">
                </div>
                <div class="campo-dinamico">
                    <label>VE (PV do Escudo)</label>
                    <input type="text" id="itemVE" value="5/30">
                </div>
            `;
        } else {
            html = `
                <div class="campo-dinamico">
                    <label>Descrição/Especificação</label>
                    <input type="text" id="itemEspec" placeholder="Ex: Dura 1h, 10m de comprimento">
                </div>
            `;
        }
        
        camposEspecificos.innerHTML = html;
    }

    confirmarCriarItem.addEventListener('click', () => {
        const nome = itemPersonalizadoNome.value.trim();
        if (!nome) { alert('Digite um nome para o item'); return; }
        
        const tipo = itemPersonalizadoTipo.value;
        const preco = parseInt(itemPersonalizadoPreco.value) || 10;
        const peso = parseFloat(itemPersonalizadoPeso.value) || 1;
        const quantidade = parseInt(itemPersonalizadoQtd.value) || 1;
        
        const novoItem = {
            id: 'personalizado_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
            nome: nome,
            preco: preco,
            peso: peso,
            quantidade: quantidade,
            tipo: tipo
        };
        
        if (tipo === 'arma_ca') {
            novoItem.alcance = parseFloat(document.getElementById('itemAlcance')?.value) || 1;
            novoItem.dano = document.getElementById('itemDano')?.value || '1d';
            novoItem.tipoDano = document.getElementById('itemTipoDano')?.value || 'Corte';
            novoItem.st = parseInt(document.getElementById('itemST')?.value) || 9;
        } else if (tipo === 'arma_dist') {
            novoItem.precisao = parseInt(document.getElementById('itemPrecisao')?.value) || 1;
            novoItem.dano = document.getElementById('itemDano')?.value || '1d';
            novoItem.tipoDano = document.getElementById('itemTipoDano')?.value || 'Perfuração';
            novoItem.alcance = document.getElementById('itemAlcance')?.value || 'STx10';
            novoItem.st = parseInt(document.getElementById('itemST')?.value) || 9;
        } else if (tipo === 'armadura') {
            novoItem.rd = parseInt(document.getElementById('itemRD')?.value) || 2;
            novoItem.local = document.getElementById('itemLocal')?.value || 'completo';
        } else if (tipo === 'escudo') {
            novoItem.bonus = parseInt(document.getElementById('itemBonus')?.value) || 1;
            novoItem.ve = document.getElementById('itemVE')?.value || '5/30';
        } else {
            novoItem.especificacao = document.getElementById('itemEspec')?.value || '';
        }
        
        inventario.deposito.push(novoItem);
        
        renderizarInventario();
        salvarInventario();
        
        modalCriarItem.classList.remove('active');
        itemPersonalizadoNome.value = '';
        itemPersonalizadoPreco.value = '10';
        itemPersonalizadoPeso.value = '1';
        itemPersonalizadoQtd.value = '1';
        
        alert('Item criado e adicionado ao depósito!');
    });

    btnAnterior.addEventListener('click', () => {
        if (abaAtual === 'vantagens') mudarAba('basicos');
        else if (abaAtual === 'desvantagens') mudarAba('vantagens');
        else if (abaAtual === 'pericias') mudarAba('desvantagens');
        else if (abaAtual === 'magias') mudarAba('pericias');
        else if (abaAtual === 'equipamentos') mudarAba('magias');
    });

    btnProximo.addEventListener('click', () => {
        if (abaAtual === 'basicos') {
            const nome = document.getElementById('nomePersonagem')?.value.trim();
            if (!nome) { alert('Digite um nome para o personagem'); return; }
            if (pontosRestantes > 0) { alert(`Você ainda tem ${pontosRestantes} pontos para distribuir`); return; }
            salvarDadosBasicos();
            mudarAba('vantagens');
        } else if (abaAtual === 'vantagens') {
            if (vantagensSelecionadas.size === 0) { alert('Escolha pelo menos 1 vantagem'); return; }
            mudarAba('desvantagens');
        } else if (abaAtual === 'desvantagens') {
            if (desvantagensSelecionadas.size === 0) { alert('Escolha pelo menos 1 desvantagem'); return; }
            mudarAba('pericias');
        }
    });

    btnFinalizar.addEventListener('click', async () => {
        if (vantagensSelecionadas.size === 0) { alert('Escolha pelo menos 1 vantagem'); return; }
        if (desvantagensSelecionadas.size === 0) { alert('Escolha pelo menos 1 desvantagem'); return; }
        if (desvantagensSelecionadas.size < 4) { alert(`Você precisa escolher 4 desvantagens (faltam ${4 - desvantagensSelecionadas.size})`); return; }

        try {
            showLoading();
            const user = auth.currentUser;
            if (!user) { window.location.href = 'index.html'; return; }
            
            const personagemRef = doc(collection(db, "personagens"));
            const personagemId = personagemRef.id;

            let reacaoBase = 0;
            if (vantagensSelecionadas.has('atraente')) reacaoBase += 2;
            if (desvantagensSelecionadas.has('feio')) reacaoBase -= 2;

            const vida = atributos.ht.base + (atributos.ht.bolinhas * 6);
            const fadiga = 8 + atributos.ht.bolinhas;
            const mana = fadiga + atributos.iq.valor;

            const personagemData = {
                id: personagemId,
                userId: user.uid,
                nome: personagemTemp?.nome || '',
                classe: personagemTemp?.classe || 'guerreiro',
                fotoURL: personagemTemp?.fotoURL || '',
                aparencia: personagemTemp?.aparencia || 'normal',
                riqueza: personagemTemp?.riqueza || 'medio',
                peculiaridades: personagemTemp?.peculiaridades || '',
                vantagens: Array.from(vantagensSelecionadas),
                desvantagens: Array.from(desvantagensSelecionadas),
                fobia: fobiaSelecionada,
                pericias: pericias,
                escolas: escolas,
                esferasDesbloqueadas: esferasDesbloqueadas,
                pmDisponivel: pmDisponivel,
                pmGasto: pmGastoTotal,
                inventario: inventario,
                dinheiro: dinheiro,
                pontos: { xp: 0, xpTotal: 0, pm: 0, dinheiro: dinheiro },
                atributos: {
                    st: atributos.st,
                    dx: atributos.dx,
                    iq: atributos.iq,
                    ht: { ...atributos.ht, valor: vida }
                },
                status: {
                    vidaAtual: vida, vidaMax: vida,
                    fadigaAtual: fadiga, fadigaMax: fadiga,
                    manaAtual: mana, manaMax: mana
                },
                derivados: {
                    danoBase: tabelaDano[atributos.st.valor] || "1d-1",
                    esquiva: Math.floor(atributos.dx.valor / 2) + 3,
                    vontade: atributos.iq.valor,
                    percepcao: atributos.iq.valor,
                    deslocamento: (vida / 10).toFixed(1)
                },
                reacao: { base: reacaoBase, total: reacaoBase },
                createdAt: new Date(),
                updatedAt: new Date()
            };

            await setDoc(personagemRef, personagemData);
            sessionStorage.removeItem('personagemTemp');
            window.location.href = `aventura-solo.html?personagemId=${personagemId}`;
        } catch (error) {
            alert('Erro ao criar personagem. Tente novamente.');
            hideLoading();
        }
    });
});

onAuthStateChanged(auth, async (user) => {
    if (user) {
        const docRef = doc(db, "usuarios", user.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const userData = docSnap.data();
            if (displayIdPc) displayIdPc.textContent = userData.id_pc || '--------';
            if (displayNickname) displayNickname.textContent = userData.nickname || 'Aventureiro';
        }
    } else window.location.href = 'index.html';
});

btnSair.addEventListener('click', async () => {
    try { showLoading(); await signOut(auth); window.location.href = 'index.html'; } 
    catch (error) { hideLoading(); }
});

atualizarContadoresAbas();
</script>
</body>
</html>