<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Personagem - RPGForce (Sistema %) </title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- PDF.js para exportação -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
   <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #2a1a3a 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        /* Fundo mágico animado */
        .magic-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
        }
        
        .magic-bg::before {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
        }
        
        .magic-bg::after {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            background: radial-gradient(circle at 80% 80%, rgba(198, 40, 40, 0.1) 0%, transparent 50%);
            animation: pulse 10s ease-in-out infinite reverse;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        /* Container principal */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Navbar */
        .navbar {
            background: rgba(10, 10, 26, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 15px 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo-area h2 {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.3rem;
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .user-id {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 30px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .user-id i { color: #ffd700; }
        
        .user-id .value {
            color: #ffd700;
            font-family: monospace;
            font-weight: 600;
        }
        
        .user-nick {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 215, 0, 0.1);
            padding: 6px 15px;
            border-radius: 30px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .user-nick i { color: #ffd700; }
        
        /* Botões de ação */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        
        .btn-excluir {
            background: transparent;
            border: 2px solid rgba(255, 0, 0, 0.5);
            color: #ff6b6b;
            padding: 6px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-excluir:hover {
            background: #ff6b6b;
            color: #0a0a1a;
            border-color: #ff6b6b;
        }
        
        .btn-pdf {
            background: transparent;
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: #ffd700;
            padding: 6px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-pdf:hover {
            background: #ffd700;
            color: #0a0a1a;
            border-color: #ffd700;
        }
        
        .btn-salvar {
            background: linear-gradient(45deg, #4a6da8, #2a4a8a);
            border: none;
            color: white;
            padding: 6px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-salvar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 109, 168, 0.4);
        }
        
        .btn-sair {
            background: transparent;
            border: 2px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 6px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-sair:hover {
            background: #ff6b6b;
            color: #0a0a1a;
            border-color: #ff6b6b;
        }
        
        /* Indicador de auto-save */
        .auto-save-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: rgba(255,215,0,0.7);
            margin-left: 10px;
        }
        
        .auto-save-indicator i { font-size: 0.7rem; }
        
        .auto-save-indicator.saving {
            color: #ffd700;
            animation: pulse 1s infinite;
        }
        
        .auto-save-indicator.saved { color: #4CAF50; }
        
        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            flex-wrap: wrap;
        }
        
        .breadcrumb a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
        }
        
        .breadcrumb a:hover { color: #ffd700; }
        
        .breadcrumb i {
            font-size: 0.7rem;
            color: rgba(255, 215, 0, 0.5);
        }
        
        .breadcrumb .current { color: #ffd700; }
        
        /* Page header */
        .page-header h1 {
            font-family: 'MedievalSharp', cursive;
            font-size: 2rem;
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Abas principais */
        .abas-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: rgba(10, 10, 26, 0.6);
            padding: 10px;
            border-radius: 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .aba {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: rgba(255, 255, 255, 0.7);
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            flex: 1;
            justify-content: center;
            min-width: 120px;
        }
        
        .aba:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
            color: #ffd700;
        }
        
        .aba.ativa {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            border-color: #ffd700;
            color: #0a0a1a;
            font-weight: 600;
        }
        
        .aba .contador {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .aba.ativa .contador {
            background: rgba(0, 0, 0, 0.2);
            color: #0a0a1a;
        }
        
        .conteudo-aba { display: none; }
        .conteudo-aba.ativa { display: block; }
        
        /* Subabas */
        .subabas-container {
            display: flex;
            gap: 5px;
            margin: 15px 0;
            flex-wrap: wrap;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 15px;
        }
        
        .subaba {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 15px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            flex: 1;
            justify-content: center;
        }
        
        .subaba:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
            color: #ffd700;
        }
        
        .subaba.ativa {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            color: #ffd700;
        }
        
        .subaba img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }
        
        .subaba:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* Cards */
        .card {
            background: rgba(10, 10, 26, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 30px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .card-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }
        
        .card-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .card-section h2 {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Formulários */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 12px 15px;
            color: #fff;
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: rgba(255, 215, 0, 0.5);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-group small {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            margin-top: 5px;
            display: block;
        }
        
        /* Upload de foto */
        .upload-area {
            background: rgba(0, 0, 0, 0.2);
            border: 2px dashed rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .upload-area:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.05);
        }
        
        .upload-area i {
            font-size: 2rem;
            color: #ffd700;
            margin-bottom: 10px;
            display: block;
        }
        
        .preview-area {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            margin: 10px 0;
            border: 3px solid #ffd700;
        }
        
        .preview-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .btn-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .btn-remove:hover {
            background: #ff0000;
            transform: scale(1.1);
        }
        
        /* ===== ATRIBUTOS DUPLA FACE ===== */
        .atributo-dual {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
            margin-top: 5px;
            font-size: 0.85rem;
        }
        
        .valor-fixo {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .valor-percentual {
            color: #ffd700;
            font-weight: bold;
        }
        
        .atributo-desc {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            margin-left: 5px;
        }
        
        /* Atributos */
        .pontos-restantes {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: bold;
        }
        
        .pontos-restantes .valor {
            font-size: 1.5rem;
            font-family: 'MedievalSharp', cursive;
        }
        
        .atributo-row {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .atributo-row:hover {
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid #ffd700;
        }
        
        .atributo-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .atributo-nome {
            font-weight: 600;
            color: #fff;
        }
        
        .atributo-valor {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffd700;
        }
        
        .bolinhas-container {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .bolinha {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bolinha.preenchida {
            background: #ffd700;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        .bolinha:hover {
            transform: scale(1.1);
            border-color: #ffd700;
        }
        
        .atributo-detalhes {
            display: flex;
            gap: 15px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            flex-wrap: wrap;
        }
        
        /* Status grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .status-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .status-item:hover {
            background: rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }
        
        .status-item .label {
            display: block;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        
        .status-item .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffd700;
        }
        
        /* Vantagens e Desvantagens */
        .vantagens-grid, .desvantagens-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .vantagem-card, .desvantagem-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .vantagem-card:hover, .desvantagem-card:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
            transform: translateY(-2px);
        }
        
        .vantagem-card.selecionada {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .desvantagem-card.selecionada {
            background: rgba(255, 0, 0, 0.2);
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }
        
        .vantagem-card h3, .desvantagem-card h3 {
            font-size: 1rem;
            color: #ffd700;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .vantagem-card p, .desvantagem-card p {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }
        
        .vantagem-card .resumo, .desvantagem-card .resumo {
            font-size: 0.7rem;
            color: rgba(255, 215, 0, 0.8);
            font-style: italic;
        }
        
        .vantagem-card .check { display: none; color: #ffd700; font-size: 1.2rem; }
        .vantagem-card.selecionada .check { display: inline; }
        
        .badge-fobia {
            background: rgba(255, 0, 0, 0.3);
            color: #ff6b6b;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-top: 5px;
            display: inline-block;
        }
        
        /* Contadores */
        .contador {
            background: rgba(255, 215, 0, 0.1);
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .contador span { color: #ffd700; font-weight: bold; }
        .contador.desvantagens { background: rgba(255, 0, 0, 0.1); }
        .contador.desvantagens span { color: #ff6b6b; }
        
        /* ===== MODAIS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: #1a1a3a;
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content h3 {
            color: #ffd700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-confirm {
            background: #1a1a3a;
            border: 2px solid #ff6b6b;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .modal-confirm h3 {
            color: #ff6b6b;
            margin-bottom: 15px;
            font-family: 'MedievalSharp', cursive;
        }
        
        .modal-confirm p {
            color: rgba(255,255,255,0.8);
            margin-bottom: 20px;
        }
        
        .modal-confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn-confirm-excluir {
            background: #ff6b6b;
            border: none;
            color: #0a0a1a;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-confirm-excluir:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .btn-cancel-excluir {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-cancel-excluir:hover {
            border-color: #ffd700;
            color: #ffd700;
        }
        
        .modal-close {
            background: transparent;
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: #ff6b6b;
            color: #0a0a1a;
        }
        
        /* Fobia items */
        .fobia-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .fobia-item:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }
        
        .fobia-item h4 { color: #ffd700; margin-bottom: 5px; }
        .fobia-item p {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* PM/PP Header */
        .pm-header {
            background: linear-gradient(45deg, #4a2a6a, #2a1a4a);
            border: 1px solid #ffd700;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .pm-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 30px;
        }
        
        .pm-input-group label {
            color: #ffd700;
            font-weight: bold;
        }
        
        .pm-input-group input {
            background: transparent;
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 5px 10px;
            border-radius: 10px;
            width: 70px;
            text-align: center;
            font-weight: bold;
        }
        
        .pm-stats {
            display: flex;
            gap: 20px;
            font-size: 1.1rem;
        }
        
        .pm-stats span {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        /* Perícias */
        .pericias-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            min-height: 500px;
        }
        
        .catalogo-pericias {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .filtros-pericias {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filtro-pericia {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .filtro-pericia.ativo {
            background: #ffd700;
            color: #0a0a1a;
            border-color: #ffd700;
        }
        
        .filtro-pericia:hover { background: rgba(255, 215, 0, 0.2); }
        
        .lista-pericias {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .pericia-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pericia-card:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
            transform: translateX(5px);
        }
        
        .pericia-card h4 {
            color: #ffd700;
            font-size: 1rem;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .pericia-card .tipo {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .pericia-card .tipo.mental { background: #4a6da8; }
        .pericia-card .tipo.fisica { background: #8b4a6d; }
        
        .pericia-card .descricao {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
        }
        
        .pericia-card .atributo {
            font-size: 0.7rem;
            color: #ffd700;
        }
        
        .pericias-adquiridas {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .pericias-adquiridas h3 {
            color: #ffd700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .lista-adquiridas {
            max-height: 550px;
            overflow-y: auto;
        }
        
        .pericia-adquirida {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pericia-adquirida-info h4 {
            color: #ffd700;
            font-size: 1rem;
        }
        
        .pericia-adquirida-info .nivel {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .pericia-adquirida-info .bonus {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .pericia-adquirida-info .nh {
            font-size: 0.9rem;
            color: #4CAF50;
            font-weight: bold;
            margin-top: 2px;
        }
        
        .pericia-adquirida-info .nh span {
            color: #ffd700;
            font-size: 1rem;
            margin-left: 5px;
        }
        
        .pericia-adquirida-acoes {
            display: flex;
            gap: 8px;
        }
        
        .btn-pericia {
            background: transparent;
            border: 1px solid #ffd700;
            color: #ffd700;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-pericia:hover {
            background: #ffd700;
            color: #0a0a1a;
        }
        
        .btn-pericia:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Tabela de níveis */
        .tabela-niveis {
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .tabela-niveis table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .tabela-niveis th {
            background: #ffd700;
            color: #0a0a1a;
            padding: 8px;
            font-size: 0.9rem;
        }
        
        .tabela-niveis td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .tabela-niveis tr:last-child td { border-bottom: none; }
        
        /* Seletor de nível */
        .seletor-nivel {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .seletor-nivel button {
            background: transparent;
            border: 2px solid #ffd700;
            color: #ffd700;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .seletor-nivel button:hover:not(:disabled) {
            background: #ffd700;
            color: #0a0a1a;
        }
        
        .seletor-nivel button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .seletor-nivel span {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
            min-width: 60px;
            text-align: center;
        }
        
        /* Custo info */
        .custo-info {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .custo-info .custo {
            font-size: 2rem;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* Botões */
        .btn-confirmar {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
            border: none;
            padding: 12px;
            border-radius: 30px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-confirmar:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.4);
        }
        
        .btn-confirmar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary, .btn-secondary {
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: transparent;
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: #ffd700;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }
        
        /* Card actions */
        .card-actions {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 10, 26, 0.9);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading-overlay.active { display: flex; }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 215, 0, 0.2);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: #ffd700;
            font-size: 1.2rem;
            font-family: 'MedievalSharp', cursive;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Resumo personagem */
        .resumo-personagem {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .resumo-personagem .foto {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffd700;
            font-size: 1.5rem;
            overflow: hidden;
            border: 2px solid #ffd700;
        }
        
        .resumo-personagem .foto img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .resumo-personagem .info h3 {
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .resumo-personagem .info p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
        
        /* Combate */
        .combate-header {
            background: linear-gradient(45deg, #6a2a2a, #3a1a1a);
            border: 1px solid #ff6b6b;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .combate-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .combate-stat-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        .combate-stat-card .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        
        .combate-stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b6b;
            font-family: 'MedievalSharp', cursive;
        }
        
        .defesas-ativas {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .defesas-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .defesa-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .defesa-card .defesa-nome {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .defesa-card .defesa-valor {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            font-family: 'MedievalSharp', cursive;
            margin-bottom: 5px;
        }
        
        .defesa-card .defesa-detalhe {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* Defesas em % */
        .defesa-percentual {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffd700;
        }
        
        .defesa-percentual::after {
            content: '%';
            font-size: 1.2rem;
            color: rgba(255,255,255,0.5);
            margin-left: 2px;
        }
        
        .rd-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .rd-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .rd-item .rd-tipo {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }
        
        .rd-item .rd-valor {
            font-size: 1.3rem;
            color: #ffd700;
            font-weight: bold;
        }
        
        .arma-equipada {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #ffd700;
        }
        
        .arma-equipada h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .arma-detalhes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        
        .arma-detalhe-item {
            text-align: center;
        }
        
        .arma-detalhe-item .label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .arma-detalhe-item .valor {
            font-size: 1.1rem;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* Deslocamento */
        .deslocamento-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }
        
        .deslocamento-item {
            text-align: center;
        }
        
        .deslocamento-item .tipo {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 5px;
        }
        
        .deslocamento-item .valor {
            font-size: 2rem;
            color: #ffd700;
            font-weight: bold;
        }
        
        .deslocamento-item .valor::after {
            content: 'm';
            font-size: 1rem;
            color: rgba(255,255,255,0.5);
            margin-left: 2px;
        }
        
        .escudo-pv {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }
        
        .escudo-pv-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .escudo-pv-barra {
            height: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .escudo-pv-preenchimento {
            height: 100%;
            background: #ffd700;
            width: 100%;
        }
        
        .thresholds {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .threshold-item {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            min-width: 150px;
        }
        
        .threshold-item.atordoamento { border-left: 3px solid #ffa500; }
        .threshold-item.morte { border-left: 3px solid #ff0000; }
        
        .threshold-item .threshold-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
        
        .threshold-item .threshold-valor {
            font-size: 1.5rem;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* Magias */
        .magia-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #0a2a3a, #1a4a6a);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid #4a9fff;
        }
        
        .simbolo-agua {
            width: 50px;
            height: 50px;
            background-image: url('agua1.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .info-escola {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .info-escola-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
        }
        
        .info-escola-item .label {
            color: #4a9fff;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        
        .info-escola-item .valor {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
        }
        
        /* Magia NH */
        .magia-nh-container {
            background: linear-gradient(45deg, #1a3a4a, #0a2a3a);
            border: 2px solid #4a9fff;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .magia-nh-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4a9fff;
            border-radius: 15px;
            padding: 10px 20px;
            text-align: center;
            min-width: 120px;
        }
        
        .magia-nh-label {
            font-size: 0.8rem;
            color: #4a9fff;
            margin-bottom: 5px;
        }
        
        .magia-nh-valor {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffd700;
            font-family: 'MedievalSharp', cursive;
        }
        
        .magia-nh-detalhe {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 3px;
        }
        
        .esferas-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .esfera-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(74, 159, 255, 0.3);
            border-radius: 15px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }
        
        .esfera-card.desbloqueada {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .esfera-card.disponivel {
            border-color: #4a9fff;
            background: rgba(74, 159, 255, 0.1);
            cursor: pointer;
        }
        
        .esfera-card.disponivel:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            transform: translateY(-5px);
        }
        
        .esfera-card.trancada {
            opacity: 0.5;
            filter: grayscale(0.8);
            cursor: not-allowed;
        }
        
        .esfera-card.aptidao-requerida {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            cursor: not-allowed;
            position: relative;
        }
        
        .esfera-card.aptidao-requerida::after {
            content: "Requer Aptidão Mágica";
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff6b6b;
            color: #0a0a1a;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            white-space: nowrap;
            z-index: 10;
        }
        
        .numero-esfera {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            background: #ffd700;
            color: #0a0a1a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .icone-esfera {
            font-size: 2rem;
            margin: 10px 0;
            color: #4a9fff;
        }
        
        .esfera-card.desbloqueada .icone-esfera { color: #ffd700; }
        .esfera-card.disponivel .icone-esfera { color: #4a9fff; }
        
        .nome-esfera {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .tipo-esfera {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .nivel-esfera {
            margin-top: 8px;
            font-size: 0.8rem;
            color: #ffd700;
        }
        
        .btn-comprar-esfera {
            background: #4a9fff;
            border: none;
            color: #0a0a1a;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
            transition: all 0.3s;
        }
        
        .btn-comprar-esfera:hover {
            background: #ffd700;
            transform: scale(1.05);
        }
        
        .btn-detalhe {
            background: transparent;
            border: 1px solid #ffd700;
            color: #ffd700;
            border-radius: 15px;
            padding: 2px 8px;
            margin-left: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-detalhe:hover {
            background: #ffd700;
            color: #0a0a1a;
        }
        
        /* Detalhe magia modal */
        .detalhe-magia-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .detalhe-magia-modal.active { display: flex; }
        
        .detalhe-magia-content {
            background: #1a1a3a;
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .tabela-detalhe {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .tabela-detalhe th {
            background: #ffd700;
            color: #0a0a1a;
            padding: 8px;
        }
        
        .tabela-detalhe td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .tabela-detalhe tr.nivel-atual {
            background: rgba(255, 215, 0, 0.3);
            font-weight: bold;
        }
        
        .tabela-detalhe tr.nivel-atual td {
            color: #ffd700;
            border-bottom: 2px solid #ffd700;
        }
        
        .btn-comprar-nivel {
            background: linear-gradient(45deg, #4a9fff, #2a6fb0);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 10px;
            width: 100%;
            margin: 10px 0;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-comprar-nivel:hover:not(:disabled) {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
        }
        
        .btn-comprar-nivel:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Equipamentos */
        .dinheiro-header {
            background: linear-gradient(45deg, #2a6a4a, #1a4a3a);
            border: 1px solid #ffd700;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .dinheiro-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2rem;
        }
        
        .dinheiro-info i {
            color: #ffd700;
            font-size: 1.5rem;
        }
        
        .dinheiro-info .valor {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .carga-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .carga-barra {
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }
        
        .carga-preenchimento {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #ffd700, #ff6b6b);
            width: 0%;
            transition: width 0.3s;
        }
        
        .carga-marcadores {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .carga-nivel {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .carga-nivel.leve { background: rgba(76, 175, 80, 0.3); color: #4CAF50; }
        .carga-nivel.medio { background: rgba(255, 193, 7, 0.3); color: #ffc107; }
        .carga-nivel.pesado { background: rgba(255, 87, 34, 0.3); color: #ff5722; }
        .carga-nivel.limite { background: rgba(244, 67, 54, 0.3); color: #f44336; }
        
        .inventario-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .inventario-coluna {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .inventario-coluna h3 {
            color: #ffd700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .inventario-itens {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .item-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .item-card:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }
        
        .item-card .item-nome {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .item-card .item-detalhes {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: space-between;
        }
        
        .item-card .item-peso { color: #4CAF50; }
        .item-card .item-preco { color: #ffd700; }
        
        .item-acoes {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
            gap: 5px;
        }
        
        .item-card:hover .item-acoes { display: flex; }
        
        .item-acao {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #ffd700;
            color: #ffd700;
            width: 25px;
            height: 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .item-acao:hover {
            background: #ffd700;
            color: #0a0a1a;
        }
        
        .btn-criar-item {
            background: linear-gradient(45deg, #4a2a6a, #2a1a4a);
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 12px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .btn-criar-item:hover {
            background: #ffd700;
            color: #0a0a1a;
        }
        
        .catalogo-itens {
            margin-top: 30px;
        }
        
        .catalogo-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .catalogo-tab {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .catalogo-tab.ativo {
            background: #ffd700;
            color: #0a0a1a;
            border-color: #ffd700;
        }
        
        .catalogo-tab:hover {
            background: rgba(255, 215, 0, 0.2);
        }
        
        .tabelas-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .tabela-item { display: none; }
        .tabela-item.ativa { display: block; }
        
        .tabela-catalogo {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            font-size: 0.9rem;
        }
        
        .tabela-catalogo th {
            background: #ffd700;
            color: #0a0a1a;
            padding: 12px 8px;
            font-weight: 600;
            text-align: left;
        }
        
        .tabela-catalogo td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .tabela-catalogo tr:hover td {
            background: rgba(255, 215, 0, 0.1);
        }
        
        .btn-comprar-tabela {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .btn-comprar-tabela:hover {
            background: #ffd700;
            color: #0a0a1a;
            transform: scale(1.05);
        }
        
        /* Campos dinâmicos */
        .campo-dinamico {
            margin-bottom: 15px;
        }
        
        .campo-dinamico label {
            display: block;
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .campo-dinamico input, .campo-dinamico select {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #ffd700;
            border-radius: 10px;
            color: #fff;
        }
        
        .destaque-campo {
            background: rgba(255, 215, 0, 0.05);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            border-left: 3px solid #ffd700;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .card { padding: 20px; }
            .form-row { grid-template-columns: 1fr; }
            .status-grid { grid-template-columns: repeat(2, 1fr); }
            .vantagens-grid, .desvantagens-grid { grid-template-columns: repeat(2, 1fr); }
            .aba { min-width: auto; padding: 10px; font-size: 0.8rem; }
            .pericias-container { grid-template-columns: 1fr; }
            .inventario-grid { grid-template-columns: 1fr; }
            .defesas-grid { grid-template-columns: 1fr; }
            .combate-stats-grid { grid-template-columns: repeat(2, 1fr); }
            .esferas-grid { grid-template-columns: repeat(3, 1fr); }
            .tabela-catalogo { font-size: 0.8rem; }
            .tabela-catalogo th, .tabela-catalogo td { padding: 8px 4px; }
            .btn-comprar-tabela { padding: 3px 6px; font-size: 0.7rem; }
            .tabelas-container { overflow-x: auto; }
            .tabela-catalogo { min-width: 600px; }
        }
    </style>
</head>
<body>
    <div class="magic-bg"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando...</div>
    </div>

    <!-- Modal de fobias -->
    <div class="modal" id="modalFobias">
        <div class="modal-content">
            <h3><i class="fas fa-spider"></i> Escolha uma Fobia</h3>
            <div class="fobia-item" data-fobia="acrofobia"><h4>Acrofobia</h4><p>Medo de alturas. -10% em testes perto de alturas.</p></div>
            <div class="fobia-item" data-fobia="agorafobia"><h4>Agorafobia</h4><p>Medo de espaços abertos. -10% em testes em áreas abertas.</p></div>
            <div class="fobia-item" data-fobia="aracnofobia"><h4>Aracnofobia</h4><p>Medo de aranhas. -15% contra aranhas.</p></div>
            <div class="fobia-item" data-fobia="claustrofobia"><h4>Claustrofobia</h4><p>Medo de espaços fechados. -10% em lugares pequenos.</p></div>
            <div class="fobia-item" data-fobia="hematofobia"><h4>Hematofobia</h4><p>Medo de sangue. -10% ao ver sangue.</p></div>
            <div class="fobia-item" data-fobia="manafobia"><h4>Manafobia</h4><p>Medo de magia. Não aprende magias.</p></div>
            <div class="fobia-item" data-fobia="necrofobia"><h4>Necrofobia</h4><p>Medo da morte. -15% perto de cadáveres.</p></div>
            <div class="fobia-item" data-fobia="nictofobia"><h4>Nictofobia</h4><p>Medo do escuro. -10% no escuro.</p></div>
            <div class="fobia-item" data-fobia="pirofobia"><h4>Pirofobia</h4><p>Medo de fogo. -15% perto de fogo.</p></div>
            <div class="fobia-item" data-fobia="xenofobia"><h4>Xenofobia</h4><p>Medo do desconhecido. -10% com não-humanos.</p></div>
            <button class="modal-close" id="fecharModalFobias"><i class="fas fa-times"></i> Fechar</button>
        </div>
    </div>

    <!-- Modal de perícia -->
    <div class="modal" id="modalPericia">
        <div class="modal-content">
            <h3><i class="fas fa-brain"></i> <span id="modalPericiaNome">Espada</span></h3>
            <div class="tabela-niveis">
                <table>
                    <thead><tr><th>Nível</th><th>Bônus</th><th>Custo PP</th></tr></thead>
                    <tbody>
                        <tr><td>1 - Amador</td><td>+4%</td><td>5 PP</td></tr>
                        <tr><td>2 - Aprendiz</td><td>+8%</td><td>10 PP</td></tr>
                        <tr><td>3 - Profissional</td><td>+12%</td><td>15 PP</td></tr>
                        <tr><td>4 - Veterano</td><td>+16%</td><td>20 PP</td></tr>
                        <tr><td>5 - Mestre</td><td>+20%</td><td>25 PP</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="seletor-nivel">
                <button id="modalPericiaMenos" disabled>-</button>
                <span id="modalPericiaNivel">1</span>
                <button id="modalPericiaMais">+</button>
            </div>
            <div class="custo-info">
                <div style="font-size: 0.9rem; margin-bottom: 5px;">Custo desta operação:</div>
                <div class="custo" id="modalPericiaCusto">5 PP</div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-secondary" id="modalPericiaCancelar" style="flex: 1;">Cancelar</button>
                <button class="btn-primary" id="modalPericiaConfirmar" style="flex: 2;">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de detalhe de magia -->
    <div class="detalhe-magia-modal" id="detalheMagiaModal">
        <div class="detalhe-magia-content">
            <h3 id="detalheMagiaTitulo" style="color: #ffd700;">Localizar Água</h3>
            <div class="magia-nh-container">
                <div class="magia-nh-item">
                    <div class="magia-nh-label">NH da Magia</div>
                    <div class="magia-nh-valor" id="detalheMagiaNH">46%</div>
                    <div class="magia-nh-detalhe">IQ% + 10% + Nível</div>
                </div>
            </div>
            <table class="tabela-detalhe" id="tabelaDetalheMagia">
                <thead><tr><th>Nível</th><th>Efeito</th><th>NH</th></tr></thead>
                <tbody id="corpoTabelaDetalhe"></tbody>
            </table>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" id="fecharDetalheMagia" style="flex: 1;">Fechar</button>
                <button class="btn-comprar-nivel" id="comprarNivelMagia" style="flex: 2;">Comprar Nível (2 PP)</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmação de exclusão -->
    <div class="modal" id="modalConfirmarExclusao">
        <div class="modal-confirm">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão</h3>
            <p>Tem certeza que deseja excluir este personagem?</p>
            <div class="modal-confirm-actions">
                <button class="btn-cancel-excluir" id="cancelarExclusao">Cancelar</button>
                <button class="btn-confirm-excluir" id="confirmarExclusao">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal de sucesso ao salvar -->
    <div class="modal" id="modalSalvarSucesso" style="display: none;">
        <div class="modal-content" style="text-align: center; background: #1a3a1a; border-color: #4CAF50;">
            <h3 style="color: #4CAF50;"><i class="fas fa-check-circle"></i> Personagem Salvo!</h3>
            <button class="btn-primary" id="fecharModalSalvar" style="background: #4CAF50;">OK</button>
        </div>
    </div>

    <!-- CONTAINER PRINCIPAL -->
    <div class="container">
        <nav class="navbar">
            <div class="logo-area"><h2>RPGForce</h2></div>
            <div class="user-info">
                <div class="user-id"><i class="fas fa-id-card"></i><span class="value" id="displayIdPc">--------</span></div>
                <div class="user-nick"><i class="fas fa-user"></i><span id="displayNickname">Aventureiro</span></div>
                
                <div class="action-buttons">
                    <button class="btn-salvar" id="btnSalvarPersonagem" title="Salvar personagem">
                        <i class="fas fa-save"></i><span>Salvar</span>
                    </button>
                    <button class="btn-pdf" id="btnExportarPDF" title="Exportar para PDF">
                        <i class="fas fa-file-pdf"></i><span>PDF</span>
                    </button>
                    <button class="btn-excluir" id="btnExcluirPersonagem" title="Excluir personagem">
                        <i class="fas fa-trash"></i><span>Excluir</span>
                    </button>
                </div>
                
                <div class="auto-save-indicator" id="autoSaveIndicator">
                    <i class="fas fa-circle"></i><span>Salvo</span>
                </div>
                
                <button class="btn-sair" id="btnSair"><i class="fas fa-sign-out-alt"></i><span>Sair</span></button>
            </div>
        </nav>

        <div class="breadcrumb">
            <a href="dashboard-pc.html"><i class="fas fa-home"></i> Dashboard</a>
            <i class="fas fa-chevron-right"></i>
            <a href="personagens.html">Personagens</a>
            <i class="fas fa-chevron-right"></i>
            <span class="current" id="breadcrumbCurrent">Criar Personagem</span>
        </div>

        <div class="page-header">
            <h1><i class="fas fa-dragon"></i> <span id="pageTitle">Criar Novo Personagem</span></h1>
        </div>

        <div class="abas-container">
            <button class="aba ativa" data-aba="basicos"><i class="fas fa-user"></i> Dados Básicos</button>
            <button class="aba" data-aba="combate"><i class="fas fa-shield-alt"></i> Combate</button>
            <button class="aba" data-aba="vantagens"><i class="fas fa-star"></i> Vantagens <span class="contador" id="contadorVantagensAba">0/3</span></button>
            <button class="aba" data-aba="desvantagens"><i class="fas fa-skull"></i> Desvantagens <span class="contador" id="contadorDesvantagensAba">0/4</span></button>
            <button class="aba" data-aba="pericias"><i class="fas fa-brain"></i> Perícias <span class="contador" id="contadorPericiasAba">0 PP</span></button>
            <button class="aba" data-aba="magias"><i class="fas fa-magic"></i> Magias <span class="contador" id="contadorMagiasAba">0/10</span></button>
            <button class="aba" data-aba="equipamentos"><i class="fas fa-backpack"></i> Equipamentos</button>
        </div>

        <!-- ABA DADOS BÁSICOS -->
        <div id="abaBasicos" class="conteudo-aba ativa">
            <div class="card">
                <div class="card-section">
                    <h2><i class="fas fa-user"></i> Dados Básicos</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomePersonagem">Nome do Personagem</label>
                            <input type="text" id="nomePersonagem" placeholder="Ex: Aric, o Caçador" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="classePersonagem">Classe</label>
                            <select id="classePersonagem">
                                <option value="guerreiro">Guerreiro</option>
                                <option value="mago">Mago</option>
                                <option value="ladino">Ladino</option>
                                <option value="clerigo">Clérigo</option>
                                <option value="barbaro">Bárbaro</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="idadePersonagem">Idade</label>
                            <input type="number" id="idadePersonagem" min="1" max="999" value="25">
                        </div>
                        <div class="form-group">
                            <label for="alturaPersonagem">Altura (cm)</label>
                            <input type="number" id="alturaPersonagem" min="50" max="300" value="170">
                        </div>
                        <div class="form-group">
                            <label for="pesoPersonagem">Peso (kg)</label>
                            <input type="number" id="pesoPersonagem" min="20" max="500" value="70" step="0.1">
                        </div>
                    </div>
                    
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-camera"></i>
                        <span>Clique para adicionar foto (opcional)</span>
                        <input type="file" id="fotoInput" accept="image/*" style="display: none;">
                    </div>
                    <div class="preview-area" id="previewArea" style="display: none;">
                        <img id="previewImage" src="" alt="Preview">
                        <button type="button" id="removeFoto" class="btn-remove"><i class="fas fa-times"></i></button>
                    </div>
                </div>

                <div class="card-section">
                    <h2><i class="fas fa-user-circle"></i> Aparência e Economia</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="aparencia">Aparência</label>
                            <select id="aparencia">
                                <option value="feio">Feio (-5% reações)</option>
                                <option value="normal" selected>Normal</option>
                                <option value="atraente">Atraente (+5% reações)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="riqueza">Riqueza Inicial</label>
                            <select id="riqueza">
                                <option value="pobre">Pobre (metade)</option>
                                <option value="medio" selected>Médio (base)</option>
                                <option value="rico">Rico (5x)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="dinheiroBase">Valor Base ($)</label>
                        <input type="number" id="dinheiroBase" min="0" value="1000" step="100">
                    </div>

                    <div class="form-group">
                        <label for="peculiaridades">Peculiaridades</label>
                        <textarea id="peculiaridades" placeholder="Ex: Fala sozinho quando nervoso..."></textarea>
                    </div>
                    
                    <input type="hidden" id="personagemId" value="">
                </div>

                <div class="card-section">
                    <h2><i class="fas fa-chart-bar"></i> Atributos</h2>
                    
                    <div class="form-group" style="margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px;">
                        <label for="esferasIniciais" style="color: #ffd700; font-weight: bold;">
                            <i class="fas fa-dice-d20"></i> Esferas Iniciais (definido pelo GM)
                        </label>
                        <input type="number" id="esferasIniciais" min="0" max="60" value="6" step="1">
                    </div>
                    
                    <div class="pontos-restantes">
                        <span>Esferas para distribuir:</span>
                        <span class="valor" id="esferasRestantes">6</span>
                    </div>
                    
                    <!-- ST -->
                    <div class="atributo-row" data-atributo="st">
                        <div class="atributo-info">
                            <span class="atributo-nome">ST (Força)</span>
                            <span class="atributo-valor" id="stValor">5</span>
                        </div>
                        <div class="atributo-dual">
                            <span><span class="valor-fixo" id="stFixo">5</span> <span class="atributo-desc">fixo</span></span>
                            <span><span class="valor-percentual" id="stPercentual">30%</span> <span class="atributo-desc">testes</span></span>
                        </div>
                        <div class="bolinhas-container" id="stBolinhas"></div>
                        <div class="atributo-detalhes">
                            <span class="dano" id="stDano">1d-3</span>
                        </div>
                    </div>

                    <!-- DX -->
                    <div class="atributo-row" data-atributo="dx">
                        <div class="atributo-info">
                            <span class="atributo-nome">DX (Destreza)</span>
                            <span class="atributo-valor" id="dxValor">5</span>
                        </div>
                        <div class="atributo-dual">
                            <span><span class="valor-fixo" id="dxFixo">5</span> <span class="atributo-desc">fixo</span></span>
                            <span><span class="valor-percentual" id="dxPercentual">30%</span> <span class="atributo-desc">testes</span></span>
                        </div>
                        <div class="bolinhas-container" id="dxBolinhas"></div>
                    </div>

                    <!-- IQ -->
                    <div class="atributo-row" data-atributo="iq">
                        <div class="atributo-info">
                            <span class="atributo-nome">IQ (Inteligência)</span>
                            <span class="atributo-valor" id="iqValor">5</span>
                        </div>
                        <div class="atributo-dual">
                            <span><span class="valor-fixo" id="iqFixo">5</span> <span class="atributo-desc">fixo</span></span>
                            <span><span class="valor-percentual" id="iqPercentual">30%</span> <span class="atributo-desc">testes</span></span>
                        </div>
                        <div class="bolinhas-container" id="iqBolinhas"></div>
                    </div>

                    <!-- VIGOR -->
                    <div class="atributo-row" data-atributo="vigor">
                        <div class="atributo-info">
                            <span class="atributo-nome">VIGOR</span>
                            <span class="atributo-valor" id="vigorValor">5</span>
                        </div>
                        <div class="atributo-dual">
                            <span><span class="valor-fixo" id="vigorFixo">5</span> <span class="atributo-desc">fixo</span></span>
                            <span><span class="valor-percentual" id="vigorPercentual">30%</span> <span class="atributo-desc">resistência</span></span>
                        </div>
                        <div class="bolinhas-container" id="vigorBolinhas"></div>
                    </div>

                    <!-- VT -->
                    <div class="atributo-row" data-atributo="vt">
                        <div class="atributo-info">
                            <span class="atributo-nome">VT (Vitalidade)</span>
                            <span class="atributo-valor" id="vtValor">5</span>
                        </div>
                        <div class="bolinhas-container" id="vtBolinhas"></div>
                        <div class="atributo-detalhes">
                            <span class="vida" id="vtVida">PV 40</span>
                        </div>
                    </div>
                </div>

                <div class="card-section status-grid">
                    <div class="status-item">
                        <span class="label">PV:</span>
                        <span class="value" id="statusPV">40</span>
                    </div>
                    <div class="status-item">
                        <span class="label">PF (Fadiga):</span>
                        <span class="value" id="statusPF">10</span>
                    </div>
                    <div class="status-item">
                        <span class="label">PM (Mana):</span>
                        <span class="value" id="statusPM">15</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Dano Base:</span>
                        <span class="value" id="statusDano">1d-3</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Nível:</span>
                        <span class="value" id="nivelPersonagem">1</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA COMBATE -->
        <div id="abaCombate" class="conteudo-aba">
            <div class="card">
                <h2 style="color: #ff6b6b; margin-bottom: 20px;"><i class="fas fa-shield-alt"></i> Combate</h2>
                
                <div class="combate-stats-grid">
                    <div class="combate-stat-card">
                        <div class="stat-label">PV</div>
                        <div class="stat-value" id="combatePV">40</div>
                    </div>
                    <div class="combate-stat-card">
                        <div class="stat-label">PF</div>
                        <div class="stat-value" id="combatePF">10</div>
                    </div>
                    <div class="combate-stat-card">
                        <div class="stat-label">PM</div>
                        <div class="stat-value" id="combatePM">15</div>
                    </div>
                </div>

                <div class="defesas-ativas">
                    <h3 style="color: #ffd700;">Defesas</h3>
                    <div class="defesas-grid">
                        <div class="defesa-card">
                            <div class="defesa-nome">Esquiva</div>
                            <div class="defesa-percentual" id="defesaEsquiva">42%</div>
                        </div>
                        <div class="defesa-card">
                            <div class="defesa-nome">Aparar</div>
                            <div class="defesa-percentual" id="defesaAparar">0%</div>
                        </div>
                        <div class="defesa-card">
                            <div class="defesa-nome">Bloqueio</div>
                            <div class="defesa-percentual" id="defesaBloqueio">0%</div>
                        </div>
                    </div>
                </div>

                <div class="deslocamento-info">
                    <div class="deslocamento-item">
                        <div class="tipo">Andar</div>
                        <div class="valor" id="deslocamentoAndar">2</div>
                    </div>
                    <div class="deslocamento-item">
                        <div class="tipo">Correr</div>
                        <div class="valor" id="deslocamentoCorrer">6</div>
                    </div>
                </div>

                <div class="arma-equipada" id="armaEquipadaContainer">
                    <h3><i class="fas fa-sword"></i> Arma Equipada</h3>
                    <div class="arma-detalhes">
                        <div class="arma-detalhe-item">
                            <div class="label">Arma</div>
                            <div class="valor" id="armaNome">Nenhuma</div>
                        </div>
                        <div class="arma-detalhe-item">
                            <div class="label">Dano</div>
                            <div class="valor" id="armaDano">-</div>
                        </div>
                    </div>
                </div>

                <div class="rd-grid">
                    <div class="rd-item">
                        <div class="rd-tipo">RD</div>
                        <div class="rd-valor" id="rdTotal">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA VANTAGENS -->
        <div id="abaVantagens" class="conteudo-aba">
            <div class="card">
                <h2><i class="fas fa-star"></i> Vantagens (escolha 3)</h2>
                <div class="contador"><span>Selecionadas:</span><span id="contadorVantagens">0/3</span></div>
                <div class="vantagens-grid" id="vantagensGrid">
                    <div class="vantagem-card" data-vantagem="aliado"><h3>Aliado</h3><p>Um companheiro fiel</p></div>
                    <div class="vantagem-card" data-vantagem="ambidestria"><h3>Ambidestria</h3><p>2 ataques/turno, cada um -2 dano</p></div>
                    <div class="vantagem-card" data-vantagem="aptidaoMagica"><h3>Aptidão Mágica</h3><p>+10% em magias</p></div>
                    <div class="vantagem-card" data-vantagem="abascanto"><h3>Resistência a magia-header</h3><p>+3% resistência a magia</p></div>
                    <div class="vantagem-card" data-vantagem="carisma"><h3>Carisma</h3><p>+5% testes sociais</p></div>
                    <div class="vantagem-card" data-vantagem="destemor"><h3>Destemor +2</h3><p>+10% resistência medo</p></div>
                    <div class="vantagem-card" data-vantagem="duroMatar"><h3>Duro de matar </h3><p>+10% VT</p></div>
                    <div class="vantagem-card" data-vantagem="flexibilidade"><h3>Flexibilidade</h3><p>+5% testes DX</p></div>
                    <div class="vantagem-card" data-vantagem="intuicao"><h3>Intuição</h3><p>Sentir quando algo está errado</p></div>
                    <div class="vantagem-card" data-vantagem="reflexoCombate"><h3>Reflexo de combate</h3><p>+5% Esquiva</p></div>
                    <div class="vantagem-card" data-vantagem="regeneracao"><h3>Regeneração</h3><p>Recupera vida mais rápido</p></div>
                    <div class="vantagem-card" data-vantagem="sentidosAgucados"><h3>Sentidos aguçados</h3><p>+5% Percepção</p></div>
                    <div class="vantagem-card" data-vantagem="sorte"><h3>Sorte</h3><p>Pode rerolar testes</p></div>
                    <div class="vantagem-card" data-vantagem="visaoNoturna"><h3>Visão noturna</h3><p>Enxerga no escuro</p></div>
                    <div class="vantagem-card" data-vantagem="mestreArmas"><h3>Mestre das armas</h3><p>+5% Aparar</p></div>
                    <div class="vantagem-card" data-vantagem="forcaVontade"><h3>Força de vontade +2</h3><p>+10% resistência mental</p></div>
                    <div class="vantagem-card" data-vantagem="fadigaExtra"><h3>Fadiga extra</h3><p>+5 PF</p></div>
                    <div class="vantagem-card" data-vantagem="htExtra"><h3>VT extra +10%</h3><p>Aumento percentual no VT</p></div>
                    <div class="vantagem-card" data-vantagem="atraente"><h3>Atraente</h3><p>+5% reações sociais</p></div>
                    <div class="vantagem-card" data-vantagem="rico"><h3>Rico</h3><p>Começa com 250 moedas</p></div>
                </div>
            </div>
        </div>

        <!-- ABA DESVANTAGENS -->
        <div id="abaDesvantagens" class="conteudo-aba">
            <div class="card">
                <h2><i class="fas fa-skull"></i> Desvantagens (escolha 4)</h2>
                <div class="contador desvantagens"><span>Selecionadas:</span><span id="contadorDesvantagens">0/4</span></div>
                <div class="desvantagens-grid" id="desvantagensGrid">
                    <div class="desvantagem-card" data-desvantagem="alcoolismo"><h3>Alcoolismo</h3><p>Vício em bebida</p></div>
                    <div class="desvantagem-card" data-desvantagem="avareza"><h3>Avareza</h3><p>Mesquinho, ama dinheiro</p></div>
                    <div class="desvantagem-card" data-desvantagem="briguento"><h3>Briguento</h3><p>Adora uma briga</p></div>
                    <div class="desvantagem-card" data-desvantagem="cobica"><h3>Cobiça</h3><p>Quer tudo que vê</p></div>
                    <div class="desvantagem-card" data-desvantagem="codigoHonra"><h3>Código de honra</h3><p>Segue regras rígidas</p></div>
                    <div class="desvantagem-card" data-desvantagem="covardia"><h3>Covardia</h3><p>Foge de perigo</p></div>
                    <div class="desvantagem-card" data-desvantagem="excessoConfianca"><h3>Excesso de confiança</h3><p>Se acha mais capaz</p></div>
                    <div class="desvantagem-card" id="cardFobia" data-desvantagem="fobia"><h3>Fobia <i class="fas fa-chevron-right"></i></h3><p>Clique para escolher</p><span class="badge-fobia" id="fobiaEscolhida" style="display: none;"></span></div>
                    <div class="desvantagem-card" data-desvantagem="furia"><h3>Fúria</h3><p>Perde o controle na raiva</p></div>
                    <div class="desvantagem-card" data-desvantagem="honestidade"><h3>Honestidade</h3><p>Não consegue mentir</p></div>
                    <div class="desvantagem-card" data-desvantagem="luxuria"><h3>Luxúria</h3><p>Obcecado por prazeres</p></div>
                    <div class="desvantagem-card" data-desvantagem="megalomania"><h3>Megalomania</h3><p>Quer dominar o mundo</p></div>
                    <div class="desvantagem-card" data-desvantagem="pacifismo"><h3>Pacifismo</h3><p>Não suporta violência</p></div>
                    <div class="desvantagem-card" data-desvantagem="preguica"><h3>Preguiça</h3><p>Evita esforço</p></div>
                    <div class="desvantagem-card" data-desvantagem="sanguinolencia"><h3>Sanguinolência</h3><p>Adora ver sangue</p></div>
                    <div class="desvantagem-card" data-desvantagem="teimosia"><h3>Teimosia</h3><p>Não muda de ideia</p></div>
                    <div class="desvantagem-card" data-desvantagem="veracidade"><h3>Veracidade</h3><p>Sempre fala a verdade</p></div>
                    <div class="desvantagem-card" data-desvantagem="magro"><h3>Magro</h3><p>-20% peso, vulnerável a quedas</p></div>
                    <div class="desvantagem-card" data-desvantagem="gordo"><h3>Gordo</h3><p>+20% peso, perde fadiga rápido</p></div>
                    <div class="desvantagem-card" data-desvantagem="nanismo"><h3>Nanismo</h3><p>-1 deslocamento</p></div>
                    <div class="desvantagem-card" data-desvantagem="pobre"><h3>Pobre</h3><p>Começa com metade do dinheiro</p></div>
                    <div class="desvantagem-card" data-desvantagem="feio"><h3>Feio</h3><p>-5% reações</p></div>
                </div>
            </div>
        </div>

        <!-- ABA PERÍCIAS -->
        <div id="abaPericias" class="conteudo-aba">
            <div class="card">
                <div class="pm-header">
                    <div class="pm-input-group">
                        <label for="ppInicial">PP Inicial:</label>
                        <input type="number" id="ppInicial" min="0" value="30" step="1">
                    </div>
                    <div class="pm-stats">
                        <div>Gastos: <span id="ppGasto">0</span></div>
                        <div>Restante: <span id="ppRestante">30</span></div>
                    </div>
                </div>
                <div class="pericias-container">
                    <div class="catalogo-pericias">
                        <h3 style="color: #ffd700;">Catálogo de Perícias</h3>
                        <div class="filtros-pericias">
                            <button class="filtro-pericia ativo" data-filtro="todas">Todas</button>
                            <button class="filtro-pericia" data-filtro="mental">Mental (IQ)</button>
                            <button class="filtro-pericia" data-filtro="fisica">Física (DX)</button>
                        </div>
                        <div class="lista-pericias" id="listaPericias"></div>
                    </div>
                    <div class="pericias-adquiridas">
                        <h3>Perícias do Personagem</h3>
                        <div class="lista-adquiridas" id="listaPericiasAdquiridas"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA MAGIAS -->
        <div id="abaMagias" class="conteudo-aba">
            <div class="card">
                <div class="magia-header">
                    <h2 style="color: #4a9fff;"><i class="fas fa-water"></i> Escola da Água</h2>
                </div>
                <div class="esferas-grid" id="esferasGrid"></div>
            </div>
        </div>

       <!-- ABA EQUIPAMENTOS -->
<div id="abaEquipamentos" class="conteudo-aba">
    <div class="card">
        <!-- CABEÇALHO COM DINHEIRO E CARGA -->
        <div class="dinheiro-header">
            <div class="dinheiro-info">
                <i class="fas fa-coins"></i>
                <span>Saldo: <span class="valor" id="dinheiroSaldo">1000</span> $</span>
            </div>
            <div class="dinheiro-info">
                <i class="fas fa-weight-hanging"></i>
                <span>Carga: <span id="cargaAtual">0.0</span> kg / <span id="cargaLimite">60</span> kg</span>
            </div>
            <div class="carga-nivel" id="cargaNivel">Leve</div>
        </div>

        <!-- BARRA DE CARGA -->
        <div class="carga-info">
            <div class="carga-barra">
                <div class="carga-preenchimento" id="cargaBarra" style="width: 0%;"></div>
            </div>
            <div class="carga-marcadores">
                <span>Leve</span>
                <span>Médio</span>
                <span>Pesado</span>
                <span>Limite</span>
            </div>
        </div>

        <!-- PENALIDADES DA CARGA -->
        <div class="penalidades-info" style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; margin-bottom: 20px; font-size: 0.9rem;">
            <span style="color: #ffd700;">Penalidades:</span>
            <span style="margin-left: 15px;">Deslocamento: <span id="penalidadeDeslocamento">0</span>m</span>
            <span style="margin-left: 15px;">Esquiva: <span id="penalidadeEsquiva">0</span>%</span>
        </div>

        <!-- INVENTÁRIO POR LOCAL -->
        <div class="inventario-grid">
            <!-- CORPO (itens equipados) -->
            <div class="inventario-coluna">
                <h3><i class="fas fa-user"></i> Corpo</h3>
                <div class="inventario-itens" id="inventarioCorpo"></div>
            </div>
            
            <!-- MOCHILA (itens carregados) -->
            <div class="inventario-coluna">
                <h3><i class="fas fa-shopping-bag"></i> Mochila</h3>
                <div class="inventario-itens" id="inventarioMochila"></div>
            </div>
            
            <!-- DEPÓSITO (itens guardados) -->
            <div class="inventario-coluna">
                <h3><i class="fas fa-warehouse"></i> Depósito</h3>
                <div class="inventario-itens" id="inventarioDeposito"></div>
            </div>
        </div>

        <!-- CATÁLOGO DE ITENS -->
        <div class="catalogo-itens">
            <h3 style="color: #ffd700; margin: 30px 0 15px 0;">
                <i class="fas fa-store"></i> Comprar Itens
            </h3>
            
            <!-- Abas do catálogo -->
            <div class="catalogo-tabs">
                <button class="catalogo-tab ativo" data-tab="armas_ca">Armas CA</button>
                <button class="catalogo-tab" data-tab="armas_dist">Armas Distância</button>
                <button class="catalogo-tab" data-tab="armaduras">Armaduras</button>
                <button class="catalogo-tab" data-tab="escudos">Escudos</button>
                <button class="catalogo-tab" data-tab="itens_gerais">Itens Gerais</button>
            </div>

            <!-- TABELAS DE ITENS -->
            <div class="tabelas-container">
                <!-- ARMAS CORPO A CORPO -->
                <div class="tabela-item ativa" id="tabelaArmasCA">
                    <table class="tabela-catalogo">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Alcance</th>
                                <th>Dano</th>
                                <th>Custo ($)</th>
                                <th>Peso (kg)</th>
                                <th>ST</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaArmasCA">
                            <tr><td>Adaga</td><td>1</td><td>1d-2</td><td>30</td><td>0.5</td><td>5</td><td><button class="btn-comprar" data-item="adaga">Comprar</button></td></tr>
                            <tr><td>Espada curta</td><td>1</td><td>1d-1</td><td>100</td><td>1.5</td><td>7</td><td><button class="btn-comprar" data-item="espada_curta">Comprar</button></td></tr>
                            <tr><td>Espada longa</td><td>1</td><td>1d</td><td>200</td><td>2.0</td><td>8</td><td><button class="btn-comprar" data-item="espada_longa">Comprar</button></td></tr>
                            <tr><td>Machado</td><td>1</td><td>1d+2</td><td>150</td><td>2.5</td><td>9</td><td><button class="btn-comprar" data-item="machado">Comprar</button></td></tr>
                            <tr><td>Maça</td><td>1</td><td>1d+1</td><td>120</td><td>2.0</td><td>8</td><td><button class="btn-comprar" data-item="maca">Comprar</button></td></tr>
                            <tr><td>Martelo</td><td>1</td><td>1d+2</td><td>180</td><td>3.0</td><td>10</td><td><button class="btn-comprar" data-item="martelo">Comprar</button></td></tr>
                            <tr><td>Lança</td><td>2</td><td>1d+1</td><td>100</td><td>2.0</td><td>8</td><td><button class="btn-comprar" data-item="lanca">Comprar</button></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- ARMAS DE DISTÂNCIA -->
                <div class="tabela-item" id="tabelaArmasDist">
                    <table class="tabela-catalogo">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Precisão</th>
                                <th>Dano</th>
                                <th>Alcance</th>
                                <th>Custo ($)</th>
                                <th>Peso (kg)</th>
                                <th>ST</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaArmasDist">
                            <tr><td>Arco curto</td><td>+1</td><td>1d</td><td>ST×15</td><td>100</td><td>1.0</td><td>7</td><td><button class="btn-comprar" data-item="arco_curto">Comprar</button></td></tr>
                            <tr><td>Arco longo</td><td>+2</td><td>1d+1</td><td>ST×20</td><td>200</td><td>1.5</td><td>9</td><td><button class="btn-comprar" data-item="arco_longo">Comprar</button></td></tr>
                            <tr><td>Besta leve</td><td>+2</td><td>1d+1</td><td>ST×25</td><td>150</td><td>2.5</td><td>7</td><td><button class="btn-comprar" data-item="besta_leve">Comprar</button></td></tr>
                            <tr><td>Besta pesada</td><td>+3</td><td>1d+2</td><td>ST×30</td><td>250</td><td>4.0</td><td>10</td><td><button class="btn-comprar" data-item="besta_pesada">Comprar</button></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- ARMADURAS -->
                <div class="tabela-item" id="tabelaArmaduras">
                    <table class="tabela-catalogo">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>RD</th>
                                <th>Custo ($)</th>
                                <th>Peso (kg)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaArmaduras">
                            <tr><td>Couro</td><td>2</td><td>50</td><td>5.0</td><td><button class="btn-comprar" data-item="couro">Comprar</button></td></tr>
                            <tr><td>Couro reforçado</td><td>4</td><td>250</td><td>10.0</td><td><button class="btn-comprar" data-item="couro_reforcado">Comprar</button></td></tr>
                            <tr><td>Cota de malha</td><td>6</td><td>500</td><td>15.0</td><td><button class="btn-comprar" data-item="cota_malha">Comprar</button></td></tr>
                            <tr><td>Placas</td><td>8</td><td>1000</td><td>22.0</td><td><button class="btn-comprar" data-item="placas">Comprar</button></td></tr>
                            <tr><td>Meia-armadura</td><td>5</td><td>400</td><td>12.0</td><td><button class="btn-comprar" data-item="meia_armadura">Comprar</button></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- ESCUDOS -->
                <div class="tabela-item" id="tabelaEscudos">
                    <table class="tabela-catalogo">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Bônus</th>
                                <th>VE</th>
                                <th>Custo ($)</th>
                                <th>Peso (kg)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaEscudos">
                            <tr><td>Escudo leve</td><td>+1</td><td>3/20</td><td>50</td><td>2.0</td><td><button class="btn-comprar" data-item="escudo_leve">Comprar</button></td></tr>
                            <tr><td>Escudo médio</td><td>+2</td><td>5/30</td><td>150</td><td>4.0</td><td><button class="btn-comprar" data-item="escudo_medio">Comprar</button></td></tr>
                            <tr><td>Escudo pesado</td><td>+3</td><td>7/45</td><td>300</td><td>8.0</td><td><button class="btn-comprar" data-item="escudo_pesado">Comprar</button></td></tr>
                            <tr><td>Escudo reforçado</td><td>+4</td><td>10/60</td><td>500</td><td>12.0</td><td><button class="btn-comprar" data-item="escudo_reforcado">Comprar</button></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- ITENS GERAIS -->
                <div class="tabela-item" id="tabelaItensGerais">
                    <table class="tabela-catalogo">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Especificação</th>
                                <th>Custo ($)</th>
                                <th>Peso (kg)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaItensGerais">
                            <tr><td>Corda</td><td>10m</td><td>5</td><td>1.5</td><td><button class="btn-comprar" data-item="corda">Comprar</button></td></tr>
                            <tr><td>Tocha</td><td>1h de luz</td><td>1</td><td>0.5</td><td><button class="btn-comprar" data-item="tocha">Comprar</button></td></tr>
                            <tr><td>Mochila</td><td>50kg capacidade</td><td>20</td><td>1.5</td><td><button class="btn-comprar" data-item="mochila">Comprar</button></td></tr>
                            <tr><td>Ração</td><td>1 dia</td><td>2</td><td>0.5</td><td><button class="btn-comprar" data-item="racao">Comprar</button></td></tr>
                            <tr><td>Cantil</td><td>1L</td><td>3</td><td>0.8</td><td><button class="btn-comprar" data-item="cantil">Comprar</button></td></tr>
                            <tr><td>Kit primeiros socorros</td><td>-</td><td>50</td><td>1.0</td><td><button class="btn-comprar" data-item="kit_socorros">Comprar</button></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
   <script type="module">
// ============================================
// SISTEMA RPGFORCE - VERSÃO COMPLETA E CORRIGIDA
// ============================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

// ============================================
// FIREBASE CONFIG
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyBrx4JSmFay24k95pu1ICjFfVki8gs_uHw",
    authDomain: "rpgforce-e3227.firebaseapp.com",
    projectId: "rpgforce-e3227",
    storageBucket: "rpgforce-e3227.firebasestorage.app",
    messagingSenderId: "984517342332",
    appId: "1:984517342332:web:87d33aa4c84ff2a07685f9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ============================================
// ATRIBUTOS
// ============================================
const atributos = {
    st: { esferas: 0 },
    dx: { esferas: 0 },
    iq: { esferas: 0 },
    vigor: { esferas: 0 },
    vt: { esferas: 0 }
};

// ============================================
// DADOS DAS MAGIAS (ATUALIZADO)
// ============================================
const dadosMagias = {
    purificarAgua: {
        nome: "Purificar Água", tipo: "Utilitária", icone: "fa-droplet",
        efeitos: { 1: "1L", 2: "5L", 3: "10L", 4: "20L", 5: "50L", 6: "100L", 7: "200L", 8: "500L", 9: "1000L", 10: "5000L" }
    },
    criarAgua: {
        nome: "Criar Água", tipo: "Utilitária", icone: "fa-water",
        efeitos: { 1: "1L", 2: "5L", 3: "10L", 4: "20L", 5: "50L", 6: "100L", 7: "200L", 8: "500L", 9: "1000L", 10: "5000L" }
    },
    dissiparAgua: {
        nome: "Dissipar Água", tipo: "Área", icone: "fa-wind",
        efeitos: { 1: "1m³", 2: "5m³", 3: "10m³", 4: "20m³", 5: "50m³", 6: "100m³", 7: "200m³", 8: "500m³", 9: "1000m³", 10: "5000m³" }
    },
    flechaLiquida: {
        nome: "Flecha Líquida", tipo: "Ataque", icone: "fa-bow-arrow",
        efeitos: { 1: "1d-2", 2: "1d-1", 3: "1d", 4: "1d+1", 5: "1d+2", 6: "2d-2", 7: "2d-1", 8: "2d", 9: "2d+1", 10: "3d" }
    },
    respirarNaAgua: {
        nome: "Respirar na Água", tipo: "Suporte", icone: "fa-lungs",
        efeitos: { 1: "1min", 2: "2min", 3: "5min", 4: "10min", 5: "15min", 6: "30min", 7: "45min", 8: "1h", 9: "1.5h", 10: "2h" }
    },
    moldarAgua: {
        nome: "Moldar Água", tipo: "Controle", icone: "fa-hand",
        efeitos: { 1: "1L", 2: "5L", 3: "10L", 4: "20L", 5: "50L", 6: "100L", 7: "200L", 8: "500L", 9: "1000L", 10: "5000L" }
    },
    nevoeiro: {
        nome: "Nevoeiro", tipo: "Área", icone: "fa-cloud",
        efeitos: { 1: "5m", 2: "6m", 3: "7m", 4: "8m", 5: "9m", 6: "10m", 7: "12m", 8: "14m", 9: "16m", 10: "20m" }
    },
    jatoDagua: {
        nome: "Jato d'água", tipo: "Ataque", icone: "fa-water",
        efeitos: { 1: "1d-1", 2: "1d", 3: "1d+1", 4: "1d+2", 5: "2d-2", 6: "2d-1", 7: "2d", 8: "2d+1", 9: "2d+2", 10: "3d" }
    },
    ondaExpulsora: {
        nome: "Onda Expulsora", tipo: "Área", icone: "fa-wave-square",
        efeitos: { 1: "1d-2", 2: "1d-1", 3: "1d", 4: "1d+1", 5: "1d+2", 6: "2d-2", 7: "2d-1", 8: "2d", 9: "2d+1", 10: "3d" }
    },
    golemDeAgua: {
        nome: "Golem de Água", tipo: "Convocação", icone: "fa-robot",
        efeitos: { 1: "PV 10", 2: "PV 15", 3: "PV 20", 4: "PV 25", 5: "PV 30", 6: "PV 35", 7: "PV 40", 8: "PV 45", 9: "PV 50", 10: "PV 60" }
    },
    cortinaDagua: {
        nome: "Cortina d'Água", tipo: "Defesa", icone: "fa-shield",
        efeitos: { 1: "RD+1", 2: "RD+1", 3: "RD+2", 4: "RD+2", 5: "RD+3", 6: "RD+3", 7: "RD+4", 8: "RD+4", 9: "RD+5", 10: "RD+5" }
    }
};

// ============================================
// ESCOLAS DE MAGIA (ATUALIZADO)
// ============================================
const escolas = {
    agua: {
        id: 'agua',
        nome: 'Água',
        desbloqueada: true,
        icone: 'fa-water',
        magias: {
            purificarAgua: { nivel: 0, desbloqueada: false, ordem: 1 },
            criarAgua: { nivel: 0, desbloqueada: false, ordem: 2 },
            dissiparAgua: { nivel: 0, desbloqueada: false, ordem: 3 },
            flechaLiquida: { nivel: 0, desbloqueada: false, ordem: 4 },
            respirarNaAgua: { nivel: 0, desbloqueada: false, ordem: 5 },
            moldarAgua: { nivel: 0, desbloqueada: false, ordem: 6 },
            nevoeiro: { nivel: 0, desbloqueada: false, ordem: 7 },
            jatoDagua: { nivel: 0, desbloqueada: false, ordem: 8 },
            ondaExpulsora: { nivel: 0, desbloqueada: false, ordem: 9 },
            golemDeAgua: { nivel: 0, desbloqueada: false, ordem: 10 },
            cortinaDagua: { nivel: 0, desbloqueada: false, ordem: 11 }
        }
    }
};

// ============================================
// VANTAGENS (ATUALIZADO)
// ============================================
const vantagensData = {
    aliado: { nome: 'Aliado', efeito: 'Um companheiro fiel' },
    ambidestria: { nome: 'Ambidestria', efeito: '2 ataques/turno, cada um -2 dano' },
    aptidaoMagica: { nome: 'Aptidão Mágica', efeito: '+10% em magias' },
    resistenciaMagia: { nome: 'Resistência a Magia', efeito: '+5% resistência a magia' },
    carisma: { nome: 'Carisma', efeito: '+5% testes sociais, +2% Persuasão' },
    destemor: { nome: 'Destemor +2', efeito: '+10% resistência medo' },
    duroMatar: { nome: 'Duro de matar', efeito: '+10% VT' },
    flexibilidade: { nome: 'Flexibilidade', efeito: '+5% testes DX' },
    intuicao: { nome: 'Intuição', efeito: 'Sentir quando algo está errado' },
    reflexoCombate: { nome: 'Reflexo de combate', efeito: '+5% Esquiva' },
    regeneracao: { nome: 'Regeneração', efeito: 'Recupera vida mais rápido' },
    sentidosAgucados: { nome: 'Sentidos aguçados', efeito: '+10% Percepção' },
    sorte: { nome: 'Sorte', efeito: 'Pode rerolar testes' },
    visaoNoturna: { nome: 'Visão noturna', efeito: 'Enxerga no escuro' },
    mestreArmas: { nome: 'Mestre das armas', efeito: '+5% Aparar' },
    forcaVontade: { nome: 'Força de vontade +2', efeito: '+10% resistência mental' },
    fadigaExtra: { nome: 'Fadiga extra', efeito: '+5 PF' },
    htExtra: { nome: 'VT extra +5%', efeito: 'Aumento percentual no VT' },
    atraente: { nome: 'Atraente', efeito: '+5% reações sociais' },
    rico: { nome: 'Rico', efeito: 'Começa com 250 moedas' }
};

// ============================================
// CATÁLOGO DE PERÍCIAS
// ============================================
const catalogoPericias = [
    { id: "adestramento", nome: "Adestramento", tipo: "mental", atributo: "iq" },
    { id: "alquimia", nome: "Alquimia", tipo: "mental", atributo: "iq" },
    { id: "artista", nome: "Artista", tipo: "mental", atributo: "iq" },
    { id: "comercio", nome: "Comércio", tipo: "mental", atributo: "iq" },
    { id: "culinaria", nome: "Culinária", tipo: "mental", atributo: "iq" },
    { id: "detectarMentira", nome: "Detecção de Mentira", tipo: "mental", atributo: "iq" },
    { id: "intimidacao", nome: "Intimidação", tipo: "mental", atributo: "iq" },
    { id: "labia", nome: "Lábia", tipo: "mental", atributo: "iq" },
    { id: "medicina", nome: "Medicina", tipo: "mental", atributo: "iq" },
    { id: "persuasao", nome: "Persuasão", tipo: "mental", atributo: "iq" },
    { id: "primeirosSocorros", nome: "Primeiros Socorros", tipo: "mental", atributo: "iq" },
    { id: "sobrevivencia", nome: "Sobrevivência", tipo: "mental", atributo: "iq" },
    { id: "acrobacia", nome: "Acrobacia", tipo: "fisica", atributo: "dx" },
    { id: "arco", nome: "Arco", tipo: "fisica", atributo: "dx" },
    { id: "armasHaste", nome: "Armas de Haste", tipo: "fisica", atributo: "dx" },
    { id: "arremesso", nome: "Arremesso", tipo: "fisica", atributo: "dx" },
    { id: "bastao", nome: "Bastão", tipo: "fisica", atributo: "dx" },
    { id: "besta", nome: "Besta", tipo: "fisica", atributo: "dx" },
    { id: "boxe", nome: "Boxe", tipo: "fisica", atributo: "dx" },
    { id: "briga", nome: "Briga", tipo: "fisica", atributo: "dx" },
    { id: "capa", nome: "Capa", tipo: "fisica", atributo: "dx" },
    { id: "cavalgar", nome: "Cavalgar", tipo: "fisica", atributo: "dx" },
    { id: "chicote", nome: "Chicote", tipo: "fisica", atributo: "dx" },
    { id: "esgrima", nome: "Esgrima", tipo: "fisica", atributo: "dx" },
    { id: "espada", nome: "Espada", tipo: "fisica", atributo: "dx" },
    { id: "escudo", nome: "Escudo", tipo: "fisica", atributo: "dx" },
    { id: "fuga", nome: "Fuga", tipo: "fisica", atributo: "dx" },
    { id: "furtividade", nome: "Furtividade", tipo: "fisica", atributo: "dx" },
    { id: "kuzari", nome: "Kuzari", tipo: "fisica", atributo: "dx" },
    { id: "mangual", nome: "Mangual", tipo: "fisica", atributo: "dx" }
];

// ============================================
// CATÁLOGO DE ITENS
// ============================================
const catalogoItensData = {
    armas_ca: [
        { id: 'adaga', nome: 'Adaga', alcance: 1, dano: '1d-2', preco: 30, peso: 0.5, st: 5 },
        { id: 'espada_curta', nome: 'Espada curta', alcance: 1, dano: '1d-1', preco: 100, peso: 1.5, st: 7 },
        { id: 'espada_longa', nome: 'Espada longa', alcance: 1, dano: '1d', preco: 200, peso: 2.0, st: 8 },
        { id: 'machado', nome: 'Machado', alcance: 1, dano: '1d+2', preco: 150, peso: 2.5, st: 9 },
        { id: 'maca', nome: 'Maça', alcance: 1, dano: '1d+1', preco: 120, peso: 2.0, st: 8 },
        { id: 'martelo', nome: 'Martelo', alcance: 1, dano: '1d+2', preco: 180, peso: 3.0, st: 10 },
        { id: 'lanca', nome: 'Lança', alcance: 2, dano: '1d+1', preco: 100, peso: 2.0, st: 8 }
    ],
    armas_dist: [
        { id: 'arco_curto', nome: 'Arco curto', precisao: 1, dano: '1d', alcance: 'ST×15', preco: 100, peso: 1.0, st: 7 },
        { id: 'arco_longo', nome: 'Arco longo', precisao: 2, dano: '1d+1', alcance: 'ST×20', preco: 200, peso: 1.5, st: 9 },
        { id: 'besta_leve', nome: 'Besta leve', precisao: 2, dano: '1d+1', alcance: 'ST×25', preco: 150, peso: 2.5, st: 7 },
        { id: 'besta_pesada', nome: 'Besta pesada', precisao: 3, dano: '1d+2', alcance: 'ST×30', preco: 250, peso: 4.0, st: 10 }
    ],
    armaduras: [
        { id: 'couro', nome: 'Armadura de Couro', rd: 2, preco: 50, peso: 5.0 },
        { id: 'couro_ref', nome: 'Armadura de Couro Reforçado', rd: 4, preco: 250, peso: 10.0 },
        { id: 'cota_malha', nome: 'Cota de Malha', rd: 6, preco: 500, peso: 15.0 },
        { id: 'placas', nome: 'Armadura de Placas', rd: 8, preco: 1000, peso: 22.0 },
        { id: 'meia_armadura', nome: 'Meia-Armadura', rd: 5, preco: 400, peso: 12.0 }
    ],
    escudos: [
        { id: 'escudo_leve', nome: 'Escudo Leve', bonus: 1, ve: '3/20', preco: 50, peso: 2.0 },
        { id: 'escudo_medio', nome: 'Escudo Médio', bonus: 2, ve: '5/30', preco: 150, peso: 4.0 },
        { id: 'escudo_pesado', nome: 'Escudo Pesado', bonus: 3, ve: '7/45', preco: 300, peso: 8.0 },
        { id: 'escudo_reforcado', nome: 'Escudo Reforçado', bonus: 4, ve: '10/60', preco: 500, peso: 12.0 }
    ],
    itens_gerais: [
        { id: 'corda', nome: 'Corda', especificacao: '10m', preco: 5, peso: 1.5 },
        { id: 'tocha', nome: 'Tocha', especificacao: '1h de luz', preco: 1, peso: 0.5 },
        { id: 'mochila', nome: 'Mochila', especificacao: '50kg capacidade', preco: 20, peso: 1.5 },
        { id: 'racao', nome: 'Ração', especificacao: '1 dia', preco: 2, peso: 0.5 },
        { id: 'cantil', nome: 'Cantil', especificacao: '1L', preco: 3, peso: 0.8 },
        { id: 'kit_socorros', nome: 'Kit primeiros socorros', especificacao: '', preco: 50, peso: 1.0 }
    ]
};

// ============================================
// VARIÁVEIS GLOBAIS
// ============================================
let abaAtual = 'basicos';
let esferasIniciais = 6;
let esferasRestantes = 6;
let fobiaSelecionada = null;
let personagemTemp = null;
let personagemId = null;
let modoEdicao = false;
const vantagensSelecionadas = new Set();
const desvantagensSelecionadas = new Set();
let ppDisponivel = 30;
let ppGastoTotal = 0;
let pericias = {};
let periciaAtual = null;
let dinheiroBase = 1000;
let autoSaveTimeout = null;
let magiaSelecionada = null;
let inventario = { corpo: [], mochila: [], deposito: [] };
let dinheiro = 0;

// ============================================
// ELEMENTOS DOM
// ============================================
const elements = {
    displayIdPc: document.getElementById('displayIdPc'),
    displayNickname: document.getElementById('displayNickname'),
    btnSair: document.getElementById('btnSair'),
    loadingOverlay: document.getElementById('loadingOverlay'),
    btnAnterior: document.getElementById('btnAnterior'),
    btnProximo: document.getElementById('btnProximo'),
    btnFinalizar: document.getElementById('btnFinalizar'),
    abas: document.querySelectorAll('.aba'),
    conteudos: document.querySelectorAll('.conteudo-aba'),
    uploadArea: document.getElementById('uploadArea'),
    fotoInput: document.getElementById('fotoInput'),
    previewArea: document.getElementById('previewArea'),
    previewImage: document.getElementById('previewImage'),
    removeFoto: document.getElementById('removeFoto'),
    esferasIniciaisInput: document.getElementById('esferasIniciais'),
    esferasRestantesSpan: document.getElementById('esferasRestantes'),
    nivelPersonagemSpan: document.getElementById('nivelPersonagem'),
    modalFobias: document.getElementById('modalFobias'),
    fecharModalFobias: document.getElementById('fecharModalFobias'),
    fobiaEscolhida: document.getElementById('fobiaEscolhida'),
    cardFobia: document.getElementById('cardFobia'),
    contadorVantagensSpan: document.getElementById('contadorVantagens'),
    contadorDesvantagensSpan: document.getElementById('contadorDesvantagens'),
    contadorVantagensAba: document.getElementById('contadorVantagensAba'),
    contadorDesvantagensAba: document.getElementById('contadorDesvantagensAba'),
    contadorPericiasAba: document.getElementById('contadorPericiasAba'),
    contadorMagiasAba: document.getElementById('contadorMagiasAba'),
    ppInicial: document.getElementById('ppInicial'),
    ppGasto: document.getElementById('ppGasto'),
    ppRestante: document.getElementById('ppRestante'),
    listaPericias: document.getElementById('listaPericias'),
    listaPericiasAdquiridas: document.getElementById('listaPericiasAdquiridas'),
    modalPericia: document.getElementById('modalPericia'),
    modalPericiaNome: document.getElementById('modalPericiaNome'),
    modalPericiaNivel: document.getElementById('modalPericiaNivel'),
    modalPericiaCusto: document.getElementById('modalPericiaCusto'),
    modalPericiaMenos: document.getElementById('modalPericiaMenos'),
    modalPericiaMais: document.getElementById('modalPericiaMais'),
    modalPericiaCancelar: document.getElementById('modalPericiaCancelar'),
    modalPericiaConfirmar: document.getElementById('modalPericiaConfirmar'),
    esferasGrid: document.getElementById('esferasGrid'),
    detalheMagiaModal: document.getElementById('detalheMagiaModal'),
    detalheMagiaTitulo: document.getElementById('detalheMagiaTitulo'),
    corpoTabelaDetalhe: document.getElementById('corpoTabelaDetalhe'),
    fecharDetalheMagia: document.getElementById('fecharDetalheMagia'),
    comprarNivelMagia: document.getElementById('comprarNivelMagia'),
    detalheMagiaNH: document.getElementById('detalheMagiaNH'),
    dinheiroBaseInput: document.getElementById('dinheiroBase'),
    dinheiroSaldo: document.getElementById('dinheiroSaldo'),
    cargaAtual: document.getElementById('cargaAtual'),
    cargaLimite: document.getElementById('cargaLimite'),
    cargaBarra: document.getElementById('cargaBarra'),
    cargaNivel: document.getElementById('cargaNivel'),
    inventarioCorpo: document.getElementById('inventarioCorpo'),
    inventarioMochila: document.getElementById('inventarioMochila'),
    inventarioDeposito: document.getElementById('inventarioDeposito'),
    btnCriarItem: document.getElementById('btnCriarItem'),
    btnSalvarPersonagem: document.getElementById('btnSalvarPersonagem'),
    btnExportarPDF: document.getElementById('btnExportarPDF'),
    btnExcluirPersonagem: document.getElementById('btnExcluirPersonagem'),
    modalConfirmarExclusao: document.getElementById('modalConfirmarExclusao'),
    cancelarExclusao: document.getElementById('cancelarExclusao'),
    confirmarExclusao: document.getElementById('confirmarExclusao'),
    modalSalvarSucesso: document.getElementById('modalSalvarSucesso'),
    fecharModalSalvar: document.getElementById('fecharModalSalvar'),
    autoSaveIndicator: document.getElementById('autoSaveIndicator'),
    breadcrumbCurrent: document.getElementById('breadcrumbCurrent'),
    pageTitle: document.getElementById('pageTitle'),
    personagemIdHidden: document.getElementById('personagemId'),
    
    stValor: document.getElementById('stValor'),
    stFixo: document.getElementById('stFixo'),
    stPercentual: document.getElementById('stPercentual'),
    dxValor: document.getElementById('dxValor'),
    dxFixo: document.getElementById('dxFixo'),
    dxPercentual: document.getElementById('dxPercentual'),
    iqValor: document.getElementById('iqValor'),
    iqFixo: document.getElementById('iqFixo'),
    iqPercentual: document.getElementById('iqPercentual'),
    vigorValor: document.getElementById('vigorValor'),
    vigorFixo: document.getElementById('vigorFixo'),
    vigorPercentual: document.getElementById('vigorPercentual'),
    vtValor: document.getElementById('vtValor'),
    stDano: document.getElementById('stDano'),
    vtVida: document.getElementById('vtVida'),
    
    statusPV: document.getElementById('statusPV'),
    statusPF: document.getElementById('statusPF'),
    statusPM: document.getElementById('statusPM'),
    statusDano: document.getElementById('statusDano'),
    
    combatePV: document.getElementById('combatePV'),
    combatePF: document.getElementById('combatePF'),
    combatePM: document.getElementById('combatePM'),
    defesaEsquiva: document.getElementById('defesaEsquiva'),
    defesaAparar: document.getElementById('defesaAparar'),
    defesaBloqueio: document.getElementById('defesaBloqueio'),
    deslocamentoAndar: document.getElementById('deslocamentoAndar'),
    deslocamentoCorrer: document.getElementById('deslocamentoCorrer'),
    armaNome: document.getElementById('armaNome'),
    armaDano: document.getElementById('armaDano'),
    armaAlcance: document.getElementById('armaAlcance'),
    rdTotal: document.getElementById('rdTotal'),
    
    corpoTabelaArmasCA: document.getElementById('corpoTabelaArmasCA'),
    corpoTabelaArmasDist: document.getElementById('corpoTabelaArmasDist'),
    corpoTabelaArmaduras: document.getElementById('corpoTabelaArmaduras'),
    corpoTabelaEscudos: document.getElementById('corpoTabelaEscudos'),
    corpoTabelaItensGerais: document.getElementById('corpoTabelaItensGerais')
};

// ============================================
// FUNÇÕES DE ATRIBUTOS - CORRIGIDO (SEM DUPLICIDADE)
// ============================================
function getSTFixo() { return 5 + atributos.st.esferas; }
function getSTPercentual() { return 30 + (atributos.st.esferas * 3); }
function getDXFixo() { return 5 + atributos.dx.esferas; }
function getDXPercentual() { return 30 + (atributos.dx.esferas * 2); }
function getIQFixo() { return 5 + atributos.iq.esferas; }
function getIQPercentual() { return 30 + (atributos.iq.esferas * 2); }
function getVIGORFixo() { return 5 + atributos.vigor.esferas; }
function getVIGORPercentual() { return 30 + (atributos.vigor.esferas * 3); }

// VT Base (COM bônus do duroMatar - ÚNICO LUGAR)
function getVTFixo() { 
    let vtBase = 5 + atributos.vt.esferas;
    let vtFinal = vtBase;
    
    // ✅ APLICAR AQUI (10% no VT)
    if (vantagensSelecionadas.has('duroMatar')) {
        vtFinal = Math.floor(vtFinal * 1.10);
    }
    
    if (vantagensSelecionadas.has('htExtra')) {
        vtFinal = Math.floor(vtFinal * 1.05);
    }
    
    return vtFinal;
}

// PV calculado simplesmente a partir do VT (SEM bônus extra)
function calcularPV() { 
    return getVTFixo() * 8;
}

// PF com bônus
function calcularPF() { 
    let pfBase = getVIGORFixo() + getVTFixo();
    
    if (vantagensSelecionadas.has('fadigaExtra')) {
        pfBase += 5;
    }
    
    return pfBase;
}

// PM
function calcularPM() { return getVIGORFixo() + getIQFixo() + getVTFixo(); }

// Nível do personagem
function calcularNivel() { 
    const totalEsferas = atributos.st.esferas + atributos.dx.esferas + atributos.iq.esferas + 
                        atributos.vigor.esferas + atributos.vt.esferas;
    return totalEsferas + 1;
}

// Resistência a Magia
function getResistenciaMagia() {
    let resistencia = getVIGORPercentual();
    if (vantagensSelecionadas.has('resistenciaMagia')) {
        resistencia += 5;
    }
    return Math.min(90, resistencia);
}

// Bônus de Perícia
function getBonusPericia(periciaId) {
    let bonus = 0;
    if (periciaId === 'persuasao' && vantagensSelecionadas.has('carisma')) {
        bonus += 2;
    }
    return bonus;
}
// ============================================
// TABELA DE DANO
// ============================================
const tabelaDano = {
    0: "1d-3", 1: "1d-3", 2: "1d-2", 3: "1d-2", 4: "1d-1", 5: "1d-1",
    6: "1d", 7: "1d", 8: "1d+1", 9: "1d+1", 10: "1d+2", 11: "1d+2",
    12: "2d-1", 13: "2d-1", 14: "2d", 15: "2d"
};

function calcularDanoBase() {
    return tabelaDano[atributos.st.esferas] || "1d-3";
}

// ============================================
// TABELA DE DESLOCAMENTO
// ============================================
const tabelaDeslocamento = [
    { min: 15, max: 20, andar: 2.0, correr: 6.0 },
    { min: 21, max: 26, andar: 3.0, correr: 9.0 },
    { min: 27, max: 32, andar: 4.0, correr: 12.0 },
    { min: 33, max: 38, andar: 5.0, correr: 15.0 },
    { min: 39, max: 44, andar: 6.0, correr: 18.0 },
    { min: 45, max: 50, andar: 7.0, correr: 21.0 },
    { min: 51, max: 60, andar: 8.0, correr: 24.0 }
];

function calcularDeslocamento() {
    const soma = getSTFixo() + getDXFixo() + getVIGORFixo();
    for (let faixa of tabelaDeslocamento) {
        if (soma >= faixa.min && soma <= faixa.max) {
            return { andar: faixa.andar, correr: faixa.correr };
        }
    }
    return soma < 15 ? { andar: 2.0, correr: 6.0 } : { andar: 8.0, correr: 24.0 };
}

// ============================================
// DEFESAS - CORRIGIDO
// ============================================
function calcularEsquiva() {
    let esquiva = Math.floor((getDXPercentual() + getIQPercentual() + getVIGORPercentual()) / 3) + 10;
    if (vantagensSelecionadas.has('reflexoCombate')) esquiva += 5;  // ✅ JÁ ESTÁ CORRETO
    const carga = calcularCarga();
    esquiva -= carga.penalidadeEsquiva;
    return Math.min(75, Math.max(0, esquiva));
}

function calcularAparar() {
    let melhorBonus = 0;
    let temArma = false;
    if (inventario.corpo && inventario.corpo.length > 0) {
        inventario.corpo.forEach(item => {
            if (item.dano) {
                temArma = true;
                const periciaId = mapearPericiaArma(item.nome);
                const pericia = pericias[periciaId];
                if (pericia) {
                    const bonus = (pericia.nivel || 0) * 4;
                    if (bonus > melhorBonus) melhorBonus = bonus;
                }
            }
        });
    }
    if (!temArma) return 0;
    
    let aparar = getDXPercentual() + melhorBonus;
    
    // ✅ ADICIONAR ESTA LINHA - Reflexo de Combate também dá bônus na aparar
    if (vantagensSelecionadas.has('reflexoCombate')) aparar += 5;
    
    if (vantagensSelecionadas.has('mestreArmas')) aparar += 5;
    return Math.min(80, aparar);
}

function calcularBloqueio() {
    let melhorBonus = 0;
    let bonusEscudo = 0;
    let temEscudo = false;
    if (inventario.corpo && inventario.corpo.length > 0) {
        inventario.corpo.forEach(item => {
            if (item.bonus) {
                temEscudo = true;
                bonusEscudo = item.bonus || 0;
                const pericia = pericias['escudo'];
                if (pericia) {
                    const bonus = (pericia.nivel || 0) * 4;
                    if (bonus > melhorBonus) melhorBonus = bonus;
                }
            }
        });
    }
    if (!temEscudo) return 0;
    
    let bloqueio = getDXPercentual() + melhorBonus + bonusEscudo;
    
    // ✅ ADICIONAR ESTA LINHA - Reflexo de Combate também dá bônus no bloqueio
    if (vantagensSelecionadas.has('reflexoCombate')) bloqueio += 5;
    
    return Math.min(85, bloqueio);
}

function mapearPericiaArma(nome) {
    nome = nome.toLowerCase();
    if (nome.includes('espada') || nome.includes('adaga')) return 'espada';
    if (nome.includes('machado')) return 'machado';
    if (nome.includes('arco')) return 'arco';
    if (nome.includes('besta')) return 'besta';
    if (nome.includes('lança')) return 'armasHaste';
    return 'espada';
}
// ============================================
// CARGA
// ============================================
function calcularLimitesCarga() {
    const st = getSTFixo();
    return {
        leve: st * 2,
        medio: st * 4,
        pesado: st * 8,
        limite: st * 12
    };
}

function calcularCarga() {
    let pesoTotal = 0;
    if (inventario.corpo) {
        inventario.corpo.forEach(item => pesoTotal += (item.peso * (item.quantidade || 1)));
    }
    if (inventario.mochila) {
        inventario.mochila.forEach(item => pesoTotal += (item.peso * (item.quantidade || 1)));
    }
    
    const limites = calcularLimitesCarga();
    let nivel = 'leve';
    let penalidadeEsquiva = 0;
    let reducaoDeslocamento = 0;
    
    if (pesoTotal > limites.pesado) {
        nivel = 'limite';
        penalidadeEsquiva = 15;
        reducaoDeslocamento = 3;
    } else if (pesoTotal > limites.medio) {
        nivel = 'pesado';
        penalidadeEsquiva = 10;
        reducaoDeslocamento = 2;
    } else if (pesoTotal > limites.leve) {
        nivel = 'medio';
        penalidadeEsquiva = 5;
        reducaoDeslocamento = 1;
    }
    
    return {
        pesoTotal,
        nivel,
        penalidadeEsquiva,
        reducaoDeslocamento,
        limites
    };
}

// ============================================
// FUNÇÕES DE UTILIDADE
// ============================================
function showLoading() {
    if (elements.loadingOverlay) elements.loadingOverlay.classList.add('active');
}

function hideLoading() {
    if (elements.loadingOverlay) elements.loadingOverlay.classList.remove('active');
}

function setAutoSaveIndicator(state) {
    if (!elements.autoSaveIndicator) return;
    elements.autoSaveIndicator.className = 'auto-save-indicator';
    if (state === 'saving') {
        elements.autoSaveIndicator.classList.add('saving');
        elements.autoSaveIndicator.innerHTML = '<i class="fas fa-circle"></i><span>Salvando...</span>';
    } else if (state === 'saved') {
        elements.autoSaveIndicator.classList.add('saved');
        elements.autoSaveIndicator.innerHTML = '<i class="fas fa-circle"></i><span>Salvo</span>';
    } else {
        elements.autoSaveIndicator.innerHTML = '<i class="fas fa-circle" style="color: #ff6b6b;"></i><span>Erro</span>';
    }
}

function triggerAutoSave() {
    if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        if (auth.currentUser) salvarRascunho();
    }, 3000);
}

// ============================================
// BOLINHAS
// ============================================
function criarBolinhas(atributoId) {
    const container = document.getElementById(`${atributoId}Bolinhas`);
    if (!container) return;
    
    container.innerHTML = '';
    
    for (let i = 0; i < 15; i++) {
        const bolinha = document.createElement('div');
        bolinha.className = 'bolinha';
        bolinha.dataset.index = i;
        bolinha.dataset.atributo = atributoId;
        
        bolinha.addEventListener('click', () => {
            const clicada = i < atributos[atributoId].esferas;
            
            if (!clicada && esferasRestantes > 0) {
                atributos[atributoId].esferas++;
                esferasRestantes--;
            } else if (clicada) {
                atributos[atributoId].esferas--;
                esferasRestantes++;
            }
            
            atualizarInterface();
            atualizarBolinhas(atributoId);
            triggerAutoSave();
        });
        
        container.appendChild(bolinha);
    }
    
    atualizarBolinhas(atributoId);
}

function atualizarBolinhas(atributoId) {
    const container = document.getElementById(`${atributoId}Bolinhas`);
    if (!container) return;
    
    const bolinhas = container.children;
    const preenchidas = atributos[atributoId].esferas;
    
    for (let i = 0; i < bolinhas.length; i++) {
        if (i < preenchidas) {
            bolinhas[i].classList.add('preenchida');
        } else {
            bolinhas[i].classList.remove('preenchida');
        }
    }
}

// ============================================
// ATUALIZAR INTERFACE
// ============================================
function atualizarInterface() {
    if (elements.stValor) elements.stValor.textContent = getSTFixo();
    if (elements.stFixo) elements.stFixo.textContent = getSTFixo();
    if (elements.stPercentual) elements.stPercentual.textContent = getSTPercentual() + '%';
    
    if (elements.dxValor) elements.dxValor.textContent = getDXFixo();
    if (elements.dxFixo) elements.dxFixo.textContent = getDXFixo();
    if (elements.dxPercentual) elements.dxPercentual.textContent = getDXPercentual() + '%';
    
    if (elements.iqValor) elements.iqValor.textContent = getIQFixo();
    if (elements.iqFixo) elements.iqFixo.textContent = getIQFixo();
    if (elements.iqPercentual) elements.iqPercentual.textContent = getIQPercentual() + '%';
    
    if (elements.vigorValor) elements.vigorValor.textContent = getVIGORFixo();
    if (elements.vigorFixo) elements.vigorFixo.textContent = getVIGORFixo();
    if (elements.vigorPercentual) elements.vigorPercentual.textContent = getVIGORPercentual() + '%';
    
    if (elements.vtValor) elements.vtValor.textContent = getVTFixo();
    
    if (elements.esferasRestantesSpan) {
        elements.esferasRestantesSpan.textContent = esferasRestantes;
    }
    
    if (elements.nivelPersonagemSpan) {
        elements.nivelPersonagemSpan.textContent = calcularNivel();
    }
    
    const danoBase = calcularDanoBase();
    if (elements.stDano) elements.stDano.textContent = danoBase;
    if (elements.statusDano) elements.statusDano.textContent = danoBase;
    
    const pv = calcularPV();
    const pf = calcularPF();
    const pm = calcularPM();
    
    // ✅ ÚNICA LINHA ADICIONADA:
    console.log('PV calculado:', pv);
    
    if (elements.statusPV) elements.statusPV.textContent = pv;
    if (elements.statusPF) elements.statusPF.textContent = pf;
    if (elements.statusPM) elements.statusPM.textContent = pm;
    if (elements.combatePV) elements.combatePV.textContent = pv;
    if (elements.combatePF) elements.combatePF.textContent = pf;
    if (elements.combatePM) elements.combatePM.textContent = pm;
    
    if (elements.vtVida) elements.vtVida.textContent = `PV ${pv}`;
    
    if (elements.defesaEsquiva) {
        elements.defesaEsquiva.textContent = calcularEsquiva() + '%';
    }
    if (elements.defesaAparar) {
        elements.defesaAparar.textContent = calcularAparar() + '%';
    }
    if (elements.defesaBloqueio) {
        elements.defesaBloqueio.textContent = calcularBloqueio() + '%';
    }
    
    const desloc = calcularDeslocamento();
    const carga = calcularCarga();
    const andarFinal = Math.max(1, desloc.andar - carga.reducaoDeslocamento);
    const correrFinal = Math.max(3, desloc.correr - (carga.reducaoDeslocamento * 3));
    
    if (elements.deslocamentoAndar) {
        elements.deslocamentoAndar.textContent = andarFinal.toFixed(1);
    }
    if (elements.deslocamentoCorrer) {
        elements.deslocamentoCorrer.textContent = correrFinal.toFixed(1);
    }
    
    if (elements.cargaAtual) {
        elements.cargaAtual.textContent = carga.pesoTotal.toFixed(1);
    }
    if (elements.cargaLimite) {
        elements.cargaLimite.textContent = carga.limites.limite;
    }
    if (elements.cargaBarra) {
        const percentual = (carga.pesoTotal / carga.limites.limite) * 100;
        elements.cargaBarra.style.width = Math.min(100, percentual) + '%';
    }
    if (elements.cargaNivel) {
        elements.cargaNivel.textContent = carga.nivel.charAt(0).toUpperCase() + carga.nivel.slice(1);
        elements.cargaNivel.className = `carga-nivel ${carga.nivel}`;
    }
    
    atualizarArmaEquipada();
    calcularRD();
    atualizarContadoresAbas();
}

function atualizarArmaEquipada() {
    if (!elements.armaNome || !elements.armaDano) return;
    
    let arma = null;
    if (inventario.corpo && inventario.corpo.length > 0) {
        inventario.corpo.forEach(item => {
            if (item.dano) arma = item;
        });
    }
    
    if (arma) {
        elements.armaNome.textContent = arma.nome;
        elements.armaDano.textContent = arma.dano;
    } else {
        elements.armaNome.textContent = 'Nenhuma';
        elements.armaDano.textContent = '-';
    }
}

function calcularRD() {
    let rd = 0;
    if (inventario.corpo && inventario.corpo.length > 0) {
        inventario.corpo.forEach(item => {
            if (item.rd) rd += item.rd;
        });
    }
    if (elements.rdTotal) elements.rdTotal.textContent = rd;
    return rd;
}
// ============================================
// FUNÇÕES DAS TABELAS DE ITENS
// ============================================
function renderizarTabelas(tab = 'armas_ca') {
    document.querySelectorAll('.tabela-item').forEach(t => t.classList.remove('ativa'));
    
    const mapaTabelas = {
        'armas_ca': 'tabelaArmasCA',
        'armas_dist': 'tabelaArmasDist',
        'armaduras': 'tabelaArmaduras',
        'escudos': 'tabelaEscudos',
        'itens_gerais': 'tabelaItensGerais'
    };
    
    const tabelaId = mapaTabelas[tab];
    const tabelaElement = document.getElementById(tabelaId);
    if (tabelaElement) tabelaElement.classList.add('ativa');
    
    renderizarTabelaArmasCA();
    renderizarTabelaArmasDist();
    renderizarTabelaArmaduras();
    renderizarTabelaEscudos();
    renderizarTabelaItensGerais();
    
    adicionarEventosCompra();
}

function renderizarTabelaArmasCA() {
    const tbody = elements.corpoTabelaArmasCA;
    if (!tbody) return;
    
    let html = '';
    catalogoItensData.armas_ca.forEach((item, i) => {
        html += `
            <tr>
                <td>${item.nome}</td>
                <td>${item.alcance}</td>
                <td>${item.dano}</td>
                <td>${item.preco}</td>
                <td>${item.peso}</td>
                <td>${item.st}</td>
                <td>
                    <button class="btn-comprar-tabela" data-tipo="armas_ca" data-indice="${i}">
                        <i class="fas fa-cart-plus"></i> Comprar
                    </button>
                </td>
            </tr>
        `;
    });
    tbody.innerHTML = html;
}

function renderizarTabelaArmasDist() {
    const tbody = elements.corpoTabelaArmasDist;
    if (!tbody) return;
    
    let html = '';
    catalogoItensData.armas_dist.forEach((item, i) => {
        html += `
            <tr>
                <td>${item.nome}</td>
                <td>+${item.precisao}</td>
                <td>${item.dano}</td>
                <td>${item.alcance}</td>
                <td>${item.preco}</td>
                <td>${item.peso}</td>
                <td>${item.st}</td>
                <td>
                    <button class="btn-comprar-tabela" data-tipo="armas_dist" data-indice="${i}">
                        <i class="fas fa-cart-plus"></i> Comprar
                    </button>
                </td>
            </tr>
        `;
    });
    tbody.innerHTML = html;
}

function renderizarTabelaArmaduras() {
    const tbody = elements.corpoTabelaArmaduras;
    if (!tbody) return;
    
    let html = '';
    catalogoItensData.armaduras.forEach((item, i) => {
        html += `
            <tr>
                <td>${item.nome}</td>
                <td>${item.rd}</td>
                <td>${item.preco}</td>
                <td>${item.peso}</td>
                <td>
                    <button class="btn-comprar-tabela" data-tipo="armaduras" data-indice="${i}">
                        <i class="fas fa-cart-plus"></i> Comprar
                    </button>
                </td>
            </tr>
        `;
    });
    tbody.innerHTML = html;
}

function renderizarTabelaEscudos() {
    const tbody = elements.corpoTabelaEscudos;
    if (!tbody) return;
    
    let html = '';
    catalogoItensData.escudos.forEach((item, i) => {
        html += `
            <tr>
                <td>${item.nome}</td>
                <td>+${item.bonus}</td>
                <td>${item.ve}</td>
                <td>${item.preco}</td>
                <td>${item.peso}</td>
                <td>
                    <button class="btn-comprar-tabela" data-tipo="escudos" data-indice="${i}">
                        <i class="fas fa-cart-plus"></i> Comprar
                    </button>
                </td>
            </tr>
        `;
    });
    tbody.innerHTML = html;
}

function renderizarTabelaItensGerais() {
    const tbody = elements.corpoTabelaItensGerais;
    if (!tbody) return;
    
    let html = '';
    catalogoItensData.itens_gerais.forEach((item, i) => {
        html += `
            <tr>
                <td>${item.nome}</td>
                <td>${item.especificacao || ''}</td>
                <td>${item.preco}</td>
                <td>${item.peso}</td>
                <td>
                    <button class="btn-comprar-tabela" data-tipo="itens_gerais" data-indice="${i}">
                        <i class="fas fa-cart-plus"></i> Comprar
                    </button>
                </td>
            </tr>
        `;
    });
    tbody.innerHTML = html;
}

function adicionarEventosCompra() {
    document.querySelectorAll('.btn-comprar-tabela').forEach(btn => {
        btn.removeEventListener('click', comprarItemHandler);
        btn.addEventListener('click', comprarItemHandler);
    });
}

function comprarItemHandler(e) {
    e.stopPropagation();
    
    const btn = e.currentTarget;
    const tipo = btn.dataset.tipo;
    const indice = parseInt(btn.dataset.indice);
    
    let item = null;
    if (tipo === 'armas_ca') item = catalogoItensData.armas_ca[indice];
    else if (tipo === 'armas_dist') item = catalogoItensData.armas_dist[indice];
    else if (tipo === 'armaduras') item = catalogoItensData.armaduras[indice];
    else if (tipo === 'escudos') item = catalogoItensData.escudos[indice];
    else if (tipo === 'itens_gerais') item = catalogoItensData.itens_gerais[indice];
    
    if (item) {
        comprarItem(item);
        triggerAutoSave();
    }
}

function comprarItem(item) {
    const preco = item.preco;
    
    if (dinheiro < preco) {
        alert(`Dinheiro insuficiente! Você tem $${dinheiro} e o item custa $${preco}`);
        return;
    }
    
    dinheiro -= preco;
    atualizarDinheiroDisplay();
    
    const novoItem = {
        ...item,
        id: item.id + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        quantidade: 1
    };
    
    if (!inventario.deposito) inventario.deposito = [];
    inventario.deposito.push(novoItem);
    
    renderizarInventario();
}

// ============================================
// INVENTÁRIO
// ============================================
function renderizarInventario() {
    if (!elements.inventarioCorpo) return;
    
    const renderizarItens = (itens, local) => {
        if (!itens || itens.length === 0) {
            return '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Vazio</div>';
        }
        
        return itens.map(item => `
            <div class="item-card" data-item-id="${item.id}" data-local="${local}">
                <div class="item-nome">
                    ${item.nome}
                    ${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}
                </div>
                <div class="item-detalhes">
                    <span class="item-peso">${(item.peso * (item.quantidade || 1)).toFixed(1)} kg</span>
                    <span class="item-preco">${item.preco} $</span>
                </div>
                <div class="item-acoes">
                    ${local !== 'deposito' ? `<button class="item-acao btn-mover-deposito" title="Mover para Depósito"><i class="fas fa-arrow-right"></i></button>` : ''}
                    ${local === 'mochila' ? `<button class="item-acao btn-equipar" title="Equipar"><i class="fas fa-user"></i></button>` : ''}
                    ${local === 'corpo' ? `<button class="item-acao btn-guardar" title="Guardar na Mochila"><i class="fas fa-shopping-bag"></i></button>` : ''}
                    ${local === 'deposito' ? `<button class="item-acao btn-pegar" title="Pegar"><i class="fas fa-arrow-left"></i></button>` : ''}
                    <button class="item-acao btn-vender" title="Vender (50%)"><i class="fas fa-coins"></i></button>
                    <button class="item-acao btn-descartar" title="Descartar"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');
    };
    
    elements.inventarioCorpo.innerHTML = renderizarItens(inventario.corpo, 'corpo');
    elements.inventarioMochila.innerHTML = renderizarItens(inventario.mochila, 'mochila');
    elements.inventarioDeposito.innerHTML = renderizarItens(inventario.deposito, 'deposito');
    
    document.querySelectorAll('.btn-mover-deposito').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = e.target.closest('.item-card');
            if (card) moverParaDeposito(card.dataset.itemId, card.dataset.local);
        });
    });
    
    document.querySelectorAll('.btn-equipar').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = e.target.closest('.item-card');
            if (card) equiparItem(card.dataset.itemId);
        });
    });
    
    document.querySelectorAll('.btn-guardar').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = e.target.closest('.item-card');
            if (card) guardarItem(card.dataset.itemId);
        });
    });
    
    document.querySelectorAll('.btn-pegar').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = e.target.closest('.item-card');
            if (card) pegarItem(card.dataset.itemId);
        });
    });
    
    document.querySelectorAll('.btn-vender').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = e.target.closest('.item-card');
            if (card) venderItem(card.dataset.itemId, card.dataset.local);
        });
    });
    
    document.querySelectorAll('.btn-descartar').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = e.target.closest('.item-card');
            if (card) descartarItem(card.dataset.itemId, card.dataset.local);
        });
    });
}

function moverParaDeposito(itemId, local) {
    if (!inventario[local]) return;
    const index = inventario[local].findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario[local][index];
        if (!inventario.deposito) inventario.deposito = [];
        inventario.deposito.push(item);
        inventario[local].splice(index, 1);
        renderizarInventario();
        atualizarInterface();
        triggerAutoSave();
    }
}

function equiparItem(itemId) {
    if (!inventario.mochila) return;
    const index = inventario.mochila.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario.mochila[index];
        if (item.st && getSTFixo() < item.st) {
            alert(`Força insuficiente! Precisa de ST ${item.st}`);
            return;
        }
        if (!inventario.corpo) inventario.corpo = [];
        inventario.corpo.push(item);
        inventario.mochila.splice(index, 1);
        renderizarInventario();
        atualizarInterface();
        triggerAutoSave();
    }
}

function guardarItem(itemId) {
    if (!inventario.corpo) return;
    const index = inventario.corpo.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario.corpo[index];
        if (!inventario.mochila) inventario.mochila = [];
        inventario.mochila.push(item);
        inventario.corpo.splice(index, 1);
        renderizarInventario();
        atualizarInterface();
        triggerAutoSave();
    }
}

function pegarItem(itemId) {
    if (!inventario.deposito) return;
    const index = inventario.deposito.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario.deposito[index];
        if (!inventario.mochila) inventario.mochila = [];
        inventario.mochila.push(item);
        inventario.deposito.splice(index, 1);
        renderizarInventario();
        atualizarInterface();
        triggerAutoSave();
    }
}

function venderItem(itemId, local) {
    if (!inventario[local]) return;
    const index = inventario[local].findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario[local][index];
        const valorVenda = Math.floor(item.preco * 0.5 * (item.quantidade || 1));
        dinheiro += valorVenda;
        atualizarDinheiroDisplay();
        
        if (item.quantidade > 1) {
            item.quantidade--;
        } else {
            inventario[local].splice(index, 1);
        }
        
        renderizarInventario();
        atualizarInterface();
        triggerAutoSave();
    }
}

function descartarItem(itemId, local) {
    if (!inventario[local]) return;
    const index = inventario[local].findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = inventario[local][index];
        if (item.quantidade > 1) {
            item.quantidade--;
        } else {
            inventario[local].splice(index, 1);
        }
        renderizarInventario();
        atualizarInterface();
        triggerAutoSave();
    }
}

// ============================================
// PERÍCIAS
// ============================================
function renderizarCatalogoPericias(filtro = 'todas') {
    if (!elements.listaPericias) return;
    
    const periciasFiltradas = catalogoPericias.filter(p => filtro === 'todas' || p.tipo === filtro);
    
    elements.listaPericias.innerHTML = periciasFiltradas.map(pericia => `
        <div class="pericia-card" data-pericia-id="${pericia.id}">
            <h4>${pericia.nome} <span class="tipo ${pericia.tipo}">${pericia.tipo === 'mental' ? 'IQ' : 'DX'}</span></h4>
            <div class="descricao">Base: ${pericia.atributo.toUpperCase()}%</div>
            <div class="atributo">Bônus: +4% por nível</div>
        </div>
    `).join('');
    
    document.querySelectorAll('.pericia-card').forEach(card => {
        card.addEventListener('click', () => abrirModalPericia(card.dataset.periciaId));
    });
}

function renderizarPericiasAdquiridas() {
    if (!elements.listaPericiasAdquiridas) return;
    
    const periciasArray = Object.entries(pericias);
    
    if (periciasArray.length === 0) {
        elements.listaPericiasAdquiridas.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Clique em uma perícia do catálogo para adicionar</div>';
        return;
    }
    
    elements.listaPericiasAdquiridas.innerHTML = periciasArray.map(([id, dados]) => {
        const pericia = catalogoPericias.find(p => p.id === id);
        if (!pericia) return '';
        
        const bonus = (dados.nivel || 0) * 4;
        let atributoBase = 0;
        
        if (pericia.atributo === 'dx') atributoBase = getDXPercentual();
        else if (pericia.atributo === 'iq') atributoBase = getIQPercentual();
        
        const bonusExtra = getBonusPericia(id);
        const nh = atributoBase + bonus + bonusExtra;
        
        return `
            <div class="pericia-adquirida" data-pericia-id="${id}">
                <div class="pericia-adquirida-info">
                    <h4>${pericia.nome}</h4>
                    <div class="nivel">Nível ${dados.nivel} <span class="bonus">(+${bonus}%)</span></div>
                    <div class="nh">NH: <span>${nh}%</span> (${pericia.atributo.toUpperCase()} ${atributoBase}% + ${bonus}%${bonusExtra > 0 ? ` + ${bonusExtra}%` : ''})</div>
                </div>
                <div class="pericia-adquirida-acoes">
                    <button class="btn-pericia btn-aumentar-pericia" data-pericia-id="${id}" ${dados.nivel >= 5 ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
                    <button class="btn-pericia btn-diminuir-pericia" data-pericia-id="${id}" ${dados.nivel <= 1 ? 'disabled' : ''}><i class="fas fa-minus"></i></button>
                </div>
            </div>
        `;
    }).join('');
    
    document.querySelectorAll('.btn-aumentar-pericia').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            aumentarPericia(btn.dataset.periciaId);
        });
    });
    
    document.querySelectorAll('.btn-diminuir-pericia').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            diminuirPericia(btn.dataset.periciaId);
        });
    });
}

function calcularCustoPericia(nivel) {
    return nivel * 5;
}

function abrirModalPericia(periciaId) {
    const pericia = catalogoPericias.find(p => p.id === periciaId);
    if (!pericia) return;
    
    const periciaExistente = pericias[periciaId];
    const nivelAtual = periciaExistente?.nivel || 0;
    
    periciaAtual = {
        id: periciaId,
        nome: pericia.nome,
        nivelAtual: nivelAtual,
        novoNivel: nivelAtual + 1 || 1
    };
    
    if (elements.modalPericiaNome) elements.modalPericiaNome.textContent = pericia.nome;
    if (elements.modalPericiaNivel) elements.modalPericiaNivel.textContent = periciaAtual.novoNivel;
    
    atualizarModalPericia();
    
    if (elements.modalPericia) elements.modalPericia.classList.add('active');
}

function atualizarModalPericia() {
    if (!periciaAtual) return;
    
    const novoNivel = periciaAtual.novoNivel;
    const nivelAtual = periciaAtual.nivelAtual;
    const custoTotal = calcularCustoPericia(novoNivel);
    const custoAtual = nivelAtual > 0 ? calcularCustoPericia(nivelAtual) : 0;
    const custoDiferenca = custoTotal - custoAtual;
    
    if (elements.modalPericiaCusto) elements.modalPericiaCusto.textContent = custoDiferenca + ' PP';
    
    if (elements.modalPericiaConfirmar) {
        elements.modalPericiaConfirmar.disabled = custoDiferenca > (ppDisponivel - ppGastoTotal);
    }
    
    if (elements.modalPericiaMenos) {
        elements.modalPericiaMenos.disabled = novoNivel <= (nivelAtual > 0 ? nivelAtual + 1 : 1);
    }
    if (elements.modalPericiaMais) {
        elements.modalPericiaMais.disabled = novoNivel >= 5;
    }
}

function confirmarPericia() {
    if (!periciaAtual) return;
    
    const periciaId = periciaAtual.id;
    const novoNivel = periciaAtual.novoNivel;
    const nivelAtual = periciaAtual.nivelAtual;
    const custoTotal = calcularCustoPericia(novoNivel);
    const custoAtual = nivelAtual > 0 ? calcularCustoPericia(nivelAtual) : 0;
    const custoDiferenca = custoTotal - custoAtual;
    
    if (custoDiferenca > (ppDisponivel - ppGastoTotal)) {
        alert('PP insuficiente!');
        return;
    }
    
    ppGastoTotal += custoDiferenca;
    pericias[periciaId] = { nivel: novoNivel };
    
    if (elements.ppGasto) elements.ppGasto.textContent = ppGastoTotal;
    if (elements.ppRestante) elements.ppRestante.textContent = ppDisponivel - ppGastoTotal;
    
    renderizarPericiasAdquiridas();
    atualizarContadoresAbas();
    
    if (elements.modalPericia) elements.modalPericia.classList.remove('active');
    
    atualizarInterface();
    triggerAutoSave();
}

function aumentarPericia(periciaId) {
    const pericia = pericias[periciaId];
    if (!pericia) return;
    
    const novoNivel = pericia.nivel + 1;
    if (novoNivel > 5) return;
    
    const custoAtual = calcularCustoPericia(pericia.nivel);
    const custoNovo = calcularCustoPericia(novoNivel);
    const custoDiferenca = custoNovo - custoAtual;
    
    if (custoDiferenca > (ppDisponivel - ppGastoTotal)) {
        alert('PP insuficiente!');
        return;
    }
    
    ppGastoTotal += custoDiferenca;
    pericia.nivel = novoNivel;
    
    if (elements.ppGasto) elements.ppGasto.textContent = ppGastoTotal;
    if (elements.ppRestante) elements.ppRestante.textContent = ppDisponivel - ppGastoTotal;
    
    renderizarPericiasAdquiridas();
    atualizarContadoresAbas();
    atualizarInterface();
    triggerAutoSave();
}

function diminuirPericia(periciaId) {
    const pericia = pericias[periciaId];
    if (!pericia) return;
    
    const novoNivel = pericia.nivel - 1;
    if (novoNivel < 1) return;
    
    const custoAtual = calcularCustoPericia(pericia.nivel);
    const custoNovo = calcularCustoPericia(novoNivel);
    const custoDiferenca = custoAtual - custoNovo;
    
    ppGastoTotal -= custoDiferenca;
    
    if (novoNivel === 0) {
        delete pericias[periciaId];
    } else {
        pericia.nivel = novoNivel;
    }
    
    if (elements.ppGasto) elements.ppGasto.textContent = ppGastoTotal;
    if (elements.ppRestante) elements.ppRestante.textContent = ppDisponivel - ppGastoTotal;
    
    renderizarPericiasAdquiridas();
    atualizarContadoresAbas();
    atualizarInterface();
    triggerAutoSave();
}

// ============================================
// MAGIAS
// ============================================
function renderizarEsferas() {
    if (!elements.esferasGrid) return;
    
    const magiasLista = Object.entries(escolas.agua.magias).sort((a, b) => a[1].ordem - b[1].ordem);
    const temAptidao = vantagensSelecionadas.has('aptidaoMagica');
    const magiasDesbloqueadas = Object.values(escolas.agua.magias).filter(m => m.desbloqueada).length;
    
    let html = '';
    
    magiasLista.forEach(([id, magia], index) => {
        const numero = index + 1;
        const magiaDados = dadosMagias[id] || { nome: id, tipo: '', icone: 'fa-magic' };
        let classeEsfera = 'trancada';
        let iconeCadeado = '<i class="fas fa-lock" style="color: #666;"></i>';
        let botaoAcao = '';
        
        if (magia.desbloqueada) {
            classeEsfera = 'desbloqueada';
            iconeCadeado = '';
        } else if (temAptidao && numero <= magiasDesbloqueadas + 1) {
            classeEsfera = 'disponivel';
            iconeCadeado = '';
            botaoAcao = `<button class="btn-comprar-esfera" data-magia-id="${id}">Desbloquear (2 PP)</button>`;
        } else if (!temAptidao) {
            classeEsfera = 'aptidao-requerida';
        }
        
        let nhMagia = 0;
        if (magia.desbloqueada) {
            nhMagia = getIQPercentual() + 10 + (magia.nivel || 0);
        }
        
        html += `
            <div class="esfera-card ${classeEsfera}" data-magia-id="${id}">
                <div class="numero-esfera">${numero}</div>
                <div class="icone-esfera"><i class="fas ${magiaDados.icone}"></i></div>
                ${iconeCadeado}
                <div class="nome-esfera">${magiaDados.nome}</div>
                <div class="tipo-esfera">${magiaDados.tipo}</div>
                ${magia.desbloqueada ? `<div class="nivel-esfera">Nível ${magia.nivel} <button class="btn-detalhe" data-magia-id="${id}"><i class="fas fa-search"></i></button> | ${nhMagia}%</div>` : ''}
                ${botaoAcao}
            </div>
        `;
    });
    
    elements.esferasGrid.innerHTML = html;
    
    document.querySelectorAll('.btn-comprar-esfera').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const magiaId = btn.dataset.magiaId;
            const custo = 2;
            
            if (custo > (ppDisponivel - ppGastoTotal)) {
                alert('PP insuficiente!');
                return;
            }
            
            ppGastoTotal += custo;
            escolas.agua.magias[magiaId].desbloqueada = true;
            escolas.agua.magias[magiaId].nivel = 1;
            
            if (elements.ppGasto) elements.ppGasto.textContent = ppGastoTotal;
            if (elements.ppRestante) elements.ppRestante.textContent = ppDisponivel - ppGastoTotal;
            
            atualizarContadoresAbas();
            renderizarEsferas();
            triggerAutoSave();
        });
    });
    
    document.querySelectorAll('.btn-detalhe, .esfera-card.desbloqueada').forEach(el => {
        el.addEventListener('click', (e) => {
            if (e.target.closest('.btn-comprar-esfera')) return;
            const magiaId = el.closest('.esfera-card')?.dataset.magiaId || el.dataset.magiaId;
            if (magiaId && escolas.agua.magias[magiaId]?.desbloqueada) {
                abrirDetalheMagia(magiaId);
            }
        });
    });
}

function abrirDetalheMagia(magiaId) {
    const magia = escolas.agua.magias[magiaId];
    const magiaDados = dadosMagias[magiaId];
    if (!magia || !magiaDados) return;
    
    magiaSelecionada = magiaId;
    
    if (elements.detalheMagiaTitulo) elements.detalheMagiaTitulo.textContent = magiaDados.nome;
    
    const iqPercentual = getIQPercentual();
    const nhBase = iqPercentual + 10;
    const nhAtual = nhBase + (magia.nivel || 0);
    
    if (elements.detalheMagiaNH) elements.detalheMagiaNH.textContent = nhAtual + '%';
    
    let linhas = '';
    for (let i = 1; i <= 10; i++) {
        const classe = i === magia.nivel ? 'nivel-atual' : '';
        const efeito = magiaDados.efeitos[i] || '-';
        const nhNivel = nhBase + i;
        linhas += `<tr class="${classe}"><td>${i}</td><td>${efeito}</td><td>${nhNivel}%</td></tr>`;
    }
    
    if (elements.corpoTabelaDetalhe) {
        elements.corpoTabelaDetalhe.innerHTML = linhas;
    }
    
    const custoProximoNivel = magia.nivel >= 10 ? 0 : 2;
    if (elements.comprarNivelMagia) {
        elements.comprarNivelMagia.disabled = magia.nivel >= 10 || (custoProximoNivel > (ppDisponivel - ppGastoTotal));
        elements.comprarNivelMagia.textContent = magia.nivel >= 10 ? 'Nível Máximo' : `Comprar Nível ${magia.nivel + 1} (${custoProximoNivel} PP)`;
    }
    
    if (elements.detalheMagiaModal) elements.detalheMagiaModal.classList.add('active');
}

// ============================================
// VANTAGENS E DESVANTAGENS
// ============================================
function selecionarVantagem(card) {
    const vantagemId = card.dataset.vantagem;
    
    if (vantagensSelecionadas.has(vantagemId)) {
        vantagensSelecionadas.delete(vantagemId);
        card.classList.remove('selecionada');
    } else {
        if (vantagensSelecionadas.size < 3) {
            vantagensSelecionadas.add(vantagemId);
            card.classList.add('selecionada');
        } else {
            alert('Você já selecionou 3 vantagens!');
            return;
        }
    }
    
    if (vantagemId === 'rico' || vantagemId === 'pobre') {
        dinheiro = calcularDinheiroInicial();
        atualizarDinheiroDisplay();
    }
    
    if (vantagemId === 'aptidaoMagica') {
        renderizarEsferas();
    }
    
    atualizarContadoresAbas();
    atualizarInterface();
    triggerAutoSave();
}

function selecionarDesvantagem(card) {
    const desvantagemId = card.dataset.desvantagem;
    
    if (desvantagensSelecionadas.has(desvantagemId)) {
        desvantagensSelecionadas.delete(desvantagemId);
        card.classList.remove('selecionada');
    } else {
        if (desvantagensSelecionadas.size < 4) {
            desvantagensSelecionadas.add(desvantagemId);
            card.classList.add('selecionada');
        } else {
            alert('Você já selecionou 4 desvantagens!');
            return;
        }
    }
    
    if (desvantagemId === 'pobre' || desvantagemId === 'rico') {
        dinheiro = calcularDinheiroInicial();
        atualizarDinheiroDisplay();
    }
    
    atualizarContadoresAbas();
    atualizarInterface();
    triggerAutoSave();
}

// ============================================
// DINHEIRO
// ============================================
function calcularDinheiroInicial() {
    const base = parseInt(elements.dinheiroBaseInput?.value) || 1000;
    
    if (desvantagensSelecionadas.has('pobre')) {
        return Math.floor(base / 2);
    } else if (vantagensSelecionadas.has('rico')) {
        return base * 5;
    }
    
    return base;
}

function atualizarDinheiroDisplay() {
    if (elements.dinheiroSaldo) elements.dinheiroSaldo.textContent = dinheiro;
}

// ============================================
// CONTADORES
// ============================================
function atualizarContadoresAbas() {
    if (elements.contadorVantagensAba) {
        elements.contadorVantagensAba.textContent = `${vantagensSelecionadas.size}/3`;
    }
    if (elements.contadorDesvantagensAba) {
        elements.contadorDesvantagensAba.textContent = `${desvantagensSelecionadas.size}/4`;
    }
    if (elements.contadorVantagensSpan) {
        elements.contadorVantagensSpan.textContent = `${vantagensSelecionadas.size}/3`;
    }
    if (elements.contadorDesvantagensSpan) {
        elements.contadorDesvantagensSpan.textContent = `${desvantagensSelecionadas.size}/4`;
    }
    if (elements.contadorPericiasAba) {
        elements.contadorPericiasAba.textContent = `${ppGastoTotal} PP`;
    }
    
    const magiasDesbloqueadas = Object.values(escolas.agua.magias).filter(m => m.desbloqueada).length;
    if (elements.contadorMagiasAba) {
        elements.contadorMagiasAba.textContent = `${magiasDesbloqueadas}/10`;
    }
    
    if (elements.ppGasto) elements.ppGasto.textContent = ppGastoTotal;
    if (elements.ppRestante) elements.ppRestante.textContent = ppDisponivel - ppGastoTotal;
    
    atualizarDinheiroDisplay();
}

// ============================================
// NAVEGAÇÃO ENTRE ABAS
// ============================================
function mudarAba(abaId) {
    elements.abas.forEach(aba => {
        if (aba.dataset.aba === abaId) {
            aba.classList.add('ativa');
        } else {
            aba.classList.remove('ativa');
        }
    });
    
    elements.conteudos.forEach(conteudo => {
        const conteudoId = `aba${abaId.charAt(0).toUpperCase() + abaId.slice(1)}`;
        if (conteudo.id === conteudoId) {
            conteudo.classList.add('ativa');
        } else {
            conteudo.classList.remove('ativa');
        }
    });
    
    abaAtual = abaId;
    
    if (abaId === 'pericias') {
        renderizarCatalogoPericias('todas');
        renderizarPericiasAdquiridas();
    } else if (abaId === 'magias') {
        renderizarEsferas();
    } else if (abaId === 'equipamentos') {
        atualizarDinheiroDisplay();
        renderizarInventario();
        renderizarTabelas('armas_ca');
    } else if (abaId === 'combate') {
        atualizarInterface();
    }
}

// ============================================
// FUNÇÕES DE COLETA DE DADOS
// ============================================
function coletarDadosBasicos() {
    return {
        nome: document.getElementById('nomePersonagem')?.value || '',
        classe: document.getElementById('classePersonagem')?.value || 'guerreiro',
        idade: parseInt(document.getElementById('idadePersonagem')?.value) || 25,
        altura: parseInt(document.getElementById('alturaPersonagem')?.value) || 170,
        peso: parseFloat(document.getElementById('pesoPersonagem')?.value) || 70,
        aparencia: document.getElementById('aparencia')?.value || 'normal',
        riqueza: document.getElementById('riqueza')?.value || 'medio',
        dinheiroBase: parseInt(elements.dinheiroBaseInput?.value) || 1000,
        peculiaridades: document.getElementById('peculiaridades')?.value || '',
        fotoURL: elements.previewImage?.src || ''
    };
}

function salvarDadosBasicos() {
    const dados = coletarDadosBasicos();
    
    if (!personagemId && dinheiro === 0) {
        dinheiro = calcularDinheiroInicial();
    }
    
    personagemTemp = {
        ...dados,
        esferasIniciais: esferasIniciais,
        atributos: {
            st: { esferas: atributos.st.esferas },
            dx: { esferas: atributos.dx.esferas },
            iq: { esferas: atributos.iq.esferas },
            vigor: { esferas: atributos.vigor.esferas },
            vt: { esferas: atributos.vt.esferas }
        },
        inventario: inventario,
        dinheiro: dinheiro,
        vantagens: Array.from(vantagensSelecionadas),
        desvantagens: Array.from(desvantagensSelecionadas),
        fobia: fobiaSelecionada,
        pericias: pericias,
        ppDisponivel: ppDisponivel,
        ppGasto: ppGastoTotal,
        escolas: escolas
    };
    
    sessionStorage.setItem('personagemTemp', JSON.stringify(personagemTemp));
    return personagemTemp;
}

// ============================================
// FUNÇÃO DE SALVAMENTO
// ============================================
async function salvarPersonagem(finalizar = false) {
    try {
        setAutoSaveIndicator('saving');
        
        const user = auth.currentUser;
        if (!user) {
            alert('Usuário não autenticado!');
            window.location.href = 'index.html';
            return false;
        }
        
        const dadosBasicos = coletarDadosBasicos();
        if (!dadosBasicos.nome.trim()) {
            alert('Digite um nome para o personagem');
            setAutoSaveIndicator('error');
            return false;
        }
        
        let fotoURL = dadosBasicos.fotoURL || '';
        if (fotoURL && fotoURL.startsWith('data:image')) {
            const imagemUrl = await uploadParaImgur(fotoURL);
            if (imagemUrl) fotoURL = imagemUrl;
        }
        
        const personagemData = {
            nome: dadosBasicos.nome,
            classe: dadosBasicos.classe,
            idade: dadosBasicos.idade,
            altura: dadosBasicos.altura,
            peso: dadosBasicos.peso,
            aparencia: dadosBasicos.aparencia,
            riqueza: dadosBasicos.riqueza,
            dinheiroBase: dadosBasicos.dinheiroBase,
            peculiaridades: dadosBasicos.peculiaridades || '',
            fotoURL: fotoURL,
            userId: user.uid,
            status: finalizar ? 'finalizado' : 'rascunho',
            updatedAt: new Date(),
            esferasIniciais: esferasIniciais,
            atributos: {
                st: { esferas: atributos.st.esferas },
                dx: { esferas: atributos.dx.esferas },
                iq: { esferas: atributos.iq.esferas },
                vigor: { esferas: atributos.vigor.esferas },
                vt: { esferas: atributos.vt.esferas }
            },
            statusCombate: {
                vidaAtual: calcularPV(),
                vidaMax: calcularPV(),
                fadigaAtual: calcularPF(),
                fadigaMax: calcularPF(),
                manaAtual: calcularPM(),
                manaMax: calcularPM()
            },
            derivados: {
                danoBase: calcularDanoBase(),
                esquiva: calcularEsquiva(),
                aparar: calcularAparar(),
                bloqueio: calcularBloqueio(),
                deslocamento: calcularDeslocamento().andar.toFixed(1) + 'm / ' + calcularDeslocamento().correr.toFixed(1) + 'm',
                resistenciaMagia: getResistenciaMagia()
            },
            vantagens: Array.from(vantagensSelecionadas),
            desvantagens: Array.from(desvantagensSelecionadas),
            fobia: fobiaSelecionada,
            pericias: pericias,
            escolas: escolas,
            ppDisponivel: ppDisponivel,
            ppGasto: ppGastoTotal,
            inventario: inventario,
            dinheiro: dinheiro
        };
        
        if (!personagemId) {
            personagemData.createdAt = new Date();
        }
        
        let docRef;
        if (personagemId) {
            docRef = doc(db, "personagens", personagemId);
            await updateDoc(docRef, personagemData);
            console.log('Personagem atualizado com sucesso!');
        } else {
            docRef = doc(collection(db, "personagens"));
            personagemId = docRef.id;
            personagemData.id = personagemId;
            await setDoc(docRef, personagemData);
            console.log('Personagem criado com sucesso!');
        }
        
        setAutoSaveIndicator('saved');
        
        if (elements.personagemIdHidden) elements.personagemIdHidden.value = personagemId;
        if (elements.breadcrumbCurrent) elements.breadcrumbCurrent.textContent = `Editando: ${dadosBasicos.nome}`;
        if (elements.pageTitle) elements.pageTitle.textContent = `Editando: ${dadosBasicos.nome}`;
        
        if (personagemTemp) {
            personagemTemp.fotoURL = fotoURL;
            sessionStorage.setItem('personagemTemp', JSON.stringify(personagemTemp));
        }
        
        if (finalizar && elements.modalSalvarSucesso) {
            elements.modalSalvarSucesso.style.display = 'flex';
        }
        
        return true;
        
    } catch (error) {
        console.error('ERRO DETALHADO:', error);
        setAutoSaveIndicator('error');
        alert('Erro ao salvar: ' + error.message);
        return false;
    }
}

async function salvarRascunho() {
    if (!auth.currentUser) return;
    await salvarPersonagem(false);
}

// ============================================
// EXPORTAÇÃO PDF (MELHORADA)
// ============================================
async function exportarPDF() {
    try {
        showLoading();
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
        
        let yPos = 20;
        const marginLeft = 20;
        const marginRight = 190;
        const pageHeight = 297;
        
        pdf.setFontSize(22);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Ficha de Personagem - RPGForce', 105, yPos, { align: 'center' });
        
        yPos += 10;
        pdf.setDrawColor(0, 0, 0);
        pdf.setLineWidth(0.5);
        pdf.line(marginLeft, yPos, marginRight, yPos);
        yPos += 10;
        
        const nome = document.getElementById('nomePersonagem')?.value || 'Sem nome';
        const classe = document.getElementById('classePersonagem')?.value || 'guerreiro';
        const classes = { guerreiro: 'Guerreiro', mago: 'Mago', ladino: 'Ladino', clerigo: 'Clérigo', barbaro: 'Bárbaro' };
        
        pdf.setFontSize(14);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Dados Básicos', marginLeft, yPos);
        yPos += 7;
        
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        pdf.setTextColor(0, 0, 0);
        
        pdf.text(`Nome: ${nome}`, marginLeft, yPos);
        pdf.text(`Classe: ${classes[classe] || classe}`, marginLeft + 80, yPos);
        yPos += 6;
        
        pdf.text(`Nível: ${calcularNivel()}`, marginLeft, yPos);
        pdf.text(`Idade: ${document.getElementById('idadePersonagem')?.value || 25} anos`, marginLeft + 80, yPos);
        yPos += 6;
        
        pdf.text(`Altura: ${document.getElementById('alturaPersonagem')?.value || 170} cm`, marginLeft, yPos);
        pdf.text(`Peso: ${document.getElementById('pesoPersonagem')?.value || 70} kg`, marginLeft + 80, yPos);
        yPos += 10;
        
        pdf.setFontSize(14);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Atributos', marginLeft, yPos);
        yPos += 7;
        
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        
        pdf.text(`ST: ${getSTFixo()} (${getSTPercentual()}%)`, marginLeft, yPos);
        pdf.text(`DX: ${getDXFixo()} (${getDXPercentual()}%)`, marginLeft + 60, yPos);
        pdf.text(`IQ: ${getIQFixo()} (${getIQPercentual()}%)`, marginLeft + 120, yPos);
        yPos += 6;
        
        pdf.text(`VIGOR: ${getVIGORFixo()} (${getVIGORPercentual()}%)`, marginLeft, yPos);
        pdf.text(`VT: ${getVTFixo()}`, marginLeft + 60, yPos);
        yPos += 10;
        
        pdf.setFontSize(14);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Status', marginLeft, yPos);
        yPos += 7;
        
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        
        const pv = calcularPV();
        const pf = calcularPF();
        const pm = calcularPM();
        
        pdf.text(`PV: ${pv}`, marginLeft, yPos);
        pdf.text(`PF: ${pf}`, marginLeft + 50, yPos);
        pdf.text(`PM: ${pm}`, marginLeft + 100, yPos);
        yPos += 6;
        
        pdf.text(`Dano Base: ${calcularDanoBase()}`, marginLeft, yPos);
        yPos += 10;
        
        pdf.setFontSize(14);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Defesas', marginLeft, yPos);
        yPos += 7;
        
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        
        pdf.text(`Esquiva: ${calcularEsquiva()}%`, marginLeft, yPos);
        pdf.text(`Aparar: ${calcularAparar()}%`, marginLeft + 60, yPos);
        pdf.text(`Bloqueio: ${calcularBloqueio()}%`, marginLeft + 120, yPos);
        yPos += 6;
        
        const desloc = calcularDeslocamento();
        const carga = calcularCarga();
        const andarFinal = Math.max(1, desloc.andar - carga.reducaoDeslocamento);
        const correrFinal = Math.max(3, desloc.correr - (carga.reducaoDeslocamento * 3));
        
        pdf.text(`Deslocamento: Andar ${andarFinal.toFixed(1)}m / Correr ${correrFinal.toFixed(1)}m`, marginLeft, yPos);
        yPos += 10;
        
        pdf.text(`Resistência a Magia: ${getResistenciaMagia()}%`, marginLeft, yPos);
        yPos += 10;
        
        if (vantagensSelecionadas.size > 0) {
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Vantagens', marginLeft, yPos);
            yPos += 7;
            
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            
            const vantagensArray = Array.from(vantagensSelecionadas);
            let col1 = '', col2 = '';
            
            vantagensArray.forEach((v, i) => {
                const nomeVantagem = vantagensData[v]?.nome || v;
                if (i < Math.ceil(vantagensArray.length / 2)) {
                    col1 += `• ${nomeVantagem}\n`;
                } else {
                    col2 += `• ${nomeVantagem}\n`;
                }
            });
            
            pdf.text(col1, marginLeft, yPos, { maxWidth: 80 });
            pdf.text(col2, marginLeft + 90, yPos, { maxWidth: 80 });
            
            yPos += (Math.ceil(vantagensArray.length / 2) * 5) + 5;
        }
        
        if (desvantagensSelecionadas.size > 0) {
            if (yPos > pageHeight - 50) {
                pdf.addPage();
                yPos = 20;
            }
            
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Desvantagens', marginLeft, yPos);
            yPos += 7;
            
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            
            const desvantagensArray = Array.from(desvantagensSelecionadas);
            let textoDesv = '';
            desvantagensArray.forEach(d => {
                const nomeD = d.startsWith('fobia:') ? d.replace('fobia:', 'Fobia: ') : d;
                textoDesv += `• ${nomeD}\n`;
            });
            
            pdf.text(textoDesv, marginLeft, yPos);
            yPos += (desvantagensArray.length * 5) + 5;
        }
        
        const periciasArray = Object.entries(pericias);
        if (periciasArray.length > 0) {
            if (yPos > pageHeight - 70) {
                pdf.addPage();
                yPos = 20;
            }
            
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Perícias', marginLeft, yPos);
            yPos += 7;
            
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            
            let textoPericias = '';
            periciasArray.forEach(([id, dados]) => {
                const pericia = catalogoPericias.find(p => p.id === id);
                if (pericia) {
                    let atributoBase = pericia.atributo === 'dx' ? getDXPercentual() : getIQPercentual();
                    const bonus = (dados.nivel || 0) * 4;
                    const bonusExtra = getBonusPericia(id);
                    const nh = atributoBase + bonus + bonusExtra;
                    
                    textoPericias += `• ${pericia.nome}: Nv ${dados.nivel} (${nh}%)\n`;
                }
            });
            
            pdf.text(textoPericias, marginLeft, yPos);
            yPos += (periciasArray.length * 5) + 5;
        }
        
        const magiasDesbloqueadas = Object.entries(escolas.agua.magias).filter(([_, m]) => m.desbloqueada);
        if (magiasDesbloqueadas.length > 0) {
            if (yPos > pageHeight - 50) {
                pdf.addPage();
                yPos = 20;
            }
            
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Magias da Água', marginLeft, yPos);
            yPos += 7;
            
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            
            let textoMagias = '';
            magiasDesbloqueadas.forEach(([id, magia]) => {
                const magiaDados = dadosMagias[id];
                if (magiaDados) {
                    const nh = getIQPercentual() + 10 + magia.nivel;
                    textoMagias += `• ${magiaDados.nome}: Nv ${magia.nivel} (${nh}%) - ${magiaDados.efeitos[magia.nivel]}\n`;
                }
            });
            
            pdf.text(textoMagias, marginLeft, yPos);
        }
        
        pdf.save(`ficha_${nome.replace(/\s+/g, '_')}.pdf`);
        
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        alert('Erro ao gerar PDF');
    } finally {
        hideLoading();
    }
}

// ============================================
// CARREGAR PERSONAGEM
// ============================================
async function carregarPersonagem(id) {
    try {
        showLoading();
        
        const docRef = doc(db, "personagens", id);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) {
            alert('Personagem não encontrado!');
            window.location.href = 'personagens.html';
            return;
        }
        
        const data = docSnap.data();
        
        if (data.userId !== auth.currentUser?.uid) {
            alert('Você não tem permissão para editar este personagem!');
            window.location.href = 'personagens.html';
            return;
        }
        
        personagemId = id;
        modoEdicao = true;
        
        document.getElementById('nomePersonagem').value = data.nome || '';
        document.getElementById('classePersonagem').value = data.classe || 'guerreiro';
        document.getElementById('idadePersonagem').value = data.idade || 25;
        document.getElementById('alturaPersonagem').value = data.altura || 170;
        document.getElementById('pesoPersonagem').value = data.peso || 70;
        document.getElementById('aparencia').value = data.aparencia || 'normal';
        document.getElementById('riqueza').value = data.riqueza || 'medio';
        document.getElementById('dinheiroBase').value = data.dinheiroBase || 1000;
        document.getElementById('peculiaridades').value = data.peculiaridades || '';
        
        if (data.fotoURL && elements.previewImage && elements.previewArea && elements.uploadArea) {
            elements.previewImage.src = data.fotoURL;
            elements.previewArea.style.display = 'block';
            elements.uploadArea.style.display = 'none';
        }
        
        if (data.esferasIniciais !== undefined) {
            esferasIniciais = data.esferasIniciais;
            if (elements.esferasIniciaisInput) elements.esferasIniciaisInput.value = esferasIniciais;
        }
        
        if (data.atributos) {
            atributos.st.esferas = data.atributos.st?.esferas || 0;
            atributos.dx.esferas = data.atributos.dx?.esferas || 0;
            atributos.iq.esferas = data.atributos.iq?.esferas || 0;
            atributos.vigor.esferas = data.atributos.vigor?.esferas || 0;
            atributos.vt.esferas = data.atributos.vt?.esferas || 0;
            
            esferasRestantes = esferasIniciais - (atributos.st.esferas + atributos.dx.esferas + atributos.iq.esferas + atributos.vigor.esferas + atributos.vt.esferas);
            
            atualizarBolinhas('st');
            atualizarBolinhas('dx');
            atualizarBolinhas('iq');
            atualizarBolinhas('vigor');
            atualizarBolinhas('vt');
        }
        
        if (data.vantagens) {
            data.vantagens.forEach(v => vantagensSelecionadas.add(v));
            document.querySelectorAll('.vantagem-card').forEach(card => {
                if (data.vantagens.includes(card.dataset.vantagem)) {
                    card.classList.add('selecionada');
                }
            });
        }
        
        if (data.desvantagens) {
            data.desvantagens.forEach(d => desvantagensSelecionadas.add(d));
            document.querySelectorAll('.desvantagem-card').forEach(card => {
                if (data.desvantagens.includes(card.dataset.desvantagem)) {
                    card.classList.add('selecionada');
                }
            });
        }
        
        if (data.fobia && elements.fobiaEscolhida && elements.cardFobia) {
            fobiaSelecionada = data.fobia;
            elements.fobiaEscolhida.style.display = 'inline-block';
            elements.fobiaEscolhida.textContent = data.fobia;
            elements.cardFobia.classList.add('selecionada');
        }
        
        if (data.pericias) {
            pericias = data.pericias;
            renderizarPericiasAdquiridas();
        }
        
        if (data.escolas) {
            escolas.agua = data.escolas.agua || escolas.agua;
            renderizarEsferas();
        }
        
        if (data.inventario) {
            inventario = data.inventario;
            renderizarInventario();
        }
        
        if (data.dinheiro !== undefined) {
            dinheiro = data.dinheiro;
        } else {
            dinheiro = calcularDinheiroInicial();
        }
        
        if (data.ppDisponivel !== undefined) {
            ppDisponivel = data.ppDisponivel;
            if (elements.ppInicial) elements.ppInicial.value = ppDisponivel;
        }
        if (data.ppGasto !== undefined) ppGastoTotal = data.ppGasto;
        
        if (elements.breadcrumbCurrent) elements.breadcrumbCurrent.textContent = `Editando: ${data.nome}`;
        if (elements.pageTitle) elements.pageTitle.textContent = `Editando: ${data.nome}`;
        if (elements.personagemIdHidden) elements.personagemIdHidden.value = id;
        
        atualizarInterface();
        atualizarContadoresAbas();
        
        hideLoading();
        
    } catch (error) {
        console.error('Erro ao carregar:', error);
        alert('Erro ao carregar personagem!');
        hideLoading();
    }
}

function carregarDadosSalvos() {
    try {
        const salvos = sessionStorage.getItem('personagemTemp');
        if (salvos) {
            personagemTemp = JSON.parse(salvos);
            
            document.getElementById('nomePersonagem').value = personagemTemp.nome || '';
            document.getElementById('classePersonagem').value = personagemTemp.classe || 'guerreiro';
            document.getElementById('idadePersonagem').value = personagemTemp.idade || 25;
            document.getElementById('alturaPersonagem').value = personagemTemp.altura || 170;
            document.getElementById('pesoPersonagem').value = personagemTemp.peso || 70;
            document.getElementById('aparencia').value = personagemTemp.aparencia || 'normal';
            document.getElementById('riqueza').value = personagemTemp.riqueza || 'medio';
            document.getElementById('dinheiroBase').value = personagemTemp.dinheiroBase || 1000;
            document.getElementById('peculiaridades').value = personagemTemp.peculiaridades || '';
            
            if (personagemTemp.fotoURL && elements.previewImage && elements.previewArea && elements.uploadArea) {
                elements.previewImage.src = personagemTemp.fotoURL;
                elements.previewArea.style.display = 'block';
                elements.uploadArea.style.display = 'none';
            }
            
            if (personagemTemp.esferasIniciais !== undefined) {
                esferasIniciais = personagemTemp.esferasIniciais;
                if (elements.esferasIniciaisInput) elements.esferasIniciaisInput.value = esferasIniciais;
            }
            
            if (personagemTemp.atributos) {
                atributos.st.esferas = personagemTemp.atributos.st?.esferas || 0;
                atributos.dx.esferas = personagemTemp.atributos.dx?.esferas || 0;
                atributos.iq.esferas = personagemTemp.atributos.iq?.esferas || 0;
                atributos.vigor.esferas = personagemTemp.atributos.vigor?.esferas || 0;
                atributos.vt.esferas = personagemTemp.atributos.vt?.esferas || 0;
                
                esferasRestantes = esferasIniciais - (atributos.st.esferas + atributos.dx.esferas + atributos.iq.esferas + atributos.vigor.esferas + atributos.vt.esferas);
                
                atualizarBolinhas('st');
                atualizarBolinhas('dx');
                atualizarBolinhas('iq');
                atualizarBolinhas('vigor');
                atualizarBolinhas('vt');
            }
            
            if (personagemTemp.vantagens) {
                personagemTemp.vantagens.forEach(v => vantagensSelecionadas.add(v));
            }
            
            if (personagemTemp.desvantagens) {
                personagemTemp.desvantagens.forEach(d => desvantagensSelecionadas.add(d));
            }
            
            if (personagemTemp.fobia && elements.fobiaEscolhida && elements.cardFobia) {
                fobiaSelecionada = personagemTemp.fobia;
                elements.fobiaEscolhida.style.display = 'inline-block';
                elements.fobiaEscolhida.textContent = personagemTemp.fobia;
                elements.cardFobia.classList.add('selecionada');
            }
            
            if (personagemTemp.pericias) {
                pericias = personagemTemp.pericias;
                renderizarPericiasAdquiridas();
            }
            
            if (personagemTemp.inventario) {
                inventario = personagemTemp.inventario;
                renderizarInventario();
            }
            
            if (personagemTemp.escolas) {
                escolas.agua = personagemTemp.escolas.agua || escolas.agua;
                renderizarEsferas();
            }
            
            if (personagemTemp.dinheiro !== undefined) {
                dinheiro = personagemTemp.dinheiro;
            } else {
                dinheiro = calcularDinheiroInicial();
            }
            
            if (personagemTemp.ppDisponivel !== undefined) {
                ppDisponivel = personagemTemp.ppDisponivel;
                if (elements.ppInicial) elements.ppInicial.value = ppDisponivel;
            }
            if (personagemTemp.ppGasto !== undefined) ppGastoTotal = personagemTemp.ppGasto;
            
            atualizarInterface();
            atualizarContadoresAbas();
        }
    } catch (e) {
        console.error('Erro ao carregar dados salvos:', e);
    }
}

async function excluirPersonagem() {
    if (!personagemId) {
        alert('Nenhum personagem para excluir');
        if (elements.modalConfirmarExclusao) elements.modalConfirmarExclusao.classList.remove('active');
        return;
    }
    
    try {
        showLoading();
        
        const user = auth.currentUser;
        if (!user) {
            alert('Usuário não autenticado!');
            window.location.href = 'index.html';
            return;
        }
        
        const docRef = doc(db, "personagens", personagemId);
        await deleteDoc(docRef);
        
        sessionStorage.removeItem('personagemTemp');
        window.location.href = 'personagens.html';
    } catch (error) {
        console.error('Erro ao excluir:', error);
        alert('Erro ao excluir personagem: ' + error.message);
        hideLoading();
    }
}

async function uploadParaImgur(base64Image) {
    try {
        const CLIENT_ID = '546c25a59c58ad7';
        const base64Data = base64Image.split(',')[1];
        
        const formData = new FormData();
        formData.append('image', base64Data);
        formData.append('type', 'base64');
        
        const resposta = await fetch('https://api.imgur.com/3/image', {
            method: 'POST',
            headers: { 'Authorization': `Client-ID ${CLIENT_ID}` },
            body: formData
        });
        
        const dados = await resposta.json();
        return dados.success ? dados.data.link : null;
    } catch (erro) {
        console.error('Erro no upload da imagem:', erro);
        return null;
    }
}

// ============================================
// INICIALIZAÇÃO
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    criarBolinhas('st');
    criarBolinhas('dx');
    criarBolinhas('iq');
    criarBolinhas('vigor');
    criarBolinhas('vt');
    
    if (elements.esferasIniciaisInput) {
        elements.esferasIniciaisInput.addEventListener('change', () => {
            esferasIniciais = parseInt(elements.esferasIniciaisInput.value) || 6;
            const totalGasto = atributos.st.esferas + atributos.dx.esferas + atributos.iq.esferas + atributos.vigor.esferas + atributos.vt.esferas;
            esferasRestantes = esferasIniciais - totalGasto;
            if (elements.esferasRestantesSpan) elements.esferasRestantesSpan.textContent = esferasRestantes;
            triggerAutoSave();
        });
    }
    
    if (elements.ppInicial) {
        elements.ppInicial.addEventListener('change', () => {
            ppDisponivel = parseInt(elements.ppInicial.value) || 30;
            if (elements.ppRestante) elements.ppRestante.textContent = ppDisponivel - ppGastoTotal;
            triggerAutoSave();
        });
    }
    
    if (elements.dinheiroBaseInput) {
        elements.dinheiroBaseInput.addEventListener('change', () => {
            dinheiro = calcularDinheiroInicial();
            atualizarDinheiroDisplay();
            triggerAutoSave();
        });
    }
    
    document.getElementById('riqueza')?.addEventListener('change', () => {
        dinheiro = calcularDinheiroInicial();
        atualizarDinheiroDisplay();
        triggerAutoSave();
    });
    
    const urlParams = new URLSearchParams(window.location.search);
    const idParaEditar = urlParams.get('id');
    
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                const docRef = doc(db, "usuarios", user.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    if (elements.displayIdPc) elements.displayIdPc.textContent = userData.id_pc || '--------';
                    if (elements.displayNickname) elements.displayNickname.textContent = userData.nickname || 'Aventureiro';
                }
                
                if (idParaEditar) {
                    await carregarPersonagem(idParaEditar);
                } else {
                    carregarDadosSalvos();
                }
            } catch (error) {
                console.error('Erro:', error);
            }
        } else {
            window.location.href = 'index.html';
        }
    });
    
    const camposAutoSave = [
        'nomePersonagem', 'classePersonagem', 'idadePersonagem', 'alturaPersonagem',
        'pesoPersonagem', 'aparencia', 'riqueza', 'dinheiroBase', 'peculiaridades'
    ];
    
    camposAutoSave.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', triggerAutoSave);
            el.addEventListener('change', triggerAutoSave);
        }
    });
    
    elements.abas.forEach(aba => {
        aba.addEventListener('click', () => {
            if (['combate', 'vantagens', 'desvantagens', 'pericias', 'magias', 'equipamentos'].includes(aba.dataset.aba)) {
                salvarDadosBasicos();
            }
            mudarAba(aba.dataset.aba);
        });
    });
    
    if (elements.uploadArea && elements.fotoInput) {
        elements.uploadArea.addEventListener('click', () => elements.fotoInput.click());
    }
    
    if (elements.fotoInput) {
        elements.fotoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (elements.previewImage) elements.previewImage.src = e.target.result;
                    if (elements.previewArea) elements.previewArea.style.display = 'block';
                    if (elements.uploadArea) elements.uploadArea.style.display = 'none';
                };
                reader.readAsDataURL(file);
                triggerAutoSave();
            }
        });
    }
    
    if (elements.removeFoto) {
        elements.removeFoto.addEventListener('click', () => {
            if (elements.previewArea) elements.previewArea.style.display = 'none';
            if (elements.uploadArea) elements.uploadArea.style.display = 'block';
            if (elements.fotoInput) elements.fotoInput.value = '';
            if (elements.previewImage) elements.previewImage.src = '';
            triggerAutoSave();
        });
    }
    
    document.querySelectorAll('.vantagem-card').forEach(card => {
        card.addEventListener('click', () => selecionarVantagem(card));
    });
    
    document.querySelectorAll('.desvantagem-card:not(#cardFobia)').forEach(card => {
        card.addEventListener('click', () => selecionarDesvantagem(card));
    });
    
    if (elements.cardFobia && elements.modalFobias) {
        elements.cardFobia.addEventListener('click', () => {
            elements.modalFobias.classList.add('active');
        });
    }
    
    if (elements.fecharModalFobias && elements.modalFobias) {
        elements.fecharModalFobias.addEventListener('click', () => {
            elements.modalFobias.classList.remove('active');
        });
    }
    
    document.querySelectorAll('.fobia-item').forEach(item => {
        item.addEventListener('click', () => {
            if (desvantagensSelecionadas.size >= 4) {
                alert('Limite de desvantagens atingido!');
                if (elements.modalFobias) elements.modalFobias.classList.remove('active');
                return;
            }
            
            const fobia = item.dataset.fobia;
            const nomeFobia = item.querySelector('h4')?.textContent || fobia;
            
            fobiaSelecionada = fobia;
            
            if (elements.fobiaEscolhida) {
                elements.fobiaEscolhida.style.display = 'inline-block';
                elements.fobiaEscolhida.textContent = nomeFobia;
            }
            
            if (elements.cardFobia) elements.cardFobia.classList.add('selecionada');
            desvantagensSelecionadas.add(`fobia:${fobia}`);
            atualizarContadoresAbas();
            
            if (elements.modalFobias) elements.modalFobias.classList.remove('active');
            triggerAutoSave();
        });
    });
    
    document.querySelectorAll('.filtro-pericia').forEach(filtro => {
        filtro.addEventListener('click', () => {
            document.querySelectorAll('.filtro-pericia').forEach(f => f.classList.remove('ativo'));
            filtro.classList.add('ativo');
            renderizarCatalogoPericias(filtro.dataset.filtro);
        });
    });
    
    if (elements.modalPericiaMais) {
        elements.modalPericiaMais.addEventListener('click', () => {
            if (periciaAtual) {
                periciaAtual.novoNivel++;
                if (elements.modalPericiaNivel) elements.modalPericiaNivel.textContent = periciaAtual.novoNivel;
                atualizarModalPericia();
            }
        });
    }
    
    if (elements.modalPericiaMenos) {
        elements.modalPericiaMenos.addEventListener('click', () => {
            if (periciaAtual) {
                periciaAtual.novoNivel--;
                if (elements.modalPericiaNivel) elements.modalPericiaNivel.textContent = periciaAtual.novoNivel;
                atualizarModalPericia();
            }
        });
    }
    
    if (elements.modalPericiaCancelar) {
        elements.modalPericiaCancelar.addEventListener('click', () => {
            if (elements.modalPericia) elements.modalPericia.classList.remove('active');
        });
    }
    
    if (elements.modalPericiaConfirmar) {
        elements.modalPericiaConfirmar.addEventListener('click', confirmarPericia);
    }
    
    if (elements.fecharDetalheMagia && elements.detalheMagiaModal) {
        elements.fecharDetalheMagia.addEventListener('click', () => {
            elements.detalheMagiaModal.classList.remove('active');
        });
    }
    
    if (elements.comprarNivelMagia) {
        elements.comprarNivelMagia.addEventListener('click', () => {
            if (!magiaSelecionada) return;
            
            const magia = escolas.agua.magias[magiaSelecionada];
            if (!magia || magia.nivel >= 10) return;
            
            const custo = 2;
            
            if (custo > (ppDisponivel - ppGastoTotal)) {
                alert('PP insuficiente!');
                return;
            }
            
            ppGastoTotal += custo;
            magia.nivel++;
            
            if (elements.ppGasto) elements.ppGasto.textContent = ppGastoTotal;
            if (elements.ppRestante) elements.ppRestante.textContent = ppDisponivel - ppGastoTotal;
            
            atualizarContadoresAbas();
            abrirDetalheMagia(magiaSelecionada);
            renderizarEsferas();
            triggerAutoSave();
        });
    }
    
    document.querySelectorAll('.catalogo-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.catalogo-tab').forEach(t => t.classList.remove('ativo'));
            tab.classList.add('ativo');
            renderizarTabelas(tab.dataset.tab);
        });
    });
    
    if (elements.btnSalvarPersonagem) {
        elements.btnSalvarPersonagem.addEventListener('click', async () => {
            await salvarPersonagem(false);
        });
    }
    
    if (elements.btnExportarPDF) {
        elements.btnExportarPDF.addEventListener('click', exportarPDF);
    }
    
    if (elements.btnExcluirPersonagem && elements.modalConfirmarExclusao) {
        elements.btnExcluirPersonagem.addEventListener('click', () => {
            elements.modalConfirmarExclusao.classList.add('active');
        });
    }
    
    if (elements.cancelarExclusao && elements.modalConfirmarExclusao) {
        elements.cancelarExclusao.addEventListener('click', () => {
            elements.modalConfirmarExclusao.classList.remove('active');
        });
    }
    
    if (elements.confirmarExclusao) {
        elements.confirmarExclusao.addEventListener('click', async () => {
            if (elements.modalConfirmarExclusao) elements.modalConfirmarExclusao.classList.remove('active');
            await excluirPersonagem();
        });
    }
    
    if (elements.fecharModalSalvar && elements.modalSalvarSucesso) {
        elements.fecharModalSalvar.addEventListener('click', () => {
            elements.modalSalvarSucesso.style.display = 'none';
            window.location.href = 'personagens.html';
        });
    }
    
    if (elements.btnSair) {
        elements.btnSair.addEventListener('click', async () => {
            try {
                showLoading();
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Erro ao sair:', error);
                hideLoading();
            }
        });
    }
    
    dinheiro = calcularDinheiroInicial();
    atualizarDinheiroDisplay();
    atualizarInterface();
    atualizarContadoresAbas();
    renderizarTabelas('armas_ca');
});
</script>
</body>
</html>