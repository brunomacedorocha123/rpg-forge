<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Aventura - Modo Clássico - RPGForce</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #2a1a3a 100%);
            min-height: 100vh;
            color: #fff;
        }

        .magic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .magic-bg::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
        }

        .magic-bg::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 80% 80%, rgba(198, 40, 40, 0.1) 0%, transparent 50%);
            animation: pulse 10s ease-in-out infinite reverse;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .game-container {
            position: relative;
            z-index: 1;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .game-header {
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #ffd700;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            z-index: 20;
        }

        .personagem-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .personagem-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #ffd700;
            overflow: hidden;
            background: #1a1a3a;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .personagem-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .personagem-nome {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.2rem;
            color: #ffd700;
        }

        .status-bars {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            min-width: 140px;
        }

        .status-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 3px;
        }

        .status-label i {
            color: #ffd700;
            margin-right: 5px;
        }

        .status-bar {
            height: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .status-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .status-fill.vida { background: linear-gradient(90deg, #ff4d4d, #ff1a1a); }
        .status-fill.mana { background: linear-gradient(90deg, #4d4dff, #1a1aff); }
        .status-fill.fadiga { background: linear-gradient(90deg, #ffaa00, #ff8800); }
        .status-fill.xp { background: linear-gradient(90deg, #4CAF50, #8BC34A); }

        .pm-display {
            background: linear-gradient(45deg, #9c27b0, #673ab7);
            padding: 5px 15px;
            border-radius: 30px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #ffd700;
        }

        .pm-display i { color: #ffd700; }

        .level-display {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
            padding: 5px 15px;
            border-radius: 30px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .level-display i { color: #0a0a1a; }

        .ato-indicator {
            background: rgba(255,215,0,0.2);
            border-left: 4px solid #ffd700;
            padding: 5px 15px;
            font-family: 'MedievalSharp', cursive;
            font-size: 1rem;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        
        .ato-indicator i {
            margin-right: 8px;
            color: #ffaa00;
        }

        .main-area {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }

        .ficha-coluna {
            width: 260px;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(10px);
            border-right: 2px solid rgba(255,215,0,0.3);
            padding: 15px;
            overflow-y: auto;
            z-index: 15;
        }

        .ficha-header {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,215,0,0.2);
        }

        .ficha-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #ffd700;
            margin: 0 auto 8px;
            overflow: hidden;
            background: #1a1a3a;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ficha-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ficha-nome {
            font-size: 1rem;
            font-weight: bold;
            color: #ffd700;
            font-family: 'MedievalSharp', cursive;
        }

        .ficha-classe {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,215,0,0.1);
            border-radius: 20px;
            padding: 5px 10px;
            margin: 8px 0;
            border: 1px solid #ffd700;
            font-size: 0.9rem;
        }

        .level-numero {
            font-weight: bold;
            color: #ffd700;
        }

        .bolinhas-disponiveis-container {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(76,175,80,0.2);
            border: 1px solid #4CAF50;
            border-radius: 20px;
            padding: 5px 10px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .bolinhas-disponiveis-container:hover {
            background: rgba(76,175,80,0.3);
            transform: scale(1.02);
        }

        .bolinhas-disponiveis-container i {
            color: #4CAF50;
        }

        .bolinhas-disponiveis-valor {
            font-weight: bold;
            color: #4CAF50;
        }

        .atributos-container {
            margin: 10px 0;
        }

        .atributo-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 5px;
            border: 1px solid rgba(255,215,0,0.2);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .atributo-card:hover {
            background: rgba(255,215,0,0.1);
            transform: translateX(3px);
        }

        .atributo-card.bolinha-disponivel {
            border-color: #4CAF50;
            animation: pulseVerde 1.5s infinite;
            background: rgba(76,175,80,0.1);
        }

        @keyframes pulseVerde {
            0% { box-shadow: 0 0 0 0 rgba(76,175,80,0.7); }
            70% { box-shadow: 0 0 0 5px rgba(76,175,80,0); }
            100% { box-shadow: 0 0 0 0 rgba(76,175,80,0); }
        }

        .atributo-info {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .atributo-nome {
            font-weight: bold;
            color: #ffd700;
            width: 35px;
            font-size: 0.9rem;
        }

        .atributo-bolinhas {
            display: flex;
            gap: 2px;
        }

        .bolinha-pequena {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,215,0,0.2);
            border: 1px solid rgba(255,215,0,0.3);
        }

        .bolinha-pequena.preenchida {
            background: #ffd700;
        }

        .atributo-valor {
            font-weight: bold;
            font-size: 1rem;
            color: #ffd700;
        }

        .defesas-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin: 10px 0;
        }

        .defesa-card {
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            padding: 5px;
            text-align: center;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .defesa-valor {
            font-size: 1rem;
            font-weight: bold;
            color: #ffd700;
        }

        .defesa-label {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.6);
        }

        .ficha-botoes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin: 10px 0;
        }

        .ficha-botao {
            background: rgba(255,215,0,0.1);
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 8px 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .ficha-botao:hover {
            background: #ffd700;
            color: #0a0a1a;
        }

        .ficha-botao i {
            font-size: 0.9rem;
        }

        .inventario-rapido {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 8px;
            margin: 10px 0;
            max-height: 80px;
            overflow-y: auto;
        }

        .inventario-titulo {
            color: #ffd700;
            font-size: 0.8rem;
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
        }

        .item-rapido {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            font-size: 0.7rem;
            border-bottom: 1px solid rgba(255,215,0,0.1);
        }

        .item-rapido .nome {
            color: #ffd700;
        }

        .cenario-coluna {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: rgba(0,0,0,0.5);
        }

        .cenario-area {
            flex: 1;
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #1a1a3a;
            min-height: 0;
        }

        .cenario-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, rgba(0,0,0,0.3) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.3) 100%);
            pointer-events: none;
        }

        .npcs-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .npc-sprite {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.2);
            filter: drop-shadow(0 10px 8px rgba(0, 0, 0, 0.5));
            z-index: 10;
        }

        .npc-sprite:hover {
            transform: translate(-50%, -60%) scale(1.08);
            filter: drop-shadow(0 15px 15px rgba(255, 215, 0, 0.3));
            z-index: 100;
        }

        .npc-sprite img {
            width: 120px;
            height: 160px;
            object-fit: cover;
            object-position: center;
            border: none;
            background: transparent;
            display: block;
            transition: all 0.3s ease;
        }

        .npc-sprite .npc-nome {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #000000;
            color: #ffd700;
            padding: 4px 15px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: bold;
            white-space: nowrap;
            border: 2px solid #ffd700;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.8);
            font-family: 'MedievalSharp', cursive;
            z-index: 30;
            pointer-events: none;
            text-shadow: 0 2px 4px #000000;
        }

        .dialogo-area {
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(10px);
            border-top: 2px solid rgba(255,215,0,0.3);
            padding: 12px 15px;
            min-height: 110px;
            max-height: 180px;
            overflow-y: auto;
        }

        .npc-falando {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 0.9rem;
        }

        .dialogo-texto {
            color: rgba(255,255,255,0.9);
            line-height: 1.4;
            margin-bottom: 8px;
            font-style: italic;
            padding-left: 8px;
            border-left: 3px solid #ffd700;
            font-size: 0.9rem;
        }

        .opcoes-dialogo {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .opcao-btn {
            background: rgba(255,215,0,0.1);
            border: 1px solid #ffd700;
            color: #fff;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }

        .opcao-btn:hover {
            background: #ffd700;
            color: #0a0a1a;
        }

        .acoes-coluna {
            width: 250px;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(10px);
            border-left: 2px solid rgba(255,215,0,0.3);
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .turno-indicator {
            background: rgba(76,175,80,0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .turno-indicator.inimigo {
            background: rgba(255,87,34,0.2);
            border-color: #ff5722;
            color: #ff5722;
        }

        .acoes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .acao-btn {
            background: rgba(255,215,0,0.1);
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 8px 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            font-size: 0.8rem;
        }

        .acao-btn:hover:not(:disabled) {
            background: #ffd700;
            color: #0a0a1a;
        }

        .acao-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .acao-btn.atacar {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .acao-btn.magia {
            border-color: #4d4dff;
            color: #4d4dff;
        }

        .inimigos-lista {
            background: rgba(255,0,0,0.1);
            border: 1px solid #ff6b6b;
            border-radius: 8px;
            padding: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .inimigo-mini {
            background: rgba(0,0,0,0.3);
            border: 1px solid #ff6b6b;
            border-radius: 6px;
            padding: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }

        .inimigo-mini:hover {
            background: rgba(255,107,107,0.2);
        }

        .inimigo-mini.selecionado {
            border: 2px solid #ffd700;
        }

        .inimigo-mini-nome {
            color: #ff6b6b;
            font-weight: bold;
        }

        .inimigo-mini-pv {
            height: 3px;
            background: rgba(0,0,0,0.3);
            border-radius: 2px;
            margin: 4px 0;
        }

        .inimigo-mini-pv-fill {
            height: 100%;
            background: #ff6b6b;
            width: 100%;
        }

        .log-container {
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            padding: 6px;
            max-height: 100px;
            overflow-y: auto;
            font-size: 0.7rem;
        }

        .log-item {
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,215,0,0.1);
        }

        .log-item.sucesso { color: #4CAF50; }
        .log-item.erro { color: #ff6b6b; }
        .log-item.dano { color: #ff5722; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a3a;
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            color: #ffd700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .atributo-opcao {
            background: rgba(0,0,0,0.3);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .atributo-opcao:hover {
            background: rgba(255,215,0,0.2);
            transform: translateX(5px);
        }

        .atributo-opcao .icone {
            width: 40px;
            height: 40px;
            background: rgba(255,215,0,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #ffd700;
        }

        .atributo-opcao .info {
            flex: 1;
        }

        .atributo-opcao .nome {
            font-size: 1rem;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .atributo-opcao .descricao {
            color: rgba(255,255,255,0.7);
            font-size: 0.8rem;
        }

        .atributo-opcao .valor-atual {
            font-size: 1rem;
            color: #4CAF50;
            font-weight: bold;
        }

        .inventario-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .inventario-coluna {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .inventario-coluna h4 {
            color: #ffd700;
            margin-bottom: 8px;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            background: #1a1a3a;
            padding: 5px 0;
        }

        .item-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 6px;
            padding: 6px;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }

        .item-card .nome {
            color: #ffd700;
            font-weight: bold;
        }

        .item-card .detalhes {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.6);
            margin-top: 2px;
        }

        .item-acoes {
            display: flex;
            gap: 3px;
            margin-top: 3px;
        }

        .item-acao {
            background: rgba(255,215,0,0.1);
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            cursor: pointer;
        }

        .item-acao:hover {
            background: #ffd700;
            color: #0a0a1a;
        }

        .pericias-grid, .vantagens-grid, .desvantagens-grid, .magias-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .pericia-card-modal, .vantagem-card-modal, .desvantagem-card-modal, .magia-card-modal {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            padding: 12px;
            transition: all 0.3s;
        }

        .pericia-card-modal h4, .vantagem-card-modal h4, .desvantagem-card-modal h4, .magia-card-modal h4 {
            color: #ffd700;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }

        .pericia-card-modal .descricao, .vantagem-card-modal .descricao, .desvantagem-card-modal .descricao, .magia-card-modal .descricao {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 5px;
        }

        .pericia-card-modal .nh, .magia-card-modal .nivel {
            font-size: 0.8rem;
            color: #4CAF50;
            font-weight: bold;
        }

        .vantagem-card-modal .bonus, .desvantagem-card-modal .penalidade {
            font-size: 0.8rem;
            color: #ffd700;
        }

        .fobia-tag {
            background: rgba(255,107,107,0.3);
            color: #ff6b6b;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            display: inline-block;
            margin-top: 5px;
        }

        .modal-botoes {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-confirmar {
            background: #ffd700;
            color: #0a0a1a;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            flex: 2;
        }

        .btn-cancelar {
            background: transparent;
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            flex: 1;
        }

        .arma-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .arma-card:hover {
            background: rgba(255,215,0,0.1);
            border-color: #ffd700;
        }

        .arma-card.selecionada {
            background: rgba(255,215,0,0.2);
            border-color: #ffd700;
        }

        .arma-nome {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 3px;
        }

        .arma-detalhes {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
            display: flex;
            gap: 10px;
        }

        .dados-flutuante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 500;
        }

        .btn-dados {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 5px 15px rgba(255,215,0,0.4);
            transition: all 0.3s;
        }

        .btn-dados:hover {
            transform: scale(1.1);
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10,10,26,0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,215,0,0.2);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .contador-badge {
            background: rgba(255,215,0,0.2);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="magic-bg"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando sua aventura...</div>
    </div>

    <div class="modal" id="modalEscolhaAtributo">
        <div class="modal-content">
            <h3><i class="fas fa-star"></i> Level Up!</h3>
            <p style="margin-bottom: 15px; color: rgba(255,255,255,0.8);">
                Você ganhou uma esfera! Seu level aumentou para <strong id="novoLevelDisplay">0</strong>
            </p>
            <p style="margin-bottom: 15px; color: rgba(255,255,255,0.8);">
                Escolha em qual atributo aplicar:
            </p>
            
            <div class="atributo-opcao" data-atributo="st">
                <div class="icone"><i class="fas fa-fist-raised"></i></div>
                <div class="info">
                    <div class="nome">ST (Força)</div>
                    <div class="descricao">Aumenta dano, carga e habilidades físicas</div>
                </div>
                <div class="valor-atual" id="valorStModal">9</div>
            </div>
            
            <div class="atributo-opcao" data-atributo="dx">
                <div class="icone"><i class="fas fa-running"></i></div>
                <div class="info">
                    <div class="nome">DX (Destreza)</div>
                    <div class="descricao">Aumenta esquiva, perícias físicas e precisão</div>
                </div>
                <div class="valor-atual" id="valorDxModal">5</div>
            </div>
            
            <div class="atributo-opcao" data-atributo="iq">
                <div class="icone"><i class="fas fa-brain"></i></div>
                <div class="info">
                    <div class="nome">IQ (Inteligência)</div>
                    <div class="descricao">Aumenta vontade, perícias mentais e magias</div>
                </div>
                <div class="valor-atual" id="valorIqModal">5</div>
            </div>
            
            <div class="atributo-opcao" data-atributo="ht">
                <div class="icone"><i class="fas fa-heart"></i></div>
                <div class="info">
                    <div class="nome">HT (Vigor)</div>
                    <div class="descricao">Aumenta PV, fadiga e resistência</div>
                </div>
                <div class="valor-atual" id="valorHtModal">8</div>
            </div>
            
            <div class="modal-botoes">
                <button class="btn-cancelar" id="cancelarEscolhaAtributo">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalInventario">
        <div class="modal-content" style="max-width: 800px;">
            <h3><i class="fas fa-backpack"></i> Inventário do Personagem</h3>
            
            <div class="inventario-grid">
                <div class="inventario-coluna">
                    <h4><i class="fas fa-shield-alt"></i> Equipado</h4>
                    <div id="inventarioEquipado"></div>
                </div>
                <div class="inventario-coluna">
                    <h4><i class="fas fa-shopping-bag"></i> Mochila</h4>
                    <div id="inventarioMochila"></div>
                </div>
                <div class="inventario-coluna">
                    <h4><i class="fas fa-warehouse"></i> Depósito</h4>
                    <div id="inventarioDeposito"></div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size:0.9rem;">
                <span><i class="fas fa-coins"></i> Dinheiro: <strong style="color:#ffd700;" id="modalDinheiro">0</strong></span>
                <span><i class="fas fa-weight-hanging"></i> Carga: <strong style="color:#ffd700;" id="modalCarga">0/0 kg</strong></span>
            </div>
            
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalInventario">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalPericias">
        <div class="modal-content">
            <h3><i class="fas fa-brain"></i> Perícias do Personagem</h3>
            <div class="pericias-grid" id="periciasModalGrid"></div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalPericias">OK</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalVantagens">
        <div class="modal-content">
            <h3><i class="fas fa-star"></i> Vantagens</h3>
            <div class="vantagens-grid" id="vantagensModalGrid"></div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalVantagens">OK</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalDesvantagens">
        <div class="modal-content">
            <h3><i class="fas fa-skull"></i> Desvantagens</h3>
            <div class="desvantagens-grid" id="desvantagensModalGrid"></div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalDesvantagens">OK</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalMagias">
        <div class="modal-content">
            <h3><i class="fas fa-magic"></i> Magias da Água</h3>
            <div class="magias-grid" id="magiasModalGrid"></div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalMagias">OK</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalAtaque">
        <div class="modal-content">
            <h3><i class="fas fa-sword"></i> Escolha sua Arma</h3>
            <div id="armasLista"></div>
            <div class="modal-botoes">
                <button class="btn-cancelar" id="btnCancelarAtaque">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirmar" id="btnConfirmarAtaque" disabled>
                    <i class="fas fa-check"></i> Atacar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalDados">
        <div class="modal-content">
            <h3><i class="fas fa-dice-d20"></i> Rolagem de Dados</h3>
            
            <div style="display: flex; flex-direction: column; gap: 10px; margin: 15px 0;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Quantidade:</label>
                    <input type="number" id="dadosQtd" min="1" max="10" value="1" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 6px; border-radius: 8px; width: 80px;">
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Faces:</label>
                    <select id="dadosFaces" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 6px; border-radius: 8px; width: 80px;">
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10" selected>d10</option>
                        <option value="12">d12</option>
                        <option value="20">d20</option>
                        <option value="100">d100</option>
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Modificador:</label>
                    <input type="number" id="dadosMod" value="0" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 6px; border-radius: 8px; width: 80px;">
                </div>
            </div>
            
            <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; text-align: center; font-size: 1.2rem; color: #ffd700; margin: 15px 0;" id="dadosResultado">
                Clique em Rolar
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn-cancelar" id="btnFecharDados" style="flex:1;">Fechar</button>
                <button class="btn-confirmar" id="btnRolarDados" style="flex:2;">Rolar</button>
            </div>
        </div>
    </div>

    <div class="dados-flutuante">
        <button class="btn-dados" id="btnAbrirDados">
            <i class="fas fa-dice-d20"></i>
        </button>
    </div>

    <div class="game-container">
        <div class="game-header">
            <div class="personagem-info">
                <div class="personagem-avatar" id="headerAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <span class="personagem-nome" id="headerNome">Carregando...</span>
                    <span style="font-size:0.7rem; color:rgba(255,255,255,0.6); margin-left:5px;" id="headerClasse"></span>
                </div>
            </div>

            <div class="status-bars">
                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-heart"></i> PV</span>
                        <span id="headerPV">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill vida" id="headerPVBarra" style="width:0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-magic"></i> Mana</span>
                        <span id="headerMana">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill mana" id="headerManaBarra" style="width:0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-tint"></i> Fadiga</span>
                        <span id="headerFadiga">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill fadiga" id="headerFadigaBarra" style="width:0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-star"></i> XP</span>
                        <span id="headerXP">0/100</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill xp" id="headerXPBarra" style="width:0%"></div>
                    </div>
                </div>
            </div>

            <div class="level-display" id="levelDisplay">
                <i class="fas fa-crown"></i>
                <span>Lv <span id="levelValor">0</span></span>
            </div>

            <div class="pm-display" id="pmDisplay">
                <i class="fas fa-crown"></i>
                <span>PM: <span id="pmValor">0</span></span>
            </div>
        </div>

        <div class="main-area">
            <div class="ficha-coluna">
                <div class="ficha-header">
                    <div class="ficha-avatar" id="fichaAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="ficha-nome" id="fichaNome">Carregando...</div>
                    <div class="ficha-classe" id="fichaClasse"></div>
                </div>

                <div class="level-info">
                    <span><i class="fas fa-crown"></i> Level</span>
                    <span class="level-numero" id="fichaLevel">0</span>
                </div>

                <div class="bolinhas-disponiveis-container" id="bolinhasDisponiveisContainer" style="display: none;">
                    <i class="fas fa-star"></i>
                    <span>Esferas:</span>
                    <span class="bolinhas-disponiveis-valor" id="bolinhasDisponiveis">0</span>
                </div>

                <div class="ato-indicator" id="atoIndicator">
                    <i class="fas fa-scroll"></i> <span id="atoTexto">Ato 1: A Taverna</span>
                </div>

                <div class="atributos-container" id="atributosContainer"></div>

                <div class="defesas-grid" id="defesasGrid"></div>

                <div class="ficha-botoes">
                    <button class="ficha-botao" id="btnVerPericias">
                        <i class="fas fa-brain"></i> Perícias
                    </button>
                    <button class="ficha-botao" id="btnVerVantagens">
                        <i class="fas fa-star"></i> Vantagens
                    </button>
                    <button class="ficha-botao" id="btnVerDesvantagens">
                        <i class="fas fa-skull"></i> Desvantagens
                    </button>
                    <button class="ficha-botao" id="btnVerMagias">
                        <i class="fas fa-magic"></i> Magias
                    </button>
                </div>

                <div class="inventario-rapido">
                    <div class="inventario-titulo">
                        <span><i class="fas fa-backpack"></i> Itens Rápidos</span>
                        <span id="cargaRapida">0/0 kg</span>
                    </div>
                    <div id="itensRapidosLista"></div>
                </div>
            </div>

            <div class="cenario-coluna">
                <div class="cenario-area" id="cenarioArea">
                    <div class="cenario-overlay"></div>
                    <div class="npcs-container" id="npcsContainer"></div>
                </div>

                <div class="dialogo-area" id="dialogoArea">
                    <div class="npc-falando" id="npcFalando">
                        <span id="npcNome">Narrador</span>
                    </div>
                    <div class="dialogo-texto" id="dialogoTexto">
                        Preparando sua aventura...
                    </div>
                    <div class="opcoes-dialogo" id="opcoesDialogo"></div>
                </div>
            </div>

            <div class="acoes-coluna">
                <div class="turno-indicator jogador" id="turnoIndicator">
                    <i class="fas fa-user"></i> SEU TURNO
                </div>

                <div class="acoes-grid">
                    <button class="acao-btn atacar" id="btnAtacar">
                        <i class="fas fa-sword"></i> Atacar
                    </button>
                    <button class="acao-btn magia" id="btnMagia">
                        <i class="fas fa-magic"></i> Magia
                    </button>
                    <button class="acao-btn" id="btnInventario">
                        <i class="fas fa-backpack"></i> Inventário
                    </button>
                    <button class="acao-btn" id="btnDescansar">
                        <i class="fas fa-bed"></i> Descansar
                    </button>
                </div>

                <div id="inimigosContainer" style="display: none;">
                    <h4 style="color:#ff6b6b; margin-bottom:5px; font-size:0.9rem;"><i class="fas fa-skull"></i> Inimigos</h4>
                    <div class="inimigos-lista" id="inimigosLista"></div>
                </div>

                <div class="log-container" id="logContainer">
                    <div class="log-item">A aventura começou...</div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBrx4JSmFay24k95pu1ICjFfVki8gs_uHw",
    authDomain: "rpgforce-e3227.firebaseapp.com",
    projectId: "rpgforce-e3227",
    storageBucket: "rpgforce-e3227.firebasestorage.app",
    messagingSenderId: "984517342332",
    appId: "1:984517342332:web:87d33aa4c84ff2a07685f9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loadingOverlay = document.getElementById('loadingOverlay');
const headerAvatar = document.getElementById('headerAvatar');
const headerNome = document.getElementById('headerNome');
const headerClasse = document.getElementById('headerClasse');
const headerPV = document.getElementById('headerPV');
const headerPVBarra = document.getElementById('headerPVBarra');
const headerMana = document.getElementById('headerMana');
const headerManaBarra = document.getElementById('headerManaBarra');
const headerFadiga = document.getElementById('headerFadiga');
const headerFadigaBarra = document.getElementById('headerFadigaBarra');
const headerXP = document.getElementById('headerXP');
const headerXPBarra = document.getElementById('headerXPBarra');
const pmValor = document.getElementById('pmValor');
const levelValor = document.getElementById('levelValor');
const fichaLevel = document.getElementById('fichaLevel');
const fichaAvatar = document.getElementById('fichaAvatar');
const fichaNome = document.getElementById('fichaNome');
const fichaClasse = document.getElementById('fichaClasse');
const atributosContainer = document.getElementById('atributosContainer');
const defesasGrid = document.getElementById('defesasGrid');
const itensRapidosLista = document.getElementById('itensRapidosLista');
const cargaRapida = document.getElementById('cargaRapida');
const bolinhasDisponiveisContainer = document.getElementById('bolinhasDisponiveisContainer');
const bolinhasDisponiveis = document.getElementById('bolinhasDisponiveis');
const atoIndicator = document.getElementById('atoIndicator');
const atoTexto = document.getElementById('atoTexto');
const cenarioArea = document.getElementById('cenarioArea');
const npcsContainer = document.getElementById('npcsContainer');
const npcNome = document.getElementById('npcNome');
const dialogoTexto = document.getElementById('dialogoTexto');
const opcoesDialogo = document.getElementById('opcoesDialogo');
const turnoIndicator = document.getElementById('turnoIndicator');
const btnAtacar = document.getElementById('btnAtacar');
const btnMagia = document.getElementById('btnMagia');
const btnInventario = document.getElementById('btnInventario');
const btnDescansar = document.getElementById('btnDescansar');
const btnVerPericias = document.getElementById('btnVerPericias');
const btnVerVantagens = document.getElementById('btnVerVantagens');
const btnVerDesvantagens = document.getElementById('btnVerDesvantagens');
const btnVerMagias = document.getElementById('btnVerMagias');
const inimigosContainer = document.getElementById('inimigosContainer');
const inimigosLista = document.getElementById('inimigosLista');
const logContainer = document.getElementById('logContainer');
const modalEscolhaAtributo = document.getElementById('modalEscolhaAtributo');
const modalInventario = document.getElementById('modalInventario');
const modalPericias = document.getElementById('modalPericias');
const modalVantagens = document.getElementById('modalVantagens');
const modalDesvantagens = document.getElementById('modalDesvantagens');
const modalMagias = document.getElementById('modalMagias');
const modalAtaque = document.getElementById('modalAtaque');
const modalDados = document.getElementById('modalDados');
const valorStModal = document.getElementById('valorStModal');
const valorDxModal = document.getElementById('valorDxModal');
const valorIqModal = document.getElementById('valorIqModal');
const valorHtModal = document.getElementById('valorHtModal');
const cancelarEscolhaAtributo = document.getElementById('cancelarEscolhaAtributo');
const fecharModalInventario = document.getElementById('fecharModalInventario');
const fecharModalPericias = document.getElementById('fecharModalPericias');
const fecharModalVantagens = document.getElementById('fecharModalVantagens');
const fecharModalDesvantagens = document.getElementById('fecharModalDesvantagens');
const fecharModalMagias = document.getElementById('fecharModalMagias');
const periciasModalGrid = document.getElementById('periciasModalGrid');
const vantagensModalGrid = document.getElementById('vantagensModalGrid');
const desvantagensModalGrid = document.getElementById('desvantagensModalGrid');
const magiasModalGrid = document.getElementById('magiasModalGrid');
const armasLista = document.getElementById('armasLista');
const btnCancelarAtaque = document.getElementById('btnCancelarAtaque');
const btnConfirmarAtaque = document.getElementById('btnConfirmarAtaque');
const btnAbrirDados = document.getElementById('btnAbrirDados');
const btnFecharDados = document.getElementById('btnFecharDados');
const btnRolarDados = document.getElementById('btnRolarDados');
const dadosResultado = document.getElementById('dadosResultado');
const dadosQtd = document.getElementById('dadosQtd');
const dadosFaces = document.getElementById('dadosFaces');
const dadosMod = document.getElementById('dadosMod');
const inventarioEquipado = document.getElementById('inventarioEquipado');
const inventarioMochila = document.getElementById('inventarioMochila');
const inventarioDeposito = document.getElementById('inventarioDeposito');
const modalDinheiro = document.getElementById('modalDinheiro');
const modalCarga = document.getElementById('modalCarga');

let currentUser = null;
let personagem = null;
let historia = null;
let capituloAtual = null;
let inimigos = [];
let sessaoId = null;
let turnoAtual = 'jogador';
let inimigoSelecionado = null;
let armaSelecionada = null;
let timerHomem = null;
let atoAtual = 1;

let pvAtual = 0;
let pvMax = 0;
let fadigaAtual = 0;
let fadigaMax = 0;
let manaAtual = 0;
let manaMax = 0;
let xpAtual = 0;
let pmAtual = 0;
let bolinhasDisponiveisCount = 0;

let atributos = {
    st: { valor: 9, bolinhas: 0, base: 9 },
    dx: { valor: 5, bolinhas: 0, base: 5 },
    iq: { valor: 5, bolinhas: 0, base: 5 },
    ht: { valor: 8, bolinhas: 0, base: 8 }
};

let vantagens = [];
let desvantagens = [];
let fobia = null;
let pericias = {};
let escolas = {
    agua: {
        magias: {
            localizarAgua: { nivel: 0, desbloqueada: false, tipo: 'Informação' },
            purificarAgua: { nivel: 0, desbloqueada: false, tipo: 'Utilitária' },
            criarAgua: { nivel: 0, desbloqueada: false, tipo: 'Utilitária' },
            dissiparAgua: { nivel: 0, desbloqueada: false, tipo: 'Área' },
            adagaDeGelo: { nivel: 0, desbloqueada: false, tipo: 'Ataque' },
            respirarNaAgua: { nivel: 0, desbloqueada: false, tipo: 'Suporte' },
            moldarAgua: { nivel: 0, desbloqueada: false, tipo: 'Controle' },
            nevoeiro: { nivel: 0, desbloqueada: false, tipo: 'Área' },
            armaCongelante: { nivel: 0, desbloqueada: false, tipo: 'Encanto' },
            cortinaDagua: { nivel: 0, desbloqueada: false, tipo: 'Defesa' },
            jatoDeAgua: { nivel: 0, desbloqueada: false, tipo: 'Ataque' },
            ondaExpulsora: { nivel: 0, desbloqueada: false, tipo: 'Ataque/Área' },
            tempestadeDeGelo: { nivel: 0, desbloqueada: false, tipo: 'Área' },
            congelamento: { nivel: 0, desbloqueada: false, tipo: 'Paralisia' }
        }
    }
};
let esferasDesbloqueadas = 0;
let inventario = { corpo: [], mochila: [], deposito: [] };
let dinheiro = 0;

const XP_POR_BOLINHA = 100;
const catalogoPericias = [
    { id: "espada", nome: "Espada", tipo: "fisica", atributo: "dx", descricao: "Lutar com espadas" },
    { id: "arco", nome: "Arco", tipo: "fisica", atributo: "dx", descricao: "Atirar com arco" },
    { id: "escudo", nome: "Escudo", tipo: "fisica", atributo: "dx", descricao: "Bloquear com escudo" },
    { id: "furtividade", nome: "Furtividade", tipo: "fisica", atributo: "dx", descricao: "Esgueirar-se" },
    { id: "persuasao", nome: "Persuasão", tipo: "mental", atributo: "iq", descricao: "Convencer alguém" },
    { id: "intimidacao", nome: "Intimidação", tipo: "mental", atributo: "iq", descricao: "Assustar" },
    { id: "medicina", nome: "Medicina", tipo: "mental", atributo: "iq", descricao: "Curar ferimentos" },
    { id: "primeirosSocorros", nome: "Primeiros Socorros", tipo: "mental", atributo: "iq", descricao: "Atendimento emergencial" },
    { id: "natacao", nome: "Natação", tipo: "organica", atributo: "ht", descricao: "Nadar" },
    { id: "caminhada", nome: "Caminhada", tipo: "organica", atributo: "ht", descricao: "Andar longas distâncias" },
    { id: "acrobacia", nome: "Acrobacia", tipo: "fisica", atributo: "dx", descricao: "Saltos e cambalhotas" },
    { id: "cavalgar", nome: "Cavalgar", tipo: "fisica", atributo: "dx", descricao: "Montar em animais" },
    { id: "ladinagem", nome: "Ladinagem", tipo: "fisica", atributo: "dx", descricao: "Abrir fechaduras, desarmar armadilhas" },
    { id: "diplomacia", nome: "Diplomacia", tipo: "mental", atributo: "iq", descricao: "Negociar e resolver conflitos" },
    { id: "intuicao", nome: "Intuição", tipo: "mental", atributo: "iq", descricao: "Perceber intenções" },
    { id: "sobrevivencia", nome: "Sobrevivência", tipo: "mental", atributo: "iq", descricao: "Sobreviver na natureza" }
];

const tabelaDano = {
    9: "1d-1", 10: "1d", 11: "1d+1", 12: "1d+2",
    13: "2d-1", 14: "2d", 15: "2d+1", 16: "2d+2",
    17: "3d-1", 18: "3d", 19: "3d+1", 20: "3d+2"
};

const vantagensData = {
    aptidaoMagica: { nome: 'Aptidão Mágica', descricao: '+1 em magias. Desbloqueia uso de magias.' },
    carisma: { nome: 'Carisma', descricao: '+1 em reações sociais, Persuasão e Lábia.' },
    destemor: { nome: 'Destemor', descricao: '+3 para resistir a Intimidação e Medo.' },
    reflexoCombate: { nome: 'Reflexo de Combate', descricao: '+1 em Esquiva, Aparar, Bloqueio. +2 Iniciativa.' },
    visaoNoturna: { nome: 'Visão Noturna', descricao: 'Enxerga no escuro sem penalidades.' },
    sorte: { nome: 'Sorte', descricao: '2/sessão. Pode rerrolar qualquer jogada.' },
    rico: { nome: 'Rico', descricao: 'Começa com 5× o valor base de dinheiro.' },
    atraente: { nome: 'Atraente', descricao: '+2 em reações sociais.' },
    mestreArmas: { nome: 'Mestre das Armas', descricao: '+1 ataque, 2 ataques por turno.' },
    forcaVontade: { nome: 'Força de Vontade', descricao: '+2 em resistências que usam Força de Vontade.' },
    fadigaExtra: { nome: 'Fadiga Extra', descricao: '+10% de Fadiga.' },
    htExtra: { nome: 'HT Extra', descricao: '+5% de PV.' },
    ambidistria: { nome: 'Ambidestria', descricao: 'Pode atacar duas vezes com armas de uma mão.' }
};

const desvantagensData = {
    pobre: { nome: 'Pobre', descricao: 'Começa com metade do dinheiro.' },
    feio: { nome: 'Feio', descricao: '-2 em reações sociais.' },
    magro: { nome: 'Magro', descricao: '-20% peso, vulnerável a quedas.' },
    gordo: { nome: 'Gordo', descricao: '+20% peso, perde fadiga rápido.' },
    nanismo: { nome: 'Nanismo', descricao: '-1 deslocamento, altura máx 1.30m.' },
    alcoolismo: { nome: 'Alcoolismo', descricao: 'Vício em bebida.' },
    avareza: { nome: 'Avareza', descricao: 'Mesquinho, ama dinheiro.' },
    briguento: { nome: 'Briguento', descricao: 'Adora uma briga.' },
    cobiça: { nome: 'Cobiça', descricao: 'Quer tudo que vê.' },
    cleptomania: { nome: 'Cleptomania', descricao: 'Compulsão por roubar.' },
    codigoHonra: { nome: 'Código de Honra', descricao: 'Segue regras rígidas.' },
    covardia: { nome: 'Covardia', descricao: 'Foge de perigo.' },
    excessoConfianca: { nome: 'Excesso de Confiança', descricao: 'Se acha mais capaz.' },
    honestidade: { nome: 'Honestidade', descricao: 'Não consegue mentir.' },
    preguiça: { nome: 'Preguiça', descricao: 'Evita esforço.' },
    teimosia: { nome: 'Teimosia', descricao: 'Não muda de ideia.' }
};

const nomesMagia = {
    localizarAgua: 'Localizar Água', purificarAgua: 'Purificar Água', criarAgua: 'Criar Água',
    dissiparAgua: 'Dissipar Água', adagaDeGelo: 'Adaga de Gelo', respirarNaAgua: 'Respirar na Água',
    moldarAgua: 'Moldar Água', nevoeiro: 'Nevoeiro', armaCongelante: 'Arma Congelante',
    cortinaDagua: 'Cortina D\'água', jatoDeAgua: 'Jato de Água', ondaExpulsora: 'Onda Expulsora',
    tempestadeDeGelo: 'Tempestade de Gelo', congelamento: 'Congelamento'
};

function showLoading() { loadingOverlay.classList.add('active'); }
function hideLoading() { loadingOverlay.classList.remove('active'); }

function adicionarLog(mensagem, tipo = 'info') {
    const logItem = document.createElement('div');
    logItem.className = `log-item ${tipo}`;
    logItem.innerHTML = mensagem;
    logContainer.appendChild(logItem);
    logContainer.scrollTop = logContainer.scrollHeight;
    while (logContainer.children.length > 30) {
        logContainer.removeChild(logContainer.firstChild);
    }
}

function rolarDados(quantidade, faces, modificador = 0) {
    let total = 0;
    let resultados = [];
    for (let i = 0; i < quantidade; i++) {
        const resultado = Math.floor(Math.random() * faces) + 1;
        resultados.push(resultado);
        total += resultado;
    }
    total += modificador;
    return {
        total: total,
        resultados: resultados,
        modificador: modificador,
        texto: `${resultados.join(' + ')} ${modificador >= 0 ? '+' : '-'} ${Math.abs(modificador)} = ${total}`
    };
}

function rolar2d10() { return rolarDados(2, 10, 0); }

function setAto(numero, texto) {
    atoAtual = numero;
    atoTexto.textContent = `Ato ${numero}: ${texto}`;
    adicionarLog(`📜 Ato ${numero}: ${texto}`, 'sucesso');
}

function getValorAtributo(atributo) {
    if (!personagem || !personagem.atributos) return 0;
    const base = { st: 9, dx: 5, iq: 5, ht: 8 }[atributo];
    const bolinhas = personagem.atributos[atributo]?.bolinhas || 0;
    return base + bolinhas;
}

function calcularLevel() {
    if (!personagem || !personagem.atributos) return 0;
    const stBolinhas = personagem.atributos.st?.bolinhas || 0;
    const dxBolinhas = personagem.atributos.dx?.bolinhas || 0;
    const iqBolinhas = personagem.atributos.iq?.bolinhas || 0;
    const htBolinhas = personagem.atributos.ht?.bolinhas || 0;
    return stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
}

function calcularManaMax() {
    const iq = getValorAtributo('iq');
    const ht = getValorAtributo('ht');
    return iq + ht;
}

function calcularPVMax() {
    const ht = getValorAtributo('ht');
    let pv = ht * 8;
    if (vantagens.includes('htExtra')) pv = Math.floor(pv * 1.05);
    return pv;
}

function calcularFadigaMax() {
    if (!personagem) return 8;
    const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
    let fadiga = 8 + htBolinhas;
    if (vantagens.includes('fadigaExtra')) fadiga = Math.floor(fadiga * 1.1);
    return fadiga;
}

function calcularPMAtual() {
    if (!personagem) return 0;
    const disponivel = personagem.pmDisponivel || 30;
    const gasto = personagem.pmGasto || 0;
    return Math.max(0, disponivel - gasto);
}

function verificarGanhoBolinha() {
    if (!personagem) return;
    
    const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
    const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
    const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
    const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
    const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
    const xpNecessario = (totalBolinhas + bolinhasDisponiveisCount + 1) * XP_POR_BOLINHA;
    
    while (xpAtual >= xpNecessario) {
        bolinhasDisponiveisCount++;
        xpAtual -= xpNecessario;
        adicionarLog(`🌟 Você ganhou uma esfera! Level ${totalBolinhas + bolinhasDisponiveisCount + 1}`, 'sucesso');
        
        const novoTotal = totalBolinhas + bolinhasDisponiveisCount;
        const proximoXP = (novoTotal + 1) * XP_POR_BOLINHA;
        headerXP.textContent = `${xpAtual}/${proximoXP}`;
        headerXPBarra.style.width = (xpAtual / proximoXP * 100) + '%';
    }
    
    atualizarInterfaceBolinhas();
}

function atualizarInterfaceBolinhas() {
    if (bolinhasDisponiveisCount > 0) {
        bolinhasDisponiveisContainer.style.display = 'flex';
        bolinhasDisponiveis.textContent = bolinhasDisponiveisCount;
        document.querySelectorAll('.atributo-card').forEach(card => {
            card.classList.add('bolinha-disponivel');
        });
    } else {
        bolinhasDisponiveisContainer.style.display = 'none';
        document.querySelectorAll('.atributo-card').forEach(card => {
            card.classList.remove('bolinha-disponivel');
        });
    }
}

function abrirModalEscolhaAtributo() {
    if (bolinhasDisponiveisCount <= 0) return;
    
    valorStModal.textContent = getValorAtributo('st');
    valorDxModal.textContent = getValorAtributo('dx');
    valorIqModal.textContent = getValorAtributo('iq');
    valorHtModal.textContent = getValorAtributo('ht');
    
    const levelAtual = calcularLevel();
    document.getElementById('novoLevelDisplay').textContent = levelAtual + 1;
    
    modalEscolhaAtributo.classList.add('active');
}

function adicionarBolinha(atributo) {
    if (bolinhasDisponiveisCount <= 0) return;
    
    if (!personagem.atributos[atributo]) {
        personagem.atributos[atributo] = { bolinhas: 0 };
    }
    personagem.atributos[atributo].bolinhas = (personagem.atributos[atributo].bolinhas || 0) + 1;
    bolinhasDisponiveisCount--;
    
    pvMax = calcularPVMax();
    manaMax = calcularManaMax();
    fadigaMax = calcularFadigaMax();
    
    const novoLevel = calcularLevel();
    levelValor.textContent = novoLevel;
    fichaLevel.textContent = novoLevel;
    
    adicionarLog(`✨ Esfera aplicada em ${atributo.toUpperCase()}! Level ${novoLevel}`, 'sucesso');
    
    atualizarFichaPersonagem();
    salvarProgresso();
    
    if (bolinhasDisponiveisCount > 0) {
        abrirModalEscolhaAtributo();
    } else {
        modalEscolhaAtributo.classList.remove('active');
    }
}

function abrirModalInventario() {
    if (!personagem || !personagem.inventario) return;
    
    inventarioEquipado.innerHTML = '';
    if (personagem.inventario.corpo && personagem.inventario.corpo.length > 0) {
        personagem.inventario.corpo.forEach(item => {
            inventarioEquipado.innerHTML += `
                <div class="item-card">
                    <div class="nome">${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}</div>
                    <div class="detalhes">
                        <span>${item.peso || 0} kg</span>
                        <span>${item.preco || 0} $</span>
                    </div>
                    <div class="item-acoes">
                        <button class="item-acao" onclick="guardarItem('${item.id}')">Guardar</button>
                    </div>
                </div>
            `;
        });
    } else {
        inventarioEquipado.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Nada equipado</div>';
    }
    
    inventarioMochila.innerHTML = '';
    if (personagem.inventario.mochila && personagem.inventario.mochila.length > 0) {
        personagem.inventario.mochila.forEach(item => {
            inventarioMochila.innerHTML += `
                <div class="item-card">
                    <div class="nome">${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}</div>
                    <div class="detalhes">
                        <span>${item.peso || 0} kg</span>
                        <span>${item.preco || 0} $</span>
                    </div>
                    <div class="item-acoes">
                        <button class="item-acao" onclick="equiparItem('${item.id}')">Equipar</button>
                        <button class="item-acao" onclick="moverParaDeposito('${item.id}')">Depósito</button>
                    </div>
                </div>
            `;
        });
    } else {
        inventarioMochila.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Mochila vazia</div>';
    }
    
    inventarioDeposito.innerHTML = '';
    if (personagem.inventario.deposito && personagem.inventario.deposito.length > 0) {
        personagem.inventario.deposito.forEach(item => {
            inventarioDeposito.innerHTML += `
                <div class="item-card">
                    <div class="nome">${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}</div>
                    <div class="detalhes">
                        <span>${item.peso || 0} kg</span>
                        <span>${item.preco || 0} $</span>
                    </div>
                    <div class="item-acoes">
                        <button class="item-acao" onclick="pegarItem('${item.id}')">Pegar</button>
                    </div>
                </div>
            `;
        });
    } else {
        inventarioDeposito.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Depósito vazio</div>';
    }
    
    modalDinheiro.textContent = personagem.dinheiro || 0;
    
    let pesoTotal = 0;
    ['corpo', 'mochila'].forEach(local => {
        if (personagem.inventario[local]) {
            personagem.inventario[local].forEach(item => {
                pesoTotal += (item.peso || 0) * (item.quantidade || 1);
            });
        }
    });
    
    const st = getValorAtributo('st');
    const limiteCarga = st * 12;
    modalCarga.textContent = `${pesoTotal.toFixed(1)}/${limiteCarga} kg`;
    
    modalInventario.classList.add('active');
}

window.equiparItem = function(itemId) {
    if (!personagem?.inventario) return;
    const index = personagem.inventario.mochila.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.mochila[index];
        personagem.inventario.corpo.push(item);
        personagem.inventario.mochila.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

window.guardarItem = function(itemId) {
    if (!personagem?.inventario) return;
    const index = personagem.inventario.corpo.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.corpo[index];
        personagem.inventario.mochila.push(item);
        personagem.inventario.corpo.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

window.moverParaDeposito = function(itemId) {
    if (!personagem?.inventario) return;
    const index = personagem.inventario.mochila.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.mochila[index];
        personagem.inventario.deposito.push(item);
        personagem.inventario.mochila.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

window.pegarItem = function(itemId) {
    if (!personagem?.inventario) return;
    const index = personagem.inventario.deposito.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.deposito[index];
        personagem.inventario.mochila.push(item);
        personagem.inventario.deposito.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

function calcularBonusPericia(periciaId) {
    let bonus = 0;
    if (vantagens.includes('carisma') && (periciaId === 'persuasao' || periciaId === 'intimidacao')) bonus += 1;
    if (vantagens.includes('destemor') && periciaId === 'intimidacao') bonus += 3;
    return bonus;
}

function calcularNHPericia(periciaId) {
    const pericia = pericias[periciaId];
    if (!pericia) return null;
    
    const periciaInfo = catalogoPericias.find(p => p.id === periciaId);
    if (!periciaInfo) return 0;
    
    let atributoBase = 0;
    if (periciaInfo.atributo === 'st') atributoBase = getValorAtributo('st');
    else if (periciaInfo.atributo === 'dx') atributoBase = getValorAtributo('dx');
    else if (periciaInfo.atributo === 'iq') atributoBase = getValorAtributo('iq');
    else if (periciaInfo.atributo === 'ht') atributoBase = getValorAtributo('ht');
    
    const bonusNivel = pericia.nivel === 1 ? 0 : pericia.nivel - 1;
    const bonusVantagem = calcularBonusPericia(periciaId);
    
    return atributoBase + bonusNivel + bonusVantagem;
}

function calcularEsquiva() {
    if (!personagem) return 0;
    const dx = getValorAtributo('dx');
    const ht = getValorAtributo('ht');
    let esquiva = Math.floor((dx + ht) / 6) + 6;
    if (vantagens.includes('reflexoCombate')) esquiva += 1;
    return esquiva;
}

function calcularAparar() {
    if (!personagem) return 0;
    const dx = getValorAtributo('dx');
    const temArma = personagem.inventario?.corpo?.some(item => item.dano);
    if (!temArma) return 0;
    let aparar = Math.floor((dx + dx) / 4) + 6;
    if (vantagens.includes('reflexoCombate')) aparar += 1;
    if (vantagens.includes('mestreArmas')) aparar += 1;
    return aparar;
}

function calcularBloqueio() {
    if (!personagem) return 0;
    const dx = getValorAtributo('dx');
    const temEscudo = personagem.inventario?.corpo?.some(item => item.tipo === 'escudo' || item.nome?.toLowerCase().includes('escudo'));
    if (!temEscudo) return 0;
    let bloqueio = Math.floor((dx + dx) / 4) + 6 + 2;
    if (vantagens.includes('reflexoCombate')) bloqueio += 1;
    return bloqueio;
}

// ===== FUNÇÃO CORRIGIDA - MOSTRA TODAS AS PERÍCIAS SEM LIMITE =====
function abrirModalPericias() {
    periciasModalGrid.innerHTML = '';
    
    const periciasArray = Object.entries(pericias);
    if (periciasArray.length === 0) {
        periciasModalGrid.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center; grid-column:span 2;">Nenhuma perícia adquirida</div>';
    } else {
        // Ordena alfabeticamente para melhor visualização
        periciasArray.sort((a, b) => {
            const nomeA = catalogoPericias.find(p => p.id === a[0])?.nome || a[0];
            const nomeB = catalogoPericias.find(p => p.id === b[0])?.nome || b[0];
            return nomeA.localeCompare(nomeB);
        });
        
        // MOSTRA TODAS AS PERÍCIAS - SEM LIMITE
        periciasArray.forEach(([id, dados]) => {
            const periciaInfo = catalogoPericias.find(p => p.id === id);
            if (!periciaInfo) return;
            
            const nh = calcularNHPericia(id);
            const bonusVantagem = calcularBonusPericia(id);
            const bonusTexto = bonusVantagem > 0 ? ` +${bonusVantagem} (vantagem)` : '';
            
            periciasModalGrid.innerHTML += `
                <div class="pericia-card-modal">
                    <h4>${periciaInfo.nome}</h4>
                    <div class="descricao">${periciaInfo.descricao}</div>
                    <div class="nh">NH ${nh} (Nível ${dados.nivel}${bonusTexto})</div>
                </div>
            `;
        });
    }
    
    modalPericias.classList.add('active');
}

function abrirModalVantagens() {
    vantagensModalGrid.innerHTML = '';
    
    if (vantagens.length === 0) {
        vantagensModalGrid.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center; grid-column:span 2;">Nenhuma vantagem</div>';
    } else {
        vantagens.forEach(v => {
            const vantagemInfo = vantagensData[v] || { nome: v, descricao: '' };
            vantagensModalGrid.innerHTML += `
                <div class="vantagem-card-modal">
                    <h4>${vantagemInfo.nome}</h4>
                    <div class="descricao">${vantagemInfo.descricao}</div>
                </div>
            `;
        });
    }
    
    modalVantagens.classList.add('active');
}

function abrirModalDesvantagens() {
    desvantagensModalGrid.innerHTML = '';
    
    const desvantagensLista = [...desvantagens];
    if (fobia) desvantagensLista.push(`fobia:${fobia}`);
    
    if (desvantagensLista.length === 0) {
        desvantagensModalGrid.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center; grid-column:span 2;">Nenhuma desvantagem</div>';
    } else {
        desvantagensLista.forEach(d => {
            if (d.startsWith('fobia:')) {
                const fobiaNome = d.split(':')[1];
                desvantagensModalGrid.innerHTML += `
                    <div class="desvantagem-card-modal">
                        <h4>Fobia: ${fobiaNome}</h4>
                        <div class="descricao">Medo específico que causa penalidades em situações de estresse.</div>
                        <span class="fobia-tag">Fobia</span>
                    </div>
                `;
            } else {
                const desvInfo = desvantagensData[d] || { nome: d, descricao: '' };
                desvantagensModalGrid.innerHTML += `
                    <div class="desvantagem-card-modal">
                        <h4>${desvInfo.nome}</h4>
                        <div class="descricao">${desvInfo.descricao}</div>
                    </div>
                `;
            }
        });
    }
    
    modalDesvantagens.classList.add('active');
}

function abrirModalMagias() {
    magiasModalGrid.innerHTML = '';
    
    if (!vantagens.includes('aptidaoMagica')) {
        magiasModalGrid.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center; grid-column:span 2;">Você não possui Aptidão Mágica</div>';
    } else {
        const magiasLista = Object.entries(escolas?.agua?.magias || {}).filter(([_, m]) => m.desbloqueada);
        if (magiasLista.length === 0) {
            magiasModalGrid.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center; grid-column:span 2;">Nenhuma magia desbloqueada</div>';
        } else {
            magiasLista.forEach(([id, magia]) => {
                magiasModalGrid.innerHTML += `
                    <div class="magia-card-modal">
                        <h4>${nomesMagia[id] || id}</h4>
                        <div class="descricao">Tipo: ${magia.tipo}</div>
                        <div class="nivel">Nível ${magia.nivel}</div>
                    </div>
                `;
            });
        }
    }
    
    modalMagias.classList.add('active');
}

function atualizarFichaPersonagem() {
    if (!personagem) return;
    
    headerNome.textContent = personagem.nome || 'Aventureiro';
    
    const classes = {
        guerreiro: 'Guerreiro', mago: 'Mago', ladino: 'Ladino',
        clerigo: 'Clérigo', barbaro: 'Bárbaro'
    };
    headerClasse.textContent = classes[personagem.classe] || personagem.classe || '';
    
    if (personagem.fotoURL) {
        headerAvatar.innerHTML = `<img src="${personagem.fotoURL}" alt="Avatar">`;
        fichaAvatar.innerHTML = `<img src="${personagem.fotoURL}" alt="Avatar">`;
    }
    
    pvMax = calcularPVMax();
    pvAtual = personagem.statusCombate?.vidaAtual || pvMax;
    headerPV.textContent = `${pvAtual}/${pvMax}`;
    headerPVBarra.style.width = (pvAtual / pvMax * 100) + '%';
    
    fadigaMax = calcularFadigaMax();
    fadigaAtual = personagem.statusCombate?.fadigaAtual || fadigaMax;
    headerFadiga.textContent = `${fadigaAtual}/${fadigaMax}`;
    headerFadigaBarra.style.width = (fadigaAtual / fadigaMax * 100) + '%';
    
    manaMax = calcularManaMax();
    manaAtual = personagem.statusCombate?.manaAtual || manaMax;
    headerMana.textContent = `${manaAtual}/${manaMax}`;
    headerManaBarra.style.width = (manaAtual / manaMax * 100) + '%';
    
    const level = calcularLevel();
    levelValor.textContent = level;
    fichaLevel.textContent = level;
    
    const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
    const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
    const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
    const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
    const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
    const xpNecessario = (totalBolinhas + bolinhasDisponiveisCount + 1) * XP_POR_BOLINHA;
    
    headerXP.textContent = `${xpAtual}/${xpNecessario}`;
    headerXPBarra.style.width = (xpAtual / xpNecessario * 100) + '%';
    
    pmAtual = calcularPMAtual();
    pmValor.textContent = pmAtual;
    
    fichaNome.textContent = personagem.nome || 'Aventureiro';
    fichaClasse.textContent = classes[personagem.classe] || personagem.classe || '';
    
    const st = getValorAtributo('st');
    const dx = getValorAtributo('dx');
    const iq = getValorAtributo('iq');
    const ht = getValorAtributo('ht');
    
    const criarBolinhasHTML = (atrib, total) => {
        let html = '';
        for (let i = 0; i < 15; i++) {
            if (i < total) {
                html += '<div class="bolinha-pequena preenchida"></div>';
            } else {
                html += '<div class="bolinha-pequena"></div>';
            }
        }
        return html;
    };
    
    atributosContainer.innerHTML = `
        <div class="atributo-card ${bolinhasDisponiveisCount > 0 ? 'bolinha-disponivel' : ''}" data-atributo="st">
            <div class="atributo-info">
                <span class="atributo-nome">ST</span>
                <div class="atributo-bolinhas">${criarBolinhasHTML('st', personagem.atributos?.st?.bolinhas || 0)}</div>
            </div>
            <div>
                <span class="atributo-valor">${st}</span>
            </div>
        </div>
        
        <div class="atributo-card ${bolinhasDisponiveisCount > 0 ? 'bolinha-disponivel' : ''}" data-atributo="dx">
            <div class="atributo-info">
                <span class="atributo-nome">DX</span>
                <div class="atributo-bolinhas">${criarBolinhasHTML('dx', personagem.atributos?.dx?.bolinhas || 0)}</div>
            </div>
            <div>
                <span class="atributo-valor">${dx}</span>
            </div>
        </div>
        
        <div class="atributo-card ${bolinhasDisponiveisCount > 0 ? 'bolinha-disponivel' : ''}" data-atributo="iq">
            <div class="atributo-info">
                <span class="atributo-nome">IQ</span>
                <div class="atributo-bolinhas">${criarBolinhasHTML('iq', personagem.atributos?.iq?.bolinhas || 0)}</div>
            </div>
            <div>
                <span class="atributo-valor">${iq}</span>
            </div>
        </div>
        
        <div class="atributo-card ${bolinhasDisponiveisCount > 0 ? 'bolinha-disponivel' : ''}" data-atributo="ht">
            <div class="atributo-info">
                <span class="atributo-nome">HT</span>
                <div class="atributo-bolinhas">${criarBolinhasHTML('ht', personagem.atributos?.ht?.bolinhas || 0)}</div>
            </div>
            <div>
                <span class="atributo-valor">${ht}</span>
            </div>
        </div>
    `;
    
    document.querySelectorAll('.atributo-card').forEach(card => {
        card.addEventListener('click', () => {
            if (bolinhasDisponiveisCount > 0) {
                const atributo = card.dataset.atributo;
                adicionarBolinha(atributo);
            }
        });
    });
    
    const esquiva = calcularEsquiva();
    const aparar = calcularAparar();
    const bloqueio = calcularBloqueio();
    
    defesasGrid.innerHTML = `
        <div class="defesa-card">
            <div class="defesa-valor">${esquiva}</div>
            <div class="defesa-label">Esq</div>
        </div>
        <div class="defesa-card">
            <div class="defesa-valor">${aparar}</div>
            <div class="defesa-label">Apr</div>
        </div>
        <div class="defesa-card">
            <div class="defesa-valor">${bloqueio}</div>
            <div class="defesa-label">Blq</div>
        </div>
    `;
    
    let itensHTML = '';
    let pesoTotal = 0;
    
    if (personagem.inventario?.corpo) {
        personagem.inventario.corpo.slice(0, 2).forEach(item => {
            itensHTML += `<div class="item-rapido">
                <span class="nome">⚔️ ${item.nome}</span>
                <span class="quantidade">${item.quantidade || 1}x</span>
            </div>`;
            pesoTotal += (item.peso || 0) * (item.quantidade || 1);
        });
    }
    
    if (personagem.inventario?.mochila) {
        personagem.inventario.mochila.slice(0, 2).forEach(item => {
            itensHTML += `<div class="item-rapido">
                <span class="nome">🎒 ${item.nome}</span>
                <span class="quantidade">${item.quantidade || 1}x</span>
            </div>`;
            pesoTotal += (item.peso || 0) * (item.quantidade || 1);
        });
    }
    
    if (itensHTML === '') {
        itensHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Vazio</div>';
    }
    
    itensRapidosLista.innerHTML = itensHTML;
    
    const limiteCarga = st * 12;
    cargaRapida.textContent = `${pesoTotal.toFixed(1)}/${limiteCarga} kg`;
    
    atualizarInterfaceBolinhas();
}

function carregarCena(cenaId) {
    if (!cenaId) return;
    
    if (typeof cenaId === 'string') {
        const cena = historia.cenas[cenaId];
        if (!cena) return;
        capituloAtual = cena;
    } else {
        capituloAtual = cenaId;
    }
    
    if (!capituloAtual) return;
    
    if (cenaId === 'exterior_taverna' || cenaId === 'interior_taverna') {
        setAto(1, 'A Taverna');
    } else if (cenaId === 'interior_taverna_com_homem' || cenaId === 'homem_fala_detalhes') {
        setAto(2, 'O Homem Ferido');
    } else if (cenaId === 'sair_para_aventura') {
        setAto(3, 'A Missão');
    } else if (cenaId === 'encontro_camponesa' || cenaId === 'carroca_destruida' || cenaId === 'clareira_goblins') {
        setAto(4, 'A Floresta');
    } else if (cenaId === 'entrada_caverna' || cenaId === 'camara_chefe') {
        setAto(5, 'A Caverna');
    } else if (cenaId === 'final_vitoria' || cenaId === 'final_taverna') {
        setAto(6, 'O Retorno');
    }
    
    if (capituloAtual.imagem) {
        cenarioArea.style.backgroundImage = `url('${capituloAtual.imagem}')`;
    } else {
        cenarioArea.style.backgroundImage = 'none';
    }
    
    npcsContainer.innerHTML = '';
    if (capituloAtual.npcs) {
        capituloAtual.npcs.forEach(npc => {
            if (npc.visivel === false) return;
            
            const npcDiv = document.createElement('div');
            npcDiv.className = 'npc-sprite';
            
            if (npc.id === 'taverneiro') {
                npcDiv.style.left = '85%';
                npcDiv.style.top = '60%';
            } else if (npc.id === 'homem_sangue') {
                npcDiv.style.left = '25%';
                npcDiv.style.top = '50%';
            } else if (npc.id === 'camponesa') {
                npcDiv.style.left = '40%';
                npcDiv.style.top = '55%';
            } else if (npc.id === 'menina_elfa') {
                npcDiv.style.left = '50%';
                npcDiv.style.top = '60%';
            } else if (npc.id === 'chefe_goblin') {
                npcDiv.style.left = '60%';
                npcDiv.style.top = '50%';
            } else {
                npcDiv.style.left = (npc.x || 50) + '%';
                npcDiv.style.top = (npc.y || 50) + '%';
            }
            
            npcDiv.dataset.npcId = npc.id;
            
            npcDiv.innerHTML = `
                <img src="${npc.sprite || 'default.png'}" alt="${npc.nome}">
                <div class="npc-nome">${npc.nome}</div>
            `;
            
            npcDiv.addEventListener('click', () => {
                falarComNPC(npc);
            });
            
            npcsContainer.appendChild(npcDiv);
        });
    }
    
    if (capituloAtual.fala) {
        npcNome.textContent = capituloAtual.fala.npc || 'Narrador';
        dialogoTexto.textContent = capituloAtual.fala.texto;
    } else {
        dialogoTexto.textContent = '...';
    }
    
    renderizarOpcoes(capituloAtual.opcoes);
    
    if (cenaId === 'interior_taverna') {
        iniciarTimerHomem();
    }
}

function renderizarOpcoes(opcoes) {
    opcoesDialogo.innerHTML = '';
    
    if (!opcoes || opcoes.length === 0) {
        const btnSair = document.createElement('button');
        btnSair.className = 'opcao-btn';
        btnSair.textContent = 'Sair da taverna';
        btnSair.addEventListener('click', () => {
            carregarCena('exterior_taverna');
        });
        opcoesDialogo.appendChild(btnSair);
        return;
    }
    
    opcoes.forEach(opcao => {
        const btn = document.createElement('button');
        btn.className = 'opcao-btn';
        btn.textContent = opcao.texto;
        
        btn.addEventListener('click', () => {
            if (opcao.proximo) {
                carregarCena(opcao.proximo);
            } else if (opcao.acao === 'iniciar_combate') {
                iniciarCombate(opcao.inimigos || []);
            } else if (opcao.resposta) {
                dialogoTexto.textContent = opcao.resposta;
                if (opcao.proximo_apos_resposta) {
                    setTimeout(() => carregarCena(opcao.proximo_apos_resposta), 2000);
                }
            } else if (opcao.acao === 'iniciar_timer') {
                dialogoTexto.textContent = opcao.resposta || 'Você observa o ambiente...';
                iniciarTimerHomem();
            } else if (opcao.tipo === 'pagar') {
                if (personagem.dinheiro >= opcao.valor) {
                    personagem.dinheiro -= opcao.valor;
                    dialogoTexto.textContent = opcao.sucesso || 'Negócio feito!';
                    adicionarLog(`💰 Pagou ${opcao.valor} moedas`, 'sucesso');
                    atualizarFichaPersonagem();
                } else {
                    dialogoTexto.textContent = opcao.falha || 'Você não tem dinheiro suficiente!';
                }
            } else if (opcao.item) {
                if (!personagem.inventario.mochila) personagem.inventario.mochila = [];
                personagem.inventario.mochila.push({
                    id: opcao.item.id,
                    nome: opcao.item.nome,
                    descricao: opcao.item.descricao,
                    peso: opcao.item.peso || 0.1,
                    quantidade: 1,
                    preco: opcao.item.preco || 0
                });
                adicionarLog(`📦 Você pegou: ${opcao.item.nome}`, 'sucesso');
                dialogoTexto.textContent = opcao.resposta || `Você pegou ${opcao.item.nome}.`;
            } else if (opcao.acao === 'finalizar_aventura') {
                adicionarLog('🎉 Aventura concluída! Parabéns!', 'sucesso');
                setTimeout(() => {
                    window.location.href = 'aventura-solo.html';
                }, 5000);
            }
            
            atualizarFichaPersonagem();
            salvarProgresso();
        });
        
        opcoesDialogo.appendChild(btn);
    });
}

function falarComNPC(npc) {
    npcNome.textContent = npc.nome;
    dialogoTexto.textContent = npc.dialogo || '...';
    
    if (npc.opcoes) {
        renderizarOpcoes(npc.opcoes);
    } else {
        renderizarOpcoes([]);
    }
}

function iniciarTimerHomem() {
    if (timerHomem) clearTimeout(timerHomem);
    adicionarLog('⏳ Você observa o ambiente...', 'info');
    
    timerHomem = setTimeout(() => {
        adicionarLog('🚪 A porta se abre violentamente! Um homem ensanguentado entra cambaleando!', 'dano');
        carregarCena('interior_taverna_com_homem');
    }, 40000);
}

function iniciarCombate(inimigosIds) {
    turnoAtual = 'jogador';
    turnoIndicator.className = 'turno-indicator jogador';
    turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
    
    inimigos = [];
    if (capituloAtual.inimigos) {
        inimigosIds.forEach(id => {
            const inimigoData = capituloAtual.inimigos.find(i => i.id === id);
            if (inimigoData) {
                inimigos.push({
                    ...inimigoData,
                    pv: inimigoData.pv || inimigoData.pv_max,
                    pv_max: inimigoData.pv_max || inimigoData.pv
                });
            }
        });
    }
    
    if (inimigos.length === 0) {
        inimigos = inimigosIds.map((id, index) => ({
            id: id,
            nome: `Inimigo ${index + 1}`,
            pv: 20,
            pv_max: 20,
            esquiva: 8,
            nh_ataque: 10,
            dano: "1d6",
            xp: 15
        }));
    }
    
    inimigosContainer.style.display = 'block';
    renderizarInimigos();
    adicionarLog('⚔️ COMBATE INICIADO!', 'sucesso');
}

function renderizarInimigos() {
    inimigosLista.innerHTML = inimigos.map((inimigo, index) => `
        <div class="inimigo-mini ${inimigoSelecionado === index ? 'selecionado' : ''}" data-index="${index}">
            <div class="inimigo-mini-nome">${inimigo.nome}</div>
            <div class="inimigo-mini-pv">
                <div class="inimigo-mini-pv-fill" style="width: ${(inimigo.pv / inimigo.pv_max) * 100}%"></div>
            </div>
            <div style="font-size:0.65rem; text-align:center;">${inimigo.pv}/${inimigo.pv_max}</div>
        </div>
    `).join('');
    
    document.querySelectorAll('.inimigo-mini').forEach(card => {
        card.addEventListener('click', () => {
            const index = parseInt(card.dataset.index);
            inimigoSelecionado = index;
            renderizarInimigos();
            btnAtacar.disabled = false;
        });
    });
}

function getArmasEquipadas() {
    if (!personagem?.inventario?.corpo) return [];
    
    return personagem.inventario.corpo.filter(item => item.dano).map(item => ({
        id: item.id,
        nome: item.nome,
        dano: item.dano,
        tipo: item.tipoDano || 'Desconhecido',
        alcance: item.alcance || 1,
        st: item.st || 8
    }));
}

function abrirModalAtaque() {
    if (inimigoSelecionado === null) {
        adicionarLog('❌ Selecione um inimigo primeiro!', 'erro');
        return;
    }
    
    const armas = getArmasEquipadas();
    
    if (armas.length === 0) {
        adicionarLog('❌ Você não tem armas equipadas!', 'erro');
        return;
    }
    
    armaSelecionada = null;
    btnConfirmarAtaque.disabled = true;
    
    armasLista.innerHTML = armas.map((arma, index) => `
        <div class="arma-card" data-index="${index}">
            <div class="arma-nome">${arma.nome}</div>
            <div class="arma-detalhes">
                <span><i class="fas fa-tint"></i> ${arma.dano}</span>
                <span><i class="fas fa-ruler"></i> ${arma.alcance}m</span>
            </div>
        </div>
    `).join('');
    
    document.querySelectorAll('.arma-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.arma-card').forEach(c => c.classList.remove('selecionada'));
            card.classList.add('selecionada');
            armaSelecionada = parseInt(card.dataset.index);
            btnConfirmarAtaque.disabled = false;
        });
    });
    
    modalAtaque.classList.add('active');
}

function executarAtaque() {
    if (armaSelecionada === null) return;
    
    const armas = getArmasEquipadas();
    const arma = armas[armaSelecionada];
    const inimigo = inimigos[inimigoSelecionado];
    
    if (!arma || !inimigo) return;
    
    modalAtaque.classList.remove('active');
    
    const rolagem = rolar2d10();
    let nhAtaque = getValorAtributo('dx') + 3;
    if (vantagens.includes('mestreArmas')) nhAtaque += 1;
    
    adicionarLog(`🎯 Ataque: ${rolagem.texto} (NH ${nhAtaque})`, 'info');
    
    if (rolagem.total <= nhAtaque) {
        let dano = 0;
        if (arma.dano === "1d-2") dano = Math.max(0, Math.floor(Math.random() * 6) - 1);
        else if (arma.dano === "1d6" || arma.dano === "1d") dano = Math.floor(Math.random() * 6) + 1;
        else if (arma.dano === "1d+1") dano = Math.floor(Math.random() * 6) + 2;
        else if (arma.dano === "1d+2") dano = Math.floor(Math.random() * 6) + 3;
        else if (arma.dano === "2d-1") dano = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) - 1;
        else if (arma.dano === "2d") dano = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6);
        else if (arma.dano === "2d+1") dano = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 1;
        else if (arma.dano === "2d+2") dano = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
        else dano = Math.floor(Math.random() * 6) + 1;
        
        inimigo.pv -= dano;
        adicionarLog(`✅ Acertou! Causou ${dano} de dano.`, 'dano');
        
        if (inimigo.pv <= 0) {
            adicionarLog(`💀 ${inimigo.nome} foi derrotado!`, 'sucesso');
            
            const xpGanho = inimigo.xp || 25;
            xpAtual += xpGanho;
            personagem.xp = xpAtual;
            adicionarLog(`✨ Ganhou ${xpGanho} XP!`, 'sucesso');
            verificarGanhoBolinha();
            
            inimigos = inimigos.filter((_, i) => i !== inimigoSelecionado);
            inimigoSelecionado = null;
        }
        
        renderizarInimigos();
        atualizarFichaPersonagem();
        
        if (inimigos.length === 0) {
            adicionarLog('🎉 VITÓRIA!', 'sucesso');
            inimigosContainer.style.display = 'none';
            
            if (capituloAtual.ao_vencer) {
                carregarCena(capituloAtual.ao_vencer);
            }
        } else {
            passarTurno();
        }
    } else {
        adicionarLog(`❌ Errou!`, 'erro');
        passarTurno();
    }
    
    salvarProgresso();
}

function passarTurno() {
    if (turnoAtual === 'jogador') {
        turnoAtual = 'inimigo';
        turnoIndicator.className = 'turno-indicator inimigo';
        turnoIndicator.innerHTML = '<i class="fas fa-skull"></i> INIMIGOS';
        
        btnAtacar.disabled = true;
        btnMagia.disabled = true;
        
        setTimeout(turnoInimigos, 1000);
    }
}

function turnoInimigos() {
    if (inimigos.length === 0) {
        turnoAtual = 'jogador';
        turnoIndicator.className = 'turno-indicator jogador';
        turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
        btnAtacar.disabled = false;
        btnMagia.disabled = false;
        return;
    }
    
    inimigos.forEach(inimigo => {
        const rolagem = rolar2d10();
        
        if (rolagem.total <= (inimigo.nh_ataque || 10)) {
            let dano = 0;
            if (inimigo.dano === "1d-2") dano = Math.max(0, Math.floor(Math.random() * 6) - 1);
            else if (inimigo.dano === "1d6" || inimigo.dano === "1d") dano = Math.floor(Math.random() * 6) + 1;
            else if (inimigo.dano === "2d-3") dano = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) - 2;
            else if (inimigo.dano === "1d+2") dano = Math.floor(Math.random() * 6) + 3;
            else if (inimigo.dano === "2d+2") dano = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 3;
            else dano = Math.floor(Math.random() * 6) + 1;
            
            pvAtual -= dano;
            personagem.statusCombate.vidaAtual = pvAtual;
            
            adicionarLog(`👾 ${inimigo.nome} causou ${dano} de dano!`, 'dano');
            
            if (pvAtual <= 0) {
                pvAtual = 0;
                adicionarLog('💀 VOCÊ MORREU!', 'erro');
                return;
            }
            
            atualizarFichaPersonagem();
        }
    });
    
    turnoAtual = 'jogador';
    turnoIndicator.className = 'turno-indicator jogador';
    turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
    
    btnAtacar.disabled = false;
    btnMagia.disabled = false;
    
    salvarProgresso();
}

function descansar() {
    pvAtual = Math.min(pvAtual + 5, pvMax);
    manaAtual = Math.min(manaAtual + 3, manaMax);
    fadigaAtual = Math.min(fadigaAtual + 2, fadigaMax);
    
    personagem.statusCombate = {
        vidaAtual: pvAtual,
        vidaMax: pvMax,
        fadigaAtual: fadigaAtual,
        fadigaMax: fadigaMax,
        manaAtual: manaAtual,
        manaMax: manaMax
    };
    
    atualizarFichaPersonagem();
    salvarProgresso();
    adicionarLog('💤 Você descansou e recuperou energia.', 'sucesso');
}

async function salvarProgresso() {
    if (!personagem || !sessaoId) return;
    
    try {
        personagem.statusCombate = {
            vidaAtual: pvAtual,
            vidaMax: pvMax,
            fadigaAtual: fadigaAtual,
            fadigaMax: fadigaMax,
            manaAtual: manaAtual,
            manaMax: manaMax
        };
        personagem.xp = xpAtual;
        
        const personagemRef = doc(db, "personagens", personagem.id);
        await updateDoc(personagemRef, {
            statusCombate: personagem.statusCombate,
            xp: xpAtual,
            atributos: personagem.atributos,
            pmGasto: personagem.pmGasto
        });
        
    } catch (error) {
        adicionarLog('❌ Erro ao salvar progresso', 'erro');
    }
}

async function carregarPersonagem(personagemId) {
    try {
        const personagemRef = doc(db, "personagens", personagemId);
        const personagemSnap = await getDoc(personagemRef);
        
        if (!personagemSnap.exists()) {
            throw new Error('Personagem não encontrado');
        }
        
        personagem = {
            id: personagemSnap.id,
            ...personagemSnap.data()
        };
        
        if (!personagem.inventario) {
            personagem.inventario = { corpo: [], mochila: [], deposito: [] };
        }
        
        if (personagem.atributos) {
            atributos = personagem.atributos;
        }
        
        if (personagem.vantagens) {
            vantagens = personagem.vantagens;
        }
        
        if (personagem.desvantagens) {
            desvantagens = personagem.desvantagens;
        }
        
        if (personagem.fobia) {
            fobia = personagem.fobia;
        }
        
        if (personagem.pericias) {
            pericias = personagem.pericias;
        }
        
        if (personagem.escolas) {
            escolas = personagem.escolas;
        }
        
        if (personagem.esferasDesbloqueadas !== undefined) {
            esferasDesbloqueadas = personagem.esferasDesbloqueadas;
        }
        
        inventario = personagem.inventario;
        dinheiro = personagem.dinheiro || 0;
        
        pvMax = calcularPVMax();
        pvAtual = personagem.statusCombate?.vidaAtual || pvMax;
        
        fadigaMax = calcularFadigaMax();
        fadigaAtual = personagem.statusCombate?.fadigaAtual || fadigaMax;
        
        manaMax = calcularManaMax();
        manaAtual = personagem.statusCombate?.manaAtual || manaMax;
        
        xpAtual = personagem.xp || 0;
        
        const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
        const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
        const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
        const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
        const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
        const xpNecessario = (totalBolinhas + 1) * XP_POR_BOLINHA;
        
        while (xpAtual >= xpNecessario) {
            bolinhasDisponiveisCount++;
            xpAtual -= xpNecessario;
        }
        
        atualizarFichaPersonagem();
        
    } catch (error) {
        adicionarLog('❌ Erro ao carregar personagem!', 'erro');
    }
}

async function carregarAventura(aventuraId) {
    try {
        if (window.AVENTURA) {
            historia = window.AVENTURA;
        } else {
            let tentativas = 0;
            while (!window.AVENTURA && tentativas < 30) {
                await new Promise(r => setTimeout(r, 100));
                tentativas++;
            }
            if (window.AVENTURA) {
                historia = window.AVENTURA;
            } else {
                throw new Error(`Aventura "${aventuraId}" não encontrada.`);
            }
        }
        
        const cenaInicialId = historia.cenaInicial;
        if (!cenaInicialId) throw new Error('Cena inicial não definida');
        
        carregarCena(cenaInicialId);
        adicionarLog(`📖 ${historia.nome} iniciada!`, 'sucesso');
        
    } catch (error) {
        dialogoTexto.textContent = `ERRO: ${error.message}`;
        opcoesDialogo.innerHTML = '';
        const btnVoltar = document.createElement('button');
        btnVoltar.className = 'opcao-btn';
        btnVoltar.textContent = 'Voltar à seleção';
        btnVoltar.addEventListener('click', () => {
            window.location.href = 'aventura-solo.html';
        });
        opcoesDialogo.appendChild(btnVoltar);
    }
}

async function criarSessao() {
    const urlParams = new URLSearchParams(window.location.search);
    const aventuraId = urlParams.get('aventura');
    const personagemId = urlParams.get('personagem');
    
    if (!aventuraId || !personagemId) {
        alert('Aventura ou personagem não selecionado!');
        window.location.href = 'aventura-solo.html';
        return;
    }
    
    showLoading();
    
    try {
        await carregarPersonagem(personagemId);
        await carregarAventura(aventuraId);
        
        const sessaoRef = doc(collection(db, "sessoes_aventura"));
        sessaoId = sessaoRef.id;
        
        await setDoc(sessaoRef, {
            id: sessaoId,
            userId: currentUser.uid,
            personagem_id: personagemId,
            aventura_id: aventuraId,
            pc_atual: personagem,
            cena_atual: historia?.cenaInicial || '',
            data_inicio: new Date().toISOString(),
            ultima_sessao: new Date().toISOString(),
            status: "em_andamento"
        });
        
    } catch (error) {
        adicionarLog('❌ Erro ao iniciar sessão', 'erro');
    } finally {
        hideLoading();
    }
}

onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        await criarSessao();
    } else {
        window.location.href = 'index.html';
    }
});

btnAtacar.addEventListener('click', abrirModalAtaque);
btnMagia.addEventListener('click', () => adicionarLog('🔮 Sistema de magias em desenvolvimento', 'info'));
btnInventario.addEventListener('click', abrirModalInventario);
btnDescansar.addEventListener('click', descansar);
btnVerPericias.addEventListener('click', abrirModalPericias);
btnVerVantagens.addEventListener('click', abrirModalVantagens);
btnVerDesvantagens.addEventListener('click', abrirModalDesvantagens);
btnVerMagias.addEventListener('click', abrirModalMagias);

cancelarEscolhaAtributo.addEventListener('click', () => {
    modalEscolhaAtributo.classList.remove('active');
});

fecharModalInventario.addEventListener('click', () => {
    modalInventario.classList.remove('active');
});

fecharModalPericias.addEventListener('click', () => {
    modalPericias.classList.remove('active');
});

fecharModalVantagens.addEventListener('click', () => {
    modalVantagens.classList.remove('active');
});

fecharModalDesvantagens.addEventListener('click', () => {
    modalDesvantagens.classList.remove('active');
});

fecharModalMagias.addEventListener('click', () => {
    modalMagias.classList.remove('active');
});

btnCancelarAtaque.addEventListener('click', () => {
    modalAtaque.classList.remove('active');
});

btnConfirmarAtaque.addEventListener('click', executarAtaque);

btnAbrirDados.addEventListener('click', () => {
    modalDados.classList.add('active');
});

btnFecharDados.addEventListener('click', () => {
    modalDados.classList.remove('active');
});

btnRolarDados.addEventListener('click', () => {
    const qtd = parseInt(dadosQtd.value) || 1;
    const faces = parseInt(dadosFaces.value) || 10;
    const mod = parseInt(dadosMod.value) || 0;
    const resultado = rolarDados(qtd, faces, mod);
    dadosResultado.textContent = resultado.texto;
    adicionarLog(`🎲 Rolagem: ${resultado.texto}`, 'info');
});

document.querySelectorAll('.atributo-opcao').forEach(opcao => {
    opcao.addEventListener('click', () => {
        const atributo = opcao.dataset.atributo;
        adicionarBolinha(atributo);
    });
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        modalEscolhaAtributo.classList.remove('active');
        modalInventario.classList.remove('active');
        modalPericias.classList.remove('active');
        modalVantagens.classList.remove('active');
        modalDesvantagens.classList.remove('active');
        modalMagias.classList.remove('active');
        modalAtaque.classList.remove('active');
        modalDados.classList.remove('active');
    }
});

setInterval(() => {
    if (personagem && sessaoId) salvarProgresso();
}, 30000);

window.AVENTURA = {
    nome: "A Menina Elfa Raptada",
    descricao: "Uma aventura clássica começando em uma taverna.",
    cenaInicial: "exterior_taverna",
    
    cenas: {
        exterior_taverna: {
            id: "exterior_taverna",
            nome: "Entrada da Taverna",
            imagem: "taverna-exterior.jpg",
            fala: {
                npc: "Narrador",
                texto: "Você chega a uma taverna aconchegante. O letreiro range com o vento: 'A Javali Sangrento'. Risadas e música saem pelas frestas da porta."
            },
            npcs: [],
            opcoes: [
                {
                    texto: "Entrar na taverna",
                    proximo: "interior_taverna"
                }
            ]
        },
        
        interior_taverna: {
            id: "interior_taverna",
            nome: "Taverna A Javali Sangrento",
            imagem: "taverna-interior.jpg",
            fala: {
                npc: "Narrador",
                texto: "O calor da lareira e o cheiro de carne assada te recebem. A taverna está movimentada. Você encontra um lugar no balcão e o taverneiro se aproxima."
            },
            npcs: [
                {
                    id: "taverneiro",
                    nome: "Taverneiro",
                    sprite: "taverneiro.png",
                    dialogo: "Bem-vindo, viajante! Quer uma cerveja gelada? Só 2 moedas.",
                    opcoes: [
                        {
                            texto: "🍺 Comprar cerveja (2 moedas)",
                            tipo: "pagar",
                            valor: 2,
                            sucesso: "Saúde! Uma boa cerveja sempre anima.",
                            falha: "Você não tem dinheiro? Que pena..."
                        },
                        {
                            texto: "📰 Perguntar sobre novidades",
                            resposta: "Ora, tem havido problemas na estrada norte. Dizem que goblins estão atacando viajantes. Uns mercadores ontem mesmo falaram que ouviram gritos vindo da floresta..."
                        },
                        {
                            texto: "💼 Procurar trabalho",
                            resposta: "Sempre tem trabalho pra quem tem coragem. Fique por aqui, tome uma cerveja, e quem sabe aparece algo."
                        },
                        {
                            texto: "🗺️ Conversar sobre a região",
                            resposta: "A região é pacata, mas ultimamente... tem coisas estranhas acontecendo na floresta."
                        },
                        {
                            texto: "👀 Observar o ambiente enquanto bebe",
                            resposta: "Você pede uma cerveja e observa calmamente o movimento da taverna...",
                            acao: "iniciar_timer"
                        },
                        {
                            texto: "🚪 Sair da taverna",
                            proximo: "exterior_taverna"
                        }
                    ]
                }
            ],
            opcoes: []
        },
        
        interior_taverna_com_homem: {
            id: "interior_taverna_com_homem",
            nome: "Taverna - O Ferido Chega",
            imagem: "taverna-interior.jpg",
            fala: {
                npc: "Narrador",
                texto: "Enquanto você bebe sua cerveja e observa o ambiente, a porta se abre violentamente! Um homem ensanguentado entra cambaleando e cai perto da entrada."
            },
            npcs: [
                {
                    id: "taverneiro",
                    nome: "Taverneiro",
                    sprite: "taverneiro.png",
                    dialogo: "Pelos deuses! O que aconteceu com ele? Alguém ajude!",
                    opcoes: [
                        {
                            texto: "Falar com o taverneiro",
                            resposta: "Vá falar com ele, rápido! Ele precisa de ajuda!"
                        },
                        {
                            texto: "Sair da taverna",
                            proximo: "exterior_taverna"
                        }
                    ]
                },
                {
                    id: "homem_sangue",
                    nome: "Homem Ferido",
                    sprite: "npc-sangue.png",
                    dialogo: "Socorro... minha filha... os goblins... levaram minha filha! Por favor, alguém...",
                    opcoes: [
                        {
                            texto: "Falar com o homem ferido",
                            resposta: "Ele está fraco... você se aproxima para ouvir sua história.",
                            proximo_apos_resposta: "homem_fala_detalhes"
                        },
                        {
                            texto: "Pedir para o taverneiro ajudar",
                            resposta: "O taverneiro corre para ajudar, mas o homem precisa de um aventureiro."
                        }
                    ]
                }
            ],
            opcoes: [
                {
                    texto: "Sair da taverna",
                    proximo: "exterior_taverna"
                }
            ]
        },
        
        homem_fala_detalhes: {
            id: "homem_fala_detalhes",
            nome: "O Desespero de um Pai",
            imagem: "taverna-interior.jpg",
            fala: {
                npc: "Homem Ferido",
                texto: "Eu vinha pela estrada norte com minha filha Lyra... Ela tem 10 anos, cabelos prateados... Fomos atacados por goblins! Eles levaram ela para a floresta! Por favor, alguém tem que salvá-la!"
            },
            npcs: [
                {
                    id: "taverneiro",
                    nome: "Taverneiro",
                    sprite: "taverneiro.png",
                    dialogo: "Coitado. Eu avisei que a estrada estava perigosa. Alguém precisa ajudar esse homem.",
                    opcoes: [
                        {
                            texto: "Perguntar ao taverneiro sobre os goblins",
                            resposta: "Eles têm um acampamento na floresta, perto de uma caverna. Vários viajantes desapareceram por lá."
                        },
                        {
                            texto: "Sair da taverna",
                            proximo: "exterior_taverna"
                        }
                    ]
                },
                {
                    id: "homem_sangue",
                    nome: "Eldrin (Pai de Lyra)",
                    sprite: "npc-sangue.png",
                    dialogo: "Minha esposa morreu no inverno... Lyra é tudo que tenho! Por favor, aventureiro, você tem cara de ser corajoso...",
                    opcoes: [
                        {
                            texto: "✅ ACEITAR MISSÃO - Salvar Lyra",
                            resposta: "Deus te abençoe! Siga a estrada norte até a floresta!",
                            proximo_apos_resposta: "sair_para_aventura"
                        },
                        {
                            texto: "Perguntar sobre os goblins",
                            resposta: "Eram uns 10... verdes, fedidos... Levaram ela para o norte, para a floresta escura."
                        },
                        {
                            texto: "Sair da taverna",
                            proximo: "exterior_taverna"
                        }
                    ]
                }
            ],
            opcoes: [
                {
                    texto: "Sair da taverna",
                    proximo: "exterior_taverna"
                }
            ]
        },
        
        sair_para_aventura: {
            id: "sair_para_aventura",
            nome: "Missão Aceita",
            imagem: "taverna-exterior.jpg",
            fala: {
                npc: "Narrador",
                texto: "Você sai da taverna com determinação. A estrada norte se estende diante de você. O vento traz o cheiro da floresta distante."
            },
            npcs: [],
            opcoes: [
                {
                    texto: "Seguir para a estrada norte",
                    proximo: "encontro_camponesa"
                }
            ]
        },
        
        encontro_camponesa: {
            id: "encontro_camponesa",
            nome: "Estrada Norte",
            imagem: "estrada-norte.jpg",
            fala: {
                npc: "Narrador",
                texto: "Enquanto segue pela estrada, você avista uma jovem camponesa colhendo flores na beira do caminho."
            },
            npcs: [
                {
                    id: "camponesa",
                    nome: "Camponesa",
                    sprite: "camponesa.png",
                    dialogo: "Oh! Um viajante! Cuidado com a estrada, ouvi gritos de goblins mais adiante. Hoje cedo vi uma menina sendo levada para a floresta... uma elfinha de cabelos prateados.",
                    opcoes: [
                        {
                            texto: "Perguntar sobre a menina",
                            resposta: "Ela chorava muito, chamava pelo pai. Levaram ela para uma caverna, mais adiante."
                        },
                        {
                            texto: "Seguir viagem",
                            proximo: "carroca_destruida"
                        }
                    ]
                }
            ],
            opcoes: [
                {
                    texto: "Continuar para o norte",
                    proximo: "carroca_destruida"
                }
            ]
        },
        
        carroca_destruida: {
            id: "carroca_destruida",
            nome: "Local do Ataque",
            imagem: "carroca.jpg",
            fala: {
                npc: "Narrador",
                texto: "Você encontra uma carroça destruída na estrada. Manchas de sangue se espalham pela madeira. Uma boneca de pano está caída na lama."
            },
            npcs: [],
            opcoes: [
                {
                    texto: "Pegar a boneca (será importante)",
                    item: {
                        id: "boneca_lyra",
                        nome: "Boneca de Lyra",
                        descricao: "Uma boneca suja, provavelmente da menina.",
                        peso: 0.2,
                        preco: 5
                    },
                    resposta: "Você guarda a boneca. Pode ser importante."
                },
                {
                    texto: "Seguir os rastros dos goblins",
                    proximo: "clareira_goblins"
                }
            ]
        },
        
        clareira_goblins: {
            id: "clareira_goblins",
            nome: "Clareira na Floresta",
            imagem: "clareira-globlins.jpg",
            fala: {
                npc: "Narrador",
                texto: "Você encontra uma clareira onde vários goblins estão acampados perto de uma fogueira."
            },
            inimigos: [
                {
                    id: "goblin1",
                    nome: "Goblin",
                    sprite: "goblin.jpg",
                    pv: 58,
                    pv_max: 58,
                    esquiva: 7,
                    nh_ataque: 8,
                    dano: "1d-2",
                    xp: 25
                },
                {
                    id: "goblin2",
                    nome: "Goblin",
                    sprite: "goblin.jpg",
                    pv: 58,
                    pv_max: 58,
                    esquiva: 7,
                    nh_ataque: 8,
                    dano: "1d-2",
                    xp: 25
                }
            ],
            opcoes: [
                {
                    texto: "Atacar os goblins",
                    acao: "iniciar_combate",
                    inimigos: ["goblin1", "goblin2"],
                    ao_vencer: "entrada_caverna"
                }
            ]
        },
        
        entrada_caverna: {
            id: "entrada_caverna",
            nome: "Entrada da Caverna",
            imagem: "entrada-caverna.jpg",
            fala: {
                npc: "Narrador",
                texto: "Uma abertura escura na rocha. Você ouve vozes ecoando."
            },
            opcoes: [
                {
                    texto: "Entrar na caverna",
                    proximo: "camara_chefe"
                }
            ]
        },
        
        camara_chefe: {
            id: "camara_chefe",
            nome: "Câmara do Chefe",
            imagem: "menina-elfa.jpg",
            fala: {
                npc: "Narrador",
                texto: "Numa jaula, uma menina elfa de cabelos prateados está sentada, assustada. Um goblin grande monta guarda."
            },
            npcs: [
                {
                    id: "menina_elfa",
                    nome: "Lyra",
                    sprite: "menina-elfa.jpg",
                    dialogo: "Por favor, me ajude!"
                },
                {
                    id: "chefe_goblin",
                    nome: "Chefe Goblin",
                    sprite: "chefe-goblin.jpg"
                }
            ],
            inimigos: [
                {
                    id: "chefe_goblin",
                    nome: "Chefe Goblin",
                    sprite: "chefe-goblin.jpg",
                    pv: 85,
                    pv_max: 85,
                    esquiva: 8,
                    nh_ataque: 10,
                    dano: "2d+2",
                    xp: 100
                }
            ],
            opcoes: [
                {
                    texto: "Atacar o chefe!",
                    acao: "iniciar_combate",
                    inimigos: ["chefe_goblin"],
                    ao_vencer: "final_vitoria"
                }
            ]
        },
        
        final_vitoria: {
            id: "final_vitoria",
            nome: "Missão Cumprida",
            imagem: "menina-elfa.jpg",
            fala: {
                npc: "Lyra",
                texto: "Você me salvou! Muito obrigada!"
            },
            opcoes: [
                {
                    texto: "Voltar à taverna",
                    proximo: "final_taverna"
                }
            ]
        },
        
        final_taverna: {
            id: "final_taverna",
            nome: "Retorno Triunfal",
            imagem: "taverna-interior.jpg",
            fala: {
                npc: "Eldrin",
                texto: "MINHA FILHA! Você conseguiu! Muito obrigado, aventureiro!"
            },
            npcs: [
                {
                    id: "homem",
                    nome: "Eldrin",
                    sprite: "npc-sangue.png"
                },
                {
                    id: "lyra",
                    nome: "Lyra",
                    sprite: "menina-elfa.jpg"
                },
                {
                    id: "taverneiro",
                    nome: "Taverneiro",
                    sprite: "taverneiro.png"
                }
            ],
            opcoes: [
                {
                    texto: "Encerrar aventura",
                    acao: "finalizar_aventura"
                }
            ]
        }
    }
};
</script>
</body>
</html>