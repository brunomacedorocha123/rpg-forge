<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Aventura - Modo Clássico - RPGForce</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
   <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #2a1a3a 100%);
        min-height: 100vh;
        color: #fff;
    }

    .magic-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
    }

    .magic-bg::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
        animation: pulse 8s ease-in-out infinite;
    }

    .magic-bg::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 80% 80%, rgba(198, 40, 40, 0.1) 0%, transparent 50%);
        animation: pulse 10s ease-in-out infinite reverse;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
    }

    .game-container {
        position: relative;
        z-index: 1;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* HEADER COM STATUS DO PERSONAGEM */
    .game-header {
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 2px solid #ffd700;
        padding: 8px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        z-index: 20;
    }

    .personagem-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .personagem-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #ffd700;
        overflow: hidden;
        background: #1a1a3a;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .personagem-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .personagem-nome {
        font-family: 'MedievalSharp', cursive;
        font-size: 1.2rem;
        color: #ffd700;
    }

    .status-bars {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .status-item {
        min-width: 140px;
    }

    .status-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
        margin-bottom: 3px;
    }

    .status-label i {
        color: #ffd700;
        margin-right: 5px;
    }

    .status-bar {
        height: 10px;
        background: rgba(0,0,0,0.5);
        border-radius: 5px;
        overflow: hidden;
        border: 1px solid rgba(255,215,0,0.3);
    }

    .status-fill {
        height: 100%;
        transition: width 0.3s;
    }

    .status-fill.vida { background: linear-gradient(90deg, #ff4d4d, #ff1a1a); }
    .status-fill.mana { background: linear-gradient(90deg, #4d4dff, #1a1aff); }
    .status-fill.fadiga { background: linear-gradient(90deg, #ffaa00, #ff8800); }
    .status-fill.xp { background: linear-gradient(90deg, #4CAF50, #8BC34A); }

    .pm-display {
        background: linear-gradient(45deg, #9c27b0, #673ab7);
        padding: 5px 15px;
        border-radius: 30px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #ffd700;
    }

    .pm-display i { color: #ffd700; }

    /* ÁREA PRINCIPAL - TRÊS COLUNAS */
    .main-area {
        flex: 1;
        display: flex;
        overflow: hidden;
        min-height: 0;
    }

    /* COLUNA ESQUERDA - FICHA DO PERSONAGEM */
    .ficha-coluna {
        width: 300px;
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(10px);
        border-right: 2px solid rgba(255,215,0,0.3);
        padding: 15px;
        overflow-y: auto;
        z-index: 15;
    }

    .ficha-header {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255,215,0,0.2);
    }

    .ficha-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 3px solid #ffd700;
        margin: 0 auto 10px;
        overflow: hidden;
        background: #1a1a3a;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ficha-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .ficha-nome {
        font-size: 1.2rem;
        font-weight: bold;
        color: #ffd700;
        font-family: 'MedievalSharp', cursive;
    }

    .ficha-classe {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.6);
    }

    .nivel-indicator {
        background: linear-gradient(45deg, #4a2a6a, #2a1a4a);
        border: 2px solid #ffd700;
        border-radius: 30px;
        padding: 10px 15px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }

    .nivel-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #ffd700;
        font-weight: bold;
    }

    .nivel-info i {
        font-size: 1.2rem;
    }

    .nivel-valor {
        background: #ffd700;
        color: #0a0a1a;
        padding: 5px 15px;
        border-radius: 30px;
        font-size: 1.5rem;
        font-weight: bold;
        font-family: 'MedievalSharp', cursive;
        min-width: 50px;
        text-align: center;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .ato-indicator {
        background: rgba(255,215,0,0.2);
        border-left: 4px solid #ffd700;
        padding: 5px 15px;
        font-family: 'MedievalSharp', cursive;
        font-size: 1rem;
        color: #ffd700;
        text-shadow: 0 0 10px rgba(255,215,0,0.5);
        margin: 10px 0;
    }
    
    .ato-indicator i {
        margin-right: 8px;
        color: #ffaa00;
    }

    .bolinhas-saldo {
        background: linear-gradient(45deg, #4CAF50, #2E7D32);
        border-radius: 30px;
        padding: 12px 15px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: bold;
        border: 2px solid #ffd700;
        box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
    }

    .bolinhas-saldo i {
        color: #ffd700;
        margin-right: 8px;
    }

    .bolinhas-saldo .valor {
        background: #ffd700;
        color: #0a0a1a;
        padding: 5px 15px;
        border-radius: 30px;
        font-size: 1.3rem;
        font-weight: bold;
        min-width: 50px;
        text-align: center;
    }

    .atributos-container {
        margin: 15px 0;
    }

    .atributo-card {
        background: rgba(0,0,0,0.3);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid rgba(255,215,0,0.2);
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .atributo-card:hover {
        background: rgba(255,215,0,0.1);
        transform: translateX(5px);
    }

    .atributo-card.bolinha-disponivel {
        border-color: #4CAF50;
        animation: pulseVerde 1.5s infinite;
        background: rgba(76,175,80,0.1);
    }

    @keyframes pulseVerde {
        0% { box-shadow: 0 0 0 0 rgba(76,175,80,0.7); }
        70% { box-shadow: 0 0 0 10px rgba(76,175,80,0); }
        100% { box-shadow: 0 0 0 0 rgba(76,175,80,0); }
    }

    .atributo-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .atributo-nome {
        font-weight: bold;
        color: #ffd700;
        width: 40px;
    }

    .atributo-bolinhas {
        display: flex;
        gap: 2px;
    }

    .bolinha-pequena {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(255,215,0,0.2);
        border: 1px solid rgba(255,215,0,0.3);
    }

    .bolinha-pequena.preenchida {
        background: #ffd700;
    }

    .atributo-valor {
        font-weight: bold;
        font-size: 1.2rem;
        color: #ffd700;
    }

    .atributo-base {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
    }

    .defesas-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
        margin: 15px 0;
    }

    .defesa-card {
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        padding: 8px;
        text-align: center;
        border: 1px solid rgba(255,215,0,0.2);
    }

    .defesa-valor {
        font-size: 1.2rem;
        font-weight: bold;
        color: #ffd700;
    }

    .defesa-label {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.6);
    }

    .ficha-botoes {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin: 15px 0;
    }

    .ficha-botao {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.3);
        border-radius: 10px;
        padding: 12px 5px;
        color: #ffd700;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }

    .ficha-botao i {
        font-size: 1.2rem;
    }

    .ficha-botao:hover {
        background: rgba(255,215,0,0.2);
        border-color: #ffd700;
        transform: translateY(-3px);
    }

    .ficha-botao .contador {
        background: #ffd700;
        color: #0a0a1a;
        border-radius: 30px;
        padding: 2px 8px;
        font-size: 0.7rem;
        margin-top: 2px;
    }

    .cenario-coluna {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background: rgba(0,0,0,0.5);
    }

    .cenario-area {
        flex: 1;
        position: relative;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-color: #1a1a3a;
        min-height: 0;
    }

    .cenario-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, rgba(0,0,0,0.3) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.3) 100%);
        pointer-events: none;
    }

    .npcs-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
    }

    .npc-sprite {
        position: absolute;
        transform: translate(-50%, -50%);
        cursor: pointer;
        pointer-events: auto;
        transition: all 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.2);
        filter: drop-shadow(0 10px 8px rgba(0, 0, 0, 0.5));
        z-index: 10;
    }

    .npc-sprite:hover {
        transform: translate(-50%, -60%) scale(1.08);
        filter: drop-shadow(0 15px 15px rgba(255, 215, 0, 0.3));
        z-index: 100;
    }

    .npc-sprite img {
        width: 150px;
        height: 200px;
        object-fit: cover;
        object-position: center;
        border: none;
        background: transparent;
        background-color: transparent;
        box-shadow: none;
        outline: none;
        display: block;
        transition: all 0.3s ease;
    }

    .npc-sprite .npc-nome {
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%);
        background: #000000;
        color: #ffd700;
        padding: 6px 20px;
        border-radius: 40px;
        font-size: 0.95rem;
        font-weight: bold;
        white-space: nowrap;
        border: 2px solid #ffd700;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.8);
        letter-spacing: 1.5px;
        font-family: 'MedievalSharp', cursive;
        z-index: 30;
        pointer-events: none;
        text-shadow: 0 2px 4px #000000;
        opacity: 1;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
    }

    .dialogo-area {
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(10px);
        border-top: 2px solid rgba(255,215,0,0.3);
        padding: 15px 20px;
        min-height: 120px;
        max-height: 200px;
        overflow-y: auto;
    }

    .npc-falando {
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .npc-falando img {
        display: none;
    }

    .dialogo-texto {
        color: rgba(255,255,255,0.9);
        line-height: 1.5;
        margin-bottom: 10px;
        font-style: italic;
        padding-left: 10px;
        border-left: 3px solid #ffd700;
    }

    .opcoes-dialogo {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .opcao-btn {
        background: rgba(255,215,0,0.1);
        border: 1px solid #ffd700;
        color: #fff;
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
    }

    .opcao-btn:hover {
        background: #ffd700;
        color: #0a0a1a;
    }

    .acoes-coluna {
        width: 280px;
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(10px);
        border-left: 2px solid rgba(255,215,0,0.3);
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .turno-indicator {
        background: rgba(76,175,80,0.2);
        border: 1px solid #4CAF50;
        color: #4CAF50;
        padding: 10px;
        border-radius: 10px;
        text-align: center;
        font-weight: bold;
    }

    .turno-indicator.inimigo {
        background: rgba(255,87,34,0.2);
        border-color: #ff5722;
        color: #ff5722;
    }

    .acoes-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }

    .acao-btn {
        background: rgba(255,215,0,0.1);
        border: 1px solid #ffd700;
        color: #ffd700;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        font-size: 0.9rem;
    }

    .acao-btn:hover:not(:disabled) {
        background: #ffd700;
        color: #0a0a1a;
    }

    .acao-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .acao-btn.atacar {
        border-color: #ff6b6b;
        color: #ff6b6b;
    }

    .acao-btn.magia {
        border-color: #4d4dff;
        color: #4d4dff;
    }

    .acao-btn.defender {
        border-color: #4CAF50;
        color: #4CAF50;
    }

    .inimigos-lista {
        background: rgba(255,0,0,0.1);
        border: 1px solid #ff6b6b;
        border-radius: 10px;
        padding: 10px;
        max-height: 200px;
        overflow-y: auto;
    }

    .inimigo-mini {
        background: rgba(0,0,0,0.3);
        border: 1px solid #ff6b6b;
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .inimigo-mini:hover {
        background: rgba(255,107,107,0.2);
    }

    .inimigo-mini.selecionado {
        border: 2px solid #ffd700;
    }

    .inimigo-mini-nome {
        color: #ff6b6b;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .inimigo-mini-pv {
        height: 4px;
        background: rgba(0,0,0,0.3);
        border-radius: 2px;
        margin: 5px 0;
    }

    .inimigo-mini-pv-fill {
        height: 100%;
        background: #ff6b6b;
        width: 100%;
    }

    .log-container {
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        padding: 8px;
        max-height: 120px;
        overflow-y: auto;
        font-size: 0.8rem;
    }

    .log-item {
        padding: 3px 0;
        border-bottom: 1px solid rgba(255,215,0,0.1);
    }

    .log-item.sucesso { color: #4CAF50; }
    .log-item.erro { color: #ff6b6b; }
    .log-item.dano { color: #ff5722; }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: #1a1a3a;
        border: 2px solid #ffd700;
        border-radius: 20px;
        padding: 25px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-content h3 {
        color: #ffd700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .atributo-opcao {
        background: rgba(0,0,0,0.3);
        border: 2px solid #ffd700;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .atributo-opcao:hover {
        background: rgba(255,215,0,0.2);
        transform: translateX(10px);
    }

    .atributo-opcao .icone {
        width: 50px;
        height: 50px;
        background: rgba(255,215,0,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #ffd700;
    }

    .atributo-opcao .info {
        flex: 1;
    }

    .atributo-opcao .nome {
        font-size: 1.2rem;
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .atributo-opcao .descricao {
        color: rgba(255,255,255,0.7);
        font-size: 0.9rem;
    }

    .atributo-opcao .valor-atual {
        font-size: 1.1rem;
        color: #4CAF50;
        font-weight: bold;
    }

    .inventario-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 15px 0;
    }

    .inventario-coluna {
        background: rgba(0,0,0,0.3);
        border-radius: 12px;
        padding: 12px;
        max-height: 300px;
        overflow-y: auto;
    }

    .inventario-coluna h4 {
        color: #ffd700;
        margin-bottom: 10px;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 5px;
        position: sticky;
        top: 0;
        background: #1a1a3a;
        padding: 5px 0;
    }

    .item-card {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.3);
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }

    .item-card .nome {
        color: #ffd700;
        font-weight: bold;
    }

    .item-card .detalhes {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.6);
        margin-top: 3px;
    }

    .item-acoes {
        display: flex;
        gap: 5px;
        margin-top: 5px;
    }

    .item-acao {
        background: rgba(255,215,0,0.1);
        border: 1px solid #ffd700;
        color: #ffd700;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        cursor: pointer;
    }

    .item-acao:hover {
        background: #ffd700;
        color: #0a0a1a;
    }

    .vantagens-lista, .desvantagens-lista, .pericias-lista, .magias-lista {
        max-height: 400px;
        overflow-y: auto;
    }

    .vantagem-item, .desvantagem-item {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.2);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
    }

    .vantagem-item h4, .desvantagem-item h4 {
        color: #ffd700;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
    }

    .vantagem-item .tipo, .desvantagem-item .tipo {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
        background: rgba(255,215,0,0.2);
        padding: 2px 8px;
        border-radius: 10px;
    }

    .vantagem-item .descricao, .desvantagem-item .descricao {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
    }

    .badge-fobia {
        background: rgba(255,0,0,0.3);
        color: #ff6b6b;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        display: inline-block;
    }

    .pericia-modal-item {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.2);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
    }

    .pericia-modal-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .pericia-modal-nome {
        color: #ffd700;
        font-weight: bold;
    }

    .pericia-modal-nivel {
        color: #4CAF50;
    }

    .pericia-modal-atributo {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
        margin-bottom: 5px;
    }

    .pericia-modal-bonus {
        font-size: 0.8rem;
        color: rgba(255,215,0,0.8);
    }

    .pericia-modal-nh {
        background: rgba(255,215,0,0.1);
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.9rem;
        margin-top: 5px;
        display: inline-block;
    }

    .magia-escola-header {
        background: linear-gradient(45deg, #0a2a3a, #1a4a6a);
        border: 1px solid #4a9fff;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .simbolo-agua {
        width: 40px;
        height: 40px;
        background-image: url('agua1.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }

    .magia-escola-info h4 {
        color: #4a9fff;
        margin-bottom: 5px;
    }

    .magia-escola-info p {
        color: rgba(255,255,255,0.8);
        font-size: 0.9rem;
    }

    .magia-item {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(74,159,255,0.3);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
    }

    .magia-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .magia-nome {
        color: #4a9fff;
        font-weight: bold;
    }

    .magia-nivel {
        background: #ffd700;
        color: #0a0a1a;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
    }

    .magia-tipo {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
        margin-bottom: 5px;
    }

    .magia-efeito {
        font-size: 0.9rem;
        color: #ffd700;
        margin: 5px 0;
    }

    .magia-nh-info {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
        border-top: 1px solid rgba(255,215,0,0.2);
        padding-top: 5px;
        margin-top: 5px;
    }

    .arma-card {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.3);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .arma-card:hover {
        background: rgba(255,215,0,0.1);
        border-color: #ffd700;
    }

    .arma-card.selecionada {
        background: rgba(255,215,0,0.2);
        border-color: #ffd700;
    }

    .arma-nome {
        font-weight: bold;
        color: #ffd700;
        margin-bottom: 5px;
    }

    .arma-detalhes {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.7);
        display: flex;
        gap: 15px;
    }

    .defesa-card-modal {
        background: rgba(0,0,0,0.3);
        border: 1px solid #4CAF50;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .defesa-card-modal:hover:not(.disabled) {
        background: rgba(76,175,80,0.2);
        border-color: #4CAF50;
    }

    .defesa-card-modal.disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .defesa-card-modal.selecionada {
        background: rgba(76,175,80,0.3);
        border-color: #4CAF50;
    }

    .modal-botoes {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-confirmar {
        background: #ffd700;
        color: #0a0a1a;
        border: none;
        padding: 10px 20px;
        border-radius: 30px;
        font-weight: bold;
        cursor: pointer;
        flex: 2;
    }

    .btn-cancelar {
        background: transparent;
        border: 2px solid #ff6b6b;
        color: #ff6b6b;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        flex: 1;
    }

    .dados-flutuante {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 500;
    }

    .btn-dados {
        background: linear-gradient(45deg, #ffd700, #ffaa00);
        color: #0a0a1a;
        border: none;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.5rem;
        box-shadow: 0 5px 20px rgba(255,215,0,0.4);
        transition: all 0.3s;
    }

    .btn-dados:hover {
        transform: scale(1.1);
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10,10,26,0.9);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 20px;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255,215,0,0.2);
        border-top-color: #ffd700;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .npc-sprite[data-npcid="taverneiro"] { left: 85%; top: 60%; }
    .npc-sprite[data-npcid="homem_sangue"] { left: 25%; top: 50%; }
    .npc-sprite[data-npcid="camponesa"] { left: 50%; top: 60%; }
    .npc-sprite[data-npcid="menina_elfa"] { left: 50%; top: 60%; }
    .npc-sprite[data-npcid="chefe_goblin"] { left: 60%; top: 50%; }

    @media (max-width: 1200px) {
        .ficha-coluna { width: 260px; }
        .acoes-coluna { width: 240px; }
        .npc-sprite img {
            width: 120px;
            height: 160px;
        }
        .npc-sprite .npc-nome {
            font-size: 0.8rem;
            padding: 4px 15px;
            bottom: -30px;
        }
    }
</style>
</head>
<body>
    <div class="magic-bg"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando sua aventura...</div>
    </div>

    <div class="modal" id="modalEscolhaAtributo">
        <div class="modal-content">
            <h3><i class="fas fa-star"></i> Você ganhou uma bolinha!</h3>
            <p style="margin-bottom: 20px; color: rgba(255,255,255,0.8);">
                Bolinhas disponíveis: <strong id="bolinhasDisponiveisModal">0</strong>
            </p>
            
            <div class="atributo-opcao" data-atributo="st">
                <div class="icone"><i class="fas fa-fist-raised"></i></div>
                <div class="info">
                    <div class="nome">ST (Força)</div>
                    <div class="descricao">Aumenta dano, carga e habilidades físicas</div>
                </div>
                <div class="valor-atual" id="valorStModal">0</div>
            </div>
            
            <div class="atributo-opcao" data-atributo="dx">
                <div class="icone"><i class="fas fa-running"></i></div>
                <div class="info">
                    <div class="nome">DX (Destreza)</div>
                    <div class="descricao">Aumenta esquiva, perícias físicas e precisão</div>
                </div>
                <div class="valor-atual" id="valorDxModal">0</div>
            </div>
            
            <div class="atributo-opcao" data-atributo="iq">
                <div class="icone"><i class="fas fa-brain"></i></div>
                <div class="info">
                    <div class="nome">IQ (Inteligência)</div>
                    <div class="descricao">Aumenta vontade, perícias mentais e magias</div>
                </div>
                <div class="valor-atual" id="valorIqModal">0</div>
            </div>
            
            <div class="atributo-opcao" data-atributo="ht">
                <div class="icone"><i class="fas fa-heart"></i></div>
                <div class="info">
                    <div class="nome">HT (Vigor)</div>
                    <div class="descricao">Aumenta PV, fadiga e resistência</div>
                </div>
                <div class="valor-atual" id="valorHtModal">0</div>
            </div>
            
            <div class="modal-botoes">
                <button class="btn-cancelar" id="cancelarEscolhaAtributo">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalInventario">
        <div class="modal-content" style="max-width: 900px;">
            <h3><i class="fas fa-backpack"></i> Inventário do Personagem</h3>
            
            <div class="inventario-grid">
                <div class="inventario-coluna">
                    <h4><i class="fas fa-shield-alt"></i> Equipado</h4>
                    <div id="inventarioEquipado"></div>
                </div>
                
                <div class="inventario-coluna">
                    <h4><i class="fas fa-shopping-bag"></i> Mochila</h4>
                    <div id="inventarioMochila"></div>
                </div>
                
                <div class="inventario-coluna">
                    <h4><i class="fas fa-warehouse"></i> Depósito</h4>
                    <div id="inventarioDeposito"></div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                <span><i class="fas fa-coins"></i> Dinheiro: <strong style="color:#ffd700;" id="modalDinheiro">0</strong></span>
                <span><i class="fas fa-weight-hanging"></i> Carga: <strong style="color:#ffd700;" id="modalCarga">0/0 kg</strong></span>
            </div>
            
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalInventario">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalVantagens">
        <div class="modal-content">
            <h3><i class="fas fa-star"></i> Vantagens do Personagem</h3>
            <div class="vantagens-lista" id="vantagensLista"></div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalVantagens">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalDesvantagens">
        <div class="modal-content">
            <h3><i class="fas fa-skull"></i> Desvantagens do Personagem</h3>
            <div class="desvantagens-lista" id="desvantagensLista"></div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalDesvantagens">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalPericias">
        <div class="modal-content" style="max-width: 600px;">
            <h3><i class="fas fa-brain"></i> Perícias do Personagem</h3>
            <div class="pericias-lista" id="periciasLista"></div>
            <div style="margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px; text-align: center;">
                <span>PM: <strong style="color:#ffd700;" id="modalPM">0/0</strong></span>
            </div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalPericias">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalMagias">
        <div class="modal-content" style="max-width: 600px;">
            <h3><i class="fas fa-magic"></i> Magias do Personagem</h3>
            
            <div class="magia-escola-header">
                <div class="simbolo-agua"></div>
                <div class="magia-escola-info">
                    <h4>Escola da Água</h4>
                    <p>Aptidão Mágica: <span id="modalAptidao">0</span></p>
                </div>
            </div>
            
            <div class="magias-lista" id="magiasLista"></div>
            
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalMagias">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalAtaque">
        <div class="modal-content">
            <h3><i class="fas fa-sword"></i> Escolha sua Arma</h3>
            <div id="armasLista"></div>
            <div class="modal-botoes">
                <button class="btn-cancelar" id="btnCancelarAtaque">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirmar" id="btnConfirmarAtaque" disabled>
                    <i class="fas fa-check"></i> Atacar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalDefesa">
        <div class="modal-content">
            <h3><i class="fas fa-shield-alt"></i> Escolha sua Defesa</h3>
            <p id="defesaContexto" style="margin-bottom: 15px; color: rgba(255,255,255,0.8);"></p>
            <div id="defesasLista"></div>
            <div class="modal-botoes">
                <button class="btn-cancelar" id="btnCancelarDefesa">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirmar" id="btnConfirmarDefesa" disabled>
                    <i class="fas fa-check"></i> Defender
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalDados">
        <div class="modal-content">
            <h3><i class="fas fa-dice-d20"></i> Rolagem de Dados</h3>
            
            <div style="display: flex; flex-direction: column; gap: 15px; margin: 20px 0;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Quantidade:</label>
                    <input type="number" id="dadosQtd" min="1" max="10" value="1" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 8px; border-radius: 8px; width: 100px;">
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Faces:</label>
                    <select id="dadosFaces" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 8px; border-radius: 8px; width: 100px;">
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10" selected>d10</option>
                        <option value="12">d12</option>
                        <option value="20">d20</option>
                        <option value="100">d100</option>
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Modificador:</label>
                    <input type="number" id="dadosMod" value="0" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 8px; border-radius: 8px; width: 100px;">
                </div>
            </div>
            
            <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 20px; text-align: center; font-size: 1.5rem; color: #ffd700; margin: 20px 0;" id="dadosResultado">
                Clique em Rolar
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn-cancelar" id="btnFecharDados" style="flex:1;">Fechar</button>
                <button class="btn-confirmar" id="btnRolarDados" style="flex:2;">Rolar</button>
            </div>
        </div>
    </div>

    <div class="dados-flutuante">
        <button class="btn-dados" id="btnAbrirDados">
            <i class="fas fa-dice-d20"></i>
        </button>
    </div>

    <div class="game-container">
        <div class="game-header">
            <div class="personagem-info">
                <div class="personagem-avatar" id="headerAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <span class="personagem-nome" id="headerNome">Carregando...</span>
                    <span style="font-size:0.8rem; color:rgba(255,255,255,0.6); margin-left:10px;" id="headerClasse"></span>
                </div>
            </div>

            <div class="status-bars">
                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-heart"></i> PV</span>
                        <span id="headerPV">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill vida" id="headerPVBarra" style="width:0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-magic"></i> Mana</span>
                        <span id="headerMana">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill mana" id="headerManaBarra" style="width:0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-tint"></i> Fadiga</span>
                        <span id="headerFadiga">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill fadiga" id="headerFadigaBarra" style="width:0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-star"></i> XP</span>
                        <span id="headerXP">0/100</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill xp" id="headerXPBarra" style="width:0%"></div>
                    </div>
                </div>
            </div>

            <div class="pm-display" id="pmDisplay">
                <i class="fas fa-crown"></i>
                <span>PM: <span id="pmValor">0</span></span>
            </div>
        </div>

        <div class="main-area">
            <div class="ficha-coluna">
                <div class="ficha-header">
                    <div class="ficha-avatar" id="fichaAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="ficha-nome" id="fichaNome">Carregando...</div>
                    <div class="ficha-classe" id="fichaClasse"></div>
                </div>

                <div class="nivel-indicator">
                    <div class="nivel-info">
                        <i class="fas fa-crown"></i>
                        <span>Nível do Personagem</span>
                    </div>
                    <div class="nivel-valor" id="nivelPersonagem">1</div>
                </div>

                <div class="ato-indicator" id="atoIndicator">
                    <i class="fas fa-scroll"></i> <span id="atoTexto">Ato 1: A Taverna</span>
                </div>

                <div class="bolinhas-saldo" id="bolinhasSaldoContainer" style="display: none;">
                    <span><i class="fas fa-star"></i> Bolinhas disponíveis:</span>
                    <span class="valor" id="bolinhasSaldo">0</span>
                </div>

                <div class="atributos-container" id="atributosContainer"></div>

                <div class="defesas-grid" id="defesasGrid"></div>

                <div class="ficha-botoes">
                    <button class="ficha-botao" id="btnVerVantagens">
                        <i class="fas fa-star"></i>
                        <span>Vantagens</span>
                        <span class="contador" id="contadorVantagensBtn">0</span>
                    </button>
                    <button class="ficha-botao" id="btnVerDesvantagens">
                        <i class="fas fa-skull"></i>
                        <span>Desvantagens</span>
                        <span class="contador" id="contadorDesvantagensBtn">0</span>
                    </button>
                    <button class="ficha-botao" id="btnVerPericias">
                        <i class="fas fa-brain"></i>
                        <span>Perícias</span>
                        <span class="contador" id="contadorPericiasBtn">0</span>
                    </button>
                    <button class="ficha-botao" id="btnVerMagias">
                        <i class="fas fa-magic"></i>
                        <span>Magias</span>
                        <span class="contador" id="contadorMagiasBtn">0</span>
                    </button>
                </div>
            </div>

            <div class="cenario-coluna">
                <div class="cenario-area" id="cenarioArea">
                    <div class="cenario-overlay"></div>
                    <div class="npcs-container" id="npcsContainer"></div>
                </div>

                <div class="dialogo-area" id="dialogoArea">
                    <div class="npc-falando" id="npcFalando">
                        <img src="" alt="" id="npcAvatar" style="display: none;">
                        <span id="npcNome">Narrador</span>
                    </div>
                    <div class="dialogo-texto" id="dialogoTexto">
                        Preparando sua aventura...
                    </div>
                    <div class="opcoes-dialogo" id="opcoesDialogo"></div>
                </div>
            </div>

            <div class="acoes-coluna">
                <div class="turno-indicator jogador" id="turnoIndicator">
                    <i class="fas fa-user"></i> SEU TURNO
                </div>

                <div class="acoes-grid">
                    <button class="acao-btn atacar" id="btnAtacar" disabled>
                        <i class="fas fa-sword"></i> Atacar
                    </button>
                    <button class="acao-btn magia" id="btnMagia" disabled>
                        <i class="fas fa-magic"></i> Magia
                    </button>
                    <button class="acao-btn" id="btnDefesaAtiva">
                        <i class="fas fa-shield-alt"></i> Defender
                    </button>
                    <button class="acao-btn" id="btnInventario">
                        <i class="fas fa-backpack"></i> Inventário
                    </button>
                </div>

                <div id="inimigosContainer" style="display: none;">
                    <h4 style="color:#ff6b6b; margin-bottom:8px;"><i class="fas fa-skull"></i> Inimigos</h4>
                    <div class="inimigos-lista" id="inimigosLista"></div>
                </div>

                <div class="log-container" id="logContainer">
                    <div class="log-item">A aventura começou...</div>
                </div>
            </div>
        </div>
    </div>

<script>
// ============================================
// SISTEMA SOCIAL REUTILIZÁVEL
// ============================================

const SistemaSocial = {
    calcularBonusAparencia: function(personagem) {
        let bonus = 0;
        if (personagem.vantagens && personagem.vantagens.includes('atraente')) bonus += 2;
        if (personagem.desvantagens && personagem.desvantagens.includes('feio')) bonus -= 2;
        return bonus;
    },
    
    calcularBonusCarisma: function(personagem) {
        return (personagem.vantagens && personagem.vantagens.includes('carisma')) ? 1 : 0;
    },
    
    testarReacao: function(npc, jogador) {
        const baseReacao = npc.reacaoBase || 10;
        const bonusAparencia = this.calcularBonusAparencia(jogador);
        const bonusCarisma = this.calcularBonusCarisma(jogador);
        const bonusTotal = bonusAparencia + bonusCarisma;
        const rolagem = Math.floor(Math.random() * 10) + 1 + Math.floor(Math.random() * 10) + 1;
        const reacaoFinal = baseReacao + bonusTotal + (rolagem - 11);
        
        let classificacao = '';
        if (reacaoFinal <= 7) classificacao = 'ruim';
        else if (reacaoFinal <= 14) classificacao = 'normal';
        else classificacao = 'otima';
        
        return {
            valor: reacaoFinal,
            rolagem: rolagem,
            bonusAparencia: bonusAparencia,
            bonusCarisma: bonusCarisma,
            classificacao: classificacao
        };
    },
    
    testeSocial: function(nhJogador, dificuldade, modificadores = 0) {
        const rolagem = Math.floor(Math.random() * 10) + 1 + Math.floor(Math.random() * 10) + 1;
        const total = rolagem + modificadores;
        const sucesso = total <= nhJogador;
        const margem = nhJogador - total;
        
        return {
            sucesso: sucesso,
            rolagem: rolagem,
            total: total,
            nh: nhJogador,
            margem: margem,
            critico: margem >= 5,
            falhaCritica: total >= nhJogador + 5
        };
    }
};
</script>

<script>
// ============================================
// SISTEMA DE COMBATE COMPLETO
// ============================================

const SistemaCombate = {
    
    rolar2d10: function() {
        const d1 = Math.floor(Math.random() * 10) + 1;
        const d2 = Math.floor(Math.random() * 10) + 1;
        return {
            total: d1 + d2,
            dados: [d1, d2],
            texto: `${d1} + ${d2} = ${d1 + d2}`,
            isCritico: (d1 + d2) <= 4,
            isFalhaCritica: (d1 + d2) >= 18
        };
    },
    
    rolarDados: function(expressao) {
        const match = expressao.match(/(\d+)d([+-]\d+)?/);
        if (!match) return 0;
        const qtd = parseInt(match[1]) || 1;
        const mod = match[2] ? parseInt(match[2]) : 0;
        let total = 0;
        for (let i = 0; i < qtd; i++) {
            total += Math.floor(Math.random() * 6) + 1;
        }
        return Math.max(0, total + mod);
    },
    
    getNHAtaque: function(personagem, arma) {
        if (!personagem || !arma) return 10;
        let periciaId = 'espada';
        const nome = arma.nome.toLowerCase();
        if (nome.includes('machado')) periciaId = 'machado';
        else if (nome.includes('arco')) periciaId = 'arco';
        else if (nome.includes('espada')) periciaId = 'espada';
        else if (nome.includes('maca')) periciaId = 'maca';
        
        if (personagem.pericias && personagem.pericias[periciaId]) {
            return personagem.pericias[periciaId].nh || (personagem.atributos.dx.valor + 3);
        }
        return (personagem.atributos.dx.valor || 10) + 3;
    },
    
    atacar: function(atacante, alvo, arma) {
        const nh = this.getNHAtaque(atacante, arma);
        const rolagem = this.rolar2d10();
        
        const resultado = {
            acertou: rolagem.total <= nh,
            critico: rolagem.isCritico,
            falhaCritica: rolagem.isFalhaCritica,
            rolagem: rolagem,
            nh: nh,
            arma: arma,
            dano: 0,
            texto: ''
        };
        
        if (rolagem.isFalhaCritica) {
            resultado.texto = `💥 FALHA CRÍTICA! (${rolagem.texto})`;
            resultado.perdeDefesa = true;
            return resultado;
        }
        
        if (rolagem.total <= nh) {
            let dano = this.rolarDados(arma.dano);
            if (rolagem.isCritico) {
                dano *= 2;
                resultado.texto = `✨ ATAQUE CRÍTICO! (${rolagem.texto})`;
            } else {
                resultado.texto = `✅ Acertou! (${rolagem.texto})`;
            }
            if (arma.tipoDano === 'Corte' || arma.tipoDano === 'Perfuração') {
                dano = Math.floor(dano * 1.5);
            }
            resultado.dano = dano;
        } else {
            resultado.texto = `❌ Errou! (${rolagem.texto})`;
        }
        
        return resultado;
    },
    
    calcularIniciativa: function(personagem, inimigos, emboscada = null) {
        let pcIniciativa = personagem.atributos.dx.valor || 10;
        if (personagem.vantagens && personagem.vantagens.includes('reflexoCombate')) pcIniciativa += 2;
        
        let somaDx = 0;
        inimigos.forEach(inimigo => somaDx += inimigo.dx || 10);
        let inimigosIniciativa = somaDx / inimigos.length;
        
        if (emboscada === 'pc') pcIniciativa += 3;
        else if (emboscada === 'inimigos') inimigosIniciativa += 3;
        
        const pcComeca = pcIniciativa >= inimigosIniciativa;
        
        return {
            quemComeca: pcComeca ? 'pc' : 'inimigos',
            pc: pcIniciativa,
            inimigos: inimigosIniciativa,
            texto: pcComeca ? '🎲 Você age primeiro!' : '🎲 Os inimigos agem primeiro!'
        };
    },
    
    defender: function(defensor, tipoDefesa, ataque, estadoDefesa = {}) {
        if (estadoDefesa.perdeuDefesa) {
            return {
                sucesso: false,
                motivo: 'Você perdeu a defesa neste turno!',
                danoFinal: ataque.dano || 0,
                texto: '💥 Sem defesa!'
            };
        }
        
        const esquiva = defensor.derivados?.esquiva || 8;
        const aparar = defensor.derivados?.aparar || 0;
        const bloqueio = defensor.derivados?.bloqueio || 0;
        
        const defesasDisponiveis = {
            esquiva: { nh: esquiva, disponivel: true, usado: false },
            aparar: { nh: aparar, disponivel: aparar > 0, usado: false },
            bloqueio: { nh: bloqueio, disponivel: bloqueio > 0, usado: false }
        };
        
        if (!defesasDisponiveis[tipoDefesa] || !defesasDisponiveis[tipoDefesa].disponivel) {
            return { sucesso: false, motivo: `Não pode usar ${tipoDefesa}`, danoFinal: ataque.dano || 0 };
        }
        
        if (tipoDefesa === 'aparar' && estadoDefesa.usouAparar) {
            return { sucesso: false, motivo: 'Aparar já foi usado!', danoFinal: ataque.dano || 0 };
        }
        
        const nh = defesasDisponiveis[tipoDefesa].nh;
        const rolagem = this.rolar2d10();
        const sucesso = rolagem.total <= nh;
        
        let danoFinal = ataque.dano || 0;
        let texto = '';
        
        if (sucesso) {
            danoFinal = 0;
            texto = `✅ ${tipoDefesa} bem sucedida! (${rolagem.texto})`;
            if (tipoDefesa === 'aparar' && sucesso) estadoDefesa.usouAparar = true;
        } else {
            const rd = defensor.derivados?.rd?.corpo || 0;
            danoFinal = Math.max(0, danoFinal - rd);
            texto = `❌ Falhou na ${tipoDefesa}! (${rolagem.texto}) RD reduziu para ${danoFinal}`;
        }
        
        return {
            sucesso: sucesso,
            tipo: tipoDefesa,
            rolagem: rolagem,
            nh: nh,
            danoFinal: danoFinal,
            texto: texto,
            novoEstado: estadoDefesa
        };
    },
    
    fadiga: {
        contadorTurnos: 0,
        iniciarCombate: function() { this.contadorTurnos = 0; },
        passarTurno: function(personagem) {
            this.contadorTurnos++;
            if (this.contadorTurnos % 5 === 0 && personagem.statusCombate) {
                personagem.statusCombate.fadigaAtual--;
                if (personagem.statusCombate.fadigaAtual <= 0) {
                    return { perdeuFadiga: true, penalidade: true, texto: '😮‍💨 FADIGA ZERO! Habilidades reduzidas!' };
                }
                return { perdeuFadiga: true, fadigaAtual: personagem.statusCombate.fadigaAtual, texto: `😮‍💨 Perdeu 1 PF` };
            }
            return { perdeuFadiga: false };
        }
    },
    
    turno: {
        atual: 'pc',
        numero: 1,
        estadoDefesa: { perdeuDefesa: false, usouAparar: false },
        
        iniciarCombate: function(quemComeca) {
            this.atual = quemComeca;
            this.numero = 1;
            this.estadoDefesa = { perdeuDefesa: false, usouAparar: false };
            SistemaCombate.fadiga.iniciarCombate();
        },
        
        passarTurno: function(personagem) {
            const fadigaResult = SistemaCombate.fadiga.passarTurno(personagem);
            this.estadoDefesa.usouAparar = false;
            if (this.estadoDefesa.perdeuDefesa) this.estadoDefesa.perdeuDefesa = false;
            this.atual = this.atual === 'pc' ? 'inimigos' : 'pc';
            this.numero++;
            return { turno: this.atual, numero: this.numero, fadiga: fadigaResult };
        },
        
        perderDefesa: function() { this.estadoDefesa.perdeuDefesa = true; }
    }
};

window.SistemaCombate = SistemaCombate;
</script>
   
<script type="module">
// ============================================
// IMPORTAÇÕES FIREBASE
// ============================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// ============================================
// CONFIGURAÇÃO FIREBASE
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyBrx4JSmFay24k95pu1ICjFfVki8gs_uHw",
    authDomain: "rpgforce-e3227.firebaseapp.com",
    projectId: "rpgforce-e3227",
    storageBucket: "rpgforce-e3227.firebasestorage.app",
    messagingSenderId: "984517342332",
    appId: "1:984517342332:web:87d33aa4c84ff2a07685f9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ============================================
// ELEMENTOS DOM
// ============================================
const loadingOverlay = document.getElementById('loadingOverlay');

// Header
const headerAvatar = document.getElementById('headerAvatar');
const headerNome = document.getElementById('headerNome');
const headerClasse = document.getElementById('headerClasse');
const headerPV = document.getElementById('headerPV');
const headerPVBarra = document.getElementById('headerPVBarra');
const headerMana = document.getElementById('headerMana');
const headerManaBarra = document.getElementById('headerManaBarra');
const headerFadiga = document.getElementById('headerFadiga');
const headerFadigaBarra = document.getElementById('headerFadigaBarra');
const headerXP = document.getElementById('headerXP');
const headerXPBarra = document.getElementById('headerXPBarra');
const pmValor = document.getElementById('pmValor');

// Ficha
const fichaAvatar = document.getElementById('fichaAvatar');
const fichaNome = document.getElementById('fichaNome');
const fichaClasse = document.getElementById('fichaClasse');
const atributosContainer = document.getElementById('atributosContainer');
const defesasGrid = document.getElementById('defesasGrid');
const bolinhasSaldoContainer = document.getElementById('bolinhasSaldoContainer');
const bolinhasSaldo = document.getElementById('bolinhasSaldo');
const atoIndicator = document.getElementById('atoIndicator');
const atoTexto = document.getElementById('atoTexto');
const nivelPersonagem = document.getElementById('nivelPersonagem');

// Botões de ficha
const btnVerVantagens = document.getElementById('btnVerVantagens');
const btnVerDesvantagens = document.getElementById('btnVerDesvantagens');
const btnVerPericias = document.getElementById('btnVerPericias');
const btnVerMagias = document.getElementById('btnVerMagias');
const contadorVantagensBtn = document.getElementById('contadorVantagensBtn');
const contadorDesvantagensBtn = document.getElementById('contadorDesvantagensBtn');
const contadorPericiasBtn = document.getElementById('contadorPericiasBtn');
const contadorMagiasBtn = document.getElementById('contadorMagiasBtn');

// Cenário e diálogo
const cenarioArea = document.getElementById('cenarioArea');
const npcsContainer = document.getElementById('npcsContainer');
const npcFalando = document.getElementById('npcFalando');
const npcAvatar = document.getElementById('npcAvatar');
const npcNome = document.getElementById('npcNome');
const dialogoTexto = document.getElementById('dialogoTexto');
const opcoesDialogo = document.getElementById('opcoesDialogo');

// Ações
const turnoIndicator = document.getElementById('turnoIndicator');
const btnAtacar = document.getElementById('btnAtacar');
const btnMagia = document.getElementById('btnMagia');
const btnInventario = document.getElementById('btnInventario');
const btnDescansar = document.getElementById('btnDescansar');
const inimigosContainer = document.getElementById('inimigosContainer');
const inimigosLista = document.getElementById('inimigosLista');
const logContainer = document.getElementById('logContainer');

// Modais
const modalEscolhaAtributo = document.getElementById('modalEscolhaAtributo');
const modalInventario = document.getElementById('modalInventario');
const modalVantagens = document.getElementById('modalVantagens');
const modalDesvantagens = document.getElementById('modalDesvantagens');
const modalPericias = document.getElementById('modalPericias');
const modalMagias = document.getElementById('modalMagias');
const modalAtaque = document.getElementById('modalAtaque');
const modalDefesa = document.getElementById('modalDefesa');
const modalDados = document.getElementById('modalDados');

const bolinhasDisponiveisModal = document.getElementById('bolinhasDisponiveisModal');
const valorStModal = document.getElementById('valorStModal');
const valorDxModal = document.getElementById('valorDxModal');
const valorIqModal = document.getElementById('valorIqModal');
const valorHtModal = document.getElementById('valorHtModal');

const cancelarEscolhaAtributo = document.getElementById('cancelarEscolhaAtributo');
const fecharModalInventario = document.getElementById('fecharModalInventario');
const fecharModalVantagens = document.getElementById('fecharModalVantagens');
const fecharModalDesvantagens = document.getElementById('fecharModalDesvantagens');
const fecharModalPericias = document.getElementById('fecharModalPericias');
const fecharModalMagias = document.getElementById('fecharModalMagias');

const armasLista = document.getElementById('armasLista');
const btnCancelarAtaque = document.getElementById('btnCancelarAtaque');
const btnConfirmarAtaque = document.getElementById('btnConfirmarAtaque');

const defesaContexto = document.getElementById('defesaContexto');
const defesasLista = document.getElementById('defesasLista');
const btnCancelarDefesa = document.getElementById('btnCancelarDefesa');
const btnConfirmarDefesa = document.getElementById('btnConfirmarDefesa');

const btnAbrirDados = document.getElementById('btnAbrirDados');
const btnFecharDados = document.getElementById('btnFecharDados');
const btnRolarDados = document.getElementById('btnRolarDados');
const dadosResultado = document.getElementById('dadosResultado');
const dadosQtd = document.getElementById('dadosQtd');
const dadosFaces = document.getElementById('dadosFaces');
const dadosMod = document.getElementById('dadosMod');

const modalDinheiro = document.getElementById('modalDinheiro');
const modalCarga = document.getElementById('modalCarga');
const modalPM = document.getElementById('modalPM');
const modalAptidao = document.getElementById('modalAptidao');

// ============================================
// DICIONÁRIOS DE NOMES
// ============================================
const nomesVantagens = {
    aliado: 'Aliado',
    ambidestria: 'Ambidestria',
    aptidaoMagica: 'Aptidão Mágica',
    abascanto: 'Abascanto',
    carisma: 'Carisma',
    destemor: 'Destemor',
    duroMatar: 'Duro de Matar',
    flexibilidade: 'Flexibilidade',
    intuicao: 'Intuição',
    nocaoPerigo: 'Noção do Perigo',
    reflexoCombate: 'Reflexo de Combate',
    regeneracao: 'Regeneração',
    sentidosAgucados: 'Sentidos Aguçados',
    sorte: 'Sorte',
    visaoNoturna: 'Visão Noturna',
    mestreArmas: 'Mestre das Armas',
    forcaVontade: 'Força de Vontade',
    fadigaExtra: 'Fadiga Extra',
    htExtra: 'HT Extra',
    atraente: 'Atraente',
    rico: 'Rico'
};

const nomesDesvantagens = {
    alcoolismo: 'Alcoolismo',
    avareza: 'Avareza',
    briguento: 'Briguento',
    barulhento: 'Barulhento',
    cobica: 'Cobiça',
    circunspeccao: 'Circunspecção',
    cleptomania: 'Cleptomania',
    codigoHonra: 'Código de Honra',
    covardia: 'Covardia',
    daltonismo: 'Daltonismo',
    sensoDever: 'Senso do Dever',
    inimigo: 'Inimigo',
    excessoConfianca: 'Excesso de Confiança',
    fobia: 'Fobia',
    furia: 'Fúria',
    honestidade: 'Honestidade',
    luxuria: 'Luxúria',
    megalomania: 'Megalomania',
    pacifismo: 'Pacifismo',
    piromania: 'Piromania',
    preguica: 'Preguiça',
    sanguinolencia: 'Sanguinolência',
    teimosia: 'Teimosia',
    veracidade: 'Veracidade',
    zarolho: 'Zarolho',
    magro: 'Magro',
    gordo: 'Gordo',
    nanismo: 'Nanismo',
    pobre: 'Pobre',
    feio: 'Feio'
};

const nomesFobias = {
    acrofobia: 'Acrofobia - Medo de alturas',
    agorafobia: 'Agorafobia - Medo de espaços abertos',
    aracnofobia: 'Aracnofobia - Medo de aranhas',
    autofobia: 'Autofobia - Medo de solidão',
    brontofobia: 'Brontofobia - Medo de ruídos altos',
    claustrofobia: 'Claustrofobia - Medo de espaços fechados',
    coitofobia: 'Coitofobia - Medo de sexo',
    demofobia: 'Demofobia - Medo de multidões',
    ecmofobia: 'Ecmofobia - Medo de coisas afiadas',
    elurofobia: 'Elurofobia - Medo de gatos',
    entomofobia: 'Entomofobia - Medo de insetos',
    hematofobia: 'Hematofobia - Medo de sangue',
    hoplofobia: 'Hoplofobia - Medo de armas',
    manafobia: 'Manafobia - Medo de magia',
    misofobia: 'Misofobia - Medo de sujeira',
    necrofobia: 'Necrofobia - Medo da morte',
    nictofobia: 'Nictofobia - Medo do escuro',
    ofiofobia: 'Ofiofobia - Medo de répteis',
    pirofobia: 'Pirofobia - Medo de fogo',
    psicofobia: 'Psicofobia - Medo de poderes psíquicos',
    talassofobia: 'Talassofobia - Medo do mar',
    tecnofobia: 'Tecnofobia - Medo de máquinas',
    teratofobia: 'Teratofobia - Medo de monstros',
    triscedecofobia: 'Triscedecofobia - Medo do número 13',
    xenofobia: 'Xenofobia - Medo do desconhecido'
};

// ============================================
// ESTADO DO JOGO
// ============================================
let currentUser = null;
let personagem = null;
let historia = null;
let capituloAtual = null;
let inimigos = [];
let sessaoId = null;

let turnoAtual = 'jogador';
let inimigoSelecionado = null;
let armaSelecionada = null;
let defesaSelecionada = null;
let ataqueAtual = null;

// Controle de tempo e eventos
let timerHomem = null;
let atoAtual = 1;

// Status do personagem
let pvAtual = 0;
let pvMax = 0;
let fadigaAtual = 0;
let fadigaMax = 0;
let manaAtual = 0;
let manaMax = 0;
let xpAtual = 0;
let pmAtual = 0;
let bolinhasDisponiveis = 0;
let pmDisponivel = 30;
let pmGasto = 0;

const XP_POR_BOLINHA = 100;

// ============================================
// FUNÇÕES AUXILIARES
// ============================================
function showLoading() {
    if (loadingOverlay) loadingOverlay.classList.add('active');
}

function hideLoading() {
    if (loadingOverlay) loadingOverlay.classList.remove('active');
}

function adicionarLog(mensagem, tipo = 'info') {
    if (!logContainer) return;
    const logItem = document.createElement('div');
    logItem.className = `log-item ${tipo}`;
    logItem.innerHTML = mensagem;
    logContainer.appendChild(logItem);
    logContainer.scrollTop = logContainer.scrollHeight;
    
    while (logContainer.children.length > 50) {
        logContainer.removeChild(logContainer.firstChild);
    }
}

function rolarDados(quantidade, faces, modificador = 0) {
    let total = 0;
    let resultados = [];
    
    for (let i = 0; i < quantidade; i++) {
        const resultado = Math.floor(Math.random() * faces) + 1;
        resultados.push(resultado);
        total += resultado;
    }
    
    total += modificador;
    
    return {
        total: total,
        resultados: resultados,
        modificador: modificador,
        texto: `${resultados.join(' + ')} ${modificador >= 0 ? '+' : '-'} ${Math.abs(modificador)} = ${total}`
    };
}

function rolar2d10() {
    return rolarDados(2, 10, 0);
}

function setAto(numero, texto) {
    atoAtual = numero;
    if (atoTexto) atoTexto.textContent = `Ato ${numero}: ${texto}`;
    adicionarLog(`📜 Ato ${numero}: ${texto}`, 'sucesso');
}

function getValorAtributo(atributo) {
    if (!personagem || !personagem.atributos) return 0;
    
    const base = { st: 9, dx: 5, iq: 5, ht: 8 }[atributo];
    const bolinhas = personagem.atributos[atributo]?.bolinhas || 0;
    return base + bolinhas;
}

function getValorAtributoReal(atributo) {
    if (!personagem || !personagem.atributos) return 0;
    return personagem.atributos[atributo]?.valor || 0;
}

function calcularManaMax() {
    const iq = getValorAtributoReal('iq');
    const ht = getValorAtributoReal('ht');
    return iq + ht;
}

function calcularPVMax() {
    const ht = getValorAtributoReal('ht');
    return ht * 8;
}

function calcularFadigaMax() {
    if (!personagem || !personagem.atributos?.ht) return 8;
    return 8 + (personagem.atributos.ht.bolinhas || 0);
}

function calcularPMAtual() {
    if (!personagem) return 0;
    const disponivel = personagem.pmDisponivel || 30;
    const gasto = personagem.pmGasto || 0;
    return Math.max(0, disponivel - gasto);
}

function calcularNivelPersonagem() {
    if (!personagem || !personagem.atributos) return 1;
    
    const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
    const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
    const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
    const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
    
    const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
    return totalBolinhas + 1;
}

function atualizarNivelNaTela() {
    const nivelElement = document.getElementById('nivelPersonagem');
    if (nivelElement) {
        const nivel = calcularNivelPersonagem();
        nivelElement.textContent = nivel;
    }
}

function verificarGanhoBolinha() {
    if (!personagem) return;
    
    const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
    const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
    const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
    const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
    
    const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
    const xpNecessario = (totalBolinhas + bolinhasDisponiveis + 1) * XP_POR_BOLINHA;
    
    while (xpAtual >= xpNecessario) {
        bolinhasDisponiveis++;
        xpAtual -= xpNecessario;
        adicionarLog(`🌟 Você ganhou uma bolinha! (Total: ${bolinhasDisponiveis} disponíveis)`, 'sucesso');
        
        const novoTotal = totalBolinhas + bolinhasDisponiveis;
        const proximoXP = (novoTotal + 1) * XP_POR_BOLINHA;
        if (headerXP) headerXP.textContent = `${xpAtual}/${proximoXP}`;
        if (headerXPBarra) headerXPBarra.style.width = (xpAtual / proximoXP * 100) + '%';
    }
    
    atualizarInterfaceBolinhas();
}

function atualizarInterfaceBolinhas() {
    if (!bolinhasSaldoContainer || !bolinhasSaldo) return;
    
    if (bolinhasDisponiveis > 0) {
        bolinhasSaldoContainer.style.display = 'flex';
        bolinhasSaldo.textContent = bolinhasDisponiveis;
        
        document.querySelectorAll('.atributo-card').forEach(card => {
            card.classList.add('bolinha-disponivel');
        });
    } else {
        bolinhasSaldoContainer.style.display = 'none';
        document.querySelectorAll('.atributo-card').forEach(card => {
            card.classList.remove('bolinha-disponivel');
        });
    }
}

function abrirModalEscolhaAtributo() {
    if (!modalEscolhaAtributo) return;
    if (bolinhasDisponiveis <= 0) return;
    
    if (valorStModal) valorStModal.textContent = getValorAtributo('st');
    if (valorDxModal) valorDxModal.textContent = getValorAtributo('dx');
    if (valorIqModal) valorIqModal.textContent = getValorAtributo('iq');
    if (valorHtModal) valorHtModal.textContent = getValorAtributo('ht');
    if (bolinhasDisponiveisModal) bolinhasDisponiveisModal.textContent = bolinhasDisponiveis;
    
    modalEscolhaAtributo.classList.add('active');
}

function adicionarBolinha(atributo) {
    if (bolinhasDisponiveis <= 0) return;
    
    if (!personagem.atributos[atributo]) {
        personagem.atributos[atributo] = { 
            bolinhas: 0, 
            base: (atributo === 'st' || atributo === 'ht') ? 8 : 5, 
            valor: (atributo === 'st' || atributo === 'ht') ? 8 : 5 
        };
    }
    
    const nivelAntes = calcularNivelPersonagem();
    
    personagem.atributos[atributo].bolinhas = (personagem.atributos[atributo].bolinhas || 0) + 1;
    personagem.atributos[atributo].valor = personagem.atributos[atributo].base + personagem.atributos[atributo].bolinhas;
    
    bolinhasDisponiveis--;
    
    const nivelDepois = calcularNivelPersonagem();
    
    pvMax = calcularPVMax();
    manaMax = calcularManaMax();
    fadigaMax = calcularFadigaMax();
    
    adicionarLog(`✨ Bolinha adicionada em ${atributo.toUpperCase()}! (${bolinhasDisponiveis} restantes)`, 'sucesso');
    
    if (nivelDepois > nivelAntes) {
        adicionarLog(`📊 NÍVEL AUMENTOU: ${nivelAntes} → ${nivelDepois}!`, 'sucesso');
    }
    
    atualizarFichaPersonagem();
    atualizarNivelNaTela();
    
    salvarProgresso();
    
    if (bolinhasDisponiveis > 0) {
        abrirModalEscolhaAtributo();
    } else {
        if (modalEscolhaAtributo) modalEscolhaAtributo.classList.remove('active');
    }
}

function abrirModalVantagens() {
    if (!modalVantagens) return;
    const vantagensLista = document.getElementById('vantagensLista');
    if (!vantagensLista) return;
    
    if (!personagem || !personagem.vantagens || personagem.vantagens.length === 0) {
        vantagensLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma vantagem</div>';
        modalVantagens.classList.add('active');
        return;
    }
    
    vantagensLista.innerHTML = '';
    
    personagem.vantagens.forEach(vantagemId => {
        const nome = nomesVantagens[vantagemId] || vantagemId;
        const div = document.createElement('div');
        div.className = 'vantagem-item';
        div.innerHTML = `
            <h4>${nome}</h4>
            <div class="tipo">Vantagem</div>
        `;
        vantagensLista.appendChild(div);
    });
    
    modalVantagens.classList.add('active');
}

function abrirModalDesvantagens() {
    if (!modalDesvantagens) return;
    const desvantagensLista = document.getElementById('desvantagensLista');
    if (!desvantagensLista) return;
    
    if (!personagem || !personagem.desvantagens || personagem.desvantagens.length === 0) {
        desvantagensLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma desvantagem</div>';
        modalDesvantagens.classList.add('active');
        return;
    }
    
    desvantagensLista.innerHTML = '';
    
    personagem.desvantagens.forEach(desvantagemId => {
        let nome = '';
        if (desvantagemId.startsWith('fobia:')) {
            const fobiaId = desvantagemId.replace('fobia:', '');
            nome = nomesFobias[fobiaId] || fobiaId;
        } else {
            nome = nomesDesvantagens[desvantagemId] || desvantagemId;
        }
        
        const div = document.createElement('div');
        div.className = 'desvantagem-item';
        
        let extra = '';
        if (desvantagemId.startsWith('fobia:')) {
            extra = '<span class="badge-fobia">Fobia</span>';
        }
        
        div.innerHTML = `
            <h4>${nome} ${extra}</h4>
            <div class="tipo">Desvantagem</div>
        `;
        desvantagensLista.appendChild(div);
    });
    
    modalDesvantagens.classList.add('active');
}

function abrirModalPericias() {
    if (!modalPericias) return;
    const periciasLista = document.getElementById('periciasLista');
    if (!periciasLista) return;
    
    if (!personagem || !personagem.pericias) {
        periciasLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma perícia</div>';
        if (modalPM) modalPM.textContent = `${pmAtual}/${pmDisponivel}`;
        modalPericias.classList.add('active');
        return;
    }
    
    periciasLista.innerHTML = '';
    
    const pericias = personagem.pericias;
    const periciasArray = Object.entries(pericias);
    
    if (periciasArray.length === 0) {
        periciasLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma perícia</div>';
    } else {
        periciasArray.forEach(([id, dados]) => {
            const nome = id.charAt(0).toUpperCase() + id.slice(1);
            const nivel = dados.nivel || 1;
            const bonus = nivel === 1 ? 0 : nivel - 1;
            
            let atributoBase = 10;
            let atributoNome = 'ST';
            
            if (id === 'alquimia' || id === 'intimidacao' || id === 'labia') {
                atributoBase = getValorAtributoReal('iq');
                atributoNome = 'IQ';
            } else {
                atributoBase = getValorAtributoReal('dx');
                atributoNome = 'DX';
            }
            
            const nh = atributoBase + bonus;
            
            const div = document.createElement('div');
            div.className = 'pericia-modal-item';
            div.innerHTML = `
                <div class="pericia-modal-header">
                    <span class="pericia-modal-nome">${nome}</span>
                    <span class="pericia-modal-nivel">Nível ${nivel}</span>
                </div>
                <div class="pericia-modal-atributo">Base: ${atributoNome} ${atributoBase}</div>
                <div class="pericia-modal-bonus">Bônus: +${bonus}</div>
                <div class="pericia-modal-nh">NH: ${nh}</div>
            `;
            periciasLista.appendChild(div);
        });
    }
    
    if (modalPM) modalPM.textContent = `${pmAtual}/${pmDisponivel}`;
    modalPericias.classList.add('active');
}

function abrirModalMagias() {
    if (!modalMagias) return;
    const magiasLista = document.getElementById('magiasLista');
    if (!magiasLista) return;
    
    if (!personagem || !personagem.escolas || !personagem.escolas.agua) {
        magiasLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma magia</div>';
        if (modalAptidao) modalAptidao.textContent = personagem?.vantagens?.includes('aptidaoMagica') ? '+1' : '0';
        modalMagias.classList.add('active');
        return;
    }
    
    magiasLista.innerHTML = '';
    
    const magias = personagem.escolas.agua.magias;
    const temAptidao = personagem.vantagens?.includes('aptidaoMagica');
    const iq = getValorAtributoReal('iq');
    const nhBase = iq + (temAptidao ? 1 : 0);
    
    if (modalAptidao) modalAptidao.textContent = temAptidao ? '+1' : '0';
    
    const magiasArray = Object.entries(magias).filter(([_, magia]) => magia.desbloqueada && magia.nivel > 0);
    
    if (magiasArray.length === 0) {
        magiasLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma magia desbloqueada</div>';
    } else {
        magiasArray.forEach(([id, magia]) => {
            let nome = '';
            switch(id) {
                case 'localizarAgua': nome = 'Localizar Água'; break;
                case 'purificarAgua': nome = 'Purificar Água'; break;
                case 'criarAgua': nome = 'Criar Água'; break;
                case 'dissiparAgua': nome = 'Dissipar Água'; break;
                case 'adagaDeGelo': nome = 'Adaga de Gelo'; break;
                case 'respirarNaAgua': nome = 'Respirar na Água'; break;
                case 'moldarAgua': nome = 'Moldar Água'; break;
                case 'nevoeiro': nome = 'Nevoeiro'; break;
                case 'armaCongelante': nome = 'Arma Congelante'; break;
                case 'cortinaDagua': nome = 'Cortina d\'Água'; break;
                case 'jatoDeAgua': nome = 'Jato d\'Água'; break;
                case 'ondaExpulsora': nome = 'Onda Expulsora'; break;
                case 'tempestadeDeGelo': nome = 'Tempestade de Gelo'; break;
                case 'congelamento': nome = 'Congelamento'; break;
                default: nome = id;
            }
            
            const tipo = magia.tipo || 'Desconhecido';
            const nivel = magia.nivel || 1;
            const efeito = `Nível ${nivel}`;
            
            const div = document.createElement('div');
            div.className = 'magia-item';
            div.innerHTML = `
                <div class="magia-header">
                    <span class="magia-nome">${nome}</span>
                    <span class="magia-nivel">Nível ${nivel}</span>
                </div>
                <div class="magia-tipo">${tipo}</div>
                <div class="magia-efeito">${efeito}</div>
                <div class="magia-nh-info">NH: ${nhBase}</div>
            `;
            magiasLista.appendChild(div);
        });
    }
    
    modalMagias.classList.add('active');
}

function abrirModalInventario() {
    if (!modalInventario) return;
    if (!personagem || !personagem.inventario) return;
    
    const equipado = document.getElementById('inventarioEquipado');
    const mochila = document.getElementById('inventarioMochila');
    const deposito = document.getElementById('inventarioDeposito');
    
    if (equipado) {
        equipado.innerHTML = '';
        if (personagem.inventario.corpo && personagem.inventario.corpo.length > 0) {
            personagem.inventario.corpo.forEach(item => {
                equipado.innerHTML += `
                    <div class="item-card">
                        <div class="nome">${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}</div>
                        <div class="detalhes">
                            <span>${item.peso || 0} kg</span>
                            <span>${item.preco || 0} $</span>
                        </div>
                        <div class="item-acoes">
                            <button class="item-acao" onclick="guardarItem('${item.id}')">Guardar</button>
                        </div>
                    </div>
                `;
            });
        } else {
            equipado.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Nada equipado</div>';
        }
    }
    
    if (mochila) {
        mochila.innerHTML = '';
        if (personagem.inventario.mochila && personagem.inventario.mochila.length > 0) {
            personagem.inventario.mochila.forEach(item => {
                mochila.innerHTML += `
                    <div class="item-card">
                        <div class="nome">${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}</div>
                        <div class="detalhes">
                            <span>${item.peso || 0} kg</span>
                            <span>${item.preco || 0} $</span>
                        </div>
                        <div class="item-acoes">
                            <button class="item-acao" onclick="equiparItem('${item.id}')">Equipar</button>
                            <button class="item-acao" onclick="moverParaDeposito('${item.id}')">Depósito</button>
                        </div>
                    </div>
                `;
            });
        } else {
            mochila.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Mochila vazia</div>';
        }
    }
    
    if (deposito) {
        deposito.innerHTML = '';
        if (personagem.inventario.deposito && personagem.inventario.deposito.length > 0) {
            personagem.inventario.deposito.forEach(item => {
                deposito.innerHTML += `
                    <div class="item-card">
                        <div class="nome">${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}</div>
                        <div class="detalhes">
                            <span>${item.peso || 0} kg</span>
                            <span>${item.preco || 0} $</span>
                        </div>
                        <div class="item-acoes">
                            <button class="item-acao" onclick="pegarItem('${item.id}')">Pegar</button>
                        </div>
                    </div>
                `;
            });
        } else {
            deposito.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Depósito vazio</div>';
        }
    }
    
    if (modalDinheiro) modalDinheiro.textContent = personagem.dinheiro || 0;
    
    let pesoTotal = 0;
    ['corpo', 'mochila'].forEach(local => {
        if (personagem.inventario[local]) {
            personagem.inventario[local].forEach(item => {
                pesoTotal += (item.peso || 0) * (item.quantidade || 1);
            });
        }
    });
    
    const st = getValorAtributo('st');
    const limiteCarga = st * 12;
    if (modalCarga) modalCarga.textContent = `${pesoTotal.toFixed(1)}/${limiteCarga} kg`;
    
    modalInventario.classList.add('active');
}

window.equiparItem = function(itemId) {
    if (!personagem?.inventario) return;
    
    const index = personagem.inventario.mochila.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.mochila[index];
        personagem.inventario.corpo.push(item);
        personagem.inventario.mochila.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

window.guardarItem = function(itemId) {
    if (!personagem?.inventario) return;
    
    const index = personagem.inventario.corpo.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.corpo[index];
        personagem.inventario.mochila.push(item);
        personagem.inventario.corpo.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

window.moverParaDeposito = function(itemId) {
    if (!personagem?.inventario) return;
    
    const index = personagem.inventario.mochila.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.mochila[index];
        personagem.inventario.deposito.push(item);
        personagem.inventario.mochila.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

window.pegarItem = function(itemId) {
    if (!personagem?.inventario) return;
    
    const index = personagem.inventario.deposito.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.deposito[index];
        personagem.inventario.mochila.push(item);
        personagem.inventario.deposito.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

function atualizarFichaPersonagem() {
    if (!personagem) return;
    
    if (headerNome) headerNome.textContent = personagem.nome || 'Aventureiro';
    
    const classes = {
        guerreiro: 'Guerreiro', mago: 'Mago', ladino: 'Ladino',
        clerigo: 'Clérigo', barbaro: 'Bárbaro'
    };
    if (headerClasse) headerClasse.textContent = classes[personagem.classe] || personagem.classe || '';
    
    if (personagem.fotoURL) {
        if (headerAvatar) headerAvatar.innerHTML = `<img src="${personagem.fotoURL}" alt="Avatar">`;
        if (fichaAvatar) fichaAvatar.innerHTML = `<img src="${personagem.fotoURL}" alt="Avatar">`;
    }
    
    pvMax = calcularPVMax();
    pvAtual = personagem.statusCombate?.vidaAtual || pvMax;
    if (headerPV) headerPV.textContent = `${pvAtual}/${pvMax}`;
    if (headerPVBarra) headerPVBarra.style.width = (pvAtual / pvMax * 100) + '%';
    
    fadigaMax = calcularFadigaMax();
    fadigaAtual = personagem.statusCombate?.fadigaAtual || fadigaMax;
    if (headerFadiga) headerFadiga.textContent = `${fadigaAtual}/${fadigaMax}`;
    if (headerFadigaBarra) headerFadigaBarra.style.width = (fadigaAtual / fadigaMax * 100) + '%';
    
    manaMax = calcularManaMax();
    manaAtual = personagem.statusCombate?.manaAtual || manaMax;
    if (headerMana) headerMana.textContent = `${manaAtual}/${manaMax}`;
    if (headerManaBarra) headerManaBarra.style.width = (manaAtual / manaMax * 100) + '%';
    
    const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
    const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
    const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
    const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
    const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
    
    const xpNecessario = (totalBolinhas + bolinhasDisponiveis + 1) * XP_POR_BOLINHA;
    
    if (headerXP) headerXP.textContent = `${xpAtual}/${xpNecessario}`;
    if (headerXPBarra) headerXPBarra.style.width = (xpAtual / xpNecessario * 100) + '%';
    
    pmDisponivel = personagem.pmDisponivel || 30;
    pmGasto = personagem.pmGasto || 0;
    pmAtual = pmDisponivel - pmGasto;
    if (pmValor) pmValor.textContent = pmAtual;
    
    if (fichaNome) fichaNome.textContent = personagem.nome || 'Aventureiro';
    if (fichaClasse) fichaClasse.textContent = classes[personagem.classe] || personagem.classe || '';
    
    const st = getValorAtributoReal('st');
    const dx = getValorAtributoReal('dx');
    const iq = getValorAtributoReal('iq');
    const ht = getValorAtributoReal('ht');
    
    const criarBolinhasHTML = (atrib, total) => {
        let html = '';
        for (let i = 0; i < 15; i++) {
            if (i < total) {
                html += '<div class="bolinha-pequena preenchida"></div>';
            } else {
                html += '<div class="bolinha-pequena"></div>';
            }
        }
        return html;
    };
    
    if (atributosContainer) {
        atributosContainer.innerHTML = `
            <div class="atributo-card ${bolinhasDisponiveis > 0 ? 'bolinha-disponivel' : ''}" data-atributo="st">
                <div class="atributo-info">
                    <span class="atributo-nome">ST</span>
                    <div class="atributo-bolinhas">${criarBolinhasHTML('st', personagem.atributos?.st?.bolinhas || 0)}</div>
                </div>
                <div>
                    <span class="atributo-valor">${st}</span>
                    <span class="atributo-base">(${personagem.atributos?.st?.base || 8}+${personagem.atributos?.st?.bolinhas || 0})</span>
                </div>
            </div>
            
            <div class="atributo-card ${bolinhasDisponiveis > 0 ? 'bolinha-disponivel' : ''}" data-atributo="dx">
                <div class="atributo-info">
                    <span class="atributo-nome">DX</span>
                    <div class="atributo-bolinhas">${criarBolinhasHTML('dx', personagem.atributos?.dx?.bolinhas || 0)}</div>
                </div>
                <div>
                    <span class="atributo-valor">${dx}</span>
                    <span class="atributo-base">(${personagem.atributos?.dx?.base || 5}+${personagem.atributos?.dx?.bolinhas || 0})</span>
                </div>
            </div>
            
            <div class="atributo-card ${bolinhasDisponiveis > 0 ? 'bolinha-disponivel' : ''}" data-atributo="iq">
                <div class="atributo-info">
                    <span class="atributo-nome">IQ</span>
                    <div class="atributo-bolinhas">${criarBolinhasHTML('iq', personagem.atributos?.iq?.bolinhas || 0)}</div>
                </div>
                <div>
                    <span class="atributo-valor">${iq}</span>
                    <span class="atributo-base">(${personagem.atributos?.iq?.base || 5}+${personagem.atributos?.iq?.bolinhas || 0})</span>
                </div>
            </div>
            
            <div class="atributo-card ${bolinhasDisponiveis > 0 ? 'bolinha-disponivel' : ''}" data-atributo="ht">
                <div class="atributo-info">
                    <span class="atributo-nome">HT</span>
                    <div class="atributo-bolinhas">${criarBolinhasHTML('ht', personagem.atributos?.ht?.bolinhas || 0)}</div>
                </div>
                <div>
                    <span class="atributo-valor">${ht}</span>
                    <span class="atributo-base">(${personagem.atributos?.ht?.base || 8}+${personagem.atributos?.ht?.bolinhas || 0})</span>
                </div>
            </div>
        `;
    }
    
    document.querySelectorAll('.atributo-card').forEach(card => {
        card.addEventListener('click', () => {
            if (bolinhasDisponiveis > 0) {
                const atributo = card.dataset.atributo;
                adicionarBolinha(atributo);
            }
        });
    });
    
    const esquiva = Math.floor((dx + ht) / 6) + 6;
    
    let aparar = 0;
    if (personagem.inventario?.corpo) {
        const temArma = personagem.inventario.corpo.some(item => item.dano);
        if (temArma) aparar = Math.floor((dx + dx) / 4) + 6;
    }
    
    let bloqueio = 0;
    if (personagem.inventario?.corpo) {
        const temEscudo = personagem.inventario.corpo.some(item => item.tipo === 'escudo' || item.nome?.toLowerCase().includes('escudo'));
        if (temEscudo) bloqueio = Math.floor((dx + dx) / 4) + 6 + 2;
    }
    
    if (defesasGrid) {
        defesasGrid.innerHTML = `
            <div class="defesa-card">
                <div class="defesa-valor">${esquiva}</div>
                <div class="defesa-label">Esquiva</div>
            </div>
            <div class="defesa-card">
                <div class="defesa-valor">${aparar}</div>
                <div class="defesa-label">Aparar</div>
            </div>
            <div class="defesa-card">
                <div class="defesa-valor">${bloqueio}</div>
                <div class="defesa-label">Bloqueio</div>
            </div>
        `;
    }
    
    if (contadorVantagensBtn) contadorVantagensBtn.textContent = personagem.vantagens?.length || 0;
    if (contadorDesvantagensBtn) contadorDesvantagensBtn.textContent = personagem.desvantagens?.length || 0;
    if (contadorPericiasBtn) contadorPericiasBtn.textContent = Object.keys(personagem.pericias || {}).length;
    
    let magiasCount = 0;
    if (personagem.escolas?.agua?.magias) {
        magiasCount = Object.values(personagem.escolas.agua.magias).filter(m => m.desbloqueada && m.nivel > 0).length;
    }
    if (contadorMagiasBtn) contadorMagiasBtn.textContent = magiasCount;
    
    atualizarInterfaceBolinhas();
    atualizarNivelNaTela();
    
    window.personagem = personagem;
}

function carregarCena(cenaId) {
    if (!cenaId) return;
    
    if (typeof cenaId === 'string') {
        const cena = historia.cenas[cenaId];
        if (!cena) {
            return;
        }
        capituloAtual = cena;
    } else {
        capituloAtual = cenaId;
    }
    
    if (!capituloAtual) return;
    
    if (capituloAtual.renderizar && typeof capituloAtual.renderizar === 'function') {
        
        if (capituloAtual.imagem && cenarioArea) {
            cenarioArea.style.backgroundImage = `url('${capituloAtual.imagem}')`;
        }
        
        if (npcsContainer) npcsContainer.innerHTML = '';
        
        capituloAtual.renderizar();
        
        if (cenaId === 'encontro_camponesa') {
            setAto(4, 'A Floresta - Encontro com Elara');
        }
        
        return;
    }
    
    if (cenaId === 'exterior_taverna' || cenaId === 'interior_taverna') {
        setAto(1, 'A Taverna');
    } else if (cenaId === 'interior_taverna_com_homem' || cenaId === 'homem_fala_detalhes') {
        setAto(2, 'O Homem Ferido');
    } else if (cenaId === 'sair_para_aventura') {
        setAto(3, 'A Missão');
    } else if (cenaId === 'encontro_camponesa' || cenaId === 'carroca_destruida' || cenaId === 'clareira_goblins') {
        setAto(4, 'A Floresta');
    } else if (cenaId === 'entrada_caverna' || cenaId === 'camara_chefe') {
        setAto(5, 'A Caverna');
    } else if (cenaId === 'final_vitoria' || cenaId === 'final_taverna') {
        setAto(6, 'O Retorno');
    }
    
    if (capituloAtual.imagem && cenarioArea) {
        cenarioArea.style.backgroundImage = `url('${capituloAtual.imagem}')`;
    } else if (cenarioArea) {
        cenarioArea.style.backgroundImage = 'none';
    }
    
    if (npcsContainer) npcsContainer.innerHTML = '';
    if (capituloAtual.npcs && npcsContainer) {
        capituloAtual.npcs.forEach(npc => {
            if (npc.visivel === false) return;
            
            const npcDiv = document.createElement('div');
            npcDiv.className = 'npc-sprite';
            
            if (npc.id === 'taverneiro') {
                npcDiv.style.left = '85%';
                npcDiv.style.top = '60%';
            } else if (npc.id === 'homem_sangue') {
                npcDiv.style.left = '25%';
                npcDiv.style.top = '50%';
            } else {
                npcDiv.style.left = (npc.x || 50) + '%';
                npcDiv.style.top = (npc.y || 50) + '%';
            }
            
            npcDiv.dataset.npcId = npc.id;
            
            npcDiv.innerHTML = `
                <img src="${npc.sprite || 'default.png'}" alt="${npc.nome}">
                <div class="npc-nome">${npc.nome}</div>
            `;
            
            npcDiv.addEventListener('click', () => {
                falarComNPC(npc);
            });
            
            npcsContainer.appendChild(npcDiv);
        });
    }
    
    if (capituloAtual.fala) {
        if (npcNome) npcNome.textContent = capituloAtual.fala.npc || 'Narrador';
        if (capituloAtual.fala.avatar && npcAvatar) {
            npcAvatar.src = capituloAtual.fala.avatar;
            npcAvatar.style.display = 'inline';
        } else if (npcAvatar) {
            npcAvatar.style.display = 'none';
        }
        if (dialogoTexto) dialogoTexto.textContent = capituloAtual.fala.texto;
    } else if (dialogoTexto) {
        dialogoTexto.textContent = '...';
    }
    
    renderizarOpcoes(capituloAtual.opcoes);
    
    if (cenaId === 'interior_taverna') {
        iniciarTimerHomem();
    }
}

function renderizarOpcoes(opcoes) {
    if (!opcoesDialogo) return;
    opcoesDialogo.innerHTML = '';
    
    if (!opcoes || opcoes.length === 0) {
        const btnSair = document.createElement('button');
        btnSair.className = 'opcao-btn';
        btnSair.textContent = 'Sair da taverna';
        btnSair.addEventListener('click', () => {
            carregarCena('exterior_taverna');
        });
        opcoesDialogo.appendChild(btnSair);
        return;
    }
    
    opcoes.forEach(opcao => {
        const btn = document.createElement('button');
        btn.className = 'opcao-btn';
        btn.textContent = opcao.texto;
        
        btn.addEventListener('click', () => {
            if (opcao.proximo) {
                carregarCena(opcao.proximo);
            } else if (opcao.acao === 'iniciar_combate') {
                iniciarCombate(opcao.inimigos || []);
            } else if (opcao.resposta) {
                if (dialogoTexto) dialogoTexto.textContent = opcao.resposta;
            } else if (opcao.tipo === 'pagar') {
                if (personagem && personagem.dinheiro >= opcao.valor) {
                    personagem.dinheiro -= opcao.valor;
                    if (dialogoTexto) dialogoTexto.textContent = opcao.sucesso || 'Negócio feito!';
                    adicionarLog(`💰 Pagou ${opcao.valor} moedas`, 'sucesso');
                    atualizarFichaPersonagem();
                } else {
                    if (dialogoTexto) dialogoTexto.textContent = opcao.falha || 'Você não tem dinheiro suficiente!';
                }
            } else if (opcao.item) {
                if (!personagem.inventario.mochila) personagem.inventario.mochila = [];
                personagem.inventario.mochila.push({
                    id: opcao.item.id,
                    nome: opcao.item.nome,
                    descricao: opcao.item.descricao,
                    peso: opcao.item.peso || 0.1,
                    quantidade: 1
                });
                adicionarLog(`📦 Você pegou: ${opcao.item.nome}`, 'sucesso');
                if (dialogoTexto) dialogoTexto.textContent = opcao.resposta || `Você pegou ${opcao.item.nome}.`;
            } else if (opcao.acao === 'finalizar_aventura') {
                adicionarLog('🎉 Aventura concluída! Parabéns!', 'sucesso');
                setTimeout(() => {
                    window.location.href = 'aventura-solo.html';
                }, 5000);
            }
            
            atualizarFichaPersonagem();
        });
        
        opcoesDialogo.appendChild(btn);
    });
}

function falarComNPC(npc) {
    if (npcNome) npcNome.textContent = npc.nome;
    if (npc.avatar && npcAvatar) {
        npcAvatar.src = npc.avatar;
        npcAvatar.style.display = 'inline';
    }
    if (dialogoTexto) dialogoTexto.textContent = npc.dialogo || '...';
    
    if (npc.opcoes) {
        renderizarOpcoes(npc.opcoes);
    } else {
        renderizarOpcoes([
            {
                texto: 'Sair da taverna',
                proximo: 'exterior_taverna'
            }
        ]);
    }
}

function iniciarTimerHomem() {
    if (timerHomem) {
        clearTimeout(timerHomem);
    }
    
    adicionarLog('⏳ Você pede uma cerveja e observa o ambiente...', 'info');
    
    timerHomem = setTimeout(() => {
        adicionarLog('🚪 A porta se abre violentamente! Um homem ensanguentado entra cambaleando!', 'dano');
        carregarCena('interior_taverna_com_homem');
    }, 30000);
}

// ============================================
// FUNÇÃO DE COMBATE CORRIGIDA
// ============================================
function iniciarCombate(inimigosData, emboscada = false) {
    console.log('🎯 Iniciando combate com:', inimigosData);
    
    // Verificar se há inimigos
    if (!inimigosData || inimigosData.length === 0) {
        adicionarLog('❌ Erro: Nenhum inimigo encontrado!', 'erro');
        return;
    }
    
    // Preparar inimigos
    window.inimigos = [];
    
    if (Array.isArray(inimigosData)) {
        inimigosData.forEach(inim => {
            // Se for um ID e temos dados na cena atual
            if (typeof inim === 'string' && capituloAtual && capituloAtual.inimigos) {
                const inimigoData = capituloAtual.inimigos.find(i => i.id === inim);
                if (inimigoData) {
                    window.inimigos.push({
                        ...inimigoData,
                        pv: inimigoData.pv_max || inimigoData.pv || 20,
                        pv_max: inimigoData.pv_max || inimigoData.pv || 20,
                        pv_atual: inimigoData.pv_max || inimigoData.pv || 20
                    });
                }
            } 
            // Se for um objeto com dados completos
            else if (typeof inim === 'object') {
                window.inimigos.push({
                    id: inim.id || `inimigo_${Date.now()}`,
                    nome: inim.nome || 'Inimigo',
                    pv: inim.pv_max || inim.pv || 20,
                    pv_max: inim.pv_max || inim.pv || 20,
                    pv_atual: inim.pv_max || inim.pv || 20,
                    defesa: inim.defesa || 8,
                    dx: inim.dx || 10,
                    nh_ataque: inim.nh_ataque || 10,
                    dano: inim.dano || "1d6",
                    xp: inim.xp || 25
                });
            }
        });
    }
    
    // Verificar se temos inimigos
    if (window.inimigos.length === 0) {
        adicionarLog('❌ Erro: Não foi possível preparar os inimigos!', 'erro');
        return;
    }

    // USAR SISTEMA DE COMBATE
    try {
        const iniciativa = SistemaCombate.calcularIniciativa(
            window.personagem,
            window.inimigos,
            emboscada ? 'pc' : null
        );
        
        adicionarLog(iniciativa.texto, 'info');
        adicionarLog(`🎲 Sua iniciativa: ${iniciativa.pc} | Inimigos: ${iniciativa.inimigos.toFixed(1)}`, 'info');
        
        window.turnoAtual = iniciativa.quemComeca;
        
        // Iniciar no sistema de combate
        SistemaCombate.turno.iniciarCombate(iniciativa.quemComeca);
        
        // Mostrar interface de combate
        if (inimigosContainer) inimigosContainer.style.display = 'block';
        renderizarInimigos();
        
        if (window.turnoAtual === 'pc') {
            turnoIndicator.className = 'turno-indicator jogador';
            turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
            if (btnAtacar) btnAtacar.disabled = false;
            if (btnMagia) btnMagia.disabled = false;
        } else {
            turnoIndicator.className = 'turno-indicator inimigo';
            turnoIndicator.innerHTML = '<i class="fas fa-skull"></i> TURNO DOS INIMIGOS';
            if (btnAtacar) btnAtacar.disabled = true;
            if (btnMagia) btnMagia.disabled = true;
            setTimeout(() => processarTurnoInimigos(), 1500);
        }
        
        adicionarLog('⚔️ COMBATE INICIADO!', 'sucesso');
        
    } catch (error) {
        console.error('Erro no combate:', error);
        adicionarLog('❌ Erro ao iniciar combate: ' + error.message, 'erro');
    }
}

function renderizarInimigos() {
    if (!inimigosLista) return;
    
    inimigosLista.innerHTML = '';
    
    if (!window.inimigos || window.inimigos.length === 0) {
        if (inimigosContainer) inimigosContainer.style.display = 'none';
        return;
    }
    
    window.inimigos.forEach((inimigo, index) => {
        const pvPercent = (inimigo.pv_atual / inimigo.pv_max) * 100;
        
        const div = document.createElement('div');
        div.className = `inimigo-mini ${inimigoSelecionado === index ? 'selecionado' : ''}`;
        div.dataset.index = index;
        
        div.innerHTML = `
            <div class="inimigo-mini-nome">${inimigo.nome}</div>
            <div class="inimigo-mini-pv">
                <div class="inimigo-mini-pv-fill" style="width: ${pvPercent}%"></div>
            </div>
            <div style="font-size:0.7rem; color:#ff6b6b;">PV: ${inimigo.pv_atual}/${inimigo.pv_max}</div>
        `;
        
        div.addEventListener('click', () => {
            document.querySelectorAll('.inimigo-mini').forEach(el => el.classList.remove('selecionado'));
            div.classList.add('selecionado');
            inimigoSelecionado = index;
        });
        
        inimigosLista.appendChild(div);
    });
}

function getArmasEquipadas() {
    if (!personagem?.inventario?.corpo) return [];
    
    return personagem.inventario.corpo.filter(item => item.dano).map(item => ({
        id: item.id,
        nome: item.nome,
        dano: item.dano,
        tipoDano: item.tipoDano || 'Contusão',
        alcance: item.alcance || 1,
        st: item.st || 8
    }));
}

function abrirModalAtaque() {
    if (!modalAtaque) return;
    if (inimigoSelecionado === null) {
        adicionarLog('❌ Selecione um inimigo primeiro!', 'erro');
        return;
    }
    
    const armas = getArmasEquipadas();
    
    if (armas.length === 0) {
        adicionarLog('❌ Você não tem armas equipadas!', 'erro');
        return;
    }
    
    armaSelecionada = null;
    if (btnConfirmarAtaque) btnConfirmarAtaque.disabled = true;
    
    if (armasLista) {
        armasLista.innerHTML = armas.map((arma, index) => `
            <div class="arma-card" data-index="${index}">
                <div class="arma-nome">${arma.nome}</div>
                <div class="arma-detalhes">
                    <span><i class="fas fa-tint"></i> Dano: ${arma.dano}</span>
                    <span><i class="fas fa-shield-alt"></i> Tipo: ${arma.tipoDano}</span>
                </div>
            </div>
        `).join('');
    }
    
    document.querySelectorAll('.arma-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.arma-card').forEach(c => c.classList.remove('selecionada'));
            card.classList.add('selecionada');
            armaSelecionada = parseInt(card.dataset.index);
            if (btnConfirmarAtaque) btnConfirmarAtaque.disabled = false;
        });
    });
    
    modalAtaque.classList.add('active');
}

function executarAtaque() {
    if (armaSelecionada === null) {
        adicionarLog('❌ Selecione uma arma!', 'erro');
        return;
    }
    
    if (inimigoSelecionado === null) {
        adicionarLog('❌ Selecione um inimigo!', 'erro');
        if (modalAtaque) modalAtaque.classList.remove('active');
        return;
    }
    
    const armas = getArmasEquipadas();
    const arma = armas[armaSelecionada];
    const inimigo = window.inimigos[inimigoSelecionado];
    
    if (!arma || !inimigo) {
        adicionarLog('❌ Erro no ataque!', 'erro');
        if (modalAtaque) modalAtaque.classList.remove('active');
        return;
    }
    
    if (modalAtaque) modalAtaque.classList.remove('active');
    
    // USAR SISTEMA DE COMBATE para atacar
    try {
        const resultado = SistemaCombate.atacar(window.personagem, inimigo, arma);
        
        adicionarLog(`⚔️ Ataque contra ${inimigo.nome}:`, 'info');
        adicionarLog(resultado.texto, resultado.acertou ? 'sucesso' : 'erro');
        
        if (resultado.acertou) {
            inimigo.pv_atual = Math.max(0, inimigo.pv_atual - resultado.dano);
            adicionarLog(`💥 Dano: ${resultado.dano}`, 'dano');
            
            if (inimigo.pv_atual <= 0) {
                adicionarLog(`💀 ${inimigo.nome} foi derrotado!`, 'sucesso');
                
                const xpGanho = inimigo.xp || 25;
                xpAtual += xpGanho;
                personagem.xp = xpAtual;
                adicionarLog(`✨ Ganhou ${xpGanho} XP!`, 'sucesso');
                verificarGanhoBolinha();
                
                window.inimigos = window.inimigos.filter((_, i) => i !== inimigoSelecionado);
                inimigoSelecionado = null;
                
                if (window.inimigos.length === 0) {
                    adicionarLog('🎉 VITÓRIA!', 'sucesso');
                    if (inimigosContainer) inimigosContainer.style.display = 'none';
                    
                    // Ir para próxima cena
                    if (capituloAtual && capituloAtual.id === 'clareira_goblins') {
                        setTimeout(() => carregarCena('entrada_caverna'), 2000);
                    } else if (capituloAtual && capituloAtual.id === 'camara_chefe') {
                        setTimeout(() => carregarCena('final_vitoria'), 2000);
                    } else if (capituloAtual && capituloAtual.ao_vencer) {
                        setTimeout(() => carregarCena(capituloAtual.ao_vencer), 2000);
                    }
                    
                    salvarProgresso();
                    return;
                }
            }
            
            renderizarInimigos();
            atualizarFichaPersonagem();
            
            // Verificar perda de defesa por falha crítica
            if (resultado.falhaCritica) {
                SistemaCombate.turno.perderDefesa();
            }
            
            // Passar turno
            passarTurno();
        } else {
            // Passar turno mesmo errando
            passarTurno();
        }
        
        salvarProgresso();
    } catch (error) {
        console.error('Erro no ataque:', error);
        adicionarLog('❌ Erro ao executar ataque', 'erro');
    }
}

function passarTurno() {
    if (window.turnoAtual === 'pc') {
        window.turnoAtual = 'inimigos';
        
        // Passar turno no sistema de combate
        try {
            const resultadoTurno = SistemaCombate.turno.passarTurno(window.personagem);
            
            if (resultadoTurno.fadiga.perdeuFadiga) {
                adicionarLog(resultadoTurno.fadiga.texto, 'info');
                atualizarFichaPersonagem();
            }
        } catch (error) {
            console.error('Erro ao passar turno:', error);
        }
        
        turnoIndicator.className = 'turno-indicator inimigo';
        turnoIndicator.innerHTML = '<i class="fas fa-skull"></i> TURNO DOS INIMIGOS';
        
        if (btnAtacar) btnAtacar.disabled = true;
        if (btnMagia) btnMagia.disabled = true;
        
        setTimeout(processarTurnoInimigos, 1000);
    }
}

function processarTurnoInimigos() {
    if (!window.inimigos || window.inimigos.length === 0) {
        window.turnoAtual = 'pc';
        turnoIndicator.className = 'turno-indicator jogador';
        turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
        if (btnAtacar) btnAtacar.disabled = false;
        if (btnMagia) btnMagia.disabled = false;
        return;
    }
    
    adicionarLog(`👾 Turno dos inimigos!`, 'dano');
    
    let ataqueRealizado = false;
    
    window.inimigos.forEach(inimigo => {
        // Usar sistema de combate para rolar ataque do inimigo
        try {
            const rolagem = SistemaCombate.rolar2d10();
            const nhAtaque = inimigo.nh_ataque || 10;
            
            adicionarLog(`🎲 ${inimigo.nome} ataca: ${rolagem.texto} (NH ${nhAtaque})`, 'info');
            
            if (rolagem.total <= nhAtaque) {
                // Calcular dano
                let dano = 0;
                if (inimigo.dano) {
                    dano = SistemaCombate.rolarDados(inimigo.dano);
                } else {
                    dano = Math.floor(Math.random() * 6) + 1;
                }
                
                dano = Math.max(1, dano);
                
                // Tentar defesa do personagem
                try {
                    const defesaResultado = SistemaCombate.defender(
                        window.personagem,
                        'esquiva',
                        { dano: dano },
                        SistemaCombate.turno.estadoDefesa
                    );
                    
                    if (defesaResultado.sucesso) {
                        adicionarLog(`🛡️ ${defesaResultado.texto}`, 'sucesso');
                        dano = 0;
                    } else {
                        dano = defesaResultado.danoFinal;
                        adicionarLog(defesaResultado.texto, 'dano');
                    }
                } catch (error) {
                    console.error('Erro na defesa:', error);
                }
                
                if (dano > 0) {
                    pvAtual = Math.max(0, pvAtual - dano);
                    if (personagem?.statusCombate) personagem.statusCombate.vidaAtual = pvAtual;
                    
                    adicionarLog(`💥 ${inimigo.nome} causou ${dano} de dano!`, 'dano');
                    atualizarFichaPersonagem();
                    ataqueRealizado = true;
                    
                    if (pvAtual <= 0) {
                        adicionarLog(`💀 VOCÊ MORREU!`, 'erro');
                        if (btnAtacar) btnAtacar.disabled = true;
                        if (btnMagia) btnMagia.disabled = true;
                        return;
                    }
                }
            } else {
                adicionarLog(`✅ ${inimigo.nome} errou!`, 'sucesso');
            }
        } catch (error) {
            console.error('Erro no ataque do inimigo:', error);
        }
    });
    
    // Passar turno para o jogador
    setTimeout(() => {
        window.turnoAtual = 'pc';
        
        // Passar turno no sistema de combate
        try {
            const resultadoTurno = SistemaCombate.turno.passarTurno(window.personagem);
            
            if (resultadoTurno.fadiga.perdeuFadiga) {
                adicionarLog(resultadoTurno.fadiga.texto, 'info');
                atualizarFichaPersonagem();
            }
        } catch (error) {
            console.error('Erro ao passar turno:', error);
        }
        
        turnoIndicator.className = 'turno-indicator jogador';
        turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
        if (btnAtacar) btnAtacar.disabled = false;
        if (btnMagia) btnMagia.disabled = false;
        
        if (ataqueRealizado) {
            adicionarLog(`🛡️ Sua vez de agir!`, 'info');
        }
        
        salvarProgresso();
    }, 1000);
}

function descansar() {
    pvAtual = Math.min(pvAtual + 5, pvMax);
    manaAtual = Math.min(manaAtual + 3, manaMax);
    fadigaAtual = Math.min(fadigaAtual + 2, fadigaMax);
    
    if (personagem && personagem.statusCombate) {
        personagem.statusCombate = {
            vidaAtual: pvAtual,
            vidaMax: pvMax,
            fadigaAtual: fadigaAtual,
            fadigaMax: fadigaMax,
            manaAtual: manaAtual,
            manaMax: manaMax
        };
    }
    
    atualizarFichaPersonagem();
    salvarProgresso();
    adicionarLog('💤 Você descansou e recuperou energia.', 'sucesso');
}

async function salvarProgresso() {
    if (!personagem || !sessaoId) return;
    
    try {
        if (personagem && personagem.statusCombate) {
            personagem.statusCombate = {
                vidaAtual: pvAtual,
                vidaMax: pvMax,
                fadigaAtual: fadigaAtual,
                fadigaMax: fadigaMax,
                manaAtual: manaAtual,
                manaMax: manaMax
            };
        }
        personagem.xp = xpAtual;
        
        const personagemRef = doc(db, "personagens", personagem.id);
        await updateDoc(personagemRef, {
            statusCombate: personagem.statusCombate,
            xp: xpAtual,
            atributos: personagem.atributos,
            pmGasto: pmGasto
        });
        
    } catch (error) {
        adicionarLog('❌ Erro ao salvar progresso', 'erro');
    }
}

async function carregarPersonagem(personagemId) {
    try {
        const personagemRef = doc(db, "personagens", personagemId);
        const personagemSnap = await getDoc(personagemRef);
        
        if (!personagemSnap.exists()) {
            throw new Error('Personagem não encontrado');
        }
        
        personagem = {
            id: personagemSnap.id,
            ...personagemSnap.data()
        };
        
        if (!personagem.inventario) {
            personagem.inventario = {
                corpo: [],
                mochila: [],
                deposito: []
            };
        }
        
        if (!personagem.atributos) {
            personagem.atributos = {
                st: { bolinhas: 0, valor: 9, base: 9 },
                dx: { bolinhas: 0, valor: 5, base: 5 },
                iq: { bolinhas: 0, valor: 5, base: 5 },
                ht: { bolinhas: 0, valor: 8, base: 8 }
            };
        } else {
            ['st', 'dx', 'iq', 'ht'].forEach(attr => {
                if (!personagem.atributos[attr]) {
                    const bases = { st: 9, dx: 5, iq: 5, ht: 8 };
                    personagem.atributos[attr] = { bolinhas: 0, valor: bases[attr], base: bases[attr] };
                } else {
                    if (!personagem.atributos[attr].base) {
                        const bases = { st: 9, dx: 5, iq: 5, ht: 8 };
                        personagem.atributos[attr].base = bases[attr];
                    }
                    if (!personagem.atributos[attr].valor) {
                        personagem.atributos[attr].valor = personagem.atributos[attr].base + (personagem.atributos[attr].bolinhas || 0);
                    }
                }
            });
        }
        
        if (!personagem.statusCombate) {
            personagem.statusCombate = {};
        }
        
        if (!personagem.vantagens) personagem.vantagens = [];
        if (!personagem.desvantagens) personagem.desvantagens = [];
        if (!personagem.pericias) personagem.pericias = {};
        if (!personagem.escolas) personagem.escolas = { agua: { magias: {} } };
        if (!personagem.pmDisponivel) personagem.pmDisponivel = 30;
        if (!personagem.pmGasto) personagem.pmGasto = 0;
        
        pvMax = calcularPVMax();
        pvAtual = personagem.statusCombate?.vidaAtual || pvMax;
        
        fadigaMax = calcularFadigaMax();
        fadigaAtual = personagem.statusCombate?.fadigaAtual || fadigaMax;
        
        manaMax = calcularManaMax();
        manaAtual = personagem.statusCombate?.manaAtual || manaMax;
        
        xpAtual = personagem.xp || 0;
        
        const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
        const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
        const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
        const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
        const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
        
        bolinhasDisponiveis = 0;
        let xpTemp = xpAtual;
        
        while (xpTemp >= XP_POR_BOLINHA) {
            bolinhasDisponiveis++;
            xpTemp -= XP_POR_BOLINHA;
        }
        
        atualizarFichaPersonagem();
        atualizarNivelNaTela();
        
        window.personagem = personagem;
        window.SistemaSocial = SistemaSocial;
        window.carregarCena = carregarCena;
        window.adicionarLog = adicionarLog;
        
    } catch (error) {
        if (dialogoTexto) dialogoTexto.textContent = '❌ Erro ao carregar personagem!';
        adicionarLog('❌ Erro ao carregar personagem!', 'erro');
    }
}

async function carregarAventura(aventuraId) {
    try {
        if (window.AVENTURA) {
            historia = window.AVENTURA;
        } else {
            let tentativas = 0;
            while (!window.AVENTURA && tentativas < 30) {
                await new Promise(r => setTimeout(r, 100));
                tentativas++;
            }
            
            if (window.AVENTURA) {
                historia = window.AVENTURA;
            } else {
                throw new Error(`Aventura "${aventuraId}" não encontrada.`);
            }
        }
        
        const cenaInicialId = historia.cenaInicial;
        
        if (!cenaInicialId) {
            throw new Error('Cena inicial não definida');
        }
        
        carregarCena(cenaInicialId);
        adicionarLog(`📖 ${historia.nome} iniciada!`, 'sucesso');
        
    } catch (error) {
        if (dialogoTexto) dialogoTexto.textContent = `ERRO: ${error.message}`;
        
        if (opcoesDialogo) {
            opcoesDialogo.innerHTML = '';
            const btnVoltar = document.createElement('button');
            btnVoltar.className = 'opcao-btn';
            btnVoltar.textContent = 'Voltar à seleção';
            btnVoltar.addEventListener('click', () => {
                window.location.href = 'aventura-solo.html';
            });
            opcoesDialogo.appendChild(btnVoltar);
        }
    }
}

async function criarSessao() {
    const urlParams = new URLSearchParams(window.location.search);
    const aventuraId = urlParams.get('aventura');
    const personagemId = urlParams.get('personagem');
    
    if (!aventuraId || !personagemId) {
        alert('Aventura ou personagem não selecionado!');
        window.location.href = 'aventura-solo.html';
        return;
    }
    
    showLoading();
    
    try {
        await carregarPersonagem(personagemId);
        await carregarAventura(aventuraId);
        
        const sessaoRef = doc(collection(db, "sessoes_aventura"));
        sessaoId = sessaoRef.id;
        
        await setDoc(sessaoRef, {
            id: sessaoId,
            userId: currentUser.uid,
            personagem_id: personagemId,
            aventura_id: aventuraId,
            pc_atual: personagem,
            cena_atual: historia?.cenaInicial || '',
            data_inicio: new Date().toISOString(),
            ultima_sessao: new Date().toISOString(),
            status: "em_andamento"
        });
        
    } catch (error) {
        adicionarLog('❌ Erro ao iniciar sessão', 'erro');
        if (dialogoTexto) dialogoTexto.textContent = '❌ Erro ao iniciar sessão.';
    } finally {
        hideLoading();
    }
}

// ============================================
// EVENT LISTENERS
// ============================================
onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        await criarSessao();
    } else {
        window.location.href = 'index.html';
    }
});

if (btnAtacar) btnAtacar.addEventListener('click', abrirModalAtaque);
if (btnMagia) btnMagia.addEventListener('click', () => adicionarLog('🔮 Sistema de magias em desenvolvimento', 'info'));
if (btnInventario) btnInventario.addEventListener('click', abrirModalInventario);
if (btnDescansar) btnDescansar.addEventListener('click', descansar);

if (btnVerVantagens) btnVerVantagens.addEventListener('click', abrirModalVantagens);
if (btnVerDesvantagens) btnVerDesvantagens.addEventListener('click', abrirModalDesvantagens);
if (btnVerPericias) btnVerPericias.addEventListener('click', abrirModalPericias);
if (btnVerMagias) btnVerMagias.addEventListener('click', abrirModalMagias);

if (cancelarEscolhaAtributo) cancelarEscolhaAtributo.addEventListener('click', () => {
    if (modalEscolhaAtributo) modalEscolhaAtributo.classList.remove('active');
});

if (fecharModalInventario) fecharModalInventario.addEventListener('click', () => {
    if (modalInventario) modalInventario.classList.remove('active');
});

if (fecharModalVantagens) fecharModalVantagens.addEventListener('click', () => {
    if (modalVantagens) modalVantagens.classList.remove('active');
});

if (fecharModalDesvantagens) fecharModalDesvantagens.addEventListener('click', () => {
    if (modalDesvantagens) modalDesvantagens.classList.remove('active');
});

if (fecharModalPericias) fecharModalPericias.addEventListener('click', () => {
    if (modalPericias) modalPericias.classList.remove('active');
});

if (fecharModalMagias) fecharModalMagias.addEventListener('click', () => {
    if (modalMagias) modalMagias.classList.remove('active');
});

if (btnCancelarAtaque) btnCancelarAtaque.addEventListener('click', () => {
    if (modalAtaque) modalAtaque.classList.remove('active');
});

if (btnConfirmarAtaque) btnConfirmarAtaque.addEventListener('click', executarAtaque);

if (btnCancelarDefesa) btnCancelarDefesa.addEventListener('click', () => {
    if (modalDefesa) modalDefesa.classList.remove('active');
});

if (btnAbrirDados) btnAbrirDados.addEventListener('click', () => {
    if (modalDados) modalDados.classList.add('active');
});

if (btnFecharDados) btnFecharDados.addEventListener('click', () => {
    if (modalDados) modalDados.classList.remove('active');
});

if (btnRolarDados) btnRolarDados.addEventListener('click', () => {
    const qtd = parseInt(dadosQtd?.value) || 1;
    const faces = parseInt(dadosFaces?.value) || 10;
    const mod = parseInt(dadosMod?.value) || 0;
    
    const resultado = rolarDados(qtd, faces, mod);
    if (dadosResultado) dadosResultado.textContent = resultado.texto;
    adicionarLog(`🎲 Rolagem: ${resultado.texto}`, 'info');
});

document.querySelectorAll('.atributo-opcao').forEach(opcao => {
    opcao.addEventListener('click', () => {
        const atributo = opcao.dataset.atributo;
        adicionarBolinha(atributo);
    });
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (modalEscolhaAtributo) modalEscolhaAtributo.classList.remove('active');
        if (modalInventario) modalInventario.classList.remove('active');
        if (modalVantagens) modalVantagens.classList.remove('active');
        if (modalDesvantagens) modalDesvantagens.classList.remove('active');
        if (modalPericias) modalPericias.classList.remove('active');
        if (modalMagias) modalMagias.classList.remove('active');
        if (modalAtaque) modalAtaque.classList.remove('active');
        if (modalDefesa) modalDefesa.classList.remove('active');
        if (modalDados) modalDados.classList.remove('active');
    }
});

setInterval(() => {
    if (personagem && sessaoId) {
        salvarProgresso();
    }
}, 30000);

window.personagem = personagem;
window.SistemaSocial = SistemaSocial;
window.carregarCena = carregarCena;
window.adicionarLog = adicionarLog;
</script>

<script>
window.AVENTURA = {
    nome: "A Menina Elfa Raptada",
    descricao: "Uma aventura clássica começando em uma taverna.",
    cenaInicial: "exterior_taverna",
    
    cenas: {
        exterior_taverna: {
            id: "exterior_taverna", nome: "Entrada da Taverna", imagem: "taverna-exterior.jpg",
            fala: { npc: "Narrador", texto: "Você chega a uma taverna aconchegante. O letreiro range com o vento: 'A Javali Sangrento'. Risadas e música saem pelas frestas da porta." },
            npcs: [], opcoes: [{ texto: "Entrar na taverna", proximo: "interior_taverna" }]
        },
        
        interior_taverna: {
            id: "interior_taverna", nome: "Taverna A Javali Sangrento", imagem: "taverna-interior.jpg",
            fala: { npc: "Narrador", texto: "O calor da lareira e o cheiro de carne assada te recebem. A taverna está movimentada. Você encontra um lugar no balcão e o taverneiro se aproxima." },
            npcs: [{
                id: "taverneiro", nome: "Taverneiro", sprite: "taverneiro.png",
                dialogo: "Bem-vindo, viajante! Quer uma cerveja gelada? Só 2 moedas.",
                opcoes: [
                    { texto: "🍺 Comprar cerveja (2 moedas)", tipo: "pagar", valor: 2, sucesso: "Saúde!", falha: "Sem dinheiro..." },
                    { texto: "📰 Perguntar sobre novidades", resposta: "Problemas na estrada norte. Goblins atacando viajantes." },
                    { texto: "👀 Observar o ambiente", resposta: "Você pede uma cerveja e observa o movimento..." }
                ]
            }], opcoes: []
        },
        
        interior_taverna_com_homem: {
            id: "interior_taverna_com_homem", nome: "Taverna - O Ferido Chega", imagem: "taverna-interior.jpg",
            fala: { npc: "Narrador", texto: "Enquanto você bebe, a porta se abre! Um homem ensanguentado entra cambaleando." },
            npcs: [
                { id: "taverneiro", nome: "Taverneiro", sprite: "taverneiro.png", dialogo: "Pelos deuses!" },
                { id: "homem_sangue", nome: "Homem Ferido", sprite: "npc-sangue.png", dialogo: "Socorro... minha filha... os goblins levaram ela!",
                  opcoes: [{ texto: "Falar com o homem", proximo: "homem_fala_detalhes" }] }
            ], opcoes: [{ texto: "Sair da taverna", proximo: "exterior_taverna" }]
        },
        
        homem_fala_detalhes: {
            id: "homem_fala_detalhes", nome: "O Desespero de um Pai", imagem: "taverna-interior.jpg",
            fala: { npc: "Homem Ferido", texto: "Minha filha Lyra, 10 anos, cabelos prateados... Os goblins levaram ela para a floresta!" },
            npcs: [{
                id: "homem_sangue", nome: "Eldrin", sprite: "npc-sangue.jpg",
                dialogo: "Por favor, aventureiro!",
                opcoes: [{ texto: "✅ ACEITAR MISSÃO", proximo: "sair_para_aventura" }]
            }], opcoes: []
        },
        
        sair_para_aventura: {
            id: "sair_para_aventura", nome: "Missão Aceita", imagem: "taverna-exterior.jpg",
            fala: { npc: "Narrador", texto: "Você sai da taverna com determinação. A estrada norte se estende diante de você." },
            npcs: [], opcoes: [{ texto: "Seguir para a estrada norte", proximo: "encontro_camponesa" }]
        },
        
        encontro_camponesa: {
            id: "encontro_camponesa", nome: "Estrada Norte - Encontro com a Camponesa", imagem: "estrada-norte.jpg",
            npcs: [{ id: "camponesa", nome: "Elara", sprite: "camponesa.png", x: 50, y: 60, visivel: true }],
            fala: { npc: "Narrador", texto: "Uma jovem camponesa colhe flores à beira da estrada." },
            npcData: { nome: "Elara", genero: "feminino", iq: 12, reacaoBase: 10 },
            
            estado: { reacao: null, flerteTentado: false, infoRevelada: false, interacaoIniciada: false },
            
            renderizar: function() {
                if (npcsContainer) {
                    npcsContainer.innerHTML = '';
                    const npcDiv = document.createElement('div');
                    npcDiv.className = 'npc-sprite';
                    npcDiv.style.left = '50%'; npcDiv.style.top = '60%';
                    npcDiv.dataset.npcId = 'camponesa';
                    npcDiv.innerHTML = `<img src="camponesa.png" alt="Elara"><div class="npc-nome">Elara</div>`;
                    npcsContainer.appendChild(npcDiv);
                }
                
                if (this.estado.interacaoIniciada) return;
                dialogoTexto.textContent = this.fala.texto;
                npcNome.textContent = this.fala.npc;
                
                opcoesDialogo.innerHTML = '';
                const btnAproximar = document.createElement('button');
                btnAproximar.className = 'opcao-btn';
                btnAproximar.textContent = "👋 Aproximar-se da camponesa";
                btnAproximar.addEventListener('click', () => this.iniciarInteracao());
                opcoesDialogo.appendChild(btnAproximar);
                
                const btnIgnorar = document.createElement('button');
                btnIgnorar.className = 'opcao-btn';
                btnIgnorar.textContent = "➡️ Seguir caminho";
                btnIgnorar.addEventListener('click', () => { carregarCena('carroca_destruida'); });
                opcoesDialogo.appendChild(btnIgnorar);
            },
            
            iniciarInteracao: function() {
                this.estado.interacaoIniciada = true;
                npcNome.textContent = this.npcData.nome;
                dialogoTexto.textContent = "Você se aproxima... Ela levanta os olhos.";
                
                opcoesDialogo.innerHTML = '';
                const btnProcessando = document.createElement('button');
                btnProcessando.className = 'opcao-btn';
                btnProcessando.textContent = "⏳ Aguardando...";
                btnProcessando.disabled = true;
                opcoesDialogo.appendChild(btnProcessando);
                
                setTimeout(() => {
                    if (!this.estado.reacao) this.estado.reacao = SistemaSocial.testarReacao(this.npcData, window.personagem);
                    const reacaoClass = this.estado.reacao.classificacao;
                    
                    const dialogoMap = {
                        ruim: "Ela dá um passo para trás, assustada.",
                        normal: "Ela te olha com curiosidade. 'Olá, viajante.'",
                        otima: "Ela sorri abertamente. 'Olá! Precisa de ajuda?'"
                    };
                    dialogoTexto.textContent = dialogoMap[reacaoClass];
                    
                    const opcoes = this.criarOpcoes(reacaoClass);
                    this.renderizarOpcoes(opcoes, this);
                }, 2000);
            },
            
            criarOpcoes: function(reacaoClass) {
                const opcoesBase = [];
                if (reacaoClass === 'normal') {
                    opcoesBase.push({ texto: "🗺️ Perguntar sobre a região", acao: "info", tipo: "normal" });
                }
                if (reacaoClass === 'otima') {
                    opcoesBase.push({ texto: "👧 Perguntar sobre a menina", acao: "info", tipo: "menina" });
                }
                opcoesBase.push({ texto: "➡️ Se despedir", acao: "sair", proximo: "carroca_destruida" });
                return opcoesBase;
            },
            
            renderizarOpcoes: function(opcoes, cenaAtual) {
                opcoesDialogo.innerHTML = '';
                opcoes.forEach(opcao => {
                    const btn = document.createElement('button');
                    btn.className = 'opcao-btn';
                    btn.textContent = opcao.texto;
                    btn.addEventListener('click', () => {
                        if (opcao.acao === 'info') {
                            dialogoTexto.textContent = opcao.tipo === 'menina' ? "Ouvi dizer que levaram uma menina para a Caverna dos Esquecidos." : "A região está perigosa ultimamente.";
                            setTimeout(() => this.renderizarOpcoes(this.criarOpcoes(this.estado.reacao.classificacao), this), 3000);
                        } else carregarCena(opcao.proximo);
                    });
                    opcoesDialogo.appendChild(btn);
                });
            }
        },
        
        carroca_destruida: {
            id: "carroca_destruida", nome: "Local do Ataque", imagem: "carroca.jpg",
            fala: { npc: "Narrador", texto: "Você avista uma carroça destruída no caminho." },
            npcs: [],
            opcoes: [{ texto: "🔍 Investigar", acao: "investigar", proximo: "clareira_goblins" }]
        },
        
        clareira_goblins: {
            id: "clareira_goblins", nome: "Clareira na Floresta", imagem: "clareira-goblins.jpg",
            fala: { npc: "Narrador", texto: "Você encontra um acampamento goblin. Três deles estão ao redor de uma fogueira." },
            inimigos: [
                { id: "goblin_arqueiro", nome: "Goblin Arqueiro", pv: 64, pv_max: 64, dx: 12, nh_ataque: 12, dano: "2d-1", xp: 30 },
                { id: "goblin_guerreiro", nome: "Goblin Guerreiro", pv: 72, pv_max: 72, dx: 11, nh_ataque: 11, dano: "2d", xp: 40 },
                { id: "goblin_normal", nome: "Goblin", pv: 56, pv_max: 56, dx: 10, nh_ataque: 10, dano: "1d+1", xp: 25 }
            ],
            ao_vencer: "entrada_caverna",
            opcoes: [{ texto: "⚔️ Atacar os goblins", acao: "iniciar_combate", inimigos: ["goblin_arqueiro","goblin_guerreiro","goblin_normal"] }]
        },
        
        entrada_caverna: {
            id: "entrada_caverna", nome: "Entrada da Caverna", imagem: "entrada-caverna.jpg",
            fala: { npc: "Narrador", texto: "Uma abertura escura na rocha. Você ouve vozes." },
            npcs: [], opcoes: [{ texto: "Entrar na caverna", proximo: "camara_chefe" }]
        },
        
        camara_chefe: {
            id: "camara_chefe", nome: "Câmara do Chefe", imagem: "menina-elfa.jpg",
            fala: { npc: "Narrador", texto: "Numa jaula, uma menina elfa de cabelos prateados está sentada. Um goblin grande monta guarda." },
            npcs: [
                { id: "menina_elfa", nome: "Lyra", sprite: "menina-elfa.jpg", dialogo: "Por favor, me ajude!" },
                { id: "chefe_goblin", nome: "Chefe Goblin", sprite: "chefe-goblin.png" }
            ],
            inimigos: [{ id: "chefe_goblin", nome: "Chefe Goblin", pv: 85, pv_max: 85, dx: 10, nh_ataque: 10, dano: "2d+2", xp: 100 }],
            ao_vencer: "final_vitoria",
            opcoes: [{ texto: "Atacar o chefe!", acao: "iniciar_combate", inimigos: ["chefe_goblin"] }]
        },
        
        final_vitoria: {
            id: "final_vitoria", nome: "Missão Cumprida", imagem: "menina-elfa.jpg",
            fala: { npc: "Lyra", texto: "Você me salvou! Muito obrigada!" },
            npcs: [], opcoes: [{ texto: "Voltar à taverna", proximo: "final_taverna" }]
        },
        
        final_taverna: {
            id: "final_taverna", nome: "Retorno Triunfal", imagem: "taverna-interior.jpg",
            fala: { npc: "Eldrin", texto: "MINHA FILHA! Você conseguiu!" },
            npcs: [], opcoes: [{ texto: "Encerrar aventura", acao: "finalizar_aventura" }]
        }
    }
};
</script>
</body>
</html>