<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Aventura - RPGForce</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #2a1a3a 100%);
            min-height: 100vh;
            color: #fff;
        }

        .magic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .magic-bg::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
        }

        .magic-bg::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 80% 80%, rgba(198, 40, 40, 0.1) 0%, transparent 50%);
            animation: pulse 10s ease-in-out infinite reverse;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        /* COLUNA ESQUERDA - FICHA DO PERSONAGEM */
        .ficha-pc {
            width: 350px;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 20px;
            overflow-y: auto;
            height: 100%;
        }

        .pc-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }

        .pc-avatar {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #0a0a1a;
            margin: 0 auto 15px;
            overflow: hidden;
        }

        .pc-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pc-nome {
            font-size: 1.8rem;
            font-weight: 600;
            color: #ffd700;
            font-family: 'MedievalSharp', cursive;
            margin-bottom: 5px;
        }

        .pc-classe {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }

        .pc-status {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .status-item {
            margin-bottom: 15px;
        }

        .status-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .status-label i {
            color: #ffd700;
        }

        .status-bar {
            height: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            overflow: hidden;
        }

        .status-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .status-fill.vida {
            background: linear-gradient(90deg, #ff4d4d, #ff1a1a);
        }

        .status-fill.mana {
            background: linear-gradient(90deg, #4d4dff, #1a1aff);
        }

        .status-fill.fadiga {
            background: linear-gradient(90deg, #ffaa00, #ff8800);
        }

        .atributos-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .atributo-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .atributo-nome {
            color: #ffd700;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .atributo-valor {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .atributo-mod {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .defesas-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .defesa-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .defesa-valor {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffd700;
        }

        .defesa-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .vantagens-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .vantagens-box h4 {
            color: #ffd700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vantagens-lista {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .vantagem-tag {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.8rem;
            color: #ffd700;
        }

        .acoes-personagem {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .btn-acao-personagem {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-acao-personagem:hover {
            background: #ffd700;
            color: #0a0a1a;
        }

        /* COLUNA DIREITA - √ÅREA DE JOGO */
        .area-jogo {
            flex: 1;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
        }

        .aventura-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }

        .aventura-titulo {
            font-size: 1.8rem;
            font-family: 'MedievalSharp', cursive;
            color: #ffd700;
        }

        .aventura-capitulo {
            background: rgba(255, 215, 0, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        /* CAIXA DE NARRATIVA */
        .narrativa-box {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            min-height: 200px;
            font-size: 1.1rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
        }

        .narrativa-box::before {
            content: '"';
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 4rem;
            color: rgba(255, 215, 0, 0.2);
            font-family: 'MedievalSharp', cursive;
        }

        .narrativa-texto {
            position: relative;
            z-index: 1;
        }

        /* INIMIGOS */
        .inimigos-container {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff6b6b;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .inimigos-titulo {
            color: #ff6b6b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .inimigos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .inimigo-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #ff6b6b;
            border-radius: 12px;
            padding: 15px;
        }

        .inimigo-nome {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .inimigo-pv {
            height: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }

        .inimigo-pv-fill {
            height: 100%;
            background: #ff6b6b;
            transition: width 0.3s;
        }

        /* OP√á√ïES */
        .opcoes-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .opcao-btn {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            color: #ffd700;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .opcao-btn:hover:not(:disabled) {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            transform: translateY(-2px);
        }

        /* A√á√ïES DE COMBATE */
        .acoes-combate {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .acao-btn {
            background: transparent;
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 12px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
        }

        .acao-btn:hover {
            background: #ffd700;
            color: #0a0a1a;
        }

        .acao-btn.atacar {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .acao-btn.atacar:hover {
            background: #ff6b6b;
            color: #0a0a1a;
        }

        .acao-btn.magia {
            border-color: #4d4dff;
            color: #4d4dff;
        }

        /* MODAL DE DADOS */
        .dados-flutuante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .btn-dados {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
            transition: all 0.3s;
        }

        .btn-dados:hover {
            transform: scale(1.1);
        }

        .modal-dados {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-dados.active {
            display: flex;
        }

        .modal-dados-content {
            background: #1a1a3a;
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
        }

        .dados-controles {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .dado-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dado-control input,
        .dado-control select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 8px;
            border-radius: 8px;
            width: 100px;
        }

        .dados-resultado {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            font-size: 1.5rem;
            color: #ffd700;
            margin: 20px 0;
        }

        .dados-botoes {
            display: flex;
            gap: 10px;
        }

        .btn-rolar {
            background: #ffd700;
            color: #0a0a1a;
            border: none;
            padding: 12px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            flex: 2;
        }

        .btn-fechar {
            background: transparent;
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
            padding: 12px;
            border-radius: 30px;
            cursor: pointer;
            flex: 1;
        }

        .log-container {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        .log-item {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 26, 0.9);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 215, 0, 0.2);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            .ficha-pc {
                width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="magic-bg"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando sua aventura...</div>
    </div>

    <!-- Modal de Dados -->
    <div class="modal-dados" id="modalDados">
        <div class="modal-dados-content">
            <h3 style="color: #ffd700; margin-bottom: 15px;">
                <i class="fas fa-dice-d20"></i> Rolagem de Dados
            </h3>
            
            <div class="dados-controles">
                <div class="dado-control">
                    <label>Quantidade:</label>
                    <input type="number" id="dadosQtd" min="1" max="10" value="1">
                </div>
                
                <div class="dado-control">
                    <label>Faces:</label>
                    <select id="dadosFaces">
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10" selected>d10</option>
                        <option value="12">d12</option>
                        <option value="20">d20</option>
                        <option value="100">d100</option>
                    </select>
                </div>
                
                <div class="dado-control">
                    <label>Modificador:</label>
                    <input type="number" id="dadosMod" value="0">
                </div>
            </div>
            
            <div class="dados-resultado" id="dadosResultado">
                Clique em Rolar
            </div>
            
            <div class="dados-botoes">
                <button class="btn-rolar" id="btnRolarDados">
                    <i class="fas fa-dice"></i> Rolar
                </button>
                <button class="btn-fechar" id="btnFecharDados">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Bot√£o flutuante de dados -->
    <div class="dados-flutuante">
        <button class="btn-dados" id="btnAbrirDados">
            <i class="fas fa-dice-d20"></i>
        </button>
    </div>

    <div class="container">
        <!-- COLUNA ESQUERDA - FICHA DO PERSONAGEM -->
        <div class="ficha-pc">
            <div class="pc-header">
                <div class="pc-avatar" id="pcAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="pc-nome" id="pcNome">Carregando...</div>
                <div class="pc-classe" id="pcClasse"></div>
            </div>

            <div class="pc-status">
                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-heart"></i> PV</span>
                        <span id="pvTexto">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill vida" id="pvBarra" style="width: 0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-tint"></i> Fadiga</span>
                        <span id="fadigaTexto">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill fadiga" id="fadigaBarra" style="width: 0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-magic"></i> PM</span>
                        <span id="manaTexto">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill mana" id="manaBarra" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="atributos-grid" id="atributosGrid">
                <!-- Preenchido via JS -->
            </div>

            <div class="defesas-grid" id="defesasGrid">
                <!-- Preenchido via JS -->
            </div>

            <div class="vantagens-box">
                <h4><i class="fas fa-star"></i> Vantagens</h4>
                <div class="vantagens-lista" id="vantagensLista">
                    <!-- Preenchido via JS -->
                </div>
            </div>

            <div class="vantagens-box">
                <h4><i class="fas fa-skull"></i> Desvantagens</h4>
                <div class="vantagens-lista" id="desvantagensLista">
                    <!-- Preenchido via JS -->
                </div>
            </div>

            <div class="acoes-personagem">
                <button class="btn-acao-personagem" id="btnPericias">
                    <i class="fas fa-brain"></i> Per√≠cias
                </button>
                <button class="btn-acao-personagem" id="btnMagias">
                    <i class="fas fa-magic"></i> Magias
                </button>
                <button class="btn-acao-personagem" id="btnInventario">
                    <i class="fas fa-backpack"></i> Invent√°rio
                </button>
                <button class="btn-acao-personagem" id="btnDescansar">
                    <i class="fas fa-bed"></i> Descansar
                </button>
            </div>

            <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 12px; margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: #ffd700;">
                    <span><i class="fas fa-coins"></i> Dinheiro</span>
                    <span id="dinheiroValor">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; color: rgba(255,255,255,0.7);">
                    <span><i class="fas fa-trophy"></i> XP</span>
                    <span id="xpValor">0</span>
                </div>
            </div>
        </div>

        <!-- COLUNA DIREITA - √ÅREA DE JOGO -->
        <div class="area-jogo">
            <div class="aventura-header">
                <div class="aventura-titulo" id="aventuraTitulo">Carregando...</div>
                <div class="aventura-capitulo" id="aventuraCapitulo"></div>
            </div>

            <!-- Caixa de narrativa -->
            <div class="narrativa-box">
                <div class="narrativa-texto" id="narrativaTexto">
                    Preparando sua aventura...
                </div>
            </div>

            <!-- Container de inimigos -->
            <div class="inimigos-container" id="inimigosContainer" style="display: none;">
                <div class="inimigos-titulo">
                    <i class="fas fa-skull"></i> Inimigos
                </div>
                <div class="inimigos-grid" id="inimigosGrid"></div>
            </div>

            <!-- Op√ß√µes do cap√≠tulo -->
            <div class="opcoes-container" id="opcoesContainer"></div>

            <!-- A√ß√µes de combate -->
            <div class="acoes-combate" id="acoesCombate" style="display: none;">
                <button class="acao-btn atacar" id="btnAtacar">
                    <i class="fas fa-sword"></i> Atacar
                </button>
                <button class="acao-btn magia" id="btnMagia">
                    <i class="fas fa-magic"></i> Usar Magia
                </button>
                <button class="acao-btn" id="btnItem">
                    <i class="fas fa-flask"></i> Usar Item
                </button>
                <button class="acao-btn" id="btnFugir">
                    <i class="fas fa-running"></i> Fugir
                </button>
            </div>

            <!-- Bot√£o continuar -->
            <button class="btn-continuar" id="btnContinuar" style="display: none;">
                Continuar <i class="fas fa-arrow-right"></i>
            </button>

            <!-- Log de a√ß√µes -->
            <div class="log-container" id="logContainer">
                <div class="log-item">A aventura come√ßou...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc,
            getDoc,
            collection,
            setDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBrx4JSmFay24k95pu1ICjFfVki8gs_uHw",
            authDomain: "rpgforce-e3227.firebaseapp.com",
            projectId: "rpgforce-e3227",
            storageBucket: "rpgforce-e3227.firebasestorage.app",
            messagingSenderId: "984517342332",
            appId: "1:984517342332:web:87d33aa4c84ff2a07685f9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Elementos do DOM
        const loadingOverlay = document.getElementById('loadingOverlay');
        const pcNome = document.getElementById('pcNome');
        const pcClasse = document.getElementById('pcClasse');
        const pcAvatar = document.getElementById('pcAvatar');
        const pvTexto = document.getElementById('pvTexto');
        const pvBarra = document.getElementById('pvBarra');
        const fadigaTexto = document.getElementById('fadigaTexto');
        const fadigaBarra = document.getElementById('fadigaBarra');
        const manaTexto = document.getElementById('manaTexto');
        const manaBarra = document.getElementById('manaBarra');
        const atributosGrid = document.getElementById('atributosGrid');
        const defesasGrid = document.getElementById('defesasGrid');
        const vantagensLista = document.getElementById('vantagensLista');
        const desvantagensLista = document.getElementById('desvantagensLista');
        const dinheiroValor = document.getElementById('dinheiroValor');
        const xpValor = document.getElementById('xpValor');
        const aventuraTitulo = document.getElementById('aventuraTitulo');
        const aventuraCapitulo = document.getElementById('aventuraCapitulo');
        const narrativaTexto = document.getElementById('narrativaTexto');
        const inimigosContainer = document.getElementById('inimigosContainer');
        const inimigosGrid = document.getElementById('inimigosGrid');
        const opcoesContainer = document.getElementById('opcoesContainer');
        const acoesCombate = document.getElementById('acoesCombate');
        const btnContinuar = document.getElementById('btnContinuar');
        const logContainer = document.getElementById('logContainer');
        
        // Bot√µes
        const btnAtacar = document.getElementById('btnAtacar');
        const btnMagia = document.getElementById('btnMagia');
        const btnItem = document.getElementById('btnItem');
        const btnFugir = document.getElementById('btnFugir');
        const btnPericias = document.getElementById('btnPericias');
        const btnMagias = document.getElementById('btnMagias');
        const btnInventario = document.getElementById('btnInventario');
        const btnDescansar = document.getElementById('btnDescansar');
        
        // Dados
        const btnAbrirDados = document.getElementById('btnAbrirDados');
        const btnFecharDados = document.getElementById('btnFecharDados');
        const btnRolarDados = document.getElementById('btnRolarDados');
        const modalDados = document.getElementById('modalDados');
        const dadosResultado = document.getElementById('dadosResultado');
        const dadosQtd = document.getElementById('dadosQtd');
        const dadosFaces = document.getElementById('dadosFaces');
        const dadosMod = document.getElementById('dadosMod');

        // Estado do jogo
        let currentUser = null;
        let personagem = null;
        let historia = null;
        let capituloAtual = null;
        let inimigos = [];
        let sessaoId = null;

        // ========== FUN√á√ïES ==========
        
        function showLoading() {
            loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        function adicionarLog(mensagem, tipo = 'info') {
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = mensagem;
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function getModificador(atributo) {
            return Math.floor((atributo - 10) / 2);
        }

        function rolarDados(quantidade, faces, modificador = 0) {
            let total = 0;
            let resultados = [];
            
            for (let i = 0; i < quantidade; i++) {
                const resultado = Math.floor(Math.random() * faces) + 1;
                resultados.push(resultado);
                total += resultado;
            }
            
            total += modificador;
            
            return {
                total: total,
                resultados: resultados,
                modificador: modificador,
                texto: `${resultados.join(' + ')} ${modificador >= 0 ? '+' : '-'} ${Math.abs(modificador)} = ${total}`
            };
        }

        function calcularDano(st, armaDano) {
            const mod = getModificador(st);
            return mod + rolarDados(1, 6).total;
        }

        // ========== CARREGAR PERSONAGEM ==========
        
        async function carregarPersonagem(personagemId) {
            try {
                const personagemRef = doc(db, "personagens", personagemId);
                const personagemSnap = await getDoc(personagemRef);
                
                if (!personagemSnap.exists()) {
                    throw new Error('Personagem n√£o encontrado');
                }
                
                personagem = {
                    id: personagemSnap.id,
                    ...personagemSnap.data()
                };
                
                // Garantir que statusCombate existe
                if (!personagem.statusCombate) {
                    personagem.statusCombate = {
                        vidaAtual: personagem.status?.vidaMax || 48,
                        vidaMax: personagem.status?.vidaMax || 48,
                        fadigaAtual: personagem.status?.fadigaMax || 8,
                        fadigaMax: personagem.status?.fadigaMax || 8,
                        manaAtual: personagem.status?.manaMax || 13,
                        manaMax: personagem.status?.manaMax || 13
                    };
                }
                
                atualizarFichaPersonagem();
                
            } catch (error) {
                console.error('Erro ao carregar personagem:', error);
                adicionarLog('‚ùå Erro ao carregar personagem!');
            }
        }

        function atualizarFichaPersonagem() {
            if (!personagem) return;
            
            // Nome e classe
            pcNome.textContent = personagem.nome || 'Sem nome';
            
            const classes = {
                guerreiro: 'Guerreiro',
                mago: 'Mago',
                ladino: 'Ladino',
                clerigo: 'Cl√©rigo',
                barbaro: 'B√°rbaro'
            };
            pcClasse.textContent = classes[personagem.classe] || personagem.classe || 'Aventureiro';
            
            // Avatar
            if (personagem.fotoURL) {
                pcAvatar.innerHTML = `<img src="${personagem.fotoURL}" alt="${personagem.nome}">`;
            }
            
            // PV
            const pvAtual = personagem.statusCombate?.vidaAtual || 48;
            const pvMax = personagem.statusCombate?.vidaMax || 48;
            pvTexto.textContent = `${pvAtual}/${pvMax}`;
            pvBarra.style.width = (pvAtual / pvMax * 100) + '%';
            
            // Fadiga
            const fadigaAtual = personagem.statusCombate?.fadigaAtual || 8;
            const fadigaMax = personagem.statusCombate?.fadigaMax || 8;
            fadigaTexto.textContent = `${fadigaAtual}/${fadigaMax}`;
            fadigaBarra.style.width = (fadigaAtual / fadigaMax * 100) + '%';
            
            // Mana
            const manaAtual = personagem.statusCombate?.manaAtual || 13;
            const manaMax = personagem.statusCombate?.manaMax || 13;
            manaTexto.textContent = `${manaAtual}/${manaMax}`;
            manaBarra.style.width = (manaAtual / manaMax * 100) + '%';
            
            // Atributos
            atributosGrid.innerHTML = `
                <div class="atributo-card">
                    <div class="atributo-nome">ST</div>
                    <div class="atributo-valor">${personagem.atributos?.st?.valor || 9}</div>
                    <div class="atributo-mod">Mod ${getModificador(personagem.atributos?.st?.valor || 9)}</div>
                </div>
                <div class="atributo-card">
                    <div class="atributo-nome">DX</div>
                    <div class="atributo-valor">${personagem.atributos?.dx?.valor || 5}</div>
                    <div class="atributo-mod">Mod ${getModificador(personagem.atributos?.dx?.valor || 5)}</div>
                </div>
                <div class="atributo-card">
                    <div class="atributo-nome">IQ</div>
                    <div class="atributo-valor">${personagem.atributos?.iq?.valor || 5}</div>
                    <div class="atributo-mod">Mod ${getModificador(personagem.atributos?.iq?.valor || 5)}</div>
                </div>
                <div class="atributo-card">
                    <div class="atributo-nome">HT</div>
                    <div class="atributo-valor">${personagem.atributos?.ht?.valor || 8}</div>
                    <div class="atributo-mod">Mod ${getModificador(personagem.atributos?.ht?.valor || 8)}</div>
                </div>
            `;
            
            // Defesas
            defesasGrid.innerHTML = `
                <div class="defesa-card">
                    <div class="defesa-valor">${personagem.derivados?.esquiva || 5}</div>
                    <div class="defesa-label">Esquiva</div>
                </div>
                <div class="defesa-card">
                    <div class="defesa-valor">${personagem.derivados?.aparar || 5}</div>
                    <div class="defesa-label">Aparar</div>
                </div>
                <div class="defesa-card">
                    <div class="defesa-valor">${personagem.derivados?.bloqueio || 5}</div>
                    <div class="defesa-label">Bloqueio</div>
                </div>
            `;
            
            // Vantagens
            if (personagem.vantagens && personagem.vantagens.length > 0) {
                vantagensLista.innerHTML = personagem.vantagens.map(v => 
                    `<span class="vantagem-tag">${v}</span>`
                ).join('');
            } else {
                vantagensLista.innerHTML = '<span style="color: rgba(255,255,255,0.5);">Nenhuma</span>';
            }
            
            // Desvantagens
            if (personagem.desvantagens && personagem.desvantagens.length > 0) {
                desvantagensLista.innerHTML = personagem.desvantagens.map(d => 
                    `<span class="vantagem-tag" style="border-color: #ff6b6b; color: #ff6b6b;">${d}</span>`
                ).join('');
            } else {
                desvantagensLista.innerHTML = '<span style="color: rgba(255,255,255,0.5);">Nenhuma</span>';
            }
            
            // Dinheiro e XP
            dinheiroValor.textContent = personagem.dinheiro || 0;
            xpValor.textContent = personagem.xp || 0;
        }

        // ========== CARREGAR HIST√ìRIA ==========
        
        async function carregarHistoria(historiaId) {
            try {
                // Tenta carregar do arquivo JS correspondente
                const module = await import(`./${historiaId}.js`);
                historia = module.default || module.HISTORIA;
                
                if (!historia) {
                    throw new Error('Hist√≥ria n√£o encontrada');
                }
                
                aventuraTitulo.textContent = historia.nome;
                
                // Inicia no primeiro cap√≠tulo
                iniciarCapitulo(historia.capitulos[0].id);
                
            } catch (error) {
                console.error('Erro ao carregar hist√≥ria:', error);
                
                // Fallback para teste
                aventuraTitulo.textContent = 'Hist√≥ria de Teste';
                narrativaTexto.textContent = 'Clique em Continuar para testar o motor de jogo.';
                
                opcoesContainer.innerHTML = `
                    <button class="opcao-btn" id="btnTeste">
                        <i class="fas fa-flask"></i> Testar Motor
                    </button>
                `;
                
                document.getElementById('btnTeste')?.addEventListener('click', () => {
                    adicionarLog('‚úÖ Motor de jogo funcionando!');
                });
            }
        }

        function iniciarCapitulo(capituloId) {
            if (!historia) return;
            
            const capitulo = historia.capitulos.find(c => c.id === capituloId);
            if (!capitulo) return;
            
            capituloAtual = capitulo;
            
            aventuraCapitulo.textContent = capitulo.titulo || 'Cap√≠tulo';
            narrativaTexto.textContent = capitulo.texto || '...';
            
            // Esconde tudo
            inimigosContainer.style.display = 'none';
            opcoesContainer.style.display = 'none';
            acoesCombate.style.display = 'none';
            btnContinuar.style.display = 'none';
            
            if (capitulo.tipo === 'narrativa') {
                // Mostra op√ß√µes
                if (capitulo.opcoes && capitulo.opcoes.length > 0) {
                    opcoesContainer.style.display = 'grid';
                    opcoesContainer.innerHTML = capitulo.opcoes.map(opcao => `
                        <button class="opcao-btn" data-proximo="${opcao.proximo}">
                            <i class="fas fa-arrow-right"></i> ${opcao.texto}
                        </button>
                    `).join('');
                    
                    document.querySelectorAll('.opcao-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            iniciarCapitulo(btn.dataset.proximo);
                        });
                    });
                }
                
            } else if (capitulo.tipo === 'combate') {
                // Inicia combate
                inimigos = capitulo.inimigos.map(i => ({...i, pv: i.pv_max || i.pv}));
                renderizarInimigos();
                
                inimigosContainer.style.display = 'block';
                acoesCombate.style.display = 'flex';
                
                adicionarLog('‚öîÔ∏è COMBATE INICIADO!');
                
            } else if (capitulo.tipo === 'recompensa') {
                // D√° recompensa
                if (capitulo.xp) {
                    personagem.xp = (personagem.xp || 0) + capitulo.xp;
                    xpValor.textContent = personagem.xp;
                    adicionarLog(`‚ú® +${capitulo.xp} XP`);
                }
                
                if (capitulo.ouro) {
                    personagem.dinheiro = (personagem.dinheiro || 0) + capitulo.ouro;
                    dinheiroValor.textContent = personagem.dinheiro;
                    adicionarLog(`üí∞ +${capitulo.ouro} moedas`);
                }
                
                if (capitulo.item) {
                    adicionarLog(`üéí Item encontrado: ${capitulo.item}`);
                }
                
                // Pr√≥ximo passo
                if (capitulo.opcoes) {
                    opcoesContainer.style.display = 'grid';
                    opcoesContainer.innerHTML = capitulo.opcoes.map(opcao => `
                        <button class="opcao-btn" data-proximo="${opcao.proximo}">
                            <i class="fas fa-arrow-right"></i> ${opcao.texto}
                        </button>
                    `).join('');
                    
                    document.querySelectorAll('.opcao-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            iniciarCapitulo(btn.dataset.proximo);
                        });
                    });
                    
                } else if (capitulo.proximo) {
                    btnContinuar.style.display = 'block';
                    btnContinuar.onclick = () => iniciarCapitulo(capitulo.proximo);
                }
                
            } else if (capitulo.tipo === 'final') {
                // Fim da aventura
                if (capitulo.xp) {
                    personagem.xp = (personagem.xp || 0) + capitulo.xp;
                    xpValor.textContent = personagem.xp;
                }
                
                if (capitulo.ouro) {
                    personagem.dinheiro = (personagem.dinheiro || 0) + capitulo.ouro;
                    dinheiroValor.textContent = personagem.dinheiro;
                }
                
                opcoesContainer.style.display = 'grid';
                opcoesContainer.innerHTML = `
                    <button class="opcao-btn" onclick="window.location.href='aventura-solo.html'">
                        <i class="fas fa-home"></i> Voltar para Aventuras
                    </button>
                `;
            }
            
            salvarProgresso();
        }

        function renderizarInimigos() {
            inimigosGrid.innerHTML = inimigos.map(inimigo => `
                <div class="inimigo-card" data-id="${inimigo.id || Math.random()}">
                    <div class="inimigo-nome">${inimigo.nome}</div>
                    <div class="inimigo-pv">
                        <div class="inimigo-pv-fill" style="width: ${(inimigo.pv / (inimigo.pv_max || inimigo.pv)) * 100}%"></div>
                    </div>
                    <div style="font-size:0.8rem; text-align:center;">${inimigo.pv}/${inimigo.pv_max || inimigo.pv} PV</div>
                </div>
            `).join('');
        }

        function atacarInimigo() {
            if (inimigos.length === 0) return;
            
            const inimigo = inimigos[0];
            const st = personagem.atributos?.st?.valor || 9;
            
            // Rola ataque (3d6 vs DX)
            const rolagem = rolarDados(3, 6).total;
            const dx = personagem.atributos?.dx?.valor || 5;
            
            if (rolagem <= dx) {
                const dano = calcularDano(st);
                inimigo.pv -= dano;
                adicionarLog(`üéØ Acertou! Dano: ${dano}`);
                
                if (inimigo.pv <= 0) {
                    adicionarLog(`üíÄ ${inimigo.nome} derrotado!`);
                    inimigos = inimigos.filter(i => i !== inimigo);
                }
            } else {
                adicionarLog(`‚ùå Errou! (rolagem ${rolagem} vs NH ${dx})`);
            }
            
            // Inimigos atacam de volta
            inimigos.forEach(i => {
                const rolagemInimigo = rolarDados(3, 6).total;
                if (rolagemInimigo <= 10) { // Esquiva base do inimigo
                    const dano = rolarDados(1, 4).total;
                    personagem.statusCombate.vidaAtual -= dano;
                    adicionarLog(`üòñ ${i.nome} causou ${dano} de dano!`);
                }
            });
            
            atualizarFichaPersonagem();
            renderizarInimigos();
            
            // Verifica fim de combate
            if (inimigos.length === 0) {
                adicionarLog('üéâ VIT√ìRIA!');
                setTimeout(() => {
                    if (capituloAtual.vitoria) {
                        iniciarCapitulo(capituloAtual.vitoria);
                    }
                }, 2000);
            }
            
            if (personagem.statusCombate.vidaAtual <= 0) {
                adicionarLog('üíÄ VOC√ä MORREU!');
                setTimeout(() => {
                    if (capituloAtual.derrota) {
                        iniciarCapitulo(capituloAtual.derrota);
                    }
                }, 2000);
            }
            
            salvarProgresso();
        }

        async function salvarProgresso() {
            if (!sessaoId || !currentUser) return;
            
            try {
                const sessaoRef = doc(db, "sessoes_aventura", sessaoId);
                await updateDoc(sessaoRef, {
                    pc_atual: personagem,
                    inimigos: inimigos,
                    capitulo_atual: capituloAtual?.id,
                    ultima_sessao: new Date().toISOString()
                });
            } catch (error) {
                console.error('Erro ao salvar progresso:', error);
            }
        }

        async function criarSessao() {
            const urlParams = new URLSearchParams(window.location.search);
            const aventuraId = urlParams.get('aventura');
            const personagemId = urlParams.get('personagem');
            
            if (!aventuraId || !personagemId) {
                alert('Aventura ou personagem n√£o selecionado!');
                window.location.href = 'aventura-solo.html';
                return;
            }
            
            showLoading();
            
            try {
                await carregarPersonagem(personagemId);
                await carregarHistoria(aventuraId);
                
                // Cria sess√£o no Firebase
                const sessaoRef = doc(collection(db, "sessoes_aventura"));
                sessaoId = sessaoRef.id;
                
                await setDoc(sessaoRef, {
                    id: sessaoId,
                    userId: currentUser.uid,
                    personagem_id: personagemId,
                    aventura_id: aventuraId,
                    pc_atual: personagem,
                    inimigos: [],
                    capitulo_atual: "inicio",
                    data_inicio: new Date().toISOString(),
                    ultima_sessao: new Date().toISOString(),
                    status: "em_andamento"
                });
                
            } catch (error) {
                console.error('Erro ao iniciar sess√£o:', error);
                alert('Erro ao iniciar aventura!');
            } finally {
                hideLoading();
            }
        }

        // ========== EVENT LISTENERS ==========
        
        btnAtacar.addEventListener('click', atacarInimigo);
        
        btnMagia.addEventListener('click', () => {
            adicionarLog('üîÆ Funcionalidade de magias em breve...');
        });
        
        btnItem.addEventListener('click', () => {
            adicionarLog('üéí Funcionalidade de itens em breve...');
        });
        
        btnFugir.addEventListener('click', () => {
            if (capituloAtual?.derrota) {
                adicionarLog('üèÉ Voc√™ fugiu do combate!');
                iniciarCapitulo(capituloAtual.derrota);
            }
        });
        
        btnPericias.addEventListener('click', () => {
            adicionarLog('üìö Suas per√≠cias est√£o dispon√≠veis');
        });
        
        btnMagias.addEventListener('click', () => {
            adicionarLog('üîÆ Suas magias est√£o dispon√≠veis');
        });
        
        btnInventario.addEventListener('click', () => {
            adicionarLog('üéí Abrindo invent√°rio...');
        });
        
        btnDescansar.addEventListener('click', () => {
            if (personagem.statusCombate.vidaAtual < personagem.statusCombate.vidaMax) {
                const cura = Math.min(5, personagem.statusCombate.vidaMax - personagem.statusCombate.vidaAtual);
                personagem.statusCombate.vidaAtual += cura;
                atualizarFichaPersonagem();
                adicionarLog(`üí§ Voc√™ descansou e recuperou ${cura} PV`);
            } else {
                adicionarLog('üí§ Voc√™ j√° est√° com vida cheia');
            }
        });
        
        // Dados
        btnAbrirDados.addEventListener('click', () => {
            modalDados.classList.add('active');
        });
        
        btnFecharDados.addEventListener('click', () => {
            modalDados.classList.remove('active');
        });
        
        btnRolarDados.addEventListener('click', () => {
            const qtd = parseInt(dadosQtd.value) || 1;
            const faces = parseInt(dadosFaces.value) || 10;
            const mod = parseInt(dadosMod.value) || 0;
            
            const resultado = rolarDados(qtd, faces, mod);
            dadosResultado.textContent = resultado.texto;
            adicionarLog(`üé≤ Rolagem: ${resultado.texto}`);
        });

        // Auth
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await criarSessao();
            } else {
                window.location.href = 'index.html';
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modalDados.classList.contains('active')) {
                modalDados.classList.remove('active');
            }
        });
    </script>
</body>
</html>