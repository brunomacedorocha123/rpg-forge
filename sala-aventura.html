<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Aventura - Combate T√°tico - RPGForce</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #2a1a3a 100%);
            min-height: 100vh;
            color: #fff;
        }

        .magic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .magic-bg::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
        }

        .magic-bg::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 80% 80%, rgba(198, 40, 40, 0.1) 0%, transparent 50%);
            animation: pulse 10s ease-in-out infinite reverse;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        /* COLUNA ESQUERDA - FICHA DO PERSONAGEM */
        .ficha-pc {
            width: 350px;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 20px;
            overflow-y: auto;
            height: 100%;
        }

        .pc-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }

        .pc-avatar {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #0a0a1a;
            margin: 0 auto 15px;
            overflow: hidden;
        }

        .pc-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pc-nome {
            font-size: 1.8rem;
            font-weight: 600;
            color: #ffd700;
            font-family: 'MedievalSharp', cursive;
            margin-bottom: 5px;
        }

        .pc-classe {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }

        .pc-status {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .status-item {
            margin-bottom: 15px;
        }

        .status-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .status-label i {
            color: #ffd700;
        }

        .status-bar {
            height: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            overflow: hidden;
        }

        .status-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .status-fill.vida {
            background: linear-gradient(90deg, #ff4d4d, #ff1a1a);
        }

        .status-fill.mana {
            background: linear-gradient(90deg, #4d4dff, #1a1aff);
        }

        .status-fill.fadiga {
            background: linear-gradient(90deg, #ffaa00, #ff8800);
        }

        .atributos-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .atributo-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .atributo-nome {
            color: #ffd700;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .atributo-valor {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .atributo-mod {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .defesas-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .defesa-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .defesa-valor {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffd700;
        }

        .defesa-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .vantagens-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .vantagens-box h4 {
            color: #ffd700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vantagens-lista {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .vantagem-tag {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.8rem;
            color: #ffd700;
        }

        .acoes-personagem {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .btn-acao-personagem {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-acao-personagem:hover {
            background: #ffd700;
            color: #0a0a1a;
        }

        /* COLUNA DIREITA - √ÅREA DE JOGO */
        .area-jogo {
            flex: 1;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
        }

        .aventura-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }

        .aventura-titulo {
            font-size: 1.8rem;
            font-family: 'MedievalSharp', cursive;
            color: #ffd700;
        }

        .turno-indicator {
            background: rgba(255, 215, 0, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid #ffd700;
        }

        .turno-indicator.jogador {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .turno-indicator.inimigo {
            background: rgba(255, 87, 34, 0.2);
            border-color: #ff5722;
            color: #ff5722;
        }

        /* CAIXA DE NARRATIVA */
        .narrativa-box {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            min-height: 150px;
            font-size: 1rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
        }

        .narrativa-box::before {
            content: '"';
            position: absolute;
            top: 5px;
            left: 10px;
            font-size: 3rem;
            color: rgba(255, 215, 0, 0.2);
            font-family: 'MedievalSharp', cursive;
        }

        .narrativa-texto {
            position: relative;
            z-index: 1;
        }

        /* INIMIGOS */
        .inimigos-container {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff6b6b;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .inimigos-titulo {
            color: #ff6b6b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .inimigos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .inimigo-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #ff6b6b;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .inimigo-card:hover {
            background: rgba(255, 107, 107, 0.2);
            transform: translateY(-2px);
        }

        .inimigo-card.selecionado {
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .inimigo-nome {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .inimigo-pv {
            height: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }

        .inimigo-pv-fill {
            height: 100%;
            background: #ff6b6b;
            transition: width 0.3s;
        }

        /* A√á√ïES */
        .acoes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .acao-btn {
            background: transparent;
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 12px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
            min-width: 150px;
        }

        .acao-btn:hover:not(:disabled) {
            background: #ffd700;
            color: #0a0a1a;
        }

        .acao-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .acao-btn.atacar {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .acao-btn.atacar:hover:not(:disabled) {
            background: #ff6b6b;
            color: #0a0a1a;
        }

        .acao-btn.magia {
            border-color: #4d4dff;
            color: #4d4dff;
        }

        .acao-btn.defender {
            border-color: #4CAF50;
            color: #4CAF50;
        }

        /* MODAL DE ATAQUE */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a3a;
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            color: #ffd700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .arma-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .arma-card:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }

        .arma-card.selecionada {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
        }

        .arma-nome {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .arma-detalhes {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            gap: 15px;
        }

        .modal-botoes {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-confirmar {
            background: #ffd700;
            color: #0a0a1a;
            border: none;
            padding: 12px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            flex: 2;
        }

        .btn-cancelar {
            background: transparent;
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
            padding: 12px;
            border-radius: 30px;
            cursor: pointer;
            flex: 1;
        }

        /* MODAL DE DEFESA */
        .defesa-card-modal {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4CAF50;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .defesa-card-modal:hover:not(.disabled) {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
        }

        .defesa-card-modal.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: #666;
        }

        .defesa-card-modal.selecionada {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }

        /* LOG */
        .log-container {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        .log-item {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }

        .log-item.sucesso {
            color: #4CAF50;
        }

        .log-item.erro {
            color: #ff6b6b;
        }

        .log-item.dano {
            color: #ff5722;
        }

        /* LOADING */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 26, 0.9);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 215, 0, 0.2);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* DADOS FLUTUANTES */
        .dados-flutuante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .btn-dados {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            color: #0a0a1a;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
            transition: all 0.3s;
        }

        .btn-dados:hover {
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            .ficha-pc {
                width: 100%;
                height: auto;
            }
            .acoes-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="magic-bg"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando sua aventura...</div>
    </div>

    <!-- MODAL DE ATAQUE -->
    <div class="modal" id="modalAtaque">
        <div class="modal-content">
            <h3><i class="fas fa-sword"></i> Escolha sua Arma</h3>
            
            <div id="armasLista">
                <!-- Preenchido via JS -->
            </div>
            
            <div class="modal-botoes">
                <button class="btn-cancelar" id="btnCancelarAtaque">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirmar" id="btnConfirmarAtaque" disabled>
                    <i class="fas fa-check"></i> Atacar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE DEFESA -->
    <div class="modal" id="modalDefesa">
        <div class="modal-content">
            <h3><i class="fas fa-shield-alt"></i> Escolha sua Defesa</h3>
            
            <p id="defesaContexto" style="margin-bottom: 15px; color: rgba(255,255,255,0.8);"></p>
            
            <div id="defesasLista">
                <!-- Preenchido via JS -->
            </div>
            
            <div class="modal-botoes">
                <button class="btn-cancelar" id="btnCancelarDefesa">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirmar" id="btnConfirmarDefesa" disabled>
                    <i class="fas fa-check"></i> Defender
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE DADOS -->
    <div class="modal" id="modalDados">
        <div class="modal-content">
            <h3><i class="fas fa-dice-d20"></i> Rolagem de Dados</h3>
            
            <div style="display: flex; flex-direction: column; gap: 15px; margin: 20px 0;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Quantidade:</label>
                    <input type="number" id="dadosQtd" min="1" max="10" value="1" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 8px; border-radius: 8px; width: 100px;">
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Faces:</label>
                    <select id="dadosFaces" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 8px; border-radius: 8px; width: 100px;">
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10" selected>d10</option>
                        <option value="12">d12</option>
                        <option value="20">d20</option>
                        <option value="100">d100</option>
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Modificador:</label>
                    <input type="number" id="dadosMod" value="0" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 8px; border-radius: 8px; width: 100px;">
                </div>
            </div>
            
            <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 20px; text-align: center; font-size: 1.5rem; color: #ffd700; margin: 20px 0;" id="dadosResultado">
                Clique em Rolar
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn-cancelar" id="btnFecharDados" style="flex:1;">Fechar</button>
                <button class="btn-confirmar" id="btnRolarDados" style="flex:2;">Rolar</button>
            </div>
        </div>
    </div>

    <!-- Bot√£o flutuante de dados -->
    <div class="dados-flutuante">
        <button class="btn-dados" id="btnAbrirDados">
            <i class="fas fa-dice-d20"></i>
        </button>
    </div>

    <div class="container">
        <!-- COLUNA ESQUERDA - FICHA DO PERSONAGEM -->
        <div class="ficha-pc">
            <div class="pc-header">
                <div class="pc-avatar" id="pcAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="pc-nome" id="pcNome">Carregando...</div>
                <div class="pc-classe" id="pcClasse"></div>
            </div>

            <div class="pc-status">
                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-heart"></i> PV</span>
                        <span id="pvTexto">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill vida" id="pvBarra" style="width: 0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-tint"></i> Fadiga</span>
                        <span id="fadigaTexto">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill fadiga" id="fadigaBarra" style="width: 0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-magic"></i> PM</span>
                        <span id="manaTexto">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill mana" id="manaBarra" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="atributos-grid" id="atributosGrid">
                <!-- Preenchido via JS -->
            </div>

            <div class="defesas-grid" id="defesasGrid">
                <!-- Preenchido via JS -->
            </div>

            <div class="vantagens-box">
                <h4><i class="fas fa-star"></i> Vantagens</h4>
                <div class="vantagens-lista" id="vantagensLista">
                    <!-- Preenchido via JS -->
                </div>
            </div>

            <div class="vantagens-box">
                <h4><i class="fas fa-skull"></i> Desvantagens</h4>
                <div class="vantagens-lista" id="desvantagensLista">
                    <!-- Preenchido via JS -->
                </div>
            </div>

            <div class="acoes-personagem">
                <button class="btn-acao-personagem" id="btnPericias">
                    <i class="fas fa-brain"></i> Per√≠cias
                </button>
                <button class="btn-acao-personagem" id="btnMagias">
                    <i class="fas fa-magic"></i> Magias
                </button>
                <button class="btn-acao-personagem" id="btnInventario">
                    <i class="fas fa-backpack"></i> Invent√°rio
                </button>
                <button class="btn-acao-personagem" id="btnDescansar">
                    <i class="fas fa-bed"></i> Descansar
                </button>
            </div>

            <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 12px; margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: #ffd700;">
                    <span><i class="fas fa-coins"></i> Dinheiro</span>
                    <span id="dinheiroValor">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; color: rgba(255,255,255,0.7);">
                    <span><i class="fas fa-trophy"></i> XP</span>
                    <span id="xpValor">0</span>
                </div>
            </div>
        </div>

        <!-- COLUNA DIREITA - √ÅREA DE JOGO -->
        <div class="area-jogo">
            <div class="aventura-header">
                <div class="aventura-titulo" id="aventuraTitulo">Carregando...</div>
                <div class="turno-indicator" id="turnoIndicator">
                    <i class="fas fa-hourglass-half"></i> Turno: Carregando
                </div>
            </div>

            <!-- Caixa de narrativa -->
            <div class="narrativa-box">
                <div class="narrativa-texto" id="narrativaTexto">
                    Preparando sua aventura...
                </div>
            </div>

            <!-- Container de inimigos -->
            <div class="inimigos-container" id="inimigosContainer" style="display: none;">
                <div class="inimigos-titulo">
                    <i class="fas fa-skull"></i> Inimigos
                </div>
                <div class="inimigos-grid" id="inimigosGrid"></div>
            </div>

            <!-- A√ß√µes -->
            <div class="acoes-container" id="acoesContainer"></div>

            <!-- Log de a√ß√µes -->
            <div class="log-container" id="logContainer">
                <div class="log-item">A aventura come√ßou...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc,
            getDoc,
            collection,
            setDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBrx4JSmFay24k95pu1ICjFfVki8gs_uHw",
            authDomain: "rpgforce-e3227.firebaseapp.com",
            projectId: "rpgforce-e3227",
            storageBucket: "rpgforce-e3227.firebasestorage.app",
            messagingSenderId: "984517342332",
            appId: "1:984517342332:web:87d33aa4c84ff2a07685f9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Elementos do DOM
        const loadingOverlay = document.getElementById('loadingOverlay');
        const pcNome = document.getElementById('pcNome');
        const pcClasse = document.getElementById('pcClasse');
        const pcAvatar = document.getElementById('pcAvatar');
        const pvTexto = document.getElementById('pvTexto');
        const pvBarra = document.getElementById('pvBarra');
        const fadigaTexto = document.getElementById('fadigaTexto');
        const fadigaBarra = document.getElementById('fadigaBarra');
        const manaTexto = document.getElementById('manaTexto');
        const manaBarra = document.getElementById('manaBarra');
        const atributosGrid = document.getElementById('atributosGrid');
        const defesasGrid = document.getElementById('defesasGrid');
        const vantagensLista = document.getElementById('vantagensLista');
        const desvantagensLista = document.getElementById('desvantagensLista');
        const dinheiroValor = document.getElementById('dinheiroValor');
        const xpValor = document.getElementById('xpValor');
        const aventuraTitulo = document.getElementById('aventuraTitulo');
        const turnoIndicator = document.getElementById('turnoIndicator');
        const narrativaTexto = document.getElementById('narrativaTexto');
        const inimigosContainer = document.getElementById('inimigosContainer');
        const inimigosGrid = document.getElementById('inimigosGrid');
        const acoesContainer = document.getElementById('acoesContainer');
        const logContainer = document.getElementById('logContainer');
        
        // Modais
        const modalAtaque = document.getElementById('modalAtaque');
        const modalDefesa = document.getElementById('modalDefesa');
        const modalDados = document.getElementById('modalDados');
        const armasLista = document.getElementById('armasLista');
        const defesasLista = document.getElementById('defesasLista');
        const defesaContexto = document.getElementById('defesaContexto');
        const btnCancelarAtaque = document.getElementById('btnCancelarAtaque');
        const btnConfirmarAtaque = document.getElementById('btnConfirmarAtaque');
        const btnCancelarDefesa = document.getElementById('btnCancelarDefesa');
        const btnConfirmarDefesa = document.getElementById('btnConfirmarDefesa');
        const btnAbrirDados = document.getElementById('btnAbrirDados');
        const btnFecharDados = document.getElementById('btnFecharDados');
        const btnRolarDados = document.getElementById('btnRolarDados');
        const dadosResultado = document.getElementById('dadosResultado');
        const dadosQtd = document.getElementById('dadosQtd');
        const dadosFaces = document.getElementById('dadosFaces');
        const dadosMod = document.getElementById('dadosMod');
        
        // Bot√µes
        const btnPericias = document.getElementById('btnPericias');
        const btnMagias = document.getElementById('btnMagias');
        const btnInventario = document.getElementById('btnInventario');
        const btnDescansar = document.getElementById('btnDescansar');

        // Estado do jogo
        let currentUser = null;
        let personagem = null;
        let historia = null;
        let capituloAtual = null;
        let inimigos = [];
        let sessaoId = null;
        
        // Estado do combate
        let turnoAtual = 'jogador'; // 'jogador' ou 'inimigo'
        let inimigoSelecionado = null;
        let armaSelecionada = null;
        let defesaSelecionada = null;
        let ataqueAtual = null; // Dados do ataque sendo realizado

        // ========== FUN√á√ïES ==========
        
        function showLoading() {
            loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        function adicionarLog(mensagem, tipo = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${tipo}`;
            logItem.innerHTML = mensagem;
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Limitar log a 50 itens
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        function rolarDados(quantidade, faces, modificador = 0) {
            let total = 0;
            let resultados = [];
            
            for (let i = 0; i < quantidade; i++) {
                const resultado = Math.floor(Math.random() * faces) + 1;
                resultados.push(resultado);
                total += resultado;
            }
            
            total += modificador;
            
            return {
                total: total,
                resultados: resultados,
                modificador: modificador,
                texto: `${resultados.join(' + ')} ${modificador >= 0 ? '+' : '-'} ${Math.abs(modificador)} = ${total}`
            };
        }

        function rolar2d10() {
            return rolarDados(2, 10, 0);
        }

        function calcularNH(atributoBase, periciaNivel) {
            const bonus = periciaNivel === 1 ? 0 : periciaNivel - 1;
            return atributoBase + bonus;
        }

        function getAtributoValor(atributo) {
            if (!personagem || !personagem.atributos) return 0;
            
            if (atributo === 'st') return personagem.atributos.st?.valor || 9;
            if (atributo === 'dx') return personagem.atributos.dx?.valor || 5;
            if (atributo === 'iq') return personagem.atributos.iq?.valor || 5;
            if (atributo === 'ht') return 8; // HT base √© sempre 8 + bolinhas
            return 0;
        }

        function getPericiaNivel(periciaId) {
            if (!personagem || !personagem.pericias) return 0;
            return personagem.pericias[periciaId]?.nivel || 0;
        }

        function getArmasEquipadas() {
            if (!personagem || !personagem.inventario) return [];
            
            const armas = [];
            
            // Procura no invent√°rio do corpo (equipado)
            if (personagem.inventario.corpo) {
                personagem.inventario.corpo.forEach(item => {
                    if (item.dano) { // √â uma arma
                        armas.push({
                            id: item.id,
                            nome: item.nome,
                            dano: item.dano,
                            tipo: item.tipoDano || 'Desconhecido',
                            alcance: item.alcance || 1,
                            st: item.st || 8,
                            periciaId: getPericiaIdPorArma(item.nome)
                        });
                    }
                });
            }
            
            return armas;
        }

        function getPericiaIdPorArma(nomeArma) {
            nomeArma = nomeArma.toLowerCase();
            
            if (nomeArma.includes('espada')) return 'espada';
            if (nomeArma.includes('machado')) return 'machado';
            if (nomeArma.includes('arco')) return 'arco';
            if (nomeArma.includes('besta')) return 'besta';
            if (nomeArma.includes('adaga')) return 'adaga';
            if (nomeArma.includes('escudo')) return 'escudo';
            
            return 'espada'; // Padr√£o
        }

        function calcularEsquiva() {
            const dx = getAtributoValor('dx');
            const ht = getAtributoValor('ht');
            return Math.floor((dx + ht) / 6) + 6;
        }

        function calcularAparar() {
            // Precisa ter arma equipada
            const armas = getArmasEquipadas();
            if (armas.length === 0) return 0;
            
            const dx = getAtributoValor('dx');
            
            // Usa a melhor per√≠cia de arma
            let melhorNH = dx;
            armas.forEach(arma => {
                const periciaNivel = getPericiaNivel(arma.periciaId);
                if (periciaNivel > 0) {
                    const nh = calcularNH(dx, periciaNivel);
                    if (nh > melhorNH) melhorNH = nh;
                }
            });
            
            return Math.floor((melhorNH + dx) / 4) + 6;
        }

        function calcularBloqueio() {
            // Precisa ter escudo equipado
            let temEscudo = false;
            let bonusEscudo = 0;
            
            if (personagem && personagem.inventario && personagem.inventario.corpo) {
                personagem.inventario.corpo.forEach(item => {
                    if (item.tipo === 'escudo' || item.nome.toLowerCase().includes('escudo')) {
                        temEscudo = true;
                        bonusEscudo = item.bonus || 0;
                    }
                });
            }
            
            if (!temEscudo) return 0;
            
            const dx = getAtributoValor('dx');
            const periciaEscudo = getPericiaNivel('escudo');
            const nhEscudo = periciaEscudo > 0 ? calcularNH(dx, periciaEscudo) : dx;
            
            return Math.floor((nhEscudo + dx) / 4) + 6 + bonusEscudo;
        }

        function atualizarFichaPersonagem() {
            if (!personagem) return;
            
            // Nome e classe
            pcNome.textContent = personagem.nome || 'Sem nome';
            
            const classes = {
                guerreiro: 'Guerreiro',
                mago: 'Mago',
                ladino: 'Ladino',
                clerigo: 'Cl√©rigo',
                barbaro: 'B√°rbaro'
            };
            pcClasse.textContent = classes[personagem.classe] || personagem.classe || 'Aventureiro';
            
            // Avatar
            if (personagem.fotoURL) {
                pcAvatar.innerHTML = `<img src="${personagem.fotoURL}" alt="${personagem.nome}">`;
            }
            
            // PV
            const pvAtual = personagem.statusCombate?.vidaAtual || 
                            (personagem.status?.vidaMax || 48);
            const pvMax = personagem.statusCombate?.vidaMax || 
                         (personagem.status?.vidaMax || 48);
            pvTexto.textContent = `${pvAtual}/${pvMax}`;
            pvBarra.style.width = (pvAtual / pvMax * 100) + '%';
            
            // Fadiga
            const fadigaAtual = personagem.statusCombate?.fadigaAtual || 
                               (personagem.status?.fadigaMax || 8);
            const fadigaMax = personagem.statusCombate?.fadigaMax || 
                             (personagem.status?.fadigaMax || 8);
            fadigaTexto.textContent = `${fadigaAtual}/${fadigaMax}`;
            fadigaBarra.style.width = (fadigaAtual / fadigaMax * 100) + '%';
            
            // Mana
            const manaAtual = personagem.statusCombate?.manaAtual || 
                            (personagem.status?.manaMax || 13);
            const manaMax = personagem.statusCombate?.manaMax || 
                          (personagem.status?.manaMax || 13);
            manaTexto.textContent = `${manaAtual}/${manaMax}`;
            manaBarra.style.width = (manaAtual / manaMax * 100) + '%';
            
            // Atributos
            const st = getAtributoValor('st');
            const dx = getAtributoValor('dx');
            const iq = getAtributoValor('iq');
            const ht = getAtributoValor('ht');
            
            atributosGrid.innerHTML = `
                <div class="atributo-card">
                    <div class="atributo-nome">ST</div>
                    <div class="atributo-valor">${st}</div>
                </div>
                <div class="atributo-card">
                    <div class="atributo-nome">DX</div>
                    <div class="atributo-valor">${dx}</div>
                </div>
                <div class="atributo-card">
                    <div class="atributo-nome">IQ</div>
                    <div class="atributo-valor">${iq}</div>
                </div>
                <div class="atributo-card">
                    <div class="atributo-nome">HT</div>
                    <div class="atributo-valor">${ht}</div>
                </div>
            `;
            
            // Defesas
            defesasGrid.innerHTML = `
                <div class="defesa-card">
                    <div class="defesa-valor">${calcularEsquiva()}</div>
                    <div class="defesa-label">Esquiva</div>
                </div>
                <div class="defesa-card">
                    <div class="defesa-valor">${calcularAparar()}</div>
                    <div class="defesa-label">Aparar</div>
                </div>
                <div class="defesa-card">
                    <div class="defesa-valor">${calcularBloqueio()}</div>
                    <div class="defesa-label">Bloqueio</div>
                </div>
            `;
            
            // Vantagens
            if (personagem.vantagens && personagem.vantagens.length > 0) {
                vantagensLista.innerHTML = personagem.vantagens.map(v => 
                    `<span class="vantagem-tag">${v}</span>`
                ).join('');
            } else {
                vantagensLista.innerHTML = '<span style="color: rgba(255,255,255,0.5);">Nenhuma</span>';
            }
            
            // Desvantagens
            if (personagem.desvantagens && personagem.desvantagens.length > 0) {
                desvantagensLista.innerHTML = personagem.desvantagens.map(d => 
                    `<span class="vantagem-tag" style="border-color: #ff6b6b; color: #ff6b6b;">${d}</span>`
                ).join('');
            } else {
                desvantagensLista.innerHTML = '<span style="color: rgba(255,255,255,0.5);">Nenhuma</span>';
            }
            
            // Dinheiro e XP
            dinheiroValor.textContent = personagem.dinheiro || 0;
            xpValor.textContent = personagem.xp || 0;
        }

        function atualizarTurnoIndicator() {
            if (turnoAtual === 'jogador') {
                turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
                turnoIndicator.className = 'turno-indicator jogador';
            } else {
                turnoIndicator.innerHTML = '<i class="fas fa-skull"></i> TURNO DOS INIMIGOS';
                turnoIndicator.className = 'turno-indicator inimigo';
            }
        }

        function renderizarInimigos() {
            if (inimigos.length === 0) {
                inimigosContainer.style.display = 'none';
                return;
            }
            
            inimigosContainer.style.display = 'block';
            
            inimigosGrid.innerHTML = inimigos.map((inimigo, index) => `
                <div class="inimigo-card ${inimigoSelecionado === index ? 'selecionado' : ''}" data-index="${index}">
                    <div class="inimigo-nome">${inimigo.nome}</div>
                    <div class="inimigo-pv">
                        <div class="inimigo-pv-fill" style="width: ${(inimigo.pv / inimigo.pv_max) * 100}%"></div>
                    </div>
                    <div style="font-size:0.8rem; text-align:center;">${inimigo.pv}/${inimigo.pv_max} PV</div>
                    <div style="font-size:0.7rem; color: #ffd700; text-align:center; margin-top:5px;">
                        Defesa ${inimigo.dados?.defesa || 8}
                    </div>
                </div>
            `).join('');
            
            // Adicionar evento de sele√ß√£o
            document.querySelectorAll('.inimigo-card').forEach(card => {
                card.addEventListener('click', () => {
                    const index = parseInt(card.dataset.index);
                    selecionarInimigo(index);
                });
            });
        }

        function selecionarInimigo(index) {
            if (turnoAtual !== 'jogador') {
                adicionarLog('‚ùå N√£o √© seu turno!', 'erro');
                return;
            }
            
            inimigoSelecionado = index;
            renderizarInimigos();
            
            // Habilitar bot√£o de ataque
            const btnAtacar = document.getElementById('btnAtacarAcao');
            if (btnAtacar) {
                btnAtacar.disabled = false;
            }
        }

        function renderizarAcoes() {
            let html = '';
            
            if (turnoAtual === 'jogador') {
                html = `
                    <button class="acao-btn atacar" id="btnAtacarAcao" ${inimigos.length === 0 ? 'disabled' : ''}>
                        <i class="fas fa-sword"></i> Atacar
                    </button>
                    <button class="acao-btn magia" id="btnMagiaAcao">
                        <i class="fas fa-magic"></i> Usar Magia
                    </button>
                    <button class="acao-btn" id="btnItemAcao">
                        <i class="fas fa-flask"></i> Usar Item
                    </button>
                    <button class="acao-btn" id="btnPassarAcao">
                        <i class="fas fa-hourglass-end"></i> Passar Turno
                    </button>
                `;
            } else {
                html = `
                    <button class="acao-btn" disabled style="opacity:0.5;">
                        <i class="fas fa-hourglass"></i> Aguarde... inimigos atacando
                    </button>
                `;
            }
            
            acoesContainer.innerHTML = html;
            
            // Adicionar eventos
            if (turnoAtual === 'jogador') {
                document.getElementById('btnAtacarAcao')?.addEventListener('click', abrirModalAtaque);
                document.getElementById('btnMagiaAcao')?.addEventListener('click', () => {
                    adicionarLog('üîÆ Sistema de magias em desenvolvimento...', 'info');
                });
                document.getElementById('btnItemAcao')?.addEventListener('click', () => {
                    adicionarLog('üéí Sistema de itens em desenvolvimento...', 'info');
                });
                document.getElementById('btnPassarAcao')?.addEventListener('click', passarTurno);
            }
        }

        function abrirModalAtaque() {
            if (inimigoSelecionado === null) {
                adicionarLog('‚ùå Selecione um inimigo primeiro!', 'erro');
                return;
            }
            
            const armas = getArmasEquipadas();
            
            if (armas.length === 0) {
                adicionarLog('‚ùå Voc√™ n√£o tem armas equipadas!', 'erro');
                return;
            }
            
            armaSelecionada = null;
            btnConfirmarAtaque.disabled = true;
            
            armasLista.innerHTML = armas.map((arma, index) => {
                const periciaNivel = getPericiaNivel(arma.periciaId);
                const dx = getAtributoValor('dx');
                const nh = periciaNivel > 0 ? calcularNH(dx, periciaNivel) : dx;
                
                return `
                    <div class="arma-card" data-index="${index}">
                        <div class="arma-nome">${arma.nome}</div>
                        <div class="arma-detalhes">
                            <span><i class="fas fa-tint"></i> Dano: ${arma.dano}</span>
                            <span><i class="fas fa-ruler"></i> Alcance: ${arma.alcance}m</span>
                            <span><i class="fas fa-bullseye"></i> NH: ${nh}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('.arma-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.arma-card').forEach(c => c.classList.remove('selecionada'));
                    card.classList.add('selecionada');
                    armaSelecionada = parseInt(card.dataset.index);
                    btnConfirmarAtaque.disabled = false;
                });
            });
            
            modalAtaque.classList.add('active');
        }

        function executarAtaque() {
            if (armaSelecionada === null) return;
            
            const armas = getArmasEquipadas();
            const arma = armas[armaSelecionada];
            const inimigo = inimigos[inimigoSelecionado];
            
            if (!arma || !inimigo) return;
            
            // Fechar modal
            modalAtaque.classList.remove('active');
            
            // Calcular NH do ataque
            const periciaNivel = getPericiaNivel(arma.periciaId);
            const dx = getAtributoValor('dx');
            const nhAtaque = periciaNivel > 0 ? calcularNH(dx, periciaNivel) : dx;
            
            // Rolar ataque (2d10)
            const rolagem = rolar2d10();
            const totalAtaque = rolagem.total;
            
            adicionarLog(`üéØ Rolagem de ataque: ${rolagem.texto} (NH ${nhAtaque})`, 'info');
            
            // Verificar se acertou (NH √© a dificuldade para rolar abaixo ou igual)
            if (totalAtaque <= nhAtaque) {
                // ACERTOU!
                adicionarLog(`‚úÖ Acertou! Rolou ${totalAtaque} vs NH ${nhAtaque}`, 'sucesso');
                
                // Verificar se √© cr√≠tico (fulminante) - rolar 2, 3 ou 4?
                const ehCritico = totalAtaque <= 4; // Regra: 2-4 √© cr√≠tico
                
                // Calcular dano
                let dano = calcularDanoArma(arma);
                let danoTexto = dano.toString();
                
                if (ehCritico) {
                    dano *= 2;
                    danoTexto = `${dano} (CR√çTICO! Dano dobrado)`;
                    adicionarLog(`‚ö° FULMINANTE! Dano dobrado!`, 'sucesso');
                }
                
                adicionarLog(`üí• Dano causado: ${danoTexto}`, 'dano');
                
                // Aplicar dano
                inimigo.pv -= dano;
                
                if (inimigo.pv <= 0) {
                    adicionarLog(`üíÄ ${inimigo.nome} foi derrotado!`, 'sucesso');
                    inimigos = inimigos.filter((_, i) => i !== inimigoSelecionado);
                    inimigoSelecionado = null;
                }
                
                renderizarInimigos();
                
                // Verificar se combate acabou
                if (inimigos.length === 0) {
                    adicionarLog('üéâ VIT√ìRIA! Todos os inimigos foram derrotados!', 'sucesso');
                    setTimeout(() => {
                        if (capituloAtual?.vitoria) {
                            iniciarCapitulo(capituloAtual.vitoria);
                        }
                    }, 2000);
                    return;
                }
                
                // Passar para o turno dos inimigos
                passarTurno();
                
            } else {
                // ERROU!
                adicionarLog(`‚ùå Errou! Rolou ${totalAtaque} vs NH ${nhAtaque}`, 'erro');
                
                // Passar para o turno dos inimigos
                passarTurno();
            }
            
            atualizarFichaPersonagem();
        }

        function calcularDanoArma(arma) {
            // Interpreta string de dano tipo "1d6+2"
            const formula = arma.dano.toLowerCase();
            
            // Extrai dados e modificador
            const match = formula.match(/(\d+)d(\d+)(?:\s*([+-])\s*(\d+))?/);
            
            if (!match) return 1; // Padr√£o
            
            const qtdDados = parseInt(match[1]) || 1;
            const faces = parseInt(match[2]) || 6;
            const operador = match[3];
            const modValor = parseInt(match[4]) || 0;
            
            let dano = 0;
            for (let i = 0; i < qtdDados; i++) {
                dano += Math.floor(Math.random() * faces) + 1;
            }
            
            if (operador === '+') dano += modValor;
            if (operador === '-') dano -= modValor;
            
            return Math.max(1, dano); // M√≠nimo 1
        }

        function passarTurno() {
            if (turnoAtual === 'jogador') {
                turnoAtual = 'inimigo';
                atualizarTurnoIndicator();
                renderizarAcoes();
                
                // Iniciar turno dos inimigos
                setTimeout(turnoInimigos, 1000);
            }
        }

        function turnoInimigos() {
            if (inimigos.length === 0) {
                // Sem inimigos, volta para o jogador
                turnoAtual = 'jogador';
                atualizarTurnoIndicator();
                renderizarAcoes();
                return;
            }
            
            adicionarLog('üëæ Turno dos inimigos!', 'info');
            
            // Fila de ataques dos inimigos
            let inimigosVivos = [...inimigos];
            
            function atacarProximoInimigo() {
                if (inimigosVivos.length === 0 || personagem.statusCombate?.vidaAtual <= 0) {
                    // Acabaram os ataques ou personagem morreu
                    turnoAtual = 'jogador';
                    atualizarTurnoIndicator();
                    renderizarAcoes();
                    return;
                }
                
                const inimigo = inimigosVivos.shift();
                
                adicionarLog(`‚öîÔ∏è ${inimigo.nome} vai atacar!`, 'info');
                
                // Salvar dados do ataque para o modal de defesa
                ataqueAtual = {
                    inimigo: inimigo,
                    danoBase: inimigo.equipamento?.arma?.dano || '1d4',
                    tipo: inimigo.equipamento?.arma?.tipo || 'contusao'
                };
                
                // Abrir modal para o jogador escolher defesa
                abrirModalDefesa(inimigo);
            }
            
            atacarProximoInimigo();
        }

        function abrirModalDefesa(inimigo) {
            defesaSelecionada = null;
            btnConfirmarDefesa.disabled = true;
            
            defesaContexto.textContent = `${inimigo.nome} est√° atacando voc√™! Escolha como defender:`;
            
            const esquiva = calcularEsquiva();
            const aparar = calcularAparar();
            const bloqueio = calcularBloqueio();
            
            defesasLista.innerHTML = `
                <div class="defesa-card-modal" data-defesa="esquiva">
                    <div style="font-weight:bold; color:#ffd700; margin-bottom:5px;">Esquiva</div>
                    <div style="font-size:0.9rem;">NH: ${esquiva}</div>
                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.7);">Baseado em DX + HT</div>
                </div>
                
                <div class="defesa-card-modal ${aparar === 0 ? 'disabled' : ''}" data-defesa="aparar">
                    <div style="font-weight:bold; color:#ffd700; margin-bottom:5px;">Aparar</div>
                    <div style="font-size:0.9rem;">NH: ${aparar}</div>
                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.7);">${aparar === 0 ? 'Precisa de arma' : 'Baseado em per√≠cia'}</div>
                </div>
                
                <div class="defesa-card-modal ${bloqueio === 0 ? 'disabled' : ''}" data-defesa="bloqueio">
                    <div style="font-weight:bold; color:#ffd700; margin-bottom:5px;">Bloqueio</div>
                    <div style="font-size:0.9rem;">NH: ${bloqueio}</div>
                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.7);">${bloqueio === 0 ? 'Precisa de escudo' : 'Baseado em per√≠cia Escudo'}</div>
                </div>
            `;
            
            document.querySelectorAll('.defesa-card-modal').forEach(card => {
                card.addEventListener('click', () => {
                    if (card.classList.contains('disabled')) return;
                    
                    document.querySelectorAll('.defesa-card-modal').forEach(c => c.classList.remove('selecionada'));
                    card.classList.add('selecionada');
                    defesaSelecionada = card.dataset.defesa;
                    btnConfirmarDefesa.disabled = false;
                });
            });
            
            modalDefesa.classList.add('active');
        }

        function executarDefesa() {
            if (!defesaSelecionada || !ataqueAtual) return;
            
            modalDefesa.classList.remove('active');
            
            const inimigo = ataqueAtual.inimigo;
            
            // Calcular NH da defesa escolhida
            let nhDefesa = 0;
            
            switch(defesaSelecionada) {
                case 'esquiva':
                    nhDefesa = calcularEsquiva();
                    break;
                case 'aparar':
                    nhDefesa = calcularAparar();
                    break;
                case 'bloqueio':
                    nhDefesa = calcularBloqueio();
                    break;
            }
            
            // Rolar defesa (2d10)
            const rolagem = rolar2d10();
            const totalDefesa = rolagem.total;
            
            adicionarLog(`üõ°Ô∏è Defesa (${defesaSelecionada}): ${rolagem.texto} (NH ${nhDefesa})`, 'info');
            
            if (totalDefesa <= nhDefesa) {
                // DEFENDEU!
                adicionarLog(`‚úÖ Voc√™ defendeu o ataque de ${inimigo.nome}!`, 'sucesso');
            } else {
                // FOI ATINGIDO!
                adicionarLog(`‚ùå Falhou na defesa!`, 'erro');
                
                // Calcular dano do inimigo
                const dano = calcularDanoInimigo(inimigo);
                adicionarLog(`üí• Dano recebido: ${dano}`, 'dano');
                
                // Aplicar dano
                personagem.statusCombate.vidaAtual -= dano;
                
                if (personagem.statusCombate.vidaAtual <= 0) {
                    adicionarLog('üíÄ VOC√ä MORREU!', 'erro');
                    if (capituloAtual?.derrota) {
                        setTimeout(() => iniciarCapitulo(capituloAtual.derrota), 2000);
                    }
                    return;
                }
                
                atualizarFichaPersonagem();
            }
            
            // Continuar com pr√≥ximo inimigo
            ataqueAtual = null;
            setTimeout(turnoInimigos, 1000);
        }

        function calcularDanoInimigo(inimigo) {
            // Dano base do inimigo
            const formula = inimigo.equipamento?.arma?.dano || '1d4';
            
            const match = formula.match(/(\d+)d(\d+)(?:\s*([+-])\s*(\d+))?/);
            
            if (!match) return 1;
            
            const qtdDados = parseInt(match[1]) || 1;
            const faces = parseInt(match[2]) || 4;
            
            let dano = 0;
            for (let i = 0; i < qtdDados; i++) {
                dano += Math.floor(Math.random() * faces) + 1;
            }
            
            return Math.max(1, dano);
        }

        // ========== CARREGAR PERSONAGEM ==========
        
        async function carregarPersonagem(personagemId) {
            try {
                const personagemRef = doc(db, "personagens", personagemId);
                const personagemSnap = await getDoc(personagemRef);
                
                if (!personagemSnap.exists()) {
                    throw new Error('Personagem n√£o encontrado');
                }
                
                personagem = {
                    id: personagemSnap.id,
                    ...personagemSnap.data()
                };
                
                // Garantir que statusCombate existe
                if (!personagem.statusCombate) {
                    const pv = (personagem.atributos?.ht?.valor || 8) * 8;
                    const fadiga = 8 + (personagem.atributos?.ht?.bolinhas || 0);
                    const mana = fadiga + (personagem.atributos?.iq?.valor || 5);
                    
                    personagem.statusCombate = {
                        vidaAtual: pv,
                        vidaMax: pv,
                        fadigaAtual: fadiga,
                        fadigaMax: fadiga,
                        manaAtual: mana,
                        manaMax: mana
                    };
                }
                
                atualizarFichaPersonagem();
                
            } catch (error) {
                console.error('Erro ao carregar personagem:', error);
                adicionarLog('‚ùå Erro ao carregar personagem!', 'erro');
            }
        }

        // ========== CARREGAR HIST√ìRIA ==========
        
        async function carregarHistoria(historiaId) {
            try {
                // Tenta carregar do arquivo JS correspondente
                const module = await import(`./${historiaId}.js`);
                historia = module.default || module.HISTORIA;
                
                if (!historia) {
                    throw new Error('Hist√≥ria n√£o encontrada');
                }
                
                aventuraTitulo.textContent = historia.nome;
                
                // Inicia no primeiro cap√≠tulo
                iniciarCapitulo(historia.cap√≠tulos[0].id);
                
            } catch (error) {
                console.error('Erro ao carregar hist√≥ria:', error);
                
                // Fallback para teste
                aventuraTitulo.textContent = 'Masmorra dos Goblins';
                narrativaTexto.textContent = 'Voc√™ est√° na entrada de uma masmorra escura...';
                
                // Inimigos de teste
                inimigos = [
                    {
                        id: 'goblin1',
                        nome: 'Goblin Guarda',
                        pv: 12,
                        pv_max: 12,
                        dados: {
                            defesa: 8
                        },
                        equipamento: {
                            arma: {
                                nome: 'Espada Curta',
                                dano: '1d6',
                                tipo: 'corte'
                            }
                        }
                    }
                ];
                
                turnoAtual = 'jogador';
                renderizarInimigos();
                renderizarAcoes();
                atualizarTurnoIndicator();
            }
        }

        function iniciarCapitulo(capituloId) {
            if (!historia) return;
            
            const capitulo = historia.cap√≠tulos.find(c => c.id === capituloId);
            if (!capitulo) return;
            
            capituloAtual = capitulo;
            
            narrativaTexto.textContent = capitulo.texto || '...';
            
            if (capitulo.tipo === 'combate' && capitulo.inimigos) {
                inimigos = capitulo.inimigos.map(i => ({...i}));
                turnoAtual = 'jogador';
                renderizarInimigos();
                renderizarAcoes();
                atualizarTurnoIndicator();
            } else if (capitulo.tipo === 'narrativa' && capitulo.opcoes) {
                // Renderizar op√ß√µes narrativas
                let opcoesHtml = '';
                capitulo.opcoes.forEach(opcao => {
                    opcoesHtml += `
                        <button class="acao-btn" data-proximo="${opcao.proximo}">
                            <i class="fas fa-arrow-right"></i> ${opcao.texto}
                        </button>
                    `;
                });
                
                acoesContainer.innerHTML = opcoesHtml;
                
                document.querySelectorAll('[data-proximo]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        iniciarCapitulo(btn.dataset.proximo);
                    });
                });
            }
        }

        async function criarSessao() {
            const urlParams = new URLSearchParams(window.location.search);
            const aventuraId = urlParams.get('aventura');
            const personagemId = urlParams.get('personagem');
            
            if (!aventuraId || !personagemId) {
                alert('Aventura ou personagem n√£o selecionado!');
                window.location.href = 'aventura-solo.html';
                return;
            }
            
            showLoading();
            
            try {
                await carregarPersonagem(personagemId);
                await carregarHistoria(aventuraId);
                
                // Cria sess√£o no Firebase
                const sessaoRef = doc(collection(db, "sessoes_aventura"));
                sessaoId = sessaoRef.id;
                
                await setDoc(sessaoRef, {
                    id: sessaoId,
                    userId: currentUser.uid,
                    personagem_id: personagemId,
                    aventura_id: aventuraId,
                    pc_atual: personagem,
                    inimigos: inimigos,
                    capitulo_atual: "entrada",
                    data_inicio: new Date().toISOString(),
                    ultima_sessao: new Date().toISOString(),
                    status: "em_andamento"
                });
                
            } catch (error) {
                console.error('Erro ao iniciar sess√£o:', error);
                alert('Erro ao iniciar aventura!');
            } finally {
                hideLoading();
            }
        }

        // ========== EVENT LISTENERS ==========
        
        btnCancelarAtaque.addEventListener('click', () => {
            modalAtaque.classList.remove('active');
        });
        
        btnConfirmarAtaque.addEventListener('click', executarAtaque);
        
        btnCancelarDefesa.addEventListener('click', () => {
            modalDefesa.classList.remove('active');
        });
        
        btnConfirmarDefesa.addEventListener('click', executarDefesa);
        
        btnAbrirDados.addEventListener('click', () => {
            modalDados.classList.add('active');
        });
        
        btnFecharDados.addEventListener('click', () => {
            modalDados.classList.remove('active');
        });
        
        btnRolarDados.addEventListener('click', () => {
            const qtd = parseInt(dadosQtd.value) || 1;
            const faces = parseInt(dadosFaces.value) || 10;
            const mod = parseInt(dadosMod.value) || 0;
            
            const resultado = rolarDados(qtd, faces, mod);
            dadosResultado.textContent = resultado.texto;
            adicionarLog(`üé≤ Rolagem: ${resultado.texto}`, 'info');
        });
        
        btnPericias.addEventListener('click', () => {
            adicionarLog('üìö Per√≠cias dispon√≠veis', 'info');
        });
        
        btnMagias.addEventListener('click', () => {
            adicionarLog('üîÆ Sistema de magias em desenvolvimento', 'info');
        });
        
        btnInventario.addEventListener('click', () => {
            adicionarLog('üéí Abrindo invent√°rio...', 'info');
        });
        
        btnDescansar.addEventListener('click', () => {
            if (personagem.statusCombate.vidaAtual < personagem.statusCombate.vidaMax) {
                const cura = Math.min(5, personagem.statusCombate.vidaMax - personagem.statusCombate.vidaAtual);
                personagem.statusCombate.vidaAtual += cura;
                atualizarFichaPersonagem();
                adicionarLog(`üí§ Voc√™ descansou e recuperou ${cura} PV`, 'sucesso');
            } else {
                adicionarLog('üí§ Voc√™ j√° est√° com vida cheia', 'info');
            }
        });

        // Auth
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await criarSessao();
            } else {
                window.location.href = 'index.html';
            }
        });

        // Fechar modais com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                modalAtaque.classList.remove('active');
                modalDefesa.classList.remove('active');
                modalDados.classList.remove('active');
            }
        });
    </script>
</body>
</html>