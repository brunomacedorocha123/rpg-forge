<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Aventura - Modo Cl√°ssico - RPGForce</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
   <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #2a1a3a 100%);
        min-height: 100vh;
        color: #fff;
    }

    .magic-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
    }

    .magic-bg::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
        animation: pulse 8s ease-in-out infinite;
    }

    .magic-bg::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 80% 80%, rgba(198, 40, 40, 0.1) 0%, transparent 50%);
        animation: pulse 10s ease-in-out infinite reverse;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
    }

    .game-container {
        position: relative;
        z-index: 1;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* HEADER COM STATUS DO PERSONAGEM */
    .game-header {
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 2px solid #ffd700;
        padding: 8px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        z-index: 20;
    }

    .personagem-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .personagem-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #ffd700;
        overflow: hidden;
        background: #1a1a3a;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .personagem-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .personagem-nome {
        font-family: 'MedievalSharp', cursive;
        font-size: 1.2rem;
        color: #ffd700;
    }

    .status-bars {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .status-item {
        min-width: 140px;
    }

    .status-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
        margin-bottom: 3px;
    }

    .status-label i {
        color: #ffd700;
        margin-right: 5px;
    }

    .status-bar {
        height: 10px;
        background: rgba(0,0,0,0.5);
        border-radius: 5px;
        overflow: hidden;
        border: 1px solid rgba(255,215,0,0.3);
    }

    .status-fill {
        height: 100%;
        transition: width 0.3s;
    }

    .status-fill.vida { background: linear-gradient(90deg, #ff4d4d, #ff1a1a); }
    .status-fill.mana { background: linear-gradient(90deg, #4d4dff, #1a1aff); }
    .status-fill.fadiga { background: linear-gradient(90deg, #ffaa00, #ff8800); }
    .status-fill.xp { background: linear-gradient(90deg, #4CAF50, #8BC34A); }

    .pm-display {
        background: linear-gradient(45deg, #9c27b0, #673ab7);
        padding: 5px 15px;
        border-radius: 30px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #ffd700;
    }

    .pm-display i { color: #ffd700; }

    /* √ÅREA PRINCIPAL - TR√äS COLUNAS */
    .main-area {
        flex: 1;
        display: flex;
        overflow: hidden;
        min-height: 0;
    }

    /* COLUNA ESQUERDA - FICHA DO PERSONAGEM */
    .ficha-coluna {
        width: 300px;
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(10px);
        border-right: 2px solid rgba(255,215,0,0.3);
        padding: 15px;
        overflow-y: auto;
        z-index: 15;
    }

    .ficha-header {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255,215,0,0.2);
    }

    .ficha-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 3px solid #ffd700;
        margin: 0 auto 10px;
        overflow: hidden;
        background: #1a1a3a;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ficha-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .ficha-nome {
        font-size: 1.2rem;
        font-weight: bold;
        color: #ffd700;
        font-family: 'MedievalSharp', cursive;
    }

    .ficha-classe {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.6);
    }

    /* INDICADOR DE N√çVEL DO PERSONAGEM (NOVO) */
    .nivel-indicator {
        background: linear-gradient(45deg, #4a2a6a, #2a1a4a);
        border: 2px solid #ffd700;
        border-radius: 30px;
        padding: 10px 15px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }

    .nivel-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #ffd700;
        font-weight: bold;
    }

    .nivel-info i {
        font-size: 1.2rem;
    }

    .nivel-valor {
        background: #ffd700;
        color: #0a0a1a;
        padding: 5px 15px;
        border-radius: 30px;
        font-size: 1.5rem;
        font-weight: bold;
        font-family: 'MedievalSharp', cursive;
        min-width: 50px;
        text-align: center;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    /* INDICADOR DE ATO */
    .ato-indicator {
        background: rgba(255,215,0,0.2);
        border-left: 4px solid #ffd700;
        padding: 5px 15px;
        font-family: 'MedievalSharp', cursive;
        font-size: 1rem;
        color: #ffd700;
        text-shadow: 0 0 10px rgba(255,215,0,0.5);
        margin: 10px 0;
    }
    
    .ato-indicator i {
        margin-right: 8px;
        color: #ffaa00;
    }

    /* BOLINHAS DISPON√çVEIS */
    .bolinhas-saldo {
        background: linear-gradient(45deg, #4CAF50, #2E7D32);
        border-radius: 30px;
        padding: 12px 15px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: bold;
        border: 2px solid #ffd700;
        box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
    }

    .bolinhas-saldo i {
        color: #ffd700;
        margin-right: 8px;
    }

    .bolinhas-saldo .valor {
        background: #ffd700;
        color: #0a0a1a;
        padding: 5px 15px;
        border-radius: 30px;
        font-size: 1.3rem;
        font-weight: bold;
        min-width: 50px;
        text-align: center;
    }

    /* ATRIBUTOS */
    .atributos-container {
        margin: 15px 0;
    }

    .atributo-card {
        background: rgba(0,0,0,0.3);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid rgba(255,215,0,0.2);
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .atributo-card:hover {
        background: rgba(255,215,0,0.1);
        transform: translateX(5px);
    }

    .atributo-card.bolinha-disponivel {
        border-color: #4CAF50;
        animation: pulseVerde 1.5s infinite;
        background: rgba(76,175,80,0.1);
    }

    @keyframes pulseVerde {
        0% { box-shadow: 0 0 0 0 rgba(76,175,80,0.7); }
        70% { box-shadow: 0 0 0 10px rgba(76,175,80,0); }
        100% { box-shadow: 0 0 0 0 rgba(76,175,80,0); }
    }

    .atributo-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .atributo-nome {
        font-weight: bold;
        color: #ffd700;
        width: 40px;
    }

    .atributo-bolinhas {
        display: flex;
        gap: 2px;
    }

    .bolinha-pequena {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(255,215,0,0.2);
        border: 1px solid rgba(255,215,0,0.3);
    }

    .bolinha-pequena.preenchida {
        background: #ffd700;
    }

    .atributo-valor {
        font-weight: bold;
        font-size: 1.2rem;
        color: #ffd700;
    }

    .atributo-base {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
    }

    /* DEFESAS */
    .defesas-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
        margin: 15px 0;
    }

    .defesa-card {
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        padding: 8px;
        text-align: center;
        border: 1px solid rgba(255,215,0,0.2);
    }

    .defesa-valor {
        font-size: 1.2rem;
        font-weight: bold;
        color: #ffd700;
    }

    .defesa-label {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.6);
    }

    /* BOT√ïES DE FICHA */
    .ficha-botoes {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin: 15px 0;
    }

    .ficha-botao {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.3);
        border-radius: 10px;
        padding: 12px 5px;
        color: #ffd700;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }

    .ficha-botao i {
        font-size: 1.2rem;
    }

    .ficha-botao:hover {
        background: rgba(255,215,0,0.2);
        border-color: #ffd700;
        transform: translateY(-3px);
    }

    .ficha-botao .contador {
        background: #ffd700;
        color: #0a0a1a;
        border-radius: 30px;
        padding: 2px 8px;
        font-size: 0.7rem;
        margin-top: 2px;
    }

    /* COLUNA CENTRAL - CEN√ÅRIO */
    .cenario-coluna {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background: rgba(0,0,0,0.5);
    }

    .cenario-area {
        flex: 1;
        position: relative;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-color: #1a1a3a;
        min-height: 0;
    }

    .cenario-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, rgba(0,0,0,0.3) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.3) 100%);
        pointer-events: none;
    }

    .npcs-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
    }

    /* NPCs */
    .npc-sprite {
        position: absolute;
        transform: translate(-50%, -50%);
        cursor: pointer;
        pointer-events: auto;
        transition: all 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.2);
        filter: drop-shadow(0 10px 8px rgba(0, 0, 0, 0.5));
        z-index: 10;
    }

    .npc-sprite:hover {
        transform: translate(-50%, -60%) scale(1.08);
        filter: drop-shadow(0 15px 15px rgba(255, 215, 0, 0.3));
        z-index: 100;
    }

    .npc-sprite img {
        width: 150px;
        height: 200px;
        object-fit: cover;
        object-position: center;
        border: none !important;
        background: transparent !important;
        background-color: transparent !important;
        box-shadow: none !important;
        outline: none !important;
        display: block;
        transition: all 0.3s ease;
    }

    .npc-sprite .npc-nome {
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%);
        background: #000000;
        color: #ffd700;
        padding: 6px 20px;
        border-radius: 40px;
        font-size: 0.95rem;
        font-weight: bold;
        white-space: nowrap;
        border: 2px solid #ffd700;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.8);
        letter-spacing: 1.5px;
        font-family: 'MedievalSharp', cursive;
        z-index: 30;
        pointer-events: none;
        text-shadow: 0 2px 4px #000000;
        opacity: 1;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
    }

    /* CAIXA DE DI√ÅLOGO */
    .dialogo-area {
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(10px);
        border-top: 2px solid rgba(255,215,0,0.3);
        padding: 15px 20px;
        min-height: 120px;
        max-height: 200px;
        overflow-y: auto;
    }

    .npc-falando {
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .npc-falando img {
        display: none;
    }

    .dialogo-texto {
        color: rgba(255,255,255,0.9);
        line-height: 1.5;
        margin-bottom: 10px;
        font-style: italic;
        padding-left: 10px;
        border-left: 3px solid #ffd700;
    }

    .opcoes-dialogo {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .opcao-btn {
        background: rgba(255,215,0,0.1);
        border: 1px solid #ffd700;
        color: #fff;
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
    }

    .opcao-btn:hover {
        background: #ffd700;
        color: #0a0a1a;
    }

    /* COLUNA DIREITA - A√á√ïES */
    .acoes-coluna {
        width: 280px;
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(10px);
        border-left: 2px solid rgba(255,215,0,0.3);
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .turno-indicator {
        background: rgba(76,175,80,0.2);
        border: 1px solid #4CAF50;
        color: #4CAF50;
        padding: 10px;
        border-radius: 10px;
        text-align: center;
        font-weight: bold;
    }

    .turno-indicator.inimigo {
        background: rgba(255,87,34,0.2);
        border-color: #ff5722;
        color: #ff5722;
    }

    .acoes-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }

    .acao-btn {
        background: rgba(255,215,0,0.1);
        border: 1px solid #ffd700;
        color: #ffd700;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        font-size: 0.9rem;
    }

    .acao-btn:hover:not(:disabled) {
        background: #ffd700;
        color: #0a0a1a;
    }

    .acao-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .acao-btn.atacar {
        border-color: #ff6b6b;
        color: #ff6b6b;
    }

    .acao-btn.magia {
        border-color: #4d4dff;
        color: #4d4dff;
    }

    .acao-btn.defender {
        border-color: #4CAF50;
        color: #4CAF50;
    }

    /* INIMIGOS */
    .inimigos-lista {
        background: rgba(255,0,0,0.1);
        border: 1px solid #ff6b6b;
        border-radius: 10px;
        padding: 10px;
        max-height: 200px;
        overflow-y: auto;
    }

    .inimigo-mini {
        background: rgba(0,0,0,0.3);
        border: 1px solid #ff6b6b;
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .inimigo-mini:hover {
        background: rgba(255,107,107,0.2);
    }

    .inimigo-mini.selecionado {
        border: 2px solid #ffd700;
    }

    .inimigo-mini-nome {
        color: #ff6b6b;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .inimigo-mini-pv {
        height: 4px;
        background: rgba(0,0,0,0.3);
        border-radius: 2px;
        margin: 5px 0;
    }

    .inimigo-mini-pv-fill {
        height: 100%;
        background: #ff6b6b;
        width: 100%;
    }

    /* LOG */
    .log-container {
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        padding: 8px;
        max-height: 120px;
        overflow-y: auto;
        font-size: 0.8rem;
    }

    .log-item {
        padding: 3px 0;
        border-bottom: 1px solid rgba(255,215,0,0.1);
    }

    .log-item.sucesso { color: #4CAF50; }
    .log-item.erro { color: #ff6b6b; }
    .log-item.dano { color: #ff5722; }

    /* MODAIS */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: #1a1a3a;
        border: 2px solid #ffd700;
        border-radius: 20px;
        padding: 25px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-content h3 {
        color: #ffd700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* MODAL DE ESCOLHA DE ATRIBUTO */
    .atributo-opcao {
        background: rgba(0,0,0,0.3);
        border: 2px solid #ffd700;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .atributo-opcao:hover {
        background: rgba(255,215,0,0.2);
        transform: translateX(10px);
    }

    .atributo-opcao .icone {
        width: 50px;
        height: 50px;
        background: rgba(255,215,0,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #ffd700;
    }

    .atributo-opcao .info {
        flex: 1;
    }

    .atributo-opcao .nome {
        font-size: 1.2rem;
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .atributo-opcao .descricao {
        color: rgba(255,255,255,0.7);
        font-size: 0.9rem;
    }

    .atributo-opcao .valor-atual {
        font-size: 1.1rem;
        color: #4CAF50;
        font-weight: bold;
    }

    /* MODAL DE INVENT√ÅRIO */
    .inventario-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 15px 0;
    }

    .inventario-coluna {
        background: rgba(0,0,0,0.3);
        border-radius: 12px;
        padding: 12px;
        max-height: 300px;
        overflow-y: auto;
    }

    .inventario-coluna h4 {
        color: #ffd700;
        margin-bottom: 10px;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 5px;
        position: sticky;
        top: 0;
        background: #1a1a3a;
        padding: 5px 0;
    }

    .item-card {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.3);
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }

    .item-card .nome {
        color: #ffd700;
        font-weight: bold;
    }

    .item-card .detalhes {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.6);
        margin-top: 3px;
    }

    .item-acoes {
        display: flex;
        gap: 5px;
        margin-top: 5px;
    }

    .item-acao {
        background: rgba(255,215,0,0.1);
        border: 1px solid #ffd700;
        color: #ffd700;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        cursor: pointer;
    }

    .item-acao:hover {
        background: #ffd700;
        color: #0a0a1a;
    }

    /* MODAL DE VANTAGENS */
    .vantagens-lista, .desvantagens-lista, .pericias-lista, .magias-lista {
        max-height: 400px;
        overflow-y: auto;
    }

    .vantagem-item, .desvantagem-item {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.2);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
    }

    .vantagem-item h4, .desvantagem-item h4 {
        color: #ffd700;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
    }

    .vantagem-item .tipo, .desvantagem-item .tipo {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
        background: rgba(255,215,0,0.2);
        padding: 2px 8px;
        border-radius: 10px;
    }

    .vantagem-item .descricao, .desvantagem-item .descricao {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
    }

    .badge-fobia {
        background: rgba(255,0,0,0.3);
        color: #ff6b6b;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        display: inline-block;
    }

    /* MODAL DE PER√çCIAS */
    .pericia-modal-item {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.2);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
    }

    .pericia-modal-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .pericia-modal-nome {
        color: #ffd700;
        font-weight: bold;
    }

    .pericia-modal-nivel {
        color: #4CAF50;
    }

    .pericia-modal-atributo {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
        margin-bottom: 5px;
    }

    .pericia-modal-bonus {
        font-size: 0.8rem;
        color: rgba(255,215,0,0.8);
    }

    .pericia-modal-nh {
        background: rgba(255,215,0,0.1);
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.9rem;
        margin-top: 5px;
        display: inline-block;
    }

    /* MODAL DE MAGIAS */
    .magia-escola-header {
        background: linear-gradient(45deg, #0a2a3a, #1a4a6a);
        border: 1px solid #4a9fff;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .simbolo-agua {
        width: 40px;
        height: 40px;
        background-image: url('agua1.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }

    .magia-escola-info h4 {
        color: #4a9fff;
        margin-bottom: 5px;
    }

    .magia-escola-info p {
        color: rgba(255,255,255,0.8);
        font-size: 0.9rem;
    }

    .magia-item {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(74,159,255,0.3);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
    }

    .magia-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .magia-nome {
        color: #4a9fff;
        font-weight: bold;
    }

    .magia-nivel {
        background: #ffd700;
        color: #0a0a1a;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
    }

    .magia-tipo {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
        margin-bottom: 5px;
    }

    .magia-efeito {
        font-size: 0.9rem;
        color: #ffd700;
        margin: 5px 0;
    }

    .magia-nh-info {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
        border-top: 1px solid rgba(255,215,0,0.2);
        padding-top: 5px;
        margin-top: 5px;
    }

    /* MODAL DE ATAQUE */
    .arma-card {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.3);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .arma-card:hover {
        background: rgba(255,215,0,0.1);
        border-color: #ffd700;
    }

    .arma-card.selecionada {
        background: rgba(255,215,0,0.2);
        border-color: #ffd700;
    }

    .arma-nome {
        font-weight: bold;
        color: #ffd700;
        margin-bottom: 5px;
    }

    .arma-detalhes {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.7);
        display: flex;
        gap: 15px;
    }

    /* MODAL DE DEFESA */
    .defesa-card-modal {
        background: rgba(0,0,0,0.3);
        border: 1px solid #4CAF50;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .defesa-card-modal:hover:not(.disabled) {
        background: rgba(76,175,80,0.2);
        border-color: #4CAF50;
    }

    .defesa-card-modal.disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .defesa-card-modal.selecionada {
        background: rgba(76,175,80,0.3);
        border-color: #4CAF50;
    }

    .modal-botoes {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-confirmar {
        background: #ffd700;
        color: #0a0a1a;
        border: none;
        padding: 10px 20px;
        border-radius: 30px;
        font-weight: bold;
        cursor: pointer;
        flex: 2;
    }

    .btn-cancelar {
        background: transparent;
        border: 2px solid #ff6b6b;
        color: #ff6b6b;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        flex: 1;
    }

    /* DADOS FLUTUANTES */
    .dados-flutuante {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 500;
    }

    .btn-dados {
        background: linear-gradient(45deg, #ffd700, #ffaa00);
        color: #0a0a1a;
        border: none;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.5rem;
        box-shadow: 0 5px 20px rgba(255,215,0,0.4);
        transition: all 0.3s;
    }

    .btn-dados:hover {
        transform: scale(1.1);
    }

    /* LOADING */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10,10,26,0.9);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 20px;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255,215,0,0.2);
        border-top-color: #ffd700;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* POSICIONAMENTO DOS NPCS */
    .npc-sprite[data-npcid="taverneiro"] { left: 85%; top: 60%; }
    .npc-sprite[data-npcid="homem_sangue"] { left: 25%; top: 50%; }
    .npc-sprite[data-npcid="camponesa"] { left: 40%; top: 55%; }
    .npc-sprite[data-npcid="menina_elfa"] { left: 50%; top: 60%; }
    .npc-sprite[data-npcid="chefe_goblin"] { left: 60%; top: 50%; }

    /* RESPONSIVIDADE */
    @media (max-width: 1200px) {
        .ficha-coluna { width: 260px; }
        .acoes-coluna { width: 240px; }
        .npc-sprite img {
            width: 120px;
            height: 160px;
        }
        .npc-sprite .npc-nome {
            font-size: 0.8rem;
            padding: 4px 15px;
            bottom: -30px;
        }
    }
</style>
</head>
<body>
    <div class="magic-bg"></div>

       <!-- LOADING -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando sua aventura...</div>
    </div>

    <!-- MODAL DE ESCOLHA DE ATRIBUTO (para bolinhas) -->
    <div class="modal" id="modalEscolhaAtributo">
        <div class="modal-content">
            <h3><i class="fas fa-star"></i> Voc√™ ganhou uma bolinha!</h3>
            <p style="margin-bottom: 20px; color: rgba(255,255,255,0.8);">
                Bolinhas dispon√≠veis: <strong id="bolinhasDisponiveisModal">0</strong>
            </p>
            
            <div class="atributo-opcao" data-atributo="st">
                <div class="icone"><i class="fas fa-fist-raised"></i></div>
                <div class="info">
                    <div class="nome">ST (For√ßa)</div>
                    <div class="descricao">Aumenta dano, carga e habilidades f√≠sicas</div>
                </div>
                <div class="valor-atual" id="valorStModal">0</div>
            </div>
            
            <div class="atributo-opcao" data-atributo="dx">
                <div class="icone"><i class="fas fa-running"></i></div>
                <div class="info">
                    <div class="nome">DX (Destreza)</div>
                    <div class="descricao">Aumenta esquiva, per√≠cias f√≠sicas e precis√£o</div>
                </div>
                <div class="valor-atual" id="valorDxModal">0</div>
            </div>
            
            <div class="atributo-opcao" data-atributo="iq">
                <div class="icone"><i class="fas fa-brain"></i></div>
                <div class="info">
                    <div class="nome">IQ (Intelig√™ncia)</div>
                    <div class="descricao">Aumenta vontade, per√≠cias mentais e magias</div>
                </div>
                <div class="valor-atual" id="valorIqModal">0</div>
            </div>
            
            <div class="atributo-opcao" data-atributo="ht">
                <div class="icone"><i class="fas fa-heart"></i></div>
                <div class="info">
                    <div class="nome">HT (Vigor)</div>
                    <div class="descricao">Aumenta PV, fadiga e resist√™ncia</div>
                </div>
                <div class="valor-atual" id="valorHtModal">0</div>
            </div>
            
            <div class="modal-botoes">
                <button class="btn-cancelar" id="cancelarEscolhaAtributo">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE INVENT√ÅRIO -->
    <div class="modal" id="modalInventario">
        <div class="modal-content" style="max-width: 900px;">
            <h3><i class="fas fa-backpack"></i> Invent√°rio do Personagem</h3>
            
            <div class="inventario-grid">
                <!-- Equipado -->
                <div class="inventario-coluna">
                    <h4><i class="fas fa-shield-alt"></i> Equipado</h4>
                    <div id="inventarioEquipado"></div>
                </div>
                
                <!-- Mochila -->
                <div class="inventario-coluna">
                    <h4><i class="fas fa-shopping-bag"></i> Mochila</h4>
                    <div id="inventarioMochila"></div>
                </div>
                
                <!-- Dep√≥sito -->
                <div class="inventario-coluna">
                    <h4><i class="fas fa-warehouse"></i> Dep√≥sito</h4>
                    <div id="inventarioDeposito"></div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                <span><i class="fas fa-coins"></i> Dinheiro: <strong style="color:#ffd700;" id="modalDinheiro">0</strong></span>
                <span><i class="fas fa-weight-hanging"></i> Carga: <strong style="color:#ffd700;" id="modalCarga">0/0 kg</strong></span>
            </div>
            
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalInventario">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE VANTAGENS -->
    <div class="modal" id="modalVantagens">
        <div class="modal-content">
            <h3><i class="fas fa-star"></i> Vantagens do Personagem</h3>
            <div class="vantagens-lista" id="vantagensLista"></div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalVantagens">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE DESVANTAGENS -->
    <div class="modal" id="modalDesvantagens">
        <div class="modal-content">
            <h3><i class="fas fa-skull"></i> Desvantagens do Personagem</h3>
            <div class="desvantagens-lista" id="desvantagensLista"></div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalDesvantagens">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE PER√çCIAS -->
    <div class="modal" id="modalPericias">
        <div class="modal-content" style="max-width: 600px;">
            <h3><i class="fas fa-brain"></i> Per√≠cias do Personagem</h3>
            <div class="pericias-lista" id="periciasLista"></div>
            <div style="margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px; text-align: center;">
                <span>PM: <strong style="color:#ffd700;" id="modalPM">0/0</strong></span>
            </div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalPericias">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE MAGIAS -->
    <div class="modal" id="modalMagias">
        <div class="modal-content" style="max-width: 600px;">
            <h3><i class="fas fa-magic"></i> Magias do Personagem</h3>
            
            <div class="magia-escola-header">
                <div class="simbolo-agua"></div>
                <div class="magia-escola-info">
                    <h4>Escola da √Ågua</h4>
                    <p>Aptid√£o M√°gica: <span id="modalAptidao">0</span></p>
                </div>
            </div>
            
            <div class="magias-lista" id="magiasLista"></div>
            
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalMagias">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE ATAQUE -->
    <div class="modal" id="modalAtaque">
        <div class="modal-content">
            <h3><i class="fas fa-sword"></i> Escolha sua Arma</h3>
            <div id="armasLista"></div>
            <div class="modal-botoes">
                <button class="btn-cancelar" id="btnCancelarAtaque">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirmar" id="btnConfirmarAtaque" disabled>
                    <i class="fas fa-check"></i> Atacar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE DEFESA -->
    <div class="modal" id="modalDefesa">
        <div class="modal-content">
            <h3><i class="fas fa-shield-alt"></i> Escolha sua Defesa</h3>
            <p id="defesaContexto" style="margin-bottom: 15px; color: rgba(255,255,255,0.8);"></p>
            <div id="defesasLista"></div>
            <div class="modal-botoes">
                <button class="btn-cancelar" id="btnCancelarDefesa">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirmar" id="btnConfirmarDefesa" disabled>
                    <i class="fas fa-check"></i> Defender
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE DADOS -->
    <div class="modal" id="modalDados">
        <div class="modal-content">
            <h3><i class="fas fa-dice-d20"></i> Rolagem de Dados</h3>
            
            <div style="display: flex; flex-direction: column; gap: 15px; margin: 20px 0;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Quantidade:</label>
                    <input type="number" id="dadosQtd" min="1" max="10" value="1" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 8px; border-radius: 8px; width: 100px;">
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Faces:</label>
                    <select id="dadosFaces" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 8px; border-radius: 8px; width: 100px;">
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10" selected>d10</option>
                        <option value="12">d12</option>
                        <option value="20">d20</option>
                        <option value="100">d100</option>
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Modificador:</label>
                    <input type="number" id="dadosMod" value="0" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 8px; border-radius: 8px; width: 100px;">
                </div>
            </div>
            
            <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 20px; text-align: center; font-size: 1.5rem; color: #ffd700; margin: 20px 0;" id="dadosResultado">
                Clique em Rolar
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn-cancelar" id="btnFecharDados" style="flex:1;">Fechar</button>
                <button class="btn-confirmar" id="btnRolarDados" style="flex:2;">Rolar</button>
            </div>
        </div>
    </div>

    <!-- Bot√£o flutuante de dados -->
    <div class="dados-flutuante">
        <button class="btn-dados" id="btnAbrirDados">
            <i class="fas fa-dice-d20"></i>
        </button>
    </div>

    <!-- CONTAINER PRINCIPAL -->
    <div class="game-container">
        <!-- HEADER -->
        <div class="game-header">
            <div class="personagem-info">
                <div class="personagem-avatar" id="headerAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <span class="personagem-nome" id="headerNome">Carregando...</span>
                    <span style="font-size:0.8rem; color:rgba(255,255,255,0.6); margin-left:10px;" id="headerClasse"></span>
                </div>
            </div>

            <div class="status-bars">
                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-heart"></i> PV</span>
                        <span id="headerPV">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill vida" id="headerPVBarra" style="width:0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-magic"></i> Mana</span>
                        <span id="headerMana">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill mana" id="headerManaBarra" style="width:0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-tint"></i> Fadiga</span>
                        <span id="headerFadiga">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill fadiga" id="headerFadigaBarra" style="width:0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-star"></i> XP</span>
                        <span id="headerXP">0/100</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill xp" id="headerXPBarra" style="width:0%"></div>
                    </div>
                </div>
            </div>

            <div class="pm-display" id="pmDisplay">
                <i class="fas fa-crown"></i>
                <span>PM: <span id="pmValor">0</span></span>
            </div>
        </div>

        <!-- √ÅREA PRINCIPAL - TR√äS COLUNAS -->
        <div class="main-area">
            <!-- COLUNA ESQUERDA - FICHA DO PERSONAGEM -->
            <div class="ficha-coluna">
                <div class="ficha-header">
                    <div class="ficha-avatar" id="fichaAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="ficha-nome" id="fichaNome">Carregando...</div>
                    <div class="ficha-classe" id="fichaClasse"></div>
                </div>

                <!-- INDICADOR DE N√çVEL DO PERSONAGEM -->
                <div class="nivel-indicator">
                    <div class="nivel-info">
                        <i class="fas fa-crown"></i>
                        <span>N√≠vel do Personagem</span>
                    </div>
                    <div class="nivel-valor" id="nivelPersonagem">1</div>
                </div>

                <!-- INDICADOR DE ATO -->
                <div class="ato-indicator" id="atoIndicator">
                    <i class="fas fa-scroll"></i> <span id="atoTexto">Ato 1: A Taverna</span>
                </div>

                <!-- BOLINHAS DISPON√çVEIS -->
                <div class="bolinhas-saldo" id="bolinhasSaldoContainer" style="display: none;">
                    <span><i class="fas fa-star"></i> Bolinhas dispon√≠veis:</span>
                    <span class="valor" id="bolinhasSaldo">0</span>
                </div>

                <!-- ATRIBUTOS -->
                <div class="atributos-container" id="atributosContainer"></div>

                <!-- DEFESAS -->
                <div class="defesas-grid" id="defesasGrid"></div>

                <!-- BOT√ïES DE FICHA -->
                <div class="ficha-botoes">
                    <button class="ficha-botao" id="btnVerVantagens">
                        <i class="fas fa-star"></i>
                        <span>Vantagens</span>
                        <span class="contador" id="contadorVantagensBtn">0</span>
                    </button>
                    <button class="ficha-botao" id="btnVerDesvantagens">
                        <i class="fas fa-skull"></i>
                        <span>Desvantagens</span>
                        <span class="contador" id="contadorDesvantagensBtn">0</span>
                    </button>
                    <button class="ficha-botao" id="btnVerPericias">
                        <i class="fas fa-brain"></i>
                        <span>Per√≠cias</span>
                        <span class="contador" id="contadorPericiasBtn">0</span>
                    </button>
                    <button class="ficha-botao" id="btnVerMagias">
                        <i class="fas fa-magic"></i>
                        <span>Magias</span>
                        <span class="contador" id="contadorMagiasBtn">0</span>
                    </button>
                </div>
            </div>

            <!-- COLUNA CENTRAL - CEN√ÅRIO E DI√ÅLOGO -->
            <div class="cenario-coluna">
                <!-- CEN√ÅRIO COM NPCs -->
                <div class="cenario-area" id="cenarioArea">
                    <div class="cenario-overlay"></div>
                    <div class="npcs-container" id="npcsContainer"></div>
                </div>

                <!-- CAIXA DE DI√ÅLOGO (EMBAIXO DO CEN√ÅRIO) -->
                <div class="dialogo-area" id="dialogoArea">
                    <div class="npc-falando" id="npcFalando">
                        <img src="" alt="" id="npcAvatar" style="display: none;">
                        <span id="npcNome">Narrador</span>
                    </div>
                    <div class="dialogo-texto" id="dialogoTexto">
                        Preparando sua aventura...
                    </div>
                    <div class="opcoes-dialogo" id="opcoesDialogo"></div>
                </div>
            </div>

            <!-- COLUNA DIREITA - A√á√ïES E COMBATE -->
            <div class="acoes-coluna">
                <!-- INDICADOR DE TURNO -->
                <div class="turno-indicator jogador" id="turnoIndicator">
                    <i class="fas fa-user"></i> SEU TURNO
                </div>

                <!-- A√á√ïES R√ÅPIDAS -->
                <div class="acoes-grid">
                    <button class="acao-btn atacar" id="btnAtacar">
                        <i class="fas fa-sword"></i> Atacar
                    </button>
                    <button class="acao-btn magia" id="btnMagia">
                        <i class="fas fa-magic"></i> Magia
                    </button>
                    <button class="acao-btn" id="btnInventario">
                        <i class="fas fa-backpack"></i> Invent√°rio
                    </button>
                    <button class="acao-btn" id="btnDescansar">
                        <i class="fas fa-bed"></i> Descansar
                    </button>
                </div>

                <!-- INIMIGOS (aparece em combate) -->
                <div id="inimigosContainer" style="display: none;">
                    <h4 style="color:#ff6b6b; margin-bottom:8px;"><i class="fas fa-skull"></i> Inimigos</h4>
                    <div class="inimigos-lista" id="inimigosLista"></div>
                </div>

                <!-- LOG DE A√á√ïES -->
                <div class="log-container" id="logContainer">
                    <div class="log-item">A aventura come√ßou...</div>
                </div>
            </div>
        </div>
    </div>
<script>
    // ============================================
// SISTEMA SOCIAL REUTILIZ√ÅVEL - TESTES DE REA√á√ÉO E INTERA√á√ÉO
// ============================================

const SistemaSocial = {
    // Calcula b√¥nus de apar√™ncia do personagem
    calcularBonusAparencia: function(personagem) {
        let bonus = 0;
        
        if (personagem.vantagens && personagem.vantagens.includes('atraente')) {
            bonus += 2;
            console.log('‚ú® Apar√™ncia atraente: +2 na rea√ß√£o');
        }
        if (personagem.desvantagens && personagem.desvantagens.includes('feio')) {
            bonus -= 2;
            console.log('üëπ Apar√™ncia feia: -2 na rea√ß√£o');
        }
        
        return bonus;
    },
    
    // Calcula b√¥nus de Carisma se existir
    calcularBonusCarisma: function(personagem) {
        if (personagem.vantagens && personagem.vantagens.includes('carisma')) {
            return 1;
        }
        return 0;
    },
    
    // Teste de rea√ß√£o 2d10 (seu sistema atual)
    testarReacao: function(npc, jogador) {
        // Base do NPC (padr√£o 10)
        const baseReacao = npc.reacaoBase || 10;
        
        // B√¥nus do jogador
        const bonusAparencia = this.calcularBonusAparencia(jogador);
        const bonusCarisma = this.calcularBonusCarisma(jogador);
        const bonusTotal = bonusAparencia + bonusCarisma;
        
        // Rolagem 2d10 (como no seu sistema de combate)
        const rolagem = Math.floor(Math.random() * 10) + 1 + Math.floor(Math.random() * 10) + 1;
        
        // C√°lculo final
        const reacaoFinal = baseReacao + bonusTotal + (rolagem - 11); // -11 para centralizar
        
        let classificacao = '';
        if (reacaoFinal <= 7) classificacao = 'ruim';
        else if (reacaoFinal <= 14) classificacao = 'normal';
        else classificacao = 'otima';
        
        return {
            valor: reacaoFinal,
            rolagem: rolagem,
            bonusAparencia: bonusAparencia,
            bonusCarisma: bonusCarisma,
            classificacao: classificacao,
            descricao: this.getDescricaoReacao(classificacao, npc.genero || 'feminino')
        };
    },
    
    // Descri√ß√µes gen√©ricas baseadas na rea√ß√£o
    getDescricaoReacao: function(classificacao, genero) {
        const pronome = genero === 'feminino' ? 'ela' : 'ele';
        
        const descricoes = {
            ruim: `${pronome} te olha com desconfian√ßa, mantendo dist√¢ncia. Seu corpo est√° tenso, pronto para correr.`,
            normal: `${pronome} parece neutra, te observando com curiosidade mas sem se aproximar muito.`,
            otima: `${pronome} sorri abertamente, seus olhos brilhando com simpatia. Parece √† vontade com sua presen√ßa.`
        };
        
        return descricoes[classificacao];
    },
    
    // Calcular NH de per√≠cia social
    calcularNHPericia: function(periciaId, personagem) {
        if (!personagem || !personagem.pericias || !personagem.pericias[periciaId]) {
            return 0; // N√£o tem a per√≠cia
        }
        
        const pericia = personagem.pericias[periciaId];
        const nivel = pericia.nivel || 1;
        const bonus = nivel === 1 ? 0 : nivel - 1;
        
        // Per√≠cias sociais usam IQ
        if (periciaId === 'labia' || periciaId === 'persuasao' || periciaId === 'intimidacao') {
            // Pega o IQ real do personagem (base + bolinhas)
            const iq = personagem.atributos?.iq?.valor || 5;
            return iq + bonus;
        }
        
        return 0;
    },
    
    // Teste social (para flerte, persuas√£o, etc)
    testeSocial: function(nhJogador, dificuldadeNpc, modificadores = 0) {
        const rolagem = Math.floor(Math.random() * 10) + 1 + Math.floor(Math.random() * 10) + 1;
        const total = rolagem + modificadores;
        
        const sucesso = total <= nhJogador;
        const margem = nhJogador - total;
        
        return {
            sucesso: sucesso,
            rolagem: rolagem,
            total: total,
            nh: nhJogador,
            margem: margem,
            critico: margem >= 5, // Sucesso cr√≠tico
            falhaCritica: total >= nhJogador + 5 // Falha cr√≠tica
        };
    },
    
    // Formatar mensagem de resultado
    formatarResultadoTeste: function(resultado, tipoTeste) {
        if (resultado.sucesso) {
            if (resultado.critico) {
                return `‚ú® Sucesso CR√çTICO em ${tipoTeste}!`;
            }
            return `‚úÖ Sucesso em ${tipoTeste}!`;
        } else {
            if (resultado.falhaCritica) {
                return `üí• Falha CR√çTICA em ${tipoTeste}!`;
            }
            return `‚ùå Falha em ${tipoTeste}!`;
        }
    }
};
</script>
    <script type="module">
// ============================================
// IMPORTA√á√ïES FIREBASE
// ============================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// ============================================
// CONFIGURA√á√ÉO FIREBASE
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyBrx4JSmFay24k95pu1ICjFfVki8gs_uHw",
    authDomain: "rpgforce-e3227.firebaseapp.com",
    projectId: "rpgforce-e3227",
    storageBucket: "rpgforce-e3227.firebasestorage.app",
    messagingSenderId: "984517342332",
    appId: "1:984517342332:web:87d33aa4c84ff2a07685f9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ============================================
// ELEMENTOS DOM
// ============================================
const loadingOverlay = document.getElementById('loadingOverlay');

// Header
const headerAvatar = document.getElementById('headerAvatar');
const headerNome = document.getElementById('headerNome');
const headerClasse = document.getElementById('headerClasse');
const headerPV = document.getElementById('headerPV');
const headerPVBarra = document.getElementById('headerPVBarra');
const headerMana = document.getElementById('headerMana');
const headerManaBarra = document.getElementById('headerManaBarra');
const headerFadiga = document.getElementById('headerFadiga');
const headerFadigaBarra = document.getElementById('headerFadigaBarra');
const headerXP = document.getElementById('headerXP');
const headerXPBarra = document.getElementById('headerXPBarra');
const pmValor = document.getElementById('pmValor');

// Ficha
const fichaAvatar = document.getElementById('fichaAvatar');
const fichaNome = document.getElementById('fichaNome');
const fichaClasse = document.getElementById('fichaClasse');
const atributosContainer = document.getElementById('atributosContainer');
const defesasGrid = document.getElementById('defesasGrid');
const bolinhasSaldoContainer = document.getElementById('bolinhasSaldoContainer');
const bolinhasSaldo = document.getElementById('bolinhasSaldo');
const atoIndicator = document.getElementById('atoIndicator');
const atoTexto = document.getElementById('atoTexto');

// Bot√µes de ficha
const btnVerVantagens = document.getElementById('btnVerVantagens');
const btnVerDesvantagens = document.getElementById('btnVerDesvantagens');
const btnVerPericias = document.getElementById('btnVerPericias');
const btnVerMagias = document.getElementById('btnVerMagias');
const contadorVantagensBtn = document.getElementById('contadorVantagensBtn');
const contadorDesvantagensBtn = document.getElementById('contadorDesvantagensBtn');
const contadorPericiasBtn = document.getElementById('contadorPericiasBtn');
const contadorMagiasBtn = document.getElementById('contadorMagiasBtn');

// Cen√°rio e di√°logo
const cenarioArea = document.getElementById('cenarioArea');
const npcsContainer = document.getElementById('npcsContainer');
const npcFalando = document.getElementById('npcFalando');
const npcAvatar = document.getElementById('npcAvatar');
const npcNome = document.getElementById('npcNome');
const dialogoTexto = document.getElementById('dialogoTexto');
const opcoesDialogo = document.getElementById('opcoesDialogo');

// A√ß√µes
const turnoIndicator = document.getElementById('turnoIndicator');
const btnAtacar = document.getElementById('btnAtacar');
const btnMagia = document.getElementById('btnMagia');
const btnInventario = document.getElementById('btnInventario');
const btnDescansar = document.getElementById('btnDescansar');
const inimigosContainer = document.getElementById('inimigosContainer');
const inimigosLista = document.getElementById('inimigosLista');
const logContainer = document.getElementById('logContainer');

// Modais
const modalEscolhaAtributo = document.getElementById('modalEscolhaAtributo');
const modalInventario = document.getElementById('modalInventario');
const modalVantagens = document.getElementById('modalVantagens');
const modalDesvantagens = document.getElementById('modalDesvantagens');
const modalPericias = document.getElementById('modalPericias');
const modalMagias = document.getElementById('modalMagias');
const modalAtaque = document.getElementById('modalAtaque');
const modalDefesa = document.getElementById('modalDefesa');
const modalDados = document.getElementById('modalDados');

const bolinhasDisponiveisModal = document.getElementById('bolinhasDisponiveisModal');
const valorStModal = document.getElementById('valorStModal');
const valorDxModal = document.getElementById('valorDxModal');
const valorIqModal = document.getElementById('valorIqModal');
const valorHtModal = document.getElementById('valorHtModal');

const cancelarEscolhaAtributo = document.getElementById('cancelarEscolhaAtributo');
const fecharModalInventario = document.getElementById('fecharModalInventario');
const fecharModalVantagens = document.getElementById('fecharModalVantagens');
const fecharModalDesvantagens = document.getElementById('fecharModalDesvantagens');
const fecharModalPericias = document.getElementById('fecharModalPericias');
const fecharModalMagias = document.getElementById('fecharModalMagias');

const armasLista = document.getElementById('armasLista');
const btnCancelarAtaque = document.getElementById('btnCancelarAtaque');
const btnConfirmarAtaque = document.getElementById('btnConfirmarAtaque');

const defesaContexto = document.getElementById('defesaContexto');
const defesasLista = document.getElementById('defesasLista');
const btnCancelarDefesa = document.getElementById('btnCancelarDefesa');
const btnConfirmarDefesa = document.getElementById('btnConfirmarDefesa');

const btnAbrirDados = document.getElementById('btnAbrirDados');
const btnFecharDados = document.getElementById('btnFecharDados');
const btnRolarDados = document.getElementById('btnRolarDados');
const dadosResultado = document.getElementById('dadosResultado');
const dadosQtd = document.getElementById('dadosQtd');
const dadosFaces = document.getElementById('dadosFaces');
const dadosMod = document.getElementById('dadosMod');

const modalDinheiro = document.getElementById('modalDinheiro');
const modalCarga = document.getElementById('modalCarga');
const modalPM = document.getElementById('modalPM');
const modalAptidao = document.getElementById('modalAptidao');

// ============================================
// DICION√ÅRIOS DE NOMES
// ============================================
const nomesVantagens = {
    aliado: 'Aliado',
    ambidestria: 'Ambidestria',
    aptidaoMagica: 'Aptid√£o M√°gica',
    abascanto: 'Abascanto',
    carisma: 'Carisma',
    destemor: 'Destemor',
    duroMatar: 'Duro de Matar',
    flexibilidade: 'Flexibilidade',
    intuicao: 'Intui√ß√£o',
    nocaoPerigo: 'No√ß√£o do Perigo',
    reflexoCombate: 'Reflexo de Combate',
    regeneracao: 'Regenera√ß√£o',
    sentidosAgucados: 'Sentidos Agu√ßados',
    sorte: 'Sorte',
    visaoNoturna: 'Vis√£o Noturna',
    mestreArmas: 'Mestre das Armas',
    forcaVontade: 'For√ßa de Vontade',
    fadigaExtra: 'Fadiga Extra',
    htExtra: 'HT Extra',
    atraente: 'Atraente',
    rico: 'Rico'
};

const nomesDesvantagens = {
    alcoolismo: 'Alcoolismo',
    avareza: 'Avareza',
    briguento: 'Briguento',
    barulhento: 'Barulhento',
    cobica: 'Cobi√ßa',
    circunspeccao: 'Circunspec√ß√£o',
    cleptomania: 'Cleptomania',
    codigoHonra: 'C√≥digo de Honra',
    covardia: 'Covardia',
    daltonismo: 'Daltonismo',
    sensoDever: 'Senso do Dever',
    inimigo: 'Inimigo',
    excessoConfianca: 'Excesso de Confian√ßa',
    fobia: 'Fobia',
    furia: 'F√∫ria',
    honestidade: 'Honestidade',
    luxuria: 'Lux√∫ria',
    megalomania: 'Megalomania',
    pacifismo: 'Pacifismo',
    piromania: 'Piromania',
    preguica: 'Pregui√ßa',
    sanguinolencia: 'Sanguinol√™ncia',
    teimosia: 'Teimosia',
    veracidade: 'Veracidade',
    zarolho: 'Zarolho',
    magro: 'Magro',
    gordo: 'Gordo',
    nanismo: 'Nanismo',
    pobre: 'Pobre',
    feio: 'Feio'
};

const nomesFobias = {
    acrofobia: 'Acrofobia - Medo de alturas',
    agorafobia: 'Agorafobia - Medo de espa√ßos abertos',
    aracnofobia: 'Aracnofobia - Medo de aranhas',
    autofobia: 'Autofobia - Medo de solid√£o',
    brontofobia: 'Brontofobia - Medo de ru√≠dos altos',
    claustrofobia: 'Claustrofobia - Medo de espa√ßos fechados',
    coitofobia: 'Coitofobia - Medo de sexo',
    demofobia: 'Demofobia - Medo de multid√µes',
    ecmofobia: 'Ecmofobia - Medo de coisas afiadas',
    elurofobia: 'Elurofobia - Medo de gatos',
    entomofobia: 'Entomofobia - Medo de insetos',
    hematofobia: 'Hematofobia - Medo de sangue',
    hoplofobia: 'Hoplofobia - Medo de armas',
    manafobia: 'Manafobia - Medo de magia',
    misofobia: 'Misofobia - Medo de sujeira',
    necrofobia: 'Necrofobia - Medo da morte',
    nictofobia: 'Nictofobia - Medo do escuro',
    ofiofobia: 'Ofiofobia - Medo de r√©pteis',
    pirofobia: 'Pirofobia - Medo de fogo',
    psicofobia: 'Psicofobia - Medo de poderes ps√≠quicos',
    talassofobia: 'Talassofobia - Medo do mar',
    tecnofobia: 'Tecnofobia - Medo de m√°quinas',
    teratofobia: 'Teratofobia - Medo de monstros',
    triscedecofobia: 'Triscedecofobia - Medo do n√∫mero 13',
    xenofobia: 'Xenofobia - Medo do desconhecido'
};

// ============================================
// ESTADO DO JOGO
// ============================================
let currentUser = null;
let personagem = null;
let historia = null;
let capituloAtual = null;
let inimigos = [];
let sessaoId = null;

let turnoAtual = 'jogador';
let inimigoSelecionado = null;
let armaSelecionada = null;
let defesaSelecionada = null;
let ataqueAtual = null;

// Controle de tempo e eventos
let timerHomem = null;
let atoAtual = 1;

// Status do personagem
let pvAtual = 0;
let pvMax = 0;
let fadigaAtual = 0;
let fadigaMax = 0;
let manaAtual = 0;
let manaMax = 0;
let xpAtual = 0;
let pmAtual = 0;
let bolinhasDisponiveis = 0;
let pmDisponivel = 30;
let pmGasto = 0;

const XP_POR_BOLINHA = 100;

// ============================================
// FUN√á√ïES AUXILIARES
// ============================================
function showLoading() {
    if (loadingOverlay) loadingOverlay.classList.add('active');
}

function hideLoading() {
    if (loadingOverlay) loadingOverlay.classList.remove('active');
}

function adicionarLog(mensagem, tipo = 'info') {
    if (!logContainer) return;
    const logItem = document.createElement('div');
    logItem.className = `log-item ${tipo}`;
    logItem.innerHTML = mensagem;
    logContainer.appendChild(logItem);
    logContainer.scrollTop = logContainer.scrollHeight;
    
    while (logContainer.children.length > 50) {
        logContainer.removeChild(logContainer.firstChild);
    }
}

function rolarDados(quantidade, faces, modificador = 0) {
    let total = 0;
    let resultados = [];
    
    for (let i = 0; i < quantidade; i++) {
        const resultado = Math.floor(Math.random() * faces) + 1;
        resultados.push(resultado);
        total += resultado;
    }
    
    total += modificador;
    
    return {
        total: total,
        resultados: resultados,
        modificador: modificador,
        texto: `${resultados.join(' + ')} ${modificador >= 0 ? '+' : '-'} ${Math.abs(modificador)} = ${total}`
    };
}

function rolar2d10() {
    return rolarDados(2, 10, 0);
}

function setAto(numero, texto) {
    atoAtual = numero;
    if (atoTexto) atoTexto.textContent = `Ato ${numero}: ${texto}`;
    adicionarLog(`üìú Ato ${numero}: ${texto}`, 'sucesso');
}

function getValorAtributo(atributo) {
    if (!personagem || !personagem.atributos) return 0;
    
    const base = { st: 9, dx: 5, iq: 5, ht: 8 }[atributo];
    const bolinhas = personagem.atributos[atributo]?.bolinhas || 0;
    return base + bolinhas;
}

function getValorAtributoReal(atributo) {
    if (!personagem || !personagem.atributos) return 0;
    return personagem.atributos[atributo]?.valor || 0;
}

function calcularManaMax() {
    const iq = getValorAtributoReal('iq');
    const ht = getValorAtributoReal('ht');
    return iq + ht;
}

function calcularPVMax() {
    const ht = getValorAtributoReal('ht');
    return ht * 8;
}

function calcularFadigaMax() {
    if (!personagem || !personagem.atributos?.ht) return 8;
    return 8 + (personagem.atributos.ht.bolinhas || 0);
}

function calcularPMAtual() {
    if (!personagem) return 0;
    const disponivel = personagem.pmDisponivel || 30;
    const gasto = personagem.pmGasto || 0;
    return Math.max(0, disponivel - gasto);
}

function calcularNivelPersonagem() {
    if (!personagem || !personagem.atributos) return 1;
    
    const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
    const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
    const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
    const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
    
    const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
    return totalBolinhas + 1;
}

function atualizarNivelNaTela() {
    const nivelElement = document.getElementById('nivelPersonagem');
    if (nivelElement) {
        const nivel = calcularNivelPersonagem();
        nivelElement.textContent = nivel;
    }
}

function verificarGanhoBolinha() {
    if (!personagem) return;
    
    const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
    const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
    const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
    const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
    
    const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
    const xpNecessario = (totalBolinhas + bolinhasDisponiveis + 1) * XP_POR_BOLINHA;
    
    while (xpAtual >= xpNecessario) {
        bolinhasDisponiveis++;
        xpAtual -= xpNecessario;
        adicionarLog(`üåü Voc√™ ganhou uma bolinha! (Total: ${bolinhasDisponiveis} dispon√≠veis)`, 'sucesso');
        
        const novoTotal = totalBolinhas + bolinhasDisponiveis;
        const proximoXP = (novoTotal + 1) * XP_POR_BOLINHA;
        if (headerXP) headerXP.textContent = `${xpAtual}/${proximoXP}`;
        if (headerXPBarra) headerXPBarra.style.width = (xpAtual / proximoXP * 100) + '%';
    }
    
    atualizarInterfaceBolinhas();
}

function atualizarInterfaceBolinhas() {
    if (!bolinhasSaldoContainer || !bolinhasSaldo) return;
    
    if (bolinhasDisponiveis > 0) {
        bolinhasSaldoContainer.style.display = 'flex';
        bolinhasSaldo.textContent = bolinhasDisponiveis;
        
        document.querySelectorAll('.atributo-card').forEach(card => {
            card.classList.add('bolinha-disponivel');
        });
    } else {
        bolinhasSaldoContainer.style.display = 'none';
        document.querySelectorAll('.atributo-card').forEach(card => {
            card.classList.remove('bolinha-disponivel');
        });
    }
}

function abrirModalEscolhaAtributo() {
    if (!modalEscolhaAtributo) return;
    if (bolinhasDisponiveis <= 0) return;
    
    if (valorStModal) valorStModal.textContent = getValorAtributo('st');
    if (valorDxModal) valorDxModal.textContent = getValorAtributo('dx');
    if (valorIqModal) valorIqModal.textContent = getValorAtributo('iq');
    if (valorHtModal) valorHtModal.textContent = getValorAtributo('ht');
    if (bolinhasDisponiveisModal) bolinhasDisponiveisModal.textContent = bolinhasDisponiveis;
    
    modalEscolhaAtributo.classList.add('active');
}

function adicionarBolinha(atributo) {
    if (bolinhasDisponiveis <= 0) return;
    
    if (!personagem.atributos[atributo]) {
        personagem.atributos[atributo] = { 
            bolinhas: 0, 
            base: (atributo === 'st' || atributo === 'ht') ? 8 : 5, 
            valor: (atributo === 'st' || atributo === 'ht') ? 8 : 5 
        };
    }
    
    const nivelAntes = calcularNivelPersonagem();
    
    personagem.atributos[atributo].bolinhas = (personagem.atributos[atributo].bolinhas || 0) + 1;
    personagem.atributos[atributo].valor = personagem.atributos[atributo].base + personagem.atributos[atributo].bolinhas;
    
    bolinhasDisponiveis--;
    
    const nivelDepois = calcularNivelPersonagem();
    
    pvMax = calcularPVMax();
    manaMax = calcularManaMax();
    fadigaMax = calcularFadigaMax();
    
    adicionarLog(`‚ú® Bolinha adicionada em ${atributo.toUpperCase()}! (${bolinhasDisponiveis} restantes)`, 'sucesso');
    
    if (nivelDepois > nivelAntes) {
        adicionarLog(`üìä N√çVEL AUMENTOU: ${nivelAntes} ‚Üí ${nivelDepois}!`, 'sucesso');
    }
    
    atualizarFichaPersonagem();
    atualizarNivelNaTela();
    
    salvarProgresso();
    
    if (bolinhasDisponiveis > 0) {
        abrirModalEscolhaAtributo();
    } else {
        if (modalEscolhaAtributo) modalEscolhaAtributo.classList.remove('active');
    }
}

function abrirModalVantagens() {
    if (!modalVantagens) return;
    const vantagensLista = document.getElementById('vantagensLista');
    if (!vantagensLista) return;
    
    if (!personagem || !personagem.vantagens || personagem.vantagens.length === 0) {
        vantagensLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma vantagem</div>';
        modalVantagens.classList.add('active');
        return;
    }
    
    vantagensLista.innerHTML = '';
    
    personagem.vantagens.forEach(vantagemId => {
        const nome = nomesVantagens[vantagemId] || vantagemId;
        const div = document.createElement('div');
        div.className = 'vantagem-item';
        div.innerHTML = `
            <h4>${nome}</h4>
            <div class="tipo">Vantagem</div>
        `;
        vantagensLista.appendChild(div);
    });
    
    modalVantagens.classList.add('active');
}

function abrirModalDesvantagens() {
    if (!modalDesvantagens) return;
    const desvantagensLista = document.getElementById('desvantagensLista');
    if (!desvantagensLista) return;
    
    if (!personagem || !personagem.desvantagens || personagem.desvantagens.length === 0) {
        desvantagensLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma desvantagem</div>';
        modalDesvantagens.classList.add('active');
        return;
    }
    
    desvantagensLista.innerHTML = '';
    
    personagem.desvantagens.forEach(desvantagemId => {
        let nome = '';
        if (desvantagemId.startsWith('fobia:')) {
            const fobiaId = desvantagemId.replace('fobia:', '');
            nome = nomesFobias[fobiaId] || fobiaId;
        } else {
            nome = nomesDesvantagens[desvantagemId] || desvantagemId;
        }
        
        const div = document.createElement('div');
        div.className = 'desvantagem-item';
        
        let extra = '';
        if (desvantagemId.startsWith('fobia:')) {
            extra = '<span class="badge-fobia">Fobia</span>';
        }
        
        div.innerHTML = `
            <h4>${nome} ${extra}</h4>
            <div class="tipo">Desvantagem</div>
        `;
        desvantagensLista.appendChild(div);
    });
    
    modalDesvantagens.classList.add('active');
}

function abrirModalPericias() {
    if (!modalPericias) return;
    const periciasLista = document.getElementById('periciasLista');
    if (!periciasLista) return;
    
    if (!personagem || !personagem.pericias) {
        periciasLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma per√≠cia</div>';
        if (modalPM) modalPM.textContent = `${pmAtual}/${pmDisponivel}`;
        modalPericias.classList.add('active');
        return;
    }
    
    periciasLista.innerHTML = '';
    
    const pericias = personagem.pericias;
    const periciasArray = Object.entries(pericias);
    
    if (periciasArray.length === 0) {
        periciasLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma per√≠cia</div>';
    } else {
        periciasArray.forEach(([id, dados]) => {
            const nome = id.charAt(0).toUpperCase() + id.slice(1);
            const nivel = dados.nivel || 1;
            const bonus = nivel === 1 ? 0 : nivel - 1;
            
            let atributoBase = 10;
            let atributoNome = 'ST';
            
            if (id === 'alquimia' || id === 'intimidacao' || id === 'labia') {
                atributoBase = getValorAtributoReal('iq');
                atributoNome = 'IQ';
            } else {
                atributoBase = getValorAtributoReal('dx');
                atributoNome = 'DX';
            }
            
            const nh = atributoBase + bonus;
            
            const div = document.createElement('div');
            div.className = 'pericia-modal-item';
            div.innerHTML = `
                <div class="pericia-modal-header">
                    <span class="pericia-modal-nome">${nome}</span>
                    <span class="pericia-modal-nivel">N√≠vel ${nivel}</span>
                </div>
                <div class="pericia-modal-atributo">Base: ${atributoNome} ${atributoBase}</div>
                <div class="pericia-modal-bonus">B√¥nus: +${bonus}</div>
                <div class="pericia-modal-nh">NH: ${nh}</div>
            `;
            periciasLista.appendChild(div);
        });
    }
    
    if (modalPM) modalPM.textContent = `${pmAtual}/${pmDisponivel}`;
    modalPericias.classList.add('active');
}

function abrirModalMagias() {
    if (!modalMagias) return;
    const magiasLista = document.getElementById('magiasLista');
    if (!magiasLista) return;
    
    if (!personagem || !personagem.escolas || !personagem.escolas.agua) {
        magiasLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma magia</div>';
        if (modalAptidao) modalAptidao.textContent = personagem?.vantagens?.includes('aptidaoMagica') ? '+1' : '0';
        modalMagias.classList.add('active');
        return;
    }
    
    magiasLista.innerHTML = '';
    
    const magias = personagem.escolas.agua.magias;
    const temAptidao = personagem.vantagens?.includes('aptidaoMagica');
    const iq = getValorAtributoReal('iq');
    const nhBase = iq + (temAptidao ? 1 : 0);
    
    if (modalAptidao) modalAptidao.textContent = temAptidao ? '+1' : '0';
    
    const magiasArray = Object.entries(magias).filter(([_, magia]) => magia.desbloqueada && magia.nivel > 0);
    
    if (magiasArray.length === 0) {
        magiasLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma magia desbloqueada</div>';
    } else {
        magiasArray.forEach(([id, magia]) => {
            let nome = '';
            switch(id) {
                case 'localizarAgua': nome = 'Localizar √Ågua'; break;
                case 'purificarAgua': nome = 'Purificar √Ågua'; break;
                case 'criarAgua': nome = 'Criar √Ågua'; break;
                case 'dissiparAgua': nome = 'Dissipar √Ågua'; break;
                case 'adagaDeGelo': nome = 'Adaga de Gelo'; break;
                case 'respirarNaAgua': nome = 'Respirar na √Ågua'; break;
                case 'moldarAgua': nome = 'Moldar √Ågua'; break;
                case 'nevoeiro': nome = 'Nevoeiro'; break;
                case 'armaCongelante': nome = 'Arma Congelante'; break;
                case 'cortinaDagua': nome = 'Cortina d\'√Ågua'; break;
                case 'jatoDeAgua': nome = 'Jato d\'√Ågua'; break;
                case 'ondaExpulsora': nome = 'Onda Expulsora'; break;
                case 'tempestadeDeGelo': nome = 'Tempestade de Gelo'; break;
                case 'congelamento': nome = 'Congelamento'; break;
                default: nome = id;
            }
            
            const tipo = magia.tipo || 'Desconhecido';
            const nivel = magia.nivel || 1;
            const efeito = `N√≠vel ${nivel}`;
            
            const div = document.createElement('div');
            div.className = 'magia-item';
            div.innerHTML = `
                <div class="magia-header">
                    <span class="magia-nome">${nome}</span>
                    <span class="magia-nivel">N√≠vel ${nivel}</span>
                </div>
                <div class="magia-tipo">${tipo}</div>
                <div class="magia-efeito">${efeito}</div>
                <div class="magia-nh-info">NH: ${nhBase}</div>
            `;
            magiasLista.appendChild(div);
        });
    }
    
    modalMagias.classList.add('active');
}

function abrirModalInventario() {
    if (!modalInventario) return;
    if (!personagem || !personagem.inventario) return;
    
    const equipado = document.getElementById('inventarioEquipado');
    const mochila = document.getElementById('inventarioMochila');
    const deposito = document.getElementById('inventarioDeposito');
    
    if (equipado) {
        equipado.innerHTML = '';
        if (personagem.inventario.corpo && personagem.inventario.corpo.length > 0) {
            personagem.inventario.corpo.forEach(item => {
                equipado.innerHTML += `
                    <div class="item-card">
                        <div class="nome">${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}</div>
                        <div class="detalhes">
                            <span>${item.peso || 0} kg</span>
                            <span>${item.preco || 0} $</span>
                        </div>
                        <div class="item-acoes">
                            <button class="item-acao" onclick="guardarItem('${item.id}')">Guardar</button>
                        </div>
                    </div>
                `;
            });
        } else {
            equipado.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Nada equipado</div>';
        }
    }
    
    if (mochila) {
        mochila.innerHTML = '';
        if (personagem.inventario.mochila && personagem.inventario.mochila.length > 0) {
            personagem.inventario.mochila.forEach(item => {
                mochila.innerHTML += `
                    <div class="item-card">
                        <div class="nome">${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}</div>
                        <div class="detalhes">
                            <span>${item.peso || 0} kg</span>
                            <span>${item.preco || 0} $</span>
                        </div>
                        <div class="item-acoes">
                            <button class="item-acao" onclick="equiparItem('${item.id}')">Equipar</button>
                            <button class="item-acao" onclick="moverParaDeposito('${item.id}')">Dep√≥sito</button>
                        </div>
                    </div>
                `;
            });
        } else {
            mochila.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Mochila vazia</div>';
        }
    }
    
    if (deposito) {
        deposito.innerHTML = '';
        if (personagem.inventario.deposito && personagem.inventario.deposito.length > 0) {
            personagem.inventario.deposito.forEach(item => {
                deposito.innerHTML += `
                    <div class="item-card">
                        <div class="nome">${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}</div>
                        <div class="detalhes">
                            <span>${item.peso || 0} kg</span>
                            <span>${item.preco || 0} $</span>
                        </div>
                        <div class="item-acoes">
                            <button class="item-acao" onclick="pegarItem('${item.id}')">Pegar</button>
                        </div>
                    </div>
                `;
            });
        } else {
            deposito.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Dep√≥sito vazio</div>';
        }
    }
    
    if (modalDinheiro) modalDinheiro.textContent = personagem.dinheiro || 0;
    
    let pesoTotal = 0;
    ['corpo', 'mochila'].forEach(local => {
        if (personagem.inventario[local]) {
            personagem.inventario[local].forEach(item => {
                pesoTotal += (item.peso || 0) * (item.quantidade || 1);
            });
        }
    });
    
    const st = getValorAtributo('st');
    const limiteCarga = st * 12;
    if (modalCarga) modalCarga.textContent = `${pesoTotal.toFixed(1)}/${limiteCarga} kg`;
    
    modalInventario.classList.add('active');
}

window.equiparItem = function(itemId) {
    if (!personagem?.inventario) return;
    
    const index = personagem.inventario.mochila.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.mochila[index];
        personagem.inventario.corpo.push(item);
        personagem.inventario.mochila.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

window.guardarItem = function(itemId) {
    if (!personagem?.inventario) return;
    
    const index = personagem.inventario.corpo.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.corpo[index];
        personagem.inventario.mochila.push(item);
        personagem.inventario.corpo.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

window.moverParaDeposito = function(itemId) {
    if (!personagem?.inventario) return;
    
    const index = personagem.inventario.mochila.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.mochila[index];
        personagem.inventario.deposito.push(item);
        personagem.inventario.mochila.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

window.pegarItem = function(itemId) {
    if (!personagem?.inventario) return;
    
    const index = personagem.inventario.deposito.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.deposito[index];
        personagem.inventario.mochila.push(item);
        personagem.inventario.deposito.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

function atualizarFichaPersonagem() {
    if (!personagem) return;
    
    if (headerNome) headerNome.textContent = personagem.nome || 'Aventureiro';
    
    const classes = {
        guerreiro: 'Guerreiro', mago: 'Mago', ladino: 'Ladino',
        clerigo: 'Cl√©rigo', barbaro: 'B√°rbaro'
    };
    if (headerClasse) headerClasse.textContent = classes[personagem.classe] || personagem.classe || '';
    
    if (personagem.fotoURL) {
        if (headerAvatar) headerAvatar.innerHTML = `<img src="${personagem.fotoURL}" alt="Avatar">`;
        if (fichaAvatar) fichaAvatar.innerHTML = `<img src="${personagem.fotoURL}" alt="Avatar">`;
    }
    
    pvMax = calcularPVMax();
    pvAtual = personagem.statusCombate?.vidaAtual || pvMax;
    if (headerPV) headerPV.textContent = `${pvAtual}/${pvMax}`;
    if (headerPVBarra) headerPVBarra.style.width = (pvAtual / pvMax * 100) + '%';
    
    fadigaMax = calcularFadigaMax();
    fadigaAtual = personagem.statusCombate?.fadigaAtual || fadigaMax;
    if (headerFadiga) headerFadiga.textContent = `${fadigaAtual}/${fadigaMax}`;
    if (headerFadigaBarra) headerFadigaBarra.style.width = (fadigaAtual / fadigaMax * 100) + '%';
    
    manaMax = calcularManaMax();
    manaAtual = personagem.statusCombate?.manaAtual || manaMax;
    if (headerMana) headerMana.textContent = `${manaAtual}/${manaMax}`;
    if (headerManaBarra) headerManaBarra.style.width = (manaAtual / manaMax * 100) + '%';
    
    const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
    const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
    const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
    const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
    const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
    
    const xpNecessario = (totalBolinhas + bolinhasDisponiveis + 1) * XP_POR_BOLINHA;
    
    if (headerXP) headerXP.textContent = `${xpAtual}/${xpNecessario}`;
    if (headerXPBarra) headerXPBarra.style.width = (xpAtual / xpNecessario * 100) + '%';
    
    pmDisponivel = personagem.pmDisponivel || 30;
    pmGasto = personagem.pmGasto || 0;
    pmAtual = pmDisponivel - pmGasto;
    if (pmValor) pmValor.textContent = pmAtual;
    
    if (fichaNome) fichaNome.textContent = personagem.nome || 'Aventureiro';
    if (fichaClasse) fichaClasse.textContent = classes[personagem.classe] || personagem.classe || '';
    
    const st = getValorAtributoReal('st');
    const dx = getValorAtributoReal('dx');
    const iq = getValorAtributoReal('iq');
    const ht = getValorAtributoReal('ht');
    
    const criarBolinhasHTML = (atrib, total) => {
        let html = '';
        for (let i = 0; i < 15; i++) {
            if (i < total) {
                html += '<div class="bolinha-pequena preenchida"></div>';
            } else {
                html += '<div class="bolinha-pequena"></div>';
            }
        }
        return html;
    };
    
    if (atributosContainer) {
        atributosContainer.innerHTML = `
            <div class="atributo-card ${bolinhasDisponiveis > 0 ? 'bolinha-disponivel' : ''}" data-atributo="st">
                <div class="atributo-info">
                    <span class="atributo-nome">ST</span>
                    <div class="atributo-bolinhas">${criarBolinhasHTML('st', personagem.atributos?.st?.bolinhas || 0)}</div>
                </div>
                <div>
                    <span class="atributo-valor">${st}</span>
                    <span class="atributo-base">(${personagem.atributos?.st?.base || 8}+${personagem.atributos?.st?.bolinhas || 0})</span>
                </div>
            </div>
            
            <div class="atributo-card ${bolinhasDisponiveis > 0 ? 'bolinha-disponivel' : ''}" data-atributo="dx">
                <div class="atributo-info">
                    <span class="atributo-nome">DX</span>
                    <div class="atributo-bolinhas">${criarBolinhasHTML('dx', personagem.atributos?.dx?.bolinhas || 0)}</div>
                </div>
                <div>
                    <span class="atributo-valor">${dx}</span>
                    <span class="atributo-base">(${personagem.atributos?.dx?.base || 5}+${personagem.atributos?.dx?.bolinhas || 0})</span>
                </div>
            </div>
            
            <div class="atributo-card ${bolinhasDisponiveis > 0 ? 'bolinha-disponivel' : ''}" data-atributo="iq">
                <div class="atributo-info">
                    <span class="atributo-nome">IQ</span>
                    <div class="atributo-bolinhas">${criarBolinhasHTML('iq', personagem.atributos?.iq?.bolinhas || 0)}</div>
                </div>
                <div>
                    <span class="atributo-valor">${iq}</span>
                    <span class="atributo-base">(${personagem.atributos?.iq?.base || 5}+${personagem.atributos?.iq?.bolinhas || 0})</span>
                </div>
            </div>
            
            <div class="atributo-card ${bolinhasDisponiveis > 0 ? 'bolinha-disponivel' : ''}" data-atributo="ht">
                <div class="atributo-info">
                    <span class="atributo-nome">HT</span>
                    <div class="atributo-bolinhas">${criarBolinhasHTML('ht', personagem.atributos?.ht?.bolinhas || 0)}</div>
                </div>
                <div>
                    <span class="atributo-valor">${ht}</span>
                    <span class="atributo-base">(${personagem.atributos?.ht?.base || 8}+${personagem.atributos?.ht?.bolinhas || 0})</span>
                </div>
            </div>
        `;
    }
    
    document.querySelectorAll('.atributo-card').forEach(card => {
        card.addEventListener('click', () => {
            if (bolinhasDisponiveis > 0) {
                const atributo = card.dataset.atributo;
                adicionarBolinha(atributo);
            }
        });
    });
    
    const esquiva = Math.floor((dx + ht) / 6) + 6;
    
    let aparar = 0;
    if (personagem.inventario?.corpo) {
        const temArma = personagem.inventario.corpo.some(item => item.dano);
        if (temArma) aparar = Math.floor((dx + dx) / 4) + 6;
    }
    
    let bloqueio = 0;
    if (personagem.inventario?.corpo) {
        const temEscudo = personagem.inventario.corpo.some(item => item.tipo === 'escudo' || item.nome?.toLowerCase().includes('escudo'));
        if (temEscudo) bloqueio = Math.floor((dx + dx) / 4) + 6 + 2;
    }
    
    if (defesasGrid) {
        defesasGrid.innerHTML = `
            <div class="defesa-card">
                <div class="defesa-valor">${esquiva}</div>
                <div class="defesa-label">Esquiva</div>
            </div>
            <div class="defesa-card">
                <div class="defesa-valor">${aparar}</div>
                <div class="defesa-label">Aparar</div>
            </div>
            <div class="defesa-card">
                <div class="defesa-valor">${bloqueio}</div>
                <div class="defesa-label">Bloqueio</div>
            </div>
        `;
    }
    
    if (contadorVantagensBtn) contadorVantagensBtn.textContent = personagem.vantagens?.length || 0;
    if (contadorDesvantagensBtn) contadorDesvantagensBtn.textContent = personagem.desvantagens?.length || 0;
    if (contadorPericiasBtn) contadorPericiasBtn.textContent = Object.keys(personagem.pericias || {}).length;
    
    let magiasCount = 0;
    if (personagem.escolas?.agua?.magias) {
        magiasCount = Object.values(personagem.escolas.agua.magias).filter(m => m.desbloqueada && m.nivel > 0).length;
    }
    if (contadorMagiasBtn) contadorMagiasBtn.textContent = magiasCount;
    
    atualizarInterfaceBolinhas();
    atualizarNivelNaTela();
    
    window.personagem = personagem;
}

function carregarCena(cenaId) {
    if (!cenaId) return;
    
    if (typeof cenaId === 'string') {
        const cena = historia.cenas[cenaId];
        if (!cena) {
            return;
        }
        capituloAtual = cena;
    } else {
        capituloAtual = cenaId;
    }
    
    if (!capituloAtual) return;
    
    if (capituloAtual.renderizar && typeof capituloAtual.renderizar === 'function') {
        
        if (capituloAtual.imagem && cenarioArea) {
            cenarioArea.style.backgroundImage = `url('${capituloAtual.imagem}')`;
        }
        
        if (npcsContainer) npcsContainer.innerHTML = '';
        
        capituloAtual.renderizar();
        
        if (cenaId === 'encontro_camponesa') {
            setAto(4, 'A Floresta - Encontro com Elara');
        }
        
        return;
    }
    
    if (cenaId === 'exterior_taverna' || cenaId === 'interior_taverna') {
        setAto(1, 'A Taverna');
    } else if (cenaId === 'interior_taverna_com_homem' || cenaId === 'homem_fala_detalhes') {
        setAto(2, 'O Homem Ferido');
    } else if (cenaId === 'sair_para_aventura') {
        setAto(3, 'A Miss√£o');
    } else if (cenaId === 'encontro_camponesa' || cenaId === 'carroca_destruida' || cenaId === 'clareira_goblins') {
        setAto(4, 'A Floresta');
    } else if (cenaId === 'entrada_caverna' || cenaId === 'camara_chefe') {
        setAto(5, 'A Caverna');
    } else if (cenaId === 'final_vitoria' || cenaId === 'final_taverna') {
        setAto(6, 'O Retorno');
    }
    
    if (capituloAtual.imagem && cenarioArea) {
        cenarioArea.style.backgroundImage = `url('${capituloAtual.imagem}')`;
    } else if (cenarioArea) {
        cenarioArea.style.backgroundImage = 'none';
    }
    
    if (npcsContainer) npcsContainer.innerHTML = '';
    if (capituloAtual.npcs && npcsContainer) {
        capituloAtual.npcs.forEach(npc => {
            if (npc.visivel === false) return;
            
            const npcDiv = document.createElement('div');
            npcDiv.className = 'npc-sprite';
            
            if (npc.id === 'taverneiro') {
                npcDiv.style.left = '85%';
                npcDiv.style.top = '60%';
            } else if (npc.id === 'homem_sangue') {
                npcDiv.style.left = '25%';
                npcDiv.style.top = '50%';
            } else {
                npcDiv.style.left = (npc.x || 50) + '%';
                npcDiv.style.top = (npc.y || 50) + '%';
            }
            
            npcDiv.dataset.npcId = npc.id;
            
            npcDiv.innerHTML = `
                <img src="${npc.sprite || 'default.png'}" alt="${npc.nome}">
                <div class="npc-nome">${npc.nome}</div>
            `;
            
            npcDiv.addEventListener('click', () => {
                falarComNPC(npc);
            });
            
            npcsContainer.appendChild(npcDiv);
        });
    }
    
    if (capituloAtual.fala) {
        if (npcNome) npcNome.textContent = capituloAtual.fala.npc || 'Narrador';
        if (capituloAtual.fala.avatar && npcAvatar) {
            npcAvatar.src = capituloAtual.fala.avatar;
            npcAvatar.style.display = 'inline';
        } else if (npcAvatar) {
            npcAvatar.style.display = 'none';
        }
        if (dialogoTexto) dialogoTexto.textContent = capituloAtual.fala.texto;
    } else if (dialogoTexto) {
        dialogoTexto.textContent = '...';
    }
    
    renderizarOpcoes(capituloAtual.opcoes);
    
    if (cenaId === 'interior_taverna') {
        iniciarTimerHomem();
    }
}

function renderizarOpcoes(opcoes) {
    if (!opcoesDialogo) return;
    opcoesDialogo.innerHTML = '';
    
    if (!opcoes || opcoes.length === 0) {
        const btnSair = document.createElement('button');
        btnSair.className = 'opcao-btn';
        btnSair.textContent = 'Sair da taverna';
        btnSair.addEventListener('click', () => {
            carregarCena('exterior_taverna');
        });
        opcoesDialogo.appendChild(btnSair);
        return;
    }
    
    opcoes.forEach(opcao => {
        const btn = document.createElement('button');
        btn.className = 'opcao-btn';
        btn.textContent = opcao.texto;
        
        btn.addEventListener('click', () => {
            if (opcao.proximo) {
                carregarCena(opcao.proximo);
            } else if (opcao.acao === 'iniciar_combate') {
                iniciarCombate(opcao.inimigos || []);
            } else if (opcao.resposta) {
                if (dialogoTexto) dialogoTexto.textContent = opcao.resposta;
            } else if (opcao.tipo === 'pagar') {
                if (personagem && personagem.dinheiro >= opcao.valor) {
                    personagem.dinheiro -= opcao.valor;
                    if (dialogoTexto) dialogoTexto.textContent = opcao.sucesso || 'Neg√≥cio feito!';
                    adicionarLog(`üí∞ Pagou ${opcao.valor} moedas`, 'sucesso');
                    atualizarFichaPersonagem();
                } else {
                    if (dialogoTexto) dialogoTexto.textContent = opcao.falha || 'Voc√™ n√£o tem dinheiro suficiente!';
                }
            } else if (opcao.item) {
                if (!personagem.inventario.mochila) personagem.inventario.mochila = [];
                personagem.inventario.mochila.push({
                    id: opcao.item.id,
                    nome: opcao.item.nome,
                    descricao: opcao.item.descricao,
                    peso: opcao.item.peso || 0.1,
                    quantidade: 1
                });
                adicionarLog(`üì¶ Voc√™ pegou: ${opcao.item.nome}`, 'sucesso');
                if (dialogoTexto) dialogoTexto.textContent = opcao.resposta || `Voc√™ pegou ${opcao.item.nome}.`;
            } else if (opcao.acao === 'finalizar_aventura') {
                adicionarLog('üéâ Aventura conclu√≠da! Parab√©ns!', 'sucesso');
                setTimeout(() => {
                    window.location.href = 'aventura-solo.html';
                }, 5000);
            }
            
            atualizarFichaPersonagem();
        });
        
        opcoesDialogo.appendChild(btn);
    });
}

function falarComNPC(npc) {
    if (npcNome) npcNome.textContent = npc.nome;
    if (npc.avatar && npcAvatar) {
        npcAvatar.src = npc.avatar;
        npcAvatar.style.display = 'inline';
    }
    if (dialogoTexto) dialogoTexto.textContent = npc.dialogo || '...';
    
    if (npc.opcoes) {
        renderizarOpcoes(npc.opcoes);
    } else {
        renderizarOpcoes([
            {
                texto: 'Sair da taverna',
                proximo: 'exterior_taverna'
            }
        ]);
    }
}

function iniciarTimerHomem() {
    if (timerHomem) {
        clearTimeout(timerHomem);
    }
    
    adicionarLog('‚è≥ Voc√™ pede uma cerveja e observa o ambiente...', 'info');
    
    timerHomem = setTimeout(() => {
        adicionarLog('üö™ A porta se abre violentamente! Um homem ensanguentado entra cambaleando!', 'dano');
        carregarCena('interior_taverna_com_homem');
    }, 40000);
}

function iniciarCombate(inimigosIds) {
    turnoAtual = 'jogador';
    if (turnoIndicator) {
        turnoIndicator.className = 'turno-indicator jogador';
        turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
    }
    
    inimigos = [];
    if (capituloAtual.inimigos) {
        inimigosIds.forEach(id => {
            const inimigoData = capituloAtual.inimigos.find(i => i.id === id);
            if (inimigoData) {
                inimigos.push({
                    ...inimigoData,
                    pv: inimigoData.pv || inimigoData.pv_max,
                    pv_max: inimigoData.pv_max || inimigoData.pv
                });
            }
        });
    }
    
    if (inimigos.length === 0) {
        inimigos = inimigosIds.map((id, index) => ({
            id: id,
            nome: `Inimigo ${index + 1}`,
            pv: 20,
            pv_max: 20,
            esquiva: 8,
            nh_ataque: 10,
            dano: "1d6"
        }));
    }
    
    if (inimigosContainer) inimigosContainer.style.display = 'block';
    renderizarInimigos();
    adicionarLog('‚öîÔ∏è COMBATE INICIADO!', 'sucesso');
}

function renderizarInimigos() {
    if (!inimigosLista) return;
    inimigosLista.innerHTML = inimigos.map((inimigo, index) => `
        <div class="inimigo-mini ${inimigoSelecionado === index ? 'selecionado' : ''}" data-index="${index}">
            <div class="inimigo-mini-nome">${inimigo.nome}</div>
            <div class="inimigo-mini-pv">
                <div class="inimigo-mini-pv-fill" style="width: ${(inimigo.pv / inimigo.pv_max) * 100}%"></div>
            </div>
            <div style="font-size:0.7rem; text-align:center;">${inimigo.pv}/${inimigo.pv_max}</div>
        </div>
    `).join('');
    
    document.querySelectorAll('.inimigo-mini').forEach(card => {
        card.addEventListener('click', () => {
            const index = parseInt(card.dataset.index);
            inimigoSelecionado = index;
            renderizarInimigos();
            if (btnAtacar) btnAtacar.disabled = false;
        });
    });
}

function getArmasEquipadas() {
    if (!personagem?.inventario?.corpo) return [];
    
    return personagem.inventario.corpo.filter(item => item.dano).map(item => ({
        id: item.id,
        nome: item.nome,
        dano: item.dano,
        tipo: item.tipoDano || 'Desconhecido',
        alcance: item.alcance || 1,
        st: item.st || 8
    }));
}

function abrirModalAtaque() {
    if (!modalAtaque) return;
    if (inimigoSelecionado === null) {
        adicionarLog('‚ùå Selecione um inimigo primeiro!', 'erro');
        return;
    }
    
    const armas = getArmasEquipadas();
    
    if (armas.length === 0) {
        adicionarLog('‚ùå Voc√™ n√£o tem armas equipadas!', 'erro');
        return;
    }
    
    armaSelecionada = null;
    if (btnConfirmarAtaque) btnConfirmarAtaque.disabled = true;
    
    if (armasLista) {
        armasLista.innerHTML = armas.map((arma, index) => `
            <div class="arma-card" data-index="${index}">
                <div class="arma-nome">${arma.nome}</div>
                <div class="arma-detalhes">
                    <span><i class="fas fa-tint"></i> Dano: ${arma.dano}</span>
                    <span><i class="fas fa-ruler"></i> Alcance: ${arma.alcance}m</span>
                </div>
            </div>
        `).join('');
    }
    
    document.querySelectorAll('.arma-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.arma-card').forEach(c => c.classList.remove('selecionada'));
            card.classList.add('selecionada');
            armaSelecionada = parseInt(card.dataset.index);
            if (btnConfirmarAtaque) btnConfirmarAtaque.disabled = false;
        });
    });
    
    modalAtaque.classList.add('active');
}

function executarAtaque() {
    if (armaSelecionada === null) return;
    
    const armas = getArmasEquipadas();
    const arma = armas[armaSelecionada];
    const inimigo = inimigos[inimigoSelecionado];
    
    if (!arma || !inimigo) return;
    
    if (modalAtaque) modalAtaque.classList.remove('active');
    
    const rolagem = rolar2d10();
    const dx = getValorAtributoReal('dx');
    const nhAtaque = dx + 3;
    
    adicionarLog(`üéØ Ataque: ${rolagem.texto} (NH ${nhAtaque})`, 'info');
    
    if (rolagem.total <= nhAtaque) {
        let dano = 0;
        if (arma.dano === "1d-2") dano = Math.max(0, Math.floor(Math.random() * 6) - 1);
        else if (arma.dano === "1d-1") dano = Math.max(0, Math.floor(Math.random() * 6) - 0);
        else if (arma.dano === "1d") dano = Math.floor(Math.random() * 6) + 1;
        else if (arma.dano === "1d+1") dano = Math.floor(Math.random() * 6) + 2;
        else if (arma.dano === "1d+2") dano = Math.floor(Math.random() * 6) + 3;
        else if (arma.dano === "2d-2") dano = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) - 2;
        else if (arma.dano === "2d") dano = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
        else if (arma.dano === "2d+2") dano = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 3;
        else dano = Math.floor(Math.random() * 6) + 1;
        
        dano = Math.max(0, dano);
        inimigo.pv -= dano;
        adicionarLog(`‚úÖ Acertou! Causou ${dano} de dano.`, 'dano');
        
        if (inimigo.pv <= 0) {
            adicionarLog(`üíÄ ${inimigo.nome} foi derrotado!`, 'sucesso');
            
            const xpGanho = inimigo.xp || 25;
            xpAtual += xpGanho;
            personagem.xp = xpAtual;
            adicionarLog(`‚ú® Ganhou ${xpGanho} XP!`, 'sucesso');
            verificarGanhoBolinha();
            
            inimigos = inimigos.filter((_, i) => i !== inimigoSelecionado);
            inimigoSelecionado = null;
        }
        
        renderizarInimigos();
        atualizarFichaPersonagem();
        
        if (inimigos.length === 0) {
            adicionarLog('üéâ VIT√ìRIA!', 'sucesso');
            if (inimigosContainer) inimigosContainer.style.display = 'none';
            
            if (capituloAtual.ao_vencer) {
                carregarCena(capituloAtual.ao_vencer);
            }
        } else {
            passarTurno();
        }
    } else {
        adicionarLog(`‚ùå Errou!`, 'erro');
        passarTurno();
    }
    
    salvarProgresso();
}

function passarTurno() {
    if (turnoAtual === 'jogador') {
        turnoAtual = 'inimigo';
        if (turnoIndicator) {
            turnoIndicator.className = 'turno-indicator inimigo';
            turnoIndicator.innerHTML = '<i class="fas fa-skull"></i> TURNO DOS INIMIGOS';
        }
        
        if (btnAtacar) btnAtacar.disabled = true;
        if (btnMagia) btnMagia.disabled = true;
        
        setTimeout(turnoInimigos, 1000);
    }
}

function turnoInimigos() {
    if (inimigos.length === 0) {
        turnoAtual = 'jogador';
        if (turnoIndicator) {
            turnoIndicator.className = 'turno-indicator jogador';
            turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
        }
        if (btnAtacar) btnAtacar.disabled = false;
        if (btnMagia) btnMagia.disabled = false;
        return;
    }
    
    inimigos.forEach(inimigo => {
        const rolagem = rolar2d10();
        
        if (rolagem.total <= (inimigo.nh_ataque || 10)) {
            let dano = 0;
            if (inimigo.dano === "1d-2") dano = Math.max(0, Math.floor(Math.random() * 6) - 1);
            else if (inimigo.dano === "1d-1") dano = Math.max(0, Math.floor(Math.random() * 6) - 0);
            else if (inimigo.dano === "1d") dano = Math.floor(Math.random() * 6) + 1;
            else if (inimigo.dano === "1d+1") dano = Math.floor(Math.random() * 6) + 2;
            else if (inimigo.dano === "1d+2") dano = Math.floor(Math.random() * 6) + 3;
            else if (inimigo.dano === "2d-2") dano = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) - 2;
            else if (inimigo.dano === "2d") dano = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
            else if (inimigo.dano === "2d+2") dano = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 3;
            else dano = Math.floor(Math.random() * 6) + 1;
            
            dano = Math.max(0, dano);
            pvAtual -= dano;
            if (personagem && personagem.statusCombate) personagem.statusCombate.vidaAtual = pvAtual;
            
            adicionarLog(`üëæ ${inimigo.nome} causou ${dano} de dano!`, 'dano');
            
            if (pvAtual <= 0) {
                pvAtual = 0;
                adicionarLog('üíÄ VOC√ä MORREU!', 'erro');
                return;
            }
            
            atualizarFichaPersonagem();
        }
    });
    
    turnoAtual = 'jogador';
    if (turnoIndicator) {
        turnoIndicator.className = 'turno-indicator jogador';
        turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
    }
    
    if (btnAtacar) btnAtacar.disabled = false;
    if (btnMagia) btnMagia.disabled = false;
    
    salvarProgresso();
}

function descansar() {
    pvAtual = Math.min(pvAtual + 5, pvMax);
    manaAtual = Math.min(manaAtual + 3, manaMax);
    fadigaAtual = Math.min(fadigaAtual + 2, fadigaMax);
    
    if (personagem && personagem.statusCombate) {
        personagem.statusCombate = {
            vidaAtual: pvAtual,
            vidaMax: pvMax,
            fadigaAtual: fadigaAtual,
            fadigaMax: fadigaMax,
            manaAtual: manaAtual,
            manaMax: manaMax
        };
    }
    
    atualizarFichaPersonagem();
    salvarProgresso();
    adicionarLog('üí§ Voc√™ descansou e recuperou energia.', 'sucesso');
}

async function salvarProgresso() {
    if (!personagem || !sessaoId) return;
    
    try {
        if (personagem && personagem.statusCombate) {
            personagem.statusCombate = {
                vidaAtual: pvAtual,
                vidaMax: pvMax,
                fadigaAtual: fadigaAtual,
                fadigaMax: fadigaMax,
                manaAtual: manaAtual,
                manaMax: manaMax
            };
        }
        personagem.xp = xpAtual;
        
        const personagemRef = doc(db, "personagens", personagem.id);
        await updateDoc(personagemRef, {
            statusCombate: personagem.statusCombate,
            xp: xpAtual,
            atributos: personagem.atributos,
            pmGasto: pmGasto
        });
        
    } catch (error) {
        adicionarLog('‚ùå Erro ao salvar progresso', 'erro');
    }
}

async function carregarPersonagem(personagemId) {
    try {
        const personagemRef = doc(db, "personagens", personagemId);
        const personagemSnap = await getDoc(personagemRef);
        
        if (!personagemSnap.exists()) {
            throw new Error('Personagem n√£o encontrado');
        }
        
        personagem = {
            id: personagemSnap.id,
            ...personagemSnap.data()
        };
        
        if (!personagem.inventario) {
            personagem.inventario = {
                corpo: [],
                mochila: [],
                deposito: []
            };
        }
        
        if (!personagem.atributos) {
            personagem.atributos = {
                st: { bolinhas: 0, valor: 9, base: 9 },
                dx: { bolinhas: 0, valor: 5, base: 5 },
                iq: { bolinhas: 0, valor: 5, base: 5 },
                ht: { bolinhas: 0, valor: 8, base: 8 }
            };
        } else {
            ['st', 'dx', 'iq', 'ht'].forEach(attr => {
                if (!personagem.atributos[attr]) {
                    const bases = { st: 9, dx: 5, iq: 5, ht: 8 };
                    personagem.atributos[attr] = { bolinhas: 0, valor: bases[attr], base: bases[attr] };
                } else {
                    if (!personagem.atributos[attr].base) {
                        const bases = { st: 9, dx: 5, iq: 5, ht: 8 };
                        personagem.atributos[attr].base = bases[attr];
                    }
                    if (!personagem.atributos[attr].valor) {
                        personagem.atributos[attr].valor = personagem.atributos[attr].base + (personagem.atributos[attr].bolinhas || 0);
                    }
                }
            });
        }
        
        if (!personagem.statusCombate) {
            personagem.statusCombate = {};
        }
        
        if (!personagem.vantagens) personagem.vantagens = [];
        if (!personagem.desvantagens) personagem.desvantagens = [];
        if (!personagem.pericias) personagem.pericias = {};
        if (!personagem.escolas) personagem.escolas = { agua: { magias: {} } };
        if (!personagem.pmDisponivel) personagem.pmDisponivel = 30;
        if (!personagem.pmGasto) personagem.pmGasto = 0;
        
        pvMax = calcularPVMax();
        pvAtual = personagem.statusCombate?.vidaAtual || pvMax;
        
        fadigaMax = calcularFadigaMax();
        fadigaAtual = personagem.statusCombate?.fadigaAtual || fadigaMax;
        
        manaMax = calcularManaMax();
        manaAtual = personagem.statusCombate?.manaAtual || manaMax;
        
        xpAtual = personagem.xp || 0;
        
        const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
        const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
        const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
        const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
        const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
        
        bolinhasDisponiveis = 0;
        let xpTemp = xpAtual;
        
        while (xpTemp >= XP_POR_BOLINHA) {
            bolinhasDisponiveis++;
            xpTemp -= XP_POR_BOLINHA;
        }
        
        atualizarFichaPersonagem();
        atualizarNivelNaTela();
        
        window.personagem = personagem;
        window.SistemaSocial = SistemaSocial;
        window.carregarCena = carregarCena;
        window.adicionarLog = adicionarLog;
        
    } catch (error) {
        if (dialogoTexto) dialogoTexto.textContent = '‚ùå Erro ao carregar personagem!';
        adicionarLog('‚ùå Erro ao carregar personagem!', 'erro');
    }
}

async function carregarAventura(aventuraId) {
    try {
        if (window.AVENTURA) {
            historia = window.AVENTURA;
        } else {
            let tentativas = 0;
            while (!window.AVENTURA && tentativas < 30) {
                await new Promise(r => setTimeout(r, 100));
                tentativas++;
            }
            
            if (window.AVENTURA) {
                historia = window.AVENTURA;
            } else {
                throw new Error(`Aventura "${aventuraId}" n√£o encontrada.`);
            }
        }
        
        const cenaInicialId = historia.cenaInicial;
        
        if (!cenaInicialId) {
            throw new Error('Cena inicial n√£o definida');
        }
        
        carregarCena(cenaInicialId);
        adicionarLog(`üìñ ${historia.nome} iniciada!`, 'sucesso');
        
    } catch (error) {
        if (dialogoTexto) dialogoTexto.textContent = `ERRO: ${error.message}`;
        
        if (opcoesDialogo) {
            opcoesDialogo.innerHTML = '';
            const btnVoltar = document.createElement('button');
            btnVoltar.className = 'opcao-btn';
            btnVoltar.textContent = 'Voltar √† sele√ß√£o';
            btnVoltar.addEventListener('click', () => {
                window.location.href = 'aventura-solo.html';
            });
            opcoesDialogo.appendChild(btnVoltar);
        }
    }
}

async function criarSessao() {
    const urlParams = new URLSearchParams(window.location.search);
    const aventuraId = urlParams.get('aventura');
    const personagemId = urlParams.get('personagem');
    
    if (!aventuraId || !personagemId) {
        alert('Aventura ou personagem n√£o selecionado!');
        window.location.href = 'aventura-solo.html';
        return;
    }
    
    showLoading();
    
    try {
        await carregarPersonagem(personagemId);
        await carregarAventura(aventuraId);
        
        const sessaoRef = doc(collection(db, "sessoes_aventura"));
        sessaoId = sessaoRef.id;
        
        await setDoc(sessaoRef, {
            id: sessaoId,
            userId: currentUser.uid,
            personagem_id: personagemId,
            aventura_id: aventuraId,
            pc_atual: personagem,
            cena_atual: historia?.cenaInicial || '',
            data_inicio: new Date().toISOString(),
            ultima_sessao: new Date().toISOString(),
            status: "em_andamento"
        });
        
    } catch (error) {
        adicionarLog('‚ùå Erro ao iniciar sess√£o', 'erro');
        if (dialogoTexto) dialogoTexto.textContent = '‚ùå Erro ao iniciar sess√£o.';
    } finally {
        hideLoading();
    }
}

// ============================================
// EVENT LISTENERS
// ============================================
onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        await criarSessao();
    } else {
        window.location.href = 'index.html';
    }
});

if (btnAtacar) btnAtacar.addEventListener('click', abrirModalAtaque);
if (btnMagia) btnMagia.addEventListener('click', () => adicionarLog('üîÆ Sistema de magias em desenvolvimento', 'info'));
if (btnInventario) btnInventario.addEventListener('click', abrirModalInventario);
if (btnDescansar) btnDescansar.addEventListener('click', descansar);

if (btnVerVantagens) btnVerVantagens.addEventListener('click', abrirModalVantagens);
if (btnVerDesvantagens) btnVerDesvantagens.addEventListener('click', abrirModalDesvantagens);
if (btnVerPericias) btnVerPericias.addEventListener('click', abrirModalPericias);
if (btnVerMagias) btnVerMagias.addEventListener('click', abrirModalMagias);

if (cancelarEscolhaAtributo) cancelarEscolhaAtributo.addEventListener('click', () => {
    if (modalEscolhaAtributo) modalEscolhaAtributo.classList.remove('active');
});

if (fecharModalInventario) fecharModalInventario.addEventListener('click', () => {
    if (modalInventario) modalInventario.classList.remove('active');
});

if (fecharModalVantagens) fecharModalVantagens.addEventListener('click', () => {
    if (modalVantagens) modalVantagens.classList.remove('active');
});

if (fecharModalDesvantagens) fecharModalDesvantagens.addEventListener('click', () => {
    if (modalDesvantagens) modalDesvantagens.classList.remove('active');
});

if (fecharModalPericias) fecharModalPericias.addEventListener('click', () => {
    if (modalPericias) modalPericias.classList.remove('active');
});

if (fecharModalMagias) fecharModalMagias.addEventListener('click', () => {
    if (modalMagias) modalMagias.classList.remove('active');
});

if (btnCancelarAtaque) btnCancelarAtaque.addEventListener('click', () => {
    if (modalAtaque) modalAtaque.classList.remove('active');
});

if (btnConfirmarAtaque) btnConfirmarAtaque.addEventListener('click', executarAtaque);

if (btnCancelarDefesa) btnCancelarDefesa.addEventListener('click', () => {
    if (modalDefesa) modalDefesa.classList.remove('active');
});

if (btnAbrirDados) btnAbrirDados.addEventListener('click', () => {
    if (modalDados) modalDados.classList.add('active');
});

if (btnFecharDados) btnFecharDados.addEventListener('click', () => {
    if (modalDados) modalDados.classList.remove('active');
});

if (btnRolarDados) btnRolarDados.addEventListener('click', () => {
    const qtd = parseInt(dadosQtd?.value) || 1;
    const faces = parseInt(dadosFaces?.value) || 10;
    const mod = parseInt(dadosMod?.value) || 0;
    
    const resultado = rolarDados(qtd, faces, mod);
    if (dadosResultado) dadosResultado.textContent = resultado.texto;
    adicionarLog(`üé≤ Rolagem: ${resultado.texto}`, 'info');
});

document.querySelectorAll('.atributo-opcao').forEach(opcao => {
    opcao.addEventListener('click', () => {
        const atributo = opcao.dataset.atributo;
        adicionarBolinha(atributo);
    });
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (modalEscolhaAtributo) modalEscolhaAtributo.classList.remove('active');
        if (modalInventario) modalInventario.classList.remove('active');
        if (modalVantagens) modalVantagens.classList.remove('active');
        if (modalDesvantagens) modalDesvantagens.classList.remove('active');
        if (modalPericias) modalPericias.classList.remove('active');
        if (modalMagias) modalMagias.classList.remove('active');
        if (modalAtaque) modalAtaque.classList.remove('active');
        if (modalDefesa) modalDefesa.classList.remove('active');
        if (modalDados) modalDados.classList.remove('active');
    }
});

setInterval(() => {
    if (personagem && sessaoId) {
        salvarProgresso();
    }
}, 30000);

window.personagem = personagem;
window.SistemaSocial = SistemaSocial;
window.carregarCena = carregarCena;
window.adicionarLog = adicionarLog;
</script>


<!-- AVENTURA COMPLETA -->
<script>
window.AVENTURA = {
    nome: "A Menina Elfa Raptada",
    descricao: "Uma aventura cl√°ssica come√ßando em uma taverna.",
    cenaInicial: "exterior_taverna",
    
    cenas: {
        exterior_taverna: {
            id: "exterior_taverna",
            nome: "Entrada da Taverna",
            imagem: "taverna-exterior.jpg",
            fala: {
                npc: "Narrador",
                texto: "Voc√™ chega a uma taverna aconchegante. O letreiro range com o vento: 'A Javali Sangrento'. Risadas e m√∫sica saem pelas frestas da porta."
            },
            npcs: [],
            opcoes: [
                {
                    texto: "Entrar na taverna",
                    proximo: "interior_taverna"
                }
            ]
        },
        
        interior_taverna: {
            id: "interior_taverna",
            nome: "Taverna A Javali Sangrento",
            imagem: "taverna-interior.jpg",
            fala: {
                npc: "Narrador",
                texto: "O calor da lareira e o cheiro de carne assada te recebem. A taverna est√° movimentada. Voc√™ encontra um lugar no balc√£o e o taverneiro se aproxima."
            },
            npcs: [
                {
                    id: "taverneiro",
                    nome: "Taverneiro",
                    sprite: "taverneiro.png",
                    dialogo: "Bem-vindo, viajante! Quer uma cerveja gelada? S√≥ 2 moedas.",
                    opcoes: [
                        {
                            texto: "üç∫ Comprar cerveja (2 moedas)",
                            tipo: "pagar",
                            valor: 2,
                            sucesso: "Sa√∫de! Uma boa cerveja sempre anima.",
                            falha: "Voc√™ n√£o tem dinheiro? Que pena..."
                        },
                        {
                            texto: "üì∞ Perguntar sobre novidades",
                            resposta: "Ora, tem havido problemas na estrada norte. Dizem que goblins est√£o atacando viajantes. Uns mercadores ontem mesmo falaram que ouviram gritos vindo da floresta..."
                        },
                        {
                            texto: "üíº Procurar trabalho",
                            resposta: "Sempre tem trabalho pra quem tem coragem. Fique por aqui, tome uma cerveja, e quem sabe aparece algo."
                        },
                        {
                            texto: "üó∫Ô∏è Conversar sobre a regi√£o",
                            resposta: "A regi√£o √© pacata, mas ultimamente... tem coisas estranhas acontecendo na floresta."
                        },
                        {
                            texto: "üëÄ Observar o ambiente enquanto bebe",
                            resposta: "Voc√™ pede uma cerveja e observa calmamente o movimento da taverna...",
                            acao: "iniciar_timer"
                        },
                        {
                            texto: "üö™ Sair da taverna",
                            proximo: "exterior_taverna"
                        }
                    ]
                }
            ],
            opcoes: []
        },
        
        interior_taverna_com_homem: {
            id: "interior_taverna_com_homem",
            nome: "Taverna - O Ferido Chega",
            imagem: "taverna-interior.jpg",
            fala: {
                npc: "Narrador",
                texto: "Enquanto voc√™ bebe sua cerveja e observa o ambiente, a porta se abre violentamente! Um homem ensanguentado entra cambaleando e cai perto da entrada."
            },
            npcs: [
                {
                    id: "taverneiro",
                    nome: "Taverneiro",
                    sprite: "taverneiro.png",
                    dialogo: "Pelos deuses! O que aconteceu com ele? Algu√©m ajude!",
                    opcoes: [
                        {
                            texto: "Falar com o taverneiro",
                            resposta: "V√° falar com ele, r√°pido! Ele precisa de ajuda!"
                        },
                        {
                            texto: "Sair da taverna",
                            proximo: "exterior_taverna"
                        }
                    ]
                },
                {
                    id: "homem_sangue",
                    nome: "Homem Ferido",
                    sprite: "npc-sangue.png",
                    dialogo: "Socorro... minha filha... os goblins... levaram minha filha! Por favor, algu√©m...",
                    opcoes: [
                        {
                            texto: "Falar com o homem ferido",
                            resposta: "Ele est√° fraco... voc√™ se aproxima para ouvir sua hist√≥ria.",
                            proximo: "homem_fala_detalhes"
                        },
                        {
                            texto: "Pedir para o taverneiro ajudar",
                            resposta: "O taverneiro corre para ajudar, mas o homem precisa de um aventureiro."
                        }
                    ]
                }
            ],
            opcoes: [
                {
                    texto: "Sair da taverna",
                    proximo: "exterior_taverna"
                }
            ]
        },
        
        homem_fala_detalhes: {
            id: "homem_fala_detalhes",
            nome: "O Desespero de um Pai",
            imagem: "taverna-interior.jpg",
            fala: {
                npc: "Homem Ferido",
                texto: "Eu vinha pela estrada norte com minha filha Lyra... Ela tem 10 anos, cabelos prateados... Fomos atacados por goblins! Eles levaram ela para a floresta! Por favor, algu√©m tem que salv√°-la!"
            },
            npcs: [
                {
                    id: "taverneiro",
                    nome: "Taverneiro",
                    sprite: "taverneiro.jpg",
                    dialogo: "Coitado. Eu avisei que a estrada estava perigosa. Algu√©m precisa ajudar esse homem.",
                    opcoes: [
                        {
                            texto: "Perguntar ao taverneiro sobre os goblins",
                            resposta: "Eles t√™m um acampamento na floresta, perto de uma caverna. V√°rios viajantes desapareceram por l√°."
                        },
                        {
                            texto: "Sair da taverna",
                            proximo: "exterior_taverna"
                        }
                    ]
                },
                {
                    id: "homem_sangue",
                    nome: "Eldrin (Pai de Lyra)",
                    sprite: "npc-sangue.jpg",
                    dialogo: "Minha esposa morreu no inverno... Lyra √© tudo que tenho! Por favor, aventureiro, voc√™ tem cara de ser corajoso...",
                    opcoes: [
                        {
                            texto: "‚úÖ ACEITAR MISS√ÉO - Salvar Lyra",
                            resposta: "Deus te aben√ßoe! Siga a estrada norte at√© a floresta!",
                            proximo: "sair_para_aventura"
                        },
                        {
                            texto: "Perguntar sobre os goblins",
                            resposta: "Eram uns 10... verdes, fedidos... Levaram ela para o norte, para a floresta escura."
                        },
                        {
                            texto: "Sair da taverna",
                            proximo: "exterior_taverna"
                        }
                    ]
                }
            ],
            opcoes: [
                {
                    texto: "Sair da taverna",
                    proximo: "exterior_taverna"
                }
            ]
        },
        
        sair_para_aventura: {
            id: "sair_para_aventura",
            nome: "Miss√£o Aceita",
            imagem: "taverna-exterior.jpg",
            fala: {
                npc: "Narrador",
                texto: "Voc√™ sai da taverna com determina√ß√£o. A estrada norte se estende diante de voc√™. O vento traz o cheiro da floresta distante."
            },
            npcs: [],
            opcoes: [
                {
                    texto: "Seguir para a estrada norte",
                    proximo: "encontro_camponesa"
                }
            ]
        },
        
   encontro_camponesa: {
    id: "encontro_camponesa",
    nome: "Estrada Norte - Encontro com a Camponesa",
    imagem: "estrada-norte.jpg",
    
    // Dados da NPC para o sistema social
    npcData: {
        nome: "Elara",
        genero: "feminino",
        iq: 12,
        reacaoBase: 10,
        personalidade: "curiosa mas cautelosa"
    },
    
    // Fun√ß√£o especial que ser√° chamada ao entrar na cena
    aoEntrar: function() {
        const reacao = SistemaSocial.testarReacao(this.npcData, window.personagem);
        adicionarLog(`üé≠ REA√á√ÉO DA CAMPONESA: ${reacao.classificacao.toUpperCase()} (${reacao.valor})`, 'info');
        adicionarLog(`   Rolagem: ${reacao.rolagem} | B√¥nus: +${reacao.bonusAparencia + reacao.bonusCarisma}`, 'info');
        this.reacaoAtual = reacao;
        return reacao;
    },
    
    // Di√°logos baseados na rea√ß√£o
    dialogo: {
        ruim: {
            texto: "Ela d√° um passo para tr√°s, segurando o cesto contra o peito. 'F-fique a√≠! N√£o se aproxime! Estranhos por aqui... nunca trazem nada de bom.' Sua m√£o treme enquanto ela procura uma rota de fuga.",
            tom: "amedrontado"
        },
        normal: {
            texto: "Ela te olha com curiosidade, mantendo uma dist√¢ncia segura. 'Ol√°, viajante. Raramente vejo algu√©m por essas bandas... Est√° perdido? Ou procurando algo espec√≠fico?'",
            tom: "curioso"
        },
        otima: {
            texto: "Ela sorri abertamente, seus olhos castanhos brilhando. 'Ol√°! Que bom ver um rosto novo por aqui! Me chamo Elara. Precisa de ajuda? Conhe√ßo bem essa regi√£o, posso te dar algumas dicas...'",
            tom: "acolhedor"
        }
    },
    
    // Informa√ß√µes que ela pode dar
    informacoes: {
        normal: [
            "Ultimamente tenho ouvido uivos estranhos vindo da floresta √† noite. Meu pai disse para eu n√£o me afastar muito de casa.",
            "Alguns mercadores mencionaram goblins nas colinas do norte. Fique atento."
        ],
        boa: [
            "Os goblins t√™m um acampamento perto da Caverna dos Esquecidos. Eles est√£o mais ousados ultimamente.",
            "Ouvi dizer que h√° uma recompensa por informa√ß√µes sobre desaparecimentos na estrada."
        ],
        otima: [
            "Meu tio, que √© ca√ßador, viu rastros de uma menina sendo levada para a caverna. Cabelos prateados, ele disse. E tamb√©m...",
            "H√° rumores de um antigo tesouro √©lfico escondido nas cavernas. Mas ningu√©m nunca voltou de l√° para confirmar."
        ]
    },
    
    // Estado da intera√ß√£o
    estado: {
        reacao: null,
        flerteTentado: false,
        infoRevelada: false
    },
    
    // ===== FUN√á√ÉO PRINCIPAL RENDERIZAR =====
    renderizar: function() {
        // Guarda refer√™ncia da cena para usar dentro dos eventos
        const cenaAtual = this;
        
        // Testar rea√ß√£o se n√£o tiver feito ainda
        if (!this.estado.reacao) {
            this.estado.reacao = this.aoEntrar();
        }
        
        const reacaoClass = this.estado.reacao.classificacao;
        const dialogoAtual = this.dialogo[reacaoClass];
        
        // Atualizar interface
        if (dialogoTexto) {
            dialogoTexto.textContent = dialogoAtual.texto;
        }
        if (npcNome) {
            npcNome.textContent = this.npcData.nome;
        }
        
        // Criar op√ß√µes baseadas na rea√ß√£o
        const opcoes = this.criarOpcoes(reacaoClass);
        
        // Renderizar op√ß√µes (passando o contexto)
        this.renderizarOpcoes(opcoes, cenaAtual);
    },
    
    // ===== CRIAR OP√á√ïES BASEADAS NA REA√á√ÉO =====
    criarOpcoes: function(reacaoClass) {
        const opcoesBase = [];
        
        // Verificar se tem Persuas√£o (per√≠cia social principal)
        const temPersuasao = window.personagem?.pericias?.persuasao?.nivel > 0;
        const nhPersuasao = temPersuasao ? 
            SistemaSocial.calcularNHPericia('persuasao', window.personagem) : 0;
        
        if (reacaoClass === 'ruim') {
            // Op√ß√£o de persuas√£o s√≥ aparece se tiver a per√≠cia
            if (temPersuasao) {
                opcoesBase.push(
                    {
                        texto: `üé≠ Tentar acalm√°-la (Persuas√£o NH ${nhPersuasao})`,
                        acao: "testeSocial",
                        tipo: "acalmar",
                        dificuldade: 12,
                        pericia: "persuasao",
                        nh: nhPersuasao
                    }
                );
            }
            
            // Op√ß√µes n√£o-sociais sempre dispon√≠veis
            opcoesBase.push(
                {
                    texto: "üö∂ Se afastar lentamente",
                    acao: "sair",
                    mensagem: "Voc√™ levanta as m√£os em gesto de paz e se afasta devagar. Ela suspira aliviada e desaparece na floresta.",
                    proximo: "carroca_destruida"
                },
                {
                    texto: "‚û°Ô∏è Ignorar e seguir caminho",
                    acao: "sair",
                    mensagem: "Ela foge correndo antes mesmo que voc√™ possa dizer algo. Que estranho...",
                    proximo: "carroca_destruida"
                }
            );
        }
        
        if (reacaoClass === 'normal') {
            // Op√ß√µes de informa√ß√£o sempre dispon√≠veis
            opcoesBase.push(
                {
                    texto: "üó∫Ô∏è Perguntar sobre a regi√£o",
                    acao: "info",
                    tipo: "normal"
                },
                {
                    texto: "üë∫ Perguntar sobre goblins",
                    acao: "info",
                    tipo: "goblins"
                },
                {
                    texto: "üëÄ Perguntar se viu algo estranho",
                    acao: "info",
                    tipo: "estranho"
                }
            );
            
            // Op√ß√£o de flerte s√≥ se tiver Persuas√£o
            if (temPersuasao) {
                opcoesBase.push(
                    {
                        texto: `üå∏ Elogiar suas flores (Persuas√£o NH ${nhPersuasao})`,
                        acao: "flerte",
                        pericia: "persuasao",
                        nh: nhPersuasao
                    }
                );
            }
            
            // Sair sempre dispon√≠vel
            opcoesBase.push(
                {
                    texto: "‚û°Ô∏è Se despedir e seguir viagem",
                    acao: "sair",
                    proximo: "carroca_destruida"
                }
            );
        }
        
        if (reacaoClass === 'otima') {
            // Op√ß√µes de informa√ß√£o avan√ßada
            opcoesBase.push(
                {
                    texto: "üëß Perguntar sobre a menina raptada",
                    acao: "info",
                    tipo: "menina"
                },
                {
                    texto: "üíé Perguntar sobre tesouros na regi√£o",
                    acao: "info",
                    tipo: "tesouro"
                },
                {
                    texto: "üë∫ Perguntar sobre os goblins (detalhado)",
                    acao: "info",
                    tipo: "goblins_avancado"
                }
            );
            
            // Op√ß√µes de flerte s√≥ se tiver Persuas√£o
            if (temPersuasao) {
                opcoesBase.push(
                    {
                        texto: `üòç Elogiar seus olhos (Persuas√£o NH ${nhPersuasao})`,
                        acao: "flerte",
                        pericia: "persuasao",
                        nh: nhPersuasao
                    },
                    {
                        texto: `üè† Oferecer companhia at√© sua cabana (Persuas√£o NH ${nhPersuasao})`,
                        acao: "flerte_avancado",
                        pericia: "persuasao",
                        nh: nhPersuasao
                    }
                );
            }
            
            // Sair sempre dispon√≠vel
            opcoesBase.push(
                {
                    texto: "‚û°Ô∏è Seguir viagem (prometendo voltar)",
                    acao: "sair",
                    proximo: "carroca_destruida"
                }
            );
        }
        
        return opcoesBase;
    },
    
    // ===== RENDERIZAR OP√á√ïES =====
    renderizarOpcoes: function(opcoes, cenaAtual) {
        if (!opcoesDialogo) return;
        opcoesDialogo.innerHTML = '';
        
        opcoes.forEach(opcao => {
            const btn = document.createElement('button');
            btn.className = 'opcao-btn';
            btn.textContent = opcao.texto;
            
            btn.addEventListener('click', () => {
                cenaAtual.processarAcao(opcao);
            });
            
            opcoesDialogo.appendChild(btn);
        });
    },
    
    // ===== PROCESSAR A√á√ÉO =====
    processarAcao: function(opcao) {
        switch(opcao.acao) {
            case 'testeSocial':
                this.realizarTesteSocial(opcao);
                break;
                
            case 'info':
                this.fornecerInfo(opcao.tipo);
                break;
                
            case 'flerte':
                this.iniciarFlerte(opcao);
                break;
                
            case 'flerte_avancado':
                this.flerteAvancado(opcao);
                break;
                
            case 'sair':
                if (opcao.mensagem && dialogoTexto) {
                    dialogoTexto.textContent = opcao.mensagem;
                    
                    // Transi√ß√£o narrativa para a carro√ßa
                    if (opcao.proximo === 'carroca_destruida') {
                        setTimeout(() => {
                            if (opcao.texto.includes("Se despedir") || opcao.texto.includes("Seguir")) {
                                dialogoTexto.textContent = "Voc√™ continua pela estrada, os pensamentos ainda na conversa. O sol filtra pelas √°rvores quando algo chama sua aten√ß√£o √† frente...";
                            } else if (opcao.texto.includes("afastar")) {
                                dialogoTexto.textContent = "Depois de se afastar, voc√™ retoma seu caminho. A floresta parece mais silenciosa agora. Alguns minutos depois, avista algo na estrada...";
                            } else {
                                dialogoTexto.textContent = "Voc√™ segue viagem, processando o encontro. A estrada se estende √† frente e logo voc√™ encontra algo inesperado...";
                            }
                            setTimeout(() => carregarCena(opcao.proximo), 2000);
                        }, 2000);
                    } else {
                        setTimeout(() => carregarCena(opcao.proximo), 2000);
                    }
                } else {
                    carregarCena(opcao.proximo);
                }
                break;
        }
    },
    
    // ===== TESTE SOCIAL (Persuas√£o) =====
    realizarTesteSocial: function(opcao) {
        // Usa o NH real da per√≠cia Persuas√£o
        const nhJogador = opcao.nh;
        const dificuldade = opcao.dificuldade;
        
        const resultado = SistemaSocial.testeSocial(nhJogador, dificuldade);
        
        adicionarLog(`üé≤ TESTE DE PERSUAS√ÉO:`, 'info');
        adicionarLog(`   NH: ${nhJogador} vs Dificuldade ${dificuldade}`, 'info');
        adicionarLog(`   Rolagem: ${resultado.rolagem}`, 'info');
        adicionarLog(`   Margem: ${resultado.margem}`, 'info');
        
        if (resultado.sucesso) {
            if (resultado.critico) {
                adicionarLog(`‚ú® SUCESSO CR√çTICO!`, 'sucesso');
                dialogoTexto.textContent = "Suas palavras s√£o t√£o convincentes que ela relaxa completamente. 'Desculpe meu medo... voc√™ parece ser uma boa pessoa. Como posso ajudar?'";
                this.estado.reacao.classificacao = 'otima';
            } else {
                adicionarLog(`‚úÖ SUCESSO!`, 'sucesso');
                dialogoTexto.textContent = "Ela parece se acalmar um pouco. 'Tudo bem... acho que me assustei √† toa. Viajantes normalmente s√£o pac√≠ficos.'";
                this.estado.reacao.classificacao = 'normal';
            }
            
            setTimeout(() => this.renderizar(), 2000);
            
        } else {
            if (resultado.falhaCritica) {
                adicionarLog(`üí• FALHA CR√çTICA!`, 'erro');
                dialogoTexto.textContent = "Suas palavras saem completamente erradas! Ela grita e sai correndo floresta adentro, deixando o cesto para tr√°s.";
                
                // Transi√ß√£o narrativa
                setTimeout(() => {
                    dialogoTexto.textContent = "Voc√™ suspira, frustrado com o fracasso. Continuando pela estrada, logo encontra vest√≠gios de viol√™ncia...";
                    setTimeout(() => carregarCena('carroca_destruida'), 2000);
                }, 2000);
            } else {
                adicionarLog(`‚ùå FALHA!`, 'erro');
                dialogoTexto.textContent = "Ela n√£o parece confiar em voc√™. 'Achei melhor ir embora...' Ela se afasta rapidamente.";
                
                // Transi√ß√£o narrativa
                setTimeout(() => {
                    dialogoTexto.textContent = "Voc√™ a observa desaparecer na floresta. Retomando seu caminho, alguns minutos depois avista algo estranho na estrada...";
                    setTimeout(() => carregarCena('carroca_destruida'), 2000);
                }, 2000);
            }
        }
    },
    
    // ===== FORNECER INFORMA√á√ÉO =====
    fornecerInfo: function(tipo) {
        const reacaoClass = this.estado.reacao.classificacao;
        let info = "";
        
        if (reacaoClass === 'normal') {
            if (tipo === 'normal') {
                info = this.informacoes.normal[0];
            } else if (tipo === 'goblins') {
                info = this.informacoes.normal[1];
            } else if (tipo === 'estranho') {
                info = "S√≥ esses barulhos na floresta mesmo... e uns mercadores que passaram apressados ontem.";
            }
            adicionarLog(`‚ÑπÔ∏è Informa√ß√£o obtida (Rea√ß√£o Normal)`, 'info');
        }
        
        if (reacaoClass === 'otima') {
            if (tipo === 'menina') {
                info = this.informacoes.otima[0];
                adicionarLog(`üîç INFORMA√á√ÉO IMPORTANTE: Localiza√ß√£o da menina!`, 'sucesso');
                
                if (!this.estado.infoRevelada) {
                    this.estado.infoRevelada = true;
                    
                    setTimeout(() => {
                        if (confirm("Elara hesita... 'Olha, n√£o conte a ningu√©m, mas posso te dar um amuleto de prote√ß√£o. Minha av√≥ disse que traz sorte.'")) {
                            if (!window.personagem.inventario.mochila) window.personagem.inventario.mochila = [];
                            window.personagem.inventario.mochila.push({
                                id: "amuleto_elara",
                                nome: "Amuleto de Elara",
                                descricao: "Um pequeno amuleto de madeira com runas desgastadas.",
                                peso: 0.1
                            });
                            adicionarLog("üìø Voc√™ ganhou: Amuleto de Elara", "sucesso");
                        }
                    }, 3000);
                }
            } else if (tipo === 'tesouro') {
                info = this.informacoes.otima[1];
                adicionarLog(`üí∞ Informa√ß√£o de tesouro obtida!`, 'sucesso');
            } else if (tipo === 'goblins_avancado') {
                info = "Eles est√£o acampados perto da Caverna dos Esquecidos. Dizem que t√™m um chefe grande e forte. Cuidado!";
                adicionarLog(`‚öîÔ∏è Informa√ß√£o avan√ßada sobre os goblins!`, 'sucesso');
            }
        }
        
        if (dialogoTexto) {
            dialogoTexto.textContent = info;
        }
        
        setTimeout(() => this.renderizar(), 4000);
    },
    
    // ===== INICIAR FLERTE =====
    iniciarFlerte: function(opcao) {
        if (this.estado.flerteTentado) {
            dialogoTexto.textContent = "Ela ri, corando. 'Outra hora, talvez... V√°, sua aventura te espera.'";
            
            // Transi√ß√£o narrativa
            setTimeout(() => {
                dialogoTexto.textContent = "Voc√™ sorri e se despede. Seguindo pela estrada, logo encontra os destro√ßos de uma carro√ßa...";
                setTimeout(() => carregarCena('carroca_destruida'), 2000);
            }, 2000);
            return;
        }
        
        this.estado.flerteTentado = true;
        
        // Usa o NH real da per√≠cia vindo da op√ß√£o
        const nhFlerte = opcao.nh;
        
        adicionarLog(`üíò INICIANDO FLERTE...`, 'info');
        adicionarLog(`   NH: ${nhFlerte}`, 'info');
        
        dialogoTexto.textContent = "Voc√™ comenta que as flores que ela colhe s√£o bonitas, e que combinam com seus olhos. Ela cora levemente.";
        
        setTimeout(() => {
            const opcoesFlerte = [
                {
                    texto: `üíò Ser direto: "Posso te ver quando voltar?" (NH ${nhFlerte})`,
                    acao: "testeFlerte",
                    nh: nhFlerte
                },
                {
                    texto: "üòÖ Recuar educadamente: 'Foi s√≥ um elogio, n√£o se preocupe'",
                    acao: "sairFlerte"
                },
                {
                    texto: "üó£Ô∏è Mudar de assunto (voltar √†s perguntas)",
                    acao: "voltarInfo"
                }
            ];
            
            this.renderizarOpcoesFlerte(opcoesFlerte);
        }, 2000);
    },
    
    // ===== RENDERIZAR OP√á√ïES DE FLERTE =====
    renderizarOpcoesFlerte: function(opcoes) {
        if (!opcoesDialogo) return;
        
        const cenaAtual = this;
        opcoesDialogo.innerHTML = '';
        
        opcoes.forEach(opcao => {
            const btn = document.createElement('button');
            btn.className = 'opcao-btn';
            btn.textContent = opcao.texto;
            
            btn.addEventListener('click', () => {
                if (opcao.acao === 'testeFlerte') {
                    cenaAtual.testeFlerte(opcao.nh);
                } else if (opcao.acao === 'sairFlerte') {
                    dialogoTexto.textContent = "Ela sorri, aliviada. 'Foi bom te conhecer. Boa sorte na sua jornada!'";
                    
                    // Transi√ß√£o narrativa
                    setTimeout(() => {
                        dialogoTexto.textContent = "Voc√™ se despede e continua seu caminho. A estrada segue serpenteando pela floresta at√© que algo chama sua aten√ß√£o...";
                        setTimeout(() => carregarCena('carroca_destruida'), 2000);
                    }, 2000);
                } else if (opcao.acao === 'voltarInfo') {
                    cenaAtual.renderizar();
                }
            });
            
            opcoesDialogo.appendChild(btn);
        });
    },
    
    // ===== TESTE DE FLERTE =====
    testeFlerte: function(nh) {
        const resultado = SistemaSocial.testeSocial(nh, 12);
        
        adicionarLog(`üíò TESTE DE FLERTE:`, 'info');
        adicionarLog(`   NH: ${nh} vs Vontade dela: 12`, 'info');
        adicionarLog(`   Rolagem: ${resultado.rolagem}`, 'info');
        adicionarLog(`   Margem: ${resultado.margem}`, 'info');
        
        if (resultado.sucesso) {
            if (resultado.critico) {
                adicionarLog(`‚ú® SUCESSO CR√çTICO! Ela se encantou!`, 'sucesso');
                dialogoTexto.textContent = "Ela cora intensamente e sorri. 'Voc√™ √© diferente... Sim, adoraria te ver de novo. Volte quando sua miss√£o acabar, prometo estar aqui.' Ela te d√° uma flor como lembran√ßa.";
                
                if (!window.personagem.inventario.mochila) window.personagem.inventario.mochila = [];
                window.personagem.inventario.mochila.push({
                    id: "flor_elara",
                    nome: "Flor de Elara",
                    descricao: "Uma flor silvestre que ela te deu. Ainda tem seu perfume.",
                    peso: 0.01
                });
                adicionarLog(`üå∏ Voc√™ ganhou: Flor de Elara`, 'sucesso');
                
                // Transi√ß√£o narrativa
                setTimeout(() => {
                    dialogoTexto.textContent = "Com o cora√ß√£o mais leve, voc√™ continua sua jornada. A estrada o leva adiante, at√© que avista algo peculiar...";
                    setTimeout(() => carregarCena('carroca_destruida'), 2000);
                }, 3000);
            } else {
                adicionarLog(`‚úÖ Sucesso no flerte!`, 'sucesso');
                dialogoTexto.textContent = "Ela sorri, meio sem gra√ßa. 'Quem sabe... quando voc√™ voltar da sua miss√£o, podemos conversar mais. Agora vai, eles precisam de voc√™.'";
                
                // Transi√ß√£o narrativa
                setTimeout(() => {
                    dialogoTexto.textContent = "Voc√™ se despede com um aceno. Seguindo pela estrada, logo encontra os vest√≠gios de um ataque recente...";
                    setTimeout(() => carregarCena('carroca_destruida'), 2000);
                }, 3000);
            }
            
        } else {
            if (resultado.falhaCritica) {
                adicionarLog(`üí• FALHA CR√çTICA! Ela ficou ofendida!`, 'erro');
                dialogoTexto.textContent = "Ela parece ofendida. 'Isso √© inapropriado! Adeus!' Ela se afasta rapidamente.";
                
                // Transi√ß√£o narrativa
                setTimeout(() => {
                    dialogoTexto.textContent = "Constrangido, voc√™ segue viagem. Mais adiante, avista uma carro√ßa destru√≠da na beira da estrada...";
                    setTimeout(() => carregarCena('carroca_destruida'), 2000);
                }, 2000);
            } else {
                adicionarLog(`‚ùå Falha no flerte. Ela n√£o se interessou.`, 'erro');
                dialogoTexto.textContent = "Ela parece desconfort√°vel. 'Acho melhor voc√™ seguir seu caminho...' Ela se afasta, encerrando a conversa.";
                
                // Transi√ß√£o narrativa
                setTimeout(() => {
                    dialogoTexto.textContent = "Sem jeito, voc√™ continua pela estrada. O sil√™ncio da floresta √© interrompido quando voc√™ avista algo √† frente...";
                    setTimeout(() => carregarCena('carroca_destruida'), 2000);
                }, 2000);
            }
        }
    },
    
    // ===== FLERTE AVAN√áADO =====
    flerteAvancado: function(opcao) {
        if (this.estado.flerteTentado) {
            dialogoTexto.textContent = "Ela sorri. 'Voc√™ √© persistente... Gosto disso. Mas agora n√£o √© hora. V√° salvar aquela menina.'";
            
            // Transi√ß√£o narrativa
            setTimeout(() => {
                dialogoTexto.textContent = "Voc√™ acena, compreendendo. A estrada o chama e logo voc√™ encontra os vest√≠gios do ataque...";
                setTimeout(() => carregarCena('carroca_destruida'), 2000);
            }, 2000);
            return;
        }
        
        this.estado.flerteTentado = true;
        
        // Usa o NH real da per√≠cia vindo da op√ß√£o
        const nhFlerte = opcao.nh;
        
        adicionarLog(`üíò FLERTE AVAN√áADO...`, 'info');
        adicionarLog(`   NH: ${nhFlerte}`, 'info');
        
        dialogoTexto.textContent = "'Oferecer companhia?' Ela ri suavemente. 'Voc√™ √© gentil, mas conhe√ßo bem essa floresta. Mas... se quiser me fazer companhia quando voltar, adoraria.'";
        
        setTimeout(() => {
            const opcoes = [
                {
                    texto: `üíò "Combinado ent√£o. Posso te dar algo quando voltar?" (NH ${nhFlerte})`,
                    acao: "testeFlerte",
                    nh: nhFlerte
                },
                {
                    texto: "üòä 'Ent√£o est√° combinado. Vou voltar assim que poss√≠vel.'",
                    acao: "sairFlerte"
                }
            ];
            
            this.renderizarOpcoesFlerte(opcoes);
        }, 2000);
    }
},
        carroca_destruida: {
            id: "carroca_destruida",
            nome: "Local do Ataque",
            imagem: "carroca.jpg",
            fala: {
                npc: "Narrador",
                texto: "Voc√™ encontra uma carro√ßa destru√≠da na estrada. Manchas de sangue se espalham pela madeira. Uma boneca de pano est√° ca√≠da na lama."
            },
            npcs: [],
            opcoes: [
                {
                    texto: "Pegar a boneca (ser√° importante)",
                    item: {
                        id: "boneca_lyra",
                        nome: "Boneca de Lyra",
                        descricao: "Uma boneca suja, provavelmente da menina.",
                        peso: 0.2
                    },
                    resposta: "Voc√™ guarda a boneca. Pode ser importante."
                },
                {
                    texto: "Seguir os rastros dos goblins",
                    proximo: "clareira_goblins"
                }
            ]
        },
        
        clareira_goblins: {
            id: "clareira_goblins",
            nome: "Clareira na Floresta",
            imagem: "clareira-globlins.jpg",
            fala: {
                npc: "Narrador",
                texto: "Voc√™ encontra uma clareira onde v√°rios goblins est√£o acampados perto de uma fogueira."
            },
            inimigos: [
                {
                    id: "goblin1",
                    nome: "Goblin",
                    sprite: "goblin.jpg",
                    pv: 58,
                    pv_max: 58,
                    esquiva: 7,
                    nh_ataque: 8,
                    dano: "1d-2",
                    xp: 25
                },
                {
                    id: "goblin2",
                    nome: "Goblin",
                    sprite: "goblin.png",
                    pv: 58,
                    pv_max: 58,
                    esquiva: 7,
                    nh_ataque: 8,
                    dano: "1d-2",
                    xp: 25
                }
            ],
            opcoes: [
                {
                    texto: "Atacar os goblins",
                    acao: "iniciar_combate",
                    inimigos: ["goblin1", "goblin2"],
                    ao_vencer: "entrada_caverna"
                }
            ]
        },
        
        entrada_caverna: {
            id: "entrada_caverna",
            nome: "Entrada da Caverna",
            imagem: "entrada-caverna.jpg",
            fala: {
                npc: "Narrador",
                texto: "Uma abertura escura na rocha. Voc√™ ouve vozes ecoando."
            },
            opcoes: [
                {
                    texto: "Entrar na caverna",
                    proximo: "camara_chefe"
                }
            ]
        },
        
        camara_chefe: {
            id: "camara_chefe",
            nome: "C√¢mara do Chefe",
            imagem: "menina-elfa.jpg",
            fala: {
                npc: "Narrador",
                texto: "Numa jaula, uma menina elfa de cabelos prateados est√° sentada, assustada. Um goblin grande monta guarda."
            },
            npcs: [
                {
                    id: "menina_elfa",
                    nome: "Lyra",
                    sprite: "menina-elfa.jpg",
                    dialogo: "Por favor, me ajude!"
                },
                {
                    id: "chefe_goblin",
                    nome: "Chefe Goblin",
                    sprite: "chefe-goblin.png"
                }
            ],
            inimigos: [
                {
                    id: "chefe_goblin",
                    nome: "Chefe Goblin",
                    sprite: "chefe-goblin.png",
                    pv: 85,
                    pv_max: 85,
                    esquiva: 8,
                    nh_ataque: 10,
                    dano: "2d+2",
                    xp: 100
                }
            ],
            opcoes: [
                {
                    texto: "Atacar o chefe!",
                    acao: "iniciar_combate",
                    inimigos: ["chefe_goblin"],
                    ao_vencer: "final_vitoria"
                }
            ]
        },
        
        final_vitoria: {
            id: "final_vitoria",
            nome: "Miss√£o Cumprida",
            imagem: "menina-elfa.jpg",
            fala: {
                npc: "Lyra",
                texto: "Voc√™ me salvou! Muito obrigada!"
            },
            opcoes: [
                {
                    texto: "Voltar √† taverna",
                    proximo: "final_taverna"
                }
            ]
        },
        
        final_taverna: {
            id: "final_taverna",
            nome: "Retorno Triunfal",
            imagem: "taverna-interior.jpg",
            fala: {
                npc: "Eldrin",
                texto: "MINHA FILHA! Voc√™ conseguiu! Muito obrigado, aventureiro!"
            },
            npcs: [
                {
                    id: "homem",
                    nome: "Eldrin",
                    sprite: "npc-sangue.jpg"
                },
                {
                    id: "lyra",
                    nome: "Lyra",
                    sprite: "menina-elfa.jpg"
                },
                {
                    id: "taverneiro",
                    nome: "Taverneiro",
                    sprite: "taverneiro.jpg"
                }
            ],
            opcoes: [
                {
                    texto: "Encerrar aventura",
                    acao: "finalizar_aventura"
                }
            ]
        }
    }
};
</script>
</body>
</html>