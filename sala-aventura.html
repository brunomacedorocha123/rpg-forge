<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Aventura - Modo Clássico - RPGForce</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
   <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #2a1a3a 100%);
        min-height: 100vh;
        color: #fff;
    }

    .magic-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
    }

    .magic-bg::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
        animation: pulse 8s ease-in-out infinite;
    }

    .magic-bg::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 80% 80%, rgba(198, 40, 40, 0.1) 0%, transparent 50%);
        animation: pulse 10s ease-in-out infinite reverse;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
    }

    .game-container {
        position: relative;
        z-index: 1;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* HEADER COM STATUS DO PERSONAGEM */
    .game-header {
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 2px solid #ffd700;
        padding: 8px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        z-index: 20;
    }

    .personagem-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .personagem-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #ffd700;
        overflow: hidden;
        background: #1a1a3a;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .personagem-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .personagem-nome {
        font-family: 'MedievalSharp', cursive;
        font-size: 1.2rem;
        color: #ffd700;
    }

    .status-bars {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .status-item {
        min-width: 140px;
    }

    .status-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
        margin-bottom: 3px;
    }

    .status-label i {
        color: #ffd700;
        margin-right: 5px;
    }

    .status-bar {
        height: 10px;
        background: rgba(0,0,0,0.5);
        border-radius: 5px;
        overflow: hidden;
        border: 1px solid rgba(255,215,0,0.3);
    }

    .status-fill {
        height: 100%;
        transition: width 0.3s;
    }

    .status-fill.vida { background: linear-gradient(90deg, #ff4d4d, #ff1a1a); }
    .status-fill.mana { background: linear-gradient(90deg, #4d4dff, #1a1aff); }
    .status-fill.fadiga { background: linear-gradient(90deg, #ffaa00, #ff8800); }
    .status-fill.xp { background: linear-gradient(90deg, #4CAF50, #8BC34A); }

    .pm-display {
        background: linear-gradient(45deg, #9c27b0, #673ab7);
        padding: 5px 15px;
        border-radius: 30px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #ffd700;
    }

    .pm-display i { color: #ffd700; }

    /* ÁREA PRINCIPAL - TRÊS COLUNAS */
    .main-area {
        flex: 1;
        display: flex;
        overflow: hidden;
        min-height: 0;
    }

    /* COLUNA ESQUERDA - FICHA DO PERSONAGEM */
    .ficha-coluna {
        width: 300px;
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(10px);
        border-right: 2px solid rgba(255,215,0,0.3);
        padding: 15px;
        overflow-y: auto;
        z-index: 15;
    }

    .ficha-header {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255,215,0,0.2);
    }

    .ficha-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 3px solid #ffd700;
        margin: 0 auto 10px;
        overflow: hidden;
        background: #1a1a3a;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ficha-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .ficha-nome {
        font-size: 1.2rem;
        font-weight: bold;
        color: #ffd700;
        font-family: 'MedievalSharp', cursive;
    }

    .ficha-classe {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.6);
    }

    /* INDICADOR DE NÍVEL DO PERSONAGEM (NOVO) */
    .nivel-indicator {
        background: linear-gradient(45deg, #4a2a6a, #2a1a4a);
        border: 2px solid #ffd700;
        border-radius: 30px;
        padding: 10px 15px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }

    .nivel-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #ffd700;
        font-weight: bold;
    }

    .nivel-info i {
        font-size: 1.2rem;
    }

    .nivel-valor {
        background: #ffd700;
        color: #0a0a1a;
        padding: 5px 15px;
        border-radius: 30px;
        font-size: 1.5rem;
        font-weight: bold;
        font-family: 'MedievalSharp', cursive;
        min-width: 50px;
        text-align: center;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    /* INDICADOR DE ATO */
    .ato-indicator {
        background: rgba(255,215,0,0.2);
        border-left: 4px solid #ffd700;
        padding: 5px 15px;
        font-family: 'MedievalSharp', cursive;
        font-size: 1rem;
        color: #ffd700;
        text-shadow: 0 0 10px rgba(255,215,0,0.5);
        margin: 10px 0;
    }
    
    .ato-indicator i {
        margin-right: 8px;
        color: #ffaa00;
    }

    /* BOLINHAS DISPONÍVEIS */
    .bolinhas-saldo {
        background: linear-gradient(45deg, #4CAF50, #2E7D32);
        border-radius: 30px;
        padding: 12px 15px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: bold;
        border: 2px solid #ffd700;
        box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
    }

    .bolinhas-saldo i {
        color: #ffd700;
        margin-right: 8px;
    }

    .bolinhas-saldo .valor {
        background: #ffd700;
        color: #0a0a1a;
        padding: 5px 15px;
        border-radius: 30px;
        font-size: 1.3rem;
        font-weight: bold;
        min-width: 50px;
        text-align: center;
    }

    /* ATRIBUTOS */
    .atributos-container {
        margin: 15px 0;
    }

    .atributo-card {
        background: rgba(0,0,0,0.3);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid rgba(255,215,0,0.2);
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .atributo-card:hover {
        background: rgba(255,215,0,0.1);
        transform: translateX(5px);
    }

    .atributo-card.bolinha-disponivel {
        border-color: #4CAF50;
        animation: pulseVerde 1.5s infinite;
        background: rgba(76,175,80,0.1);
    }

    @keyframes pulseVerde {
        0% { box-shadow: 0 0 0 0 rgba(76,175,80,0.7); }
        70% { box-shadow: 0 0 0 10px rgba(76,175,80,0); }
        100% { box-shadow: 0 0 0 0 rgba(76,175,80,0); }
    }

    .atributo-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .atributo-nome {
        font-weight: bold;
        color: #ffd700;
        width: 40px;
    }

    .atributo-bolinhas {
        display: flex;
        gap: 2px;
    }

    .bolinha-pequena {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(255,215,0,0.2);
        border: 1px solid rgba(255,215,0,0.3);
    }

    .bolinha-pequena.preenchida {
        background: #ffd700;
    }

    .atributo-valor {
        font-weight: bold;
        font-size: 1.2rem;
        color: #ffd700;
    }

    .atributo-base {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
    }

    /* DEFESAS */
    .defesas-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
        margin: 15px 0;
    }

    .defesa-card {
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        padding: 8px;
        text-align: center;
        border: 1px solid rgba(255,215,0,0.2);
    }

    .defesa-valor {
        font-size: 1.2rem;
        font-weight: bold;
        color: #ffd700;
    }

    .defesa-label {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.6);
    }

    /* BOTÕES DE FICHA */
    .ficha-botoes {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin: 15px 0;
    }

    .ficha-botao {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.3);
        border-radius: 10px;
        padding: 12px 5px;
        color: #ffd700;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }

    .ficha-botao i {
        font-size: 1.2rem;
    }

    .ficha-botao:hover {
        background: rgba(255,215,0,0.2);
        border-color: #ffd700;
        transform: translateY(-3px);
    }

    .ficha-botao .contador {
        background: #ffd700;
        color: #0a0a1a;
        border-radius: 30px;
        padding: 2px 8px;
        font-size: 0.7rem;
        margin-top: 2px;
    }

    /* COLUNA CENTRAL - CENÁRIO */
    .cenario-coluna {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background: rgba(0,0,0,0.5);
    }

    .cenario-area {
        flex: 1;
        position: relative;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-color: #1a1a3a;
        min-height: 0;
    }

    .cenario-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, rgba(0,0,0,0.3) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.3) 100%);
        pointer-events: none;
    }

    .npcs-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
    }

    /* NPCs */
    .npc-sprite {
        position: absolute;
        transform: translate(-50%, -50%);
        cursor: pointer;
        pointer-events: auto;
        transition: all 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.2);
        filter: drop-shadow(0 10px 8px rgba(0, 0, 0, 0.5));
        z-index: 10;
    }

    .npc-sprite:hover {
        transform: translate(-50%, -60%) scale(1.08);
        filter: drop-shadow(0 15px 15px rgba(255, 215, 0, 0.3));
        z-index: 100;
    }

    .npc-sprite img {
        width: 150px;
        height: 200px;
        object-fit: cover;
        object-position: center;
        border: none !important;
        background: transparent !important;
        background-color: transparent !important;
        box-shadow: none !important;
        outline: none !important;
        display: block;
        transition: all 0.3s ease;
    }

    .npc-sprite .npc-nome {
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%);
        background: #000000;
        color: #ffd700;
        padding: 6px 20px;
        border-radius: 40px;
        font-size: 0.95rem;
        font-weight: bold;
        white-space: nowrap;
        border: 2px solid #ffd700;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.8);
        letter-spacing: 1.5px;
        font-family: 'MedievalSharp', cursive;
        z-index: 30;
        pointer-events: none;
        text-shadow: 0 2px 4px #000000;
        opacity: 1;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
    }

    /* CAIXA DE DIÁLOGO */
    .dialogo-area {
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(10px);
        border-top: 2px solid rgba(255,215,0,0.3);
        padding: 15px 20px;
        min-height: 120px;
        max-height: 200px;
        overflow-y: auto;
    }

    .npc-falando {
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .npc-falando img {
        display: none;
    }

    .dialogo-texto {
        color: rgba(255,255,255,0.9);
        line-height: 1.5;
        margin-bottom: 10px;
        font-style: italic;
        padding-left: 10px;
        border-left: 3px solid #ffd700;
    }

    .opcoes-dialogo {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .opcao-btn {
        background: rgba(255,215,0,0.1);
        border: 1px solid #ffd700;
        color: #fff;
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
    }

    .opcao-btn:hover {
        background: #ffd700;
        color: #0a0a1a;
    }

    /* COLUNA DIREITA - AÇÕES */
    .acoes-coluna {
        width: 280px;
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(10px);
        border-left: 2px solid rgba(255,215,0,0.3);
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .turno-indicator {
        background: rgba(76,175,80,0.2);
        border: 1px solid #4CAF50;
        color: #4CAF50;
        padding: 10px;
        border-radius: 10px;
        text-align: center;
        font-weight: bold;
    }

    .turno-indicator.inimigo {
        background: rgba(255,87,34,0.2);
        border-color: #ff5722;
        color: #ff5722;
    }

    .acoes-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }

    .acao-btn {
        background: rgba(255,215,0,0.1);
        border: 1px solid #ffd700;
        color: #ffd700;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        font-size: 0.9rem;
    }

    .acao-btn:hover:not(:disabled) {
        background: #ffd700;
        color: #0a0a1a;
    }

    .acao-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .acao-btn.atacar {
        border-color: #ff6b6b;
        color: #ff6b6b;
    }

    .acao-btn.magia {
        border-color: #4d4dff;
        color: #4d4dff;
    }

    .acao-btn.defender {
        border-color: #4CAF50;
        color: #4CAF50;
    }

    /* INIMIGOS */
    .inimigos-lista {
        background: rgba(255,0,0,0.1);
        border: 1px solid #ff6b6b;
        border-radius: 10px;
        padding: 10px;
        max-height: 200px;
        overflow-y: auto;
    }

    .inimigo-mini {
        background: rgba(0,0,0,0.3);
        border: 1px solid #ff6b6b;
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .inimigo-mini:hover {
        background: rgba(255,107,107,0.2);
    }

    .inimigo-mini.selecionado {
        border: 2px solid #ffd700;
    }

    .inimigo-mini-nome {
        color: #ff6b6b;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .inimigo-mini-pv {
        height: 4px;
        background: rgba(0,0,0,0.3);
        border-radius: 2px;
        margin: 5px 0;
    }

    .inimigo-mini-pv-fill {
        height: 100%;
        background: #ff6b6b;
        width: 100%;
    }

    /* LOG */
    .log-container {
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        padding: 8px;
        max-height: 120px;
        overflow-y: auto;
        font-size: 0.8rem;
    }

    .log-item {
        padding: 3px 0;
        border-bottom: 1px solid rgba(255,215,0,0.1);
    }

    .log-item.sucesso { color: #4CAF50; }
    .log-item.erro { color: #ff6b6b; }
    .log-item.dano { color: #ff5722; }

    /* MODAIS */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: #1a1a3a;
        border: 2px solid #ffd700;
        border-radius: 20px;
        padding: 25px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-content h3 {
        color: #ffd700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* MODAL DE ESCOLHA DE ATRIBUTO */
    .atributo-opcao {
        background: rgba(0,0,0,0.3);
        border: 2px solid #ffd700;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .atributo-opcao:hover {
        background: rgba(255,215,0,0.2);
        transform: translateX(10px);
    }

    .atributo-opcao .icone {
        width: 50px;
        height: 50px;
        background: rgba(255,215,0,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #ffd700;
    }

    .atributo-opcao .info {
        flex: 1;
    }

    .atributo-opcao .nome {
        font-size: 1.2rem;
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .atributo-opcao .descricao {
        color: rgba(255,255,255,0.7);
        font-size: 0.9rem;
    }

    .atributo-opcao .valor-atual {
        font-size: 1.1rem;
        color: #4CAF50;
        font-weight: bold;
    }

    /* MODAL DE INVENTÁRIO */
    .inventario-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 15px 0;
    }

    .inventario-coluna {
        background: rgba(0,0,0,0.3);
        border-radius: 12px;
        padding: 12px;
        max-height: 300px;
        overflow-y: auto;
    }

    .inventario-coluna h4 {
        color: #ffd700;
        margin-bottom: 10px;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 5px;
        position: sticky;
        top: 0;
        background: #1a1a3a;
        padding: 5px 0;
    }

    .item-card {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.3);
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }

    .item-card .nome {
        color: #ffd700;
        font-weight: bold;
    }

    .item-card .detalhes {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.6);
        margin-top: 3px;
    }

    .item-acoes {
        display: flex;
        gap: 5px;
        margin-top: 5px;
    }

    .item-acao {
        background: rgba(255,215,0,0.1);
        border: 1px solid #ffd700;
        color: #ffd700;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        cursor: pointer;
    }

    .item-acao:hover {
        background: #ffd700;
        color: #0a0a1a;
    }

    /* MODAL DE VANTAGENS */
    .vantagens-lista, .desvantagens-lista, .pericias-lista, .magias-lista {
        max-height: 400px;
        overflow-y: auto;
    }

    .vantagem-item, .desvantagem-item {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.2);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
    }

    .vantagem-item h4, .desvantagem-item h4 {
        color: #ffd700;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
    }

    .vantagem-item .tipo, .desvantagem-item .tipo {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
        background: rgba(255,215,0,0.2);
        padding: 2px 8px;
        border-radius: 10px;
    }

    .vantagem-item .descricao, .desvantagem-item .descricao {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
    }

    .badge-fobia {
        background: rgba(255,0,0,0.3);
        color: #ff6b6b;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        display: inline-block;
    }

    /* MODAL DE PERÍCIAS */
    .pericia-modal-item {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.2);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
    }

    .pericia-modal-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .pericia-modal-nome {
        color: #ffd700;
        font-weight: bold;
    }

    .pericia-modal-nivel {
        color: #4CAF50;
    }

    .pericia-modal-atributo {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
        margin-bottom: 5px;
    }

    .pericia-modal-bonus {
        font-size: 0.8rem;
        color: rgba(255,215,0,0.8);
    }

    .pericia-modal-nh {
        background: rgba(255,215,0,0.1);
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.9rem;
        margin-top: 5px;
        display: inline-block;
    }

    /* MODAL DE MAGIAS */
    .magia-escola-header {
        background: linear-gradient(45deg, #0a2a3a, #1a4a6a);
        border: 1px solid #4a9fff;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .simbolo-agua {
        width: 40px;
        height: 40px;
        background-image: url('agua1.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }

    .magia-escola-info h4 {
        color: #4a9fff;
        margin-bottom: 5px;
    }

    .magia-escola-info p {
        color: rgba(255,255,255,0.8);
        font-size: 0.9rem;
    }

    .magia-item {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(74,159,255,0.3);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
    }

    .magia-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .magia-nome {
        color: #4a9fff;
        font-weight: bold;
    }

    .magia-nivel {
        background: #ffd700;
        color: #0a0a1a;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
    }

    .magia-tipo {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
        margin-bottom: 5px;
    }

    .magia-efeito {
        font-size: 0.9rem;
        color: #ffd700;
        margin: 5px 0;
    }

    .magia-nh-info {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
        border-top: 1px solid rgba(255,215,0,0.2);
        padding-top: 5px;
        margin-top: 5px;
    }

    /* MODAL DE ATAQUE */
    .arma-card {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,215,0,0.3);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .arma-card:hover {
        background: rgba(255,215,0,0.1);
        border-color: #ffd700;
    }

    .arma-card.selecionada {
        background: rgba(255,215,0,0.2);
        border-color: #ffd700;
    }

    .arma-nome {
        font-weight: bold;
        color: #ffd700;
        margin-bottom: 5px;
    }

    .arma-detalhes {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.7);
        display: flex;
        gap: 15px;
    }

    /* MODAL DE DEFESA */
    .defesa-card-modal {
        background: rgba(0,0,0,0.3);
        border: 1px solid #4CAF50;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .defesa-card-modal:hover:not(.disabled) {
        background: rgba(76,175,80,0.2);
        border-color: #4CAF50;
    }

    .defesa-card-modal.disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .defesa-card-modal.selecionada {
        background: rgba(76,175,80,0.3);
        border-color: #4CAF50;
    }

    .modal-botoes {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-confirmar {
        background: #ffd700;
        color: #0a0a1a;
        border: none;
        padding: 10px 20px;
        border-radius: 30px;
        font-weight: bold;
        cursor: pointer;
        flex: 2;
    }

    .btn-cancelar {
        background: transparent;
        border: 2px solid #ff6b6b;
        color: #ff6b6b;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        flex: 1;
    }

    /* DADOS FLUTUANTES */
    .dados-flutuante {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 500;
    }

    .btn-dados {
        background: linear-gradient(45deg, #ffd700, #ffaa00);
        color: #0a0a1a;
        border: none;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.5rem;
        box-shadow: 0 5px 20px rgba(255,215,0,0.4);
        transition: all 0.3s;
    }

    .btn-dados:hover {
        transform: scale(1.1);
    }

    /* LOADING */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10,10,26,0.9);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 20px;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255,215,0,0.2);
        border-top-color: #ffd700;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* POSICIONAMENTO DOS NPCS */
    .npc-sprite[data-npcid="taverneiro"] { left: 85%; top: 60%; }
    .npc-sprite[data-npcid="homem_sangue"] { left: 25%; top: 50%; }
    .npc-sprite[data-npcid="camponesa"] { left: 40%; top: 55%; }
    .npc-sprite[data-npcid="menina_elfa"] { left: 50%; top: 60%; }
    .npc-sprite[data-npcid="chefe_goblin"] { left: 60%; top: 50%; }

    /* RESPONSIVIDADE */
    @media (max-width: 1200px) {
        .ficha-coluna { width: 260px; }
        .acoes-coluna { width: 240px; }
        .npc-sprite img {
            width: 120px;
            height: 160px;
        }
        .npc-sprite .npc-nome {
            font-size: 0.8rem;
            padding: 4px 15px;
            bottom: -30px;
        }
    }
</style>
</head>
<body>
    <div class="magic-bg"></div>

       <!-- LOADING -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando sua aventura...</div>
    </div>

    <!-- MODAL DE ESCOLHA DE ATRIBUTO (para bolinhas) -->
    <div class="modal" id="modalEscolhaAtributo">
        <div class="modal-content">
            <h3><i class="fas fa-star"></i> Você ganhou uma bolinha!</h3>
            <p style="margin-bottom: 20px; color: rgba(255,255,255,0.8);">
                Bolinhas disponíveis: <strong id="bolinhasDisponiveisModal">0</strong>
            </p>
            
            <div class="atributo-opcao" data-atributo="st">
                <div class="icone"><i class="fas fa-fist-raised"></i></div>
                <div class="info">
                    <div class="nome">ST (Força)</div>
                    <div class="descricao">Aumenta dano, carga e habilidades físicas</div>
                </div>
                <div class="valor-atual" id="valorStModal">0</div>
            </div>
            
            <div class="atributo-opcao" data-atributo="dx">
                <div class="icone"><i class="fas fa-running"></i></div>
                <div class="info">
                    <div class="nome">DX (Destreza)</div>
                    <div class="descricao">Aumenta esquiva, perícias físicas e precisão</div>
                </div>
                <div class="valor-atual" id="valorDxModal">0</div>
            </div>
            
            <div class="atributo-opcao" data-atributo="iq">
                <div class="icone"><i class="fas fa-brain"></i></div>
                <div class="info">
                    <div class="nome">IQ (Inteligência)</div>
                    <div class="descricao">Aumenta vontade, perícias mentais e magias</div>
                </div>
                <div class="valor-atual" id="valorIqModal">0</div>
            </div>
            
            <div class="atributo-opcao" data-atributo="ht">
                <div class="icone"><i class="fas fa-heart"></i></div>
                <div class="info">
                    <div class="nome">HT (Vigor)</div>
                    <div class="descricao">Aumenta PV, fadiga e resistência</div>
                </div>
                <div class="valor-atual" id="valorHtModal">0</div>
            </div>
            
            <div class="modal-botoes">
                <button class="btn-cancelar" id="cancelarEscolhaAtributo">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE INVENTÁRIO -->
    <div class="modal" id="modalInventario">
        <div class="modal-content" style="max-width: 900px;">
            <h3><i class="fas fa-backpack"></i> Inventário do Personagem</h3>
            
            <div class="inventario-grid">
                <!-- Equipado -->
                <div class="inventario-coluna">
                    <h4><i class="fas fa-shield-alt"></i> Equipado</h4>
                    <div id="inventarioEquipado"></div>
                </div>
                
                <!-- Mochila -->
                <div class="inventario-coluna">
                    <h4><i class="fas fa-shopping-bag"></i> Mochila</h4>
                    <div id="inventarioMochila"></div>
                </div>
                
                <!-- Depósito -->
                <div class="inventario-coluna">
                    <h4><i class="fas fa-warehouse"></i> Depósito</h4>
                    <div id="inventarioDeposito"></div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                <span><i class="fas fa-coins"></i> Dinheiro: <strong style="color:#ffd700;" id="modalDinheiro">0</strong></span>
                <span><i class="fas fa-weight-hanging"></i> Carga: <strong style="color:#ffd700;" id="modalCarga">0/0 kg</strong></span>
            </div>
            
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalInventario">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE VANTAGENS -->
    <div class="modal" id="modalVantagens">
        <div class="modal-content">
            <h3><i class="fas fa-star"></i> Vantagens do Personagem</h3>
            <div class="vantagens-lista" id="vantagensLista"></div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalVantagens">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE DESVANTAGENS -->
    <div class="modal" id="modalDesvantagens">
        <div class="modal-content">
            <h3><i class="fas fa-skull"></i> Desvantagens do Personagem</h3>
            <div class="desvantagens-lista" id="desvantagensLista"></div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalDesvantagens">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE PERÍCIAS -->
    <div class="modal" id="modalPericias">
        <div class="modal-content" style="max-width: 600px;">
            <h3><i class="fas fa-brain"></i> Perícias do Personagem</h3>
            <div class="pericias-lista" id="periciasLista"></div>
            <div style="margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px; text-align: center;">
                <span>PM: <strong style="color:#ffd700;" id="modalPM">0/0</strong></span>
            </div>
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalPericias">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE MAGIAS -->
    <div class="modal" id="modalMagias">
        <div class="modal-content" style="max-width: 600px;">
            <h3><i class="fas fa-magic"></i> Magias do Personagem</h3>
            
            <div class="magia-escola-header">
                <div class="simbolo-agua"></div>
                <div class="magia-escola-info">
                    <h4>Escola da Água</h4>
                    <p>Aptidão Mágica: <span id="modalAptidao">0</span></p>
                </div>
            </div>
            
            <div class="magias-lista" id="magiasLista"></div>
            
            <div class="modal-botoes">
                <button class="btn-confirmar" id="fecharModalMagias">
                    <i class="fas fa-check"></i> Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE ATAQUE -->
    <div class="modal" id="modalAtaque">
        <div class="modal-content">
            <h3><i class="fas fa-sword"></i> Escolha sua Arma</h3>
            <div id="armasLista"></div>
            <div class="modal-botoes">
                <button class="btn-cancelar" id="btnCancelarAtaque">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirmar" id="btnConfirmarAtaque" disabled>
                    <i class="fas fa-check"></i> Atacar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE DEFESA -->
    <div class="modal" id="modalDefesa">
        <div class="modal-content">
            <h3><i class="fas fa-shield-alt"></i> Escolha sua Defesa</h3>
            <p id="defesaContexto" style="margin-bottom: 15px; color: rgba(255,255,255,0.8);"></p>
            <div id="defesasLista"></div>
            <div class="modal-botoes">
                <button class="btn-cancelar" id="btnCancelarDefesa">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirmar" id="btnConfirmarDefesa" disabled>
                    <i class="fas fa-check"></i> Defender
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE DADOS -->
    <div class="modal" id="modalDados">
        <div class="modal-content">
            <h3><i class="fas fa-dice-d20"></i> Rolagem de Dados</h3>
            
            <div style="display: flex; flex-direction: column; gap: 15px; margin: 20px 0;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Quantidade:</label>
                    <input type="number" id="dadosQtd" min="1" max="10" value="1" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 8px; border-radius: 8px; width: 100px;">
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Faces:</label>
                    <select id="dadosFaces" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 8px; border-radius: 8px; width: 100px;">
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10" selected>d10</option>
                        <option value="12">d12</option>
                        <option value="20">d20</option>
                        <option value="100">d100</option>
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label>Modificador:</label>
                    <input type="number" id="dadosMod" value="0" style="background: rgba(0,0,0,0.3); border: 1px solid #ffd700; color: #ffd700; padding: 8px; border-radius: 8px; width: 100px;">
                </div>
            </div>
            
            <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 20px; text-align: center; font-size: 1.5rem; color: #ffd700; margin: 20px 0;" id="dadosResultado">
                Clique em Rolar
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn-cancelar" id="btnFecharDados" style="flex:1;">Fechar</button>
                <button class="btn-confirmar" id="btnRolarDados" style="flex:2;">Rolar</button>
            </div>
        </div>
    </div>

    <!-- Botão flutuante de dados -->
    <div class="dados-flutuante">
        <button class="btn-dados" id="btnAbrirDados">
            <i class="fas fa-dice-d20"></i>
        </button>
    </div>

    <!-- CONTAINER PRINCIPAL -->
    <div class="game-container">
        <!-- HEADER -->
        <div class="game-header">
            <div class="personagem-info">
                <div class="personagem-avatar" id="headerAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <span class="personagem-nome" id="headerNome">Carregando...</span>
                    <span style="font-size:0.8rem; color:rgba(255,255,255,0.6); margin-left:10px;" id="headerClasse"></span>
                </div>
            </div>

            <div class="status-bars">
                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-heart"></i> PV</span>
                        <span id="headerPV">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill vida" id="headerPVBarra" style="width:0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-magic"></i> Mana</span>
                        <span id="headerMana">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill mana" id="headerManaBarra" style="width:0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-tint"></i> Fadiga</span>
                        <span id="headerFadiga">0/0</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill fadiga" id="headerFadigaBarra" style="width:0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">
                        <span><i class="fas fa-star"></i> XP</span>
                        <span id="headerXP">0/100</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill xp" id="headerXPBarra" style="width:0%"></div>
                    </div>
                </div>
            </div>

            <div class="pm-display" id="pmDisplay">
                <i class="fas fa-crown"></i>
                <span>PM: <span id="pmValor">0</span></span>
            </div>
        </div>

        <!-- ÁREA PRINCIPAL - TRÊS COLUNAS -->
        <div class="main-area">
            <!-- COLUNA ESQUERDA - FICHA DO PERSONAGEM -->
            <div class="ficha-coluna">
                <div class="ficha-header">
                    <div class="ficha-avatar" id="fichaAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="ficha-nome" id="fichaNome">Carregando...</div>
                    <div class="ficha-classe" id="fichaClasse"></div>
                </div>

                <!-- INDICADOR DE NÍVEL DO PERSONAGEM -->
                <div class="nivel-indicator">
                    <div class="nivel-info">
                        <i class="fas fa-crown"></i>
                        <span>Nível do Personagem</span>
                    </div>
                    <div class="nivel-valor" id="nivelPersonagem">1</div>
                </div>

                <!-- INDICADOR DE ATO -->
                <div class="ato-indicator" id="atoIndicator">
                    <i class="fas fa-scroll"></i> <span id="atoTexto">Ato 1: A Taverna</span>
                </div>

                <!-- BOLINHAS DISPONÍVEIS -->
                <div class="bolinhas-saldo" id="bolinhasSaldoContainer" style="display: none;">
                    <span><i class="fas fa-star"></i> Bolinhas disponíveis:</span>
                    <span class="valor" id="bolinhasSaldo">0</span>
                </div>

                <!-- ATRIBUTOS -->
                <div class="atributos-container" id="atributosContainer"></div>

                <!-- DEFESAS -->
                <div class="defesas-grid" id="defesasGrid"></div>

                <!-- BOTÕES DE FICHA -->
                <div class="ficha-botoes">
                    <button class="ficha-botao" id="btnVerVantagens">
                        <i class="fas fa-star"></i>
                        <span>Vantagens</span>
                        <span class="contador" id="contadorVantagensBtn">0</span>
                    </button>
                    <button class="ficha-botao" id="btnVerDesvantagens">
                        <i class="fas fa-skull"></i>
                        <span>Desvantagens</span>
                        <span class="contador" id="contadorDesvantagensBtn">0</span>
                    </button>
                    <button class="ficha-botao" id="btnVerPericias">
                        <i class="fas fa-brain"></i>
                        <span>Perícias</span>
                        <span class="contador" id="contadorPericiasBtn">0</span>
                    </button>
                    <button class="ficha-botao" id="btnVerMagias">
                        <i class="fas fa-magic"></i>
                        <span>Magias</span>
                        <span class="contador" id="contadorMagiasBtn">0</span>
                    </button>
                </div>
            </div>

            <!-- COLUNA CENTRAL - CENÁRIO E DIÁLOGO -->
            <div class="cenario-coluna">
                <!-- CENÁRIO COM NPCs -->
                <div class="cenario-area" id="cenarioArea">
                    <div class="cenario-overlay"></div>
                    <div class="npcs-container" id="npcsContainer"></div>
                </div>

                <!-- CAIXA DE DIÁLOGO (EMBAIXO DO CENÁRIO) -->
                <div class="dialogo-area" id="dialogoArea">
                    <div class="npc-falando" id="npcFalando">
                        <img src="" alt="" id="npcAvatar" style="display: none;">
                        <span id="npcNome">Narrador</span>
                    </div>
                    <div class="dialogo-texto" id="dialogoTexto">
                        Preparando sua aventura...
                    </div>
                    <div class="opcoes-dialogo" id="opcoesDialogo"></div>
                </div>
            </div>

            <!-- COLUNA DIREITA - AÇÕES E COMBATE -->
            <div class="acoes-coluna">
                <!-- INDICADOR DE TURNO -->
                <div class="turno-indicator jogador" id="turnoIndicator">
                    <i class="fas fa-user"></i> SEU TURNO
                </div>

                <!-- AÇÕES RÁPIDAS -->
                <div class="acoes-grid">
                    <button class="acao-btn atacar" id="btnAtacar">
                        <i class="fas fa-sword"></i> Atacar
                    </button>
                    <button class="acao-btn magia" id="btnMagia">
                        <i class="fas fa-magic"></i> Magia
                    </button>
                    <button class="acao-btn" id="btnInventario">
                        <i class="fas fa-backpack"></i> Inventário
                    </button>
                    <button class="acao-btn" id="btnDescansar">
                        <i class="fas fa-bed"></i> Descansar
                    </button>
                </div>

                <!-- INIMIGOS (aparece em combate) -->
                <div id="inimigosContainer" style="display: none;">
                    <h4 style="color:#ff6b6b; margin-bottom:8px;"><i class="fas fa-skull"></i> Inimigos</h4>
                    <div class="inimigos-lista" id="inimigosLista"></div>
                </div>

                <!-- LOG DE AÇÕES -->
                <div class="log-container" id="logContainer">
                    <div class="log-item">A aventura começou...</div>
                </div>
            </div>
        </div>
    </div>

<script>
// ============================================
// sistema-combate.js - SISTEMA DE COMBATE RPGForce
// ============================================

const SistemaCombate = {
    
    calcularIniciativa: function(personagem, inimigos, emboscada = null) {
        let pcIniciativa = personagem.atributos.dx.valor || 10;
        if (personagem.vantagens && personagem.vantagens.includes('reflexoCombate')) pcIniciativa += 2;
        let somaDx = 0;
        inimigos.forEach(inimigo => somaDx += inimigo.dx || 10);
        let inimigosIniciativa = somaDx / inimigos.length;
        if (emboscada === 'pc') pcIniciativa += 3;
        else if (emboscada === 'inimigos') inimigosIniciativa += 3;
        const pcComeca = pcIniciativa >= inimigosIniciativa;
        return {
            quemComeca: pcComeca ? 'pc' : 'inimigos',
            pc: pcIniciativa,
            inimigos: inimigosIniciativa,
            texto: pcComeca ? '   Você age primeiro!' : '   Os inimigos agem primeiro!'
        };
    },
    
    rolar2d10: function() {
        const d1 = Math.floor(Math.random() * 10) + 1;
        const d2 = Math.floor(Math.random() * 10) + 1;
        const total = d1 + d2;
        return {
            total: total,
            dados: [d1, d2],
            texto: `${d1} + ${d2} = ${total}`,
            isCritico: total <= 4,
            isFalhaCritica: total >= 18
        };
    },
    
    getDanoBaseExpressao: function(st) {
        if (st <= 9) return "1d-2";
        if (st == 10) return "1d";
        if (st == 11) return "1d+1";
        if (st == 12) return "1d+2";
        if (st == 13) return "2d-1";
        if (st == 14) return "2d";
        if (st == 15) return "2d+1";
        if (st == 16) return "2d+2";
        if (st == 17) return "3d-1";
        if (st == 18) return "3d";
        if (st == 19) return "3d+1";
        if (st == 20) return "3d+2";
        if (st <= 22) return "4d";
        if (st <= 24) return "5d";
        if (st <= 26) return "6d";
        if (st <= 28) return "7d";
        if (st <= 30) return "8d";
        return "10d";
    },
    
    rolarDanoBase: function(personagem) {
        if (!personagem || !personagem.atributos) return 0;
        const st = personagem.atributos.st?.valor || 10;
        const expressao = this.getDanoBaseExpressao(st);
        return this.rolarDados(expressao);
    },
    
    rolarDados: function(expressao) {
        if (!expressao) return 0;
        if (typeof expressao === 'string') expressao = expressao.split(' ')[0];
        const expr = String(expressao).trim();
        const match = expr.match(/(\d+)d(?:(\d+))?([+-]\d+)?/);
        if (!match) return 0;
        const qtd = parseInt(match[1]) || 1;
        const faces = match[2] ? parseInt(match[2]) : 10;
        const mod = match[3] ? parseInt(match[3]) : 0;
        let total = 0;
        for (let i = 0; i < qtd; i++) total += Math.floor(Math.random() * faces) + 1;
        total += mod;
        return Math.max(0, total);
    },
    
    rolarDanoTotal: function(personagem, arma) {
        if (!personagem) return 0;
        const danoBase = this.rolarDanoBase(personagem);
        let danoArma = 0;
        if (arma && arma.dano) danoArma = this.rolarDados(arma.dano);
        let danoTotal = danoBase + danoArma;
        if (arma && (arma.tipoDano === 'Corte' || arma.tipoDano === 'Perfuração')) {
            danoTotal = Math.floor(danoTotal * 1.5);
        }
        return Math.max(1, danoTotal);
    },
    
    getNHAtaque: function(personagem, arma) {
        if (!personagem || !arma) return 10;
        let periciaId = 'espada';
        const nome = arma.nome?.toLowerCase() || '';
        if (nome.includes('machado')) periciaId = 'machado';
        else if (nome.includes('arco')) periciaId = 'arco';
        else if (nome.includes('besta')) periciaId = 'besta';
        else if (nome.includes('espada')) periciaId = 'espada';
        else if (nome.includes('maca')) periciaId = 'maca';
        else if (nome.includes('rapieira')) periciaId = 'esgrima';
        if (personagem.pericias && personagem.pericias[periciaId]) {
            return personagem.pericias[periciaId].nh || personagem.atributos.dx.valor;
        }
        return personagem.atributos.dx.valor || 10;
    },
    
    atacar: function(atacante, alvo, arma) {
        const nh = this.getNHAtaque(atacante, arma);
        const rolagem = this.rolar2d10();
        const resultado = {
            acertou: rolagem.total <= nh,
            critico: rolagem.isCritico,
            falhaCritica: rolagem.isFalhaCritica,
            rolagem: rolagem,
            nh: nh,
            arma: arma,
            dano: 0,
            texto: ''
        };
        if (rolagem.isFalhaCritica) {
            resultado.texto = `   FALHA CRÍTICA! (${rolagem.texto})`;
            resultado.perdeDefesa = true;
            return resultado;
        }
        if (rolagem.total <= nh) {
            const danoTotal = this.rolarDanoTotal(atacante, arma);
            if (rolagem.isCritico) {
                resultado.dano = danoTotal * 2;
                resultado.texto = `✨ ATAQUE CRÍTICO! (${rolagem.texto})`;
            } else {
                resultado.dano = danoTotal;
                resultado.texto = `✅ Acertou! (${rolagem.texto})`;
            }
            resultado.danoOriginal = danoTotal;
        } else {
            resultado.texto = `❌ Errou! (${rolagem.texto})`;
        }
        return resultado;
    },
    
    ataqueDuplo: function(atacante, alvo1, alvo2, arma1, arma2) {
        if (!atacante.vantagens || !atacante.vantagens.includes('ambidestria')) {
            return { erro: 'Você não possui Ambidestria!' };
        }
        const ataque1 = this.atacar(atacante, alvo1, arma1);
        const ataque2 = this.atacar(atacante, alvo2, arma2);
        return {
            tipo: 'duplo',
            ataques: [ataque1, ataque2],
            texto: `⚔️ Ataque Duplo!`
        };
    },
    
    armasLongoAlcance: {
        estado: {},
        reset: function() { this.estado = {}; },
        atacar: function(atacante, alvo, arma) {
            const armaId = arma.id || 'arco';
            if (!this.estado[armaId]) this.estado[armaId] = { carregada: true, turnosMirando: 0 };
            const estadoArma = this.estado[armaId];
            if (!estadoArma.carregada) return { podeAtacar: false, texto: '   Arma descarregada! Precisa recarregar (1 turno)' };
            const bonusMirar = estadoArma.turnosMirando > 0 ? 1 : 0;
            const nh = SistemaCombate.getNHAtaque(atacante, arma) + bonusMirar;
            const rolagem = SistemaCombate.rolar2d10();
            const acertou = rolagem.total <= nh;
            let dano = 0;
            if (acertou) dano = SistemaCombate.rolarDanoTotal(atacante, arma);
            estadoArma.carregada = false;
            estadoArma.turnosMirando = 0;
            return {
                podeAtacar: true,
                acertou: acertou,
                dano: dano,
                bonusMirar: bonusMirar,
                nh: nh,
                rolagem: rolagem,
                texto: acertou ? `   Acertou! (bônus de mirar: +${bonusMirar})` : `   Errou...`
            };
        },
        recarregar: function(armaId) {
            if (!this.estado[armaId]) this.estado[armaId] = { carregada: true, turnosMirando: 0 };
            this.estado[armaId].carregada = true;
            this.estado[armaId].turnosMirando = 0;
            return { texto: '   Arma recarregada!' };
        },
        mirar: function(armaId) {
            if (!this.estado[armaId]) this.estado[armaId] = { carregada: true, turnosMirando: 0 };
            if (!this.estado[armaId].carregada) return { texto: '   Arma descarregada! Recarregue primeiro.' };
            this.estado[armaId].turnosMirando++;
            return { texto: `   Mirando... (+${this.estado[armaId].turnosMirando} no próximo ataque)` };
        },
        passarTurno: function() {}
    },
    
    defender: function(defensor, tipoDefesa, ataque, estadoDefesa = {}) {
        if (estadoDefesa.perdeuDefesa) {
            return {
                sucesso: false,
                motivo: 'Você perdeu a defesa neste turno (falha crítica)!',
                danoFinal: ataque.dano || 0,
                texto: '   Sem defesa!'
            };
        }
        const esquiva = defensor.derivados?.esquiva || 8;
        const aparar = defensor.derivados?.aparar || 0;
        const bloqueio = defensor.derivados?.bloqueio || 0;
        const defesasDisponiveis = {
            esquiva: { nh: esquiva, disponivel: true, usado: false },
            aparar: { nh: aparar, disponivel: aparar > 0, usado: false },
            bloqueio: { nh: bloqueio, disponivel: bloqueio > 0, usado: false }
        };
        if (!defesasDisponiveis[tipoDefesa] || !defesasDisponiveis[tipoDefesa].disponivel) {
            return {
                sucesso: false,
                motivo: `Não pode usar ${tipoDefesa}`,
                danoFinal: ataque.dano || 0
            };
        }
        if (tipoDefesa === 'aparar' && estadoDefesa.usouAparar) {
            return {
                sucesso: false,
                motivo: 'Aparar já foi usado neste turno!',
                danoFinal: ataque.dano || 0
            };
        }
        const nh = defesasDisponiveis[tipoDefesa].nh;
        const rolagem = this.rolar2d10();
        const sucesso = rolagem.total <= nh;
        let danoFinal = ataque.dano || 0;
        let texto = '';
        if (sucesso) {
            danoFinal = 0;
            texto = `✅ ${tipoDefesa} bem sucedida! (${rolagem.texto})`;
        } else {
            const rd = defensor.derivados?.rd?.corpo || 0;
            danoFinal = Math.max(0, danoFinal - rd);
            texto = `❌ Falhou na ${tipoDefesa}! (${rolagem.texto}) RD reduziu para ${danoFinal}`;
        }
        if (tipoDefesa === 'aparar' && sucesso) estadoDefesa.usouAparar = true;
        return {
            sucesso: sucesso,
            tipo: tipoDefesa,
            rolagem: rolagem,
            nh: nh,
            danoFinal: danoFinal,
            texto: texto,
            novoEstado: estadoDefesa
        };
    },
    
    magias: {
        catalogo: {
            adagaDeGelo: {
                nome: 'Adaga de Gelo',
                tipo: 'Ataque',
                icone: 'fa-knife',
                custoPM: 2,
                tempoConjuracao: 1,
                efeito: function(nivel) {
                    const danos = {
                        1: '1d-3', 2: '1d-2', 3: '1d-1', 4: '1d', 5: '1d+1',
                        6: '1d+2', 7: '2d-2', 8: '2d-1', 9: '2d', 10: '2d+1',
                        11: '2d+2', 12: '3d-2', 13: '3d-1', 14: '3d', 15: '3d+1'
                    };
                    return danos[nivel] || '1d';
                }
            }
        },
        estado: {},
        concentrar: function(magiaId, personagem) {
            const magia = this.catalogo[magiaId];
            if (!magia) return { erro: 'Magia não encontrada' };
            if ((personagem.pmDisponivel - personagem.pmGasto) < magia.custoPM) return { erro: 'PM insuficiente' };
            this.estado[magiaId] = { magiaId: magiaId, turnosConcentrando: 0, turnosNecessarios: magia.tempoConjuracao };
            return { sucesso: true, texto: `   Concentrando para ${magia.nome}... (${magia.tempoConjuracao} turnos)` };
        },
        lancar: function(magiaId, personagem, alvo) {
            const magia = this.catalogo[magiaId];
            const estado = this.estado[magiaId];
            if (!estado || estado.turnosConcentrando < estado.turnosNecessarios) return { erro: 'Magia não está pronta!' };
            personagem.pmGasto += magia.custoPM;
            const iq = personagem.atributos.iq.valor;
            const temAptidao = personagem.vantagens?.includes('aptidaoMagica');
            const nh = iq + (temAptidao ? 1 : 0);
            const rolagem = SistemaCombate.rolar2d10();
            const sucesso = rolagem.total <= nh;
            let resultado = { magia: magia.nome, nh: nh, rolagem: rolagem, sucesso: sucesso };
            if (sucesso) {
                const nivel = personagem.escolas?.agua?.magias[magiaId]?.nivel || 1;
                const expressaoDano = magia.efeito(nivel);
                let dano = SistemaCombate.rolarDados(expressaoDano);
                if (rolagem.isCritico) dano *= 2;
                resultado.dano = dano;
                resultado.texto = `✨ ${magia.nome} causou ${dano} de dano!`;
            } else {
                resultado.texto = `❌ Falhou ao lançar ${magia.nome}!`;
            }
            delete this.estado[magiaId];
            return resultado;
        },
        passarTurno: function() {
            Object.keys(this.estado).forEach(magiaId => this.estado[magiaId].turnosConcentrando++);
        }
    },
    
    fadiga: {
        contadorTurnos: 0,
        iniciarCombate: function() { this.contadorTurnos = 0; },
        passarTurno: function(personagem) {
            this.contadorTurnos++;
            if (this.contadorTurnos % 5 === 0 && personagem.statusCombate) {
                personagem.statusCombate.fadigaAtual = (personagem.statusCombate.fadigaAtual || 10) - 1;
                if (personagem.statusCombate.fadigaAtual <= 0) {
                    return {
                        perdeuFadiga: true,
                        fadigaAtual: 0,
                        penalidade: true,
                        texto: '  ‍   FADIGA ZERO! Todas as habilidades reduzidas pela metade!'
                    };
                }
                return {
                    perdeuFadiga: true,
                    fadigaAtual: personagem.statusCombate.fadigaAtual,
                    texto: `  ‍   Perdeu 1 PF (restante: ${personagem.statusCombate.fadigaAtual})`
                };
            }
            return { perdeuFadiga: false };
        },
        reset: function() { this.contadorTurnos = 0; }
    },
    
    turno: {
        atual: 'pc',
        numero: 1,
        estadoDefesa: { perdeuDefesa: false, usouAparar: false },
        iniciarCombate: function(quemComeca) {
            this.atual = quemComeca;
            this.numero = 1;
            this.estadoDefesa = { perdeuDefesa: false, usouAparar: false };
            SistemaCombate.fadiga.iniciarCombate();
            SistemaCombate.armasLongoAlcance.reset();
        },
        passarTurno: function(personagem) {
            const fadigaResult = SistemaCombate.fadiga.passarTurno(personagem);
            SistemaCombate.magias.passarTurno();
            SistemaCombate.armasLongoAlcance.passarTurno();
            this.estadoDefesa.usouAparar = false;
            if (this.estadoDefesa.perdeuDefesa) this.estadoDefesa.perdeuDefesa = false;
            this.atual = this.atual === 'pc' ? 'inimigos' : 'pc';
            this.numero++;
            return { turno: this.atual, numero: this.numero, fadiga: fadigaResult };
        },
        perderDefesa: function() { this.estadoDefesa.perdeuDefesa = true; }
    }
};

window.SistemaCombate = SistemaCombate;
</script>

<script>
// ============================================
// SISTEMA SOCIAL - TESTES DE REAÇÃO E INTERAÇÃO
// ============================================

const SistemaSocial = {
    
    calcularBonusAparencia: function(personagem) {
        let bonus = 0;
        if (personagem.vantagens && personagem.vantagens.includes('atraente')) bonus += 2;
        if (personagem.desvantagens && personagem.desvantagens.includes('feio')) bonus -= 2;
        return bonus;
    },
    
    calcularBonusCarisma: function(personagem) {
        return (personagem.vantagens && personagem.vantagens.includes('carisma')) ? 1 : 0;
    },
    
    testarReacao: function(npc, jogador) {
        const baseReacao = npc.reacaoBase || 10;
        const bonusAparencia = this.calcularBonusAparencia(jogador);
        const bonusCarisma = this.calcularBonusCarisma(jogador);
        const bonusTotal = bonusAparencia + bonusCarisma;
        
        const d1 = Math.floor(Math.random() * 10) + 1;
        const d2 = Math.floor(Math.random() * 10) + 1;
        const rolagem = d1 + d2;
        
        const reacaoFinal = baseReacao + bonusTotal + (rolagem - 11);
        
        let classificacao = '';
        if (reacaoFinal <= 7) classificacao = 'ruim';
        else if (reacaoFinal <= 14) classificacao = 'normal';
        else classificacao = 'otima';
        
        return {
            valor: reacaoFinal,
            rolagem: rolagem,
            dados: [d1, d2],
            bonusAparencia: bonusAparencia,
            bonusCarisma: bonusCarisma,
            bonusTotal: bonusTotal,
            classificacao: classificacao,
            descricao: this.getDescricaoReacao(classificacao, npc.genero || 'feminino')
        };
    },
    
    getDescricaoReacao: function(classificacao, genero) {
        const pronome = genero === 'feminino' ? 'ela' : 'ele';
        const descricoes = {
            ruim: `${pronome} te olha com desconfiança, mantendo distância. Seu corpo está tenso, pronto para correr.`,
            normal: `${pronome} parece neutra, te observando com curiosidade mas sem se aproximar muito.`,
            otima: `${pronome} sorri abertamente, seus olhos brilhando com simpatia. Parece à vontade com sua presença.`
        };
        return descricoes[classificacao];
    },
    
    calcularNHPericia: function(periciaId, personagem) {
        if (!personagem || !personagem.pericias || !personagem.pericias[periciaId]) return 0;
        return personagem.pericias[periciaId].nh || 0;
    },
    
    testeSocial: function(nhJogador, dificuldadeNpc, modificadores = 0) {
        const d1 = Math.floor(Math.random() * 10) + 1;
        const d2 = Math.floor(Math.random() * 10) + 1;
        const rolagem = d1 + d2;
        const total = rolagem + modificadores;
        const sucesso = total <= nhJogador;
        const margem = nhJogador - total;
        
        return {
            sucesso: sucesso,
            rolagem: rolagem,
            dados: [d1, d2],
            total: total,
            nh: nhJogador,
            margem: margem,
            critico: margem >= 5,
            falhaCritica: total >= nhJogador + 5
        };
    },
    
    formatarResultadoTeste: function(resultado, tipoTeste) {
        if (resultado.sucesso) {
            if (resultado.critico) return `✨ Sucesso CRÍTICO em ${tipoTeste}!`;
            return `✅ Sucesso em ${tipoTeste}!`;
        } else {
            if (resultado.falhaCritica) return `   Falha CRÍTICA em ${tipoTeste}!`;
            return `❌ Falha em ${tipoTeste}!`;
        }
    }
};

window.SistemaSocial = SistemaSocial;
</script>
<script>
window.AVENTURA = {
    nome: "A Menina Elfa Raptada",
    descricao: "Uma aventura clássica começando em uma taverna.",
    cenaInicial: "exterior_taverna",
    
    cenas: {
        exterior_taverna: {
            id: "exterior_taverna",
            nome: "Entrada da Taverna",
            imagem: "taverna-exterior.jpg",
            fala: {
                npc: "Narrador",
                texto: "Você chega a uma taverna aconchegante. O letreiro range com o vento: 'A Javali Sangrento'. Risadas e música saem pelas frestas da porta."
            },
            npcs: [],
            opcoes: [
                {
                    texto: "Entrar na taverna",
                    proximo: "interior_taverna"
                }
            ]
        },
        
        interior_taverna: {
            id: "interior_taverna",
            nome: "Taverna A Javali Sangrento",
            imagem: "taverna-interior.jpg",
            fala: {
                npc: "Narrador",
                texto: "O calor da lareira e o cheiro de carne assada te recebem. A taverna está movimentada. Você encontra um lugar no balcão e o taverneiro se aproxima."
            },
            npcs: [
                {
                    id: "taverneiro",
                    nome: "Taverneiro",
                    sprite: "taverneiro.png",
                    dialogo: "Bem-vindo, viajante! Quer uma cerveja gelada? Só 2 moedas.",
                    opcoes: [
                        {
                            texto: "   Comprar cerveja (2 moedas)",
                            tipo: "pagar",
                            valor: 2,
                            sucesso: "Saúde! Uma boa cerveja sempre anima.",
                            falha: "Você não tem dinheiro? Que pena..."
                        },
                        {
                            texto: "   Perguntar sobre novidades",
                            resposta: "Ora, tem havido problemas na estrada norte. Dizem que goblins estão atacando viajantes. Uns mercadores ontem mesmo falaram que ouviram gritos vindo da floresta..."
                        },
                        {
                            texto: "   Procurar trabalho",
                            resposta: "Sempre tem trabalho pra quem tem coragem. Fique por aqui, tome uma cerveja, e quem sabe aparece algo."
                        },
                        {
                            texto: "  ️ Conversar sobre a região",
                            resposta: "A região é pacata, mas ultimamente... tem coisas estranhas acontecendo na floresta."
                        },
                        {
                            texto: "   Observar o ambiente enquanto bebe",
                            resposta: "Você pede uma cerveja e observa calmamente o movimento da taverna...",
                            acao: "iniciar_timer"
                        },
                        {
                            texto: "   Sair da taverna",
                            proximo: "exterior_taverna"
                        }
                    ]
                }
            ],
            opcoes: []
        },
        
        interior_taverna_com_homem: {
            id: "interior_taverna_com_homem",
            nome: "Taverna - O Ferido Chega",
            imagem: "taverna-interior.jpg",
            fala: {
                npc: "Narrador",
                texto: "Enquanto você bebe sua cerveja e observa o ambiente, a porta se abre violentamente! Um homem ensanguentado entra cambaleando e cai perto da entrada."
            },
            npcs: [
                {
                    id: "taverneiro",
                    nome: "Taverneiro",
                    sprite: "taverneiro.png",
                    dialogo: "Pelos deuses! O que aconteceu com ele? Alguém ajude!",
                    opcoes: [
                        {
                            texto: "Falar com o taverneiro",
                            resposta: "Vá falar com ele, rápido! Ele precisa de ajuda!"
                        },
                        {
                            texto: "Sair da taverna",
                            proximo: "exterior_taverna"
                        }
                    ]
                },
                {
                    id: "homem_sangue",
                    nome: "Homem Ferido",
                    sprite: "npc-sangue.png",
                    dialogo: "Socorro... minha filha... os goblins... levaram minha filha! Por favor, alguém...",
                    opcoes: [
                        {
                            texto: "Falar com o homem ferido",
                            resposta: "Ele está fraco... você se aproxima para ouvir sua história.",
                            proximo: "homem_fala_detalhes"
                        },
                        {
                            texto: "Pedir para o taverneiro ajudar",
                            resposta: "O taverneiro corre para ajudar, mas o homem precisa de um aventureiro."
                        }
                    ]
                }
            ],
            opcoes: [
                {
                    texto: "Sair da taverna",
                    proximo: "exterior_taverna"
                }
            ]
        },
        
        homem_fala_detalhes: {
            id: "homem_fala_detalhes",
            nome: "O Desespero de um Pai",
            imagem: "taverna-interior.jpg",
            fala: {
                npc: "Homem Ferido",
                texto: "Eu vinha pela estrada norte com minha filha Lyra... Ela tem 10 anos, cabelos prateados... Fomos atacados por goblins! Eles levaram ela para a floresta! Por favor, alguém tem que salvá-la!"
            },
            npcs: [
                {
                    id: "taverneiro",
                    nome: "Taverneiro",
                    sprite: "taverneiro.jpg",
                    dialogo: "Coitado. Eu avisei que a estrada estava perigosa. Alguém precisa ajudar esse homem.",
                    opcoes: [
                        {
                            texto: "Perguntar ao taverneiro sobre os goblins",
                            resposta: "Eles têm um acampamento na floresta, perto de uma caverna. Vários viajantes desapareceram por lá."
                        },
                        {
                            texto: "Sair da taverna",
                            proximo: "exterior_taverna"
                        }
                    ]
                },
                {
                    id: "homem_sangue",
                    nome: "Eldrin (Pai de Lyra)",
                    sprite: "npc-sangue.jpg",
                    dialogo: "Minha esposa morreu no inverno... Lyra é tudo que tenho! Por favor, aventureiro, você tem cara de ser corajoso...",
                    opcoes: [
                        {
                            texto: "✅ ACEITAR MISSÃO - Salvar Lyra",
                            resposta: "Deus te abençoe! Siga a estrada norte até a floresta!",
                            proximo: "sair_para_aventura"
                        },
                        {
                            texto: "Perguntar sobre os goblins",
                            resposta: "Eram uns 10... verdes, fedidos... Levaram ela para o norte, para a floresta escura."
                        },
                        {
                            texto: "Sair da taverna",
                            proximo: "exterior_taverna"
                        }
                    ]
                }
            ],
            opcoes: [
                {
                    texto: "Sair da taverna",
                    proximo: "exterior_taverna"
                }
            ]
        },
        
        sair_para_aventura: {
            id: "sair_para_aventura",
            nome: "Missão Aceita",
            imagem: "taverna-exterior.jpg",
            fala: {
                npc: "Narrador",
                texto: "Você sai da taverna com determinação. A estrada norte se estende diante de você. O vento traz o cheiro da floresta distante."
            },
            npcs: [],
            opcoes: [
                {
                    texto: "Seguir para a estrada norte",
                    proximo: "encontro_camponesa"
                }
            ]
        },
        
  encontro_camponesa: {
    id: "encontro_camponesa",
    nome: "Estrada Norte - Encontro com a Camponesa",
    imagem: "estrada-norte.jpg",
    
    // NPC aparece no cenário (apenas visual)
    npcs: [
        {
            id: "camponesa",
            nome: "Elara",
            sprite: "camponesa.png",
            x: 50,
            y: 60,
            visivel: true
        }
    ],
    
    // Fala inicial do narrador
    fala: {
        npc: "Narrador",
        texto: "Uma jovem camponesa colhe flores à beira da estrada. Seu cesto está cheio de lírios silvestres. Ela ainda não notou sua presença."
    },
    
    // Dados da NPC para o sistema social
    npcData: {
        nome: "Elara",
        genero: "feminino",
        iq: 12,
        reacaoBase: 10,
        personalidade: "curiosa mas cautelosa"
    },
    
    // Diálogos baseados na reação
    dialogo: {
        ruim: {
            texto: "Ela dá um passo para trás, segurando o cesto contra o peito. 'F-fique aí! Não se aproxime! Estranhos por aqui... nunca trazem nada de bom.' Sua mão treme enquanto ela procura uma rota de fuga.",
            tom: "amedrontado"
        },
        normal: {
            texto: "Ela te olha com curiosidade, mantendo uma distância segura. 'Olá, viajante. Raramente vejo alguém por essas bandas... Está perdido? Ou procurando algo específico?'",
            tom: "curioso"
        },
        otima: {
            texto: "Ela sorri abertamente, seus olhos castanhos brilhando. 'Olá! Que bom ver um rosto novo por aqui! Me chamo Elara. Precisa de ajuda? Conheço bem essa região, posso te dar algumas dicas...'",
            tom: "acolhedor"
        }
    },
    
    // Informações que ela pode dar
    informacoes: {
        normal: [
            "Ultimamente tenho ouvido uivos estranhos vindo da floresta à noite. Meu pai disse para eu não me afastar muito de casa.",
            "Alguns mercadores mencionaram goblins nas colinas do norte. Fique atento."
        ],
        boa: [
            "Os goblins têm um acampamento perto da Caverna dos Esquecidos. Eles estão mais ousados ultimamente.",
            "Ouvi dizer que há uma recompensa por informações sobre desaparecimentos na estrada."
        ],
        otima: [
            "Meu tio, que é caçador, viu rastros de uma menina sendo levada para a caverna. Cabelos prateados, ele disse. E também...",
            "Há rumores de um antigo tesouro élfico escondido nas cavernas. Mas ninguém nunca voltou de lá para confirmar."
        ]
    },
    
    // Informação especial que pode ser revelada (apenas em reação ótima)
    informacaoSecreta: {
        revelada: false,
        texto: "Ela hesita por um momento, como se decidindo algo. 'Espere... tenho algo que pode ajudar. Meu avô era caçador e me deu isto antes de partir. Dizem que protege quem o carrega.' Ela tira do bolso um pequeno amuleto de madeira com runas desgastadas. 'Tome. Que os espíritos da floresta te guiem.'",
        item: {
            id: "amuleto_elara",
            nome: "Amuleto de Elara",
            descricao: "Um pequeno amuleto de madeira com runas desgastadas. Dizem que protege quem o carrega.",
            peso: 0.1
        }
    },
    
    // Estado da interação
    estado: {
        reacao: null,
        flerteTentado: false,
        infoRevelada: false,
        interacaoIniciada: false,
        aguardandoAvanco: false
    },
    
    // ===== FUNÇÃO PRINCIPAL RENDERIZAR =====
    renderizar: function() {
        const cenaAtual = this;
        
        // ===== CRIAR NPC MANUALMENTE =====
        if (npcsContainer) {
            npcsContainer.innerHTML = '';
            
            // Criar a camponesa
            const npcDiv = document.createElement('div');
            npcDiv.className = 'npc-sprite';
            npcDiv.style.left = '50%';
            npcDiv.style.top = '60%';
            npcDiv.dataset.npcId = 'camponesa';
            
            npcDiv.innerHTML = `
                <img src="camponesa.png" alt="Elara">
                <div class="npc-nome">Elara</div>
            `;
            
            // Apenas visual, sem evento de clique
            npcsContainer.appendChild(npcDiv);
        }
        
        // Se a interação já foi iniciada, não mostra os botões iniciais novamente
        if (this.estado.interacaoIniciada) {
            return;
        }
        
        // Mostrar fala do narrador
        if (dialogoTexto) {
            dialogoTexto.textContent = this.fala.texto;
        }
        if (npcNome) {
            npcNome.textContent = this.fala.npc;
        }
        
        // Criar botões iniciais
        if (opcoesDialogo) {
            opcoesDialogo.innerHTML = '';
            
            const btnAproximar = document.createElement('button');
            btnAproximar.className = 'opcao-btn';
            btnAproximar.textContent = "   Aproximar-se da camponesa";
            btnAproximar.addEventListener('click', () => {
                cenaAtual.iniciarInteracao();
            });
            opcoesDialogo.appendChild(btnAproximar);
            
            const btnIgnorar = document.createElement('button');
            btnIgnorar.className = 'opcao-btn';
            btnIgnorar.textContent = "➡️ Seguir caminho sem interagir";
            btnIgnorar.addEventListener('click', () => {
                dialogoTexto.textContent = "Você decide não perturbar a camponesa e continua sua jornada.";
                setTimeout(() => carregarCena('carroca_destruida'), 2000);
            });
            opcoesDialogo.appendChild(btnIgnorar);
        }
    },
    
    // ===== INICIAR INTERAÇÃO =====
    iniciarInteracao: function() {
        const cenaAtual = this;
        
        // Marcar que a interação foi iniciada
        this.estado.interacaoIniciada = true;
        
        // Mudar nome para Elara
        if (npcNome) {
            npcNome.textContent = this.npcData.nome;
        }
        
        // Mostrar "processando"
        if (dialogoTexto) {
            dialogoTexto.textContent = "Você se aproxima... Ela levanta os olhos e nota sua presença.";
        }
        
        // Remover botões
        if (opcoesDialogo) {
            opcoesDialogo.innerHTML = '';
            
            const btnProcessando = document.createElement('button');
            btnProcessando.className = 'opcao-btn';
            btnProcessando.textContent = "⏳ Aguardando reação...";
            btnProcessando.disabled = true;
            opcoesDialogo.appendChild(btnProcessando);
        }
        
        // Processar reação após 2 segundos
        setTimeout(() => {
            // Testar reação
            if (!cenaAtual.estado.reacao) {
                cenaAtual.estado.reacao = cenaAtual.aoEntrar();
            }
            
            const reacaoClass = cenaAtual.estado.reacao.classificacao;
            const dialogoAtual = cenaAtual.dialogo[reacaoClass];
            
            // Mostrar reação
            if (dialogoTexto) {
                dialogoTexto.textContent = dialogoAtual.texto;
            }
            
            // Criar opções baseadas na reação
            const opcoes = cenaAtual.criarOpcoes(reacaoClass);
            cenaAtual.renderizarOpcoes(opcoes, cenaAtual);
            
        }, 2000);
    },
    
    // ===== FUNÇÃO ESPECIAL QUE SERÁ CHAMADA AO ENTRAR NA CENA =====
    aoEntrar: function() {
        const reacao = SistemaSocial.testarReacao(this.npcData, window.personagem);
        adicionarLog(`   REAÇÃO DA CAMPONESA: ${reacao.classificacao.toUpperCase()} (${reacao.valor})`, 'info');
        adicionarLog(`   Rolagem: ${reacao.rolagem} | Bônus: +${reacao.bonusAparencia + reacao.bonusCarisma}`, 'info');
        return reacao;
    },
    
    // ===== CRIAR OPÇÕES BASEADAS NA REAÇÃO =====
    criarOpcoes: function(reacaoClass) {
        const opcoesBase = [];
        
        // Verificar se tem Persuasão
        const temPersuasao = window.personagem?.pericias?.persuasao?.nivel > 0;
        const nhPersuasao = temPersuasao ? 
            SistemaSocial.calcularNHPericia('persuasao', window.personagem) : 0;
        
        if (reacaoClass === 'ruim') {
            if (temPersuasao) {
                opcoesBase.push(
                    {
                        texto: `   Tentar acalmá-la (Persuasão NH ${nhPersuasao})`,
                        acao: "testeSocial",
                        tipo: "acalmar",
                        dificuldade: 12,
                        nh: nhPersuasao
                    }
                );
            }
            
            opcoesBase.push(
                {
                    texto: "   Se afastar lentamente",
                    acao: "sair",
                    mensagem: "Você levanta as mãos em gesto de paz e se afasta devagar. Ela suspira aliviada e desaparece na floresta."
                },
                {
                    texto: "➡️ Ignorar e seguir caminho",
                    acao: "sair",
                    mensagem: "Ela foge correndo antes mesmo que você possa dizer algo. Que estranho..."
                }
            );
        }
        
        if (reacaoClass === 'normal') {
            opcoesBase.push(
                {
                    texto: "  ️ Perguntar sobre a região",
                    acao: "info",
                    tipo: "normal"
                },
                {
                    texto: "   Perguntar sobre goblins",
                    acao: "info",
                    tipo: "goblins"
                },
                {
                    texto: "   Perguntar se viu algo estranho",
                    acao: "info",
                    tipo: "estranho"
                }
            );
            
            if (temPersuasao) {
                opcoesBase.push(
                    {
                        texto: `   Elogiar suas flores (Persuasão NH ${nhPersuasao})`,
                        acao: "flerte",
                        nh: nhPersuasao
                    }
                );
            }
            
            opcoesBase.push(
                {
                    texto: "➡️ Se despedir e seguir viagem",
                    acao: "prepararSaida"
                }
            );
        }
        
        if (reacaoClass === 'otima') {
            opcoesBase.push(
                {
                    texto: "   Perguntar sobre a menina raptada",
                    acao: "info",
                    tipo: "menina"
                },
                {
                    texto: "   Perguntar sobre tesouros na região",
                    acao: "info",
                    tipo: "tesouro"
                },
                {
                    texto: "   Perguntar sobre os goblins (detalhado)",
                    acao: "info",
                    tipo: "goblins_avancado"
                }
            );
            
            if (temPersuasao) {
                opcoesBase.push(
                    {
                        texto: `   Elogiar seus olhos (Persuasão NH ${nhPersuasao})`,
                        acao: "flerte",
                        nh: nhPersuasao
                    },
                    {
                        texto: `   Oferecer companhia até sua cabana (Persuasão NH ${nhPersuasao})`,
                        acao: "flerte_avancado",
                        nh: nhPersuasao
                    }
                );
            }
            
            opcoesBase.push(
                {
                    texto: "➡️ Seguir viagem (prometendo voltar)",
                    acao: "prepararSaida"
                }
            );
        }
        
        return opcoesBase;
    },
    
    // ===== RENDERIZAR OPÇÕES =====
    renderizarOpcoes: function(opcoes, cenaAtual) {
        if (!opcoesDialogo) return;
        opcoesDialogo.innerHTML = '';
        
        opcoes.forEach(opcao => {
            const btn = document.createElement('button');
            btn.className = 'opcao-btn';
            btn.textContent = opcao.texto;
            
            btn.addEventListener('click', () => {
                cenaAtual.processarAcao(opcao);
            });
            
            opcoesDialogo.appendChild(btn);
        });
    },
    
    // ===== PROCESSAR AÇÃO =====
    processarAcao: function(opcao) {
        switch(opcao.acao) {
            case 'testeSocial':
                this.realizarTesteSocial(opcao);
                break;
                
            case 'info':
                this.fornecerInfo(opcao.tipo);
                break;
                
            case 'flerte':
                this.iniciarFlerte(opcao);
                break;
                
            case 'flerte_avancado':
                this.flerteAvancado(opcao);
                break;
                
            case 'prepararSaida':
                this.prepararSaida();
                break;
                
            case 'sair':
                if (opcao.mensagem) {
                    dialogoTexto.textContent = opcao.mensagem;
                }
                this.mostrarBotaoAvancar();
                break;
        }
    },
    
    // ===== PREPARAR SAÍDA (MOSTRA BOTÃO AVANÇAR) =====
    prepararSaida: function() {
        const cenaAtual = this;
        
        if (dialogoTexto) {
            if (this.estado.reacao.classificacao === 'otima') {
                dialogoTexto.textContent = "'Foi bom conversar com você. Volte quando puder, e cuidado com os goblins!' Elara acena e retorna a colher suas flores.";
            } else if (this.estado.reacao.classificacao === 'normal') {
                dialogoTexto.textContent = "'Cuide-se na estrada.' Ela sorri brevemente e volta sua atenção para as flores.";
            } else {
                dialogoTexto.textContent = "Você decide que é hora de seguir seu caminho.";
            }
        }
        
        // Esconder opções anteriores e mostrar apenas botão avançar
        if (opcoesDialogo) {
            opcoesDialogo.innerHTML = '';
            
            const btnAvancar = document.createElement('button');
            btnAvancar.className = 'opcao-btn opcao-destaque';
            btnAvancar.innerHTML = '➡️ Continuar jornada →';
            btnAvancar.style.backgroundColor = '#4a6da8';
            btnAvancar.style.fontWeight = 'bold';
            btnAvancar.style.padding = '12px';
            btnAvancar.style.marginTop = '10px';
            
            btnAvancar.addEventListener('click', () => {
                dialogoTexto.textContent = "Você segue pela estrada. Após alguns minutos de caminhada, avista algo à frente...";
                setTimeout(() => carregarCena('carroca_destruida'), 2000);
            });
            
            opcoesDialogo.appendChild(btnAvancar);
        }
    },
    
    // ===== MOSTRAR BOTÃO AVANÇAR (VERSÃO SIMPLIFICADA) =====
    mostrarBotaoAvancar: function() {
        if (opcoesDialogo) {
            opcoesDialogo.innerHTML = '';
            
            const btnAvancar = document.createElement('button');
            btnAvancar.className = 'opcao-btn opcao-destaque';
            btnAvancar.innerHTML = '➡️ Avançar →';
            btnAvancar.style.backgroundColor = '#4a6da8';
            btnAvancar.style.fontWeight = 'bold';
            btnAvancar.style.padding = '12px';
            
            btnAvancar.addEventListener('click', () => {
                dialogoTexto.textContent = "Continuando sua jornada, você logo encontra algo inesperado...";
                setTimeout(() => carregarCena('carroca_destruida'), 1500);
            });
            
            opcoesDialogo.appendChild(btnAvancar);
        }
    },
    
    // ===== TESTE SOCIAL =====
    realizarTesteSocial: function(opcao) {
        const nhJogador = opcao.nh;
        const dificuldade = opcao.dificuldade;
        
        const resultado = SistemaSocial.testeSocial(nhJogador, dificuldade);
        
        adicionarLog(`   TESTE DE PERSUASÃO:`, 'info');
        adicionarLog(`   NH: ${nhJogador} vs Dificuldade ${dificuldade}`, 'info');
        adicionarLog(`   Rolagem: ${resultado.rolagem}`, 'info');
        adicionarLog(`   Margem: ${resultado.margem}`, 'info');
        
        if (resultado.sucesso) {
            if (resultado.critico) {
                adicionarLog(`✨ SUCESSO CRÍTICO!`, 'sucesso');
                dialogoTexto.textContent = "Suas palavras são tão convincentes que ela relaxa completamente. 'Desculpe meu medo... você parece ser uma boa pessoa. Como posso ajudar?'";
                this.estado.reacao.classificacao = 'otima';
            } else {
                adicionarLog(`✅ SUCESSO!`, 'sucesso');
                dialogoTexto.textContent = "Ela parece se acalmar um pouco. 'Tudo bem... acho que me assustei à toa. Viajantes normalmente são pacíficos.'";
                this.estado.reacao.classificacao = 'normal';
            }
            
            // Renderizar novamente com a nova reação
            setTimeout(() => {
                const opcoes = this.criarOpcoes(this.estado.reacao.classificacao);
                this.renderizarOpcoes(opcoes, this);
            }, 2000);
            
        } else {
            if (resultado.falhaCritica) {
                adicionarLog(`   FALHA CRÍTICA!`, 'erro');
                dialogoTexto.textContent = "Suas palavras saem completamente erradas! Ela grita e sai correndo floresta adentro, deixando o cesto para trás.";
                
                setTimeout(() => {
                    this.mostrarBotaoAvancar();
                }, 2000);
            } else {
                adicionarLog(`❌ FALHA!`, 'erro');
                dialogoTexto.textContent = "Ela não parece confiar em você. 'Achei melhor ir embora...' Ela se afasta rapidamente.";
                
                setTimeout(() => {
                    this.mostrarBotaoAvancar();
                }, 2000);
            }
        }
    },
    
    // ===== FORNECER INFORMAÇÃO =====
    fornecerInfo: function(tipo) {
        const reacaoClass = this.estado.reacao.classificacao;
        let info = "";
        
        if (reacaoClass === 'normal') {
            if (tipo === 'normal') {
                info = this.informacoes.normal[0];
            } else if (tipo === 'goblins') {
                info = this.informacoes.normal[1];
            } else if (tipo === 'estranho') {
                info = "Só esses barulhos na floresta mesmo... e uns mercadores que passaram apressados ontem.";
            }
            adicionarLog(`ℹ️ Informação obtida`, 'info');
        }
        
        if (reacaoClass === 'otima') {
            if (tipo === 'menina') {
                info = this.informacoes.otima[0];
                adicionarLog(`   Informação sobre a menina!`, 'sucesso');
                
                // Revelar informação secreta (amuleto) se ainda não foi revelada
                if (!this.informacaoSecreta.revelada) {
                    this.informacaoSecreta.revelada = true;
                    
                    // Adicionar um delay para mostrar a informação extra
                    setTimeout(() => {
                        if (dialogoTexto) {
                            dialogoTexto.textContent = this.informacaoSecreta.texto;
                        }
                        
                        // Dar o item ao jogador
                        if (!window.personagem.inventario.mochila) {
                            window.personagem.inventario.mochila = [];
                        }
                        window.personagem.inventario.mochila.push(this.informacaoSecreta.item);
                        adicionarLog(`   Você ganhou: ${this.informacaoSecreta.item.nome}`, 'sucesso');
                        
                        // Após mostrar a informação extra, volta às opções
                        setTimeout(() => {
                            const opcoes = this.criarOpcoes(this.estado.reacao.classificacao);
                            this.renderizarOpcoes(opcoes, this);
                        }, 4000);
                        
                    }, 3000);
                }
                
            } else if (tipo === 'tesouro') {
                info = this.informacoes.otima[1];
                adicionarLog(`   Informação de tesouro!`, 'sucesso');
            } else if (tipo === 'goblins_avancado') {
                info = "Eles estão acampados perto da Caverna dos Esquecidos. Dizem que têm um chefe grande e forte. Cuidado!";
                adicionarLog(`⚔️ Informação avançada!`, 'sucesso');
            }
        }
        
        // Se for informação normal (sem delay extra)
        if (info && !(tipo === 'menina' && reacaoClass === 'otima')) {
            if (dialogoTexto) {
                dialogoTexto.textContent = info;
            }
            
            // Voltar às opções normais após a informação
            setTimeout(() => {
                const opcoes = this.criarOpcoes(this.estado.reacao.classificacao);
                this.renderizarOpcoes(opcoes, this);
            }, 4000);
        }
    },
    
    // ===== INICIAR FLERTE =====
    iniciarFlerte: function(opcao) {
        if (this.estado.flerteTentado) {
            dialogoTexto.textContent = "Ela ri, corando. 'Outra hora, talvez... Vá, sua aventura te espera.'";
            
            setTimeout(() => {
                this.prepararSaida();
            }, 2000);
            return;
        }
        
        this.estado.flerteTentado = true;
        const nhFlerte = opcao.nh;
        
        adicionarLog(`   INICIANDO FLERTE... NH: ${nhFlerte}`, 'info');
        dialogoTexto.textContent = "Você comenta que as flores que ela colhe são bonitas, e que combinam com seus olhos. Ela cora levemente.";
        
        setTimeout(() => {
            const opcoesFlerte = [
                {
                    texto: `   Ser direto: "Posso te ver quando voltar?" (NH ${nhFlerte})`,
                    acao: "testeFlerte",
                    nh: nhFlerte
                },
                {
                    texto: "   Recuar educadamente",
                    acao: "sairFlerte"
                },
                {
                    texto: "  ️ Mudar de assunto",
                    acao: "voltarInfo"
                }
            ];
            
            this.renderizarOpcoesFlerte(opcoesFlerte);
        }, 2000);
    },
    
    // ===== RENDERIZAR OPÇÕES DE FLERTE =====
    renderizarOpcoesFlerte: function(opcoes) {
        if (!opcoesDialogo) return;
        
        const cenaAtual = this;
        opcoesDialogo.innerHTML = '';
        
        opcoes.forEach(opcao => {
            const btn = document.createElement('button');
            btn.className = 'opcao-btn';
            btn.textContent = opcao.texto;
            
            btn.addEventListener('click', () => {
                if (opcao.acao === 'testeFlerte') {
                    cenaAtual.testeFlerte(opcao.nh);
                } else if (opcao.acao === 'sairFlerte') {
                    dialogoTexto.textContent = "Ela sorri, aliviada. 'Foi bom te conhecer.'";
                    
                    setTimeout(() => {
                        cenaAtual.prepararSaida();
                    }, 2000);
                } else if (opcao.acao === 'voltarInfo') {
                    const opcoesNormais = cenaAtual.criarOpcoes(cenaAtual.estado.reacao.classificacao);
                    cenaAtual.renderizarOpcoes(opcoesNormais, cenaAtual);
                }
            });
            
            opcoesDialogo.appendChild(btn);
        });
    },
    
    // ===== TESTE DE FLERTE =====
    testeFlerte: function(nh) {
        const resultado = SistemaSocial.testeSocial(nh, 12);
        
        adicionarLog(`   TESTE DE FLERTE:`, 'info');
        adicionarLog(`   NH: ${nh} vs 12`, 'info');
        adicionarLog(`   Rolagem: ${resultado.rolagem}`, 'info');
        adicionarLog(`   Margem: ${resultado.margem}`, 'info');
        
        if (resultado.sucesso) {
            if (resultado.critico) {
                adicionarLog(`✨ SUCESSO CRÍTICO!`, 'sucesso');
                dialogoTexto.textContent = "Ela cora intensamente. 'Volte quando sua missão acabar.' Ela te dá uma flor.";
                
                if (!window.personagem.inventario.mochila) window.personagem.inventario.mochila = [];
                window.personagem.inventario.mochila.push({
                    id: "flor_elara",
                    nome: "Flor de Elara",
                    descricao: "Uma flor silvestre que ela te deu.",
                    peso: 0.01
                });
                adicionarLog(`   Flor de Elara`, 'sucesso');
            } else {
                adicionarLog(`✅ Sucesso!`, 'sucesso');
                dialogoTexto.textContent = "Ela sorri, meio sem graça. 'Quando voltar, podemos conversar.'";
            }
            
            setTimeout(() => {
                this.prepararSaida();
            }, 3000);
            
        } else {
            if (resultado.falhaCritica) {
                adicionarLog(`   FALHA CRÍTICA!`, 'erro');
                dialogoTexto.textContent = "Ela parece ofendida. 'Isso é inapropriado! Adeus!'";
            } else {
                adicionarLog(`❌ Falha.`, 'erro');
                dialogoTexto.textContent = "Ela parece desconfortável. 'Acho melhor ir embora.'";
            }
            
            setTimeout(() => {
                this.mostrarBotaoAvancar();
            }, 2000);
        }
    },
    
    // ===== FLERTE AVANÇADO =====
    flerteAvancado: function(opcao) {
        if (this.estado.flerteTentado) {
            dialogoTexto.textContent = "Ela sorri. 'Gosto disso. Mas vá salvar a menina.'";
            
            setTimeout(() => {
                this.prepararSaida();
            }, 2000);
            return;
        }
        
        this.estado.flerteTentado = true;
        const nhFlerte = opcao.nh;
        
        adicionarLog(`   FLERTE AVANÇADO NH: ${nhFlerte}`, 'info');
        dialogoTexto.textContent = "'Oferecer companhia?' Ela ri. 'Quando voltar, adoraria.'";
        
        setTimeout(() => {
            const opcoes = [
                {
                    texto: `   "Combinado então." (NH ${nhFlerte})`,
                    acao: "testeFlerte",
                    nh: nhFlerte
                },
                {
                    texto: "   'Combinado.' (sem teste)",
                    acao: "sairFlerte"
                }
            ];
            
            this.renderizarOpcoesFlerte(opcoes);
        }, 2000);
    }
},


      carroca_destruida: {
    id: "carroca_destruida",
    nome: "Local do Ataque",
    imagem: "carroca.jpg",
    
    // Estado da cena
    estado: {
        percepcaoTestada: false,
        bonecaEncontrada: false,
        rastrosEncontrados: false,
        testeRealizado: false
    },
    
    // Fala inicial (sem detalhes)
    fala: {
        npc: "Narrador",
        texto: "A estrada à frente está silenciosa... quieta demais. Conforme você se aproxima, avista algo estranho no caminho."
    },
    
    // ===== FUNÇÃO RENDERIZAR =====
    renderizar: function() {
        const cenaAtual = this;
        
        // Resetar estado
        this.estado = {
            percepcaoTestada: false,
            bonecaEncontrada: false,
            rastrosEncontrados: false,
            testeRealizado: false
        };
        
        // Imagem de fundo
        if (window.cenarioArea) {
            window.cenarioArea.style.backgroundImage = "url('carroca.jpg')";
        }
        
        // Fala inicial do narrador
        if (window.npcNome) window.npcNome.textContent = "Narrador";
        if (window.npcAvatar) window.npcAvatar.style.display = 'none';
        if (window.dialogoTexto) window.dialogoTexto.textContent = this.fala.texto;
        
        // Botão para se aproximar
        if (window.opcoesDialogo) {
            window.opcoesDialogo.innerHTML = '';
            
            const btnAproximar = document.createElement('button');
            btnAproximar.className = 'opcao-btn';
            btnAproximar.textContent = "   Se aproximar para investigar";
            btnAproximar.addEventListener('click', function() {
                cenaAtual.iniciarInvestigacao();
            });
            window.opcoesDialogo.appendChild(btnAproximar);
        }
    },
    
    // ===== INICIAR INVESTIGAÇÃO =====
    iniciarInvestigacao: function() {
        const cenaAtual = this;
        
        // Primeira visão - descrição inicial
        if (window.dialogoTexto) {
            window.dialogoTexto.textContent = "Ao se aproximar, você vê os destroços de uma carroça. Madeira partida, mercadorias espalhadas... e manchas de sangue no chão. Parece que o ataque foi recente.";
        }
        
        // Botões de ação
        if (window.opcoesDialogo) {
            window.opcoesDialogo.innerHTML = '';
            
            const btnObservar = document.createElement('button');
            btnObservar.className = 'opcao-btn';
            btnObservar.textContent = "   Observar atentamente (Teste de Percepção)";
            btnObservar.addEventListener('click', function() {
                cenaAtual.realizarTestePercepcao();
            });
            window.opcoesDialogo.appendChild(btnObservar);
            
            const btnSeguir = document.createElement('button');
            btnSeguir.className = 'opcao-btn';
            btnSeguir.textContent = "➡️ Seguir caminho (ignorar)";
            btnSeguir.addEventListener('click', function() {
                if (window.dialogoTexto) {
                    window.dialogoTexto.textContent = "Você decide não perder tempo e continua pela estrada.";
                }
                setTimeout(function() { window.carregarCena('clareira_goblins'); }, 2000);
            });
            window.opcoesDialogo.appendChild(btnSeguir);
        }
    },
    
    // ===== TESTE DE PERCEPÇÃO =====
    realizarTestePercepcao: function() {
        const cenaAtual = this;
        
        // Calcular Percepção do personagem
        let iq = 10; // valor padrão
        try {
            iq = window.getValorAtributoReal ? window.getValorAtributoReal('iq') : 10;
        } catch(e) {
            console.log('Erro ao pegar IQ, usando padrão 10');
        }
        
        const temSentidos = window.personagem?.vantagens?.includes('sentidosAgucados');
        const bonusVantagem = temSentidos ? 2 : 0;
        
        const percepcao = iq + bonusVantagem;
        
        if (window.adicionarLog) {
            window.adicionarLog(`   TESTE DE PERCEPÇÃO`, 'info');
            window.adicionarLog(`   IQ: ${iq} + ${bonusVantagem} (Sentidos Aguçados) = ${percepcao}`, 'info');
        }
        
        // Rolar 2d10
        const rolagem = Math.floor(Math.random() * 10) + 1 + Math.floor(Math.random() * 10) + 1;
        const resultado = rolagem;
        const margem = percepcao - resultado;
        
        if (window.adicionarLog) {
            window.adicionarLog(`   Rolagem: ${rolagem}`, 'info');
            window.adicionarLog(`   Margem: ${margem}`, 'info');
        }
        
        // Verificar resultado
        const sucesso = resultado <= percepcao;
        
        if (!sucesso) {
            // FALHA - Não percebe nada além do óbvio
            if (window.adicionarLog) window.adicionarLog(`❌ Falha na Percepção!`, 'erro');
            if (window.dialogoTexto) {
                window.dialogoTexto.textContent = "Você examina a área, mas não encontra nada além dos destroços óbvios. Talvez os goblins já tenham levado tudo de valor.";
            }
            
            // Apenas opção de seguir
            if (window.opcoesDialogo) {
                window.opcoesDialogo.innerHTML = '';
                const btnSeguir = document.createElement('button');
                btnSeguir.className = 'opcao-btn';
                btnSeguir.textContent = "➡️ Seguir para a floresta";
                btnSeguir.addEventListener('click', function() {
                    window.carregarCena('clareira_goblins');
                });
                window.opcoesDialogo.appendChild(btnSeguir);
            }
            return;
        }
        
        // SUCESSO - Encontra a boneca
        if (window.adicionarLog) window.adicionarLog(`✅ Sucesso na Percepção!`, 'sucesso');
        this.estado.bonecaEncontrada = true;
        
        let textoDescoberta = "Examinando cuidadosamente, você nota algo enterrado na lama perto de uma moita, a alguns metros da carroça. É uma boneca de pano, suja, mas intacta.";
        
        // Se margem >= 2, encontra também rastros
        if (margem >= 2) {
            if (window.adicionarLog) window.adicionarLog(`✨ Sucesso por margem ${margem}! Encontra rastros!`, 'sucesso');
            this.estado.rastrosEncontrados = true;
            textoDescoberta += " Além disso, você percebe pegadas frescas levando para o norte, na direção da floresta. São pegadas de criaturas pequenas... goblins! E algumas são mais fundas, como se estivessem carregando algo pesado.";
        } else {
            textoDescoberta += " Não há outros sinais além dos destroços da carroça.";
        }
        
        if (window.dialogoTexto) {
            window.dialogoTexto.textContent = textoDescoberta;
        }
        
        // Opções pós-descoberta
        if (window.opcoesDialogo) {
            window.opcoesDialogo.innerHTML = '';
            
            // Opção de pegar a boneca
            const btnPegar = document.createElement('button');
            btnPegar.className = 'opcao-btn';
            btnPegar.textContent = "   Pegar a boneca";
            btnPegar.addEventListener('click', function() {
                cenaAtual.pegarBoneca();
            });
            window.opcoesDialogo.appendChild(btnPegar);
            
            // Opção de seguir rastros (se encontrou)
            if (this.estado.rastrosEncontrados) {
                const btnRastros = document.createElement('button');
                btnRastros.className = 'opcao-btn';
                btnRastros.textContent = "   Seguir os rastros dos goblins";
                btnRastros.addEventListener('click', function() {
                    if (window.dialogoTexto) {
                        window.dialogoTexto.textContent = "Você segue as pegadas pela floresta. Elas levam para o norte, cada vez mais fundo na mata fechada...";
                    }
                    setTimeout(function() { window.carregarCena('clareira_goblins'); }, 2000);
                });
                window.opcoesDialogo.appendChild(btnRastros);
            } else {
                // Se não encontrou rastros, opção genérica
                const btnSeguir = document.createElement('button');
                btnSeguir.className = 'opcao-btn';
                btnSeguir.textContent = "➡️ Seguir para a floresta";
                btnSeguir.addEventListener('click', function() {
                    if (window.dialogoTexto) {
                        window.dialogoTexto.textContent = "Sem pistas claras, você decide seguir para a floresta. Algo lhe diz que os goblins foram por ali...";
                    }
                    setTimeout(function() { window.carregarCena('clareira_goblins'); }, 2000);
                });
                window.opcoesDialogo.appendChild(btnSeguir);
            }
            
            // Opção de ignorar
            const btnIgnorar = document.createElement('button');
            btnIgnorar.className = 'opcao-btn';
            btnIgnorar.textContent = "   Ignorar e seguir caminho";
            btnIgnorar.addEventListener('click', function() {
                if (window.dialogoTexto) {
                    window.dialogoTexto.textContent = "Você decide não se envolver mais e continua sua jornada.";
                }
                setTimeout(function() { window.carregarCena('clareira_goblins'); }, 2000);
            });
            window.opcoesDialogo.appendChild(btnIgnorar);
        }
    },
    
    // ===== PEGAR BONECA =====
    pegarBoneca: function() {
        if (!window.personagem.inventario.mochila) {
            window.personagem.inventario.mochila = [];
        }
        
        window.personagem.inventario.mochila.push({
            id: "boneca_lyra_" + Date.now(),
            nome: "Boneca de Lyra",
            descricao: "Uma boneca de pano suja, provavelmente da menina raptada. Pode ser importante para convencê-la de que você veio para ajudar.",
            peso: 0.2
        });
        
        if (window.adicionarLog) window.adicionarLog(`   Você pegou: Boneca de Lyra`, 'sucesso');
        
        if (window.dialogoTexto) {
            window.dialogoTexto.textContent = "Você guarda a boneca com cuidado. Quem quer que tenha perdido isso deve estar desesperado.";
        }
        
        // Voltar às opções (sem a boneca novamente)
        if (window.opcoesDialogo) {
            window.opcoesDialogo.innerHTML = '';
            
            if (this.estado.rastrosEncontrados) {
                const btnRastros = document.createElement('button');
                btnRastros.className = 'opcao-btn';
                btnRastros.textContent = "   Seguir os rastros dos goblins";
                btnRastros.addEventListener('click', function() {
                    if (window.dialogoTexto) {
                        window.dialogoTexto.textContent = "Você segue as pegadas pela floresta. Elas levam para o norte, cada vez mais fundo na mata fechada...";
                    }
                    setTimeout(function() { window.carregarCena('clareira_goblins'); }, 2000);
                });
                window.opcoesDialogo.appendChild(btnRastros);
            } else {
                const btnSeguir = document.createElement('button');
                btnSeguir.className = 'opcao-btn';
                btnSeguir.textContent = "➡️ Seguir para a floresta";
                btnSeguir.addEventListener('click', function() {
                    window.carregarCena('clareira_goblins');
                });
                window.opcoesDialogo.appendChild(btnSeguir);
            }
        }
    }
}, 
        
  // ============================================
// CENA: CLAREIRA DOS GOBLINS (COMPLETA E CORRIGIDA)
// ============================================

clareira_goblins: {
    id: "clareira_goblins",
    nome: "Clareira na Floresta",
    imagem: "clareira-goblins.jpg", // Imagem de fundo da clareira
    
    // Estado da cena
    estado: {
        furtividadeTestada: false,
        percepcaoTestada: false,
        furtividadeSucesso: false,
        inimigosAlertados: false,
        informacaoObtida: false,
        processando: false
    },
    
    // NPCs visíveis na cena (os goblins)
    npcs: [
        {
            id: "goblin_arqueiro",
            nome: "Goblin Arqueiro",
            sprite: "goblin-arqueiro.png", // imagem na mesma pasta
            x: 30,
            y: 40,
            visivel: true
        },
        {
            id: "goblin_guerreiro",
            nome: "Goblin Guerreiro",
            sprite: "goblin-guerreiro.png", // imagem na mesma pasta
            x: 50,
            y: 50,
            visivel: true
        },
        {
            id: "goblin_normal",
            nome: "Goblin",
            sprite: "goblin.png", // imagem na mesma pasta
            x: 70,
            y: 60,
            visivel: true
        }
    ],
    
    // Lista de inimigos na cena (3 goblins) - para combate
    inimigos: [
        {
            id: "goblin_arqueiro",
            nome: "Goblin Arqueiro",
            sprite: "goblin-arqueiro.png", 
            pv: 64,
            pv_max: 64,
            defesa: 9,
            dx: 12,
            nh_ataque: 12,
            dano: "2d-1",
            xp: 30
        },
        {
            id: "goblin_guerreiro",
            nome: "Goblin Guerreiro",
            sprite: "goblin-guerreiro.png",
            pv: 72,
            pv_max: 72,
            defesa: 9,
            dx: 11,
            nh_ataque: 11,
            dano: "2d",
            rd: 2,
            xp: 40
        },
        {
            id: "goblin_normal",
            nome: "Goblin",
            sprite: "goblin.png",
            pv: 56,
            pv_max: 56,
            defesa: 9,
            dx: 10,
            nh_ataque: 10,
            dano: "1d+1",
            xp: 25
        }
    ],
    
    // Fala inicial do narrador
    fala: {
        npc: "Narrador",
        texto: "Seguindo os rastros pela floresta densa, você finalmente chega a uma clareira. O cheiro de fumaça e carne queimada toma conta do ar. Escondido atrás de uma moita, você avista um acampamento goblin... Três deles estão ao redor de uma fogueira, um segurando um arco, outro com uma espada maior e um terceiro menor, aparentemente mais fraco."
    },
    
    // ===== FUNÇÃO RENDERIZAR =====
    renderizar: function() {
        const cenaAtual = this;
        
        // Resetar estado da cena
        this.estado = {
            furtividadeTestada: false,
            percepcaoTestada: false,
            furtividadeSucesso: false,
            inimigosAlertados: false,
            informacaoObtida: false,
            processando: false
        };
        
        // Imagem de fundo
        if (window.cenarioArea) {
            window.cenarioArea.style.backgroundImage = "url('clareira-goblins.jpg')";
            window.cenarioArea.style.backgroundSize = "cover";
            window.cenarioArea.style.backgroundPosition = "center";
        }
        
        // MOSTRAR OS GOBLINS NO CENÁRIO
        if (window.npcsContainer) {
            window.npcsContainer.innerHTML = '';
            
            // Goblin Arqueiro
            const npcArqueiro = document.createElement('div');
            npcArqueiro.className = 'npc-sprite';
            npcArqueiro.style.left = '30%';
            npcArqueiro.style.top = '40%';
            npcArqueiro.dataset.npcId = 'goblin_arqueiro';
            npcArqueiro.innerHTML = `
                <img src="goblin-arqueiro.png" alt="Goblin Arqueiro" onerror="this.src='https://via.placeholder.com/150x200/2a5a2a/ffd700?text=Arqueiro'">
                <div class="npc-nome">Goblin Arqueiro</div>
            `;
            window.npcsContainer.appendChild(npcArqueiro);
            
            // Goblin Guerreiro
            const npcGuerreiro = document.createElement('div');
            npcGuerreiro.className = 'npc-sprite';
            npcGuerreiro.style.left = '50%';
            npcGuerreiro.style.top = '50%';
            npcGuerreiro.dataset.npcId = 'goblin_guerreiro';
            npcGuerreiro.innerHTML = `
                <img src="goblin-guerreiro.png" alt="Goblin Guerreiro" onerror="this.src='https://via.placeholder.com/150x200/3a3a1a/ffd700?text=Guerreiro'">
                <div class="npc-nome">Goblin Guerreiro</div>
            `;
            window.npcsContainer.appendChild(npcGuerreiro);
            
            // Goblin Normal
            const npcNormal = document.createElement('div');
            npcNormal.className = 'npc-sprite';
            npcNormal.style.left = '70%';
            npcNormal.style.top = '60%';
            npcNormal.dataset.npcId = 'goblin_normal';
            npcNormal.innerHTML = `
                <img src="goblin.png" alt="Goblin" onerror="this.src='https://via.placeholder.com/150x200/1a4a1a/ffd700?text=Goblin'">
                <div class="npc-nome">Goblin</div>
            `;
            window.npcsContainer.appendChild(npcNormal);
        }
        
        // Mostrar fala inicial
        if (window.npcNome) window.npcNome.textContent = "Narrador";
        if (window.npcAvatar) window.npcAvatar.style.display = 'none';
        if (window.dialogoTexto) window.dialogoTexto.textContent = this.fala.texto;
        
        // Mostrar opções iniciais
        this.mostrarOpcoesIniciais();
    },
    
    // ===== MOSTRAR OPÇÕES INICIAIS =====
    mostrarOpcoesIniciais: function() {
        const cenaAtual = this;
        
        if (window.opcoesDialogo) {
            window.opcoesDialogo.innerHTML = '';
            
            // Opção 1: Tentar furtividade
            const btnFurtividade = document.createElement('button');
            btnFurtividade.className = 'opcao-btn';
            btnFurtividade.innerHTML = '   Tentar se aproximar furtivamente';
            btnFurtividade.addEventListener('click', () => {
                if (!cenaAtual.estado.processando) {
                    cenaAtual.tentarFurtividade();
                }
            });
            window.opcoesDialogo.appendChild(btnFurtividade);
            
            // Opção 2: Atacar diretamente
            const btnAtacar = document.createElement('button');
            btnAtacar.className = 'opcao-btn';
            btnAtacar.innerHTML = '⚔️ Atacar os goblins diretamente';
            btnAtacar.addEventListener('click', () => {
                if (!cenaAtual.estado.processando) {
                    cenaAtual.estado.inimigosAlertados = true;
                    cenaAtual.iniciarCombate();
                }
            });
            window.opcoesDialogo.appendChild(btnAtacar);
            
            // Opção 3: Voltar (fugir)
            const btnVoltar = document.createElement('button');
            btnVoltar.className = 'opcao-btn';
            btnVoltar.innerHTML = '   Voltar para a floresta';
            btnVoltar.addEventListener('click', () => {
                if (!cenaAtual.estado.processando) {
                    if (window.dialogoTexto) {
                        window.dialogoTexto.textContent = "Você decide recuar e pensar em outra estratégia...";
                    }
                    setTimeout(() => {
                        window.carregarCena('carroca_destruida');
                    }, 2000);
                }
            });
            window.opcoesDialogo.appendChild(btnVoltar);
        }
    },
    
    // ===== FUNÇÃO: TESTAR FURTIVIDADE =====
    tentarFurtividade: function() {
        const cenaAtual = this;
        
        // Marcar como processando para evitar múltiplos cliques
        this.estado.processando = true;
        
        if (window.dialogoTexto) {
            window.dialogoTexto.textContent = "Você se agacha e começa a se mover silenciosamente entre as árvores, tentando se aproximar do acampamento sem ser notado...";
        }
        
        // Mostrar botão de processamento
        if (window.opcoesDialogo) {
            window.opcoesDialogo.innerHTML = '';
            const btnProcessando = document.createElement('button');
            btnProcessando.className = 'opcao-btn';
            btnProcessando.textContent = "⏳ Rolando dados...";
            btnProcessando.disabled = true;
            window.opcoesDialogo.appendChild(btnProcessando);
        }
        
        // Processar após 2 segundos
        setTimeout(() => {
            // Pega o personagem
            const personagem = window.personagem;
            
            if (!personagem) {
                window.adicionarLog("❌ Erro: Personagem não carregado!", "erro");
                cenaAtual.estado.processando = false;
                cenaAtual.mostrarOpcoesIniciais();
                return;
            }
            
            // Calcula Furtividade
            let furtividade = 0;
            let furtividadeInfo = "";
            
            // Pega o valor da perícia Furtividade se existir
            if (personagem.pericias && personagem.pericias.furtividade) {
                furtividade = personagem.pericias.furtividade.nh || 0;
                furtividadeInfo = `Usando perícia Furtividade: NH ${furtividade}`;
            } else {
                // Fallback: DX + 3
                const dx = personagem.atributos?.dx?.valor || 10;
                furtividade = dx + 3;
                furtividadeInfo = `Sem perícia, usando DX+3: ${dx}+3 = ${furtividade}`;
            }
            
            // Rola 2d10 usando SistemaCombate
            const resultado = window.SistemaCombate.rolar2d10();
            const d1 = resultado.dados[0];
            const d2 = resultado.dados[1];
            const rolagem = resultado.total;
            
            const sucesso = rolagem <= furtividade;
            
            // Log
            window.adicionarLog(`   TESTE DE FURTIVIDADE: ${d1} + ${d2} = ${rolagem}`, 'info');
            window.adicionarLog(`   ${furtividadeInfo}`, 'info');
            window.adicionarLog(`   NH: ${furtividade} | Resultado: ${rolagem}`, 'info');
            window.adicionarLog(sucesso ? '   ✅ Sucesso!' : '   ❌ Falhou!', sucesso ? 'sucesso' : 'erro');
            
            if (sucesso) {
                cenaAtual.estado.furtividadeSucesso = true;
                cenaAtual.aposFurtividadeSucesso();
            } else {
                // Falhou - inimigos alertados!
                cenaAtual.estado.inimigosAlertados = true;
                if (window.dialogoTexto) {
                    window.dialogoTexto.textContent = "CRAC! Você pisa em um galho seco. Os goblins viram rapidamente, empunhando suas armas! 'INTRUSO!'";
                }
                setTimeout(() => {
                    cenaAtual.iniciarCombate();
                }, 2000);
            }
            
            cenaAtual.estado.processando = false;
        }, 2000);
    },
    
    // ===== APÓS FURTIVIDADE BEM SUCEDIDA =====
    aposFurtividadeSucesso: function() {
        const cenaAtual = this;
        
        if (window.dialogoTexto) {
            window.dialogoTexto.textContent = "Você consegue se aproximar bem perto do acampamento, escondido atrás de uma rocha. Agora pode ouvir a conversa dos goblins...";
        }
        
        // Opções após furtividade
        if (window.opcoesDialogo) {
            window.opcoesDialogo.innerHTML = '';
            
            // Opção: Ouvir conversa (Percepção)
            const btnOuvir = document.createElement('button');
            btnOuvir.className = 'opcao-btn';
            btnOuvir.innerHTML = '   Escutar a conversa (Percepção)';
            btnOuvir.addEventListener('click', () => {
                if (!cenaAtual.estado.processando) {
                    cenaAtual.testarPercepcao();
                }
            });
            window.opcoesDialogo.appendChild(btnOuvir);
            
            // Opção: Atacar de surpresa
            const btnAtacar = document.createElement('button');
            btnAtacar.className = 'opcao-btn';
            btnAtacar.innerHTML = '⚔️ Atacar de surpresa (bônus de +3)';
            btnAtacar.addEventListener('click', () => {
                if (!cenaAtual.estado.processando) {
                    cenaAtual.estado.inimigosAlertados = true;
                    cenaAtual.iniciarCombate(true);
                }
            });
            window.opcoesDialogo.appendChild(btnAtacar);
            
            // Opção: Voltar
            const btnVoltar = document.createElement('button');
            btnVoltar.className = 'opcao-btn';
            btnVoltar.innerHTML = '   Voltar para a floresta';
            btnVoltar.addEventListener('click', () => {
                if (!cenaAtual.estado.processando) {
                    if (window.dialogoTexto) {
                        window.dialogoTexto.textContent = "Você decide não arriscar e volta para a floresta...";
                    }
                    setTimeout(() => {
                        window.carregarCena('carroca_destruida');
                    }, 2000);
                }
            });
            window.opcoesDialogo.appendChild(btnVoltar);
        }
    },
    
    // ===== TESTAR PERCEPÇÃO =====
    testarPercepcao: function() {
        const cenaAtual = this;
        
        // Marcar como processando
        this.estado.processando = true;
        
        if (window.dialogoTexto) {
            window.dialogoTexto.textContent = "Você se concentra para ouvir o que os goblins estão falando...";
        }
        
        // Mostrar botão de processamento
        if (window.opcoesDialogo) {
            window.opcoesDialogo.innerHTML = '';
            const btnProcessando = document.createElement('button');
            btnProcessando.className = 'opcao-btn';
            btnProcessando.textContent = "⏳ Aguardando resultado...";
            btnProcessando.disabled = true;
            window.opcoesDialogo.appendChild(btnProcessando);
        }
        
        setTimeout(() => {
            const personagem = window.personagem;
            
            if (!personagem) {
                window.adicionarLog("❌ Erro: Personagem não carregado!", "erro");
                cenaAtual.estado.processando = false;
                cenaAtual.aposFurtividadeSucesso();
                return;
            }
            
            // Calcula Percepção
            let percepcao = personagem.atributos?.iq?.valor || 10;
            let bonusTexto = '';
            
            if (personagem.vantagens && personagem.vantagens.includes('sentidosAgucados')) {
                percepcao += 2;
                bonusTexto = ' +2 Sentidos Aguçados';
            }
            
            // Rola 2d10
            const resultado = window.SistemaCombate.rolar2d10();
            const d1 = resultado.dados[0];
            const d2 = resultado.dados[1];
            const rolagem = resultado.total;
            
            const sucesso = rolagem <= percepcao;
            const margem = percepcao - rolagem;
            
            window.adicionarLog(`   TESTE DE PERCEPÇÃO: ${d1} + ${d2} = ${rolagem}`, 'info');
            window.adicionarLog(`   NH: IQ ${personagem.atributos?.iq?.valor || 10}${bonusTexto} = ${percepcao}`, 'info');
            window.adicionarLog(sucesso ? '   ✅ Sucesso!' : '   ❌ Falhou!', sucesso ? 'sucesso' : 'erro');
            
            if (sucesso) {
                // INFORMAÇÃO OBTIDA!
                cenaAtual.estado.informacaoObtida = true;
                
                let textoInfo = "Você escuta claramente a conversa:\n\n";
                textoInfo += "   Goblin Arqueiro: 'O chefe vai ficar contente!'\n";
                textoInfo += "⚔️ Goblin Guerreiro: 'A menina elfa de cabelo prateado vai render um bom resgate na caverna.'\n";
                textoInfo += "   Goblin Normal: 'Cala a boca seu idiota! E se alguém estiver ouvindo?'\n\n";
                
                if (margem >= 3) {
                    textoInfo += "✨ Com sua percepção aguçada, você percebe que eles estão de guarda baixa, distraídos com a discussão. Seria fácil atacá-los de surpresa.";
                } else {
                    textoInfo += "   Agora você sabe: a menina está em uma CAVERNA. Esses goblins são apenas um acampamento avançado.";
                }
                
                if (window.dialogoTexto) {
                    window.dialogoTexto.textContent = textoInfo;
                }
                
                window.adicionarLog(`   INFORMAÇÃO OBTIDA: Lyra está na caverna!`, 'sucesso');
                
                // Mostrar opções pós-informação
                setTimeout(() => {
                    cenaAtual.aposInformacao();
                    cenaAtual.estado.processando = false;
                }, 5000);
                
            } else {
                // Falhou na percepção
                if (window.dialogoTexto) {
                    window.dialogoTexto.textContent = "Os goblins estão falando muito baixo. Você não consegue entender nada, apenas ouve palavras soltas como 'menina', 'caverna'... Nada muito claro.";
                }
                
                window.adicionarLog(`❌ Não conseguiu entender a conversa`, 'erro');
                
                setTimeout(() => {
                    cenaAtual.aposFurtividadeSucesso();
                    cenaAtual.estado.processando = false;
                }, 3000);
            }
        }, 2000);
    },
    
    // ===== APÓS OBTER INFORMAÇÃO =====
    aposInformacao: function() {
        const cenaAtual = this;
        
        if (window.opcoesDialogo) {
            window.opcoesDialogo.innerHTML = '';
            
            // Opção: Atacar os goblins
            const btnAtacar = document.createElement('button');
            btnAtacar.className = 'opcao-btn';
            btnAtacar.innerHTML = '⚔️ Atacar os goblins (eliminar a ameaça)';
            btnAtacar.addEventListener('click', () => {
                if (!cenaAtual.estado.processando) {
                    cenaAtual.estado.inimigosAlertados = true;
                    cenaAtual.iniciarCombate();
                }
            });
            window.opcoesDialogo.appendChild(btnAtacar);
            
            // Opção: Ignorar e seguir para caverna
            const btnSeguir = document.createElement('button');
            btnSeguir.className = 'opcao-btn';
            btnSeguir.innerHTML = '➡️ Ignorar e seguir para a caverna';
            btnSeguir.addEventListener('click', () => {
                if (!cenaAtual.estado.processando) {
                    if (window.dialogoTexto) {
                        window.dialogoTexto.textContent = "Você decide não perder tempo com esses goblins. A menina está na caverna, e é para lá que você vai.";
                    }
                    setTimeout(() => {
                        window.carregarCena('entrada_caverna');
                    }, 2000);
                }
            });
            window.opcoesDialogo.appendChild(btnSeguir);
            
            // Opção: Voltar para a floresta
            const btnVoltar = document.createElement('button');
            btnVoltar.className = 'opcao-btn';
            btnVoltar.innerHTML = '   Voltar para a floresta';
            btnVoltar.addEventListener('click', () => {
                if (!cenaAtual.estado.processando) {
                    window.carregarCena('carroca_destruida');
                }
            });
            window.opcoesDialogo.appendChild(btnVoltar);
        }
    },
    
    // ===== INICIAR COMBATE =====
    iniciarCombate: function(emboscada = false) {
        // Log para debug
        window.adicionarLog(`   Iniciando combate na clareira...`, 'info');
        window.adicionarLog(`   Emboscada: ${emboscada ? 'SIM' : 'NÃO'}`, 'info');
        
        // Verificar se a função global existe
        if (typeof window.iniciarCombate !== 'function') {
            window.adicionarLog("❌ ERRO: Sistema de combate não carregado!", "erro");
            window.adicionarLog("   Verifique se o sistema-combate.js foi carregado antes da aventura", "erro");
            return;
        }
        
        // Preparar os inimigos para o combate
        const inimigosCombate = this.inimigos.map(inimigo => ({
            ...inimigo,
            pv: inimigo.pv_max,
            pv_atual: inimigo.pv_max
        }));
        
        // Log dos inimigos preparados
        window.adicionarLog(`   Preparados ${inimigosCombate.length} inimigos para combate`, 'info');
        
        // Chama a função global de iniciar combate
        window.iniciarCombate(inimigosCombate, emboscada);
        
        // Define a cena após vitória
        window.capituloAtual.ao_vencer = "entrada_caverna";
    },
    
    // ===== MOSTRAR OPÇÕES DE COMBATE (quando já alertou) =====
    mostrarOpcoesCombate: function() {
        if (window.opcoesDialogo) {
            window.opcoesDialogo.innerHTML = '';
            
            const btnCombate = document.createElement('button');
            btnCombate.className = 'opcao-btn';
            btnCombate.innerHTML = '⚔️ Iniciar Combate';
            btnCombate.addEventListener('click', () => {
                if (!this.estado.processando) {
                    this.iniciarCombate();
                }
            });
            window.opcoesDialogo.appendChild(btnCombate);
            
            const btnVoltar = document.createElement('button');
            btnVoltar.className = 'opcao-btn';
            btnVoltar.innerHTML = '   Voltar para a floresta';
            btnVoltar.addEventListener('click', () => {
                if (!this.estado.processando) {
                    window.carregarCena('carroca_destruida');
                }
            });
            window.opcoesDialogo.appendChild(btnVoltar);
        }
    }
},
        entrada_caverna: {
            id: "entrada_caverna",
            nome: "Entrada da Caverna",
            imagem: "entrada-caverna.jpg",
            fala: {
                npc: "Narrador",
                texto: "Uma abertura escura na rocha. Você ouve vozes ecoando."
            },
            opcoes: [
                {
                    texto: "Entrar na caverna",
                    proximo: "camara_chefe"
                }
            ]
        },
        
        camara_chefe: {
            id: "camara_chefe",
            nome: "Câmara do Chefe",
            imagem: "menina-elfa.jpg",
            fala: {
                npc: "Narrador",
                texto: "Numa jaula, uma menina elfa de cabelos prateados está sentada, assustada. Um goblin grande monta guarda."
            },
            npcs: [
                {
                    id: "menina_elfa",
                    nome: "Lyra",
                    sprite: "menina-elfa.jpg",
                    dialogo: "Por favor, me ajude!"
                },
                {
                    id: "chefe_goblin",
                    nome: "Chefe Goblin",
                    sprite: "chefe-goblin.png"
                }
            ],
            inimigos: [
                {
                    id: "chefe_goblin",
                    nome: "Chefe Goblin",
                    sprite: "chefe-goblin.png",
                    pv: 85,
                    pv_max: 85,
                    esquiva: 8,
                    nh_ataque: 10,
                    dano: "2d+2",
                    xp: 100
                }
            ],
            opcoes: [
                {
                    texto: "Atacar o chefe!",
                    acao: "iniciar_combate",
                    inimigos: ["chefe_goblin"],
                    ao_vencer: "final_vitoria"
                }
            ]
        },
        
        final_vitoria: {
            id: "final_vitoria",
            nome: "Missão Cumprida",
            imagem: "menina-elfa.jpg",
            fala: {
                npc: "Lyra",
                texto: "Você me salvou! Muito obrigada!"
            },
            opcoes: [
                {
                    texto: "Voltar à taverna",
                    proximo: "final_taverna"
                }
            ]
        },
        
        final_taverna: {
            id: "final_taverna",
            nome: "Retorno Triunfal",
            imagem: "taverna-interior.jpg",
            fala: {
                npc: "Eldrin",
                texto: "MINHA FILHA! Você conseguiu! Muito obrigado, aventureiro!"
            },
            npcs: [
                {
                    id: "homem",
                    nome: "Eldrin",
                    sprite: "npc-sangue.jpg"
                },
                {
                    id: "lyra",
                    nome: "Lyra",
                    sprite: "menina-elfa.jpg"
                },
                {
                    id: "taverneiro",
                    nome: "Taverneiro",
                    sprite: "taverneiro.jpg"
                }
            ],
            opcoes: [
                {
                    texto: "Encerrar aventura",
                    acao: "finalizar_aventura"
                }
            ]
        }
    }
};
</script>
   
<script type="module">
// ============================================
// IMPORTAÇÕES FIREBASE
// ============================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// ============================================
// CONFIGURAÇÃO FIREBASE
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyBrx4JSmFay24k95pu1ICjFfVki8gs_uHw",
    authDomain: "rpgforce-e3227.firebaseapp.com",
    projectId: "rpgforce-e3227",
    storageBucket: "rpgforce-e3227.firebasestorage.app",
    messagingSenderId: "984517342332",
    appId: "1:984517342332:web:87d33aa4c84ff2a07685f9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ============================================
// ELEMENTOS DOM
// ============================================
const loadingOverlay = document.getElementById('loadingOverlay');

// Header
const headerAvatar = document.getElementById('headerAvatar');
const headerNome = document.getElementById('headerNome');
const headerClasse = document.getElementById('headerClasse');
const headerPV = document.getElementById('headerPV');
const headerPVBarra = document.getElementById('headerPVBarra');
const headerMana = document.getElementById('headerMana');
const headerManaBarra = document.getElementById('headerManaBarra');
const headerFadiga = document.getElementById('headerFadiga');
const headerFadigaBarra = document.getElementById('headerFadigaBarra');
const headerXP = document.getElementById('headerXP');
const headerXPBarra = document.getElementById('headerXPBarra');
const pmValor = document.getElementById('pmValor');

// Ficha
const fichaAvatar = document.getElementById('fichaAvatar');
const fichaNome = document.getElementById('fichaNome');
const fichaClasse = document.getElementById('fichaClasse');
const atributosContainer = document.getElementById('atributosContainer');
const defesasGrid = document.getElementById('defesasGrid');
const bolinhasSaldoContainer = document.getElementById('bolinhasSaldoContainer');
const bolinhasSaldo = document.getElementById('bolinhasSaldo');
const atoIndicator = document.getElementById('atoIndicator');
const atoTexto = document.getElementById('atoTexto');
const nivelPersonagem = document.getElementById('nivelPersonagem');

// Botões de ficha
const btnVerVantagens = document.getElementById('btnVerVantagens');
const btnVerDesvantagens = document.getElementById('btnVerDesvantagens');
const btnVerPericias = document.getElementById('btnVerPericias');
const btnVerMagias = document.getElementById('btnVerMagias');
const contadorVantagensBtn = document.getElementById('contadorVantagensBtn');
const contadorDesvantagensBtn = document.getElementById('contadorDesvantagensBtn');
const contadorPericiasBtn = document.getElementById('contadorPericiasBtn');
const contadorMagiasBtn = document.getElementById('contadorMagiasBtn');

// Cenário e diálogo
const cenarioArea = document.getElementById('cenarioArea');
const npcsContainer = document.getElementById('npcsContainer');
const npcFalando = document.getElementById('npcFalando');
const npcAvatar = document.getElementById('npcAvatar');
const npcNome = document.getElementById('npcNome');
const dialogoTexto = document.getElementById('dialogoTexto');
const opcoesDialogo = document.getElementById('opcoesDialogo');

// Ações
const turnoIndicator = document.getElementById('turnoIndicator');
const btnAtacar = document.getElementById('btnAtacar');
const btnMagia = document.getElementById('btnMagia');
const btnInventario = document.getElementById('btnInventario');
const btnDescansar = document.getElementById('btnDescansar');
const btnDefender = document.getElementById('btnDefender'); // NOVO BOTÃO
const inimigosContainer = document.getElementById('inimigosContainer');
const inimigosLista = document.getElementById('inimigosLista');
const logContainer = document.getElementById('logContainer');

// Modais
const modalEscolhaAtributo = document.getElementById('modalEscolhaAtributo');
const modalInventario = document.getElementById('modalInventario');
const modalVantagens = document.getElementById('modalVantagens');
const modalDesvantagens = document.getElementById('modalDesvantagens');
const modalPericias = document.getElementById('modalPericias');
const modalMagias = document.getElementById('modalMagias');
const modalAtaque = document.getElementById('modalAtaque');
const modalDefesa = document.getElementById('modalDefesa');
const modalDados = document.getElementById('modalDados');

const bolinhasDisponiveisModal = document.getElementById('bolinhasDisponiveisModal');
const valorStModal = document.getElementById('valorStModal');
const valorDxModal = document.getElementById('valorDxModal');
const valorIqModal = document.getElementById('valorIqModal');
const valorHtModal = document.getElementById('valorHtModal');

const cancelarEscolhaAtributo = document.getElementById('cancelarEscolhaAtributo');
const fecharModalInventario = document.getElementById('fecharModalInventario');
const fecharModalVantagens = document.getElementById('fecharModalVantagens');
const fecharModalDesvantagens = document.getElementById('fecharModalDesvantagens');
const fecharModalPericias = document.getElementById('fecharModalPericias');
const fecharModalMagias = document.getElementById('fecharModalMagias');

const armasLista = document.getElementById('armasLista');
const btnCancelarAtaque = document.getElementById('btnCancelarAtaque');
const btnConfirmarAtaque = document.getElementById('btnConfirmarAtaque');

const defesaContexto = document.getElementById('defesaContexto');
const defesasLista = document.getElementById('defesasLista');
const btnCancelarDefesa = document.getElementById('btnCancelarDefesa');
const btnConfirmarDefesa = document.getElementById('btnConfirmarDefesa');

const btnAbrirDados = document.getElementById('btnAbrirDados');
const btnFecharDados = document.getElementById('btnFecharDados');
const btnRolarDados = document.getElementById('btnRolarDados');
const dadosResultado = document.getElementById('dadosResultado');
const dadosQtd = document.getElementById('dadosQtd');
const dadosFaces = document.getElementById('dadosFaces');
const dadosMod = document.getElementById('dadosMod');

const modalDinheiro = document.getElementById('modalDinheiro');
const modalCarga = document.getElementById('modalCarga');
const modalPM = document.getElementById('modalPM');
const modalAptidao = document.getElementById('modalAptidao');

// ============================================
// DICIONÁRIOS DE NOMES
// ============================================
const nomesVantagens = {
    aliado: 'Aliado',
    ambidestria: 'Ambidestria',
    aptidaoMagica: 'Aptidão Mágica',
    abascanto: 'Abascanto',
    carisma: 'Carisma',
    destemor: 'Destemor',
    duroMatar: 'Duro de Matar',
    flexibilidade: 'Flexibilidade',
    intuicao: 'Intuição',
    nocaoPerigo: 'Noção do Perigo',
    reflexoCombate: 'Reflexo de Combate',
    regeneracao: 'Regeneração',
    sentidosAgucados: 'Sentidos Aguçados',
    sorte: 'Sorte',
    visaoNoturna: 'Visão Noturna',
    mestreArmas: 'Mestre das Armas',
    forcaVontade: 'Força de Vontade',
    fadigaExtra: 'Fadiga Extra',
    htExtra: 'HT Extra',
    atraente: 'Atraente',
    rico: 'Rico'
};

const nomesDesvantagens = {
    alcoolismo: 'Alcoolismo',
    avareza: 'Avareza',
    briguento: 'Briguento',
    barulhento: 'Barulhento',
    cobica: 'Cobiça',
    circunspeccao: 'Circunspecção',
    cleptomania: 'Cleptomania',
    codigoHonra: 'Código de Honra',
    covardia: 'Covardia',
    daltonismo: 'Daltonismo',
    sensoDever: 'Senso do Dever',
    inimigo: 'Inimigo',
    excessoConfianca: 'Excesso de Confiança',
    fobia: 'Fobia',
    furia: 'Fúria',
    honestidade: 'Honestidade',
    luxuria: 'Luxúria',
    megalomania: 'Megalomania',
    pacifismo: 'Pacifismo',
    piromania: 'Piromania',
    preguica: 'Preguiça',
    sanguinolencia: 'Sanguinolência',
    teimosia: 'Teimosia',
    veracidade: 'Veracidade',
    zarolho: 'Zarolho',
    magro: 'Magro',
    gordo: 'Gordo',
    nanismo: 'Nanismo',
    pobre: 'Pobre',
    feio: 'Feio'
};

const nomesFobias = {
    acrofobia: 'Acrofobia - Medo de alturas',
    agorafobia: 'Agorafobia - Medo de espaços abertos',
    aracnofobia: 'Aracnofobia - Medo de aranhas',
    autofobia: 'Autofobia - Medo de solidão',
    brontofobia: 'Brontofobia - Medo de ruídos altos',
    claustrofobia: 'Claustrofobia - Medo de espaços fechados',
    coitofobia: 'Coitofobia - Medo de sexo',
    demofobia: 'Demofobia - Medo de multidões',
    ecmofobia: 'Ecmofobia - Medo de coisas afiadas',
    elurofobia: 'Elurofobia - Medo de gatos',
    entomofobia: 'Entomofobia - Medo de insetos',
    hematofobia: 'Hematofobia - Medo de sangue',
    hoplofobia: 'Hoplofobia - Medo de armas',
    manafobia: 'Manafobia - Medo de magia',
    misofobia: 'Misofobia - Medo de sujeira',
    necrofobia: 'Necrofobia - Medo da morte',
    nictofobia: 'Nictofobia - Medo do escuro',
    ofiofobia: 'Ofiofobia - Medo de répteis',
    pirofobia: 'Pirofobia - Medo de fogo',
    psicofobia: 'Psicofobia - Medo de poderes psíquicos',
    talassofobia: 'Talassofobia - Medo do mar',
    tecnofobia: 'Tecnofobia - Medo de máquinas',
    teratofobia: 'Teratofobia - Medo de monstros',
    triscedecofobia: 'Triscedecofobia - Medo do número 13',
    xenofobia: 'Xenofobia - Medo do desconhecido'
};

// ============================================
// ESTADO DO JOGO
// ============================================
let currentUser = null;
let personagem = null;
let historia = null;
let capituloAtual = null;
let inimigos = [];
let sessaoId = null;

let turnoAtual = 'pc'; // 'pc' ou 'inimigos'
let inimigoSelecionado = null;
let armaSelecionada = null;
let defesaSelecionada = null;
let ataqueAtual = null;

// Controle de tempo e eventos
let timerHomem = null;
let atoAtual = 1;

// Status do personagem
let pvAtual = 0;
let pvMax = 0;
let fadigaAtual = 0;
let fadigaMax = 0;
let manaAtual = 0;
let manaMax = 0;
let xpAtual = 0;
let pmAtual = 0;
let bolinhasDisponiveis = 0;
let pmDisponivel = 30;
let pmGasto = 0;

const XP_POR_BOLINHA = 100;

// ============================================
// FUNÇÕES AUXILIARES
// ============================================
function showLoading() {
    if (loadingOverlay) loadingOverlay.classList.add('active');
}

function hideLoading() {
    if (loadingOverlay) loadingOverlay.classList.remove('active');
}

function adicionarLog(mensagem, tipo = 'info') {
    if (!logContainer) return;
    const logItem = document.createElement('div');
    logItem.className = `log-item ${tipo}`;
    logItem.innerHTML = mensagem;
    logContainer.appendChild(logItem);
    logContainer.scrollTop = logContainer.scrollHeight;
    
    while (logContainer.children.length > 50) {
        logContainer.removeChild(logContainer.firstChild);
    }
}

function rolarDados(quantidade, faces, modificador = 0) {
    let total = 0;
    let resultados = [];
    
    for (let i = 0; i < quantidade; i++) {
        const resultado = Math.floor(Math.random() * faces) + 1;
        resultados.push(resultado);
        total += resultado;
    }
    
    total += modificador;
    
    return {
        total: total,
        resultados: resultados,
        modificador: modificador,
        texto: `${resultados.join(' + ')} ${modificador >= 0 ? '+' : '-'} ${Math.abs(modificador)} = ${total}`
    };
}

function rolar2d10() {
    return rolarDados(2, 10, 0);
}

function setAto(numero, texto) {
    atoAtual = numero;
    if (atoTexto) atoTexto.textContent = `Ato ${numero}: ${texto}`;
    adicionarLog(`   Ato ${numero}: ${texto}`, 'sucesso');
}

function getValorAtributo(atributo) {
    if (!personagem || !personagem.atributos) return 0;
    
    const base = { st: 9, dx: 5, iq: 5, ht: 8 }[atributo];
    const bolinhas = personagem.atributos[atributo]?.bolinhas || 0;
    return base + bolinhas;
}

function getValorAtributoReal(atributo) {
    if (!personagem || !personagem.atributos) return 0;
    return personagem.atributos[atributo]?.valor || 0;
}

function calcularManaMax() {
    const iq = getValorAtributoReal('iq');
    const ht = getValorAtributoReal('ht');
    return iq + ht;
}

function calcularPVMax() {
    const ht = getValorAtributoReal('ht');
    return ht * 8;
}

function calcularFadigaMax() {
    if (!personagem || !personagem.atributos?.ht) return 8;
    return 8 + (personagem.atributos.ht.bolinhas || 0);
}

function calcularPMAtual() {
    if (!personagem) return 0;
    const disponivel = personagem.pmDisponivel || 30;
    const gasto = personagem.pmGasto || 0;
    return Math.max(0, disponivel - gasto);
}

function calcularNivelPersonagem() {
    if (!personagem || !personagem.atributos) return 1;
    
    const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
    const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
    const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
    const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
    
    const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
    return totalBolinhas + 1;
}

function atualizarNivelNaTela() {
    const nivelElement = document.getElementById('nivelPersonagem');
    if (nivelElement) {
        const nivel = calcularNivelPersonagem();
        nivelElement.textContent = nivel;
    }
}

function verificarGanhoBolinha() {
    if (!personagem) return;
    
    const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
    const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
    const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
    const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
    
    const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
    const xpNecessario = (totalBolinhas + bolinhasDisponiveis + 1) * XP_POR_BOLINHA;
    
    while (xpAtual >= xpNecessario) {
        bolinhasDisponiveis++;
        xpAtual -= xpNecessario;
        adicionarLog(`   Você ganhou uma bolinha! (Total: ${bolinhasDisponiveis} disponíveis)`, 'sucesso');
        
        const novoTotal = totalBolinhas + bolinhasDisponiveis;
        const proximoXP = (novoTotal + 1) * XP_POR_BOLINHA;
        if (headerXP) headerXP.textContent = `${xpAtual}/${proximoXP}`;
        if (headerXPBarra) headerXPBarra.style.width = (xpAtual / proximoXP * 100) + '%';
    }
    
    atualizarInterfaceBolinhas();
}

function atualizarInterfaceBolinhas() {
    if (!bolinhasSaldoContainer || !bolinhasSaldo) return;
    
    if (bolinhasDisponiveis > 0) {
        bolinhasSaldoContainer.style.display = 'flex';
        bolinhasSaldo.textContent = bolinhasDisponiveis;
        
        document.querySelectorAll('.atributo-card').forEach(card => {
            card.classList.add('bolinha-disponivel');
        });
    } else {
        bolinhasSaldoContainer.style.display = 'none';
        document.querySelectorAll('.atributo-card').forEach(card => {
            card.classList.remove('bolinha-disponivel');
        });
    }
}

function abrirModalEscolhaAtributo() {
    if (!modalEscolhaAtributo) return;
    if (bolinhasDisponiveis <= 0) return;
    
    if (valorStModal) valorStModal.textContent = getValorAtributo('st');
    if (valorDxModal) valorDxModal.textContent = getValorAtributo('dx');
    if (valorIqModal) valorIqModal.textContent = getValorAtributo('iq');
    if (valorHtModal) valorHtModal.textContent = getValorAtributo('ht');
    if (bolinhasDisponiveisModal) bolinhasDisponiveisModal.textContent = bolinhasDisponiveis;
    
    modalEscolhaAtributo.classList.add('active');
}

function adicionarBolinha(atributo) {
    if (bolinhasDisponiveis <= 0) return;
    
    if (!personagem.atributos[atributo]) {
        personagem.atributos[atributo] = { 
            bolinhas: 0, 
            base: (atributo === 'st' || atributo === 'ht') ? 8 : 5, 
            valor: (atributo === 'st' || atributo === 'ht') ? 8 : 5 
        };
    }
    
    const nivelAntes = calcularNivelPersonagem();
    
    personagem.atributos[atributo].bolinhas = (personagem.atributos[atributo].bolinhas || 0) + 1;
    personagem.atributos[atributo].valor = personagem.atributos[atributo].base + personagem.atributos[atributo].bolinhas;
    
    bolinhasDisponiveis--;
    
    const nivelDepois = calcularNivelPersonagem();
    
    pvMax = calcularPVMax();
    manaMax = calcularManaMax();
    fadigaMax = calcularFadigaMax();
    
    adicionarLog(`✨ Bolinha adicionada em ${atributo.toUpperCase()}! (${bolinhasDisponiveis} restantes)`, 'sucesso');
    
    if (nivelDepois > nivelAntes) {
        adicionarLog(`   NÍVEL AUMENTOU: ${nivelAntes} → ${nivelDepois}!`, 'sucesso');
    }
    
    atualizarFichaPersonagem();
    atualizarNivelNaTela();
    
    salvarProgresso();
    
    if (bolinhasDisponiveis > 0) {
        abrirModalEscolhaAtributo();
    } else {
        if (modalEscolhaAtributo) modalEscolhaAtributo.classList.remove('active');
    }
}

function abrirModalVantagens() {
    if (!modalVantagens) return;
    const vantagensLista = document.getElementById('vantagensLista');
    if (!vantagensLista) return;
    
    if (!personagem || !personagem.vantagens || personagem.vantagens.length === 0) {
        vantagensLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma vantagem</div>';
        modalVantagens.classList.add('active');
        return;
    }
    
    vantagensLista.innerHTML = '';
    
    personagem.vantagens.forEach(vantagemId => {
        const nome = nomesVantagens[vantagemId] || vantagemId;
        const div = document.createElement('div');
        div.className = 'vantagem-item';
        div.innerHTML = `
            <h4>${nome}</h4>
            <div class="tipo">Vantagem</div>
        `;
        vantagensLista.appendChild(div);
    });
    
    modalVantagens.classList.add('active');
}

function abrirModalDesvantagens() {
    if (!modalDesvantagens) return;
    const desvantagensLista = document.getElementById('desvantagensLista');
    if (!desvantagensLista) return;
    
    if (!personagem || !personagem.desvantagens || personagem.desvantagens.length === 0) {
        desvantagensLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma desvantagem</div>';
        modalDesvantagens.classList.add('active');
        return;
    }
    
    desvantagensLista.innerHTML = '';
    
    personagem.desvantagens.forEach(desvantagemId => {
        let nome = '';
        if (desvantagemId.startsWith('fobia:')) {
            const fobiaId = desvantagemId.replace('fobia:', '');
            nome = nomesFobias[fobiaId] || fobiaId;
        } else {
            nome = nomesDesvantagens[desvantagemId] || desvantagemId;
        }
        
        const div = document.createElement('div');
        div.className = 'desvantagem-item';
        
        let extra = '';
        if (desvantagemId.startsWith('fobia:')) {
            extra = '<span class="badge-fobia">Fobia</span>';
        }
        
        div.innerHTML = `
            <h4>${nome} ${extra}</h4>
            <div class="tipo">Desvantagem</div>
        `;
        desvantagensLista.appendChild(div);
    });
    
    modalDesvantagens.classList.add('active');
}

function abrirModalPericias() {
    if (!modalPericias) return;
    const periciasLista = document.getElementById('periciasLista');
    if (!periciasLista) return;
    
    if (!personagem || !personagem.pericias) {
        periciasLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma perícia</div>';
        if (modalPM) modalPM.textContent = `${pmAtual}/${pmDisponivel}`;
        modalPericias.classList.add('active');
        return;
    }
    
    periciasLista.innerHTML = '';
    
    const pericias = personagem.pericias;
    const periciasArray = Object.entries(pericias);
    
    if (periciasArray.length === 0) {
        periciasLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma perícia</div>';
    } else {
        periciasArray.forEach(([id, dados]) => {
            const nome = id.charAt(0).toUpperCase() + id.slice(1);
            const nivel = dados.nivel || 1;
            const bonus = nivel === 1 ? 0 : nivel - 1;
            
            let atributoBase = 10;
            let atributoNome = 'ST';
            
            if (id === 'alquimia' || id === 'intimidacao' || id === 'labia') {
                atributoBase = getValorAtributoReal('iq');
                atributoNome = 'IQ';
            } else {
                atributoBase = getValorAtributoReal('dx');
                atributoNome = 'DX';
            }
            
            const nh = atributoBase + bonus;
            
            const div = document.createElement('div');
            div.className = 'pericia-modal-item';
            div.innerHTML = `
                <div class="pericia-modal-header">
                    <span class="pericia-modal-nome">${nome}</span>
                    <span class="pericia-modal-nivel">Nível ${nivel}</span>
                </div>
                <div class="pericia-modal-atributo">Base: ${atributoNome} ${atributoBase}</div>
                <div class="pericia-modal-bonus">Bônus: +${bonus}</div>
                <div class="pericia-modal-nh">NH: ${nh}</div>
            `;
            periciasLista.appendChild(div);
        });
    }
    
    if (modalPM) modalPM.textContent = `${pmAtual}/${pmDisponivel}`;
    modalPericias.classList.add('active');
}

function abrirModalMagias() {
    if (!modalMagias) return;
    const magiasLista = document.getElementById('magiasLista');
    if (!magiasLista) return;
    
    if (!personagem || !personagem.escolas || !personagem.escolas.agua) {
        magiasLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma magia</div>';
        if (modalAptidao) modalAptidao.textContent = personagem?.vantagens?.includes('aptidaoMagica') ? '+1' : '0';
        modalMagias.classList.add('active');
        return;
    }
    
    magiasLista.innerHTML = '';
    
    const magias = personagem.escolas.agua.magias;
    const temAptidao = personagem.vantagens?.includes('aptidaoMagica');
    const iq = getValorAtributoReal('iq');
    const nhBase = iq + (temAptidao ? 1 : 0);
    
    if (modalAptidao) modalAptidao.textContent = temAptidao ? '+1' : '0';
    
    const magiasArray = Object.entries(magias).filter(([_, magia]) => magia.desbloqueada && magia.nivel > 0);
    
    if (magiasArray.length === 0) {
        magiasLista.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Nenhuma magia desbloqueada</div>';
    } else {
        magiasArray.forEach(([id, magia]) => {
            let nome = '';
            switch(id) {
                case 'localizarAgua': nome = 'Localizar Água'; break;
                case 'purificarAgua': nome = 'Purificar Água'; break;
                case 'criarAgua': nome = 'Criar Água'; break;
                case 'dissiparAgua': nome = 'Dissipar Água'; break;
                case 'adagaDeGelo': nome = 'Adaga de Gelo'; break;
                case 'respirarNaAgua': nome = 'Respirar na Água'; break;
                case 'moldarAgua': nome = 'Moldar Água'; break;
                case 'nevoeiro': nome = 'Nevoeiro'; break;
                case 'armaCongelante': nome = 'Arma Congelante'; break;
                case 'cortinaDagua': nome = 'Cortina d\'Água'; break;
                case 'jatoDeAgua': nome = 'Jato d\'Água'; break;
                case 'ondaExpulsora': nome = 'Onda Expulsora'; break;
                case 'tempestadeDeGelo': nome = 'Tempestade de Gelo'; break;
                case 'congelamento': nome = 'Congelamento'; break;
                default: nome = id;
            }
            
            const tipo = magia.tipo || 'Desconhecido';
            const nivel = magia.nivel || 1;
            const efeito = `Nível ${nivel}`;
            
            const div = document.createElement('div');
            div.className = 'magia-item';
            div.innerHTML = `
                <div class="magia-header">
                    <span class="magia-nome">${nome}</span>
                    <span class="magia-nivel">Nível ${nivel}</span>
                </div>
                <div class="magia-tipo">${tipo}</div>
                <div class="magia-efeito">${efeito}</div>
                <div class="magia-nh-info">NH: ${nhBase}</div>
            `;
            magiasLista.appendChild(div);
        });
    }
    
    modalMagias.classList.add('active');
}

function abrirModalInventario() {
    if (!modalInventario) return;
    if (!personagem || !personagem.inventario) return;
    
    const equipado = document.getElementById('inventarioEquipado');
    const mochila = document.getElementById('inventarioMochila');
    const deposito = document.getElementById('inventarioDeposito');
    
    if (equipado) {
        equipado.innerHTML = '';
        if (personagem.inventario.corpo && personagem.inventario.corpo.length > 0) {
            personagem.inventario.corpo.forEach(item => {
                equipado.innerHTML += `
                    <div class="item-card">
                        <div class="nome">${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}</div>
                        <div class="detalhes">
                            <span>${item.peso || 0} kg</span>
                            <span>${item.preco || 0} $</span>
                        </div>
                        <div class="item-acoes">
                            <button class="item-acao" onclick="guardarItem('${item.id}')">Guardar</button>
                        </div>
                    </div>
                `;
            });
        } else {
            equipado.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Nada equipado</div>';
        }
    }
    
    if (mochila) {
        mochila.innerHTML = '';
        if (personagem.inventario.mochila && personagem.inventario.mochila.length > 0) {
            personagem.inventario.mochila.forEach(item => {
                mochila.innerHTML += `
                    <div class="item-card">
                        <div class="nome">${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}</div>
                        <div class="detalhes">
                            <span>${item.peso || 0} kg</span>
                            <span>${item.preco || 0} $</span>
                        </div>
                        <div class="item-acoes">
                            <button class="item-acao" onclick="equiparItem('${item.id}')">Equipar</button>
                            <button class="item-acao" onclick="moverParaDeposito('${item.id}')">Depósito</button>
                        </div>
                    </div>
                `;
            });
        } else {
            mochila.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Mochila vazia</div>';
        }
    }
    
    if (deposito) {
        deposito.innerHTML = '';
        if (personagem.inventario.deposito && personagem.inventario.deposito.length > 0) {
            personagem.inventario.deposito.forEach(item => {
                deposito.innerHTML += `
                    <div class="item-card">
                        <div class="nome">${item.nome}${item.quantidade > 1 ? ` (x${item.quantidade})` : ''}</div>
                        <div class="detalhes">
                            <span>${item.peso || 0} kg</span>
                            <span>${item.preco || 0} $</span>
                        </div>
                        <div class="item-acoes">
                            <button class="item-acao" onclick="pegarItem('${item.id}')">Pegar</button>
                        </div>
                    </div>
                `;
            });
        } else {
            deposito.innerHTML = '<div style="color:rgba(255,255,255,0.5); text-align:center;">Depósito vazio</div>';
        }
    }
    
    if (modalDinheiro) modalDinheiro.textContent = personagem.dinheiro || 0;
    
    let pesoTotal = 0;
    ['corpo', 'mochila'].forEach(local => {
        if (personagem.inventario[local]) {
            personagem.inventario[local].forEach(item => {
                pesoTotal += (item.peso || 0) * (item.quantidade || 1);
            });
        }
    });
    
    const st = getValorAtributo('st');
    const limiteCarga = st * 12;
    if (modalCarga) modalCarga.textContent = `${pesoTotal.toFixed(1)}/${limiteCarga} kg`;
    
    modalInventario.classList.add('active');
}

window.equiparItem = function(itemId) {
    if (!personagem?.inventario) return;
    
    const index = personagem.inventario.mochila.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.mochila[index];
        personagem.inventario.corpo.push(item);
        personagem.inventario.mochila.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

window.guardarItem = function(itemId) {
    if (!personagem?.inventario) return;
    
    const index = personagem.inventario.corpo.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.corpo[index];
        personagem.inventario.mochila.push(item);
        personagem.inventario.corpo.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

window.moverParaDeposito = function(itemId) {
    if (!personagem?.inventario) return;
    
    const index = personagem.inventario.mochila.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.mochila[index];
        personagem.inventario.deposito.push(item);
        personagem.inventario.mochila.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

window.pegarItem = function(itemId) {
    if (!personagem?.inventario) return;
    
    const index = personagem.inventario.deposito.findIndex(i => i.id === itemId);
    if (index !== -1) {
        const item = personagem.inventario.deposito[index];
        personagem.inventario.mochila.push(item);
        personagem.inventario.deposito.splice(index, 1);
        abrirModalInventario();
        atualizarFichaPersonagem();
        salvarProgresso();
    }
};

function atualizarFichaPersonagem() {
    if (!personagem) return;
    
    if (headerNome) headerNome.textContent = personagem.nome || 'Aventureiro';
    
    const classes = {
        guerreiro: 'Guerreiro', mago: 'Mago', ladino: 'Ladino',
        clerigo: 'Clérigo', barbaro: 'Bárbaro'
    };
    if (headerClasse) headerClasse.textContent = classes[personagem.classe] || personagem.classe || '';
    
    if (personagem.fotoURL) {
        if (headerAvatar) headerAvatar.innerHTML = `<img src="${personagem.fotoURL}" alt="Avatar">`;
        if (fichaAvatar) fichaAvatar.innerHTML = `<img src="${personagem.fotoURL}" alt="Avatar">`;
    }
    
    pvMax = calcularPVMax();
    pvAtual = personagem.statusCombate?.vidaAtual || pvMax;
    if (headerPV) headerPV.textContent = `${pvAtual}/${pvMax}`;
    if (headerPVBarra) headerPVBarra.style.width = (pvAtual / pvMax * 100) + '%';
    
    fadigaMax = calcularFadigaMax();
    fadigaAtual = personagem.statusCombate?.fadigaAtual || fadigaMax;
    if (headerFadiga) headerFadiga.textContent = `${fadigaAtual}/${fadigaMax}`;
    if (headerFadigaBarra) headerFadigaBarra.style.width = (fadigaAtual / fadigaMax * 100) + '%';
    
    manaMax = calcularManaMax();
    manaAtual = personagem.statusCombate?.manaAtual || manaMax;
    if (headerMana) headerMana.textContent = `${manaAtual}/${manaMax}`;
    if (headerManaBarra) headerManaBarra.style.width = (manaAtual / manaMax * 100) + '%';
    
    const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
    const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
    const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
    const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
    const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
    
    const xpNecessario = (totalBolinhas + bolinhasDisponiveis + 1) * XP_POR_BOLINHA;
    
    if (headerXP) headerXP.textContent = `${xpAtual}/${xpNecessario}`;
    if (headerXPBarra) headerXPBarra.style.width = (xpAtual / xpNecessario * 100) + '%';
    
    pmDisponivel = personagem.pmDisponivel || 30;
    pmGasto = personagem.pmGasto || 0;
    pmAtual = pmDisponivel - pmGasto;
    if (pmValor) pmValor.textContent = pmAtual;
    
    if (fichaNome) fichaNome.textContent = personagem.nome || 'Aventureiro';
    if (fichaClasse) fichaClasse.textContent = classes[personagem.classe] || personagem.classe || '';
    
    const st = getValorAtributoReal('st');
    const dx = getValorAtributoReal('dx');
    const iq = getValorAtributoReal('iq');
    const ht = getValorAtributoReal('ht');
    
    const criarBolinhasHTML = (atrib, total) => {
        let html = '';
        for (let i = 0; i < 15; i++) {
            if (i < total) {
                html += '<div class="bolinha-pequena preenchida"></div>';
            } else {
                html += '<div class="bolinha-pequena"></div>';
            }
        }
        return html;
    };
    
    if (atributosContainer) {
        atributosContainer.innerHTML = `
            <div class="atributo-card ${bolinhasDisponiveis > 0 ? 'bolinha-disponivel' : ''}" data-atributo="st">
                <div class="atributo-info">
                    <span class="atributo-nome">ST</span>
                    <div class="atributo-bolinhas">${criarBolinhasHTML('st', personagem.atributos?.st?.bolinhas || 0)}</div>
                </div>
                <div>
                    <span class="atributo-valor">${st}</span>
                    <span class="atributo-base">(${personagem.atributos?.st?.base || 8}+${personagem.atributos?.st?.bolinhas || 0})</span>
                </div>
            </div>
            
            <div class="atributo-card ${bolinhasDisponiveis > 0 ? 'bolinha-disponivel' : ''}" data-atributo="dx">
                <div class="atributo-info">
                    <span class="atributo-nome">DX</span>
                    <div class="atributo-bolinhas">${criarBolinhasHTML('dx', personagem.atributos?.dx?.bolinhas || 0)}</div>
                </div>
                <div>
                    <span class="atributo-valor">${dx}</span>
                    <span class="atributo-base">(${personagem.atributos?.dx?.base || 5}+${personagem.atributos?.dx?.bolinhas || 0})</span>
                </div>
            </div>
            
            <div class="atributo-card ${bolinhasDisponiveis > 0 ? 'bolinha-disponivel' : ''}" data-atributo="iq">
                <div class="atributo-info">
                    <span class="atributo-nome">IQ</span>
                    <div class="atributo-bolinhas">${criarBolinhasHTML('iq', personagem.atributos?.iq?.bolinhas || 0)}</div>
                </div>
                <div>
                    <span class="atributo-valor">${iq}</span>
                    <span class="atributo-base">(${personagem.atributos?.iq?.base || 5}+${personagem.atributos?.iq?.bolinhas || 0})</span>
                </div>
            </div>
            
            <div class="atributo-card ${bolinhasDisponiveis > 0 ? 'bolinha-disponivel' : ''}" data-atributo="ht">
                <div class="atributo-info">
                    <span class="atributo-nome">HT</span>
                    <div class="atributo-bolinhas">${criarBolinhasHTML('ht', personagem.atributos?.ht?.bolinhas || 0)}</div>
                </div>
                <div>
                    <span class="atributo-valor">${ht}</span>
                    <span class="atributo-base">(${personagem.atributos?.ht?.base || 8}+${personagem.atributos?.ht?.bolinhas || 0})</span>
                </div>
            </div>
        `;
    }
    
    document.querySelectorAll('.atributo-card').forEach(card => {
        card.addEventListener('click', () => {
            if (bolinhasDisponiveis > 0) {
                const atributo = card.dataset.atributo;
                adicionarBolinha(atributo);
            }
        });
    });
    
    const esquiva = Math.floor((dx + ht) / 6) + 6;
    
    let aparar = 0;
    if (personagem.inventario?.corpo) {
        const temArma = personagem.inventario.corpo.some(item => item.dano);
        if (temArma) aparar = Math.floor((dx + dx) / 4) + 6;
    }
    
    let bloqueio = 0;
    if (personagem.inventario?.corpo) {
        const temEscudo = personagem.inventario.corpo.some(item => item.tipo === 'escudo' || item.nome?.toLowerCase().includes('escudo'));
        if (temEscudo) bloqueio = Math.floor((dx + dx) / 4) + 6 + 2;
    }
    
    if (defesasGrid) {
        defesasGrid.innerHTML = `
            <div class="defesa-card">
                <div class="defesa-valor">${esquiva}</div>
                <div class="defesa-label">Esquiva</div>
            </div>
            <div class="defesa-card">
                <div class="defesa-valor">${aparar}</div>
                <div class="defesa-label">Aparar</div>
            </div>
            <div class="defesa-card">
                <div class="defesa-valor">${bloqueio}</div>
                <div class="defesa-label">Bloqueio</div>
            </div>
        `;
    }
    
    if (contadorVantagensBtn) contadorVantagensBtn.textContent = personagem.vantagens?.length || 0;
    if (contadorDesvantagensBtn) contadorDesvantagensBtn.textContent = personagem.desvantagens?.length || 0;
    if (contadorPericiasBtn) contadorPericiasBtn.textContent = Object.keys(personagem.pericias || {}).length;
    
    let magiasCount = 0;
    if (personagem.escolas?.agua?.magias) {
        magiasCount = Object.values(personagem.escolas.agua.magias).filter(m => m.desbloqueada && m.nivel > 0).length;
    }
    if (contadorMagiasBtn) contadorMagiasBtn.textContent = magiasCount;
    
    atualizarInterfaceBolinhas();
    atualizarNivelNaTela();
    
    window.personagem = personagem;
}

function carregarCena(cenaId) {
    if (!cenaId) return;
    
    if (typeof cenaId === 'string') {
        const cena = historia.cenas[cenaId];
        if (!cena) {
            return;
        }
        capituloAtual = cena;
    } else {
        capituloAtual = cenaId;
    }
    
    if (!capituloAtual) return;
    
    if (capituloAtual.renderizar && typeof capituloAtual.renderizar === 'function') {
        
        if (capituloAtual.imagem && cenarioArea) {
            cenarioArea.style.backgroundImage = `url('${capituloAtual.imagem}')`;
        }
        
        if (npcsContainer) npcsContainer.innerHTML = '';
        
        capituloAtual.renderizar();
        
        if (cenaId === 'encontro_camponesa') {
            setAto(4, 'A Floresta - Encontro com Elara');
        }
        
        return;
    }
    
    if (cenaId === 'exterior_taverna' || cenaId === 'interior_taverna') {
        setAto(1, 'A Taverna');
    } else if (cenaId === 'interior_taverna_com_homem' || cenaId === 'homem_fala_detalhes') {
        setAto(2, 'O Homem Ferido');
    } else if (cenaId === 'sair_para_aventura') {
        setAto(3, 'A Missão');
    } else if (cenaId === 'encontro_camponesa' || cenaId === 'carroca_destruida' || cenaId === 'clareira_goblins') {
        setAto(4, 'A Floresta');
    } else if (cenaId === 'entrada_caverna' || cenaId === 'camara_chefe') {
        setAto(5, 'A Caverna');
    } else if (cenaId === 'final_vitoria' || cenaId === 'final_taverna') {
        setAto(6, 'O Retorno');
    }
    
    if (capituloAtual.imagem && cenarioArea) {
        cenarioArea.style.backgroundImage = `url('${capituloAtual.imagem}')`;
    } else if (cenarioArea) {
        cenarioArea.style.backgroundImage = 'none';
    }
    
    if (npcsContainer) npcsContainer.innerHTML = '';
    if (capituloAtual.npcs && npcsContainer) {
        capituloAtual.npcs.forEach(npc => {
            if (npc.visivel === false) return;
            
            const npcDiv = document.createElement('div');
            npcDiv.className = 'npc-sprite';
            
            if (npc.id === 'taverneiro') {
                npcDiv.style.left = '85%';
                npcDiv.style.top = '60%';
            } else if (npc.id === 'homem_sangue') {
                npcDiv.style.left = '25%';
                npcDiv.style.top = '50%';
            } else {
                npcDiv.style.left = (npc.x || 50) + '%';
                npcDiv.style.top = (npc.y || 50) + '%';
            }
            
            npcDiv.dataset.npcId = npc.id;
            
            npcDiv.innerHTML = `
                <img src="${npc.sprite || 'default.png'}" alt="${npc.nome}">
                <div class="npc-nome">${npc.nome}</div>
            `;
            
            npcDiv.addEventListener('click', () => {
                falarComNPC(npc);
            });
            
            npcsContainer.appendChild(npcDiv);
        });
    }
    
    if (capituloAtual.fala) {
        if (npcNome) npcNome.textContent = capituloAtual.fala.npc || 'Narrador';
        if (capituloAtual.fala.avatar && npcAvatar) {
            npcAvatar.src = capituloAtual.fala.avatar;
            npcAvatar.style.display = 'inline';
        } else if (npcAvatar) {
            npcAvatar.style.display = 'none';
        }
        if (dialogoTexto) dialogoTexto.textContent = capituloAtual.fala.texto;
    } else if (dialogoTexto) {
        dialogoTexto.textContent = '...';
    }
    
    renderizarOpcoes(capituloAtual.opcoes);
    
    if (cenaId === 'interior_taverna') {
        iniciarTimerHomem();
    }
}

function renderizarOpcoes(opcoes) {
    if (!opcoesDialogo) return;
    opcoesDialogo.innerHTML = '';
    
    if (!opcoes || opcoes.length === 0) {
        const btnSair = document.createElement('button');
        btnSair.className = 'opcao-btn';
        btnSair.textContent = 'Sair da taverna';
        btnSair.addEventListener('click', () => {
            carregarCena('exterior_taverna');
        });
        opcoesDialogo.appendChild(btnSair);
        return;
    }
    
    opcoes.forEach(opcao => {
        const btn = document.createElement('button');
        btn.className = 'opcao-btn';
        btn.textContent = opcao.texto;
        
        btn.addEventListener('click', () => {
            if (opcao.proximo) {
                carregarCena(opcao.proximo);
            } else if (opcao.acao === 'iniciar_combate') {
                window.iniciarCombate(opcao.inimigos || []);
            } else if (opcao.resposta) {
                if (dialogoTexto) dialogoTexto.textContent = opcao.resposta;
            } else if (opcao.tipo === 'pagar') {
                if (personagem && personagem.dinheiro >= opcao.valor) {
                    personagem.dinheiro -= opcao.valor;
                    if (dialogoTexto) dialogoTexto.textContent = opcao.sucesso || 'Negócio feito!';
                    adicionarLog(`   Pagou ${opcao.valor} moedas`, 'sucesso');
                    atualizarFichaPersonagem();
                } else {
                    if (dialogoTexto) dialogoTexto.textContent = opcao.falha || 'Você não tem dinheiro suficiente!';
                }
            } else if (opcao.item) {
                if (!personagem.inventario.mochila) personagem.inventario.mochila = [];
                personagem.inventario.mochila.push({
                    id: opcao.item.id,
                    nome: opcao.item.nome,
                    descricao: opcao.item.descricao,
                    peso: opcao.item.peso || 0.1,
                    quantidade: 1
                });
                adicionarLog(`   Você pegou: ${opcao.item.nome}`, 'sucesso');
                if (dialogoTexto) dialogoTexto.textContent = opcao.resposta || `Você pegou ${opcao.item.nome}.`;
            } else if (opcao.acao === 'finalizar_aventura') {
                adicionarLog('   Aventura concluída! Parabéns!', 'sucesso');
                setTimeout(() => {
                    window.location.href = 'aventura-solo.html';
                }, 5000);
            }
            
            atualizarFichaPersonagem();
        });
        
        opcoesDialogo.appendChild(btn);
    });
}

function falarComNPC(npc) {
    if (npcNome) npcNome.textContent = npc.nome;
    if (npc.avatar && npcAvatar) {
        npcAvatar.src = npc.avatar;
        npcAvatar.style.display = 'inline';
    }
    if (dialogoTexto) dialogoTexto.textContent = npc.dialogo || '...';
    
    if (npc.opcoes) {
        renderizarOpcoes(npc.opcoes);
    } else {
        renderizarOpcoes([
            {
                texto: 'Sair da taverna',
                proximo: 'exterior_taverna'
            }
        ]);
    }
}

function iniciarTimerHomem() {
    if (timerHomem) {
        clearTimeout(timerHomem);
    }
    
    adicionarLog('⏳ Você pede uma cerveja e observa o ambiente...', 'info');
    
    timerHomem = setTimeout(() => {
        adicionarLog('   A porta se abre violentamente! Um homem ensanguentado entra cambaleando!', 'dano');
        carregarCena('interior_taverna_com_homem');
    }, 30000);
}

// ============================================
// FUNÇÕES DE COMBATE (CORRIGIDAS)
// ============================================

function getArmasEquipadas() {
    if (!personagem?.inventario?.corpo) return [];
    
    return personagem.inventario.corpo.filter(item => item.dano).map(item => ({
        id: item.id,
        nome: item.nome,
        dano: item.dano,
        tipoDano: item.tipoDano || 'Contusão',
        alcance: item.alcance || 1,
        st: item.st || 8
    }));
}

function renderizarInimigos() {
    if (!inimigosLista) return;
    
    inimigosLista.innerHTML = '';
    
    if (!window.inimigos || window.inimigos.length === 0) {
        inimigosContainer.style.display = 'none';
        return;
    }
    
    window.inimigos.forEach((inimigo, index) => {
        const pvPercent = (inimigo.pv_atual / inimigo.pv_max) * 100;
        
        const div = document.createElement('div');
        div.className = `inimigo-mini ${inimigoSelecionado === index ? 'selecionado' : ''}`;
        div.dataset.index = index;
        
        div.innerHTML = `
            <div class="inimigo-mini-nome">${inimigo.nome}</div>
            <div class="inimigo-mini-pv">
                <div class="inimigo-mini-pv-fill" style="width: ${pvPercent}%"></div>
            </div>
            <div style="font-size:0.7rem; color:#ff6b6b;">PV: ${inimigo.pv_atual}/${inimigo.pv_max}</div>
        `;
        
        div.addEventListener('click', () => {
            document.querySelectorAll('.inimigo-mini').forEach(el => el.classList.remove('selecionado'));
            div.classList.add('selecionado');
            inimigoSelecionado = index;
        });
        
        inimigosLista.appendChild(div);
    });
}

// ATAQUE - Agora com dano ST + Arma
function executarAtaque() {
    if (armaSelecionada === null) {
        const armas = getArmasEquipadas();
        if (armas.length === 1) {
            armaSelecionada = 0;
        } else {
            adicionarLog('❌ Selecione uma arma!', 'erro');
            return;
        }
    }
    
    if (inimigoSelecionado === null) {
        adicionarLog('❌ Selecione um inimigo!', 'erro');
        if (modalAtaque) modalAtaque.classList.remove('active');
        return;
    }
    
    const armas = getArmasEquipadas();
    const arma = armas[armaSelecionada];
    const inimigo = window.inimigos[inimigoSelecionado];
    
    if (!arma || !inimigo) {
        adicionarLog('❌ Erro no ataque!', 'erro');
        if (modalAtaque) modalAtaque.classList.remove('active');
        return;
    }
    
    if (modalAtaque) modalAtaque.classList.remove('active');
    
    // USAR SISTEMA DE COMBATE para atacar
    const resultado = SistemaCombate.atacar(window.personagem, inimigo, arma);
    
    adicionarLog(`⚔️ Ataque contra ${inimigo.nome}:`, 'info');
    adicionarLog(resultado.texto, resultado.acertou ? 'sucesso' : 'erro');
    
    if (resultado.acertou) {
        // Mostrar componentes do dano
        const danoBase = SistemaCombate.calcularDanoBase(window.personagem);
        const danoArma = SistemaCombate.rolarDados(arma.dano);
        adicionarLog(`   Dano base (ST ${getValorAtributoReal('st')}): ${danoBase} | Arma: ${danoArma} | Total: ${resultado.dano}`, 'info');
        
        inimigo.pv_atual = Math.max(0, inimigo.pv_atual - resultado.dano);
        adicionarLog(`   Dano: ${resultado.dano}`, 'dano');
        
        if (inimigo.pv_atual <= 0) {
            adicionarLog(`   ${inimigo.nome} foi derrotado!`, 'sucesso');
            
            const xpGanho = inimigo.xp || 25;
            xpAtual += xpGanho;
            personagem.xp = xpAtual;
            adicionarLog(`✨ Ganhou ${xpGanho} XP!`, 'sucesso');
            verificarGanhoBolinha();
            
            window.inimigos = window.inimigos.filter((_, i) => i !== inimigoSelecionado);
            inimigoSelecionado = null;
            armaSelecionada = null;
            
            if (window.inimigos.length === 0) {
                adicionarLog('   VITÓRIA!', 'sucesso');
                if (inimigosContainer) inimigosContainer.style.display = 'none';
                
                if (capituloAtual?.ao_vencer) {
                    carregarCena(capituloAtual.ao_vencer);
                }
                salvarProgresso();
                return;
            }
        }
        
        renderizarInimigos();
        atualizarFichaPersonagem();
        
        // Verificar perda de defesa por falha crítica
        if (resultado.falhaCritica) {
            SistemaCombate.turno.perderDefesa();
        }
        
        // Passar turno
        passarTurno();
    } else {
        // Passar turno mesmo errando
        passarTurno();
    }
    
    salvarProgresso();
}

// DEFESA - Agora com modal e escudo
function abrirModalDefesa(inimigo, dano, callback) {
    if (!modalDefesa) {
        // Se não tiver modal, usa esquiva automática
        processarDefesa('esquiva', inimigo, dano);
        if (callback) callback();
        return;
    }
    
    const defesaContexto = document.getElementById('defesaContexto');
    const defesasLista = document.getElementById('defesasLista');
    
    if (!defesaContexto || !defesasLista) {
        processarDefesa('esquiva', inimigo, dano);
        if (callback) callback();
        return;
    }
    
    // Mostrar contexto
    defesaContexto.innerHTML = `${inimigo.nome} causará ${dano} de dano! Escolha sua defesa:`;
    
    // Obter valores das defesas
    const dx = getValorAtributoReal('dx');
    const ht = getValorAtributoReal('ht');
    
    const esquiva = Math.floor((dx + ht) / 6) + 6;
    
    let aparar = 0;
    let bloqueio = 0;
    let escudoPV = 0;
    let escudoRD = 0;
    let escudoNome = '';
    
    // Verificar equipamentos
    if (personagem?.inventario?.corpo) {
        const temArma = personagem.inventario.corpo.some(item => item.dano);
        if (temArma) aparar = Math.floor((dx + dx) / 4) + 6;
        
        const escudo = personagem.inventario.corpo.find(item => 
            item.nome?.toLowerCase().includes('escudo') || item.tipo === 'escudo'
        );
        if (escudo) {
            bloqueio = Math.floor((dx + dx) / 4) + 6 + 2;
            escudoPV = escudo.pv || 10;
            escudoRD = escudo.rd || 2;
            escudoNome = escudo.nome || 'Escudo';
        }
    }
    
    // Criar lista de defesas
    defesasLista.innerHTML = '';
    
    // Esquiva
    const divEsquiva = document.createElement('div');
    divEsquiva.className = 'defesa-card-modal';
    divEsquiva.dataset.defesa = 'esquiva';
    divEsquiva.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span><i class="fas fa-running"></i> Esquiva</span>
            <span style="font-weight:bold; color:#4CAF50;">${esquiva}</span>
        </div>
        <div style="font-size:0.8rem;">Tentar desviar completamente</div>
    `;
    defesasLista.appendChild(divEsquiva);
    
    // Aparar
    if (aparar > 0) {
        const divAparar = document.createElement('div');
        divAparar.className = 'defesa-card-modal';
        divAparar.dataset.defesa = 'aparar';
        divAparar.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span><i class="fas fa-sword"></i> Aparar</span>
                <span style="font-weight:bold; color:#ffaa00;">${aparar}</span>
            </div>
            <div style="font-size:0.8rem;">Usar arma para bloquear</div>
        `;
        defesasLista.appendChild(divAparar);
    }
    
    // Bloqueio
    if (bloqueio > 0) {
        const divBloqueio = document.createElement('div');
        divBloqueio.className = 'defesa-card-modal';
        divBloqueio.dataset.defesa = 'bloqueio';
        divBloqueio.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span><i class="fas fa-shield"></i> Bloqueio</span>
                <span style="font-weight:bold; color:#4a9fff;">${bloqueio}</span>
            </div>
            <div style="font-size:0.8rem;">
                ${escudoNome} (PV: ${escudoPV} | RD: ${escudoRD})
            </div>
        `;
        defesasLista.appendChild(divBloqueio);
    }
    
    let defesaSelecionada = null;
    
    document.querySelectorAll('.defesa-card-modal').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.defesa-card-modal').forEach(c => c.classList.remove('selecionada'));
            card.classList.add('selecionada');
            defesaSelecionada = card.dataset.defesa;
            if (btnConfirmarDefesa) btnConfirmarDefesa.disabled = false;
        });
    });
    
    const confirmarHandler = () => {
        if (!defesaSelecionada) {
            defesaSelecionada = 'esquiva';
        }
        
        modalDefesa.classList.remove('active');
        
        // Processar defesa escolhida
        processarDefesa(defesaSelecionada, inimigo, dano, { escudoPV, escudoRD, escudoNome });
        
        btnConfirmarDefesa.removeEventListener('click', confirmarHandler);
        btnCancelarDefesa.removeEventListener('click', cancelarHandler);
        
        if (callback) callback();
    };
    
    const cancelarHandler = () => {
        modalDefesa.classList.remove('active');
        
        // Se cancelar, usa esquiva
        processarDefesa('esquiva', inimigo, dano, { escudoPV, escudoRD, escudoNome });
        
        btnConfirmarDefesa.removeEventListener('click', confirmarHandler);
        btnCancelarDefesa.removeEventListener('click', cancelarHandler);
        
        if (callback) callback();
    };
    
    if (btnConfirmarDefesa) {
        btnConfirmarDefesa.disabled = true;
        btnConfirmarDefesa.addEventListener('click', confirmarHandler);
    }
    
    if (btnCancelarDefesa) {
        btnCancelarDefesa.addEventListener('click', cancelarHandler);
    }
    
    modalDefesa.classList.add('active');
}

function processarDefesa(tipo, inimigo, dano, escudoInfo = {}) {
    const dx = getValorAtributoReal('dx');
    const ht = getValorAtributoReal('ht');
    
    let nhDefesa = 0;
    let nomeDefesa = '';
    
    switch(tipo) {
        case 'esquiva':
            nhDefesa = Math.floor((dx + ht) / 6) + 6;
            nomeDefesa = 'Esquiva';
            break;
        case 'aparar':
            nhDefesa = Math.floor((dx + dx) / 4) + 6;
            nomeDefesa = 'Aparar';
            break;
        case 'bloqueio':
            nhDefesa = Math.floor((dx + dx) / 4) + 6 + 2;
            nomeDefesa = 'Bloqueio';
            break;
        default:
            nhDefesa = Math.floor((dx + ht) / 6) + 6;
            nomeDefesa = 'Esquiva';
    }
    
    const rolagem = SistemaCombate.rolar2d10();
    const sucesso = rolagem.total <= nhDefesa;
    
    adicionarLog(`   ${nomeDefesa}: ${rolagem.texto} (NH ${nhDefesa})`, 'info');
    
    let danoFinal = dano;
    let mensagem = '';
    
    if (sucesso) {
        if (tipo === 'bloqueio' && escudoInfo.escudoPV > 0) {
            // Escudo absorve parte do dano
            const danoNoEscudo = Math.min(dano, escudoInfo.escudoPV);
            danoFinal = Math.max(0, dano - escudoInfo.escudoPV - escudoInfo.escudoRD);
            mensagem = `   ${escudoInfo.escudoNome || 'Escudo'} absorveu ${danoNoEscudo} dano!`;
        } else {
            danoFinal = 0;
        }
        adicionarLog(`✅ ${nomeDefesa} bem sucedida!`, 'sucesso');
        if (mensagem) adicionarLog(mensagem, 'sucesso');
    } else {
        const rd = personagem.derivados?.rd?.corpo || 2;
        danoFinal = Math.max(0, dano - rd);
        adicionarLog(`❌ Falhou na ${nomeDefesa}! RD reduziu para ${danoFinal}`, 'erro');
    }
    
    if (danoFinal > 0) {
        pvAtual = Math.max(0, pvAtual - danoFinal);
        if (personagem.statusCombate) personagem.statusCombate.vidaAtual = pvAtual;
        adicionarLog(`   ${inimigo.nome} causou ${danoFinal} de dano!`, 'dano');
        atualizarFichaPersonagem();
        
        if (pvAtual <= 0) {
            adicionarLog(`   VOCÊ MORREU!`, 'erro');
            btnAtacar.disabled = true;
            btnMagia.disabled = true;
            if (btnDefender) btnDefender.disabled = true;
        }
    }
}

// TURNO DOS INIMIGOS - Agora com modal de defesa
function processarTurnoInimigos() {
    if (!window.inimigos || window.inimigos.length === 0) {
        window.turnoAtual = 'pc';
        turnoIndicator.className = 'turno-indicator jogador';
        turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
        btnAtacar.disabled = false;
        btnMagia.disabled = false;
        if (btnDefender) btnDefender.disabled = false;
        return;
    }
    
    adicionarLog(`   Turno dos inimigos!`, 'dano');
    
    // Desabilitar botões do jogador
    btnAtacar.disabled = true;
    btnMagia.disabled = true;
    if (btnDefender) btnDefender.disabled = true;
    
    // Fila de ataques
    let index = 0;
    
    function atacarProximo() {
        if (index >= window.inimigos.length) {
            // Todos atacaram, passar turno
            setTimeout(() => {
                window.turnoAtual = 'pc';
                turnoIndicator.className = 'turno-indicator jogador';
                turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
                btnAtacar.disabled = false;
                btnMagia.disabled = false;
                if (btnDefender) btnDefender.disabled = false;
                adicionarLog(`  ️ Sua vez de agir!`, 'info');
                salvarProgresso();
            }, 1000);
            return;
        }
        
        const inimigo = window.inimigos[index];
        index++;
        
        // Rolar ataque do inimigo
        const rolagem = SistemaCombate.rolar2d10();
        const nhAtaque = inimigo.nh_ataque || 10;
        
        adicionarLog(`   ${inimigo.nome} ataca: ${rolagem.texto} (NH ${nhAtaque})`, 'info');
        
        if (rolagem.total <= nhAtaque) {
            // Calcula dano base
            let dano = 0;
            if (inimigo.dano) {
                dano = SistemaCombate.rolarDados(inimigo.dano);
            } else {
                dano = Math.floor(Math.random() * 6) + 1;
            }
            dano = Math.max(1, dano);
            
            // Abre modal para escolher defesa
            abrirModalDefesa(inimigo, dano, () => {
                // Depois de defender, processa próximo inimigo
                setTimeout(atacarProximo, 500);
            });
        } else {
            adicionarLog(`✅ ${inimigo.nome} errou!`, 'sucesso');
            setTimeout(atacarProximo, 500);
        }
    }
    
    // Iniciar ataques
    atacarProximo();
}

function passarTurno() {
    if (window.turnoAtual === 'pc') {
        window.turnoAtual = 'inimigos';
        
        // Passar turno no sistema de combate
        const resultadoTurno = SistemaCombate.turno.passarTurno(window.personagem);
        
        if (resultadoTurno.fadiga.perdeuFadiga) {
            adicionarLog(resultadoTurno.fadiga.texto, 'info');
            atualizarFichaPersonagem();
        }
        
        turnoIndicator.className = 'turno-indicator inimigo';
        turnoIndicator.innerHTML = '<i class="fas fa-skull"></i> TURNO DOS INIMIGOS';
        
        btnAtacar.disabled = true;
        btnMagia.disabled = true;
        if (btnDefender) btnDefender.disabled = true;
        
        setTimeout(processarTurnoInimigos, 1000);
    }
}

// ATAQUE - Versão simplificada para modal
function abrirModalAtaque() {
    if (!modalAtaque) return;
    if (inimigoSelecionado === null) {
        adicionarLog('❌ Selecione um inimigo primeiro!', 'erro');
        return;
    }
    
    const armas = getArmasEquipadas();
    
    if (armas.length === 0) {
        adicionarLog('❌ Você não tem armas equipadas!', 'erro');
        return;
    }
    
    // Se só tem UMA arma, ataca direto
    if (armas.length === 1) {
        armaSelecionada = 0;
        executarAtaque();
        return;
    }
    
    // Se tem várias armas, mostra modal
    armaSelecionada = null;
    if (btnConfirmarAtaque) btnConfirmarAtaque.disabled = true;
    
    if (armasLista) {
        armasLista.innerHTML = armas.map((arma, index) => `
            <div class="arma-card" data-index="${index}">
                <div class="arma-nome">${arma.nome}</div>
                <div class="arma-detalhes">
                    <span><i class="fas fa-tint"></i> Dano: ${arma.dano}</span>
                    <span><i class="fas fa-shield-alt"></i> Tipo: ${arma.tipoDano}</span>
                </div>
            </div>
        `).join('');
    }
    
    document.querySelectorAll('.arma-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.arma-card').forEach(c => c.classList.remove('selecionada'));
            card.classList.add('selecionada');
            armaSelecionada = parseInt(card.dataset.index);
            if (btnConfirmarAtaque) btnConfirmarAtaque.disabled = false;
        });
    });
    
    modalAtaque.classList.add('active');
}

// DEFESA MANUAL (botão)
function defenderManual() {
    if (window.turnoAtual !== 'pc') {
        adicionarLog('❌ Não é seu turno!', 'erro');
        return;
    }
    
    if (!window.inimigos || window.inimigos.length === 0) {
        adicionarLog('❌ Não há inimigos para defender!', 'erro');
        return;
    }
    
    // Cria um ataque fictício para teste
    const inimigoFicticio = { nome: 'Treinamento' };
    const danoFicticio = 0;
    
    abrirModalDefesa(inimigoFicticio, danoFicticio, () => {
        adicionarLog('   Posição de defesa preparada!', 'sucesso');
    });
}

// ============================================
// FUNÇÃO DE COMBATE GLOBAL
// ============================================
window.iniciarCombate = function(inimigosData, emboscada = false) {
    console.log('   Iniciando combate com:', inimigosData);
    
    // Preparar inimigos
    if (Array.isArray(inimigosData) && inimigosData.length > 0) {
        window.inimigos = inimigosData.map(inim => ({
            ...inim,
            pv: inim.pv_max || inim.pv,
            pv_atual: inim.pv_max || inim.pv,
            pv_max: inim.pv_max || inim.pv
        }));
    } else {
        window.inimigos = inimigosData.map((inim, index) => ({
            id: inim.id || `inimigo_${index}`,
            nome: inim.nome || `Inimigo ${index + 1}`,
            pv: inim.pv || 20,
            pv_max: inim.pv_max || inim.pv || 20,
            pv_atual: inim.pv_max || inim.pv || 20,
            defesa: inim.defesa || 8,
            dx: inim.dx || 10,
            nh_ataque: inim.nh_ataque || 10,
            dano: inim.dano || "1d6",
            xp: inim.xp || 25
        }));
    }
    
    if (!window.inimigos || window.inimigos.length === 0) {
        adicionarLog('❌ Erro: Nenhum inimigo encontrado!', 'erro');
        return;
    }
    
    // Calcular iniciativa
    const iniciativa = SistemaCombate.calcularIniciativa(
        window.personagem,
        window.inimigos,
        emboscada ? 'pc' : null
    );
    
    adicionarLog(iniciativa.texto, 'info');
    adicionarLog(`   Sua iniciativa: ${iniciativa.pc} | Inimigos: ${iniciativa.inimigos.toFixed(1)}`, 'info');
    
    window.turnoAtual = iniciativa.quemComeca;
    
    // Iniciar no sistema de combate
    SistemaCombate.turno.iniciarCombate(iniciativa.quemComeca);
    
    // Mostrar interface de combate
    if (inimigosContainer) inimigosContainer.style.display = 'block';
    renderizarInimigos();
    
    if (window.turnoAtual === 'pc') {
        turnoIndicator.className = 'turno-indicator jogador';
        turnoIndicator.innerHTML = '<i class="fas fa-user"></i> SEU TURNO';
        btnAtacar.disabled = false;
        btnMagia.disabled = false;
        if (btnDefender) btnDefender.disabled = false;
    } else {
        turnoIndicator.className = 'turno-indicator inimigo';
        turnoIndicator.innerHTML = '<i class="fas fa-skull"></i> TURNO DOS INIMIGOS';
        btnAtacar.disabled = true;
        btnMagia.disabled = true;
        if (btnDefender) btnDefender.disabled = true;
        setTimeout(processarTurnoInimigos, 1500);
    }
    
    adicionarLog('⚔️ COMBATE INICIADO!', 'sucesso');
}

function descansar() {
    pvAtual = Math.min(pvAtual + 5, pvMax);
    manaAtual = Math.min(manaAtual + 3, manaMax);
    fadigaAtual = Math.min(fadigaAtual + 2, fadigaMax);
    
    if (personagem && personagem.statusCombate) {
        personagem.statusCombate = {
            vidaAtual: pvAtual,
            vidaMax: pvMax,
            fadigaAtual: fadigaAtual,
            fadigaMax: fadigaMax,
            manaAtual: manaAtual,
            manaMax: manaMax
        };
    }
    
    atualizarFichaPersonagem();
    salvarProgresso();
    adicionarLog('   Você descansou e recuperou energia.', 'sucesso');
}

async function salvarProgresso() {
    if (!personagem || !sessaoId) return;
    
    try {
        if (personagem && personagem.statusCombate) {
            personagem.statusCombate = {
                vidaAtual: pvAtual,
                vidaMax: pvMax,
                fadigaAtual: fadigaAtual,
                fadigaMax: fadigaMax,
                manaAtual: manaAtual,
                manaMax: manaMax
            };
        }
        personagem.xp = xpAtual;
        
        const personagemRef = doc(db, "personagens", personagem.id);
        await updateDoc(personagemRef, {
            statusCombate: personagem.statusCombate,
            xp: xpAtual,
            atributos: personagem.atributos,
            pmGasto: pmGasto
        });
        
    } catch (error) {
        adicionarLog('❌ Erro ao salvar progresso', 'erro');
    }
}

async function carregarPersonagem(personagemId) {
    try {
        const personagemRef = doc(db, "personagens", personagemId);
        const personagemSnap = await getDoc(personagemRef);
        
        if (!personagemSnap.exists()) {
            throw new Error('Personagem não encontrado');
        }
        
        personagem = {
            id: personagemSnap.id,
            ...personagemSnap.data()
        };
        
        if (!personagem.inventario) {
            personagem.inventario = {
                corpo: [],
                mochila: [],
                deposito: []
            };
        }
        
        if (!personagem.atributos) {
            personagem.atributos = {
                st: { bolinhas: 0, valor: 9, base: 9 },
                dx: { bolinhas: 0, valor: 5, base: 5 },
                iq: { bolinhas: 0, valor: 5, base: 5 },
                ht: { bolinhas: 0, valor: 8, base: 8 }
            };
        } else {
            ['st', 'dx', 'iq', 'ht'].forEach(attr => {
                if (!personagem.atributos[attr]) {
                    const bases = { st: 9, dx: 5, iq: 5, ht: 8 };
                    personagem.atributos[attr] = { bolinhas: 0, valor: bases[attr], base: bases[attr] };
                } else {
                    if (!personagem.atributos[attr].base) {
                        const bases = { st: 9, dx: 5, iq: 5, ht: 8 };
                        personagem.atributos[attr].base = bases[attr];
                    }
                    if (!personagem.atributos[attr].valor) {
                        personagem.atributos[attr].valor = personagem.atributos[attr].base + (personagem.atributos[attr].bolinhas || 0);
                    }
                }
            });
        }
        
        if (!personagem.statusCombate) {
            personagem.statusCombate = {};
        }
        
        if (!personagem.vantagens) personagem.vantagens = [];
        if (!personagem.desvantagens) personagem.desvantagens = [];
        if (!personagem.pericias) personagem.pericias = {};
        if (!personagem.escolas) personagem.escolas = { agua: { magias: {} } };
        if (!personagem.pmDisponivel) personagem.pmDisponivel = 30;
        if (!personagem.pmGasto) personagem.pmGasto = 0;
        
        pvMax = calcularPVMax();
        pvAtual = personagem.statusCombate?.vidaAtual || pvMax;
        
        fadigaMax = calcularFadigaMax();
        fadigaAtual = personagem.statusCombate?.fadigaAtual || fadigaMax;
        
        manaMax = calcularManaMax();
        manaAtual = personagem.statusCombate?.manaAtual || manaMax;
        
        xpAtual = personagem.xp || 0;
        
        const stBolinhas = personagem.atributos?.st?.bolinhas || 0;
        const dxBolinhas = personagem.atributos?.dx?.bolinhas || 0;
        const iqBolinhas = personagem.atributos?.iq?.bolinhas || 0;
        const htBolinhas = personagem.atributos?.ht?.bolinhas || 0;
        const totalBolinhas = stBolinhas + dxBolinhas + iqBolinhas + htBolinhas;
        
        bolinhasDisponiveis = 0;
        let xpTemp = xpAtual;
        
        while (xpTemp >= XP_POR_BOLINHA) {
            bolinhasDisponiveis++;
            xpTemp -= XP_POR_BOLINHA;
        }
        
        atualizarFichaPersonagem();
        atualizarNivelNaTela();
        
        window.personagem = personagem;
        window.SistemaSocial = SistemaSocial;
        window.carregarCena = carregarCena;
        window.adicionarLog = adicionarLog;
        
    } catch (error) {
        if (dialogoTexto) dialogoTexto.textContent = '❌ Erro ao carregar personagem!';
        adicionarLog('❌ Erro ao carregar personagem!', 'erro');
    }
}

async function carregarAventura(aventuraId) {
    try {
        if (window.AVENTURA) {
            historia = window.AVENTURA;
        } else {
            let tentativas = 0;
            while (!window.AVENTURA && tentativas < 30) {
                await new Promise(r => setTimeout(r, 100));
                tentativas++;
            }
            
            if (window.AVENTURA) {
                historia = window.AVENTURA;
            } else {
                throw new Error(`Aventura "${aventuraId}" não encontrada.`);
            }
        }
        
        const cenaInicialId = historia.cenaInicial;
        
        if (!cenaInicialId) {
            throw new Error('Cena inicial não definida');
        }
        
        carregarCena(cenaInicialId);
        adicionarLog(`   ${historia.nome} iniciada!`, 'sucesso');
        
    } catch (error) {
        if (dialogoTexto) dialogoTexto.textContent = `ERRO: ${error.message}`;
        
        if (opcoesDialogo) {
            opcoesDialogo.innerHTML = '';
            const btnVoltar = document.createElement('button');
            btnVoltar.className = 'opcao-btn';
            btnVoltar.textContent = 'Voltar à seleção';
            btnVoltar.addEventListener('click', () => {
                window.location.href = 'aventura-solo.html';
            });
            opcoesDialogo.appendChild(btnVoltar);
        }
    }
}

async function criarSessao() {
    const urlParams = new URLSearchParams(window.location.search);
    const aventuraId = urlParams.get('aventura');
    const personagemId = urlParams.get('personagem');
    
    if (!aventuraId || !personagemId) {
        alert('Aventura ou personagem não selecionado!');
        window.location.href = 'aventura-solo.html';
        return;
    }
    
    showLoading();
    
    try {
        await carregarPersonagem(personagemId);
        await carregarAventura(aventuraId);
        
        const sessaoRef = doc(collection(db, "sessoes_aventura"));
        sessaoId = sessaoRef.id;
        
        await setDoc(sessaoRef, {
            id: sessaoId,
            userId: currentUser.uid,
            personagem_id: personagemId,
            aventura_id: aventuraId,
            pc_atual: personagem,
            cena_atual: historia?.cenaInicial || '',
            data_inicio: new Date().toISOString(),
            ultima_sessao: new Date().toISOString(),
            status: "em_andamento"
        });
        
    } catch (error) {
        adicionarLog('❌ Erro ao iniciar sessão', 'erro');
        if (dialogoTexto) dialogoTexto.textContent = '❌ Erro ao iniciar sessão.';
    } finally {
        hideLoading();
    }
}

// ============================================
// EXPOR FUNÇÕES GLOBAIS
// ============================================
window.iniciarCombate = iniciarCombate;
window.carregarCena = carregarCena;
window.adicionarLog = adicionarLog;
window.rolarDados = rolarDados;
window.rolar2d10 = rolar2d10;
window.SistemaSocial = SistemaSocial;
window.getValorAtributoReal = getValorAtributoReal;
window.calcularPVMax = calcularPVMax;
window.calcularFadigaMax = calcularFadigaMax;
window.calcularManaMax = calcularManaMax;
window.getArmasEquipadas = getArmasEquipadas;
window.executarAtaque = executarAtaque;
window.processarTurnoInimigos = processarTurnoInimigos;

// ============================================
// EVENT LISTENERS
// ============================================
onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        await criarSessao();
    } else {
        window.location.href = 'index.html';
    }
});

if (btnAtacar) btnAtacar.addEventListener('click', abrirModalAtaque);
if (btnMagia) btnMagia.addEventListener('click', () => adicionarLog('   Sistema de magias em desenvolvimento', 'info'));
if (btnInventario) btnInventario.addEventListener('click', abrirModalInventario);
if (btnDescansar) btnDescansar.addEventListener('click', descansar);
if (btnDefender) btnDefender.addEventListener('click', defenderManual);

if (btnVerVantagens) btnVerVantagens.addEventListener('click', abrirModalVantagens);
if (btnVerDesvantagens) btnVerDesvantagens.addEventListener('click', abrirModalDesvantagens);
if (btnVerPericias) btnVerPericias.addEventListener('click', abrirModalPericias);
if (btnVerMagias) btnVerMagias.addEventListener('click', abrirModalMagias);

if (cancelarEscolhaAtributo) cancelarEscolhaAtributo.addEventListener('click', () => {
    if (modalEscolhaAtributo) modalEscolhaAtributo.classList.remove('active');
});

if (fecharModalInventario) fecharModalInventario.addEventListener('click', () => {
    if (modalInventario) modalInventario.classList.remove('active');
});

if (fecharModalVantagens) fecharModalVantagens.addEventListener('click', () => {
    if (modalVantagens) modalVantagens.classList.remove('active');
});

if (fecharModalDesvantagens) fecharModalDesvantagens.addEventListener('click', () => {
    if (modalDesvantagens) modalDesvantagens.classList.remove('active');
});

if (fecharModalPericias) fecharModalPericias.addEventListener('click', () => {
    if (modalPericias) modalPericias.classList.remove('active');
});

if (fecharModalMagias) fecharModalMagias.addEventListener('click', () => {
    if (modalMagias) modalMagias.classList.remove('active');
});

if (btnCancelarAtaque) btnCancelarAtaque.addEventListener('click', () => {
    if (modalAtaque) modalAtaque.classList.remove('active');
});

if (btnConfirmarAtaque) btnConfirmarAtaque.addEventListener('click', executarAtaque);

if (btnCancelarDefesa) btnCancelarDefesa.addEventListener('click', () => {
    if (modalDefesa) modalDefesa.classList.remove('active');
});

if (btnAbrirDados) btnAbrirDados.addEventListener('click', () => {
    if (modalDados) modalDados.classList.add('active');
});

if (btnFecharDados) btnFecharDados.addEventListener('click', () => {
    if (modalDados) modalDados.classList.remove('active');
});

if (btnRolarDados) btnRolarDados.addEventListener('click', () => {
    const qtd = parseInt(dadosQtd?.value) || 1;
    const faces = parseInt(dadosFaces?.value) || 10;
    const mod = parseInt(dadosMod?.value) || 0;
    
    const resultado = rolarDados(qtd, faces, mod);
    if (dadosResultado) dadosResultado.textContent = resultado.texto;
    adicionarLog(`   Rolagem: ${resultado.texto}`, 'info');
});

document.querySelectorAll('.atributo-opcao').forEach(opcao => {
    opcao.addEventListener('click', () => {
        const atributo = opcao.dataset.atributo;
        adicionarBolinha(atributo);
    });
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (modalEscolhaAtributo) modalEscolhaAtributo.classList.remove('active');
        if (modalInventario) modalInventario.classList.remove('active');
        if (modalVantagens) modalVantagens.classList.remove('active');
        if (modalDesvantagens) modalDesvantagens.classList.remove('active');
        if (modalPericias) modalPericias.classList.remove('active');
        if (modalMagias) modalMagias.classList.remove('active');
        if (modalAtaque) modalAtaque.classList.remove('active');
        if (modalDefesa) modalDefesa.classList.remove('active');
        if (modalDados) modalDados.classList.remove('active');
    }
});

setInterval(() => {
    if (personagem && sessaoId) {
        salvarProgresso();
    }
}, 30000);

window.personagem = personagem;
window.SistemaSocial = SistemaSocial;
window.carregarCena = carregarCena;
window.adicionarLog = adicionarLog;
</script>
</body>
</html>
